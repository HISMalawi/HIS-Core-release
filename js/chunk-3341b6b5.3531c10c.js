(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-3341b6b5"],{3800:function(e,t,a){"use strict";a.d(t,"d",(function(){return i})),a.d(t,"e",(function(){return n})),a.d(t,"g",(function(){return o})),a.d(t,"n",(function(){return s})),a.d(t,"f",(function(){return r})),a.d(t,"b",(function(){return l})),a.d(t,"m",(function(){return c})),a.d(t,"k",(function(){return d})),a.d(t,"i",(function(){return u})),a.d(t,"a",(function(){return h})),a.d(t,"l",(function(){return p})),a.d(t,"c",(function(){return b})),a.d(t,"j",(function(){return m})),a.d(t,"h",(function(){return g}));const i=[["1","2","3"],["4","5","6"],["7","8","9"],[".","0","Del"],["","Done",""]],n=[["1","2","3"],["4","5","6"],["7","8","9"],["Del","0","."],["Unknown","",""]],o=[["1","2","3"],["4","5","6"],["7","8","9"],["Del","0","."],["Unknown","","Confirm"]],s=[["1","2","3"],["4","5","6"],["7","8","9"],[".","0","Del"],["Clear","%","/"]],r=[["1","2","3"],["4","5","6"],["7","8","9"],["Del.","0","Clear"]],l=[["1","2","3","<"],["4","5","6",">"],["7","8","9","="],["","0",""]],c=[["1","2","3","+","-","/","*"],["4","5","6","%","=","<",">","Qwerty"],["7","8","9",".",","],["","0",""]],d=[["1","2","3"],["4","5","6"],["7","8","9"],["","0",""]],u=[["1","2","3","4","5","6","7"],["8","9","10","11","12","13","14"],["15","16","17","18","19","20","21"],["22","23","24","25","26","27","28"],["29","30","31"]],h=[["a","b","c","d","e","f","g","h","."],["i","j","k","l","m","n","o","p","q"],["r","s","t","u","v","w","x","y","z"]],p=[["q","w","e","r","t","y","u","i","o","p"],["a","s","d","f","g","h","j","k","l","'"],["z","x","c","v","b","n","m",",",".","A-Z"]],b=[["1","2","3","4","5","6","7","8","9","0"],["a","b","c","d","e","f","g","h","-","."],["i","j","k","l","m","n","o","p","q"],["r","s","t","u","v","w","x","y","z"]],m=[["1","2","3","4","5","6","7","8","9","0","Del"],["q","w","e","r","t","y","u","i","o","p","Clear"],["a","s","d","f","g","h","j","k","l",".","Caps"],["z","x","c","v","b","n","m","<",">","/","Enter"]],g=[["1","2","3","4","5","6","7","8","9","0"],["q","w","e","r","t","y","u","i","o","p"],["a","s","d","f","g","h","j","k","l","Del."],["z","x","c","v","b","n","m","Caps","Login"]]},"5f2c":function(e,t,a){"use strict";a.d(t,"a",(function(){return d}));var i=a("ade3"),n=(a("14d9"),a("cc6f")),o=a("71c3"),s=(a("13d5"),a("1c74"));class r extends s["e"]{constructor(){super()}static async fetchAvailableDrugStock(e){const t=await this.getJson("pharmacy/items",{drug_id:e});if(t&&t.length>0)return t.reduce((e,t)=>e+t.current_quantity,0)}}var l=a("d1ca");const c={11:[30],21:[25],22:[60],24:[30,60,90,100],30:[90],39:[60],73:[120],74:[60],76:[1e3],297:[30,60,90],576:[30,60,90],613:[60],731:[60],732:[60],733:[60],734:[30],735:[30],736:[60],738:[60],931:[12,30,60],932:[30],954:[60],963:[30,60,90],968:[60],969:[30],971:[30,60,90],976:[60],977:[30],982:[30],983:[30,90],1039:[30,60,90],1043:[60],1044:[30],1056:[24],1216:[3,6,8,12]};class d extends n["a"]{constructor(e,t){super(e,54,t),Object(i["a"])(this,"drugHistory",void 0),Object(i["a"])(this,"currentDrugOrder",void 0),Object(i["a"])(this,"useDrugManagement",void 0),this.drugHistory=[],this.currentDrugOrder=[],this.useDrugManagement=!1}setIsDrugManagementEnabled(e){this.useDrugManagement=e}async loadDrugManagementEnabled(){this.useDrugManagement=await l["b"].drugManagementEnabled()}getDrugHistory(){return this.drugHistory}getCurrentOrder(){return this.currentDrugOrder}buildDispensations(e,t,a){const i=[];for(let n=0;n<a;n++)i.push({drug_order_id:e,date:this.date,quantity:t/a});return i}saveDispensations(e){return n["a"].postJson("/dispensations",{dispensations:e,program_id:n["a"].getProgramID()})}async voidOrder(e){return n["a"].void("/dispensations/"+e,{})}async loadDrugHistory(){try{const e=await o["a"].getDrugOrderHistory(this.patientID);e&&(this.drugHistory=e)}catch(e){console.warn(e)}}async loadCurrentDrugOrder(){const e=await o["a"].getDrugOrders(this.patientID);if(e){if(this.useDrugManagement){const t=e.map(async e=>(e["available_stock"]=await r.fetchAvailableDrugStock(e.drug.drug_id),e));return void(this.currentDrugOrder=await Promise.all(t))}this.currentDrugOrder=e}}getDrugPackSizes(e){return e in c?c[e]:[30,60,90]}calcCompletePack(e,t){const a=e.barcodes.sort((e,t)=>e.tabs-t.tabs);if(0==a.length||0==t)return t;for(const n in a){const{tabs:e}=a[n];if(parseInt(e)>=t)return e}const i=parseInt(a[a.length-1].tabs);return i}}},"68ed":function(e,t,a){},"6be2":function(e,t,a){"use strict";a.d(t,"d",(function(){return o})),a.d(t,"g",(function(){return s})),a.d(t,"f",(function(){return r})),a.d(t,"e",(function(){return l})),a.d(t,"c",(function(){return c})),a.d(t,"b",(function(){return d})),a.d(t,"h",(function(){return h})),a.d(t,"a",(function(){return p}));var i=a("3800");const n=[i["m"],[["","Delete"]]],o=[i["k"],[["Delete"]]],s=[i["k"],[["Delete","Unknown"]]],r=[i["k"],[["N/A"],["Delete","Unknown"]]],l=[i["k"],[["Delete"]]],c=[i["k"],[["Unknown","Delete"],["Qwerty","A-Z"]]],d=[i["i"],[["Unknown"]]],u=[i["a"],[["0-9","Delete"],["Qwerty","Unknown"],["","Space"]]],h=[i["l"],[["","Delete"],["?123","0-9"],["Space","Unknown"]]],p=[{btn:"0-9",keyboard:c},{btn:"?123",keyboard:n},{btn:"A-Z",keyboard:u},{btn:"Qwerty",keyboard:h}]},"6c3f":function(e,t,a){"use strict";a.r(t);var i=a("7a23");function n(e,t,a,n,o,s){const r=Object(i["resolveComponent"])("his-standard-form");return Object(i["openBlock"])(),Object(i["createBlock"])(r,{fields:e.fields,onFinishAction:e.onFinish,skipSummary:!0,cancelDestinationPath:e.cancelDestination},null,8,["fields","onFinishAction","cancelDestinationPath"])}a("14d9"),a("13d5");var o=a("d95e"),s=a("7920"),r=a("2706"),l=a("b5e4"),c=a("9283"),d=a("2ef0"),u=a("3b8c"),h=a("c1e4"),p=a("9b7c"),b=a("8158"),m=a("fe96"),g=a("d867");function f(e,t,a,n,o,s){const r=Object(i["resolveComponent"])("ion-title"),l=Object(i["resolveComponent"])("ion-toolbar"),c=Object(i["resolveComponent"])("ion-header"),d=Object(i["resolveComponent"])("ion-content"),u=Object(i["resolveComponent"])("ion-button"),h=Object(i["resolveComponent"])("ion-footer");return Object(i["openBlock"])(),Object(i["createElementBlock"])(i["Fragment"],null,[Object(i["createVNode"])(c,null,{default:Object(i["withCtx"])(()=>[Object(i["createVNode"])(l,null,{default:Object(i["withCtx"])(()=>[Object(i["createVNode"])(r,null,{default:Object(i["withCtx"])(()=>[Object(i["createTextVNode"])("VL milestone has been reached")]),_:1})]),_:1})]),_:1}),Object(i["createVNode"])(d,{style:{overflowY:"hidden",background:"grey"}},{default:Object(i["withCtx"])(()=>[Object(i["createElementVNode"])("p",null,"ART start date : "+Object(i["toDisplayString"])(e.artStartDate),1),Object(i["createElementVNode"])("p",null,"Months on ART: "+Object(i["toDisplayString"])(e.monthsOnART),1),Object(i["createElementVNode"])("p",null,"Last VL order date "+Object(i["toDisplayString"])(e.lastOrder),1),Object(i["createElementVNode"])("p",null,"Current regimen / start date: "+Object(i["toDisplayString"])(e.currentRegimen)+" - "+Object(i["toDisplayString"])(e.regimenStartDate),1)]),_:1}),Object(i["createVNode"])(h,null,{default:Object(i["withCtx"])(()=>[Object(i["createVNode"])(l,null,{default:Object(i["withCtx"])(()=>[Object(i["createVNode"])(u,{slot:"end",color:"success",size:"large",onClick:t[0]||(t[0]=t=>e.closeModal("order"))},{default:Object(i["withCtx"])(()=>[Object(i["createTextVNode"])(" Order VL")]),_:1}),Object(i["createVNode"])(u,{slot:"end",size:"large",onClick:t[1]||(t[1]=t=>e.closeModal("wait"))},{default:Object(i["withCtx"])(()=>[Object(i["createTextVNode"])(" Wait till next milestone")]),_:1}),Object(i["createVNode"])(u,{slot:"start",color:"danger",size:"large",onClick:t[2]||(t[2]=t=>e.closeModal("later"))},{default:Object(i["withCtx"])(()=>[Object(i["createTextVNode"])(" Remind me later ")]),_:1})]),_:1})]),_:1})],64)}var v=Object(i["defineComponent"])({name:"Modal",props:{VLData:{type:Object,required:!0}},async created(){this.artStartDate=c["b"].toStandardHisDisplayFormat(this.VLData.earliest_start_date),this.monthsOnART=this.VLData.period_on_art,this.lastOrder=this.VLData.last_order_date?c["b"].toStandardHisDisplayFormat(this.VLData.last_order_date):"N/A",this.currentRegimen=this.VLData.current_regimen.name?this.VLData.current_regimen.name:"Other",this.regimenStartDate=c["b"].toStandardHisDisplayFormat(this.VLData.current_regimen.date_started)},methods:{async closeModal(e){await g["Z"].dismiss(e)}},data(){return{content:"Content",artStartDate:"",monthsOnART:"",lastOrder:"",currentRegimen:"",regimenStartDate:""}},components:{IonHeader:g["q"],IonToolbar:g["S"],IonTitle:g["R"],IonContent:g["n"],IonFooter:g["o"],IonButton:g["d"]}}),T=(a("d42f"),a("d959")),O=a.n(T);const y=O()(v,[["render",f],["__scopeId","data-v-10a26cd2"]]);var _=y,C=a("ad60"),w=a("cc6f");class D extends w["a"]{constructor(e,t){super(e,13,t)}async buildDefferedOrder(e){const t=await w["a"].getConceptID("HIV viral load"),a=await w["a"].getConceptID("Delayed milestones");return[{concept_id:t,value_text:"Wait till next milestone",value_coded:a,value_numeric:e}]}}var S=a("7f35");const P=e=>(Object(i["pushScopeId"])("data-v-546674a2"),e=e(),Object(i["popScopeId"])(),e),x={style:{}},E=P(()=>Object(i["createElementVNode"])("div",{class:"side-title"}," Select reason ",-1)),N=P(()=>Object(i["createElementVNode"])("p",null,"Current Medication",-1)),I=P(()=>Object(i["createElementVNode"])("p",null,"Previous Medication",-1)),V=P(()=>Object(i["createElementVNode"])("p",null,null,-1));function j(e,t,a,n,o,s){const r=Object(i["resolveComponent"])("ion-title"),l=Object(i["resolveComponent"])("ion-toolbar"),c=Object(i["resolveComponent"])("ion-header"),d=Object(i["resolveComponent"])("ion-label"),u=Object(i["resolveComponent"])("ion-item"),h=Object(i["resolveComponent"])("ion-list"),p=Object(i["resolveComponent"])("ion-col"),b=Object(i["resolveComponent"])("ion-radio"),m=Object(i["resolveComponent"])("ion-radio-group"),g=Object(i["resolveComponent"])("ion-row"),f=Object(i["resolveComponent"])("ion-grid"),v=Object(i["resolveComponent"])("ion-content"),T=Object(i["resolveComponent"])("ion-button"),O=Object(i["resolveComponent"])("ion-footer");return Object(i["openBlock"])(),Object(i["createElementBlock"])(i["Fragment"],null,[Object(i["createVNode"])(c,null,{default:Object(i["withCtx"])(()=>[Object(i["createVNode"])(l,null,{default:Object(i["withCtx"])(()=>[Object(i["createVNode"])(r,null,{default:Object(i["withCtx"])(()=>[Object(i["createTextVNode"])("Side effects suspected causes")]),_:1})]),_:1})]),_:1}),Object(i["createVNode"])(v,{style:{overflowY:"hidden",background:"grey"}},{default:Object(i["withCtx"])(()=>[Object(i["createVNode"])(f,null,{default:Object(i["withCtx"])(()=>[Object(i["createVNode"])(g,null,{default:Object(i["withCtx"])(()=>[Object(i["createVNode"])(p,{size:"4"},{default:Object(i["withCtx"])(()=>[Object(i["createVNode"])(h,{style:{overflowY:"auto",height:"78vh"}},{default:Object(i["withCtx"])(()=>[(Object(i["openBlock"])(!0),Object(i["createElementBlock"])(i["Fragment"],null,Object(i["renderList"])(e.sides,(t,a)=>(Object(i["openBlock"])(),Object(i["createBlock"])(u,{key:t,onClick:t=>e.selectSideEffect(a),detail:!0,style:Object(i["normalizeStyle"])(e.activeIndex===a?"color: green":"color: black")},{default:Object(i["withCtx"])(()=>[Object(i["createVNode"])(d,null,{default:Object(i["withCtx"])(()=>[Object(i["createTextVNode"])(Object(i["toDisplayString"])(t.label),1)]),_:2},1024)]),_:2},1032,["onClick","style"]))),128))]),_:1})]),_:1}),Object(i["createVNode"])(p,{style:{overflowY:"auto",height:"78vh"}},{default:Object(i["withCtx"])(()=>[Object(i["createElementVNode"])("div",x,[Object(i["createVNode"])(h,null,{default:Object(i["withCtx"])(()=>[null!==e.activeIndex?(Object(i["openBlock"])(),Object(i["createBlock"])(m,{key:0,modelValue:e.sides[e.activeIndex]["reason"],"onUpdate:modelValue":t[0]||(t[0]=t=>e.sides[e.activeIndex]["reason"]=t)},{default:Object(i["withCtx"])(()=>[E,N,(Object(i["openBlock"])(!0),Object(i["createElementBlock"])(i["Fragment"],null,Object(i["renderList"])(e.drugs,(e,t)=>(Object(i["openBlock"])(),Object(i["createBlock"])(u,{key:t},{default:Object(i["withCtx"])(()=>[Object(i["createVNode"])(d,null,{default:Object(i["withCtx"])(()=>[Object(i["createTextVNode"])(Object(i["toDisplayString"])(e.drug.name),1)]),_:2},1024),Object(i["createVNode"])(b,{slot:"start",value:e.drug_inventory_id},null,8,["value"])]),_:2},1024))),128)),I,Object(i["createVNode"])(u,null,{default:Object(i["withCtx"])(()=>[Object(i["createVNode"])(d,null,{default:Object(i["withCtx"])(()=>[Object(i["createTextVNode"])("Other, not drug related")]),_:1}),Object(i["createVNode"])(b,{slot:"start",value:"other"})]),_:1}),Object(i["createVNode"])(u,null,{default:Object(i["withCtx"])(()=>[Object(i["createVNode"])(d,null,{default:Object(i["withCtx"])(()=>[Object(i["createTextVNode"])("Drug side effect")]),_:1}),Object(i["createVNode"])(b,{slot:"start",value:"drug"})]),_:1})]),_:1},8,["modelValue"])):Object(i["createCommentVNode"])("",!0)]),_:1})]),V]),_:1})]),_:1})]),_:1})]),_:1}),Object(i["createVNode"])(O,null,{default:Object(i["withCtx"])(()=>[Object(i["createVNode"])(l,null,{default:Object(i["withCtx"])(()=>[Object(i["createVNode"])(T,{onClick:e.closeModal,slot:"end",color:"danger"},{default:Object(i["withCtx"])(()=>[Object(i["createTextVNode"])(" Close ")]),_:1},8,["onClick"]),Object(i["createVNode"])(T,{onClick:e.postSideEffects,slot:"end",disabled:!e.allSelected},{default:Object(i["withCtx"])(()=>[Object(i["createTextVNode"])(" Save ")]),_:1},8,["onClick","disabled"])]),_:1})]),_:1})],64)}var k=Object(i["defineComponent"])({name:"Modal",props:{sideEffects:{type:Object,required:!0},drugs:{type:Array,default:[]}},methods:{closeModal(){g["Z"].dismiss()},async postSideEffects(){await g["Z"].dismiss(this.sides)},selectSideEffect(e){this.activeIndex=e}},computed:{allSelected(){return this.sides.filter(e=>e["reason"]).length===this.sides.length}},mounted(){this.sides=this.sideEffects},data(){return{content:"Content",extendedLabsEnabled:!1,appActivities:[],sides:[],specimens:[],reasons:["Routine","Targeted","Confirmatory","Stat","Repeat / Missing"],activeIndex:null}},components:{IonButton:g["d"],IonContent:g["n"],IonHeader:g["q"],IonTitle:g["R"],IonToolbar:g["S"],IonLabel:g["x"],IonList:g["y"],IonItem:g["w"],IonRadioGroup:g["F"],IonRow:g["H"]}});a("e96c");const A=O()(k,[["render",j],["__scopeId","data-v-546674a2"]]);var H=A,F=a("d1ca"),B=a("b446"),R=a("9ceb"),L=a("8df6"),M=a("dac2"),U=a("5f2c"),q=a("4db7"),Y=a("8e8b"),$=a("e86e"),W=a("6d32"),z=Object(i["defineComponent"])({mixins:[m["a"]],components:{HisStandardForm:s["a"]},data:()=>({fields:[],currentWeight:-1,weightTrail:[],customRegimens:[],labOrders:[],weightLossPercentageNum:0,lostTenPercentBodyWeight:!1,CxCaEnabled:!1,CxCaStartAge:-1,CxCaMaxAge:-1,DueForCxCa:!1,currentlyPregnant:!1,currentlyBreastfeeding:!1,patientHitMenopause:!1,hasPregnancyObsToday:!1,autoSelect3HP:!1,labOrderFieldContext:{},consultation:{},prescription:{},dispensation:{},completed3HP:!1,hasTbHistoryObs:!1,allergicToSulphur:!1,TBSuspected:!1,presentedTBSymptoms:!1,askAdherence:!1,lastDrugsReceived:[],sideEffectsHistory:{},onPermanentFPMethods:!1,reasonForDecliningTPTObs:{},malawiSideEffectReasonObs:[],otherSideEffectReasonObs:[],wasTransferredIn:!1,dateStartedArt:"",clientHadAHysterectomy:!1,isNoneClientPatient:!1,tptStatus:{},customDrugs:[]}),watch:{ready:{handler(e){e&&(this.consultation=new u["a"](this.patientID,this.providerID),this.prescription=new M["a"](this.patientID,this.providerID),this.dispensation=new U["a"](this.patientID,this.providerID),this.fields=this.getFields())},immediate:!0}},methods:{async onFinish(e,t){const a=await this.consultation.createEncounter();if(!a)return Object(l["e"])("Unable to create encounter");const i=await this.resolveObs(t,"consultation"),n=(await Promise.all([...this.malawiSideEffectReasonObs,...this.otherSideEffectReasonObs,this.reasonForDecliningTPTObs])).filter(e=>!Object(d["isEmpty"])(e)),o=await this.consultation.saveObservationList([...i,...n]);if(Object(d["isEmpty"])(this.drugObs)||this.isNoneClientPatient||await this.saveAdherence(),!o)return Object(l["e"])("Unable to save patient observations");Object(l["d"])("Observations and encounter created!"),e.refer_to_clinician&&"Yes"===e.refer_to_clinician.value?this.gotoPatientDashboard():this.nextTask()},async getTptDrugs(e){const t=[],a=e.routine_tb_therapy.value;return Object(d["isEmpty"])(this.customDrugs)&&(this.customDrugs=await W["a"].getCustomIngridients()),a.match(/ipt/i)?t.push("INH or H (Isoniazid 300mg tablet)"):a.includes("3HP (RFP + INH)")?(t.push("INH or H (Isoniazid 300mg tablet)"),t.push("Rifapentine (150mg)")):a.includes("INH 300 / RFP 300 (3HP)")&&t.push("INH 300 / RFP 300 (3HP)"),Object(d["isEmpty"])(t)?[]:this.customDrugs.filter(e=>t.includes(e.name)).map(e=>({label:e.name,value:"",other:e}))},async getTransferInStatus(){const e=await u["a"].getFirstValueCoded(this.patientID,"Ever received ART"),t=await u["a"].getFirstObs(this.patientID,"Has transfer letter"),a=t?c["b"].toStandardHisFormat(t.obs_datetime):"";return e&&e.match(/yes/i)&&t&&(""+t.value_coded).match(/yes/i)&&a===this.consultation.getDate()},async getDateStartedArt(){const e=await u["a"].getFirstValueDatetime(this.patientID,"Date ART started");return e?c["b"].toStandardHisFormat(e):""},async checkIfWeightLossIsControlled(e){if(this.lostTenPercentBodyWeight&&(""+e.label).match(/malnutrition/i)&&(""+e.value).match(/no/i)){const t=await Object(S["a"])("Recommendation",`Patient's weight has dropped by ${this.weightLossPercentageNum}% , is this controlled weight loss??`,"Please verify",[{name:"Confirm weight loss",slot:"start",color:"success"},{name:"Confirm controlled",slot:"end",color:"primary"}]);e.value="Confirm weight loss"===t?"Yes":"No"}},async checkVLReminder(){const e=await C["a"].getPatientVLInfo(this.patientID);if(!0===e.eligibile){const t=await g["Z"].create({component:_,backdropDismiss:!1,cssClass:"large-modal",componentProps:{VLData:e}});t.present();const{data:a}=await t.onDidDismiss();switch(a){case"order":await this.labOrderFieldContext.launchOrderSelection();break;case"wait":await this.waitForVL();break;case"later":break;default:break}}},async waitForVL(e=null){const t=new D(this.patientID,this.providerID),a=await t.createEncounter(),i=await t.buildDefferedOrder(e);if(!a)return Object(l["e"])("Unable to create encounter");await t.saveObservationList(i)},canScreenCxCa(){const e=this.patient.getAge();return this.patient.isFemale()&&this.DueForCxCa&&this.CxCaEnabled&&e>=this.CxCaStartAge&&e<=this.CxCaMaxAge&&!this.clientHadAHysterectomy},pregnancyEligible(){return this.patient.isChildBearing()&&!this.onPermanentFPMethods},showCurrentContraceptionMethods(e){return this.pregnancyEligible()&&!this.patientHitMenopause&&!this.isPregnant(e)&&!this.isANCclient()},showNewContraceptionMethods(e){return this.pregnancyEligible()&&!this.patientHitMenopause&&!this.isPregnant(e)&&!this.isOnTubalLigation(e)&&!this.isANCclient()},isPregnant(e){return e.pregnant_breastfeeding?this.inArray(e.pregnant_breastfeeding,e=>"Pregnant"===e.label&&"Yes"===e.value):this.currentlyPregnant},isBreastFeeding(e){return e.pregnant_breastfeeding?this.inArray(e.pregnant_breastfeeding,e=>"Breastfeeding"===e.label&&"Yes"===e.value):this.currentlyBreastfeeding},isOnTubalLigation(e){return this.inArray(e.current_fp_methods,e=>"TUBAL LIGATION"===e.value)},async disableFPMethods(e,t){if(t.isChecked&&"NONE"===t.label)return e.map(e=>("NONE"!=e.label&&(e.isChecked=!1,e.disabled=!1),e));if("NONE"!=t.label&&t.isChecked){t.label.match(/condom/gi)&&Object(l["b"])("Combine with other modern methods of family planning");const a=Object(d["findIndex"])(e,{label:"NONE"});e[a].isChecked=!1;const i=this.consultation.familyPlanningMethods(t.label,e),n=Object(d["findIndex"])(i,{label:t.label});return i[n].isChecked=!0,i}return e.map(e=>(e.disabled=!1,e))},disablePrescriptions(e,t){if(t.isChecked&&"NONE OF THE ABOVE"===t.label)return e.map(e=>("NONE OF THE ABOVE"!=e.label&&(e.isChecked=!1),e));if("NONE OF THE ABOVE"!=t.label&&t.isChecked){const t=Object(d["findIndex"])(e,{label:"NONE OF THE ABOVE"});e[t].isChecked=!1}return e},buildMedicationOrders(e){if(this.inArray(e,e=>"NONE OF THE ABOVE"===e.label))return this.consultation.buildValueCoded("Prescribe drugs","No");const t=this.consultation.buildValueCoded("Prescribe drugs","Yes"),a=e.map(e=>this.consultation.buildValueCoded("Medication orders",e.label));return[t,...a]},declinedFPM(e){return this.inArray(e.fp_methods,e=>"NONE"===e.value)&&this.inArray(e.current_fp_methods,e=>"NONE"===e.value)},riskOfUnplannedPregnancy(e){return"At risk of unplanned pregnancy"===e.reason_for_no_fpm.value},showOtherSideEffects(e){return this.inArray(e.side_effects,e=>"Other"===e.label&&"Yes"===e.value)},hasTBSymptoms(e){return this.presentedTBSymptoms=this.inArray(e.tb_side_effects,e=>"Yes"===e.value),this.presentedTBSymptoms},isTBSuspect(e){return this.TBSuspected=!!e.value.toString().match(/Yes|TB Suspected/i),this.TBSuspected},isAllergicToSulphur(e){return this.allergicToSulphur=e.value.match(/unknown/i)?null:!!e.value.match(/yes/i),this.allergicToSulphur},async buildSideEffectObs(e,t){const a=await this.getSideEffectsReasons(e);if(this[t]=[],void 0===a)return!1;if(-1!=a){const e=b["a"].getCachedConceptID("Drug induced",!0),i=e=>!!(""+e).match(/other|drug/i);this[t]=a.map(t=>({concept_id:e,value_coded:b["a"].getCachedConceptID(t.label,!0),value_text:i(t.reason)?"Past medication history":null,value_drug:i(t.reason)?null:t.reason}))}return!0},async getSideEffectsReasons(e){const t=e.filter(e=>!(""+e.label).match(/other/i)&&"Yes"===e.value);if(t.length>0){const e=await g["Z"].create({component:H,backdropDismiss:!1,cssClass:"large-modal",componentProps:{sideEffects:t,drugs:this.lastDrugsReceived}});e.present();const{data:a}=await e.onDidDismiss();return a}return-1},getFPMethods(e=[],t){const a=this.consultation.getFamilyPlanningMethods(),i=a.filter(t=>!e.includes(t));return i.map(e=>({label:e,value:e,isChecked:t.map(e=>e.label).includes(e)}))},getOptions(e,t){return e.map(e=>{const a=Object(d["find"])(t,{label:e});return{label:e,value:a?a.value:"",other:{values:this.yesNoOptions()}}})},getContraindications(e){const t=b["a"].getConceptsByCategory("contraindication",!0).map(e=>e.name);return this.getOptions([...t,"Other"],e)},getOtherContraindications(e){const t=b["a"].getConceptsByCategory("side_effect",!0).map(e=>e.name),a=t.pop();return this.getOptions([...t,"Other (Specify)",""+a],e)},getTBSymptoms(e){const t=b["a"].getConceptsByCategory("tb_symptom",!0).map(e=>e.name);return this.getOptions([...t],e)},getReasonsForNoCxcaOptions(){return b["a"].getConceptsByCategory("reason_for_no_cxca").map(e=>({label:e.name,value:e.name,other:{c:e}}))},runAppendOptionParams(e,t){const a=t.filter(e=>e.isChecked).map(e=>e.label);return e.map(e=>{var t;if("function"===typeof(null===e||void 0===e||null===(t=e.other)||void 0===t?void 0:t.appendOptionParams)){var i;const t=null===e||void 0===e||null===(i=e.other)||void 0===i?void 0:i.appendOptionParams();if("object"===typeof t){const i={label:e.label,value:e.value,other:e.other};return t.isChecked?(i.isChecked=t.isChecked,delete t.isChecked):i.isChecked=a.includes(e.label),{...i,...t}}}return e})},didCompleted3HP(e){return!!this.completed3HP||!(!e.routine_tb_therapy||!e.routine_tb_therapy.value.match(/complete/i))},patientOnTpt(e){return null!=e.routine_tb_therapy?/Currently/i.test(e.routine_tb_therapy.value):null!==this.tptStatus.tpt&&!this.completed3HP},tptAutoSelectionMode(e){return this.autoSelect3HP&&!this.didCompleted3HP(e)},async on3HPValueUpdate(e,t,a){const i=e=>!!e.label.match(/IPT|3HP/i),n=(()=>{const t=e.reduce((e,t)=>(i(t)&&!(t.label in e)&&t.isChecked&&e.push(t.label),e),[]);return t.includes("IPT")&&(t.includes("3HP (RFP + INH)")||t.includes("INH 300 / RFP 300 (3HP)"))})(),o=i(t)&&e.filter(e=>i(e)).map(e=>!e.isChecked).every(Boolean);if(o&&this.patientOnTpt(a)){const e=await Object(S["c"])("Reasons for declining TPT","",["Patient declined","Side-effects (previous or current)","Stock-out","Starting TB treatment","Other"],[{name:"Done",slot:"start",role:"action"}]);this.reasonForDecliningTPTObs=this.consultation.buildValueText("Other reason for not seeking services",e.selection)}else this.reasonForDecliningTPTObs={};if(n){const t=await Object(S["a"])("IPT / 3HP conflict","IPT and 3HP can NOT be prescribed together","Please pick either one",[{name:"Prescribe 3HP",slot:"start",color:"primary"},{name:"Prescribe IPT",slot:"end",color:"primary"}]);return e.map(e=>(i(e)&&(e.isChecked="Prescribe IPT"===t&&"IPT"===e.label||"Prescribe 3HP"===t&&"INH 300 / RFP 300 (3HP)"===e.label),e))}return e.map(e=>(("3HP (RFP + INH)"===t.label&&"INH 300 / RFP 300 (3HP)"===e.label&&t.isChecked||"INH 300 / RFP 300 (3HP)"===t.label&&"3HP (RFP + INH)"===e.label&&t.isChecked)&&(e.isChecked=!1),e))},medicationOrderOptions(e,t=[]){const a=this.didCompleted3HP(e),i=null!==this.tptStatus.tpt,n=this.tptAutoSelectionMode(e),o=this.isBreastFeeding(e),s=e=>({disabled:!0,isChecked:!1,description:{color:"danger",show:"always",text:e}});return this.runAppendOptionParams([this.toOption("ARVs",{appendOptionParams:()=>({isChecked:n&&!this.TBSuspected})}),this.toOption("CPT",{appendOptionParams:()=>!n||this.TBSuspected||this.allergicToSulphur?this.allergicToSulphur?s("Allergic to CPT"):{disabled:!1}:{isChecked:!0}}),this.toOption("3HP (RFP + INH)",{appendOptionParams:()=>a?s("Completed TPT treatment"):this.tptStatus.tb_treatment?s("Completed/on TB treatment"):this.TBSuspected?s("TB Suspect"):this.currentlyPregnant?s("Pregnant patient"):o?s("Patient is breast feeding"):this.currentWeight<20?s("Weight below regulation"):i&&"3HP (RFP + INH)"!==this.tptStatus.tpt&&!this.tptStatus.completed?s(`On ${this.tptStatus.tpt} treatment`):"3HP (RFP + INH)"!==this.tptStatus.tpt||this.tptStatus.completed?void 0:{isChecked:!0}}),this.toOption("INH 300 / RFP 300 (3HP)",{appendOptionParams:()=>a?s("Completed TPT treatment"):this.tptStatus.tb_treatment?s("Completed/on TB treatment"):this.TBSuspected?s("TB Suspect"):this.currentlyPregnant?s("Pregnant patient"):o?s("Patient is breast feeding"):this.currentWeight<30?s("Weight below regulation"):i&&"INH 300 / RFP 300 (3HP)"!==this.tptStatus.tpt&&!this.tptStatus.completed?s(`On ${this.tptStatus.tpt} treatment`):"INH 300 / RFP 300 (3HP)"!==this.tptStatus.tpt||this.tptStatus.completed?{isChecked:n}:{isChecked:!0}}),this.toOption("IPT",{appendOptionParams:()=>a?s("Completed TPT treatment"):this.tptStatus.tb_treatment?s("Completed/on TB treatment"):this.TBSuspected?s("TB Suspect"):this.currentlyPregnant?s("Pregnant patient"):o?s("Patient is breast feeding"):i&&"IPT"!==this.tptStatus.tpt&&!this.tptStatus.completed?s(`On ${this.tptStatus.tpt} treatment`):"IPT"!==this.tptStatus.tpt||this.tptStatus.completed?void 0:{isChecked:!0}}),this.toOption("NONE OF THE ABOVE")],t)},async getVlLabData(){return p["a"].formatLabs(await Y["a"].get("GET_LAB_ORDERS_WITH_GIVEN_RESULT_STATUS",{patientID:this.patientID}))},isANCclient(){return"ANC"===C["a"].getSuspendedProgram()},getFields(){return[{id:"other_patient_prescription",proxyID:"prescription",helpText:"Medication to prescribe during this visit",type:o["b"].TT_MULTIPLE_SELECT,init:async()=>{const e="No"===await this.consultation.getClient();return this.isNoneClientPatient=!!e||!!await L["a"].isDrugRefillPatient(this.patientID),this.isNoneClientPatient&&(this.currentWeight=Number(await this.patient.getRecentWeight()),this.autoSelect3HP=await Y["a"].get("ART_AUTO_3HP_SELECTION"),this.tptStatus=await this.consultation.getTptTreatmentStatus(),this.completed3HP=null!==this.tptStatus.tpt&&this.tptStatus.completed),!0},validation:e=>r["a"].required(e),computedValue:e=>({tag:"consultation",obs:this.buildMedicationOrders(e)}),onValueUpdate:(e,t,a)=>{const i=this.disablePrescriptions(e,t);return this.on3HPValueUpdate(i,t,a)},options:(e,t,a,i)=>Object(d["isEmpty"])(i)?this.medicationOrderOptions(e):i,condition:()=>this.isNoneClientPatient,exitsForm:()=>!0},...Object(B["b"])({id:"date_last_received_arvs",helpText:"Last ARV Dispensation",required:!0,init:async()=>(this.wasTransferredIn=await this.getTransferInStatus()||!1,this.dateStartedArt=await this.getDateStartedArt(),!0),condition:()=>this.wasTransferredIn,minDate:()=>this.dateStartedArt,maxDate:()=>this.consultation.getDate(),computeValue:e=>(this.prescription.setDate(e),{tag:"consultation",date:e,obs:this.consultation.buildValueDate("Date drug received from previous facility",e)}),estimation:{allowUnknown:!1}},this.consultation.getDate()),{id:"previous_arvs_received",helpText:"Last ARV drugs dispensed",type:o["b"].TT_MULTIPLE_SELECT,computedValue:e=>e.map(e=>e.other),validation:e=>r["a"].required(e),options:async()=>{if(!Object(d["isEmpty"])(this.customRegimens))return this.customRegimens;const e=new M["a"](this.patientID,this.providerID);return this.customRegimens=(await e.getARVs()).map(e=>({label:e.name,value:e.drug_id,other:{...e}})),this.customRegimens},config:{showKeyboard:!0},condition:()=>this.wasTransferredIn},{id:"drug_interval",helpText:"Duration period for last received ARVs",type:o["b"].TT_NEXT_VISIT_INTERVAL_SELECTION,condition:()=>this.wasTransferredIn,validation:e=>r["a"].required(e),computedValue:e=>e.other.nextAppointment,options:()=>{const e=[{label:"2 weeks",value:14},{label:"1 month",value:28},{label:"2 months",value:56},{label:"3 months",value:84},{label:"4 months",value:112},{label:"5 months",value:140},{label:"6 months",value:168},{label:"7 months",value:196},{label:"8 months",value:224},{label:"9 months",value:252},{label:"10 months",value:280},{label:"11 months",value:308},{label:"12 months",value:336}];return e.map(({label:e,value:t})=>{this.prescription.setNextVisitInterval(t);const a=this.prescription.calculateDateFromInterval();return{label:e,value:t,other:{label:"Medication run-out date:",value:c["b"].toStandardHisDisplayFormat(a),nextAppointment:a,other:{label:"",value:[]}}}})}},{id:"arv_quantities",helpText:"Amount of drugs dispensed (From last ART Facility)",type:o["b"].TT_DRUG_TRANSFER_IN,validation:e=>this.validateSeries([()=>r["a"].required(e),()=>e.map(e=>{var t;return""===e.value||""===(null===e||void 0===e||null===(t=e.other)||void 0===t?void 0:t.pillsBrought)}).some(Boolean)?["Some Drugs are missing values"]:null]),computedValue:(e,t,a)=>({tag:"consultation",obs:e.map(async e=>{var t,i,n,o;const s=(null===e||void 0===e||null===(t=e.other)||void 0===t||null===(i=t.drug)||void 0===i?void 0:i.drug_id)||0;return{...await this.consultation.buildObs("Drug received from previous facility",{value_drug:s,value_datetime:(null===a||void 0===a?void 0:a.drug_interval)||null,value_numeric:(null===e||void 0===e?void 0:e.value)||0}),child:await this.consultation.buildObs("Number of tablets brought to clinic",{value_drug:s,value_numeric:(null===e||void 0===e||null===(n=e.other)||void 0===n?void 0:n.pillsBrought)||-1,value_datetime:(null===a||void 0===a||null===(o=a.date_last_received_arvs)||void 0===o?void 0:o.date)||null})}})}),options:(e,t,a)=>t.previous_arvs_received.map(e=>{const t=e["alternative_drug_name"]||e["drug_name"]||e["name"],i=Object(d["find"])(a,{label:t});let n="",o="";var s;i&&(n=null===i||void 0===i?void 0:i.value,o=null===i||void 0===i||null===(s=i.other)||void 0===s?void 0:s.pillsBrought);return{label:t,value:n,other:{drug:e,pillsBrought:o}}}),condition:()=>this.wasTransferredIn},{id:"patient_lab_orders",helpText:"Lab orders",type:o["b"].TT_LAB_ORDERS,init:async()=>(this.labOrders=await this.getVlLabData(),!0),unload:async()=>{await this.checkVLReminder();const e=this.labOrders.filter(e=>"No"===e.result_given);if(e.length&&await Object(l["a"])("Result(s) Given to Client?")){const t=new w["a"](this.patientID,-1,this.providerID),a=e.reduce((e,a)=>[...e,...a.resultIds.map(async e=>(t.encounterID=a.encounter_id,t.saveObs(await t.buildObs("Result Given to Client",{value_coded:"Yes",obs_group_id:e}))))],[]);await Promise.all(a)}this.labOrders=await this.getVlLabData()},onload:e=>this.labOrderFieldContext=e,options:()=>[{label:"Lab orders",value:"order trail",other:{values:this.labOrders}}],config:{printOrder:e=>new q["a"](this.patientID).printLabOrderLbl(e),hiddenFooterBtns:["Clear"],footerBtns:[{name:"Order",size:"large",slot:"end",color:"primary",visible:!0,onClick:async()=>{Object(d["isEmpty"])(this.labOrderFieldContext)||await this.labOrderFieldContext.launchOrderSelection()}}]}},{id:"pregnant_breastfeeding",helpText:"Patient Pregnant or breastfeeding?",init:async()=>(this.patient.isFemale()&&(this.patient.isChildBearing()&&(this.hasPregnancyObsToday=await this.patient.hasPregnancyObsToday(),this.currentlyPregnant=await this.patient.isPregnant(),this.currentlyBreastfeeding=await this.patient.isBreastfeeding()),this.onPermanentFPMethods=await this.consultation.getTLObs()),!0),condition:()=>!this.hasPregnancyObsToday&&this.pregnancyEligible(),type:o["b"].TT_MULTIPLE_YES_NO,validation:e=>this.validateSeries([()=>r["a"].required(e),()=>r["a"].anyEmpty(e)]),computedValue:e=>({tag:"consultation",obs:e.map(e=>this.consultation.buildValueCoded(e.other.concept,e.value)).concat(this.isANCclient()?[this.consultation.buildValueCoded("Is patient pregnant","Yes")]:[])}),options:e=>{const t=[];return this.isANCclient()||t.push({label:"Pregnant",value:"",other:{values:this.yesNoOptions(),concept:"Is patient pregnant"}}),t.push({label:"Breastfeeding",value:"",other:{values:this.yesNoOptions(),concept:"Is patient breast feeding"}}),e.pregnant_breastfeeding||t}},{id:"patient_weight_chart",helpText:"Patient weight chart",type:o["b"].TT_WEIGHT_CHART,init:async()=>(this.weightTrail=await this.patient.getWeightHistory(),this.weightLossPercentageNum=this.patient.getWeightLossPercentageFromTrail(this.weightTrail),this.lostTenPercentBodyWeight=this.weightLossPercentageNum>=10,!0),options:async()=>{const e=await this.patient.getBMI(),t=this.weightTrail;return[{label:"Weight for patient",value:"Weight trail",other:{bmi:e,values:t.map(e=>({x:c["b"].toStandardHisDisplayFormat(e.date),y:e.weight})),age:this.patient.getAge()}}]},config:{hiddenFooterBtns:["Clear"]}},{id:"has_fp_methods",helpText:"",type:o["b"].TT_TEXT_BANNER,condition:()=>this.onPermanentFPMethods,options:()=>this.mapStrToOptions(["Patient is on Tubal ligation method"])},{id:"current_fp_methods",helpText:"What method are you currently on?",type:o["b"].TT_MULTIPLE_SELECT,init:async()=>(this.patient.isFemale()&&(this.patientHitMenopause=await this.consultation.patientHitMenopause()),!0),validation:e=>r["a"].required(e),onValueUpdate:(e,t)=>this.disableFPMethods(e,t),computedValue:e=>({tag:"consultation",obs:e.map(e=>this.consultation.buildValueCoded("Family planning method",e.value))}),condition:e=>this.showCurrentContraceptionMethods(e),options:(e,t)=>this.getFPMethods([],t)},{id:"fp_methods",helpText:"What method are you providing today?",type:o["b"].TT_MULTIPLE_SELECT,condition:e=>this.showNewContraceptionMethods(e),validation:e=>r["a"].required(e),onValueUpdate:(e,t)=>this.disableFPMethods(e,t),computedValue:e=>({tag:"consultation",obs:e.map(e=>this.consultation.buildValueCoded("Family planning, action to take",e.value))}),options:(e,t)=>this.getFPMethods([],t)},{id:"reason_for_no_fpm",helpText:"Main reason for not using family planning methods",type:o["b"].TT_SELECT,validation:e=>r["a"].required(e),condition:e=>this.declinedFPM(e),computedValue:e=>({tag:"consultation",obs:this.consultation.buildValueText("Why does the woman not use birth control",e.value)}),options:()=>this.mapStrToOptions(["Not Sexually active","Patient want to get pregnant","Not needed for medical reasons","At risk of unplanned pregnancy","Menopause"])},{id:"specific_reason_for_no_fpm",helpText:"Specific reason for not using family planning methods",type:o["b"].TT_SELECT,validation:e=>r["a"].required(e),computedValue:e=>({tag:"consultation",obs:this.consultation.buildValueText("Reason for not using contraceptives",e.value)}),condition:e=>this.riskOfUnplannedPregnancy(e),options:()=>this.mapStrToOptions(["Following wishes of spouse","Religious reasons","Afraid of side effects","Never though about it","Indifferent (does not mind getting pregnant)"])},{id:"offer_contraceptives",helpText:"Offer contraceptives",type:o["b"].TT_SELECT,validation:e=>r["a"].required(e),condition:e=>this.riskOfUnplannedPregnancy(e),computedValue:e=>({tag:"consultation",obs:this.consultation.buildValueCoded("Family planning, action to take",e.value)}),options:()=>[{label:"Accepted",value:"Yes"},{label:"Declined",value:"No"},{label:"Discuss with spouse",value:"Discuss with spouse"}]},{id:"offered_intervention",helpText:"Offered intervention",type:o["b"].TT_MULTIPLE_SELECT,validation:e=>r["a"].required(e),condition:e=>"Accepted"===e.offer_contraceptives.value,computedValue:e=>({tag:"consultation",obs:e.map(e=>this.consultation.buildValueCoded(e.label,e.value))}),options:(e,t)=>this.getFPMethods(["NONE"],t)},{id:"offer_cxca",helpText:"Refer client for CxCa screening",type:o["b"].TT_SELECT,init:async()=>{if(this.patient.isFemale()&&(this.CxCaEnabled=await F["b"].cervicalCancerScreeningEnabled(),this.CxCaEnabled)){const{start:e,end:t}=await F["b"].cervicalCancerScreeningAgeBounds();this.CxCaMaxAge=t,this.CxCaStartAge=e,this.DueForCxCa=await this.consultation.clientDueForCxCa(),this.clientHadAHysterectomy=await this.consultation.clientHasHadAHysterectomy()}return!0},validation:e=>r["a"].required(e),condition:e=>this.canScreenCxCa()&&!this.isPregnant(e),computedValue:e=>({tag:"consultation",obs:this.consultation.buildValueCoded("Offer CxCa",e.value)}),options:()=>this.yesNoOptions()},{id:"reason_for_no_cxca",helpText:"Reason for NOT offering CxCa",type:o["b"].TT_SELECT,validation:e=>r["a"].required(e),condition:e=>"No"===e.offer_cxca.value,computedValue:e=>({tag:"consultation",obs:this.consultation.buildValueCoded("Reason for NOT offering CxCa",e.value)}),options:()=>this.getReasonsForNoCxcaOptions()},...Object(B["b"])({id:"previous_cxca_test_date",helpText:"Previous CxCa test",required:!0,minDate:()=>this.patient.getBirthdate(),maxDate:()=>u["a"].getSessionDate(),condition:e=>"Not due for screening"===e.reason_for_no_cxca.value,computeValue:(e,t)=>t?{tag:"consultation",obs:this.consultation.buildValueDateEstimated("CxCa test date",e)}:{tag:"consultation",obs:this.consultation.buildValueDate("CxCa test date",e)},estimation:{allowUnknown:!0,estimationFieldType:B["a"].MONTH_ESTIMATE_FIELD}}),{id:"previous_side_effects",helpText:"Side effects / Contraindications history",type:o["b"].TT_DATA_TABLE,init:async()=>(this.sideEffectsHistory=await this.consultation.getDrugSideEffects(),!0),config:{columns:()=>[[R["a"].thTxt("Date"),R["a"].thTxt("Condition"),R["a"].thTxt("Drug induced"),R["a"].thTxt("Drug")]],rows:()=>Object.keys(this.sideEffectsHistory).map(e=>Object.values(this.sideEffectsHistory[e]).filter(e=>!Object(d["isEmpty"])(e.name)).map(t=>[R["a"].tdDate(e),R["a"].td(t.name),R["a"].td(t.drug_induced?"Yes":"No"),R["a"].td(t.drug)])).reduce((e,t)=>e.concat(t),[])}},{id:"side_effects",helpText:"Contraindications / Side effects (select either 'Yes' or 'No')",type:o["b"].TT_MULTIPLE_YES_NO,init:async()=>(this.lastDrugsReceived=await this.consultation.getPreviousDrugs(),!0),validation:e=>this.validateSeries([()=>r["a"].required(e),()=>r["a"].anyEmpty(e)]),computedValue:e=>({tag:"consultation",obs:e.map(async e=>({...await this.consultation.buildValueCoded("Malawi ART side effects",e.label),child:await this.consultation.buildValueCoded(e.label,e.value)}))}),beforeNext:e=>this.buildSideEffectObs(e,"malawiSideEffectReasonObs"),options:(e,t)=>this.getContraindications(t)},{id:"other_side_effects",helpText:"Other Contraindications / Side effects (select either 'Yes' or 'No')",type:o["b"].TT_MULTIPLE_YES_NO,onValue:async e=>(await this.checkIfWeightLossIsControlled(e),!0),condition:e=>this.showOtherSideEffects(e),onConditionFalse:()=>this.otherSideEffectReasonObs=[],validation:e=>this.validateSeries([()=>r["a"].required(e),()=>r["a"].anyEmpty(e)]),computedValue:e=>({tag:"consultation",obs:e.filter(e=>"Other (Specify)"!=e.label).map(async e=>({...await this.consultation.buildValueCoded("Other side effect",e.label),child:await this.consultation.buildValueCoded(e.label,e.value)}))}),beforeNext:e=>this.buildSideEffectObs(e,"otherSideEffectReasonObs"),options:(e,t)=>this.getOtherContraindications(t)},{id:"other_side_effect_specify",helpText:"Other Contraindications / Side effects (specify)",type:o["b"].TT_NOTE,computedValue:async e=>({tag:"consultation",obs:{...await this.consultation.buildValueCoded("Other side effect","Other (Specify)"),child:await this.consultation.buildValueText("Other (Specify)",e.value)}}),condition:e=>this.inArray(e.other_side_effects,e=>"Other (Specify)"===e.label&&"Yes"===e.value),validation:e=>r["a"].required(e)},{id:"on_tb_treatment",helpText:"On TB Treatment?",type:o["b"].TT_SELECT,validation:e=>r["a"].required(e),computedValue:e=>({tag:"consultation",obs:[this.consultation.buildValueCoded("TB treatment",e.value)].concat(this.isTBSuspect(e)?[this.consultation.buildValueCoded("TB Status","Confirmed TB on treatment")]:[])}),options:()=>this.yesNoOptions()},{id:"tb_side_effects",helpText:"TB Associated symptoms",type:o["b"].TT_MULTIPLE_YES_NO,onValue:async e=>(await this.checkIfWeightLossIsControlled(e),!0),validation:e=>this.validateSeries([()=>r["a"].required(e),()=>r["a"].anyEmpty(e)]),condition:e=>e.on_tb_treatment.value.match(/no/i),options:(e,t)=>this.getTBSymptoms(t),computedValue:(e,t)=>({tag:"consultation",obs:e.map(async e=>({...await this.consultation.buildValueCoded("Routine TB Screening",e.label),child:await this.consultation.buildValueCoded(e.label,e.value)})).concat(this.hasTBSymptoms(t)?[]:[this.consultation.buildValueCoded("TB Status","TB NOT suspected")])})},{id:"tb_status",helpText:"TB Status",type:o["b"].TT_SELECT,validation:e=>r["a"].required(e),condition:e=>this.hasTBSymptoms(e),onConditionFalse:()=>this.TBSuspected=!1,defaultValue:()=>"TB Suspected",computedValue:e=>({tag:"consultation",obs:this.consultation.buildValueCoded("TB Status",e.value)}),beforeNext:async e=>{if(this.isTBSuspect(e)){const e=await Object(S["a"])("Lab Order","The patient is a TB suspect. Do you want to take lab orders?","",[{name:"Order now",slot:"start",color:"success"},{name:"NOT now",slot:"end",color:"danger"}]);"Order now"===e&&this.labOrderFieldContext.launchOrderSelection(["TB Microscopic Exam","GeneXpert","Culture & Sensitivity","TB Tests"])}return!0},options:()=>this.mapStrToOptions(["TB NOT suspected","TB Suspected","Confirmed TB Not on treatment"])},{id:"routine_tb_therapy",helpText:"TB preventive therapy (TPT) history",type:o["b"].TT_SELECT,init:async()=>(this.hasTbHistoryObs=await this.consultation.hasTreatmentHistoryObs(),!0),validation:e=>r["a"].required(e),condition:()=>!this.hasTbHistoryObs,computedValue:e=>({tag:"consultation",obs:this.consultation.buildValueText("Previous TB treatment history",e.value)}),options:e=>{let t=[];return/no/i.test(e.on_tb_treatment.value)&&(t=["Currently on IPT","Currently on 3HP (RFP + INH)","Currently on INH 300 / RFP 300 (3HP)"]),t=t.concat(["Complete course of 3HP in the past (3 months RFP+INH)","Complete course of IPT in the past (min. 6 months of INH)","Aborted course of 3HP (RFP + INH) in the past","Aborted course of INH 300 / RFP 300 (3HP) in the past","Aborted course of IPT in the past","Never taken IPT or 3HP"]),this.mapStrToOptions(t)}},...Object(B["b"])({id:"date_started_tpt",helpText:"Started TPT Treatment",required:!0,minDate:()=>this.patient.getBirthdate(),maxDate:()=>u["a"].getSessionDate(),condition:e=>e.routine_tb_therapy.value.match(/currently/i),computeValue:e=>e,estimation:{allowUnknown:!0,estimationFieldType:B["a"].MONTH_ESTIMATE_FIELD}}),{id:"tpt_drugs_received",helpText:"TPT Drugs Received",required:!0,condition:e=>e.routine_tb_therapy.value.match(/currently/i),type:o["b"].TT_ADHERENCE_INPUT,options:e=>this.getTptDrugs(e),computedValue:(e,t,a)=>({tag:"consultation",obs:e.map(async e=>{var t;return this.consultation.buildObs("TPT Drugs Received",{value_drug:(null===e||void 0===e||null===(t=e.other)||void 0===t?void 0:t.drug_id)||0,value_datetime:(null===a||void 0===a?void 0:a.date_started_tpt)||null,value_numeric:(null===e||void 0===e?void 0:e.value)||0})})}),config:{titles:{label:"Drug name",value:"Tablets received"}}},{id:"tpt_tranfer_from",helpText:"Facility client is transferring in from",type:o["b"].TT_SELECT,computedValue:({label:e})=>({tag:"consultation",obs:this.consultation.buildValueText("Location TPT last received",e)}),validation:e=>r["a"].required(e),condition:e=>e.routine_tb_therapy.value.match(/currently/i),options:(e,t="")=>Object($["b"])(t),config:{showKeyboard:!0,isFilterDataViaApi:!0}},{id:"allergic_to_sulphur",helpText:"Allergic to Cotrimoxazole",type:o["b"].TT_SELECT,validation:e=>r["a"].required(e),computedValue:e=>({tag:"consultation",obs:this.consultation.buildValueCoded("Allergic to sulphur",e.value)}),beforeNext:e=>(this.isAllergicToSulphur(e),console.log(this.allergicToSulphur),!0),options:()=>this.yesNoUnknownOptions()},...this.getAdherenceFields(!0),{id:"refer_to_clinician",helpText:"Refer to clinician",type:o["b"].TT_SELECT,condition:()=>h["a"].isNurse(),validation:e=>r["a"].required(e),computedValue:e=>({tag:"consultation",obs:this.consultation.buildValueCoded("Refer to clinician",e.value)}),options:()=>this.yesNoOptions()},{id:"medication_to_prescribe",proxyID:"prescription",helpText:"Medication to prescribe during this visit",type:o["b"].TT_MULTIPLE_SELECT,init:async()=>(this.isNoneClientPatient||(this.currentWeight=Number(await this.patient.getRecentWeight()),this.autoSelect3HP=await Y["a"].get("ART_AUTO_3HP_SELECTION"),this.tptStatus=await this.consultation.getTptTreatmentStatus(),this.completed3HP=null!==this.tptStatus.tpt&&this.tptStatus.completed),!0),condition:e=>!e.refer_to_clinician||(""+e.refer_to_clinician.value).match(/no/i),validation:e=>r["a"].required(e),computedValue:e=>({tag:"consultation",obs:this.buildMedicationOrders(e)}),onValueUpdate:(e,t,a)=>{const i=this.disablePrescriptions(e,t);return this.on3HPValueUpdate(i,t,a)},options:(e,t,a,i)=>this.medicationOrderOptions(e,i),config:{footerBtns:[{name:"Update allergic to CPT",onClickComponentEvents:{refreshOptions:(e,t,a)=>(this.allergicToSulphur="Allergic"===e.btnOutput,this.medicationOrderOptions(a,t))},onClick:()=>Object(S["a"])("Allergic to Cotrimoxazole update","Is the patient allergic to cotrimoxazole.","",[{name:"Allergic",slot:"start",color:"success"},{name:"NOT Allergic",slot:"end"}])}]}}]}}});const G=O()(z,[["render",n]]);t["default"]=G},b446:function(e,t,a){"use strict";a.d(t,"a",(function(){return i})),a.d(t,"b",(function(){return _}));a("14d9"),a("13d5");var i,n=a("d95e"),o=[{label:"Jan",value:1},{label:"Feb",value:2},{label:"Mar",value:3},{label:"Apr",value:4},{label:"May",value:5},{label:"Jun",value:6},{label:"Jul",value:7},{label:"Aug",value:8},{label:"Sep",value:9},{label:"Oct",value:10},{label:"Nov",value:11},{label:"Dec",value:12}],s=a("9283"),r=a("2706"),l=a("3800"),c=a("6be2"),d=a("5a0c"),u=a.n(d),h=a("1c74");function p(e,t,a=!0){const i=[];return a&&i.push("UNKNOWN"),{id:e,helpText:t+" Year",appearInSummary:()=>!1,type:n["b"].TT_TEXT,config:{customKeyboard:[l["k"],[i,["DELETE"]]]}}}function b(e,t){return{id:e,helpText:t+" Month",appearInSummary:()=>!1,type:n["b"].TT_SELECT,options:()=>o}}function m(e,t){return{id:e,helpText:t+" Day",type:n["b"].TT_MONTHLY_DAYS,appearInSummary:()=>!1}}function g(e,t){return{id:e,helpText:t+" Estimated period",type:n["b"].TT_SELECT,appearInSummary:()=>!1,options:()=>[{label:"6 months ago",value:180},{label:"12 months ago",value:365},{label:"18 months ago",value:540},{label:"24 months ago",value:730},{label:"Over 2 years ago",value:730}]}}function f(e,t){return{id:e,helpText:t+" Age Estimate",type:n["b"].TT_NUMBER,appearInSummary:()=>!1,config:{keypad:c["e"]}}}function v(e){return parseInt(e)<10?"0"+e:e}async function T(e,t,a){if(t.defaultValue){const i=await t.defaultValue(e);if(i){const[e,t,n]=i.split("-");switch(a){case"Year":return e||"";case"Month":return parseInt(t)||"";case"Day":return parseInt(n)||""}}}return""}function O(e){return s["b"].toStandardHisDisplayFormat(e)}function y(e,t,a,i){if(t.minDate){const n=t.minDate(a,i);if(new Date(e)<new Date(n))return[`${O(e)} is less than minimum date of ${O(n)}`]}if(t.maxDate){const n=t.maxDate(a,i);if(n&&new Date(e)>new Date(n))return[`${O(e)} is greater than max date of  ${O(n)}`]}}function _(e,t=""){let a="",n="",l="",c="",d=!1;const _="year_"+e.id,C="month_"+e.id,w="day_"+e.id,D="age_estimate_"+e.id,S="duration_estimate_"+e.id,P=p(_,e.helpText,e.estimation.allowUnknown),x=b(C,e.helpText),E=m(w,e.helpText),N=f(D,e.helpText),I=g(S,e.helpText),V="boolean"===typeof e.estimation.allowUnknownMonthDay&&e.estimation.allowUnknownMonthDay,j=t=>!(t[_]&&t[_].value&&["Unknown"].includes(t[_].value))&&(!e.condition||e.condition(t)),k=(e,t)=>{const a=[{type:"year",value:n,default:"YYYY"},{type:"month",value:l,default:"MM"},{type:"day",value:c,default:"DD"}];return a.reduce((a,i)=>{const n=[null,void 0,"Unknown",""];return t===i.type?n.includes(e)?a.push(i.default):a.push(e):n.includes(i.value)?a.push(i.default):a.push(i.value),a},[]).join("-")};"function"===typeof e.init&&(P.init=e.init),P.updateHelpTextOnValue=e=>`${P.helpText} (${k(null===e||void 0===e?void 0:e.label,"year")})`,P.proxyID=e.id,P.unload=e=>n=e.value.toString(),P.config={...P.config,...e.config},P.defaultValue=t=>T(t,e,"Year"),P.condition=t=>!e.condition||e.condition(t),P.validation=(t,a,i)=>{if(e.required&&r["a"].required(t))return["Year cannot be empty"];const n=t?t.value:"";if(!e.estimation.allowUnknown&&n.toString().match(/unknown/i))return["Value unknown is not permitted"];if(n&&!["Unknown"].includes(n)&&isNaN(n)||n<1900)return["Invalid Year"];if(n&&"function"===typeof e.minDate){const t=s["b"].getYear(e.minDate(a,i));if(parseInt(n)<t)return[`Year of ${n} is less than Minimum year of ${t}`]}if(n&&"function"===typeof e.maxDate){const t=e.maxDate(a,i);if(t&&n>s["b"].getYear(t))return[`Year of ${n} exceeds Maximum year of ${s["b"].getYear(t)}`]}return null},P.summaryMapValue=()=>({label:e.summaryLabel||e.helpText,value:a?O(a):"Unknown"}),P.appearInSummary=(t,a)=>a===e.id,P.computedValue=t=>{if(a){const[i,n,o]=a.split("-");return a=`${t.value}-${n}-${o}`,e.computeValue(a,!1)}if(t&&"Unknown"===t.value)return a="",e.computeValue("Unknown",!1)},x.updateHelpTextOnValue=e=>`${x.helpText} (${k(null===e||void 0===e?void 0:e.label,"month")})`,x.proxyID=e.id,x.unload=e=>l=v(e.value.toString()),x.condition=e=>j(e),x.validation=e=>r["a"].required(e),x.defaultValue=t=>T(t,e,"Month"),V&&(x.options=()=>[...o,{label:"Unknown",value:"Unknown"}]),x.computedValue=(t,i)=>{if((""+t.value).match(/unknown/i))return a=i[_].value+"-07-15",e.computeValue(a,!0);if(a){const[i,n,o]=a.split("-"),s=v(""+t.value);return a=`${i}-${s}-${o}`,e.computeValue(a,!1)}},E.proxyID=e.id,E.updateHelpTextOnValue=e=>`${E.helpText} (${k(null===e||void 0===e?void 0:e.label,"day")})`,E.condition=e=>!(""+e[C].value).match(/unknown/i)&&j(e),E.validation=(t,i,o)=>r["a"].required(t)?["Day is required for date"]:(d=!!(""+t.value).match(/unknown/i),c=d?"15":v(""+t.value),a=`${n}-${l}-${c}`,y(a,e,i,o)),E.defaultValue=t=>T(t,e,"Day"),E.computedValue=()=>e.computeValue(a,d),E.unload=(t,a,i,n)=>{e.unload&&e.unload(t,a,i,n)},E.beforeNext=(t,i)=>!e.beforeNext||e.beforeNext(a,i),E.config={year:e=>e[_].value,month:e=>e[C].value},V||(E.config.keyboardActions=[]);const A=(t,a)=>{const i=["Unknown"===t[_].value,!e.condition||e.condition(t),e.estimation.estimationFieldType===a];return i.every(Boolean)};return N.proxyID=e.id,N.validation=(t,i,n)=>{if(t&&t.value>300)return["Age estimate is too high and exceeding hard limit of 300"];if(isNaN(parseInt(t.value.toString())))return["Please enter a valid number"];const o=/^(12[0-7]|1[01][0-9]|[1-9]?[0-9])$/;if(!t.value.toString().match(o))return["Not a valid age estimate"];const s=u()(h["e"].getSessionDate()).subtract(t.value,"years").year();return a=s+"-07-15",y(a,e,i,n)},N.condition=e=>A(e,i.AGE_ESTIMATE_FIELD),N.computedValue=()=>e.computeValue(a,!0),N.beforeNext=(t,i)=>!e.beforeNext||e.beforeNext(a,i),I.proxyID=e.id,I.validation=(t,i,n)=>r["a"].required(t)?["Please select an estimate"]:(a=u()(h["e"].getSessionDate()).subtract(t.value,"day").format(s["a"]),y(a,e,i,n)),I.condition=e=>A(e,i.MONTH_ESTIMATE_FIELD),I.computedValue=()=>e.computeValue(a,!0),I.beforeNext=(t,i)=>!e.beforeNext||e.beforeNext(a,i),[P,x,E,N,I]}(function(e){e["AGE_ESTIMATE_FIELD"]="age-estimate-field",e["MONTH_ESTIMATE_FIELD"]="month-period-estimate-field"})(i||(i={}))},d42f:function(e,t,a){"use strict";a("68ed")},e86e:function(e,t,a){"use strict";a.d(t,"b",(function(){return o})),a.d(t,"d",(function(){return s})),a.d(t,"c",(function(){return r})),a.d(t,"f",(function(){return l})),a.d(t,"e",(function(){return c})),a.d(t,"a",(function(){return d})),a.d(t,"g",(function(){return u})),a.d(t,"h",(function(){return h}));var i=a("5713"),n=a("2ef0");async function o(e=""){const t=await i["a"].getFacilities({name:e});return t.filter(e=>!Object(n["isEmpty"])(e)&&""!=e.name.trim()).map(e=>({label:e.name,value:e.location_id,other:e}))}async function s(e=""){const t=await i["a"].getLabs({search_name:e});return t.map(e=>({label:e,value:e}))}async function r(e=""){const t=await i["a"].getFacilities({name:e,tag:"Facility adult sections"});return t.map(e=>({label:e.name,value:e.name,other:e}))}async function l(){const e=await i["a"].getSpecialistClinics();return e.map(e=>({label:e.name,value:e.name,other:e}))}async function c(){const e=await i["a"].getRegions();return e.map(e=>({label:e.name,value:e.region_id,other:e}))}async function d(e){const t=await i["a"].getDistricts(e);return t.map(e=>({label:e.name,value:e.district_id,other:e}))}async function u(e,t=""){const a=await i["a"].getTraditionalAuthorities(e,t);return a.map(e=>({label:e.name,value:e.traditional_authority_id,other:e}))}async function h(e,t=""){const a=await i["a"].getVillages(e,t);return a.map(e=>({label:e.name,value:e.village_id,other:e}))}},e96c:function(e,t,a){"use strict";a("ecfc")},ecfc:function(e,t,a){},fe96:function(e,t,a){"use strict";a("14d9");var i=a("7a23"),n=a("d95e"),o=a("b5e4"),s=a("ade3"),r=(a("13d5"),a("cc6f")),l=a("9283"),c=a("2ef0"),d=a("32b3"),u=a("5a0c"),h=a.n(u);class p extends r["a"]{constructor(e,t){super(e,68,t),Object(s["a"])(this,"lastDrugs",void 0),Object(s["a"])(this,"lastReceiptDate",void 0),this.lastDrugs=[],this.lastReceiptDate=""}async loadPreviousDrugs(e=!1){const t=new Date(this.date);t.setDate(t.getDate()-1);const a=e=>l["b"].toStandardHisFormat(e),i=await r["a"].getJson(`patients/${this.patientID}/drugs_received`,{date:a(t)});if(!Object(c["isEmpty"])(i)){this.lastReceiptDate=i.reduce((e,t)=>!e||new Date(a(t.order.start_date))>new Date(e)?a(t.order.start_date):e,null);const t=d["a"].htnDrugReferences().map(e=>e.drug_id);if(this.lastDrugs=i.filter(e=>!t.includes(e.drug["drug_id"])&&a(e.order.start_date)===this.lastReceiptDate),e){const e=await this.getPreviousDrugPillCount()||{};this.lastDrugs=this.lastDrugs.map(t=>(e[t.drug.drug_id]&&t.quantity&&(t.quantity+=e[t.drug.drug_id]),t))}}}getReceiptDate(){return this.lastReceiptDate}getLastDrugs(){return this.lastDrugs}receivedDrugsBefore(){return!Object(c["isEmpty"])(this.lastDrugs)}buildPillCountObs(e,t){return this.buildValueNumber("Number of tablets brought to clinic",t,null,e)}getPreviousDrugPillCount(){return r["a"].getJson("last_drugs_pill_count",{patient_id:this.patientID,program_id:this.programID,date:this.lastReceiptDate})}async buildAdherenceObs(e,t,a){const i=await r["a"].getConceptID("Drug adherence",!0);return{concept_id:i,value_numeric:a,value_drug:t,value_modifier:"%",order_id:e,person_id:this.patientID,obs_datetime:r["a"].getSessionDate()}}isAdherenceGood(e){return e>=95&&e<=105}calculateAdherence(e,t,a){return Math.round(100*(e-t)/(e-a))}calculateExpected(e,t,a,i){const n="QW"===i?"week":"day",o=this.calcTimeElapsed(a,n);return e-o*parseFloat(t.toString())}calcTimeElapsed(e,t){return h()(l["b"].toStandardHisFormat(this.date)).diff(l["b"].toStandardHisFormat(e),t)+1}calculateUnaccountedOrMissed(e,t){const a=parseFloat(e)-parseFloat(t);return a<0?-1*a+" missed":a+" unacc"}}var b=a("7365"),m=a("2706"),g=a("8e8b"),f=Object(i["defineComponent"])({mixins:[b["a"]],data:()=>({adherence:{},drugObs:[],askReasonForPoorAdherence:!1,calculationAgreementObs:[]}),methods:{async saveAdherence(){await this.adherence.createEncounter();const e=await Promise.all([...this.drugObs,...this.calculationAgreementObs]),t=await this.adherence.saveObservationList(e);if(!t)return Object(o["e"])("Unable to save patient observations")},buildAdherenceReport(e){const t=this.adherence.getReceiptDate(),a=this.adherence.calcTimeElapsed(t,"day"),i=` Last visit: ${l["b"].toStandardHisDisplayFormat(t)} \n                (${a} Days Elapsed)`,n=[{indexes:[0,3,6],class:"adherence-col-bg"}],o=[],s=[i],r=[["Prescription"],["Tabs given"],["Tabs per"],["Tabs remaining"],["Expected"],["Actual (counted)"],["Adherence"],["Doses missed/ Unaccounted for"],["Doses consumed"],["Art Adherence"]];return e.forEach((e,t)=>{const a=this.formatFrequency(e.frequency),i=this.calcPillsExpected(e),n=this.adherence.calculateAdherence(e.quantity,e.pillsBrought,i),l=this.adherence.isAdherenceGood(n)?"Good adherence":"Explore problem",c=this.adherence.calculateUnaccountedOrMissed(i,e.pillsBrought);s.push(e.drug.name),r[0].push(""),r[1].push(e.quantity),r[2].push(`${e.equivalent_daily_dose} <b>${a}</b>`),r[3].push(""),r[4].push(i<0?0:i),r[5].push(e.pillsBrought),r[6].push(""),r[7].push(c),r[8].push(n+"%"),r[9].push(l),o.push({index:t+1,row:9,class:l.match(/good/i)?"adherence-txt-good":"adherence-txt-bad"})}),[{label:"Selected Medication",value:"Table",other:{columns:s,rows:r,rowColors:n,cellColors:o}}]},formatFrequency(e){return(""+e).match(/qod/i)?"QOD":(""+e).match(/weekly/i)?"QW":e},calcPillsExpected(e){return this.adherence.calculateExpected(e.quantity,e.equivalent_daily_dose,e.order.start_date,this.formatFrequency(e.frequency))},getAdherenceFields(e=!1){return[{id:"pills_brought",helpText:"Pills remaining (brought to clinic)",type:n["b"].TT_ADHERENCE_INPUT,init:async()=>(this.adherence=new p(this.patientID,this.providerID),await this.adherence.loadPreviousDrugs(await g["a"].get("ASK_HANGING_PILLS")),!0),condition:()=>!e||this.adherence.receivedDrugsBefore(),validation:e=>{if(m["a"].required(e))return["No drugs available"];const t=e.map(e=>""===e.value);return t.some(Boolean)?["Some values are missing"]:null},unload:async e=>{this.drugObs=[],e.forEach(async e=>{const{drug:t,order:a}=e.other,i={...e.other,pillsBrought:e.value},n=this.adherence.calculateAdherence(i.quantity,i.pillsBrought,this.calcPillsExpected(i));this.drugObs.push(this.adherence.buildAdherenceObs(a.order_id,t.drug_id,n)),this.drugObs.push(this.adherence.buildPillCountObs(a.order_id,e.value)),this.askReasonForPoorAdherence||(this.askReasonForPoorAdherence=!this.adherence.isAdherenceGood(i))})},options:e=>Object(c["isEmpty"])(e.pills_brought)?this.adherence.getLastDrugs().map(e=>({label:e.drug.name,value:"",other:{...e}})):e.pills_brought},{id:"adherence_report",helpText:"ART adherence",type:n["b"].TT_TABLE_VIEWER,condition:()=>!e||this.adherence.receivedDrugsBefore(),options:e=>this.buildAdherenceReport(e.pills_brought.map(e=>({...e.other,pillsBrought:e.value}))),config:{hiddenFooterBtns:["Clear"]}},{id:"agree_with_calculation",helpText:"Agree with adherence calculation",type:n["b"].TT_SELECT,condition:()=>this.askReasonForPoorAdherence,validation:e=>m["a"].required(e),unload:({value:e})=>{this.calculationAgreementObs=[this.adherence.buildValueCoded("Reason for poor treatment adherence",e)]},options:()=>[{label:"Yes",value:"Yes"},{label:"No",value:"No"}]}]}}});const v=f;t["a"]=v}}]);
//# sourceMappingURL=chunk-3341b6b5.3531c10c.js.map