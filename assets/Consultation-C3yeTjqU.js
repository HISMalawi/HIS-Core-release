import{d as U,k as K,l as ot,I as J,a5 as Q,m as Z,a4 as tt,z as N,H as v,ak as q,h as V,e as d,w as c,ap as p,j as T,g as y,t as O,a9 as B,b as S,bV as H,ac as rt,ds as lt,a7 as ut,ag as dt,ah as ct,aa as W,a as A,a6 as pt,aO as ht,al as r,am as l,a$ as D,ay as C,c2 as mt,U as gt,aZ as b,au as R,aY as L,bJ as bt,aB as k,O as Tt,dj as G,c1 as j,ct as ft,a_ as x,dr as _,B as z,bd as X,bj as _t,bm as E,dt as vt,s as M,q as yt}from"./index-DO7Erl4-.js";import{H as Ct}from"./HisStandardForm-DUMUlSHj.js";import{_ as St}from"./AdherenceMixin.vue_vue_type_script_lang-CQ5DcOwT.js";import{P as Y,R as Pt}from"./prescription_service-dNUU7uVF.js";import{D as Ot}from"./dispensation_service-BE3fByTC.js";import{T as Et}from"./tb_integration_service-TOJPT2DI.js";import{A as wt}from"./appointment_service-BG-oLVXi.js";import"./adherence_service-B9otArkk.js";import"./htn_service-B345Slyh.js";import"./EncounterMixin.vue_vue_type_script_lang-CPsHcF6U.js";import"./encounter_guidelines-4_w2ZKXa.js";import"./GuidelineEngine-D6V1_Znr.js";import"./drug_order_service-cHNvOr18.js";const xt=U({name:"Modal",props:{VLData:{type:Object,required:!0}},async created(){this.artStartDate=v.toStandardHisDisplayFormat(this.VLData.earliest_start_date),this.monthsOnART=this.VLData.period_on_art,this.lastOrder=this.VLData.last_order_date?v.toStandardHisDisplayFormat(this.VLData.last_order_date):"N/A",this.currentRegimen=this.VLData.current_regimen.name?this.VLData.current_regimen.name:"Other",this.regimenStartDate=v.toStandardHisDisplayFormat(this.VLData.current_regimen.date_started)},methods:{async closeModal(t){await N.dismiss(t)}},data(){return{content:"Content",artStartDate:"",monthsOnART:"",lastOrder:"",currentRegimen:"",regimenStartDate:""}},components:{IonHeader:tt,IonToolbar:Z,IonTitle:Q,IonContent:J,IonFooter:ot,IonButton:K}});function Nt(t,e,i,n,o,s){const u=p("ion-title"),a=p("ion-toolbar"),m=p("ion-header"),f=p("ion-content"),g=p("ion-button"),h=p("ion-footer");return S(),V(B,null,[d(m,null,{default:c(()=>[d(a,null,{default:c(()=>[d(u,null,{default:c(()=>[...e[3]||(e[3]=[T("VL milestone has been reached",-1)])]),_:1})]),_:1})]),_:1}),d(f,{style:{overflowY:"hidden",background:"grey"}},{default:c(()=>[y("p",null,"ART start date : "+O(t.artStartDate),1),y("p",null,"Months on ART: "+O(t.monthsOnART),1),y("p",null,"Last VL order date "+O(t.lastOrder),1),y("p",null,"Current regimen / start date: "+O(t.currentRegimen)+" - "+O(t.regimenStartDate),1)]),_:1}),d(h,null,{default:c(()=>[d(a,null,{default:c(()=>[d(g,{slot:"end",color:"success",size:"large",onClick:e[0]||(e[0]=w=>t.closeModal("order"))},{default:c(()=>[...e[4]||(e[4]=[T(" Order VL",-1)])]),_:1}),d(g,{slot:"end",size:"large",onClick:e[1]||(e[1]=w=>t.closeModal("wait"))},{default:c(()=>[...e[5]||(e[5]=[T(" Wait till next milestone",-1)])]),_:1}),d(g,{slot:"start",color:"danger",size:"large",onClick:e[2]||(e[2]=w=>t.closeModal("later"))},{default:c(()=>[...e[6]||(e[6]=[T(" Remind me later ",-1)])]),_:1})]),_:1})]),_:1})],64)}const It=q(xt,[["render",Nt],["__scopeId","data-v-2044e916"]]);class Dt extends H{constructor(e,i){super(e,13,i)}async buildDefferedOrder(e){const i=await H.getConceptID("HIV viral load"),n=await H.getConceptID("Delayed milestones");return[{concept_id:i,value_text:"Wait till next milestone",value_coded:n,value_numeric:e}]}}const Vt=U({name:"Modal",props:{sideEffects:{type:Object,required:!0},drugs:{type:Array,default:()=>[]}},methods:{closeModal(){N.dismiss()},async postSideEffects(){await N.dismiss(this.sides)},selectSideEffect(t){this.activeIndex=t}},computed:{allSelected(){return this.sides.filter(t=>t.reason).length===this.sides.length}},mounted(){this.sides=this.sideEffects},data(){return{content:"Content",extendedLabsEnabled:!1,appActivities:[],sides:[],specimens:[],reasons:["Routine","Targeted","Confirmatory","Stat","Repeat / Missing"],activeIndex:null}},components:{IonButton:K,IonContent:J,IonHeader:tt,IonTitle:Q,IonToolbar:Z,IonLabel:ct,IonList:dt,IonItem:ut,IonRadioGroup:lt,IonRow:rt}}),Bt={style:{}};function Ht(t,e,i,n,o,s){const u=p("ion-title"),a=p("ion-toolbar"),m=p("ion-header"),f=p("ion-label"),g=p("ion-item"),h=p("ion-list"),w=p("ion-col"),F=p("ion-radio"),et=p("ion-radio-group"),it=p("ion-row"),nt=p("ion-grid"),st=p("ion-content"),$=p("ion-button"),at=p("ion-footer");return S(),V(B,null,[d(m,null,{default:c(()=>[d(a,null,{default:c(()=>[d(u,null,{default:c(()=>[...e[1]||(e[1]=[T("Side effects suspected causes",-1)])]),_:1})]),_:1})]),_:1}),d(st,{style:{overflowY:"hidden",background:"grey"}},{default:c(()=>[d(nt,null,{default:c(()=>[d(it,null,{default:c(()=>[d(w,{size:"4"},{default:c(()=>[d(h,{style:{overflowY:"auto",height:"78vh"}},{default:c(()=>[(S(!0),V(B,null,W(t.sides,(P,I)=>(S(),A(g,{key:P,onClick:Lt=>t.selectSideEffect(I),detail:!0,style:ht(t.activeIndex===I?"color: green":"color: black")},{default:c(()=>[d(f,null,{default:c(()=>[T(O(P.label),1)]),_:2},1024)]),_:2},1032,["onClick","style"]))),128))]),_:1})]),_:1}),d(w,{style:{overflowY:"auto",height:"78vh"}},{default:c(()=>[y("div",Bt,[d(h,null,{default:c(()=>[t.activeIndex!==null?(S(),A(et,{key:0,modelValue:t.sides[t.activeIndex].reason,"onUpdate:modelValue":e[0]||(e[0]=P=>t.sides[t.activeIndex].reason=P)},{default:c(()=>[e[4]||(e[4]=y("div",{class:"side-title"}," Select reason ",-1)),e[5]||(e[5]=y("p",null,"Current Medication",-1)),(S(!0),V(B,null,W(t.drugs,(P,I)=>(S(),A(g,{key:I},{default:c(()=>[d(f,null,{default:c(()=>[T(O(P.drug.name),1)]),_:2},1024),d(F,{slot:"start",value:P.drug_inventory_id},null,8,["value"])]),_:2},1024))),128)),e[6]||(e[6]=y("p",null,"Previous Medication",-1)),d(g,null,{default:c(()=>[d(f,null,{default:c(()=>[...e[2]||(e[2]=[T("Other, not drug related",-1)])]),_:1}),d(F,{slot:"start",value:"other"})]),_:1}),d(g,null,{default:c(()=>[d(f,null,{default:c(()=>[...e[3]||(e[3]=[T("Drug side effect",-1)])]),_:1}),d(F,{slot:"start",value:"drug"})]),_:1})]),_:1},8,["modelValue"])):pt("",!0)]),_:1})]),e[7]||(e[7]=y("p",null,null,-1))]),_:1})]),_:1})]),_:1})]),_:1}),d(at,null,{default:c(()=>[d(a,null,{default:c(()=>[d($,{onClick:t.closeModal,slot:"end",color:"danger"},{default:c(()=>[...e[8]||(e[8]=[T(" Close ",-1)])]),_:1},8,["onClick"]),d($,{onClick:t.postSideEffects,slot:"end",disabled:!t.allSelected},{default:c(()=>[...e[9]||(e[9]=[T(" Save ",-1)])]),_:1},8,["onClick","disabled"])]),_:1})]),_:1})],64)}const At=q(Vt,[["render",Ht],["__scopeId","data-v-045e07c6"]]),Ft=U({mixins:[St],components:{HisStandardForm:Ct},data:()=>({fields:[],currentWeight:-1,weightTrail:[],customRegimens:[],labOrders:[],weightLossPercentageNum:0,lostTenPercentBodyWeight:!1,CxCaEnabled:!1,CxCaStartAge:-1,CxCaMaxAge:-1,DueForCxCa:!1,currentlyPregnant:!1,currentlyBreastfeeding:!1,patientHitMenopause:!1,hasPregnancyObsToday:!1,autoSelect3HP:!1,labOrderFieldContext:{},consultation:{},prescription:{},dispensation:{},hasTbHistoryObs:!1,allergicToSulphur:!1,TBSuspected:!1,presentedTBSymptoms:!1,askAdherence:!1,lastDrugsReceived:[],sideEffectsHistory:{},onPermanentFPMethods:!1,reasonForDecliningTPTObs:{},malawiSideEffectReasonObs:[],otherSideEffectReasonObs:[],wasTransferredIn:!1,dateStartedArt:"",clientHadAHysterectomy:!1,isNoneClientPatient:!1,tptStatus:{},customDrugs:[],CxCaAppointDate:{},hasTbTreatmentDate:!1,isEligibleForTpt:!1,appointment:{},extraDtgState:{init:!1,onDtg:!1,dtgNeeded:0,nextAppointment:"",consultationBeforeAppointment:!1,arvExpireDate:"",lastArvStartDate:"",isNewTbTreatment:!1}}),watch:{ready:{handler(t){t&&(this.consultation=new _(this.patientID,this.providerID),this.prescription=new Y(this.patientID,this.providerID),this.dispensation=new Ot(this.patientID,this.providerID),this.appointment=new wt(this.patientID,this.providerID),this.fields=this.getFields())},immediate:!0}},methods:{async onFinish(t,e){if(!await this.consultation.createEncounter())return M("Unable to create encounter");const n=await this.resolveObs(e,"consultation"),o=(await Promise.all([...this.malawiSideEffectReasonObs,...this.otherSideEffectReasonObs,this.reasonForDecliningTPTObs,this.buildTBStatusObs(t)])).filter(a=>!b.isEmpty(a)),s=await this.consultation.saveObservationList([...n,...o]);if(!b.isEmpty(this.drugObs)&&!this.isNoneClientPatient&&await this.saveAdherence(),!s)return M("Unable to save patient observations");const u=this.inArray(t.prescription,a=>a.value==="ARVs"&&a.isChecked);if(this.isEligibleForExtraDtg(t)&&u&&await x("Patient on TB Treatment","Patient is eligible for extra DTG supplementation","Patient is currently on TB treatment and taking DTG-based regimen. Choose to prescribe extra DTG or review current ART regimen",[{name:"Prescribe Extra DTG",slot:"start",color:"success"},{name:"Review ART Regimen",slot:"end",color:"primary"}],"his-warning-color")==="Prescribe Extra DTG"&&await this.prescribeExtraDtg(),yt("Observations and encounter created!"),t.refer_to_clinician&&t.refer_to_clinician.value==="Yes"){this.gotoPatientDashboard();return}this.nextTask()},async getTptDrugs(t){const e=[],i=t.routine_tb_therapy.value;return b.isEmpty(this.customDrugs)&&(this.customDrugs=await Pt.getCustomIngridients()),i.match(/ipt/i)?e.push("INH or H (Isoniazid 300mg tablet)"):i.includes("3HP (RFP + INH)")?(e.push("INH or H (Isoniazid 300mg tablet)"),e.push("Rifapentine (150mg)")):i.includes("INH 300 / RFP 300 (3HP)")&&e.push("INH 300 / RFP 300 (3HP)"),b.isEmpty(e)?[]:this.customDrugs.filter(n=>e.includes(n.name)).map(n=>({label:n.name,value:"",other:n}))},async getTransferInStatus(){const t=await _.getFirstValueCoded(this.patientID,"Ever received ART"),e=await _.getFirstObs(this.patientID,"Has transfer letter"),i=e?v.toStandardHisFormat(e.obs_datetime):"";return t&&t.match(/yes/i)&&e&&"".concat(e.value_coded).match(/yes/i)&&i===this.consultation.getDate()},async getDateStartedArt(){const t=await _.getFirstValueDatetime(this.patientID,"Date ART started");return t?v.toStandardHisFormat(t):""},async checkIfWeightLossIsControlled(t){if(this.lostTenPercentBodyWeight&&"".concat(t.label).match(/malnutrition/i)&&"".concat(t.value).match(/no/i)){const e=await x("Recommendation","Patient's weight has dropped by ".concat(this.weightLossPercentageNum,"% , is this controlled weight loss??"),"Please verify",[{name:"Confirm weight loss",slot:"start",color:"success"},{name:"Confirm controlled",slot:"end",color:"primary"}]);t.value=e==="Confirm weight loss"?"Yes":"No"}},async checkVLReminder(){const t=await X.getPatientVLInfo(this.patientID);if(t.eligibile===!0){const e=await N.create({component:It,backdropDismiss:!1,cssClass:"large-modal",componentProps:{VLData:t}});e.present();const{data:i}=await e.onDidDismiss();switch(i){case"order":await this.labOrderFieldContext.launchOrderSelection();break;case"wait":await this.waitForVL();break}}},async waitForVL(t=null){const e=new Dt(this.patientID,this.providerID),i=await e.createEncounter(),n=await e.buildDefferedOrder(t);if(!i)return M("Unable to create encounter");await e.saveObservationList(n)},canScreenCxCa(){const t=this.patient.getAge();return this.patient.isFemale()&&this.DueForCxCa&&this.CxCaEnabled&&t>=this.CxCaStartAge&&t<=this.CxCaMaxAge&&!this.clientHadAHysterectomy},pregnancyEligible(){return this.patient.isChildBearing()&&!this.onPermanentFPMethods},showCurrentContraceptionMethods(t){return this.pregnancyEligible()&&!this.patientHitMenopause&&!this.isPregnant(t)&&!this.isANCclient()},showNewContraceptionMethods(t){return this.pregnancyEligible()&&!this.patientHitMenopause&&!this.isPregnant(t)&&!this.isLongTermFpMethod(t)&&!this.isANCclient()},isPregnant(t){return t.pregnant_breastfeeding?this.inArray(t.pregnant_breastfeeding,e=>e.label==="Pregnant"&&e.value==="Yes"):this.currentlyPregnant},isBreastFeeding(t){return t.pregnant_breastfeeding?this.inArray(t.pregnant_breastfeeding,e=>e.label==="Breastfeeding"&&e.value==="Yes"):this.currentlyBreastfeeding},isLongTermFpMethod(t){return(t.current_fp_methods||[]).some(e=>/contraceptive implant|intrauterine|tubal ligation/i.test("".concat(e.value)))},async disableFPMethods(t,e){if(e.isChecked&&e.label==="NONE")return t.map(i=>(i.label!="NONE"&&(i.isChecked=!1,i.disabled=!1),i));if(e.label!="NONE"&&e.isChecked){e.label.match(/condom/gi)&&vt("Combine with other modern methods of family planning");const i=b.findIndex(t,{label:"NONE"});t[i].isChecked=!1;const n=this.consultation.familyPlanningMethods(e.label,t),o=b.findIndex(n,{label:e.label});return n[o].isChecked=!0,n}else return t.map(i=>(i.disabled=!1,i))},disablePrescriptions(t,e){return e.isChecked&&/extra dtg|none/i.test(e.label)?t.map(i=>({...i,isChecked:i.label===e.label})):t.map(i=>({...i,isChecked:/extra dtg|none/i.test("".concat(i.label))?!1:i.isChecked}))},buildMedicationOrders(t){if(this.inArray(t,n=>n.label==="Extra DTG"))return[this.consultation.buildValueCoded("Prescribe drugs","Yes"),this.consultation.buildValueCoded("Medication orders","ARVs")];if(this.inArray(t,n=>n.label==="NONE OF THE ABOVE"))return this.consultation.buildValueCoded("Prescribe drugs","No");const e=this.consultation.buildValueCoded("Prescribe drugs","Yes"),i=t.map(n=>this.consultation.buildValueCoded("Medication orders",n.label));return[e,...i]},declinedFPM(t){return this.inArray(t.fp_methods,e=>e.value==="NONE")&&this.inArray(t.current_fp_methods,e=>e.value==="NONE")},riskOfUnplannedPregnancy(t){return t.reason_for_no_fpm.value==="At risk of unplanned pregnancy"},showOtherSideEffects(t){return this.inArray(t.side_effects,e=>e.label==="Other"&&e.value==="Yes")},hasTBSymptoms(t){return this.presentedTBSymptoms=this.inArray(t.tb_side_effects,e=>e.value==="Yes"),this.presentedTBSymptoms},isTBSuspect(t){return this.TBSuspected=!!t.value.toString().match(/Yes|TB Suspected/i),this.TBSuspected},isAllergicToSulphur(t){return this.allergicToSulphur=t.value.match(/unknown/i)?null:!!t.value.match(/yes/i),this.allergicToSulphur},async buildSideEffectObs(t,e){const i=await this.getSideEffectsReasons(t);if(this[e]=[],i===void 0)return!1;if(i!=-1){const n=E.getCachedConceptID("Drug induced",!0),o=s=>!!"".concat(s).match(/other|drug/i);this[e]=i.map(s=>({concept_id:n,value_coded:E.getCachedConceptID(s.label,!0),value_text:o(s.reason)?"Past medication history":null,value_drug:o(s.reason)?null:s.reason}))}return!0},async getSideEffectsReasons(t){const e=t.filter(i=>!"".concat(i.label).match(/other/i)&&i.value==="Yes");if(e.length>0){const i=await N.create({component:At,backdropDismiss:!1,cssClass:"large-modal",componentProps:{sideEffects:e,drugs:this.lastDrugsReceived}});i.present();const{data:n}=await i.onDidDismiss();return n}return-1},getFPMethods(t=[],e){return this.consultation.getFamilyPlanningMethods().filter(o=>!t.includes(o)).map(o=>({label:o,value:o,isChecked:e.map(s=>s.label).includes(o)}))},getContraindications(t){const e=E.getConceptsByCategory("contraindication",!0).map(i=>i.name);return this.getOptions([...e,"Other"],t)},getOtherContraindications(t){const e=E.getConceptsByCategory("side_effect",!0).map(n=>n.name),i=e.pop();return this.getOptions([...e,"Other (Specify)","".concat(i)],t)},getTBSymptoms(t){const e=E.getConceptsByCategory("tb_symptom",!0).map(i=>i.name);return this.getOptions([...e],t)},getReasonsForNoCxcaOptions(){return E.getConceptsByCategory("reason_for_no_cxca").map(t=>({label:t.name,value:t.name,other:{c:t}}))},runAppendOptionParams(t,e){const i=e.filter(n=>n.isChecked).map(n=>n.label);return t.map(n=>{var o,s;if(typeof((o=n==null?void 0:n.other)==null?void 0:o.appendOptionParams)=="function"){const u=(s=n==null?void 0:n.other)==null?void 0:s.appendOptionParams();if(typeof u=="object"){const a={label:n.label,value:n.value,other:n.other};return u.isChecked?(a.isChecked=u.isChecked,delete u.isChecked):a.isChecked=i.includes(n.label),{...a,...u}}}return n})},didCompletedTPT(t){var e;return/complete/i.test((e=t.routine_tb_therapy)==null?void 0:e.value)||this.tptStatus.completed},patientOnTpt(t){return this.didCompletedTPT(t)},async on3HPValueUpdate(t,e){const i=s=>!!s.label.match(/IPT|3HP/i),n=(()=>{const s=t.reduce((u,a)=>(i(a)&&!(a.label in u)&&a.isChecked&&u.push(a.label),u),[]);return s.includes("IPT")&&(s.includes("3HP (RFP + INH)")||s.includes("INH 300 / RFP 300 (3HP)"))})(),o=i(e)&&t.filter(s=>i(s)).map(s=>!s.isChecked).every(Boolean);if(i(e)&&o&&!this.tptStatus.completed){const s=await L("Reasons for declining TPT","",["Patient declined","Side-effects (previous or current)","Stock-out","Starting TB treatment","Heavy alcohol use","Hepatic conditions (active hepatitis or liver damage)","Severe/moderate peripheral neuropathy","Hypersensitivity to INH, Rifapentine, or Rifampicin","Other"],[{name:"Done",slot:"start",role:"action"}]);this.reasonForDecliningTPTObs=this.consultation.buildValueText("Other reason for not seeking services",s.selection)}else this.reasonForDecliningTPTObs={};if(n){const s=await x("IPT / 3HP conflict","IPT and 3HP can NOT be prescribed together","Please pick either one",[{name:"Prescribe 3HP",slot:"start",color:"primary"},{name:"Prescribe IPT",slot:"end",color:"primary"}]);return t.map(u=>(i(u)&&(u.isChecked=s==="Prescribe IPT"&&u.label==="IPT"||s==="Prescribe 3HP"&&u.label==="INH 300 / RFP 300 (3HP)"),u))}return t.map(s=>((e.label==="3HP (RFP + INH)"&&s.label==="INH 300 / RFP 300 (3HP)"&&e.isChecked||e.label==="INH 300 / RFP 300 (3HP)"&&s.label==="3HP (RFP + INH)"&&e.isChecked)&&(s.isChecked=!1),s))},medicationOrderOptions(t,e=[]){var f,g;this.isEligibleForTpt=!1;const i=this.didCompletedTPT(t),n=this.tptStatus.tpt!==null,o=this.isBreastFeeding(t),s=this.isPregnant(t),u=((f=t.on_tb_treatment)==null?void 0:f.value)==="Yes"||((g=t.start_tb_treatment)==null?void 0:g.value)==="Yes"||t.tb_module_status,a=h=>({disabled:!0,isChecked:!1,description:{color:"danger",show:"always",text:h}}),m=o?{isChecked:!1,description:{color:"danger",show:"always",text:"Patient is breast feeding"}}:{};return this.runAppendOptionParams([this.toOption("ARVs",{appendOptionParams:()=>({isChecked:this.isEligibleForExtraDtg(t)?!1:this.autoSelect3HP&&!this.TBSuspected})}),this.toOption("CPT",{appendOptionParams:()=>!this.isEligibleForExtraDtg(t)&&this.autoSelect3HP&&!this.TBSuspected&&!this.allergicToSulphur?{isChecked:!0}:this.allergicToSulphur?a("Allergic to CPT"):{disabled:!1}}),this.toOption("3HP (RFP + INH)",{appendOptionParams:()=>{var h;if(i)return a("Completed TPT treatment");if(u)return a("On TB treatment");if(this.tptStatus.tb_treatment)return a("Completed/on TB treatment");if(/confirmed tb/i.test((h=t.tb_status)==null?void 0:h.value))return a("Confirmed TB Not on treatment");if(this.TBSuspected)return a("TB Suspect");if(s)return a("Pregnant patient");if(this.currentWeight<20)return a("Weight below regulation");if(!this.tptStatus.eligible["3HP"]&&!this.tptStatus.eligible["6H"])return a("Not eligible to start or re-start TPT");if(n&&this.tptStatus.tpt!=="3HP (RFP + INH)"&&!this.tptStatus.completed)return a("On ".concat(this.tptStatus.tpt," treatment"));if(this.isEligibleForTpt=this.tptStatus.eligible["3HP"],this.tptStatus.tpt==="3HP (RFP + INH)"&&!this.tptStatus.completed&&this.isEligibleForTpt)return{isChecked:!0,...m}}}),this.toOption("INH 300 / RFP 300 (3HP)",{appendOptionParams:()=>{var h;return i?a("Completed TPT treatment"):u?a("On TB treatment"):this.tptStatus.tb_treatment?a("Completed/on TB treatment"):this.TBSuspected?a("TB Suspect"):/confirmed tb/i.test((h=t.tb_status)==null?void 0:h.value)?a("Confirmed TB Not on treatment"):s?a("Pregnant patient"):this.currentWeight<30?a("Weight below regulation"):!this.tptStatus.eligible["3HP"]&&!this.tptStatus.eligible["6H"]?a("Not eligible to start or re-start TPT"):n&&this.tptStatus.tpt!=="INH 300 / RFP 300 (3HP)"&&!this.tptStatus.completed?a("On ".concat(this.tptStatus.tpt," treatment")):(this.isEligibleForTpt=this.tptStatus.eligible["3HP"],this.tptStatus.tpt==="INH 300 / RFP 300 (3HP)"&&!this.tptStatus.completed&&this.isEligibleForTpt?{isChecked:!0,...m}:{isChecked:this.autoSelect3HP&&this.isEligibleForTpt,...m})}}),this.toOption("IPT",{appendOptionParams:()=>{var h;if(i)return a("Completed TPT treatment");if(u)return a("On TB treatment");if(this.tptStatus.tb_treatment)return a("Completed/on TB treatment");if(this.TBSuspected)return a("TB Suspect");if(/confirmed tb/i.test((h=t.tb_status)==null?void 0:h.value))return a("Confirmed TB Not on treatment");if(s)return a("Pregnant patient");if(!this.tptStatus.eligible["3HP"]&&!this.tptStatus.eligible["6H"])return a("Not eligible to start or re-start TPT");if(n&&this.tptStatus.tpt!=="IPT"&&!this.tptStatus.completed)return a("On ".concat(this.tptStatus.tpt," treatment"));if(this.isEligibleForTpt=this.tptStatus.eligible["6H"],this.tptStatus.tpt==="IPT"&&!this.tptStatus.completed&&this.isEligibleForTpt)return{isChecked:!0,...m}}}),this.toOption("NONE OF THE ABOVE")],e)},async getVlLabData(){return _t.formatLabs(await k.get("GET_LAB_ORDERS_WITH_GIVEN_RESULT_STATUS",{patientID:this.patientID}))},isANCclient(){return X.getSuspendedProgram()==="ANC"},isRapidTestPositive(t){const e="chest x-ray",i="Molecular WHO Recommended Rapid Diagnostic test",n=t.tb_screening_testing_results.reduce((o,s)=>({...o,[s.label]:s.value}),{});return n[i]==="Negative"?!1:n[e]==="Positive"||n[i]==="Positive"},buildTBStatusObs(t){var e,i;return((e=t==null?void 0:t.on_tb_treatment)==null?void 0:e.value)==="Yes"||((i=t.start_tb_treatment)==null?void 0:i.value)==="Yes"?this.consultation.buildValueCoded("TB Status","Confirmed TB on treatment"):t!=null&&t.tb_status?this.consultation.buildValueCoded("TB Status",t.tb_status.value):t!=null&&t.tb_screening_testing_results?this.isRapidTestPositive(t)?this.consultation.buildValueCoded("TB Status","TB Suspected"):this.consultation.buildValueCoded("TB Status","TB NOT suspected"):t!=null&&t.tb_side_effects&&!this.hasTBSymptoms(t)?this.consultation.buildValueCoded("TB Status","TB NOT suspected"):{}},async prescribeExtraDtg(){const t=this.prescription.toOrderObj(982,"Dolutegravir (50mg tablet)","tab(s)",0,1,"Daily (QOD)");t.auto_expire_date=this.extraDtgState.arvExpireDate,await this.prescription.createEncounter(),await this.prescription.createDrugOrder([t]),await this.appointment.createEncounter(),await this.appointment.saveValueDatetimeObs("Appointment date",this.extraDtgState.nextAppointment),await this.appointment.saveValueDatetimeObs("Estimated date",this.extraDtgState.nextAppointment)},async initExtraDtgCheck(t){var i;this.extraDtgState.init||(this.extraDtgState.nextAppointment=await this.appointment.getLastAppointmentDate(),this.extraDtgState.isNewTbTreatment=await this.appointment.getFirstValueCoded("TB treatment")==="Yes");const e=((i=t==null?void 0:t.pills_brought)!=null?i:[]).find(n=>Y.regimenHasDtg(n.other.regimen)&&n.value>0);e&&(this.extraDtgState.onDtg=!0,this.extraDtgState.lastArvStartDate=e.other.order.start_date,this.extraDtgState.arvExpireDate=e.other.order.auto_expire_date,this.extraDtgState.dtgNeeded=e.other.quantity-e.value,this.extraDtgState.consultationBeforeAppointment=this.extraDtgState.nextAppointment?z(this.consultation.date).isBefore(this.extraDtgState.nextAppointment):!1),this.extraDtgState.init=!0},isEligibleForExtraDtg(t){var e,i;return!this.isNoneClientPatient&&(((e=t==null?void 0:t.on_tb_treatment)==null?void 0:e.value)==="Yes"||((i=t==null?void 0:t.start_tb_treatment)==null?void 0:i.value)==="Yes")&&this.extraDtgState.consultationBeforeAppointment&&this.extraDtgState.onDtg&&this.extraDtgState.dtgNeeded>0&&!this.extraDtgState.isNewTbTreatment},isTBPositive(t){var e,i,n;return/confirmed/i.test((i=(e=t.tb_status)==null?void 0:e.value)!=null?i:"")||((n=t.tb_screening_testing_results)==null?void 0:n.some(o=>/Positive/i.test(o.value.toString())))},getFields(){return[{id:"other_patient_prescription",proxyID:"prescription",helpText:"Medication to prescribe during this visit",type:l.TT_MULTIPLE_SELECT,init:async()=>(await this.consultation.getClient()==="No"?this.isNoneClientPatient=!0:this.isNoneClientPatient=!!await bt.isDrugRefillPatient(this.patientID),this.isNoneClientPatient&&(this.currentWeight=Number(await this.patient.getRecentWeight()),this.autoSelect3HP=await k.get("ART_AUTO_3HP_SELECTION"),this.tptStatus=await this.consultation.getTptTreatmentStatus()),!0),beforeNext:async(t,e)=>{if(!Object.keys(this.reasonForDecliningTPTObs).length&&!this.isBreastFeeding(e)&&this.isEligibleForTpt&&!this.patientOnTpt(e)&&!t.some(i=>/3hp|ipt/i.test(i.label)))if(await R("Are you sure you want to proceed without prescribing TPT?")){const i=await L("Reasons for declining TPT","",["Patient declined","Side-effects (previous or current)","Stock-out","Starting TB treatment","Heavy alcohol use","Hepatic conditions (active hepatitis or liver damage)","Severe/moderate peripheral neuropathy","Hypersensitivity to INH, Rifapentine, or Rifampicin","Other"],[{name:"Done",slot:"start",role:"action"}]);this.reasonForDecliningTPTObs=this.consultation.buildValueText("Other reason for not seeking services",i.selection)}else return this.reasonForDecliningTPTObs={},!1;return!0},validation:t=>r.required(t),computedValue:t=>({tag:"consultation",obs:this.buildMedicationOrders(t)}),onValueUpdate:(t,e)=>{const i=this.disablePrescriptions(t,e);return this.on3HPValueUpdate(i,e)},options:(t,e,i,n)=>b.isEmpty(n)?this.medicationOrderOptions(t):n,condition:()=>this.isNoneClientPatient,exitsForm:()=>!0},...D({id:"date_last_received_arvs",helpText:"Last ARV Dispensation",required:!0,init:async()=>(this.wasTransferredIn=await this.getTransferInStatus()||!1,this.dateStartedArt=await this.getDateStartedArt(),!0),condition:()=>this.wasTransferredIn,minDate:()=>this.dateStartedArt,maxDate:()=>this.consultation.getDate(),computeValue:t=>(this.prescription.setDate(t),{tag:"consultation",date:t,obs:this.consultation.buildValueDate("Date drug received from previous facility",t)}),estimation:{allowUnknown:!1}}),{id:"previous_arvs_received",helpText:"Last ARV drugs dispensed",type:l.TT_MULTIPLE_SELECT,computedValue:t=>t.map(e=>e.other),validation:t=>r.required(t),options:async()=>{if(!b.isEmpty(this.customRegimens))return this.customRegimens;const t=new Y(this.patientID,this.providerID);return this.customRegimens=(await t.getARVs()).map(e=>({label:e.name,value:e.drug_id,other:{...e}})),this.customRegimens},config:{showKeyboard:!0},condition:()=>this.wasTransferredIn},{id:"drug_interval",helpText:"Duration period for last received ARVs",type:l.TT_NEXT_VISIT_INTERVAL_SELECTION,condition:()=>this.wasTransferredIn,validation:t=>r.required(t),computedValue:t=>t.other.nextAppointment,options:()=>[{label:"2 weeks",value:14},{label:"1 month",value:28},{label:"2 months",value:56},{label:"3 months",value:84},{label:"4 months",value:112},{label:"5 months",value:140},{label:"6 months",value:168},{label:"7 months",value:196},{label:"8 months",value:224},{label:"9 months",value:252},{label:"10 months",value:280},{label:"11 months",value:308},{label:"12 months",value:336}].map(({label:e,value:i})=>{this.prescription.setNextVisitInterval(i);const n=this.prescription.calculateDateFromInterval();return{label:e,value:i,other:{label:"Medication run-out date:",value:v.toStandardHisDisplayFormat(n),nextAppointment:n,other:{label:"",value:[]}}}})},{id:"arv_quantities",helpText:"Amount of drugs dispensed (From last ART Facility)",type:l.TT_DRUG_TRANSFER_IN,validation:t=>this.validateSeries([()=>r.required(t),()=>t.map(e=>{var i;return e.value===""||((i=e==null?void 0:e.other)==null?void 0:i.pillsBrought)===""}).some(Boolean)?["Some Drugs are missing values"]:null]),computedValue:(t,e,i)=>({tag:"consultation",obs:t.map(async n=>{var s,u,a,m;const o=((u=(s=n==null?void 0:n.other)==null?void 0:s.drug)==null?void 0:u.drug_id)||0;return{...await this.consultation.buildObs("Drug received from previous facility",{value_drug:o,value_datetime:(i==null?void 0:i.drug_interval)||null,value_numeric:(n==null?void 0:n.value)||0}),child:[await this.consultation.buildObs("Number of tablets brought to clinic",{value_drug:o,value_numeric:((a=n==null?void 0:n.other)==null?void 0:a.pillsBrought)||-1,value_datetime:((m=i==null?void 0:i.date_last_received_arvs)==null?void 0:m.date)||null})]}})}),options:(t,e,i)=>e.previous_arvs_received.map(n=>{var m;const o=n.alternative_drug_name||n.drug_name||n.name,s=b.find(i,{label:o});let u="",a="";return s&&(u=s==null?void 0:s.value,a=(m=s==null?void 0:s.other)==null?void 0:m.pillsBrought),{label:o,value:u,other:{drug:n,pillsBrought:a}}}),condition:()=>this.wasTransferredIn},{id:"patient_lab_orders",helpText:"Lab orders",type:l.TT_LAB_ORDERS,init:async()=>(this.labOrders=await this.getVlLabData(),!0),unload:async()=>{await this.checkVLReminder();const t=this.labOrders.filter(e=>e.result_given==="No");if(t.length&&await R("Result(s) Given to Client?")){const e=new H(this.patientID,-1,this.providerID),i=t.reduce((n,o)=>[...n,...o.resultIds.map(async s=>(e.encounterID=o.encounter_id,e.saveObs(await e.buildObs("Result Given to Client",{value_coded:"Yes",obs_group_id:s}))))],[]);await Promise.all(i)}this.labOrders=await this.getVlLabData()},onload:t=>this.labOrderFieldContext=t,options:()=>[{label:"Lab orders",value:"order trail",other:{values:this.labOrders}}],config:{printOrder:t=>Tt(t),hiddenFooterBtns:["Clear"],footerBtns:[{name:"Order",size:"large",slot:"end",color:"primary",visible:!0,onClick:async()=>{b.isEmpty(this.labOrderFieldContext)||await this.labOrderFieldContext.launchOrderSelection()}}]}},{id:"pregnant_breastfeeding",helpText:"Patient Pregnant or breastfeeding?",init:async()=>(this.patient.isFemale()&&(this.patient.isChildBearing()&&(this.hasPregnancyObsToday=await this.patient.hasPregnancyObsToday(),this.currentlyPregnant=await this.patient.isPregnant(),this.currentlyBreastfeeding=await this.patient.isBreastfeeding()),this.onPermanentFPMethods=await this.consultation.getTLObs()),!0),condition:()=>!this.hasPregnancyObsToday&&this.pregnancyEligible(),type:l.TT_MULTIPLE_YES_NO,validation:t=>this.validateSeries([()=>r.required(t),()=>r.anyEmpty(t)]),computedValue:t=>({tag:"consultation",obs:t.map(e=>this.consultation.buildValueCoded(e.other.concept,e.value)).concat(this.isANCclient()?[this.consultation.buildValueCoded("Is patient pregnant","Yes")]:[])}),options:t=>{const e=[];return this.isANCclient()||e.push({label:"Pregnant",value:"",other:{values:this.yesNoOptions(),concept:"Is patient pregnant"}}),e.push({label:"Breastfeeding",value:"",other:{values:this.yesNoOptions(),concept:"Is patient breast feeding"}}),t.pregnant_breastfeeding||e}},{id:"patient_weight_chart",helpText:"Patient weight chart",type:l.TT_WEIGHT_CHART,init:async()=>(this.weightTrail=await this.patient.getWeightHistory(),this.weightLossPercentageNum=this.patient.getWeightLossPercentageFromTrail(this.weightTrail),this.lostTenPercentBodyWeight=this.weightLossPercentageNum>=10,!0),options:async()=>{const t=await this.patient.getBMI(),e=this.weightTrail;return[{label:"Weight for patient",value:"Weight trail",other:{bmi:t,values:e.map(i=>({x:v.toStandardHisDisplayFormat(i.date),y:i.weight})),age:this.patient.getAge()}}]},config:{hiddenFooterBtns:["Clear"]}},{id:"has_fp_methods",helpText:"",type:l.TT_TEXT_BANNER,condition:()=>this.onPermanentFPMethods,options:()=>this.mapStrToOptions(["Patient is on Tubal ligation method"])},{id:"current_fp_methods",helpText:"What method are you currently on?",type:l.TT_MULTIPLE_SELECT,init:async()=>(this.patient.isFemale()&&(this.patientHitMenopause=await this.consultation.patientHitMenopause()),!0),validation:t=>r.required(t),onValueUpdate:(t,e)=>this.disableFPMethods(t,e),computedValue:t=>({tag:"consultation",obs:t.map(e=>this.consultation.buildValueCoded("Family planning method",e.value))}),condition:t=>this.showCurrentContraceptionMethods(t),options:(t,e)=>this.getFPMethods([],e)},{id:"fp_methods",helpText:"What method are you providing today?",type:l.TT_MULTIPLE_SELECT,condition:t=>this.showNewContraceptionMethods(t),validation:t=>r.required(t),onValueUpdate:(t,e)=>this.disableFPMethods(t,e),computedValue:t=>({tag:"consultation",obs:t.map(e=>this.consultation.buildValueCoded("Family planning, action to take",e.value))}),options:(t,e)=>this.getFPMethods([],e)},{id:"reason_for_no_fpm",helpText:"Main reason for not using family planning methods",type:l.TT_SELECT,validation:t=>r.required(t),condition:t=>this.declinedFPM(t),computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueText("Why does the woman not use birth control",t.value)}),options:()=>this.mapStrToOptions(["Not Sexually active","Patient want to get pregnant","Not needed for medical reasons","Not Interested; At risk of unplanned pregnancy","Menopause"])},{id:"specific_reason_for_no_fpm",helpText:"Specific reason for not using family planning methods",type:l.TT_SELECT,validation:t=>r.required(t),computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueText("Reason for not using contraceptives",t.value)}),condition:t=>this.riskOfUnplannedPregnancy(t),options:()=>this.mapStrToOptions(["Following wishes of spouse","Religious reasons","Afraid of side effects","Never though about it","Indifferent (does not mind getting pregnant)"])},{id:"offer_contraceptives",helpText:"Offer contraceptives",type:l.TT_SELECT,validation:t=>r.required(t),condition:t=>this.riskOfUnplannedPregnancy(t),computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueCoded("Family planning, action to take",t.value)}),options:()=>[{label:"Accepted",value:"Yes"},{label:"Declined",value:"No"},{label:"Discuss with spouse",value:"Discuss with spouse"}]},{id:"offered_intervention",helpText:"Offered intervention",type:l.TT_MULTIPLE_SELECT,validation:t=>r.required(t),condition:t=>t.offer_contraceptives.value==="Accepted",computedValue:t=>({tag:"consultation",obs:t.map(e=>this.consultation.buildValueCoded(e.label,e.value))}),options:(t,e)=>this.getFPMethods(["NONE"],e)},{id:"offer_cxca",helpText:"Refer client for CxCa screening",type:l.TT_SELECT,init:async()=>{if(this.patient.isFemale()&&(this.CxCaEnabled=await G.cervicalCancerScreeningEnabled(),this.CxCaEnabled)){const{start:t,end:e}=await G.cervicalCancerScreeningAgeBounds();this.CxCaMaxAge=e,this.CxCaStartAge=t,this.DueForCxCa=await this.consultation.clientDueForCxCa(),this.clientHadAHysterectomy=await this.consultation.clientHasHadAHysterectomy()}return!0},validation:t=>r.required(t),condition:t=>this.canScreenCxCa()&&!this.isPregnant(t),computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueCoded("Offer CxCa",t.value)}),options:()=>this.yesNoOptions()},{id:"cxca_reminder",helpText:"CxCa Screening Reminder",type:l.TT_TEXT_BANNER,init:async()=>(this.CxCaEnabled&&this.patient.isFemale()&&(this.CxCaAppointDate=await this.patient.nextAppointment(24)),!0),condition:()=>30>v.dateDiffInDays(this.CxCaAppointDate,this.consultation.date),options:()=>this.mapStrToOptions(["Patient is due for Cervical Cancer Screening on ".concat(v.toStandardHisDisplayFormat(this.CxCaAppointDate.appointment_date))])},{id:"reason_for_no_cxca",helpText:"Reason for NOT offering CxCa",type:l.TT_SELECT,validation:t=>r.required(t),condition:t=>t.offer_cxca.value==="No",computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueCoded("Reason for NOT offering CxCa",t.value)}),options:()=>this.getReasonsForNoCxcaOptions()},...D({id:"previous_cxca_test_date",helpText:"Previous CxCa test",required:!0,minDate:()=>this.patient.getBirthdate(),maxDate:()=>_.getSessionDate(),condition:t=>t.reason_for_no_cxca.value==="Not due for screening",computeValue:(t,e)=>e?{tag:"consultation",obs:this.consultation.buildValueDateEstimated("CxCa test date",t)}:{tag:"consultation",obs:this.consultation.buildValueDate("CxCa test date",t)},estimation:{allowUnknown:!0,estimationFieldType:j.MONTH_ESTIMATE_FIELD}}),{id:"previous_side_effects",helpText:"Side effects / Contraindications history",type:l.TT_DATA_TABLE,init:async()=>(this.sideEffectsHistory=await this.consultation.getDrugSideEffects(),!0),config:{columns:()=>[[C.thTxt("Date"),C.thTxt("Condition"),C.thTxt("Drug induced"),C.thTxt("Drug")]],rows:()=>Object.keys(this.sideEffectsHistory).map(t=>Object.values(this.sideEffectsHistory[t]).filter(e=>!b.isEmpty(e.name)).map(e=>[C.tdDate(t),C.td(e.name),C.td(e.drug_induced?"Yes":"No"),C.td(e.drug)])).reduce((t,e)=>t.concat(e),[])}},{id:"side_effects",helpText:"Contraindications / Side effects (select either 'Yes' or 'No')",type:l.TT_MULTIPLE_YES_NO,init:async()=>(this.lastDrugsReceived=await this.consultation.getPreviousDrugs(),!0),validation:t=>this.validateSeries([()=>r.required(t),()=>r.anyEmpty(t)]),computedValue:t=>({tag:"consultation",obs:t.map(async e=>({...await this.consultation.buildValueCoded("Malawi ART side effects",e.label),child:[await this.consultation.buildValueCoded(e.label,e.value)]}))}),beforeNext:t=>this.buildSideEffectObs(t,"malawiSideEffectReasonObs"),options:(t,e)=>this.getContraindications(e)},{id:"other_side_effects",helpText:"Other Contraindications / Side effects (select either 'Yes' or 'No')",type:l.TT_MULTIPLE_YES_NO,onValue:async t=>(await this.checkIfWeightLossIsControlled(t),!0),condition:t=>this.showOtherSideEffects(t),onConditionFalse:()=>this.otherSideEffectReasonObs=[],validation:t=>this.validateSeries([()=>r.required(t),()=>r.anyEmpty(t)]),computedValue:t=>({tag:"consultation",obs:t.filter(e=>e.label!="Other (Specify)").map(async e=>({...await this.consultation.buildValueCoded("Other side effect",e.label),child:[await this.consultation.buildValueCoded(e.label,e.value)]}))}),beforeNext:t=>this.buildSideEffectObs(t,"otherSideEffectReasonObs"),options:(t,e)=>this.getOtherContraindications(e)},{id:"other_side_effect_specify",helpText:"Other Contraindications / Side effects (specify)",type:l.TT_NOTE,computedValue:async t=>({tag:"consultation",obs:{...await this.consultation.buildValueCoded("Other side effect","Other (Specify)"),child:[await this.consultation.buildValueText("Other (Specify)",t.value)]}}),condition:t=>this.inArray(t.other_side_effects,e=>e.label==="Other (Specify)"&&e.value==="Yes"),validation:t=>r.required(t)},(()=>{const t=new Et(this.patientID);return{id:"tb_module_status",helpText:"TB Module Status",type:l.TT_SUMMARY,init:async()=>(await t.loadTbProgram(),!0),computedValue:e=>({tag:"consultation",obs:e.filter(i=>{var n;return(n=i==null?void 0:i.other)==null?void 0:n.obs}).map(i=>i.other.obs())}),condition:()=>t.isOnTreatment,options:()=>[{label:"TB Status",value:t.isPositive?"Positive":"Negative",other:{obs:()=>this.consultation.buildValueCoded("TB Status","Confirmed TB on treatment")}},{label:"Treatment status",value:"On Treatment",other:{obs:()=>this.consultation.buildValueCoded("TB treatment","Yes")}},{label:"Treatment start date",value:ft(t.outcomeDate),other:{obs:()=>this.consultation.buildValueDate("TB treatment start date",t.outcomeDate)}},{label:"Treatment period in months",value:t.maxPeriodOnTreatment,other:{obs:()=>this.consultation.buildValueNumber("TB treatment period",t.maxPeriodOnTreatment)}}]}})(),{id:"on_tb_treatment",helpText:"On TB Treatment?",type:l.TT_SELECT,validation:t=>r.required(t),computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueCoded("TB treatment",t.value)}),condition:t=>!t.tb_module_status,options:()=>this.yesNoOptions()},{id:"tb_side_effects",helpText:"TB Associated symptoms",type:l.TT_MULTIPLE_YES_NO,onValue:async t=>(await this.checkIfWeightLossIsControlled(t),!0),validation:t=>this.validateSeries([()=>r.required(t),()=>r.anyEmpty(t)]),condition:t=>{var e;return(e=t.on_tb_treatment)==null?void 0:e.value.match(/no/i)},options:(t,e)=>this.getTBSymptoms(e),computedValue:t=>({tag:"consultation",obs:t.map(async e=>({...await this.consultation.buildValueCoded("Routine TB Screening",e.label),child:[await this.consultation.buildValueCoded(e.label,e.value)]}))})},{id:"tb_status",helpText:"TB Status",type:l.TT_SELECT,validation:t=>r.required(t),condition:t=>this.hasTBSymptoms(t),onConditionFalse:()=>this.TBSuspected=!1,defaultValue:()=>"TB Suspected",options:()=>this.mapStrToOptions(["TB NOT Suspected","TB Suspected","Confirmed TB Not on treatment"])},{id:"tb_screening_testing_methods",helpText:"TB screening method used",type:l.TT_MULTIPLE_YES_NO,validation:t=>r.anyEmpty(t),condition:t=>{var e;return!this.hasTBSymptoms(t)||((e=t.tb_status)==null?void 0:e.value.toString().includes("Suspected"))},options:t=>{var e,i;return[{label:"chest x-ray",value:((e=(t.tb_screening_testing_methods||[])[0])==null?void 0:e.value)||"",other:{values:this.yesNoOptions(),resultOptions:[{label:"Abnormal",value:"Positive"},{label:"Normal",value:"Negative"}]}},{label:"Molecular WHO Recommended Rapid Diagnostic test",value:((i=(t.tb_screening_testing_methods||[])[1])==null?void 0:i.value)||"",other:{values:this.yesNoOptions(),resultOptions:[{label:"Positive",value:"Positive"},{label:"Negative",value:"Negative"}]}}]}},{id:"tb_screening_testing_results",helpText:"TB screening result",type:l.TT_MULTIPLE_YES_NO,validation:t=>r.required(t),condition:t=>t.tb_screening_testing_methods.some(e=>e.value==="Yes"),options:t=>t.tb_screening_testing_methods.filter(i=>i.value==="Yes").map(i=>{var n;return{value:((n=(t.tb_screening_testing_results||[]).find(o=>o.label===i.label)||[])==null?void 0:n.value)||"",label:i.label,other:{values:i.other.resultOptions}}}),computedValue:t=>({tag:"consultation",obs:t.map(async e=>({...await this.consultation.buildValueCoded("TB screening method used",e.label),child:[await this.consultation.buildValueCoded(e.label,e.value)]}))})},{id:"start_tb_treatment",helpText:"Start TB Treatment?",type:l.TT_SELECT,validation:t=>r.required(t),computedValue:async t=>({tag:"consultation",obs:[await this.consultation.buildValueCoded("TB treatment",t.value),this.consultation.buildValueDate("TB treatment start date",this.consultation.date)]}),condition:t=>this.isTBPositive(t),options:()=>this.yesNoOptions(),beforeNext:async t=>(t.value==="No"&&await x("TB Treatment Not Initiated","Patient has tested positive for TB but treatment has not been started","TB treatment should be initiated as soon as possible for optimal patient outcomes",[{name:"Continue",color:"primary",slot:"start"}]),!0)},{id:"tb_date_started_treatment_known",helpText:"TB treatment history",type:l.TT_YES_NO,init:async()=>{this.hasTbTreatmentDate=!1;const t=await _.getFirstValueDatetime(this.patientID,"TB treatment start date"),e=await _.getFirstValueNumber(this.patientID,"TB treatment period");if(e&&t){const i=z(this.consultation.date).diff(t,"months");this.hasTbTreatmentDate=i<=e}return!0},validation:t=>r.required(t),condition:t=>!this.hasTbTreatmentDate&&t.on_tb_treatment.label==="Yes",options:()=>[{label:"Date started treatment known?",values:this.yesNoOptions()}]},...D({id:"tb_start_date",helpText:"Enter start date for treatment?",required:!0,minDate:()=>this.patient.getBirthdate(),maxDate:()=>_.getSessionDate(),condition:t=>t.tb_date_started_treatment_known==="Yes",computeValue:t=>({tag:"consultation",obs:this.consultation.buildValueDate("TB treatment start date",t)}),estimation:{allowUnknown:!1}}),{id:"tb_treatment_period",helpText:"Enter Full TB Treatment Period (In Months)",type:l.TT_NUMBER,validation:t=>r.validateSeries([()=>r.required(t),()=>r.isNumber(t),()=>r.rangeOf(t,3,9)]),condition:t=>t.tb_date_started_treatment_known==="Yes"||t.start_tb_treatment.label==="Yes",computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueNumber("TB treatment period",t.value)})},{id:"routine_tb_therapy",helpText:"TB preventive therapy (TPT) history",type:l.TT_SELECT,init:async()=>(this.hasTbHistoryObs=await this.consultation.hasTreatmentHistoryObs(),!0),validation:t=>r.required(t),condition:()=>!this.hasTbHistoryObs,computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueText("Previous TB treatment history",t.value)}),options:t=>{var i;let e=[];return/no/i.test("".concat((i=t.on_tb_treatment)==null?void 0:i.value))&&(e=["Currently on IPT","Currently on 3HP (RFP + INH)","Currently on INH 300 / RFP 300 (3HP)"]),e=e.concat(["Complete course of 3HP in the past (3 months RFP+INH)","Complete course of IPT in the past (min. 6 months of INH)","Aborted course of 3HP (RFP + INH) in the past","Aborted course of INH 300 / RFP 300 (3HP) in the past","Aborted course of IPT in the past","Never taken IPT or 3HP"]),this.mapStrToOptions(e)}},...D({id:"date_started_tpt",helpText:"Started TPT Treatment",required:!0,minDate:()=>this.patient.getBirthdate(),maxDate:()=>_.getSessionDate(),condition:t=>t.routine_tb_therapy.value.match(/currently/i),computeValue:t=>t,estimation:{allowUnknown:!0,estimationFieldType:j.MONTH_ESTIMATE_FIELD}}),{id:"tpt_drugs_received",helpText:"TPT Drugs Received",required:!0,condition:t=>t.routine_tb_therapy.value.match(/currently/i),type:l.TT_ADHERENCE_INPUT,options:t=>this.getTptDrugs(t),computedValue:(t,e,i)=>({tag:"consultation",obs:t.map(async n=>{var o;return this.consultation.buildObs("TPT Drugs Received",{value_drug:((o=n==null?void 0:n.other)==null?void 0:o.drug_id)||0,value_datetime:(i==null?void 0:i.date_started_tpt)||null,value_numeric:(n==null?void 0:n.value)||0})})}),config:{titles:{label:"Drug name",value:"Tablets received"}}},{id:"tpt_tranfer_from",helpText:"Facility client is transferring in from",type:l.TT_SELECT,computedValue:({label:t})=>({tag:"consultation",obs:this.consultation.buildValueText("Location TPT last received",t)}),validation:t=>r.required(t),condition:t=>t.routine_tb_therapy.value.match(/currently/i),options:(t,e="")=>mt(e),config:{showKeyboard:!0,isFilterDataViaApi:!0}},{id:"allergic_to_sulphur",helpText:"Allergic to Cotrimoxazole",type:l.TT_SELECT,validation:t=>r.required(t),computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueCoded("Allergic to sulphur",t.value)}),beforeNext:t=>(this.isAllergicToSulphur(t),!0),options:()=>this.yesNoUnknownOptions()},...this.getAdherenceFields(!0),{id:"refer_to_clinician",helpText:"Refer to clinician",type:l.TT_SELECT,condition:()=>gt.isNurse(),validation:t=>r.required(t),computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueCoded("Refer to clinician",t.value)}),options:()=>this.yesNoOptions()},{id:"medication_to_prescribe",proxyID:"prescription",helpText:"Medication to prescribe during this visit",type:l.TT_MULTIPLE_SELECT,init:async()=>(this.isNoneClientPatient||(this.currentWeight=Number(await this.patient.getRecentWeight()),this.autoSelect3HP=await k.get("ART_AUTO_3HP_SELECTION"),this.tptStatus=await this.consultation.getTptTreatmentStatus()),!0),beforeNext:async(t,e)=>{if(!Object.keys(this.reasonForDecliningTPTObs).length&&!this.isBreastFeeding(e)&&this.isEligibleForTpt&&!this.patientOnTpt(e)&&!t.some(i=>/3hp|ipt/i.test(i.label)))if(await R("Are you sure you want to proceed without prescribing TPT?")){const i=await L("Reasons for declining TPT","",["Patient declined","Side-effects (previous or current)","Stock-out","Starting TB treatment","Heavy alcohol use","Hepatic conditions (active hepatitis or liver damage)","Severe/moderate peripheral neuropathy","Hypersensitivity to INH, Rifapentine, or Rifampicin","Other"],[{name:"Done",slot:"start",role:"action"}]);this.reasonForDecliningTPTObs=this.consultation.buildValueText("Other reason for not seeking services",i.selection)}else return this.reasonForDecliningTPTObs={},!1;return!0},condition:t=>!t.refer_to_clinician||"".concat(t.refer_to_clinician.value).match(/no/i),validation:t=>r.required(t),computedValue:t=>({tag:"consultation",obs:this.buildMedicationOrders(t)}),onValueUpdate:(t,e)=>{const i=this.disablePrescriptions(t,e);return this.on3HPValueUpdate(i,e)},options:async(t,e,i,n)=>(await this.initExtraDtgCheck(t),this.medicationOrderOptions(t,n)),config:{footerBtns:[{name:"Update allergic to CPT",onClickComponentEvents:{refreshOptions:(t,e,i)=>(this.allergicToSulphur=t.btnOutput==="Allergic",this.medicationOrderOptions(i,e))},onClick:()=>x("Allergic to Cotrimoxazole update","Is the patient allergic to cotrimoxazole.","",[{name:"Allergic",slot:"start",color:"success"},{name:"NOT Allergic",slot:"end"}])}]}}]}}});function Rt(t,e,i,n,o,s){const u=p("his-standard-form");return S(),A(u,{fields:t.fields,onFinishAction:t.onFinish,skipSummary:!0,cancelDestinationPath:t.cancelDestination},null,8,["fields","onFinishAction","cancelDestinationPath"])}const Qt=q(Ft,[["render",Rt]]);export{Qt as default};
