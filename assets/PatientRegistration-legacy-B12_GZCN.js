System.register(["./dynamic-import-helper-legacy-DYK5bIOV.js","./HisStandardForm-legacy-DHvPmsWP.js","./MultiFieldDateHelper-legacy-BKSEfgg6.js","./index-legacy-DzF0J2nr.js","./PersonFieldHelper-legacy-D2qk71Du.js","./TouchScreenForm-legacy-CDzY5o9b.js","./ToolbarMediumCard-legacy-BDSK2XWR.js","./Transformers-legacy-DhNYVLaS.js","./ViewPort-legacy-BcrZm7RF.js","./KbLayouts-legacy-BKvPSxzZ.js","./HisKbConfigurations-legacy-vrLd9Pgz.js","./LocationFieldOptions-legacy-COMbtKBt.js"],(function(e,t){"use strict";var i,a,n,s,r,o,l,d,h,u,c,p,m,_,g,y,f,C,b,D,v,F,T,I,P,A,E,N,w,S;return{setters:[e=>{i=e.F},e=>{a=e.H},e=>{n=e.g},e=>{s=e.d,r=e.I,o=e.aJ,l=e.s,d=e.R,h=e.aX,u=e.P,c=e.p,p=e.aY,m=e.q,_=e.ab,g=e.ad,y=e.V,f=e.aZ,C=e.H,b=e.a_,D=e.t,v=e.a$,F=e.b0,T=e.aO,I=e._,P=e.r,A=e.o,E=e.c,N=e.w,w=e.b},e=>{S=e.P},null,null,null,null,null,null,null],execute:function(){const t=s({components:{HisStandardForm:a,IonPage:r},data:()=>({app:o.getActiveApp(),ddeInstance:{},ddeDocID:"",ddeIsReassign:!1,skipSummary:!1,currentAddressAttributes:["current_region","current_district","current_village","current_traditional_authority"],homeAddressAttributes:["home_region","home_district","home_traditional_authority","home_village"],hasIncompleteData:!1,patient:{},editPersonData:{},editPerson:-1,personAttribute:"",activeField:"",fieldComponent:"",fields:[],isMilitarySite:!1,presets:{},registrationSummary:{},form:{},ddeEnabled:!1}),watch:{$route:{async handler({query:e}){this.ddeInstance=new l,e.edit_person?(this.ddeIsReassign=e.dde_reassign,this.ddeDocID=e.doc_id,this.ddeInstance.setPatientID(e.edit_person),e.person_attribute&&(this.personAttribute=e.person_attribute),await this.initEditMode(e.edit_person)):this.presets=e,this.fields=this.getFields()},immediate:!0,deep:!0}},methods:{getFields(){let e=[];return e.push(this.personIndexField()),e.push(this.givenNameField()),e.push(this.familyNameField()),e.push(this.genderField()),e.push(this.searchResultField()),e=e.concat(this.dobFields()),e.push(this.homeRegionField()),e.push(this.homeDistrictField()),e.push(this.homeTAField()),e.push(this.homeVillageField()),e.push(this.currentRegionField()),e.push(this.currentDistrictField()),e.push(this.currentTAField()),e.push(this.currentVillage()),e=e.concat(this.landmarkFields()),e.push(this.cellPhoneField()),e.push(this.patientTypeField()),e.push(this.facilityLocationField()),e.push(this.occupationField()),e.push(this.hasMalawiNationalIdField()),e.push(this.malawiNationalIdField()),e.push(this.relationshipField()),e.push(this.possibleDuplicatesField()),e.push(this.patientRegistrationSummary()),e},isEditMode(){return this.editPerson>=1},async initEditMode(e){this.editPerson=e,this.patient=await d.get("ACTIVE_PATIENT",{patientID:parseInt(`${this.editPerson}`)});const{ancestryDistrict:t,ancestryTA:i,ancestryVillage:a,currentDistrict:n,currentVillage:s,currentTA:r}=this.patient.getAddresses();this.editPersonData={given_name:this.patient.getGivenName(),family_name:this.patient.getFamilyName(),gender:this.patient.getGender(),birthdate:this.patient.getBirthdate(),home_district:t,home_traditional_authority:i,home_village:a,current_district:n,current_village:s,current_traditional_authority:r,cell_phone_number:this.patient.getPhoneNumber(),landmark:this.patient.getClosestLandmark(),occupation:this.patient.getOccupation(),national_id:this.patient.getMWNationalID()},this.presets=this.editPersonData,this.skipSummary=!0,this.personAttribute&&(this.activeField=this.personAttribute,this.fieldComponent=this.activeField)},async onFinish(e,t){return this.isEditMode()?(e.malawi_national_identifier?.value&&(await this.patient.updateMWNationalId(e.malawi_national_identifier?.value),this.editPersonData.national_id=e.malawi_national_identifier?.value),this.update(t)):this.create(e,t)},async create(e,t){let i=S.resolvePerson(t);i="true"==this.presets.nationalIDStatus?this.appendNationalIDData(i):i;const a=this.resolvePersonAttributes(t),n=new h,s=new u(await n.registerPatient(i,a)),r=n.getPersonID();d.set("ACTIVE_PATIENT",s);let o="";if("true"==this.presets.nationalIDStatus?o=this.presets?.identifier:"Yes"===e.has_malawi_id?.value&&(o=e.malawi_national_identifier?.value),o&&(this.patient=s,await this.patient.updateMWNationalId(o)),!this.app.onRegisterPatient||!(await this.app.onRegisterPatient(r,i,a,this.$router,this.$route)))return"Yes"===i.relationship?this.$router.push(`/guardian/registration/${r}`):void(await c(r,this.$router))},appendNationalIDData(e){return Object.assign(e,{given_name:this.presets.given_name,family_name:this.presets.family_name,gender:this.presets.gender,birthdate:this.presets.birthdate,birthdate_estimated:!1})},async update(e){const t=S.resolvePerson(e),i=new h;i.setPersonID(this.editPerson),await i.updatePerson(t);for(const a in t)a in this.editPersonData&&(this.editPersonData[a]=t[a]);if(d.invalidate("ACTIVE_PATIENT"),!this.personAttribute)return this.fieldComponent="edit_user";this.$router.back()},editConditionCheck(e=[]){return!(this.isEditMode()&&!e.includes(this.activeField))},async confirmPatient(){if(this.ddeEnabled&&(!this.patient.getDocID()||this.patient.getDocID()&&this.patient.getNationalID().match(/unknown/i)))try{await this.patient.assignNpid(),await this.patient.printNationalID(),await p(300)}catch(e){m(`Failed to assign new NPID: ${e}`)}this.$router.push(`/patients/confirm?person_id=${this.patient.getID()}`)},resolvePersonAttributes:e=>Object.values(e).filter((e=>_.isPlainObject(e)&&"personAttributes"in e)).map((({personAttributes:e})=>e)),mapToOption:e=>e.map((e=>({label:e,value:e}))),givenNameField(){const e=S.getGivenNameField();return e.condition=()=>this.editConditionCheck(["given_name"])&&"true"!=this.presets.nationalIDStatus,e.defaultValue=()=>this.presets.given_name,e},familyNameField(){const e=S.getFamilyNameField();return e.condition=()=>this.editConditionCheck(["family_name"])&&"true"!=this.presets.nationalIDStatus,e.defaultValue=()=>this.presets.family_name,e},genderField(){const e="ANC"===this.app.applicationName,t="CxCa"===this.app.applicationName,i=S.getGenderField();return i.requireNext=this.isEditMode(),i.defaultValue=()=>this.presets.gender,i.condition=()=>!(!this.isEditMode()&&(e||t))&&this.editConditionCheck(["gender"])&&"true"!=this.presets.nationalIDStatus,!e&&!t||this.isEditMode()||(i.defaultOutput=()=>({label:"Female",value:"F"}),i.defaultComputedOutput=()=>({person:"F"})),i.beforeNext=async e=>{const t=e.value,i=this.presets.gender;return!this.isEditMode()||t==i||"Change gender"===await g("Warning",`Changing gender from ${i} to ${t}`,"This change will cause data inconsistency and will affect alot of Reports.",[{name:"Cancel",slot:"start"},{name:"Change gender",slot:"end",color:"danger"}])},i},dobFields(){const e=S.getDobConfig();if(e.defaultValue=()=>this.presets.birthdate,e.condition=()=>!(this.presets.birthdate&&this.presets.nationalIDStatus)&&this.editConditionCheck(["year_birth_date","month_birth_date","day_birth_date"]),"ANC"===this.app.applicationName){const t=u.getSessionDate(),i=12;e.maxDate=()=>v(t).subtract(i,"years").format(F)}return n(e)},homeRegionField(){const e=S.getHomeRegionField();return e.condition=()=>this.editConditionCheck(this.homeAddressAttributes),e},homeDistrictField(){const e=S.getHomeDistrictField();return e.condition=()=>this.editConditionCheck(this.homeAddressAttributes),e},homeTAField(){const e=S.getHomeTaField();return e.condition=e=>this.editConditionCheck(this.homeAddressAttributes)&&!e.home_region.label.match(/foreign/i),e},homeVillageField(){const e=S.getHomeVillageField();return e.condition=e=>this.editConditionCheck(this.homeAddressAttributes)&&!e.home_region.label.match(/foreign/i),e},currentRegionField(){const e=S.getCurrentRegionField();return e.condition=()=>this.editConditionCheck(this.currentAddressAttributes),e},currentDistrictField(){const e=S.getCurrentDistrictField();return e.condition=()=>this.editConditionCheck(this.currentAddressAttributes),e},currentTAField(){const e=S.getCurrentTAfield();return e.condition=e=>this.editConditionCheck(this.currentAddressAttributes)&&!e.current_region.label.match(/foreign/i),e},currentVillage(){const e=S.getCurrentVillageField();return e.condition=e=>this.editConditionCheck(this.currentAddressAttributes)&&!e.current_region.label.match(/foreign/i),e},cellPhoneField(){const e=S.getCellNumberField();return e.condition=()=>this.editConditionCheck(["cell_phone_number"]),e.defaultValue=()=>this.presets.cell_phone_number,e},facilityLocationField(){const e=S.getFacilityLocationField();return e.condition=e=>["Emergency supply","External consultation"].includes(e.patient_type.value),e},landmarkFields(){const e=S.getLandmarkFields();return e[0].condition=()=>this.editConditionCheck(["default_landmarks"]),e},patientTypeField(){return{id:"patient_type",helpText:"Type of patient",type:i.TT_SELECT,computedValue:e=>({person:e.value}),condition:()=>this.editConditionCheck(["patient_type"])&&"ART"===this.app.applicationName,validation:e=>y.required(e),options:()=>f.getPatientTypes()}},occupationField(){const e="AETC"===this.app.applicationName;return{id:"occupation",helpText:"Occupation",type:i.TT_SELECT,init:async()=>(this.isMilitarySite=await d.get("IS_MILITARY_SITE"),!0),computedValue:e=>({person:e.value}),condition:()=>this.editConditionCheck(["occupation"])&&this.isMilitarySite||e,validation:e=>y.required(e),options:()=>{const t=["Military","Civilian"];if(e){const e=["Business","Craftsman","Domestic Worker","Driver","Farmer","Healthcare Worker","House Wife","Mechanic","Messenger","Office Worker","Police","Preschool Child","Prisoner","Sales Person","Security Guard","Soldier","Student","Teacher","Other","unknown"];return this.mapToOption([...t,...e])}return this.mapToOption(t)}}},regimentField(){return{id:"person_regiment_id",helpText:"Regiment ID",type:i.TT_TEXT,computedValue:({value:e})=>({personAttributes:{person_attribute_type_id:35,value:e}}),condition:e=>this.editConditionCheck(["person_regiment_id","occupation"])&&e.occupation&&e.occupation.value.match(/Military/i),validation:e=>y.required(e)}},rankField(){return{id:"rank",helpText:"Rank",type:i.TT_SELECT,validation:e=>y.required(e),computedValue:({value:e})=>({personAttributes:{person_attribute_type_id:36,value:e}}),condition:e=>this.editConditionCheck(["rank","occupation"])&&e.occupation&&e.occupation.value.match(/Military/i),options:()=>this.mapToOption(["First Lieutenant","Captain","Major","Lieutenant Colonel","Colonel","Brigadier General","Lieutenant General","General","Private","Corporal","Lance Corporal","Seargent","Staff Seargent","Warrant Officer class 1","Warrant Officer class 2"])}},dateJoinedMilitaryFields(){return n({id:"person_date_joined_military",helpText:"Joined Military",required:!0,condition:e=>this.editConditionCheck(["year_person_date_joined_military","month_person_date_joined_military","day_person_date_joined_military","occupation"])&&e.occupation&&e.occupation.value.match(/Military/i),minDate:()=>C.estimateDateFromAge(100),maxDate:()=>T.getSessionDate(),estimation:{allowUnknown:!1},computeValue:e=>({date:e,personAttributes:{person_attribute_type_id:37,value:e}})})},relationshipField(){const e="CxCa"===this.app.applicationName,t="OPD"===this.app.applicationName,a="Registration"===this.app.applicationName;return{id:"relationship",helpText:"Register guardian?",type:i.TT_SELECT,computedValue:e=>({person:e.value}),condition:()=>this.editConditionCheck(["relationship"])&&!e&&!t&&!a,validation:e=>y.required(e),options:()=>this.mapToOption(["Yes","No"])}},searchResultField(){return{id:"results",helpText:"Search results",type:i.TT_PERSON_RESULT_VIEW,init:async()=>(this.isEditMode()||(this.ddeEnabled=await d.get("IS_DDE_ENABLED")),!0),dynamicHelpText:e=>"true"==this.presets.nationalIDStatus?`Search results for "${this.presets.given_name} ${this.presets.family_name} | ${this.presets.gender}"`:`Search results for "${e.given_name.value} ${e.family_name.value} | ${e.gender.label}"`,appearInSummary:()=>!1,condition:()=>!this.$route.query.skipSearch&&!this.isEditMode(),validation:e=>y.required(e),options:async e=>{let t;return"true"==this.presets.nationalIDStatus?(this.presets.gender="Male"==this.presets.gender?"M":"F",t={given_name:this.presets.given_name,family_name:this.presets.family_name,gender:this.presets.gender}):t={given_name:e.given_name.value,family_name:e.family_name.value,gender:e.gender.value},this.ddeEnabled?(await this.ddeInstance.searchDemographics(t)).map((e=>{const t=S.getPersonAttributeOptions(e);return t.other.options.push({label:"Patient Type",value:e.patient_type}),t.other.options.push({label:"Doc ID",value:e.doc_id}),t})):(await u.search(t)).map((e=>S.getPersonAttributeOptions(e)))},config:{hiddenFooterBtns:["Clear","Next","Back"],footerBtns:[{name:"Edit Search",slot:"end",onClick:()=>{this.fieldComponent="given_name"}},{name:"New Patient",slot:"end",onClick:()=>{"true"!=this.presets.nationalIDStatus?this.fieldComponent="year_birth_date":this.fieldComponent="home_region"}},{name:"Continue",color:"success",slot:"end",state:{disabled:{default:()=>!0,onValue:(e,t)=>_.isEmpty(t.results)}},onClick:e=>e.results.other.patientID?this.$router.push(`/patients/confirm?person_id=${e.results.value}`):this.$router.push(`/patients/confirm?patient_barcode=${e.results.value}`)}]}}},possibleDuplicatesField(){let e={},t={};return{id:"possible_duplicates",helpText:"Possible Duplicate(s)",type:i.TT_PERSON_MATCH_VIEW,condition:async(i,a)=>!!(this.ddeEnabled&&this.editPerson<=0)&&(e=S.resolvePerson(a),t=await this.ddeInstance.checkPotentialDuplicates(e),t.length>=1),options:async()=>{const i=e=>C.toStandardHisDisplayFormat(e);return t.map((({score:t,person:a})=>({label:`${a.given_name} ${a.family_name}`,value:a.patient_id,other:{score:100*t+"%",newPerson:e,foundPerson:a,docID:a.id,comparisons:[["Name",`${e.given_name} ${e.family_name}`,`${a.given_name} ${a.family_name}`],["Gender",e.gender,a.gender],["Birthdate",i(e.birthdate),i(a.birthdate)],["Home District",e.home_district,a.home_district],["Home TA",e.home_traditional_authority,a.home_traditional_authority]]}})))},config:{hiddenFooterBtns:["Clear","Next"],footerBtns:[{name:"Not Duplicate",slot:"start",state:{visible:{default:()=>!1,onValue:(e,t)=>!_.isEmpty(t.possible_duplicates)}},onClick:()=>{this.fieldComponent="_NEXT_FIELD_"}},{name:"Select",slot:"end",color:"success",state:{visible:{default:()=>!1,onValue:(e,t)=>!_.isEmpty(t.possible_duplicates)}},onClick:e=>{this.ddeInstance.importPatient(e.possible_duplicates.other.docID).then((e=>{this.$router.push(`/patients/confirm?person_id=${e.patient_id}`)})).catch((()=>{this.$router.push(`/patients/confirm?person_id=${e.possible_duplicates.value}`)}))}}]}}},hasMalawiNationalIdField(){return{id:"has_malawi_id",helpText:"Does client have a Malawi National ID?",type:i.TT_SELECT,condition:()=>this.editConditionCheck(["has_malawi_id"])&&"true"!=this.presets.nationalIDStatus,validation:e=>y.required(e),options:()=>[{label:"Yes",value:"Yes"},{label:"No",value:"No"}]}},malawiNationalIdField(){return{id:"malawi_national_identifier",helpText:"Malawi National ID",type:i.TT_TEXT,computedValue:e=>({mwID:e.value}),condition:e=>this.editConditionCheck(["has_malawi_id"])&&"Yes"===e.has_malawi_id.value,validation:e=>y.validateSeries([()=>y.required(e),()=>y.isMWNationalID(e)])}},personIndexField(){return{id:"edit_user",helpText:"Edit Demographics",type:i.TT_TABLE_VIEWER,init:async()=>(this.isEditMode()&&(this.ddeEnabled=await d.get("IS_DDE_ENABLED"),this.isMilitarySite=await d.get("IS_MILITARY_SITE")),!0),condition:()=>this.isEditMode(),options:async()=>{const e=e=>({name:"Edit",type:"button",action:()=>{this.activeField=e,this.fieldComponent=this.activeField}}),t=[["Malawi National ID",this.editPersonData.national_id,/unknown/i.test(this.editPersonData.national_id)?e("has_malawi_id"):"N/A"],["Given Name",this.editPersonData.given_name,e("given_name")],["Family Name",this.editPersonData.family_name,e("family_name")],["Gender",this.editPersonData.gender,e("gender")],["Birthdate",C.toStandardHisDisplayFormat(this.editPersonData.birthdate),e("year_birth_date")],["Cell Phone Number",this.editPersonData.cell_phone_number,e("cell_phone_number")],["Home District",this.editPersonData.home_district,e("home_region")],["Home TA",this.editPersonData.home_traditional_authority,e("home_region")],["Home Village",this.editPersonData.home_village,e("home_region")],["Current district",this.editPersonData.current_district,e("current_region")],["Current Village",this.editPersonData.current_village,e("current_region")],["Current T/A",this.editPersonData.current_traditional_authority,e("current_region")],["Landmark",this.editPersonData.landmark,e("default_landmarks")]];this.isMilitarySite&&t.push(["Occupation",this.editPersonData.occupation,e("occupation")]);const i={indexes:[],class:"his-empty-set-color"};return t.forEach(((e,t)=>{b(e[1])&&i.indexes.push(t)})),this.hasIncompleteData=i.indexes.length>=1,[{label:"",value:"",other:{rows:t,columns:["Attributes","Values","Edit"],rowColors:[i]}}]},config:{footerBtns:[{name:"Reassign",slot:"end",color:"success",state:{visible:{default:()=>!1,onload:()=>this.ddeEnabled&&this.ddeIsReassign&&!this.hasIncompleteData}},onClick:async()=>{try{await this.ddeInstance.reassignNpid(this.ddeDocID,this.editPerson),await this.ddeInstance.printNpid(),this.$router.push(`/patients/confirm?person_id=${this.editPerson}`)}catch(e){D(`${e}`)}}},{name:"Confirm",slot:"end",color:"warning",state:{visible:{onload:()=>!this.ddeIsReassign&&!this.hasIncompleteData}},onClick:async()=>this.confirmPatient()}],hiddenFooterBtns:["Clear","Next"]}}},patientRegistrationSummary(){return{id:"registration_summary",helpText:"Summary",type:i.TT_SUMMARY,condition:()=>!this.skipSummary,options:(e,t)=>this.buildRegistrationSummary(t),config:{hiddenFooterBtns:["Clear"]}}},buildRegistrationSummary(e){e=(e=Object.keys(e).map((function(t){if(null!=e[t])return{label:t.replace(/_/g," ").replace(/(^\w|\s\w)/g,(e=>e.toUpperCase())),value:"birth_date"==t?e[t].date:e[t].mwID||e[t].person}}))).filter((e=>null!=e));const t=[{label:"Given Name",value:this.presets.given_name},{label:"Family Name",value:this.presets.family_name},{label:"Gender",value:this.presets.gender},{label:"Birthdate",value:this.presets.birthdate},{label:"Malawi National ID",value:this.presets.identifier}];return"true"==this.presets.nationalIDStatus&&(e=t.concat(e)),e}}});e("default",I(t,[["render",function(e,t,i,a,n,s){const r=P("his-standard-form"),o=P("ion-page");return A(),E(o,null,{default:N((()=>[w(r,{onOnIndex:t[0]||(t[0]=t=>e.fieldComponent=""),skipSummary:!0,activeField:e.fieldComponent,fields:e.fields,onFinishAction:e.onFinish},null,8,["activeField","fields","onFinishAction"])])),_:1})}]]))}}}));
