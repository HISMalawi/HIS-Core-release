import{d as V,bY as j,Y as F,X as z,_ as K,a3 as L,a8 as U,a4 as q,a9 as J,I as X,aj as Y,aE as G,ad as S,aN as b,ae as B,bn as R,W,au as Z,cA as Q,aa as x,c as D,w as s,af as d,a as o,b as a,K as n,E as i,J as p,G as h,M as N,C as m,a2 as C}from"./index-DpVM51Mk.js";import{_ as ee}from"./EncounterMixin.vue_vue_type_script_lang-CBh-AybA.js";import{B as w,H as P}from"./htn_service-D3PpdiZi.js";import"./encounter_guidelines-Cnr48ESD.js";import"./GuidelineEngine-D6V1_Znr.js";import"./HisStandardForm-CyU-At7_.js";const te=V({mixins:[ee],components:{ViewPort:j,IonToolbar:F,IonHeader:z,IonContent:K,IonRow:L,IonButton:U,IonCol:q,IonFooter:J,IonPage:X,IonCheckbox:Y},watch:{ready:{async handler(t){if(t){this.HTN=new w(this.patientID,this.providerID),this.drugs=this.HTN.getDrugs();const{drugs:e,notes:r}=await this.HTN.getCurrentDrugs();this.setPreviousBpDrugs(e),this.setPreviousBpNotes(r),this.canClearHtnSessionPrescription=this.patientHasHtnSessionKey()}},immediate:!0}},data:()=>({HTN:{},drugs:null,otherBpDrugs:[],canClearHtnSessionPrescription:!1}),methods:{clearPrescriptionInSession(){sessionStorage.removeItem(P.Prescription),this.canClearHtnSessionPrescription=!1},showMoreBpDrugs(){G([{id:"drug",helpText:"Select BP drugs",type:S.TT_MULTIPLE_SELECT,init:async()=>{b.isEmpty(this.otherBpDrugs)&&(await w.getAllBpDrugs()).forEach(e=>{this.otherBpDrugs.push({label:e.name,value:e.drug_id,other:e})});const t=this.getStandardSelectedDrugs().map(e=>e.drug_id);return this.otherBpDrugs=this.otherBpDrugs.map(e=>({...e,isChecked:t.includes(e.value)})),!0},onValueUpdate:t=>(Object.keys(this.drugs).forEach(e=>this.drugs[e].drugs=this.drugs[e].drugs.map(r=>({...r,selected:t.some(u=>u.value===r.drugID&&u.isChecked)}))),t),options:()=>this.otherBpDrugs,validation:t=>B.required(t),config:{showKeyboard:!0}},{id:"dosage",helpText:"Custom dose",type:S.TT_DOSAGE_INPUT,condition:t=>!b.isEmpty(t.drug),validation:t=>B.required(t)?["Drugs are not available"]:t.some(({other:e})=>e.am<=0&&e.noon<=0&&e.pm<=0)?["Missing dosage configuration on some drugs"]:null,computedValue:t=>t.map(e=>e.other),options:t=>t.drug.map(e=>({label:e.label,value:e.value,other:{drug_id:e.other.drug_id,drug_name:e.label,barcodes:e.other.barcodes,units:e.other.units,am:0,noon:0,pm:0,frequency:"Daily (QOD)"}}))}],(t,e)=>this.cacheSelectedDrugsAndProceed(e.dosage))},patientHasHtnSessionKey(){try{const t=sessionStorage.getItem(P.Prescription);if(t)return JSON.parse(t)[this.patientID]}catch(t){console.warn(t)}return!1},removeNote(t,e){this.drugs[t].notes.splice(e,1)},launchNotePad(t){this.showModal({id:"note",helpText:"Add notes for ".concat(t),type:S.TT_TEXT},e=>{e&&this.drugs[t].notes.push({date:R.getSessionDate(),description:e.value||"",drugID:this.drugs[t].drugs[0].drugID,isNewNote:!0})})},async onFinish(){const t=Object.values(this.drugs).filter(e=>!b.isEmpty(e.notes)).map(e=>e.notes).reduce((e,r)=>e.concat(r),[]).filter(e=>e.isNewNote).map(e=>this.HTN.buildObs("Clinician notes",{value_text:e.description,value_drug:e.drugID}));if(!b.isEmpty(t))try{await this.HTN.createEncounter(),await this.HTN.saveObservationList(await Promise.all(t))}catch(e){return W("Unable to save notes ".concat(e))}this.cacheSelectedDrugsAndProceed(this.getStandardSelectedDrugs())},getStandardSelectedDrugs(){return this.selectedDrugs.map(t=>b.find(w.htnDrugReferences(),{drug_id:t.drugID}))},cacheSelectedDrugsAndProceed(t){const e={};e[this.patientID]=t,sessionStorage.setItem(P.Prescription,JSON.stringify(e)),this.$router.push("/art/encounters/prescriptions/".concat(this.patientID))},async showModal(t,e){(await Z.create({component:Q,backdropDismiss:!1,cssClass:"full-modal",componentProps:{dismissType:"modal",currentField:t,onFinish:e}})).present()},setPreviousBpNotes(t){for(const e in t)this.drugs[e].notes=Object.keys(t[e]).map(r=>t[e][r].map(u=>({date:r,description:u,isNewNote:!1}))).reduce((r,u)=>r.concat(u),[])},setPreviousBpDrugs(t){t.forEach(e=>{for(const r in this.drugs)this.drugs[r].drugs.forEach((u,y)=>{e.drug_id===u.drugID&&(this.drugs[r].drugs[y].current=!0,this.drugs[r].drugs[y].selected=!0,this.drugs[r].selected=e.drug_id)})})},selectDrug(t,e,r){this.drugs[t].drugs.forEach((u,y)=>{this.drugs[t].drugs[y].selected=!1}),this.drugs[t].drugs[e].selected=r.detail.checked}},computed:{selectedDrugs(){return this.drugs?Object.values(this.drugs).map(t=>t.drugs).reduce((t,e)=>t.concat(e),[]).filter(t=>t.selected):[]}}}),se={key:0,class:"view-port-content"},oe={id:"main-table",style:{width:"100%"}},ne={id:"table-notes",style:{width:"100%"}},re={class:"table-inner-notes",id:"notes-HCTZ"},ae={class:"date-td today-td"},ie={class:"date-td today-td"};function le(t,e,r,u,y,ue){const k=d("ion-col"),v=d("ion-row"),T=d("ion-toolbar"),E=d("ion-header"),H=d("ion-checkbox"),_=d("ion-button"),O=d("view-port"),$=d("ion-content"),A=d("ion-footer"),M=d("ion-page");return o(),D(M,null,{default:s(()=>[a(E,null,{default:s(()=>[a(T,null,{default:s(()=>[a(v,null,{default:s(()=>[a(k,null,{default:s(()=>e[0]||(e[0]=[n("label",{class:"his-title"}," Prescribe BP drugs ",-1)])),_:1})]),_:1})]),_:1})]),_:1}),a($,null,{default:s(()=>[a(O,null,{default:s(()=>[t.drugs?(o(),i("div",se,[n("table",oe,[n("tr",null,[e[1]||(e[1]=n("th",null," ",-1)),(o(!0),i(p,null,h(t.drugs,(c,l)=>(o(),i("th",{key:l},[m(C(l)+" ",1),a(v,null,{default:s(()=>[(o(!0),i(p,null,h(c.drugs,(g,f)=>(o(),D(k,{class:"col-borders",key:f},{default:s(()=>[m(C(g.amount||"0mg"),1)]),_:2},1024))),128))]),_:2},1024)]))),128))]),n("tr",null,[e[2]||(e[2]=n("td",{class:"td-remaining td-title"},[n("span",null,"New/Current")],-1)),(o(!0),i(p,null,h(t.drugs,(c,l)=>(o(),i("td",{key:l,class:"td-current td-value"},[a(v,null,{default:s(()=>[(o(!0),i(p,null,h(c.drugs,(g,f)=>(o(),D(k,{key:f},{default:s(()=>[a(H,{checked:g.selected,onIonChange:I=>t.selectDrug(l,f,I)},null,8,["checked","onIonChange"])]),_:2},1024))),128))]),_:2},1024)]))),128))]),n("tr",null,[e[4]||(e[4]=n("td",{class:"td-remaining td-title"},[n("span",null," ")],-1)),(o(!0),i(p,null,h(Object.keys(t.drugs),(c,l)=>(o(),i("td",{class:"td-remaining td-value",key:l},[a(v,null,{default:s(()=>[a(k,null,{default:s(()=>[a(_,{onClick:g=>t.launchNotePad(c),color:"warning"},{default:s(()=>e[3]||(e[3]=[m(" Add notes ")])),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]))),128))])]),e[8]||(e[8]=n("p",null,null,-1)),n("table",ne,[e[6]||(e[6]=n("caption",{style:{"font-size":"1.2em"}}," Notes ",-1)),e[7]||(e[7]=n("p",null,null,-1)),n("tr",null,[(o(!0),i(p,null,h(t.drugs,(c,l)=>(o(),i("th",{style:{width:"25%"},key:l},[n("span",null,C(l),1)]))),128))]),n("tr",null,[(o(!0),i(p,null,h(Object.keys(t.drugs),(c,l)=>(o(),i("td",{id:"HCTZ",style:{"padding-top":"2px !important"},valign:"top",key:l},[n("table",re,[(o(!0),i(p,null,h(t.drugs[c].notes,(g,f)=>(o(),i("tr",{key:f},[n("td",ae,C(g.date),1),n("td",ie,C(g.description),1),n("td",null,[g.isNewNote?(o(),D(_,{key:0,color:"danger",onClick:I=>t.removeNote(c,f)},{default:s(()=>e[5]||(e[5]=[m(" X ")])),_:2},1032,["onClick"])):N("",!0)])]))),128))])]))),128))])])])):N("",!0)]),_:1})]),_:1}),a(A,null,{default:s(()=>[a(T,{color:"dark"},{default:s(()=>[a(_,{size:"large",color:"danger",slot:"start",onClick:t.gotoPatientDashboard},{default:s(()=>e[9]||(e[9]=[m(" Cancel ")])),_:1},8,["onClick"]),a(_,{onClick:t.showMoreBpDrugs,size:"large",slot:"end"},{default:s(()=>e[10]||(e[10]=[m(" More Drugs ")])),_:1},8,["onClick"]),t.canClearHtnSessionPrescription?(o(),D(_,{key:0,size:"large",color:"warning",slot:"end",onClick:t.clearPrescriptionInSession},{default:s(()=>e[11]||(e[11]=[m(" Clear Session Prescription ")])),_:1},8,["onClick"])):N("",!0),t.selectedDrugs&&t.selectedDrugs.length>0?(o(),D(_,{key:1,size:"large",color:"success",slot:"end",onClick:t.onFinish},{default:s(()=>e[12]||(e[12]=[m(" Continue ")])),_:1},8,["onClick"])):N("",!0)]),_:1})]),_:1})]),_:1})}const fe=x(te,[["render",le],["__scopeId","data-v-00ea3049"]]);export{fe as default};
