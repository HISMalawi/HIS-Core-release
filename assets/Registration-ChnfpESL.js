import{d as U,br as F,r as y,bU as M,bZ as C,u as O,e5 as T,an as v,bq as k,bY as b,a_ as V,cs as H,aR as _,l as $,e0 as B,ao as g,a as L,b as Y,w as j,e as G,i as x,e6 as N,aA as W,q as X}from"./index-CJleCCtM.js";import{H as Z}from"./HisStandardForm-BPNPJCrM.js";import{u as z}from"./useEncounter-BYi6HXkG.js";import{m as J,r as K}from"./commons-CcXQGk9e.js";import{I as Q}from"./identifier_service-bUlEAoUS.js";import"./isEmpty-Dwdx9lIX.js";import"./encounter_guidelines-CfQXyRxl.js";import"./GuidelineEngine-D6V1_Znr.js";const ce=U({__name:"Registration",setup(ee){const D=F.getActiveApp(),I=y([]),a=new M(-1,C.TB_REGISTRATION),c=new Q,s=y(),l=y(""),o=O();function u(r){const[n,f]="".concat(r).split("/");if(f)return"".concat(l.value).concat(n,"/").concat(f);const[d]="".concat(a.date).split("-");return"".concat(l.value).concat(n,"/").concat(d.trim())}const p={"Multi drug resistance treatment":{type:T.MDR,label:"Patient DR TB Number",indexID:"DR TB Number",concept:"MDR_NUMBER"},"Tuberculosis Preventive Treatment (TPT)":{type:T.IPT,label:"Patient IPT Number",indexID:"IPT Number",concept:"TB_NUMBER"},"Currently in treatment":{type:T.TB,label:"Patient TB Number",indexID:"TB Number",concept:"TB_NUMBER"},DEFAULT:{type:T.TB,label:"Patient TB Number",indexID:"TB Number",concept:"TB_NUMBER"}},{goToNextTask:E,patientDashboardUrl:P,patientId:R}=z((r,n,f,d)=>{a.patientID=n,a.providerID=r;const h=()=>{let e={};const t=Object.values(p).find(i=>i.indexID===o.query.type);return{id:"reassign",helpText:"Reassign ".concat(o.query.type,": ").concat(o.query.id),proxyID:"patientIdentifier",type:v.TT_NUMBER,init:async()=>{e=await k.getProgramInformation(n),!o.query.id&&b.isOnTreatment(e.current_outcome)&&"".concat(e.tb_number).split("/").length>0&&await V("Caution!","Client is currently using program number ".concat(e.tb_number),"Current outcome is ".concat(e.current_outcome," updated on ").concat(H(e.current_outcome_date)),[{name:"Ok",color:"primary",slot:"start"}]);const[i,m]="".concat(o.query.id).split("/");return c.setIdentifierType(t==null?void 0:t.type),l.value="".concat(i,"/").concat(m,"/"),!0},beforeNext:async i=>{const m=u("".concat(i.value)),q=await c.getPatientsByIdentifier(m);return _.isEmpty(q)?!0:($("".concat(m," is already in use!!")),!1)},computedValue:i=>({obs_datetime:a.date,value_text:u("".concat(i.value)),concept_id:B(t==null?void 0:t.concept)}),condition:()=>o.query.reassign,validation:i=>g.required(i)}},A=()=>({id:"new",helpText:"Identifier:",proxyID:"patientIdentifier",type:v.TT_NUMBER,init:async()=>{var e,t,i;return p[d.outcome]?s.value=p[d.outcome]:s.value=p.DEFAULT,c.setIdentifierType((e=s.value)==null?void 0:e.type),l.value=await((i=D.programPatientIdentifiers[(t=s.value)==null?void 0:t.indexID])==null?void 0:i.prefix()),!0},beforeNext:async e=>{const t=u("".concat(e.value)),i=await c.getPatientsByIdentifier(t);return _.isEmpty(i)?!0:($("".concat(t," is already in use!!")),!1)},computedValue:e=>{var t;return{obs_datetime:a.date,value_text:u("".concat(e.value)),concept_id:B((t=s.value)==null?void 0:t.concept)}},condition:e=>{var t;return!((t=e.reassign)!=null&&t.value)},validation:e=>g.required(e),dynamicHelpText:()=>{var e;return(e=s.value)==null?void 0:e.label}}),S=()=>({id:"idSummary",helpText:"Identifier",type:v.TT_TEXT_BANNER,options:e=>{var t;return J(["".concat((t=s.value)==null?void 0:t.label,": <br/> <b>").concat(u(e.patientIdentifier.value),"</b>")])}});I.value=[h(),A(),S()]});async function w(r,n){await a.createEncounter(),await a.saveObservationList(await K(n)),r.new?await N.create(R.value,c.identifierType,u(r.patientIdentifier.value)):await N.update(parseInt("".concat(o.query.reassign)),u(r.patientIdentifier.value)),await b.printTBNumber(a.patientID),W.invalidate("ACTIVE_PATIENT"),E()}return(r,n)=>(L(),Y(x(X),null,{default:j(()=>[G(Z,{cancelDestinationPath:x(P),onFinishAction:w,fields:I.value,skipSummary:!0},null,8,["cancelDestinationPath","fields"])]),_:1}))}});export{ce as default};
