import{d as I,I as M,ch as F,K as b,N,ac as q,O as p,t as E,n as B,ae as x,cu as O,q as S,cv as H,cw as U,cx as L,cy as X,_ as j,r as C,o as V,c as W,w as G,b as R}from"./index-BbPYANJn.js";import{D as K}from"./ReportDateSelectionPrompt-ky060BJP.js";import{T as Q}from"./tx_report_service-0Au3rqR3.js";import{v as z}from"./TableView-ra7g-iYd.js";import{A}from"./ArtDrilldown-CdKUSW1X.js";import{R as J}from"./ReportErrors-Bh41HAsP.js";import{M as Y}from"./moh_cohort_service-Bo_zqICL.js";import"./fuse-YdZE3OCN.js";import"./Export-BN6ZqWE3.js";import"./HisKeyboard-BC4PLlfH.js";const Z=I({components:{IonPage:M,IonLoading:F,v2Datatable:z},setup(){const o=b([]),m=b(""),g=b(!1),l=new Q,c=b([]),_=new Y,u=(a,s)=>({ref:s,label:a,toValue:n=>n.length,tdClick:async n=>{n.refData.length&&(await p.create({component:A,backdropDismiss:!1,cssClass:"large-modal",componentProps:{subtitle:m,patientIdentifiers:n.refData,title:"".concat(n.data.age_group," ").concat(n.data.gender," ").concat(n.column.label),onFinish:()=>p.getTop().then(e=>e&&p.dismiss())}})).present()}}),w=[[{label:"#",ref:"index"},{label:"Age group",ref:"age_group"},{label:"Gender",ref:"gender"},u("Tx new CD4 <200","cd4_less_than_200"),u("Tx new CD4 >=200","cd4_greater_than_equal_to_200"),u("Tx new CD4 Unknown","cd4_unknown_or_not_done"),u("Transfer-ins","transfer_in")]],f=function(a){const s=c.value.findIndex(n=>n.id===a.id);s!==-1?c.value[s]=a:c.value.push(a)},D=async function(a){const s="validationErrors";(await p.create({id:s,component:J,backdropDismiss:!1,cssClass:"large-modal",componentProps:{errors:a}})).present(),f({id:s,text:"<b>".concat(a.length,"</b> validation errors detected"),icon:X,color:"danger",action:()=>D(a)})};function P(a){const s={initiated_on_art_first_time:{param:a.total,check:(e,t)=>e!=t,error:(e,t)=>"\n                        MOH cohort initiated on ART first time <b>(".concat(e,")</b> is not matching Tx New <b>(").concat(t,")</b>\n                    ")},initial_pregnant_females_all_ages:{param:a.pregnant,check:(e,t)=>e!=t,error:(e,t)=>"\n                        MOH cohort initial pregnant females all ages \n                        <b>(".concat(e,")</b> is not matching with TX new Pregnant women <b>").concat(t,"</b>\n                    ")},males_initiated_on_art_first_time:{param:a.male,check:(e,t)=>e!=t,error:(e,t)=>"\n                        MoH Cohort males initiated on ART first time <b>(".concat(e,")</b>\n                        is not matching with TX new All male <b>(").concat(t,")</b>\n                    ")},"quarterly_re_initiated_on_art + transfer_in":{param:a.transfer_in,check:(e,t)=>e!=t,error:(e,t)=>"\n                        Quarterly Transfer In + Reinitiated Clients <b>".concat(e,"</b>  does not match Transfer In <b>").concat(t,"</b> clients in TXNEW report\n                    ")}};_.validateIndicators(s,e=>{e.length?D(e):f({id:"reportOk",text:"<b>Report is consistent</b>",icon:L,color:"success"})})===-1&&D(["Report not validated. Run the MoH cohort report for similar reporting period and then run this report"])}const $=async(a=!1)=>{if(!(l.startDate&&l.endDate))return E("Start date and end date required!");const s=a&&await B("Do you want to rebuild report?");g.value=!0,o.value=[];try{const n=await l.getTxNewReport(s),t=n.filter(r=>!["All"].includes(r.age_group)).reduce((r,i)=>(r[i.gender]=Object.keys(i).reduce((d,h)=>Array.isArray(i[h])?{...d,[h]:[...d[h]||[],...i[h]]}:d,r[i.gender]||{}),r),{Male:{},Female:{}});o.value=n;const k=n.reduce((r,i)=>{if(i.gender==="FP"){const d=Object.values(i).filter(Array.isArray).flat();return r.concat(d)}return r},[]),v=["cd4_less_than_200","cd4_greater_than_equal_to_200","cd4_unknown_or_not_done"],T=x.uniq(["Female","Male"].reduce((r,i)=>[...r,...v.map(d=>t[i][d]).flat(1)],[]));f({id:"stats",text:"Tx new <b>".concat(T.length,"</b>"),icon:O,color:"primary",action:async()=>{(await p.create({component:A,backdropDismiss:!1,cssClass:"large-modal",componentProps:{title:"All TxNew",subtitle:m.value,patientIdentifiers:T,onFinish:()=>p.getTop().then(r=>r&&p.dismiss())}})).present()}}),P({total:T.length,pregnant:x.uniq(v.map(r=>t.Female[r].filter(i=>k.includes(i))).flat(1)).length,male:x.uniq(v.map(r=>t.Male[r]).flat(1)).length,transfer_in:[...t.Male.transfer_in,...t.Female.transfer_in].length}),o.value=o.value.map((r,i)=>({index:i+1,...r}))}catch(n){console.error("".concat(n)),S("Unable to generate report!"),c.value=[{text:"Unable to generate report!",color:"danger",icon:H,action:function(){c.value=[{text:"Exception occured: <b>".concat(n,"</b>"),color:"danger",icon:U}]}}]}g.value=!1},y=()=>K({onFinish:(a,s,n,e)=>{m.value=n,l.startDate=a,l.endDate=s,e&&l.setOccupation(e),_.setStartDate(l.startDate),_.setEndDate(l.endDate),$()}});return N(()=>y()),{Img:q,headerBadge:c,reportData:o,isLoading:g,configure:y,generate:$,columns:w,period:m}}});function ee(o,m,g,l,c,_){const u=C("ion-loading"),w=C("v2Datatable"),f=C("ion-page");return V(),W(f,null,{default:G(()=>[R(u,{"is-open":o.isLoading,message:"Please wait..."},null,8,["is-open"]),R(w,{"icon-url":o.Img("login-logos/PEPFAR.png"),title:"Pepfar Tx New","report-prefix":"Pepfar",subtitle:o.period,columns:o.columns,columnData:o.reportData,rowsPerPage:100,headerBadge:o.headerBadge,onConfigure:o.configure,onRefresh:()=>o.generate(!0)},null,8,["icon-url","subtitle","columns","columnData","headerBadge","onConfigure","onRefresh"])]),_:1})}const pe=j(Z,[["render",ee]]);export{pe as default};
