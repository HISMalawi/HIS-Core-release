System.register(["./index-legacy-pSEoxn3J.js","./drug_order_service-legacy-BgTMjiEt.js","./drug_service-legacy-2EnhKurZ.js","./drug_prescription_service-legacy-KXVw9x3g.js","./HisStandardForm-legacy-CGi-zolz.js","./useEncounter-legacy-D27v7I9F.js","./isEmpty-legacy-De9HmsH6.js","./encounter_guidelines-legacy-mYSO8ZN5.js","./GuidelineEngine-legacy-KsvQuFdF.js"],(function(e,a){"use strict";var t,r,n,i,s,o,u,l,d,c,g,p,y,h,m,_,f,D,b,T,v,w,E,q,S,M;return{setters:[e=>{t=e.bW,r=e.bk,n=e.d,i=e.r,s=e.an,o=e.ao,u=e.a_,l=e.a,d=e.w,c=e.e,g=e.f,p=e.m,y=e.aF,h=e.dM,m=e.aw,_=e.z,f=e.b,D=e.bM,b=e.a1,T=e.H},e=>{v=e.D},e=>{w=e.D},e=>{E=e.D,q=e.A},e=>{S=e.H},e=>{M=e.u},null,null,null],execute:function(){class a extends t{static getDrugs;constructor(e,a){super(e,25,a)}async loadDrugs(e="",a=1,t=10){return(await w.getDrugs({name:e,page:a,page_size:t,concept_set:"OPD Medication"})).map((e=>({label:e.name,value:e.name,other:e})))}async getDrugs(e="",a=1,t=10){return(await w.getDrugs({name:e,page:a,page_size:t,concept_set:"OPD Medication"})).map((e=>({label:e.name,value:e.name,other:e})))}async hasMalaria(){const e=await r.getLatestMalariaTestResult(this.patientID);return"No"===e?!!(await t.getAllValueCoded(this.patientID,"Primary diagnosis")).includes("Malaria")||!!(await t.getAllValueCoded(this.patientID,"Secondary diagnosis")).includes("Malaria"):"Positive"===e}createDrugOrder(e){return v.create({encounter_id:this.encounterID,drug_orders:e})}}e("default",n({__name:"DrugPrescription",setup(e){const t=i([]);let r,n;const{goToNextTask:v}=M(((e,i)=>{n=new a(i,e),t.value=[{id:"drug_selection",helpText:"Select the drugs to be prescribed",type:o.TT_INFINITE_SCROLL_MULTIPLE_SELECT,onload:e=>r=e,validation:e=>s.required(e),options:async(e,a="",t=1,r=10)=>n.getDrugs(a,t,r),onValueUpdate:async e=>{for(let t=0;t<e.length;t++)if(e[t].isChecked&&!((a=e[t].other).dosage&&a.frequency&&a.duration)){const a=await P(e[t]);u.isEmpty(a)?e.splice(t,1):(e[t].other={...e[t].other,...a},r.filter="",r.selected="")}var a;return e},config:{isFilterDataViaApi:!0,showKeyboard:!0,footerBtns:[{name:"Predefined Malaria Drugs",color:"primary",size:"large",visible:!1,slot:"end",onClick:I}]}},{id:"summary",helpText:"Prescribed Drugs",type:o.TT_TABLE_VIEWER,options:e=>{const a=e.drug_selection.map((e=>[e.label,e.other.dosage,E.find((a=>a.code===e.other.frequency))?.label,e.other.duration]));return[{label:"Prescribed Drugs",value:"",other:{columns:["Drug","Dosage","Frequency","Duration"],rows:a}}]}}]}));async function w(e){const t=function(e){const t=a.getSessionDate();return e.map((e=>{const a=E.find((a=>a.code===e.other.frequency));return{drug_inventory_id:e.other.drug_id,equivalent_daily_dose:"Unknown"==e.other.dosage?0:e.other.dosage*a?.value||0,start_date:t,auto_expire_date:x(t,e.other.duration),units:e.other.units,instructions:`${e.label}: ${e.other.dosage} ${e.other.units} ${a?.code||""} for ${e.other.duration} days`,dose:e.other.dosage,frequency:a?.code||""}}))}(e.drug_selection);try{await n.createEncounter(),await n.createDrugOrder(t),await D.isSummaryPrintingEnabled()&&b(n.patientID),v()}catch(r){console.error(r)}}function x(e,a){const t=new Date(e);return t.setDate(t.getDate()+parseInt(a)),T.toStandardHisFormat(t)}async function I(){await async function(){return await n.hasMalaria()||m("Patient has no malaria. Do you still want to prescribe anti malaria drugs?")}()&&await y([{id:"malaria_drug",helpText:"Select the malaria drug to be prescribed",type:o.TT_SELECT,validation:e=>s.required(e),options:()=>q.map((e=>({value:e.name,label:e.name,other:{...e,dosage:e.dose_strength,frequency:E.find((a=>a.value===e.frequency))?.code}})))}],(async e=>{r.checkedItems.push({...e.malaria_drug,isChecked:!0}),await _.dismiss()}))}async function P(e){return new Promise((a=>{y([{id:"frequency",helpText:`Select the frequency for ${e.label}`,type:o.TT_SELECT,requireNext:!1,validation:e=>s.required(e),computedValue:e=>e.value,options:()=>E.map((e=>({value:e.code,label:e.label,other:e})))},{id:"dosage",helpText:`Enter the dosage for ${e.label}`,type:o.TT_NUMBER,defaultValue:()=>e.other.dose_strength,validation:e=>s.required(e),computedValue:e=>Number(e.value),config:{keypad:[h,[["DELETE"]]]}},{id:"duration",helpText:`Enter the duration for ${e.label}`,type:o.TT_NUMBER,validation:e=>s.required(e),computedValue:e=>Number(e.value)}],(async(e,t)=>{await _.dismiss(),a(t)}),(()=>a({})))}))}return(e,a)=>(f(),l(g(p),null,{default:d((()=>[c(S,{"skip-summary":"",fields:t.value,onFinishAction:w},null,8,["fields"])])),_:1}))}}))}}}));
