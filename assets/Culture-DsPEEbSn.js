import{H as C}from"./HisStandardForm-BCjM4-bc.js";import{u as L}from"./useEncounter-CsCeua2V.js";import{d as N,r as v,bQ as A,bV as O,ar as P,ad as d,ae as u,d$ as s,e1 as U,ao as F,a as M,c as k,w as V,b as $,u as S,bU as b,e2 as w,aW as B,I as x,a_ as y}from"./index-CMZASHAR.js";import{r as Y}from"./commons-Bp7XBfaW.js";import"./isEmpty-DjKeGqZh.js";import"./encounter_guidelines-CJXpBOk4.js";import"./GuidelineEngine-D6V1_Znr.js";const K=N({__name:"Culture",setup(G){const h=v([]),n=new A(-1,O.LAB_RESULTS),R=v(),D=P(),{goToNextTask:p,patientDashboardUrl:E,facts:g}=L((c,l,m)=>{n.patientID=l,n.providerID=c,R.value=m;const _=()=>({id:"sampleResult",helpText:"Sample Result:",type:d.TT_SELECT,validation:e=>u.required(e),computedValue:e=>[{concept_id:s("TB_STATUS"),value_coded:s("".concat(e.value)),obs_datetime:n.date},{concept_id:s("BACTERIOLOGICALLY_DIAGNOSED"),value_coded:s("YES_ANSWER"),obs_datetime:n.date},{concept_id:s("PROCEDURE_TYPE"),value_coded:s("CULTURE_AND_DST"),obs_datetime:n.date},...e.value==="POSITIVE"?[{concept_id:s("TB_TYPE"),value_coded:s("PULMONARY_TB"),obs_datetime:n.date}]:[]],options:()=>[{value:"POSITIVE",label:"Culture Positive"},{value:"NEGATIVE",label:"Culture Negative"}]}),f=()=>({id:"treatmentType",helpText:"Select treatment drugs:",type:d.TT_SELECT,validation:e=>u.required(e),condition:e=>e.sampleResult.value==="POSITIVE",options:()=>[{value:"FIRST_LINE",label:"Firstline Drugs"},{value:"SECOND_LINE",label:"DR TB Drugs"}]}),i=()=>({id:"sampleResistance",helpText:"Firstline Drug Resistance:",type:d.TT_MULTIPLE_SELECT,condition:e=>e.treatmentType.value==="FIRST_LINE",computedValue:e=>{const t=[];return e.length===1?t.push({concept_id:s("Resistance classification"),value_coded:s("Mono drug resistant"),obs_datetime:n.date}):e.length>1&&t.push({concept_id:s("Resistance classification"),value_coded:s("Multi drug resistant"),obs_datetime:n.date}),e.some(a=>/rif/i.test(a.label))&&t.push({concept_id:s("Rifampicin resistance confirmed"),value_coded:s("YES_ANSWER"),obs_datetime:n.date}),[...t,...e.filter(a=>!/no resistance/i.test("".concat(a.value))).map(a=>({concept_id:s("TB_DRUG_RESISTANT"),value_coded:U("".concat(a.value)),obs_datetime:n.date}))]},onValueUpdate:(e,t)=>e.map(a=>{if(t.isChecked){if(/no resistance/i.test("".concat(t.label))&&a.label!=t.label)return a.isChecked=!1,a;/no resistance/i.test("".concat(t.label))||/no resistance/i.test("".concat(a.label))&&(a.isChecked=!1)}return a}),options:()=>[{value:"Rifampicin (300mg)",label:"Rifampicin Resistant"},{value:"Isoniazid (300mg)",label:"Isoniazid Resistant"},{value:"No Resistance",label:"No Resistance"}]}),o=()=>{const e=[];return{id:"sampleSecondlineDrugs",helpText:"DR TB Drug Resistance:",type:d.TT_MULTIPLE_SELECT,init:async()=>{try{const t=[];(await F.getJson("programs/".concat(n.programID,"/tb_regimen_group"),{patient:l,regimen_group:"second-line-concepts"})).forEach(r=>{!t.includes(r.concept_id)&&!/none|other non-coded/i.test(r.name)&&(t.push(r.concept_id),e.push({label:r.name,value:r.concept_id}))})}catch(t){return!1}return!0},condition:t=>t.treatmentType.value==="SECOND_LINE",onValueUpdate:(t,a)=>t.map(r=>{if(a.isChecked){if(/no resistance/i.test("".concat(a.label))&&r.label!=a.label)return r.isChecked=!1,r;/no resistance/i.test("".concat(a.label))||/no resistance/i.test("".concat(r.label))&&(r.isChecked=!1)}return r}),computedValue:t=>{const a=[];return t.length===1?a.push({concept_id:s("Resistance classification"),value_coded:s("Mono drug resistant"),obs_datetime:n.date}):t.length>1&&a.push({concept_id:s("Resistance classification"),value_coded:s("Multi drug resistant"),obs_datetime:n.date}),[...a,...t.filter(r=>!/no resistance/i.test("".concat(r.value))).map(r=>({concept_id:s("TB_DRUG_RESISTANT"),value_coded:r.value,obs_datetime:n.date}))]},options:()=>[...e,{value:"No Resistance",label:"No Resistance"}]}},T=()=>({id:"sampleResultDate",helpText:"Sample Result Date:",type:d.TT_FULL_DATE,validation:e=>u.validateSeries([()=>u.required(e),()=>u.dateRangeOf(e,"".concat(D.query.date),n.date)]),computedValue:e=>({concept_id:s("RESULT_DATE"),value_datetime:e.value,obs_datetime:n.date})});h.value=[_(),f(),i(),o(),T()]});async function I(c,l){var f;await n.createEncounter(),await n.saveObservationList(await Y(l));const m={tbPositive:((f=c.sampleResult)==null?void 0:f.value)==="POSITIVE",onTreatment:b.isOnTreatment(g.outcome),tptEligible:!b.isOnTreatment(g.outcome)&&R.value.getAge()>=0&&R.value.getAge()<w,inhResistance:(c.sampleResistance||[]).some(i=>i.label==="Isoniazid Resistant"),rrResistance:(c.sampleResistance||[]).some(i=>i.label==="Rifampicin Resistant")},_={"try a different examination when negative result":{title:"Negative patient",message:"Do you want to try a different examination?",yes:()=>y.push("/tb/lab/".concat(n.patientID)),no:()=>y.push(E.value),mandatoryCondition:{tbPositive:i=>!i,onTreatment:i=>!i,tptEligble:i=>!i}},"go to other encounters if no drug resistance was found":{action:()=>p(),mandatoryCondition:{inhResistance:i=>!i,rrResistance:i=>!i}},"enroll in MDR program if drug resistance is found":{title:"Start drug resistance program",message:"Drug resistance has been detected, do you want to enroll patient is Drug Resistance program?",yes:async()=>{await b.enrollMDR(n.patientID),p()},no:()=>p(),eitherConditionMatch:{inhResistance:i=>i,rrResistance:i=>i}}};for(const i of Object.keys(_)){const o=_[i];let T=!0,e=!0;if(o.mandatoryCondition&&(e=Object.keys(o.mandatoryCondition).every(t=>o.mandatoryCondition[t](m[t]))),o.eitherConditionMatch&&(T=Object.keys(o.eitherConditionMatch||{}).some(t=>o.eitherConditionMatch[t](m[t]))),T&&e){if(typeof o.yes=="function"&&typeof o.no=="function")return await B(o.title,"",o.message,[{name:"Yes",slot:"start",color:"success"},{name:"No",slot:"start",color:"primary"}])==="Yes"?o.yes():o.no();if(typeof o.action=="function")return o.action()}}p()}return(c,l)=>(M(),k(S(x),null,{default:V(()=>[$(C,{cancelDestinationPath:S(E),onFinishAction:I,fields:h.value,skipSummary:!0},null,8,["cancelDestinationPath","fields"])]),_:1}))}});export{K as default};
