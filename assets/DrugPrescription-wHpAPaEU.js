var C=Object.defineProperty;var M=(l,r,s)=>r in l?C(l,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):l[r]=s;var D=(l,r,s)=>M(l,typeof r!="symbol"?r+"":r,s);import{bQ as h,bz as A,d as L,r as O,ad as c,ae as u,aN as F,a as N,c as V,w as R,b as k,u as q,dF as U,g as $,H as B,aE as _,au as g,dI as H,I as z,aj as G}from"./index-CMZASHAR.js";import{D as K}from"./drug_order_service-DwQHOfYk.js";import{D as y}from"./drug_service-Dy0XwoPz.js";import{D as p,A as Q}from"./drug_prescription_service-8rYX4IPe.js";import{H as j}from"./HisStandardForm-BCjM4-bc.js";import{u as W}from"./useEncounter-CsCeua2V.js";import"./isEmpty-DjKeGqZh.js";import"./encounter_guidelines-CJXpBOk4.js";import"./GuidelineEngine-D6V1_Znr.js";class f extends h{constructor(r,s){super(r,25,s)}async loadDrugs(r="",s=1,o=10){return(await y.getDrugs({name:r,page:s,page_size:o,concept_set:"OPD Medication"})).map(n=>({label:n.name,value:n.name,other:n}))}async getDrugs(r="",s=1,o=10){return(await y.getDrugs({name:r,page:s,page_size:o,concept_set:"OPD Medication"})).map(n=>({label:n.name,value:n.name,other:n}))}async hasMalaria(){const r=await A.getLatestMalariaTestResult(this.patientID);return r==="No"?!!((await h.getAllValueCoded(this.patientID,"Primary diagnosis")).includes("Malaria")||(await h.getAllValueCoded(this.patientID,"Secondary diagnosis")).includes("Malaria")):r==="Positive"}createDrugOrder(r){return K.create({encounter_id:this.encounterID,drug_orders:r})}}D(f,"getDrugs");const oe=L({__name:"DrugPrescription",setup(l){const r=O([]);let s,o;const{goToNextTask:m}=W((e,t)=>{o=new f(t,e),r.value=[P(),I()]});async function n(e){var a;const t=T(e.drug_selection);try{await o.createEncounter(),await o.createDrugOrder(t),(a=await U.isSummaryPrintingEnabled())!=null&&a&&$(o.patientID),m()}catch(i){console.error(i)}}function T(e){const t=f.getSessionDate();return e.map(a=>{const i=p.find(d=>d.code===a.other.frequency);return{drug_inventory_id:a.other.drug_id,equivalent_daily_dose:a.other.dosage=="Unknown"?0:a.other.dosage*(i==null?void 0:i.value)||0,start_date:t,auto_expire_date:E(t,a.other.duration),units:a.other.units,instructions:"".concat(a.label,": ").concat(a.other.dosage," ").concat(a.other.units," ").concat((i==null?void 0:i.code)||""," for ").concat(a.other.duration," days"),dose:a.other.dosage,frequency:(i==null?void 0:i.code)||""}})}function E(e,t){const a=new Date(e);return a.setDate(a.getDate()+parseInt(t)),B.toStandardHisFormat(a)}async function b(){return await o.hasMalaria()||G("Patient has no malaria. Do you still want to prescribe anti malaria drugs?")}async function v(){await b()&&await _([{id:"malaria_drug",helpText:"Select the malaria drug to be prescribed",type:c.TT_SELECT,validation:e=>u.required(e),options:()=>Q.map(e=>{var t;return{value:e.name,label:e.name,other:{...e,dosage:e.dose_strength,frequency:(t=p.find(a=>a.value===e.frequency))==null?void 0:t.code}}})}],async e=>{s.checkedItems.push({...e.malaria_drug,isChecked:!0}),await g.dismiss()})}function w(e){return e.dosage&&e.frequency&&e.duration}async function S(e){return new Promise(t=>{_([{id:"frequency",helpText:"Select the frequency for ".concat(e.label),type:c.TT_SELECT,requireNext:!1,validation:a=>u.required(a),computedValue:a=>a.value,options:()=>p.map(a=>({value:a.code,label:a.label,other:a}))},{id:"dosage",helpText:"Enter the dosage for ".concat(e.label),type:c.TT_NUMBER,defaultValue:()=>e.other.dose_strength,validation:a=>u.required(a),computedValue:a=>Number(a.value),config:{keypad:[H,[["DELETE"]]]}},{id:"duration",helpText:"Enter the duration for ".concat(e.label),type:c.TT_NUMBER,validation:a=>u.required(a),computedValue:a=>Number(a.value)}],async(a,i)=>{await g.dismiss(),t(i)},()=>t({}))})}function P(){return{id:"drug_selection",helpText:"Select the drugs to be prescribed",type:c.TT_INFINITE_SCROLL_MULTIPLE_SELECT,onload:e=>s=e,validation:e=>u.required(e),options:async(e,t="",a=1,i=10)=>o.getDrugs(t,a,i),onValueUpdate:async e=>{for(let t=0;t<e.length;t++)if(e[t].isChecked&&!w(e[t].other)){const a=await S(e[t]);F.isEmpty(a)?e.splice(t,1):(e[t].other={...e[t].other,...a},s.filter="",s.selected="")}return e},config:{isFilterDataViaApi:!0,showKeyboard:!0,footerBtns:[{name:"Predefined Malaria Drugs",color:"primary",size:"large",visible:!1,slot:"end",onClick:v}]}}}function I(){return{id:"summary",helpText:"Prescribed Drugs",type:c.TT_TABLE_VIEWER,options:e=>{const t=["Drug","Dosage","Frequency","Duration"],a=e.drug_selection.map(i=>{var d;return[i.label,i.other.dosage,(d=p.find(x=>x.code===i.other.frequency))==null?void 0:d.label,i.other.duration]});return[{label:"Prescribed Drugs",value:"",other:{columns:t,rows:a}}]}}}return(e,t)=>(N(),V(q(z),null,{default:R(()=>[k(j,{"skip-summary":"",fields:r.value,onFinishAction:n},null,8,["fields"])]),_:1}))}});export{oe as default};
