var p=Object.defineProperty;var D=(u,r,t)=>r in u?p(u,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[r]=t;var c=(u,r,t)=>D(u,typeof r!="symbol"?r+"":r,t);import{bQ as d,aN as g,bC as h,H as l}from"./index-CMZASHAR.js";import{B as m}from"./htn_service-B9DGYTze.js";class v extends d{constructor(t,e){super(t,68,e);c(this,"lastDrugs");c(this,"lastReceiptDate");this.lastDrugs=[],this.lastReceiptDate=""}async loadPreviousDrugs(t=!1){const e=new Date(this.date);e.setDate(e.getDate()-1);const s=o=>l.toStandardHisFormat(o),n=await d.getJson("patients/".concat(this.patientID,"/drugs_received"),{date:s(e)});if(!g.isEmpty(n)){this.lastReceiptDate=n.reduce((a,i)=>!a||new Date(s(i.order.start_date))>new Date(a)?s(i.order.start_date):a,null);const o=m.htnDrugReferences().map(a=>a.drug_id);if(this.lastDrugs=n.filter(a=>!o.includes(a.drug.drug_id)&&s(a.order.start_date)===this.lastReceiptDate),t){const a=await this.getPreviousDrugPillCount()||{};this.lastDrugs=this.lastDrugs.map(i=>(a[i.drug.drug_id]&&i.quantity&&(i.quantity+=a[i.drug.drug_id]),i))}}}getReceiptDate(){return this.lastReceiptDate}getLastDrugs(){return this.lastDrugs}receivedDrugsBefore(){return!g.isEmpty(this.lastDrugs)}buildPillCountObs(t,e){return this.buildValueNumber("Number of tablets brought to clinic",e,null,t)}getPreviousDrugPillCount(){return d.getJson("last_drugs_pill_count",{patient_id:this.patientID,program_id:this.programID,date:this.lastReceiptDate})}async buildAdherenceObs(t,e,s,n=d.getSessionDate()){return{concept_id:await d.getConceptID("Drug adherence",!0),value_numeric:s,value_drug:e,value_modifier:"%",order_id:t,person_id:this.patientID,obs_datetime:n}}isAdherenceGood(t){return t>=95&&t<=105}calculateAdherence(t,e,s){return Math.round(100*(t-e)/(t-s))}calculateExpected(t,e,s,n){const o=n==="QW"?"week":"day",a=this.calcTimeElapsed(s,o);return t-a*parseFloat(e.toString())}calcTimeElapsed(t,e){return h(l.toStandardHisFormat(this.date)).diff(l.toStandardHisFormat(t),e)+1}calculateUnaccountedOrMissed(t,e){const s=parseFloat(t)-parseFloat(e);return s<0?s*-1+" missed":s+" unacc"}}export{v as A};
