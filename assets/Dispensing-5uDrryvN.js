import{d as D,H as p,am as u,al as v,s as _,aB as b,y as S,au as o,aZ as l,bJ as c,bh as w,ct as h,ak as E,a as P,ap as I,b as k}from"./index-BCOAvIf2.js";import{D as m}from"./dispensation_service-DcLwpkq6.js";import{_ as F}from"./EncounterMixin.vue_vue_type_script_lang-BiqmNDbL.js";import{j as T}from"./Arrays-CufAqHE9.js";import"./drug_order_service-BJuBfLno.js";import"./encounter_guidelines-DtnttXhU.js";import"./GuidelineEngine-D6V1_Znr.js";import"./HisStandardForm-CejSRcn9.js";const A=D({mixins:[F],data:()=>({dispensation:{},hasTodayAppointment:!1,isEmergencySupply:!1,activeField:""}),watch:{ready:{async handler(e){if(e){this.dispensation=new m(this.patientID,this.providerID);try{await new w(this.patientID).enrollProgram()}catch(n){console.log("Probably already enrolled!"),console.error(n)}const t=await m.getFirstObs(this.patientID,"Appointment date");this.hasTodayAppointment=t?h(t.obs_datetime)===h(this.dispensation.date):!1;const i=await c.getArtPatientType(this.patientID);this.isEmergencySupply=/Emergency ARVs for In-Patient/i.test((i==null?void 0:i.value_coded)||""),this.fields=this.getFields()}},immediate:!0}},methods:{async onSubmitHandler(e){var t;if(this.isEmergencySupply&&((t=e==null?void 0:e.notification)!=null&&t.value)){const i=new c(this.patientID,this.providerID);await i.createEncounter(),await i.saveValueCodedObs("Registered facility notified of emergency supply",e.notification.value)}return this.hasTodayAppointment?this.gotoPatientDashboard():this.$router.push({name:"appointment"})},saveDispensations(e){return this.dispensation.saveDispensations(this.buildDispensations(e))},buildDispensations(e){var t;if(!l.isEmpty((t=e.other)==null?void 0:t.dispenses)){let i=[];return e.other.dispenses.forEach(([n,a])=>{i=[...i,...this.dispensation.buildDispensations(e.other.order_id,n,a)]}),i}return this.dispensation.buildDispensations(e.other.order_id,Number.parseInt(e.value.toString()),1)},async buildMedicationHistory(){return await this.dispensation.loadDrugHistory(),this.dispensation.getDrugHistory().sort((e,t)=>{const i=new Date(e.order.start_date);return new Date(t.order.start_date)-i}).map(e=>({medication:e.drug.name,date:p.toStandardHisDisplayFormat(e.order.start_date),amount:e.quantity}))},buildOrderOptions(){return this.dispensation.getCurrentOrder().map(e=>({label:e.drug.name,value:e.quantity||0,other:{order:e,drug_id:e.drug.drug_id,order_id:e.order.order_id,available_stock:this.getCumulativeStocks(e.stocks),amount_needed:this.calculateCompletePack(e),pack_sizes:this.getPackSizesRows(e.drug.drug_id,e.stocks)}}))},getCumulativeStocks(e){return e?e.reduce((t,i)=>t+i.quantity,0):"-"},getPackSizesRows(e,t){const i=(t==null?void 0:t.map(n=>[n.packSize,Math.floor(n.quantity/n.packSize)||"-",0,0]))||[];return this.dispensation.getDrugPackSizes(e).forEach(n=>{i.findIndex(([s])=>s===n)===-1&&i.push([n,"-",0,0])}),i.sort((n,a)=>n[0]-a[0])},calculateCompletePack(e){const t=parseFloat(e.amount_needed)-(e.quantity||0);return t<=0?0:this.dispensation.calcCompletePack(e,t)},isDoneDispensing(e){return e.map(t=>t.value!=0).every(Boolean)},async isValidDispensation(e){var a;const t=parseInt(e.value.toString()),i=e.other.amount_needed,n=t/i*100;if(n>110&&!await o("Are you sure you want to dispense over 110% of the prescribed pill count?")||n<100&&!await o("Are you sure you want to dispense less than 100% of the prescribe amount?"))return!1;if(this.dispensation.useDrugManagement){const s=(a=e.other)==null?void 0:a.dispenses.filter(([r])=>{var d;return(d=e.other)==null?void 0:d.pack_sizes.some(([f,g,y])=>f===r&&g==="-"&&y>0)}).map(([r])=>r);if(!l.isEmpty(s))return o("Are you sure you want to dispense drugs of ".concat(T(s)," pack size(s) that have no associated stocks available?"))}return!0},getFields(){return[{id:"dispenses",helpText:"Dispensation",type:u.TT_DISPENSATION_INPUT,init:async()=>{try{return this.dispensation.setIsDrugManagementEnabled(await b.get("IS_ART_DRUG_MANAGEMENT_ENABLED")),await this.dispensation.loadCurrentDrugOrder(),!0}catch(e){return S("Unable to load current order: ".concat(e)),!1}},onValueUpdate:async(e,t)=>{if(e.value!=-1&&this.isDoneDispensing(t)){if(this.isEmergencySupply){this.activeField="notification";return}return this.onSubmitHandler()}return e.other.amount_needed=e.other.amount_needed-(parseInt(e.value.toString())||0),e.other.amount_needed<0&&(e.other.amount_needed=0),await this.dispensation.loadCurrentDrugOrder(),this.buildOrderOptions()},onValue:async(e,t)=>e.value===-1?!await this.dispensation.voidOrder(e.other.order_id):!t&&!await this.isValidDispensation(e)?!1:await this.saveDispensations(e)?!0:(_("Unable to save dispensation"),!1),config:{isDrugManagementEnabled:()=>this.dispensation.useDrugManagement,medicationHistory:()=>this.buildMedicationHistory(),toolbarInfo:[{label:"Name",value:this.patient.getFullName()},{label:"Gender",value:this.patient.getGender()},{label:"Date Of Birth",value:p.toStandardHisDisplayFormat(this.patient.getBirthdate())}],hiddenFooterBtns:["Clear","Finish"]},options:()=>this.buildOrderOptions()},{id:"notification",type:u.TT_SELECT,helpText:"Is registered facility notified of Emergency Supply",options:this.yesNoOptions,validation:e=>v.required(e)}]}}});function O(e,t,i,n,a,s){const r=I("his-standard-form");return k(),P(r,{fields:e.fields,skipSummary:!0,activeField:e.activeField,cancelDestinationPath:e.cancelDestination,onOnFinish:e.onSubmitHandler},null,8,["fields","activeField","cancelDestinationPath","onOnFinish"])}const q=E(A,[["render",O]]);export{q as default};
