var v=Object.defineProperty;var y=(e,t,a)=>t in e?v(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a;var d=(e,t,a)=>y(e,typeof t!="symbol"?t+"":t,a);import{d as S,dr as u,B as _,H as T,di as E,an as n,ao as l,c3 as D,c0 as g,a_ as h,q as b,bZ as k,p as I,y as A,am as x,a as C,ar as F,b as R}from"./index-DrAzzURJ.js";import{H as $}from"./HisStandardForm-BuN2ARUl.js";class p{constructor(){d(this,"BASE30_DIGITS_INDEX",{});d(this,"BASE30_DIGITS");this.BASE30_DIGITS="0123456789ABCDEFGHJKLMNPRTVWXY".split(""),this.BASE30_DIGITS.forEach((t,a)=>this.BASE30_DIGITS_INDEX[t]=a)}convertFromDecimal(t,a=30){if(a<2||a>30)throw"Invalid base ${toBase}";let i="";for(;t>0;)i=this.BASE30_DIGITS[t%a]+i,t=Math.floor(t/a);return i}static calculateLuhnCheckDigit(t){const a=t.toString().split("").map(s=>Number.parseInt(s,10)),i=a.length%2;let o=0;a.forEach((s,c)=>{c%2===i&&(s*=2),s>9&&(s-=9),o+=s});const r=o%10;return r===0?0:10-r}isValidDHACode(t){try{const a=this.convertToDecimal(t).toString();return p.calculateLuhnCheckDigit(Number.parseInt(a,10)*10)===0}catch(a){return console.error(a),!1}}convertToDecimal(t){if(t.length==0)return 0;const a=this.BASE30_DIGITS_INDEX[t[0]];if(a==null)throw"Invalid base ${fromBase} number: ${number}";return a*30**(t.length-1)+this.convertToDecimal(t.slice(1))}}const B=S({components:{HisStandardForm:$},data:()=>({activeField:"",fields:[],drugs:[],selectedDrugs:[],barcode:"",stockService:{}}),methods:{async onFinish(e){let t=[];for(const a of e.enter_batches){const i={reallocation_code:e.authorization.value,quantity:a.other.pack_size*a.other.tins,date:e.date.value,reason:a.other.reason};try{e.task.value==="Relocations"?await this.stockService.relocateItems(a.other.id,{...i,location_id:e.relocation_location.value}):await this.stockService.disposeItems(a.other.id,i)}catch(o){o instanceof k&&!h.isEmpty(o.errors)?t=t.concat(o.errors.map(r=>"".concat(r," for ").concat(a.other.drug_name))):t.push("".concat(o)),console.log(o)}}if(h.isEmpty(t))return I("Stock succesfully moved"),this.$router.push("/");A("".concat(t.join(",")))},getFields(){return[{id:"task",helpText:"Select task",type:l.TT_SELECT,validation:e=>n.required(e),options:()=>[{label:"Relocations",value:"Relocations"},{label:"Disposal",value:"Disposal"}]},{id:"relocation_location",helpText:"Destination",type:l.TT_SELECT,validation:e=>n.required(e)||n.notTheSame(e.label,"".concat(u.getLocationName())),condition:e=>e.task.value==="Relocations",options:(e,t="")=>D(t),computedValue:e=>e.label,config:{showKeyboard:!0,isFilterDataViaApi:!0}},{id:"date",dynamicHelpText:e=>"Date of ".concat(e.task.label),helpText:"Set date",type:l.TT_FULL_DATE,validation:e=>n.required(e)},{id:"select drugs",helpText:"Select drugs",type:l.TT_MULTIPLE_SELECT,requireNext:!0,validation:e=>n.required(e),options:async(e,t)=>this.getDrugs(t,e.date.value),unload:e=>this.selectedDrugs=e},{id:"enter_batches",helpText:"Batch entry",type:l.TT_BATCH_MOVEMENT,beforeNext:(e,t,a,{currentFieldContext:i})=>{const o=s=>s.map(c=>"".concat(c.label)).join(" & "),r=i.drugs.filter(s=>!s.other.tins||!s.other.reason);if(!h.isEmpty(r)){const s=o(r);return b("Please fix partial batch entries for drugs: ".concat(s)),!1}return!0},options:()=>this.selectedDrugs,validation:e=>n.required(e),config:{getReasons:this.getReasons}},{id:"authorization",helpText:"Enter authorization code",type:l.TT_TEXT,config:{customKeyboard:[g,[["Delete"]]]},validation:e=>n.validateSeries([()=>n.required(e),()=>{const t=e.value;return new p().isValidDHACode(t.toUpperCase())?null:["Invalid authorization code"]}])},{id:"summary",helpText:"Summary",type:l.TT_TABLE_VIEWER,options:e=>this.buildResults(e),config:{hiddenFooterBtns:["Clear"]}}]},buildResults(e){const t=e.task.value==="Relocations",a=["Drug","Total Tins","Expiry date","Authorization code","Reason"];t&&a.push("Relocation");const i=e.enter_batches.map(o=>{const r=[o.other.drug_name,E(o.other.tins),T.toStandardHisDisplayFormat(o.other.expiry_date),e.authorization.value.toUpperCase(),o.other.reason];return t&&r.push(e.relocation_location.label),r});return[{label:"Confirm entry",value:"Table",other:{columns:a,rows:i}}]},async getDrugs(e,t){return(await this.stockService.getItems()).map(i=>{var c,m;const o=(m=(c=i==null?void 0:i.drug_name)!=null?c:i==null?void 0:i.drug_legacy_name)!=null?m:"N/A",r=T.toStandardHisDisplayFormat(i.expiry_date),s=e.filter(f=>f.label===o).length>=1;return{label:o,value:i.drug_id,isChecked:s,description:{color:"primary",show:"always",text:"Product Code: ".concat(i.product_code," - Batch Number: ").concat(i.batch_number," - Pack Size: ").concat(i.pack_size," - Expiry date: ").concat(r)},other:{...i,tins:null,quantity:Math.trunc(i.current_quantity/i.pack_size)||0,reason:""}}}).filter(i=>!_(t).isBefore(i.other.delivery_date)&&i.other.current_quantity>0)},mapToOptions(e){return e.map(t=>({label:t,value:t}))},getReasons(e,t){var o;if(t.task.value==="Relocations")return this.mapToOptions(["Transfer to another facility/relocation","For trainings"]);const a=_((o=e.other)==null?void 0:o.expiry_date).isAfter(u.getSessionDate()),i=["Damaged","Phased out","Banned","Missing"];return a||i.push("Expired"),this.mapToOptions(i)}},created(){this.stockService=new u,this.fields=this.getFields()}});function N(e,t,a,i,o,r){const s=F("his-standard-form");return R(),C(s,{fields:e.fields,activeField:e.activeField,onFinishAction:e.onFinish,skipSummary:!0},null,8,["fields","activeField","onFinishAction"])}const H=x(B,[["render",N]]);export{H as default};
