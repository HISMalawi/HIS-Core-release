System.register(["./index-legacy-DhfIpXPN.js","./HisStandardForm-legacy-BZtV4cgX.js"],(function(e,t){"use strict";var i,a,s,o,r,n,d,l,c,u,h,p,m,v,y,g,f,w;return{setters:[e=>{i=e.d,a=e.al,s=e.U,o=e.am,r=e.bl,n=e.H,d=e.aZ,l=e.A,c=e.aB,u=e.c4,h=e.s,p=e.y,m=e.q,v=e.ak,y=e.ap,g=e.a,f=e.b},e=>{w=e.H}],execute:function(){const t=i({components:{HisStandardForm:w},data:()=>({formKey:0,fields:[],activity:"",presets:{},programs:{},userData:{},fieldComponent:"",isSessionPasswordChange:!1,activeField:"",form:{}}),watch:{$route:{async handler(e){if(!e)return;const{query:t}=e;["edit","add"].includes(t.activity)?this.activity=t.activity:this.activity="add",t.update_password&&(this.userData=this.toUserData(await s.getCurrentUser()),this.isSessionPasswordChange=!0,this.activeField="new_password",this.fieldComponent=this.activeField),this.programs=this.removeObjectsByApplicationNames(s.getAvailableApps(),["CRVS"]),this.fields=this.getFields()},immediate:!0,deep:!0}},methods:{async onFinish(e,t){try{switch(this.activity){case"add":await this.create(t),this.activity="edit";break;case"edit":if(await this.update(t),this.isSessionPasswordChange){const e=new l;e.sessionDate=await s.getApiDate(),await e.resetUserPasswordChangeCheck(),this.$router.push("/")}}c.invalidate("PROVIDERS"),this.activeField="user_info",this.$nextTick((()=>this.fieldComponent=this.activeField)),this.formKey+=1}catch(i){i instanceof u&&!d.isEmpty(i.errors)?h(i.errors):p(`${i}`)}},removeObjectsByApplicationNames:(e,t)=>e.filter((e=>!t.includes(e.applicationName))),async create(e){const{user:t}=await s.createUser(e);if(t)return this.userData=this.toUserData(t);throw"Unable to create new user, Possibly the user already exists or incorrect info was entered"},async update(e){const t=await s.updateUser(this.userData.id,e);if(t)return this.userData=this.toUserData(t);throw"Unable to update user, possibly server error or incorrect information entered"},getProgramName(e){const t=d.find(this.programs,{programID:e});return t?t.applicationName:""},mapToOption:e=>e.map((e=>({label:e,value:e}))),async getRoles(){return(await s.getAllRoles()).filter((e=>{try{return!this.userData.role.split(",").includes(e.role)}catch(t){return!0}})).map((e=>({label:e.role,value:e.role,other:e})))},toUserData(e){const t=e.person.names[0];return{id:e.user_id,given_name:t.given_name,family_name:t.family_name,username:e.username,role:e.roles.map((e=>e.role)),created:n.toStandardHisDisplayFormat(e.date_created),status:e.deactivated_on?"Inactive":"Active",programs:e.programs.map((e=>e.program_id))}},editConditionCheck(e=[]){return"edit"!==this.activity||e.includes(this.activeField)},toLcase:e=>e.value.toString().toLowerCase(),getFields:function(){return[{id:"select_user",helpText:"Select Username",type:o.TT_SELECT,condition:()=>"edit"===this.activity&&s.isAdmin(),validation:e=>a.required(e),unload:({other:e})=>this.userData=this.toUserData(e),options:async()=>(await s.getAllUsers()).map((e=>({label:e.username,value:e.user_id,other:e}))),config:{showKeyboard:!0}},{id:"user_info",helpText:"User information",type:o.TT_TABLE_VIEWER,dynamicHelpText:()=>`User: ${this.userData.username} | Added On: ${this.userData.created}`,condition:()=>"edit"===this.activity&&s.isAdmin(),options:async(e,t,i)=>{const a=e=>({name:"Active"===e?"Deactivate":"Activate",type:"button",style:{width:"65%",fontWeight:"bold"},color:"Active"===e?"danger":"success",action:async()=>{try{"Active"===e&&(await s.deactivateUser(this.userData.id),this.userData.status="Inactive",i.rows[3]=["Status","Inactive",a("Inactive")],m("User has been deactivated",400)),"Inactive"===e&&(await s.activateUser(this.userData.id),this.userData.status="Active",i.rows[3]=["Status","Active",a("Active")],m("User has been activated",400))}catch(t){h(`${t}`)}}}),o=(e,t)=>({name:e,type:"button",color:"light",style:{fontWeight:"bold",width:"65%"},action:()=>{this.activeField=t,this.fieldComponent=this.activeField}}),r=[o("Add/Append Role","roles")];return this.userData.role.length>1&&r.push(o("Remove Role","remove_roles")),[{label:"",value:"",other:{columns:["Attributes","Values","Actions"],rows:[["<b>Name</b>",`${this.userData.given_name} ${this.userData.family_name}`,o("Edit Name","given_name"),""],["<b>Password</b>","*******",o("Change password","new_password"),""],["<b>Role</b>",this.userData.role.join("<br/>"),...r],["<b>Status</b>",this.userData.status,a(this.userData.status),""],["<b>Programs</b>",this.userData.programs.map((e=>this.getProgramName(e))).join("<br/>"),o("Edit Program","programs"),""]]}}]},config:{hiddenFooterBtns:["Clear"],overrideDefaultFooterBtns:{nextBtn:{name:"Finish",onClick:()=>this.$router.back()}}}},{id:"given_name",helpText:"First name",type:o.TT_TEXT,computedValue:e=>e.value,defaultValue:()=>this.userData.given_name,condition:()=>this.editConditionCheck(["given_name"])&&s.isAdmin(),validation:e=>a.isName(e),options:async e=>{if(!e.given_name||null===e.given_name.value)return[];const t=await r.searchGivenName(e.given_name.value);return this.mapToOption(t)}},{id:"family_name",helpText:"Last name",type:o.TT_TEXT,computedValue:e=>e.value,defaultValue:()=>this.userData.family_name,validation:e=>a.isName(e),condition:()=>this.editConditionCheck(["given_name"])&&s.isAdmin(),options:async e=>{if(!e.family_name||null===e.family_name.value)return[];const t=await r.searchFamilyName(e.family_name.value);return this.mapToOption(t)}},{id:"roles",helpText:"Role",type:o.TT_SELECT,computedValue:e=>[e.value],condition:()=>this.editConditionCheck(["roles"])&&s.isAdmin(),validation:e=>a.required(e),options:()=>this.getRoles(),config:{showKeyboard:!0}},{id:"remove_roles",helpText:"Remove Roles",proxyID:"roles",type:o.TT_SELECT,validation:e=>a.required(e),condition:()=>this.editConditionCheck(["remove_roles"])&&s.isAdmin()&&"edit"===this.activity,computedValue:e=>this.userData.role.filter((t=>t!=e.label)),options:()=>this.mapToOption(this.userData.role),config:{showKeyboard:!0}},{id:"must_append_roles",helpText:"Would you like to append role?",type:o.TT_SELECT,computedValue:e=>"Yes"===e.label,condition:()=>"edit"===this.activity&&this.editConditionCheck(["roles"])&&s.isAdmin(),defaultComputedOutput:()=>!1,validation:e=>a.required(e),options:()=>[{label:"Yes",value:"true"},{label:"No",value:"false"}]},{id:"programs",helpText:"Select Apps",type:o.TT_MULTIPLE_SELECT,condition:()=>s.isAdmin()&&this.editConditionCheck(["programs"]),validation:e=>a.required(e),computedValue:e=>e.map((e=>e.value)),options:()=>this.programs.map((e=>{let t=!1;return"edit"===this.activity&&(t=this.userData.programs.includes(e.programID)),{label:e.applicationName,value:e.programID,isChecked:t}}))},{id:"username",helpText:"Username",type:o.TT_TEXT,condition:()=>this.editConditionCheck(["nothing to see here"])&&s.isAdmin(),computedValue:e=>this.toLcase(e),validation:e=>a.validateSeries([()=>a.required(e),()=>a.hasLengthRangeOf(e,4,15)]),config:{casing:"lowercase"}},{id:"new_password",proxyID:"password",helpText:"New Password",type:o.TT_PASSWORD,computedValue:e=>this.toLcase(e),condition:()=>this.editConditionCheck(["new_password"]),validation:e=>a.validateSeries([()=>a.required(e)]),config:{inputType:"password"}},{id:"verify_password",proxyID:"password",helpText:"Confirm Password",type:o.TT_PASSWORD,computedValue:e=>this.toLcase(e),condition:()=>this.editConditionCheck(["new_password"]),validation:(e,t)=>a.validateSeries([()=>a.required(e),()=>{if(this.toLcase(t.verify_password)!=this.toLcase(t.new_password))return["New password does not match current password"]}]),config:{inputType:"password"}}]}}});e("default",v(t,[["render",function(e,t,i,a,s,o){const r=y("his-standard-form");return f(),g(r,{key:e.formKey,fields:e.fields,skipSummary:!0,activeField:e.fieldComponent,onOnIndex:t[0]||(t[0]=t=>e.fieldComponent=""),onFinishAction:e.onFinish},null,8,["fields","activeField","onFinishAction"])}]]))}}}));
