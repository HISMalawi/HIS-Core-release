import{d as z,aC as g,k as M,ai as Y,aD as j,U as E,aE as q,al as P,am as U,s as k,aF as G,y as J,aG as Q,aH as D,aI as X,A as x,aJ as Z,aK as ss,aL as es,ak as W,ap as $,h,b as p,g as u,t as I,aM as ts,aN as os,e as o,w as i,a as V,a6 as S,a9 as L,aa as B,aO as as,r as A,aP as ns,c as is,aQ as rs,aR as ls,o as us,f as t,a4 as ds,m as R,a5 as ps,ah as w,j as m,I as F,l as cs,x as H,aS as hs,aT as K,ag as fs,a7 as C,aU as ws,aV as ms,aW as ys,aX as gs,n as Is,aY as vs,aZ as bs}from"./index-3BeNlo1y.js";import{p as Ps}from"./main-Ba5gcMwE.js";import{H as ks}from"./HelpdeskFlyer-BqH27o0C.js";const Cs=z({components:{IonInput:Y,IonButton:M,IonIcon:g},props:{useVirtualInput:{type:Boolean}},data:function(){return{eye:es,eyeOff:ss,passwordTimeout:null,showPasswordButtonTimeout:null,showPassword:!1,showPasswordButton:!1,keyboard:D,auth:{},userInput:{type:String,username:"",password:""},focusInput:{type:Object,value:"",id:""},display:"none",keyboardTop:"",btnCaption:"",Caps:{type:Boolean,on:!1}}},created(){this.auth=new x,Z.clearScreenTimeout()},setup(){const{facilityName:s,district:e}=X();return{facilityName:s,district:e}},methods:{onShowPassword(){this.showPassword=!0,this.showPasswordButton=!0,this.passwordTimeout&&clearTimeout(this.passwordTimeout),this.passwordTimeout=setTimeout(()=>this.showPassword=!1,1e4)},renderKeyBoard(s){this.focusInput=s.currentTarget,this.focusInput.id=="password"?this.btnCaption="Login":this.btnCaption="Next";let e=s.currentTarget.getBoundingClientRect().top;e=parseInt(e),this.keyboardTop=e+20+"px;",this.display="table",window.scrollTo(0,9999)},keyPress(s){const e=s.currentTarget.id;let r;try{e.match(/@#/i)?this.keyboard=Q:e.match(/qwerty/i)?this.keyboard=D:e.match(/Del/i)?this.focusInput.value=this.focusInput.value.substring(0,this.focusInput.value.length-1):e.match(/Next/i)?(this.display="none",r=this.$refs.password,r.$el.click()):e.match(/Login/i)?(this.display="none",this.doLogin()):e.match(/Caps/i)?(this.Caps.on=!this.Caps.on,this.display="none",this.focusInput.id==="username"?r=this.$refs.username:r=this.$refs.password,r.click()):e.match(/Hide/i)?this.display="none":this.focusInput.value+=e,this.focusInput.id=="username"?this.userInput.username=this.focusInput.value:this.userInput.password=this.focusInput.value}catch(l){console.warn("input error")}},doLogin:async function(){if(this.showPasswordButtonTimeout&&clearTimeout(this.showPasswordButtonTimeout),this.showPasswordButton=!1,this.showPassword=!1,this.userInput.username&&this.userInput.password){this.auth.setUsername(this.userInput.username);try{if(this.auth.versionLockingIsEnabled()&&await this.auth.validateIfCorrectAPIVersion(),!await this.auth.checkTimeIntegrity())throw"Local date does not match API date. Please Update your device's date";await this.auth.login(this.userInput.password),this.auth.startSession();const s=await Promise.all([this.auth.passwordPolicyEnabled(),this.auth.passwordExpired()]),e=(()=>{let r=0;const l=Ps(this.userInput.password);return r+=l.score,/^(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>])/i.test(this.userInput.password)&&(r+=2),r<3})();if(e||s.every(Boolean)){const r=l=>"".concat(l.value).toLowerCase();return q([{id:"new_password",proxyID:"password",helpText:"Change your password",type:U.TT_PASSWORD,init:()=>(setTimeout(()=>{e?k("Your password is weak, please change it below"):k("Your password has expired, please change it below",6e3)},500),!0),computedValue:l=>r(l),validation:l=>P.validateSeries([()=>P.required(l),()=>P.hasLengthRangeOf(l,4,15),()=>{if("".concat(this.userInput.password).toLowerCase()===r(l))return["New password should not match old password"]}]),config:{inputType:"password"}},{id:"verify_password",proxyID:"password",helpText:"Confirm Password",type:U.TT_PASSWORD,computedValue:l=>r(l),validation:(l,f)=>P.validateSeries([()=>P.required(l),()=>{if(r(f.verify_password)!=r(f.new_password))return["New password does not match current password"]}]),config:{inputType:"password"}}],async(l,f)=>{await E.updateUser(this.auth.userID,f)?(await this.auth.resetUserPasswordChangeCheck(),await this.navigateAfterLogin()):k("Unable to update user")})}await this.navigateAfterLogin()}catch(s){s instanceof G?(k("Invalid username or password"),this.showPasswordButton=!0,this.showPasswordButtonTimeout=setTimeout(()=>this.showPasswordButton=!1,3e4)):J("".concat(s),5e4)}}else k("Complete form to log in")},async navigateAfterLogin(){var s;try{const e=j.version;try{const r=await E.getJson("user_properties",{property:"his_core_update_acknowledged"});if(((s=r==null?void 0:r.property_value)==null?void 0:s.split("|")[0])===e){this.$router.push("/select_hc_location");return}}catch(r){console.log("[Login] User property not found or error - showing updates")}console.log("[Login] Showing update flashcards for version ".concat(e)),this.$router.push("/updates/flashcards")}catch(e){console.error("Error during post-login navigation:",e),this.$router.push("/updates/flashcards")}}},computed:{btnStyles(){return"display: ".concat(this.display,"; top: ").concat(this.keyboardTop,";")}}}),_s={class:"main",ref:"main"},Ts={class:"cells ion-padding-bottom"},Ss={style:{color:"#cd853f"}},Ls={class:"rows"},Vs={class:"cells"},$s=["readonly"],As={class:"rows input-rows"},Bs={class:"cells"},Ns={class:"rows"},Os=["id"],Es=["id"];function Us(s,e,r,l,f,_){const v=$("ion-icon"),b=$("ion-button"),y=$("ion-input");return p(),h(L,null,[u("div",_s,[u("div",Ts,[u("h3",null,[e[7]||(e[7]=u("b",{style:{color:"#8b4513"}},"Facility: ",-1)),u("b",Ss,I(s.facilityName)+" ("+I(s.district)+")",1)])]),u("div",Ls,[u("div",Vs,[ts(u("input",{type:"text",name:"usename",autocomplete:"off",placeholder:"Username",id:"username",ref:"username","onUpdate:modelValue":e[0]||(e[0]=d=>s.userInput.username=d),onClick:e[1]||(e[1]=d=>s.renderKeyBoard(d)),class:"input-boxes ion-padding",readonly:s.useVirtualInput},null,8,$s),[[os,s.userInput.username]])])]),u("div",As,[u("div",Bs,[o(y,{style:{margin:"0px auto","margin-top":"15px","text-align":"left"},modelValue:s.userInput.password,"onUpdate:modelValue":e[3]||(e[3]=d=>s.userInput.password=d),type:s.showPassword?"text":"password",name:"password",ref:"password",id:"password",onClick:e[4]||(e[4]=d=>s.renderKeyBoard(d)),class:"input-boxes ion-padding",placeholder:"Password",readonly:s.useVirtualInput},{default:i(()=>[!s.showPassword&&s.showPasswordButton?(p(),V(b,{key:0,onClick:s.onShowPassword,color:"light",size:"large",slot:"end"},{default:i(()=>[o(v,{size:"large",icon:s.eye},null,8,["icon"])]),_:1},8,["onClick"])):S("",!0),s.showPassword&&s.showPasswordButton?(p(),V(b,{key:1,onClick:e[2]||(e[2]=d=>s.showPassword=!1),color:"light",size:"large",slot:"end"},{default:i(()=>[o(v,{size:"large",icon:s.eyeOff},null,8,["icon"])]),_:1})):S("",!0)]),_:1},8,["modelValue","type","readonly"])])])],512),u("div",{id:"keyboard",style:as(s.btnStyles),class:"keyboard"},[(p(!0),h(L,null,B(s.keyboard,(d,T)=>(p(),h("span",{key:T},[u("div",Ns,[(p(!0),h(L,null,B(d,a=>(p(),h("div",{class:"cells",key:a},[a==="Next"||a==="Login"?(p(),h("button",{key:0,id:s.btnCaption,class:"keyboard-btn login-btn",onClick:e[5]||(e[5]=n=>s.keyPress(n))},I(s.btnCaption),9,Os)):S("",!0),a!="Login"&&a!="Next"?(p(),h("button",{key:1,id:s.Caps.on?a.toUpperCase():a.toLowerCase(),class:"keyboard-btn",onClick:e[6]||(e[6]=n=>s.keyPress(n))},I(a==="Del."||a==="Caps"?a:s.Caps.on?a.toUpperCase():a.toLowerCase()),9,Es)):S("",!0)]))),128))])]))),128))],4)],64)}const Ds=W(Cs,[["render",Us],["__scopeId","data-v-aaf6011d"]]),Rs={slot:"start"},Fs=["src"],Hs=["src"],Ks=z({__name:"Login",setup(s){const e=H("login-logos/Malawi-Coat_of_arms_of_arms.png"),r=H("login-logos/PEPFAR.png"),l=A([]),f=async()=>{const a=await vs("Application Selection","Please specify the application you wish to use",l.value.map(n=>n.name),[{name:"Cancel",color:"danger",slot:"start"},{name:"Confirm",color:"primary",slot:"end",role:"action"}]);if(a.selection&&a.action!="Cancel"){const n=l.value.find(c=>c.name===a.selection);window.open("".concat(n.protocol||"http","://").concat(n.IP,":").concat(n.port||80),"_blank")}},{activePlatformProfile:_,platformProfiles:v}=ns(),b=A(""),y=A(""),d=is(()=>_.value.keyboard===rs.HIS_KEYBOARD_ONLY),T=Object.keys(v.value).map(a=>({label:a,value:{profileName:a,...v.value[a]}}));return ls(y,a=>{_.value=(bs.find(T,{label:a})||{}).value}),us(async()=>{var N,O;const a=new x;l.value=((N=await a.loadConfig())==null?void 0:N.otherApps)||[];const n=a.getHeadVersion();a.setActiveVersion(n);const c=await a.getApiVersion();b.value="".concat(n," / ").concat(c),y.value=((O=_.value)==null?void 0:O.profileName)||""}),(a,n)=>(p(),V(t(Is),null,{default:i(()=>[o(t(ds),null,{default:i(()=>[o(t(R),null,{default:i(()=>[o(t(ps),null,{default:i(()=>[o(t(w),{style:{fontWeight:"bolder",fontSize:"1.9em"}},{default:i(()=>[...n[0]||(n[0]=[u("b",{style:{color:"#8b4513"}},"National ",-1),u("b",{style:{color:"#cd853f"}},"EMR",-1)])]),_:1})]),_:1}),o(t(w),{class:"ion-padding",slot:"end"},{default:i(()=>[n[1]||(n[1]=m(" Version: ",-1)),u("b",null,I(b.value),1)]),_:1})]),_:1})]),_:1}),o(t(F),{fullscreen:!1,style:{width:"100%"}},{default:i(()=>[o(Ds,{useVirtualInput:d.value},null,8,["useVirtualInput"]),u("p",null,[o(ks)])]),_:1}),o(t(cs),null,{default:i(()=>[o(t(R),null,{default:i(()=>[u("span",Rs,[u("img",{id:"coat",src:t(e),alt:"Malawi Coat of Arms logo"},null,8,Fs),u("img",{id:"pepfar",src:t(r),alt:"PEPFAR logo"},null,8,Hs)]),o(t(M),{color:"dark",fill:"outline",size:"large",slot:"end",id:"configuration"},{default:i(()=>[o(t(g),{slot:"end",icon:t(hs)},null,8,["icon"]),n[2]||(n[2]=m(" Quick Actions ",-1))]),_:1}),o(t(K),{trigger:"configuration","dismiss-on-select":"",style:{"--width":"300px"}},{default:i(()=>[o(t(F),null,{default:i(()=>[o(t(fs),null,{default:i(()=>[o(t(C),{button:"","router-link":"/reset_password",class:"his-sm-text"},{default:i(()=>[o(t(g),{icon:t(ws),slot:"start"},null,8,["icon"]),o(t(w),null,{default:i(()=>[...n[3]||(n[3]=[m("Reset Password",-1)])]),_:1})]),_:1}),o(t(C),{button:"","router-link":"/settings/host",class:"his-sm-text"},{default:i(()=>[o(t(g),{icon:t(ms),slot:"start"},null,8,["icon"]),o(t(w),null,{default:i(()=>[...n[4]||(n[4]=[m("Network Settings",-1)])]),_:1})]),_:1}),o(t(C),{button:"",detail:"",id:"devices",class:"his-sm-text"},{default:i(()=>[o(t(g),{icon:t(ys),slot:"start"},null,8,["icon"]),o(t(w),null,{default:i(()=>[...n[5]||(n[5]=[m("Device Profile",-1)])]),_:1})]),_:1}),o(t(K),{trigger:"devices","dismiss-on-select":"",side:"end"},{default:i(()=>[(p(!0),h(L,null,B(t(T),c=>(p(),V(t(C),{key:c.label,color:c.label===y.value?"primary":"light",button:"",onClick:()=>y.value=c.label},{default:i(()=>[o(t(w),null,{default:i(()=>[m(I(c.label),1)]),_:2},1024)]),_:2},1032,["color","onClick"]))),128))]),_:1}),o(t(C),{button:"",onClick:f,class:"his-sm-text"},{default:i(()=>[o(t(g),{icon:t(gs),slot:"start"},null,8,["icon"]),o(t(w),null,{default:i(()=>[...n[6]||(n[6]=[m("Other Applications",-1)])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}))}}),Ws=W(Ks,[["__scopeId","data-v-b23d751a"]]);export{Ws as default};
