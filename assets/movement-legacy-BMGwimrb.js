System.register(["./index-legacy-zV5Jd_xD.js","./HisStandardForm-legacy-DUG6a-9J.js"],(function(e,t){"use strict";var a,i,o,r,s,n,l,c,u,d,h,p,m,T,g,_,y,f,v;return{setters:[e=>{a=e.d,i=e.dp,o=e.B,r=e.H,s=e.dg,n=e.al,l=e.am,c=e.c2,u=e.b$,d=e.aZ,h=e.s,p=e.bY,m=e.q,T=e.y,g=e.ak,_=e.a,y=e.ap,f=e.b},e=>{v=e.H}],execute:function(){class t{BASE30_DIGITS_INDEX={};BASE30_DIGITS;constructor(){this.BASE30_DIGITS="0123456789ABCDEFGHJKLMNPRTVWXY".split(""),this.BASE30_DIGITS.forEach(((e,t)=>this.BASE30_DIGITS_INDEX[e]=t))}convertFromDecimal(e,t=30){if(t<2||t>30)throw"Invalid base ${toBase}";let a="";for(;e>0;)a=this.BASE30_DIGITS[e%t]+a,e=Math.floor(e/t);return a}static calculateLuhnCheckDigit(e){const t=e.toString().split("").map((e=>Number.parseInt(e,10))),a=t.length%2;let i=0;t.forEach(((e,t)=>{t%2===a&&(e*=2),e>9&&(e-=9),i+=e}));const o=i%10;return 0===o?0:10-o}isValidDHACode(e){try{const a=this.convertToDecimal(e).toString();return 0===t.calculateLuhnCheckDigit(10*Number.parseInt(a,10))}catch(a){return console.error(a),!1}}convertToDecimal(e){if(0==e.length)return 0;const t=this.BASE30_DIGITS_INDEX[e[0]];if(null==t)throw"Invalid base ${fromBase} number: ${number}";return t*30**(e.length-1)+this.convertToDecimal(e.slice(1))}}const S=a({components:{HisStandardForm:v},data:()=>({activeField:"",fields:[],drugs:[],selectedDrugs:[],barcode:"",stockService:{}}),methods:{async onFinish(e){let t=[];for(const i of e.enter_batches){const o={reallocation_code:e.authorization.value,quantity:i.other.pack_size*i.other.tins,date:e.date.value,reason:i.other.reason};try{"Relocations"===e.task.value?await this.stockService.relocateItems(i.other.id,{...o,location_id:e.relocation_location.value}):await this.stockService.disposeItems(i.other.id,o)}catch(a){a instanceof p&&!d.isEmpty(a.errors)?t=t.concat(a.errors.map((e=>`${e} for ${i.other.drug_name}`))):t.push(`${a}`),console.log(a)}}if(d.isEmpty(t))return m("Stock succesfully moved"),this.$router.push("/");T(`${t.join(",")}`)},getFields(){return[{id:"task",helpText:"Select task",type:l.TT_SELECT,validation:e=>n.required(e),options:()=>[{label:"Relocations",value:"Relocations"},{label:"Disposal",value:"Disposal"}]},{id:"relocation_location",helpText:"Destination",type:l.TT_SELECT,validation:e=>n.required(e)||n.notTheSame(e.label,`${i.getLocationName()}`),condition:e=>"Relocations"===e.task.value,options:(e,t="")=>c(t),computedValue:e=>e.label,config:{showKeyboard:!0,isFilterDataViaApi:!0}},{id:"date",dynamicHelpText:e=>`Date of ${e.task.label}`,helpText:"Set date",type:l.TT_FULL_DATE,validation:e=>n.required(e)},{id:"select drugs",helpText:"Select drugs",type:l.TT_MULTIPLE_SELECT,requireNext:!0,validation:e=>n.required(e),options:async(e,t)=>this.getDrugs(t,e.date.value),unload:e=>this.selectedDrugs=e},{id:"enter_batches",helpText:"Batch entry",type:l.TT_BATCH_MOVEMENT,beforeNext:(e,t,a,{currentFieldContext:i})=>{const o=i.drugs.filter((e=>!e.other.tins||!e.other.reason));if(!d.isEmpty(o)){const e=o.map((e=>`${e.label}`)).join(" & ");return h(`Please fix partial batch entries for drugs: ${e}`),!1}return!0},options:()=>this.selectedDrugs,validation:e=>n.required(e),config:{getReasons:this.getReasons}},{id:"authorization",helpText:"Enter authorization code",type:l.TT_TEXT,config:{customKeyboard:[u,[["Delete"]]]},validation:e=>n.validateSeries([()=>n.required(e),()=>{const a=e.value;return(new t).isValidDHACode(a.toUpperCase())?null:["Invalid authorization code"]}])},{id:"summary",helpText:"Summary",type:l.TT_TABLE_VIEWER,options:e=>this.buildResults(e),config:{hiddenFooterBtns:["Clear"]}}]},buildResults(e){const t="Relocations"===e.task.value,a=["Drug","Total Tins","Expiry date","Authorization code","Reason"];return t&&a.push("Relocation"),[{label:"Confirm entry",value:"Table",other:{columns:a,rows:e.enter_batches.map((a=>{const i=[a.other.drug_name,s(a.other.tins),r.toStandardHisDisplayFormat(a.other.expiry_date),e.authorization.value.toUpperCase(),a.other.reason];return t&&i.push(e.relocation_location.label),i}))}}]},async getDrugs(e,t){return(await this.stockService.getItems()).map((t=>{const a=t?.drug_name??t?.drug_legacy_name??"N/A",i=r.toStandardHisDisplayFormat(t.expiry_date),o=e.filter((e=>e.label===a)).length>=1;return{label:a,value:t.drug_id,isChecked:o,description:{color:"primary",show:"always",text:`Product Code: ${t.product_code} - Batch Number: ${t.batch_number} - Pack Size: ${t.pack_size} - Expiry date: ${i}`},other:{...t,tins:null,quantity:Math.trunc(t.current_quantity/t.pack_size)||0,reason:""}}})).filter((e=>!o(t).isBefore(e.other.delivery_date)&&e.other.current_quantity>0))},mapToOptions:e=>e.map((e=>({label:e,value:e}))),getReasons(e,t){if("Relocations"===t.task.value)return this.mapToOptions(["Transfer to another facility/relocation","For trainings"]);const a=["Damaged","Phased out","Banned","Missing"];return o(e.other?.expiry_date).isAfter(i.getSessionDate())||a.push("Expired"),this.mapToOptions(a)}},created(){this.stockService=new i,this.fields=this.getFields()}});e("default",g(S,[["render",function(e,t,a,i,o,r){const s=y("his-standard-form");return f(),_(s,{fields:e.fields,activeField:e.activeField,onFinishAction:e.onFinish,skipSummary:!0},null,8,["fields","activeField","onFinishAction"])}]]))}}}));
