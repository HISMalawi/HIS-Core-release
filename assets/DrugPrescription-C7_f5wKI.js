var C=Object.defineProperty;var M=(l,r,o)=>r in l?C(l,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):l[r]=o;var D=(l,r,o)=>M(l,typeof r!="symbol"?r+"":r,o);import{bS as h,bz as A,d as N,r as F,ad as c,ae as u,aN as L,a as V,c as k,w as O,b as R,u as q,bH as U,g as $,H as B,aE as _,au as g,dJ as H,I as z,ak as G}from"./index-DxMuvVt8.js";import{D as K}from"./drug_order_service-oYRcbXYJ.js";import{D as y}from"./drug_service-BtuX_eFn.js";import{D as p,A as J}from"./drug_prescription_service-Ckh5YmPt.js";import{H as Q}from"./HisStandardForm-DZm4XR0H.js";import{u as W}from"./useEncounter-lcMM7dIM.js";import"./isEmpty-BtPnaiKI.js";import"./encounter_guidelines-BGVHGEbE.js";import"./GuidelineEngine-D6V1_Znr.js";class f extends h{constructor(r,o){super(r,25,o)}async loadDrugs(r="",o=1,s=10){return(await y.getDrugs({name:r,page:o,page_size:s,concept_set:"OPD Medication"})).map(n=>({label:n.name,value:n.name,other:n}))}async getDrugs(r="",o=1,s=10){return(await y.getDrugs({name:r,page:o,page_size:s,concept_set:"OPD Medication"})).map(n=>({label:n.name,value:n.name,other:n}))}async hasMalaria(){const r=await A.getLatestMalariaTestResult(this.patientID);return r==="No"?!!((await h.getAllValueCoded(this.patientID,"Primary diagnosis")).includes("Malaria")||(await h.getAllValueCoded(this.patientID,"Secondary diagnosis")).includes("Malaria")):r==="Positive"}createDrugOrder(r){return K.create({encounter_id:this.encounterID,drug_orders:r})}}D(f,"getDrugs");const se=N({__name:"DrugPrescription",setup(l){const r=F([]);let o,s;const{goToNextTask:m}=W((e,t)=>{s=new f(t,e),r.value=[P(),I()]});async function n(e){var a;const t=T(e.drug_selection);try{await s.createEncounter(),await s.createDrugOrder(t),(a=await U.isSummaryPrintingEnabled())!=null&&a&&$(s.patientID),m()}catch(i){console.error(i)}}function T(e){const t=f.getSessionDate();return e.map(a=>{const i=p.find(d=>d.code===a.other.frequency);return{drug_inventory_id:a.other.drug_id,equivalent_daily_dose:a.other.dosage=="Unknown"?0:a.other.dosage*(i==null?void 0:i.value)||0,start_date:t,auto_expire_date:E(t,a.other.duration),units:a.other.units,instructions:"".concat(a.label,": ").concat(a.other.dosage," ").concat(a.other.units," ").concat((i==null?void 0:i.code)||""," for ").concat(a.other.duration," days"),dose:a.other.dosage,frequency:(i==null?void 0:i.code)||""}})}function E(e,t){const a=new Date(e);return a.setDate(a.getDate()+parseInt(t)),B.toStandardHisFormat(a)}async function b(){return await s.hasMalaria()||G("Patient has no malaria. Do you still want to prescribe anti malaria drugs?")}async function v(){await b()&&await _([{id:"malaria_drug",helpText:"Select the malaria drug to be prescribed",type:c.TT_SELECT,validation:e=>u.required(e),options:()=>J.map(e=>{var t;return{value:e.name,label:e.name,other:{...e,dosage:e.dose_strength,frequency:(t=p.find(a=>a.value===e.frequency))==null?void 0:t.code}}})}],async e=>{o.checkedItems.push({...e.malaria_drug,isChecked:!0}),await g.dismiss()})}function w(e){return e.dosage&&e.frequency&&e.duration}async function S(e){return new Promise(t=>{_([{id:"frequency",helpText:"Select the frequency for ".concat(e.label),type:c.TT_SELECT,requireNext:!1,validation:a=>u.required(a),computedValue:a=>a.value,options:()=>p.map(a=>({value:a.code,label:a.label,other:a}))},{id:"dosage",helpText:"Enter the dosage for ".concat(e.label),type:c.TT_NUMBER,defaultValue:()=>e.other.dose_strength,validation:a=>u.required(a),computedValue:a=>Number(a.value),config:{keypad:[H,[["DELETE"]]]}},{id:"duration",helpText:"Enter the duration for ".concat(e.label),type:c.TT_NUMBER,validation:a=>u.required(a),computedValue:a=>Number(a.value)}],async(a,i)=>{await g.dismiss(),t(i)},()=>t({}))})}function P(){return{id:"drug_selection",helpText:"Select the drugs to be prescribed",type:c.TT_INFINITE_SCROLL_MULTIPLE_SELECT,onload:e=>o=e,validation:e=>u.required(e),options:async(e,t="",a=1,i=10)=>s.getDrugs(t,a,i),onValueUpdate:async e=>{for(let t=0;t<e.length;t++)if(e[t].isChecked&&!w(e[t].other)){const a=await S(e[t]);L.isEmpty(a)?e.splice(t,1):(e[t].other={...e[t].other,...a},o.filter="",o.selected="")}return e},config:{isFilterDataViaApi:!0,showKeyboard:!0,footerBtns:[{name:"Predefined Malaria Drugs",color:"primary",size:"large",visible:!1,slot:"end",onClick:v}]}}}function I(){return{id:"summary",helpText:"Prescribed Drugs",type:c.TT_TABLE_VIEWER,options:e=>{const t=["Drug","Dosage","Frequency","Duration"],a=e.drug_selection.map(i=>{var d;return[i.label,i.other.dosage,(d=p.find(x=>x.code===i.other.frequency))==null?void 0:d.label,i.other.duration]});return[{label:"Prescribed Drugs",value:"",other:{columns:t,rows:a}}]}}}return(e,t)=>(V(),k(q(z),null,{default:O(()=>[R(Q,{"skip-summary":"",fields:r.value,onFinishAction:n},null,8,["fields"])]),_:1}))}});export{se as default};
