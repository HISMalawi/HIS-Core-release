System.register(["./dynamic-import-helper-legacy-DYK5bIOV.js","./index-legacy--hxN_V8z.js","./drug_order_service-legacy-BZSuSNX0.js","./EncounterMixin.vue_vue_type_script_lang-legacy-BYNMg0KB.js","./encounter_guidelines-legacy-BZk5BWg2.js","./GuidelineEngine-legacy-KsvQuFdF.js","./HisStandardForm-legacy-C7VqHmr3.js","./TouchScreenForm-legacy-DxIQwsU4.js","./ToolbarMediumCard-legacy-CzmL2SiF.js","./Transformers-legacy-DhNYVLaS.js","./ViewPort-legacy-TUlObaz7.js"],(function(e,t){"use strict";var s,i,r,n,a,o,d,u,l,c,p,g;return{setters:[e=>{s=e.F},e=>{i=e.b2,r=e.d,n=e.H,a=e.n,o=e.t,d=e._,u=e.r,l=e.o,c=e.c},e=>{p=e.D},e=>{g=e._},null,null,null,null,null,null,null],execute:function(){class t extends i{drugHistory;currentDrugOrder;constructor(e,t){super(e,54,t),this.drugHistory=[],this.currentDrugOrder=[]}getDrugHistory(){return this.drugHistory}getCurrentOrder(){return this.currentDrugOrder}buildDispensations(e,t){return[{drug_order_id:e,date:this.date,quantity:t}]}saveDispensations(e){return i.postJson("/dispensations",{dispensations:e,program_id:i.getProgramID()})}async voidOrder(e){return i.void(`/dispensations/${e}`,{})}async loadDrugHistory(){const e=await p.getDrugOrderHistory(this.patientID);e&&(this.drugHistory=e)}async loadCurrentDrugOrder(){const e=await p.getDrugOrders(this.patientID);e&&(this.currentDrugOrder=await Promise.all(e))}calcCompletePack(e,t){const s=e.barcodes.sort((function(e,t){return e.tabs-t.tabs}));if(0==s.length||0==t)return t;for(let n=0;n<=s.length-1;n++)if(parseInt(s[n].tabs)>=t)return s[n].tabs;const i=parseInt(s[0].tabs);let r=parseInt(s[s.length-1].tabs);for(;r<t;)r+=i;return r}}const h=r({mixins:[g],data:()=>({dispensation:{}}),watch:{patient:{async handler(e){this.dispensation=new t(e.getID(),this.providerID),await this.dispensation.loadCurrentDrugOrder(),await this.dispensation.loadDrugHistory(),this.fields=this.getFields()},deep:!0}},methods:{saveDispensations(e){const t=this.buildDispensations(e);return this.dispensation.saveDispensations(t)},buildDispensations(e){return this.dispensation.buildDispensations(e.other.order_id,e.value)},buildMedicationHistory(){return this.dispensation.getDrugHistory().sort(((e,t)=>{const s=new Date(e.order.start_date);return new Date(t.order.start_date)-s})).map((e=>({medication:e.drug.name,date:n.toStandardHisDisplayFormat(e.order.start_date),amount:e.quantity})))},buildOrderOptions(){return this.dispensation.getCurrentOrder().map((e=>({label:e.drug.name,value:e.quantity||0,other:{drug_id:e.drug.drug_id,order_id:e.order.order_id,amount_needed:this.calculateCompletePack(e)}})))},getPackSizesRows(e,t){return this.dispensation.getDrugPackSizes(e).map((e=>[e,t>0?t/e:"-",0,0]))},calculateCompletePack(e){const t=parseFloat(e.amount_needed)-(e.quantity||0),s=this.dispensation.calcCompletePack(e,t);return s<0?0:s},isDoneDispensing:e=>e.map((e=>0!=e.value)).every(Boolean),async isValidDispensation(e){let t=!0;const s=parseInt(e.value.toString())/e.other.amount_needed*100;return s>110&&(t=await a("Are you sure you want to dispense over 110% of the prescribed pill count?")),s<100&&(t=await a("Are you sure you want to dispense less than 100% of the prescribe amount?")),t},getFields(){return[{id:"dispenses",helpText:"Dispensation",type:s.TT_DRUG_DISPENSER,onValueUpdate:async(e,t)=>-1!=e.value&&this.isDoneDispensing(t)?this.gotoPatientDashboard():(e.other.amount_needed=0,await this.dispensation.loadCurrentDrugOrder(),this.buildOrderOptions()),onValue:async(e,t)=>-1===e.value?!!(await this.dispensation.voidOrder(e.other.order_id)):!(!t&&!(await this.isValidDispensation(e)))&&(!!(await this.saveDispensations(e))||(o("Unable to save dispensation"),!1)),config:{medicationHistory:this.buildMedicationHistory(),toolbarInfo:[{label:"Name",value:this.patient.getFullName()},{label:"Gender",value:this.patient.getGender()},{label:"Date Of Birth",value:n.toStandardHisDisplayFormat(this.patient.getBirthdate())}],hiddenFooterBtns:["Clear","Finish"]},options:()=>this.buildOrderOptions()}]}}});e("default",d(h,[["render",function(e,t,s,i,r,n){const a=u("his-standard-form");return l(),c(a,{skipSummary:!0,cancelDestinationPath:e.cancelDestination,fields:e.fields},null,8,["cancelDestinationPath","fields"])}]]))}}}));
