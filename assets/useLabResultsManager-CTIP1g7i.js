import{aR as H,r as S,C as P,aB as B,s as _,aZ as y,H as b,cJ as M,al as o,am as l,bj as W,au as j,aE as Y,cK as k}from"./index-Ds0zDBhU.js";import{L as K}from"./lab_order_service-DNld-3nB.js";let m;const g=S([]),h=S([]),O=S(Math.random()),c=P({date:"",id:-1,indicators:[]});async function A(a,i,r){if(!v(a))return!0;const t=r.substring(0,1),s=r.substring(1,r.length);return W.isValidVLResult(i,t,s)?!0:!await j("Invalid results for ".concat(i," HIV viral load"),{cancelBtnLabel:"Process result",confirmBtnLabel:"Re-enter result"})}function w(a){return/^(>|<|=)(.*)/i.test(a)}function X(a){return/^(=|<|>)([0-9]*)$/im.test(a)}function U(a){return/^(=|<|>)([0-9]*\.?[0-9]*)$/im.test(a)}function L(a){return/serum crag/i.test(a)}function E(a){return/mrdt|malaria/i.test(a)}function R(a){return/Lam/i.test(a)}function v(a){return/HIV viral load/i.test(a)}function J(a){return E(a)||R(a)||L(a)}function Z(a,i,r,t){const s=J(a),d=s?"text":i["type_".concat(r)].value,f=s?"".concat(t):t.substring(1),n=s?"=":t.charAt(0);return{type:d,value:f,modifier:n}}function z(a,i,r){return a.map(t=>({testId:i,indicatorName:t.name,indicatorId:t.concept_id,specimen:r}))}async function $(){const a=await m.getTestsWithoutResults(),i=["Accession#","Specimen","Test","Order date"],r=[];for(const t of a)for(const s of t.tests)if(y.isEmpty(s.result)){const d=await m.getTestIndicators(s.concept_id),f=z(d,s.id,t.specimen.name);g.value.push(...f),r.push([t.accession_number,t.specimen.name,s.name,b.toStandardHisDisplayFormat(t.order_date),{type:"button",name:"Enter result",action:()=>{c.id=s.id,c.date=t.order_date,c.indicators=f,M(G)}}])}h.value=[{label:"",value:"",other:{rows:r,columns:i}}]}async function G(){return Y([{id:"result_date",helpText:"Result Date",type:l.TT_DATE_PICKER,defaultValue:()=>m.getDate(),computedValue:a=>a,config:{infoItems:a=>[{label:"Order Date",value:b.toStandardHisDisplayFormat(c.date)},{label:"Result Date",value:b.toStandardHisDisplayFormat(a)}],minDate:()=>b.toStandardHisFormat(c.date),maxDate:()=>m.getDate()}},{id:"result_indicators",helpText:"Select test result indicators",type:l.TT_MULTIPLE_SELECT,validation:a=>o.required(a),options:()=>c.indicators.map(a=>({label:a.indicatorName,value:a.indicatorId}))},...F(),{id:"entry_confirmation",helpText:"Confirm entry",type:l.TT_TABLE_VIEWER,options:(a,i)=>[{label:"",value:"",other:{rows:Object.values(i).filter(t=>typeof t=="object"&&t!=null&&t.tag==="result_indicator").map(t=>[t.test,t.modifier,t.result]),columns:["Test","Modifier","Result"]}}]}],async(a,i)=>{const r=Object.values(i).filter(s=>s.tag==="result_indicator"&&s.measures).map(s=>s.measures);await q(r,i.result_date)&&(await $(),k.dismiss(),O.value=Math.random())})}function F(){const a=[];let i=0;for(const r of g.value){const{indicatorName:t,indicatorId:s,testId:d,specimen:f}=r,n=s*d+i++,u=e=>c.id===d&&y.findIndex(e.result_indicators,{label:t})>-1,N=e=>A(t,f,e.value),p=(e,T)=>{if(/^other$/i.test(e.value)&&v(t))return{};const{type:x,value:I,modifier:V}=Z(t,T,n,e.value),D=x==="numeric"?parseFloat(I):I,C=y.find(T.result_indicators,{label:t});return{tag:"result_indicator",measures:{indicator:{concept_id:C.value},value:D,value_modifier:V,value_type:x},result:D,modifier:V,test:C.label}};a.push({id:"type_".concat(n),helpText:"Result type (".concat(t,")"),type:l.TT_SELECT,group:"test_indicator",condition:e=>u(e)&&!E(t)&&!R(t)&&!L(t),appearInSummary:()=>!1,validation:e=>o.required(e),options:()=>[{label:"Numeric (numbers only)",value:"numeric"},{label:"Alphanumeric(text and numbers)",value:"text"}]},{id:"urine_result_".concat(n),helpText:"Select Test Result (".concat(t,")"),type:l.TT_SELECT,group:"test_indicator",computedValue:p,validation:e=>o.required(e),condition:e=>u(e)&&R(t),options:()=>[{label:"Positive",value:"positive"},{label:"Negative",value:"negative"}]},{id:"crag_result_".concat(n),helpText:"Select Serum CrAg Result (".concat(t,")"),type:l.TT_SELECT,group:"test_indicator",computedValue:p,validation:e=>o.required(e),condition:e=>u(e)&&L(t),options:()=>[{label:"Positive",value:"positive"},{label:"Negative",value:"negative"}]},{id:"num_".concat(n),helpText:"Test Result (".concat(t,")"),type:l.TT_TEXT,group:"test_indicator",computedValue:p,beforeNext:N,onValue:e=>/hiv/i.test(t)&&e&&e.value&&!X(e.value.toString())?(_("You must enter a modifier and numbers only. i.e =90 / >19 / < 750"),!1):e&&e.value&&!U(e.value.toString())?(_("You must enter a modifier and numbers only. i.e =90 / >19.5 / < 750.45"),!1):!0,validation:e=>o.required(e),condition:e=>u(e)&&e["type_".concat(n)].value==="numeric",config:{customKeyboard:[[["1","2","3"],["4","5","6","=","<",">"],["7","8","9","."],["","0",""]],[["Delete"]]]}},{id:"alpha_".concat(n),helpText:"Test Result (".concat(t,")"),type:l.TT_TEXT,group:"test_indicator",computedValue:p,validation:e=>{const T=o.required(e);return T||(w("".concat(e==null?void 0:e.value))?null:["You must enter a modifier plus result (for example =LDL)"])},condition:e=>u(e)&&e["type_".concat(n)].value==="text"&&!v(t)},{id:"VL_alpha_".concat(n),helpText:"Select Test Result (".concat(t,")"),type:l.TT_SELECT,group:"test_indicator",computedValue:p,validation:e=>o.required(e),condition:e=>u(e)&&e["type_".concat(n)].value==="text"&&v(t),options:()=>[{label:"Collect Another Sample",value:"=Collect Another Sample"},{label:"<LDL",value:"<LDL"},{label:"=LDL",value:"=LDL"},{value:"Other",label:"Other"}]},{id:"other_VL_alpha_".concat(n),helpText:"Test Result (".concat(t,")"),type:l.TT_TEXT,group:"test_indicator",onValue:e=>e&&e.value&&!w(e.value.toString())?(_("You must enter a modifier plus result (for example =LDL)"),!1):!0,computedValue:p,validation:e=>o.required(e),condition:e=>u(e)&&e["type_".concat(n)].value==="text"&&v(t)&&e["VL_alpha_".concat(n)].value==="Other"},{id:"malaria_result_".concat(n),helpText:"Select Test Result (".concat(t,")"),type:l.TT_SELECT,group:"test_indicator",computedValue:p,validation:e=>o.required(e),condition:e=>u(e)&&E(t),options:()=>t.match(/mrdt/i)?[{label:"Positive",value:"positive"},{label:"Negative",value:"negative"}]:[{label:"Parasites seen",value:"parasites seen"},{label:"No parasites seen",value:"no parasites seen"}]})}return a}async function q(a,i){try{return await m.createEncounter(),await m.createLabResult(a,c.id,i),B.invalidate("PATIENT_LAB_ORDERS"),g.value=[],_("Lab result saved successfully"),!0}catch(r){return console.error(r),_("Failed to save lab result"),!1}}function Q(a=!1){return[{id:"test_type",helpText:"Tests without results",type:l.TT_TABLE_VIEWER,condition:()=>a?!y.isEmpty(h.value[0].other.rows):!0,init:async()=>(await $(),!0),options:()=>h.value,config:{hiddenFooterBtns:["Clear"]}}]}function ae(a,i,r){return m=new K(a,i),H(O,()=>r.value++,{deep:!0}),{testIndicators:g,testOptions:h,getLabFields:Q,isValidResult:A,buildTestIndicatorFields:F,loadLabTests:$,submitLabResult:q}}export{ae as u};
