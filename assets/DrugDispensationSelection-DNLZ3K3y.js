import{d as S,O as g,cB as N,_ as V,r as c,o as r,x as d,b as a,w as u,A as e,v as h,B as k,y as D,ay as P,u as v,a6 as I,a7 as E,bl as M,bm as R,aj as H,aq as L,ar as q,ae as T,q as F,c as Q,z as A}from"./index-CZ5Jg0n0.js";import{O as U}from"./ActionSideButton-ktMeCdAU.js";import{R as j}from"./ResetButton-DfYdBC0f.js";import{_ as G}from"./FieldMixin.vue_vue_type_script_lang-Bls-Q6Pl.js";const J=S({data:()=>({listData:[],tabsIndex:2,packsIndex:3}),props:{drugName:{type:String,required:!0},tabsNeeded:{type:String,required:!0},items:{type:Array,required:!0},onDispense:{type:Function,required:!0},onClose:{type:Function}},computed:{dispensedValues(){return this.listData.filter(t=>t[this.tabsIndex]>0).map(t=>[t[this.tabsIndex],t[this.packsIndex]])},amountNeededRowSpan(){return this.listData.length+1}},watch:{items:{handler(t){t&&(this.listData=[...t])},deep:!0,immediate:!0}},methods:{async onClose(){await g.dismiss({}),typeof this.onClose=="function"&&this.onClose()},incrementAmount(t){const[n,,i,p]=this.listData[t],o=n+i,m=p+1;this.listData[t][2]=o,this.listData[t][3]=m},decrementAmount(t){const[n,,i,p]=this.listData[t],o=p-1;if(o>=0){const m=i-n;this.listData[t][2]=m,this.listData[t][3]=o}},fmtNumber(t){return/-/i.test(t)?t:N(t)}}}),z=t=>(I("data-v-de39aa22"),t=t(),E(),t),K={colspan:"6"},W=z(()=>e("tr",null,[e("th",null,"Total tab(s) needed "),e("th",{colspan:"2"}," Available stock "),e("th",{colspan:"2"}," Dispensed "),e("th")],-1)),X=z(()=>e("tr",null,[e("th"),e("th",null," Pack size "),e("th",null," Packs "),e("th",null," Total Tab(s)"),e("th",null," Packs "),e("th")],-1)),Y=["rowspan"],Z={class:"btn-list"};function x(t,n,i,p,o,m){const l=c("ion-button"),b=c("ion-content"),w=c("ion-toolbar"),C=c("ion-footer");return r(),d(k,null,[a(b,null,{default:u(()=>[e("table",null,[e("thead",null,[e("tr",null,[e("th",K,h(t.drugName),1)]),W,X]),e("tbody",null,[e("tr",null,[e("td",{rowspan:t.amountNeededRowSpan},h(t.tabsNeeded)+" tab(s) ",9,Y)]),(r(!0),d(k,null,D(t.listData,(y,_)=>(r(),d("tr",{key:_},[(r(!0),d(k,null,D(y,(f,s)=>(r(),d("td",{key:s,class:P(s>=2?"input-field":"his-md-text")},h(t.fmtNumber(f)),3))),128)),e("td",null,[e("ul",Z,[e("li",null,[a(l,{onClick:f=>t.incrementAmount(_),class:"dispense-btn",size:"large"},{default:u(()=>[v(" + ")]),_:2},1032,["onClick"])]),e("li",null,[a(l,{onClick:f=>t.decrementAmount(_),class:"dispense-btn",size:"large"},{default:u(()=>[v(" - ")]),_:2},1032,["onClick"])])])])]))),128))])])]),_:1}),a(C,null,{default:u(()=>[a(w,null,{default:u(()=>[a(l,{onClick:t.onClose,color:"danger",size:"large",slot:"end"},{default:u(()=>[v(" Close ")]),_:1},8,["onClick"]),a(l,{onClick:n[0]||(n[0]=y=>t.onDispense(t.dispensedValues)),color:"success",size:"large",slot:"end"},{default:u(()=>[v(" Dispense ")]),_:1})]),_:1})]),_:1})],64)}const tt=V(J,[["render",x],["__scopeId","data-v-de39aa22"]]),et=S({components:{IonInput:M,ViewPort:R,Barcode:H,NavButton:U,ResetButton:j,IonRow:L,IonCol:q},mixins:[G],data:()=>({dispensingLockEnabled:!1,tab:"prescribe",listData:[],medicationHistory:[],isStockManagementEnabled:!1}),mounted(){this.init()},activated(){this.init()},watch:{tab:{handler(t){t==="history"&&T.isEmpty(this.medicationHistory)&&typeof this.config.medicationHistory=="function"&&this.config.medicationHistory().then(n=>{n&&(this.medicationHistory=n)}).catch(n=>{F("".concat(n))})}}},methods:{async init(){var t,n;this.$emit("onFieldActivated",this),typeof((t=this.config)==null?void 0:t.isDrugManagementEnabled)=="function"&&(this.isStockManagementEnabled=(n=this.config)==null?void 0:n.isDrugManagementEnabled()),this.listData=await this.options(this.fdata)},async onScan(t){const[n,i]=t.split("-"),p=this.listData.map(async o=>{if(o.other.drug_id===parseInt(n)){const m=parseInt(o.value.toString()),l=parseInt(i);await this.updateOnValue(o,l,[],!0)&&(o.value=l+m)}return o});this.listData=await Promise.all(p)},async onReset(t){await this.updateOnValue(t,-1)},fmtNumber(t){return!this.isStockManagementEnabled||/-/i.test(t)?"-":N(t)},async updateOnValue(t,n,i=[],p=!1){return this.onValue&&!await this.onValue({label:t.label,other:{dispenses:i,...t.other},value:n},p)?!1:(t.value=n<0?0:n,this.$emit("onValue",t),this.onValueUpdate&&(this.listData=await this.onValueUpdate(t,this.listData)),!0)},async launchDispenser(t){this.dispensingLockEnabled=!0,(await g.create({component:tt,backdropDismiss:!1,cssClass:"custom-modal",componentProps:{drugName:t.label,tabsNeeded:t.other.amount_needed,items:t.other.pack_sizes,onClose:async()=>{this.dispensingLockEnabled=!1,await g.dismiss({})},onDispense:async i=>{const o=i.reduce((l,b)=>l+b[0],0);await this.updateOnValue(t,o,i)&&(this.dispensingLockEnabled=!1,await g.dismiss({}))}}})).present()}}}),B=t=>(I("data-v-e0e49e2a"),t=t(),E(),t),nt={class:"view-port-content"},st={key:0,class:"his-card history"},ot={class:"his-table"},at=B(()=>e("tr",null,[e("th",null," Medication"),e("th",null," Date"),e("th",null," Amount dispensed ")],-1)),it={key:1,class:"prescription-tab"},lt={class:"prescription-table-section his-card"},rt={class:"his-table"},ct=B(()=>e("tr",null,[e("th",null," Medication"),e("th",null," Amount in stock"),e("th",null," Amount needed"),e("th",null," Amount dispensed "),e("th",null," Reset ")],-1)),ut={class:"barcode-section"};function dt(t,n,i,p,o,m){const l=c("nav-button"),b=c("ion-col"),w=c("ion-input"),C=c("reset-button"),y=c("barcode"),_=c("ion-row"),f=c("view-port");return r(),Q(f,null,{default:u(()=>[e("div",nt,[a(_,null,{default:u(()=>[a(b,{size:"2"},{default:u(()=>[a(l,{onClick:n[0]||(n[0]=s=>t.tab="prescribe"),isActive:t.tab==="prescribe",image:"prescription/rx",label:"Prescribed"},null,8,["isActive"]),a(l,{onClick:n[1]||(n[1]=s=>t.tab="history"),isActive:t.tab==="history",image:"prescription/history",label:"History"},null,8,["isActive"])]),_:1}),a(b,{size:"10"},{default:u(()=>[t.tab==="history"?(r(),d("div",st,[e("table",ot,[at,(r(!0),d(k,null,D(t.medicationHistory,(s,$)=>(r(),d("tr",{key:$},[e("td",null,h(s.medication),1),e("td",null,h(s.date),1),e("td",null,h(s.amount),1)]))),128))])])):A("",!0),t.tab==="prescribe"?(r(),d("div",it,[e("div",lt,[e("table",rt,[ct,(r(!0),d(k,null,D(t.listData,(s,$)=>(r(),d("tr",{key:$},[e("td",null,h(s.label),1),e("td",null,h(t.fmtNumber(s.other.available_stock)),1),e("td",null,h(s.other.amount_needed),1),e("td",null,[a(w,{disabled:t.dispensingLockEnabled||s.value>0,value:s.value,onClick:O=>s.value<=0&&!t.dispensingLockEnabled?t.launchDispenser(s):null,class:"dosage-input"},null,8,["disabled","value","onClick"])]),e("td",null,[a(C,{label:"",disabled:s.value<=0,onClick:O=>s.value>0?t.onReset(s):null},null,8,["disabled","onClick"])])]))),128))])]),e("div",ut,[a(y,{onOnScan:t.onScan,class:"his-card"},null,8,["onOnScan"])])])):A("",!0)]),_:1})]),_:1})])]),_:1})}const _t=V(et,[["render",dt],["__scopeId","data-v-e0e49e2a"]]);export{_t as default};
