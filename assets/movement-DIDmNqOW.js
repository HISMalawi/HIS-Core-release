var v=Object.defineProperty;var S=(e,t,a)=>t in e?v(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a;var d=(e,t,a)=>S(e,typeof t!="symbol"?t+"":t,a);import{d as y,bj as E,ae as u,U as D,q as g,F as l,V as n,cH as h,bo as b,t as k,bn as I,cB as A,H as _,b3 as T,_ as x,r as C,o as F,c as R}from"./index-C-Wf7IuL.js";import{H as $}from"./HisStandardForm-zCup__or.js";class p{constructor(){d(this,"BASE30_DIGITS_INDEX",{});d(this,"BASE30_DIGITS");this.BASE30_DIGITS="0123456789ABCDEFGHJKLMNPRTVWXY".split(""),this.BASE30_DIGITS.forEach((t,a)=>this.BASE30_DIGITS_INDEX[t]=a)}convertFromDecimal(t,a=30){if(a<2||a>30)throw"Invalid base ${toBase}";let o="";for(;t>0;)o=this.BASE30_DIGITS[t%a]+o,t=Math.floor(t/a);return o}static calculateLuhnCheckDigit(t){const a=t.toString().split("").map(s=>Number.parseInt(s,10)),o=a.length%2;let i=0;a.forEach((s,c)=>{c%2===o&&(s*=2),s>9&&(s-=9),i+=s});const r=i%10;return r===0?0:10-r}isValidDHACode(t){try{const a=this.convertToDecimal(t).toString();return p.calculateLuhnCheckDigit(Number.parseInt(a,10)*10)===0}catch(a){return console.error(a),!1}}convertToDecimal(t){if(t.length==0)return 0;const a=this.BASE30_DIGITS_INDEX[t[0]];if(a==null)throw"Invalid base ${fromBase} number: ${number}";return a*30**(t.length-1)+this.convertToDecimal(t.slice(1))}}const B=y({components:{HisStandardForm:$},data:()=>({activeField:"",fields:[],drugs:[],selectedDrugs:[],barcode:"",stockService:{}}),methods:{async onFinish(e){let t=[];for(const a of e.enter_batches){const o={reallocation_code:e.authorization.value,quantity:a.other.pack_size*a.other.tins,date:e.date.value,reason:a.other.reason};try{e.task.value==="Relocations"?await this.stockService.relocateItems(a.other.id,{...o,location_id:e.relocation_location.value}):await this.stockService.disposeItems(a.other.id,o)}catch(i){i instanceof E&&!u.isEmpty(i.errors)?t=t.concat(i.errors.map(r=>"".concat(r," for ").concat(a.other.drug_name))):t.push("".concat(i)),console.log(i)}}if(u.isEmpty(t))return D("Stock succesfully moved"),this.$router.push("/");g("".concat(t.join(",")))},getFields(){return[{id:"task",helpText:"Select task",type:l.TT_SELECT,validation:e=>n.required(e),options:()=>[{label:"Relocations",value:"Relocations"},{label:"Disposal",value:"Disposal"}]},{id:"relocation_location",helpText:"Destination",type:l.TT_SELECT,validation:e=>n.required(e)||n.notTheSame(e.label,"".concat(h.getLocationName())),condition:e=>e.task.value==="Relocations",options:(e,t="")=>b(t),computedValue:e=>e.label,config:{showKeyboard:!0,isFilterDataViaApi:!0}},{id:"date",dynamicHelpText:e=>"Date of ".concat(e.task.label),helpText:"Set date",type:l.TT_FULL_DATE,validation:e=>n.required(e)},{id:"select drugs",helpText:"Select drugs",type:l.TT_MULTIPLE_SELECT,requireNext:!0,validation:e=>n.required(e),options:async(e,t)=>this.getDrugs(t,e.date.value),unload:e=>this.selectedDrugs=e},{id:"enter_batches",helpText:"Batch entry",type:l.TT_BATCH_MOVEMENT,beforeNext:(e,t,a,{currentFieldContext:o})=>{const i=s=>s.map(c=>"".concat(c.label)).join(" & "),r=o.drugs.filter(s=>!s.other.tins||!s.other.reason);if(!u.isEmpty(r)){const s=i(r);return k("Please fix partial batch entries for drugs: ".concat(s)),!1}return!0},options:()=>this.selectedDrugs,validation:e=>n.required(e),config:{getReasons:this.getReasons}},{id:"authorization",helpText:"Enter authorization code",type:l.TT_TEXT,config:{customKeyboard:[I,[["Delete"]]]},validation:e=>n.validateSeries([()=>n.required(e),()=>{const t=e.value;return new p().isValidDHACode(t.toUpperCase())?null:["Invalid authorization code"]}])},{id:"summary",helpText:"Summary",type:l.TT_TABLE_VIEWER,options:e=>this.buildResults(e),config:{hiddenFooterBtns:["Clear"]}}]},buildResults(e){const t=e.task.value==="Relocations",a=["Drug","Total Tins","Expiry date","Authorization code","Reason"];t&&a.push("Relocation");const o=e.enter_batches.map(i=>{const r=[i.other.drug_name,A(i.other.tins),_.toStandardHisDisplayFormat(i.other.expiry_date),e.authorization.value.toUpperCase(),i.other.reason];return t&&r.push(e.relocation_location.label),r});return[{label:"Confirm entry",value:"Table",other:{columns:a,rows:o}}]},async getDrugs(e,t){return(await this.stockService.getItems()).map(o=>{var c,m;const i=(m=(c=o==null?void 0:o.drug_name)!=null?c:o==null?void 0:o.drug_legacy_name)!=null?m:"N/A",r=_.toStandardHisDisplayFormat(o.expiry_date),s=e.filter(f=>f.label===i).length>=1;return{label:i,value:o.drug_id,isChecked:s,description:{color:"primary",show:"always",text:"Product Code: ".concat(o.product_code," - Batch Number: ").concat(o.batch_number," - Pack Size: ").concat(o.pack_size," - Expiry date: ").concat(r)},other:{...o,tins:null,quantity:Math.trunc(o.current_quantity/o.pack_size)||0,reason:""}}}).filter(o=>!T(t).isBefore(o.other.delivery_date)&&o.other.current_quantity>0)},mapToOptions(e){return e.map(t=>({label:t,value:t}))},getReasons(e,t){var i;if(t.task.value==="Relocations")return this.mapToOptions(["Transfer to another facility/relocation","For trainings"]);const a=T((i=e.other)==null?void 0:i.expiry_date).isAfter(h.getSessionDate()),o=["Damaged","Phased out","Banned","Missing"];return a||o.push("Expired"),this.mapToOptions(o)}},created(){this.stockService=new h,this.fields=this.getFields()}});function N(e,t,a,o,i,r){const s=C("his-standard-form");return F(),R(s,{fields:e.fields,activeField:e.activeField,onFinishAction:e.onFinish,skipSummary:!0},null,8,["fields","activeField","onFinishAction"])}const w=x(B,[["render",N]]);export{w as default};
