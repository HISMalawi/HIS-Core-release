const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/PatientConfirmationCards-C5QZw2MJ.js","assets/index-CMZASHAR.js","assets/index-DRfyWMnt.css","assets/PatientConfirmationCards-Ov8Qvv0q.css"])))=>i.map(i=>d[i]);
import{aW as c,bO as _,bP as k,bQ as G,bn as q,bC as O,d as K,_ as J,X as Q,a9 as Z,I as tt,Y as et,bR as at,a3 as nt,a4 as it,a8 as st,bb as rt,bo as ot,an as ct,aN as m,H as L,U as S,bz as T,al as f,am as D,bS as lt,bT as F,aw as I,bU as B,bA as dt,bI as pt,by as ut,au as V,W as M,aj as b,bF as A,bV as ht,R as H,B as mt,bG as gt,ak as ft,bB as Nt,aa as Dt,c as E,w as d,af as h,a as y,b as u,K as o,C as p,a2 as g,E as yt,G as It,J as Et,M as U}from"./index-CMZASHAR.js";import{m as wt}from"./GuidelineEngine-D6V1_Znr.js";import{p as At}from"./VoidReason-H99Hq1yQ.js";var v=(t=>(t.ON_CONTINUE="oncontinue",t.ONLOAD="onload",t))(v||{}),n=(t=>(t.FORCE_EXIT="forceExit",t.GO_HOME="gotoHome",t.GO_BACK="goBack",t.CONTINUE="continue",t.ENROLL="enroll",t.EXIT="exit",t.ACTIVATE_FN="activateFn",t.ASSIGN_NPID="assignNpid",t.UPDATE_DMG="updateDemographics",t.PRINT_NPID="printNPID",t.CREATE_NPID_WITH_REMOTE_DIFF="createNpiDWithRemote",t.REFRESH_DDE_DEMOGRAPHICS="refreshDemographicsDDE",t.UPDATE_LOCAL_DDE_DIFFS="updateLocalDiffs",t.RESOLVE_DUPLICATE_NPIDS="resolveDuplicateNpids",t.ADD_AS_DRUG_REFILL="addAsDrugRefill",t.ADD_AS_NEW_PATIENT="addAsNewPatient",t.ADD_AS_EXTERNAL_CONSULTATION="addAsExternalConsultation",t.INITIATE_ANC_PREGNANCY="initiateNewAncPregnancy",t.VIEW_MERGE_AUDIT_FOR_NPID="viewMergeAuditForNpid",t.SEARCH_BY_NAME="searchByName",t.SYNCH_ART_STATUS_WITH_TB="syncArtStatusWithTb",t.ALERT_TO_BRING_NATIONAL_ID_NEXT="bringNationalID",t.SCAN_NATIONAL_ID="scanNationalID",t))(n||{});const Pt={"[DDE NOT ENABLED] Do not proceed if patient is not found in the system":{weight:98,targetEvent:"onload",actions:{alert:async()=>await c(" 0 Search results","Patient has not been found","Choose how to proceed",[{name:"Close",slot:"start",color:"primary"},{name:"Search by name",slot:"end",color:"success"}],"his-danger-color")==="Search by name"?"searchByName":"gotoHome"},conditions:{globalProperties({ddeEnabled:t}){return t===!1},patientFound(t){return t===!1}}},"[DDE ENABLED] Show invalid attributes for a patient whose remote":{weight:78,targetEvent:"onload",actions:{alert:async t=>(await _("DDE Entity Error","Remote patient has invalid attributes",["Attribute","Errors"],t.demographics.invalidDemographics,[{name:"Close",slot:"start",color:"danger"}],"his-danger-color"),"goBack")},conditions:{demographics({hasInvalidDemographics:t}){return t===!0}}},"[DDE ENABLED] Do not proceed if NPID is not found and Provide history of voided NPIDS":{weight:98,targetEvent:"onload",actions:{alert:async t=>{const e=await _("Voided patients with ID ".concat(t.scannedNpid),"NPID was not found. Please review available patient with similar ID",t.dde.voidedNpids.cols,t.dde.voidedNpids.rows,[{name:"Close",slot:"start",color:"primary"},{name:"Merge history",slot:"end",color:"primary"},{name:"Search by name",slot:"end",color:"success"}],"his-danger-color");return e==="Merge history"?"viewMergeAuditForNpid":e==="Search by name"?"searchByName":"gotoHome"}},conditions:{globalProperties({ddeEnabled:t}){return t===!0},patientFound(t){return t===!1}}},"[DDE NOT ENABLED] Notify the user to proceed with Remote NPID if local NPID does not match remote":{weight:77,targetEvent:"onload",actions:{alert:async({dde:t})=>(await c("Missing Local NPID",'Local NPID of "'.concat(t.localNpidDiff,'" does not match remote "').concat(t.remoteNpidDiff,'"'),"Proceed to Fix issue",[{name:"Resolve issue",slot:"start",color:"danger"}],"his-danger-color"),"createNpiDWithRemote")},conditions:{dde({localNpidDiff:t,remoteNpidDiff:e}){return t!=e},globalProperties({ddeEnabled:t}){return t===!0}}},"Warn if patient is missing National ID and assign them one":{weight:75,targetEvent:"onload",actions:{alert:async()=>(await c("Missing National ID","Patient was found BUT has no National ID","The system is going to assign the patient with a new ID",[{name:"OK",slot:"start",color:"primary"}],"his-danger-color"),"assignNpid")},conditions:{currentNpid:t=>k(t)}},"Detect NPID over 5 duplicates and prompt the user to resolve them":{weight:99,targetEvent:"onload",actions:{alert:async({scannedNpid:t})=>await c("More than 5 duplicates found","There are more than 5 duplicates for this NPID (".concat(t,"). Please search by name and gender"),"Choose how to proceed",[{name:"Close",slot:"start",color:"danger"},{name:"Search by name",slot:"start",color:"primary"}],"his-danger-color")==="Search by name"?"searchByName":"gotoHome"},conditions:{npidHasOverFiveDuplicates(t){return t}}},"Detect NPID duplicates and prompt the user to resolve them":{weight:99,targetEvent:"onload",actions:{alert:async({scannedNpid:t})=>(await c("DUPLICATE NPID","NPID ".concat(t," is currently assigned to multiple patients"),"Proceed to resolve the issue",[{name:"Resolve Duplicate NPIDs",slot:"start",color:"danger"}],"his-danger-color"),"resolveDuplicateNpids")},conditions:{npidHasDuplicates(t){return t}}},"Enquire if patient has brought a national ID":{weight:95,targetEvent:"onload",actions:{alert:async()=>await c("Malawi National ID","Has Client brought a National ID Card or Birth Certificate?","",[{name:"Yes",slot:"start",color:"primary"},{name:"No",slot:"end",color:"primary"}])=="Yes"?"scanNationalID":"bringNationalID"},conditions:{isMalawiNationalIDFeaturesEnabled:t=>t,hasMalawiNationalID:t=>!t}},"Warn before proceeding if patient is deceased based on current Patient state":{weight:50,targetEvent:"oncontinue",actions:{alert:async()=>await c("Deceased Patient","Patient outcome is Died!","Do you want to continue?",[{name:"Yes",slot:"start",color:"danger"},{name:"No",slot:"end",color:"success"}],"his-warning-color")==="Yes"?"continue":"forceExit"},conditions:{currentOutcome:t=>t==="Patient died"}},"Warn before proceeding if patient stopped treatment based on current Patient state":{weight:49,targetEvent:"oncontinue",actions:{alert:async()=>await c("Stopped Treatment","Patient outcome is Stopped Treatment ","Do you want to continue?",[{name:"Yes",slot:"start",color:"danger"},{name:"No",slot:"end",color:"success"}],"his-warning-color")==="Yes"?"continue":"forceExit"},conditions:{currentOutcome:t=>t==="Treatment stopped"}},"[ART patient visit purpose] Select purpose of visit if patient is Transferred out or Emergency supply":{weight:70,targetEvent:"oncontinue",actions:{alert:async({patientType:t,currentOutcome:e})=>{let a=[];switch((t==="External consultation"||e==="Patient transferred out")&&(a=[{name:"Emergency supply",slot:"start",color:"primary"},{name:"New Patient",slot:"end",color:"primary"}]),t==="Emergency supply"&&(a=[{name:"External Consultation",slot:"start",color:"primary"},{name:"New Patient",slot:"end",color:"primary"}]),t==="New patient"&&(a=[{name:"External Consultation",slot:"start",color:"primary"},{name:"Emergency supply",slot:"start",color:"primary"}]),await c("Purpose of visit","Patient type: ".concat(t," | State: ").concat(e),"Please select purpose of the visit",[...a,{name:"Continue",slot:"end",color:"success"}])){case"Emergency supply":return"addAsDrugRefill";case"External Consultation":return"addAsExternalConsultation";case"New Patient":return"addAsNewPatient";default:return"continue"}}},conditions:{programName:t=>t==="ART",patientType:(t,{currentOutcome:e})=>["Emergency supply","External consultation"].includes(t)||e==="Patient transferred out"}},"Prompt patient enrollment in current programme if not enrolled":{weight:30,targetEvent:"onload",actions:{alert:async()=>await c("Programme Enrollment","Patient is not enrolled in current programme, do you want to enroll?","",[{name:"Yes",slot:"start",color:"success"},{name:"No",slot:"end",color:"danger"}])==="Yes"?"enroll":"exit"},conditions:{enrolledInProgram:t=>t===!1}},"(ART Filing numbers) Prompt dormant filing number reactivation if patient has a dormant filing number":{weight:25,targetEvent:"onload",actions:{alert:async()=>await c("Filing Numbers","Activate dormant #?","",[{name:"Yes",slot:"start",color:"success"},{name:"No",slot:"end",color:"danger"}])==="Yes"?"activateFn":"exit"},conditions:{programName:t=>t==="ART",identifiers:t=>t.includes("Archived filing number"),currentOutcome:t=>!["Treatment stopped","Patient transferred out","Patient died"].includes(t),globalProperties({useFilingNumbers:t}){return t}}},"[DDE OFF] Prompt the user to update patient demographics when data is incomplete":{weight:92,targetEvent:"onload",actions:{alert:async()=>await c("Demographics","Patient data is incomplete","Do you want to review and update now?",[{name:"Yes",slot:"start",color:"success"},{name:"No",slot:"end",color:"danger"}],"his-danger-color")==="Yes"?"updateDemographics":"exit"},conditions:{globalProperties({ddeEnabled:t}){return t===!1},demographics:({patientIsComplete:t})=>t===!1,patientFound:t=>t===!0}},"[DDE] Alert When remote Patient demographics dont match Local Demographics ":{weight:93,targetEvent:"onload",actions:{alert:async({dde:t})=>await _("Demographics Mismatch","Local Demographics do not match Remote Demographics",["Attributes","Local","Remote"],t.diffRows,[{name:"Use Local",slot:"start",color:"primary"},{name:"Use Remote",slot:"start",color:"primary"}],"his-danger-color",t.diffRowColors)==="Use Local"?"updateLocalDiffs":"refreshDemographicsDDE"},conditions:{dde({hasDemographicConflict:t}){return t}}},"[DDE] Alert to print newer NPID when the scanned NPID doesnt match active NPID":{weight:69,targetEvent:"onload",actions:{alert:async({currentNpid:t})=>(await c("[DDE] NATIONAL ID","Patient has a newer National Identifier ".concat(t),"Print and proceed",[{name:"Print",slot:"start",color:"primary"}]),"printNPID")},conditions:{globalProperties({ddeEnabled:t}){return t===!0},scannedNpid(t,{currentNpid:e}){return!t.match(new RegExp(e,"i"))}}},"assign newer NPID when the current one is invalid":{weight:68,targetEvent:"onload",actions:{alert:async({currentNpid:t})=>(await c("NATIONAL ID","Current NPID ".concat(t," is invalid"),"Reasign and Print",[{name:"Reassign",slot:"start",color:"primary"}]),"assignNpid")},conditions:{demographics:({patientIsComplete:t})=>t===!0,patientFound:t=>t===!0,hasInvalidNpid(t){return t}}},"[DDE ON] Warn program managers when Patient has incomplete demographics. Dont force them to update though":{weight:91,targetEvent:"onload",actions:{alert:async()=>await c("Demographics","Patient data is incomplete data","Do you want to review and update now?",[{name:"Yes",slot:"start",color:"success"},{name:"No",slot:"end",color:"danger"}],"his-danger-color")==="Yes"?"updateDemographics":"continue"},conditions:{globalProperties({ddeEnabled:t}){return t===!0},demographics:({patientIsComplete:t})=>t===!1,patientFound:t=>t===!0,userRoles(t){return t.includes("Program Manager")===!0}}},"[DDE ON] Force Users to update Incomplete Patient demographics":{weight:92,targetEvent:"onload",actions:{alert:async()=>await c("Patient Demographics","Demographic data is incomplete","Continue to update",[{name:"Update",slot:"start",color:"success"},{name:"Cancel",slot:"start",color:"danger"}],"his-warning-color")==="Cancel"?"gotoHome":"updateDemographics"},conditions:{globalProperties({ddeEnabled:t}){return t===!0},demographics:({patientIsComplete:t})=>t===!1,userRoles:t=>t.includes("Program Manager")===!1}},"Warn the user when patient has high viral load":{weight:45,targetEvent:"onload",actions:{alert:async()=>(await c("High Viral Load","Patient has a high viral load, please take immediate action!","",[{name:"OK",slot:"end",color:"danger"}],"his-danger-color"),"continue")},conditions:{hasHighViralLoad:t=>t===!0}},"[ANC] Warn last LMP is more than 8 months ago and ask to initiate new pregnancy":{weight:32,targetEvent:"oncontinue",actions:{alert:async({anc:t})=>await c("Pregancy overdue","Last menstrual period was ".concat(t.lmpMonths," months ago!"),"Would you like to initiate new pregnancy?",[{name:"Yes",slot:"end",color:"success"},{name:"No",slot:"end",color:"danger"}],"his-danger-color")==="Yes"?"initiateNewAncPregnancy":"continue"},conditions:{programName:t=>t==="ANC",anc:t=>t.currentPregnancyIsOverdue===!0}},"[ANC] Exit if client is NOT ELIGIBLE for ANC":{weight:89,targetEvent:"onload",actions:{alert:async()=>await c("Client not eligible for ANC","This program is for women eligible for ANC only","If this is a mistake, please update client Demographics or Exit",[{name:"EXIT",slot:"end",color:"success"},{name:"EDIT DEMOGRAPHICS",slot:"end",color:"danger"}],"his-danger-color")==="EXIT"?"gotoHome":"updateDemographics"},conditions:{demographics:({gender:t})=>{const e=t.toLowerCase();return e==="m"||e==="male"},programName:t=>t==="ANC"}},"Alert the provider that the client is on ART and record needs to be synched with TB":{weight:89,targetEvent:"oncontinue",actions:{alert:async()=>await c("TB PROGRAM ALERT","Client was enrolled in the ART program","Do you want to synchronize ART status into TB program?",[{name:"No",slot:"end",color:"primary"},{name:"Yes",slot:"end",color:"success"}],"his-danger-color")==="No"?"continue":"syncArtStatusWithTb"},conditions:{programName:t=>t==="TB",tb:({noHivPositiveRecordInTB:t,clientEnrolledInArtProgram:e})=>e&&t}}};class $ extends G{constructor(e,a){super(e,111,a)}async getLmpInMonths(){const e=await q.getProgramInformation(this.patientID);if(e.date_of_lnmp){const a=O(e.date_of_lnmp);return O(this.date).diff(a,"months")}return-1}async pregnancyIsOverdue(){return await this.getLmpInMonths()>9}async canInitiateNewPregnancy(){return await this.getLmpInMonths()>=7}async createNewPregnancyStatus(){return await this.createEncounter(),this.saveValueCodedObs("Pregnancy status","New")}}const _t=K({name:"Patient Confirmation",components:{IonContent:J,IonHeader:Q,IonFooter:Z,IonPage:tt,IonToolbar:et,IonSpinner:at,IonRow:nt,IonCol:it,IonButton:st,ConfirmationCard:rt(()=>Nt(()=>import("./PatientConfirmationCards-C5QZw2MJ.js"),__vite__mapDeps([0,1,2,3])))},data:()=>({app:{},program:{},patient:{},localPatient:{},ddeInstance:{},useDDE:!1,programInfo:{},isReady:!1,cards:[],facts:{isMalawiNationalIDFeaturesEnabled:!1,hasMalawiNationalID:!1,hasHighViralLoad:!1,patientFound:!1,npidHasDuplicates:!1,npidHasOverFiveDuplicates:!1,userRoles:[],scannedNpid:"",currentNpid:"",hasInvalidNpid:!1,enrolledInProgram:!1,programName:"N/A",currentOutcome:"",programs:[],identifiers:[],patientType:"N/A",patientTypeLastUpdated:"",tb:{noHivPositiveRecordInTB:!1,clientEnrolledInArtProgram:!1,_artData:{}},anc:{lmpMonths:-1,canInitiateNewPregnancy:!1,currentPregnancyIsOverdue:!1},dde:{localNpidDiff:"",remoteNpidDiff:"",voidedNpids:{cols:[],rows:[]},hasDemographicConflict:!1,localDiffs:{},diffRows:[],diffRowColors:[]},demographics:{patientIsComplete:!1,hasInvalidDemographics:!1,invalidDemographics:[],givenName:"",familyName:"",patientName:"",landmark:"",phoneNumber:"",currentDistrict:"",currentTA:"",currentVillage:"",ancestryDistrict:"",ancestryTA:"",ancestryVillage:"",gender:"",birthdate:""},globalProperties:{useFilingNumbers:!1,ddeEnabled:!1}}}),created(){this.initCards(),this.app=ot.getActiveApp()||{}},mounted(){this.app&&(this.updateCards(),this.ddeInstance=new ct,this.setGlobalPropertyFacts().then(()=>{const t=this.$route.query;!m.isEmpty(t)&&(t.person_id||t.patient_barcode)&&this.findAndSetPatient(t.person_id,t.patient_barcode)}))},computed:{demographics(){return this.facts.demographics},birthdate(){return L.toStandardHisDisplayFormat(this.facts.demographics.birthdate)},canVoidClient(){return this.facts.patientFound&&S.isDataManager()}},methods:{initCards(){for(let t=0;t<6;t++)this.cards[t]={label:"-",isLoading:!0,values:[]}},async updateCards(){if(typeof this.app.confirmationSummary=="function"){const t=this.app.confirmationSummary(this.patient,this.program,this.facts),e=Object.keys(t);for(let a=0;a<this.cards.length;a++){const i=e[a]?t[e[a]]():[];if(this.cards[a]={label:e[a]||"-",isLoading:!1,values:i},typeof i=="object"&&i.then)this.cards[a].isLoading=!0,m.isEmpty(this.patient)||i.then(s=>{this.cards[a].isLoading=!1,this.cards[a].values=s}).catch(s=>{this.cards[a].isLoading=!1,console.error("".concat(s))});else for(let s=0;s<i.length;++s){const r=i[s];this.cards[a].values[s]=r,m.isEmpty(this.patient)||(typeof r.init=="function"&&await r.init(),typeof r.asyncValue=="function"?r.asyncValue().then(l=>{this.cards[a].values[s].value=l}).catch(l=>{this.cards[a].values[s].value="_ERROR_",console.error("".concat(l))}):typeof r.staticValue=="function"&&(this.cards[a].values[s].value=r.staticValue()))}}}},async setViralLoadStatus(){try{const e=(await T.getOrders(this.patient.getID())).reduce((a,i)=>{const s=T.getVLResults(i);return m.isEmpty(s)||s[0].date<a.date?a:s[0]},{});this.facts.hasHighViralLoad=T.isHighViralLoadResult(e)}catch(t){console.error(t)}},async findAndSetPatient(t,e){let a=null;this.isReady=!1,this.localPatient={},this.facts.scannedNpid||(this.facts.scannedNpid=e||""),this.useDDE&&e?a=this.ddeInstance.searchNpid(e):t?a=f.findByID(t):a=f.findByNpid(e),this.handleSearchResults(a).then(()=>this.isReady=!0).catch(i=>D("".concat(i),3e5))},async handleSearchResults(t){let e=[];try{e=await t}catch(a){if(a instanceof lt&&!m.isEmpty(a.entity))e=a.entity;else if(a instanceof F&&Array.isArray(a.errors)){const[i,...s]=a.errors;typeof i=="string"&&i==="Invalid parameter(s)"&&this.setInvalidParametersFacts(s)}else D("".concat(a),3e5)}if(m.isEmpty(e)&&!m.isEmpty(this.localPatient)&&(e=this.localPatient),Array.isArray(e)&&e.length>1?(this.facts.npidHasDuplicates=e.length<=5,this.facts.npidHasOverFiveDuplicates=e.length>5):this.facts.patientFound=!m.isEmpty(e),this.facts.patientFound){this.patient=new f(Array.isArray(e)?e[0]:e),this.updateCards(),I.set("ACTIVE_PATIENT",this.patient),this.setPatientFacts();const a=[];a.push(this.setProgramFacts()),this.useDDE&&a.push(this.setDDEFacts()),this.facts.programName==="ANC"&&a.push(this.setAncFacts()),this.facts.programName==="TB"&&a.push(this.setTbFacts()),this.facts.programName==="ART"&&a.push(this.setViralLoadStatus()),this.facts.currentNpid=this.patient.getNationalID(),a.push(this.validateNpid()),await Promise.all(a)}else this.facts.scannedNpid&&this.setVoidedNpidFacts(this.facts.scannedNpid);this.onEvent(v.ONLOAD).then(()=>this.isReady=!0).catch(a=>{D("".concat(a),3e5),this.isReady=!0})},async validateNpid(){if(this.useDDE)this.facts.hasInvalidNpid=!this.patient.getDocID()||this.patient.getDocID()&&k(this.patient.getNationalID());else{const t=await f.findByNpid(this.facts.currentNpid,{page_size:2});this.facts.hasInvalidNpid=Array.isArray(t)&&t.length>1}},setInvalidParametersFacts(t){this.facts.demographics.hasInvalidDemographics=!0,this.facts.demographics.invalidDemographics=t.map(e=>{const a=Object.entries(e),i=a[0][0],s=a[0][1];return[i,s.join(", ")]})},reloadPatient(){return this.findAndSetPatient(this.patient.getID(),void 0)},setPatientFacts(){this.facts.demographics.patientIsComplete=this.patient.patientIsComplete(),this.facts.demographics.patientName=this.patient.getFullName(),this.facts.demographics.givenName=this.patient.getGivenName(),this.facts.demographics.familyName=this.patient.getFamilyName(),this.facts.demographics.landmark=this.patient.getAttribute(19),this.facts.demographics.phoneNumber=this.patient.getAttribute(12),this.facts.demographics.gender=this.patient.getGender(),this.facts.demographics.birthdate=this.patient.getBirthdate(),this.facts.demographics.ancestryDistrict=this.patient.getHomeDistrict(),this.facts.demographics.ancestryTA=this.patient.getHomeTA(),this.facts.demographics.ancestryVillage=this.patient.getHomeVillage(),this.facts.demographics.currentDistrict=this.patient.getCurrentDistrict(),this.facts.demographics.currentTA=this.patient.getCurrentTA(),this.facts.demographics.currentVillage=this.patient.getCurrentVillage(),this.facts.identifiers=this.patient.getIdentifiers().map(t=>t.type.name),this.facts.hasMalawiNationalID=!/unknown/i.test(this.patient.getMWNationalID())},async setGlobalPropertyFacts(){this.facts.isMalawiNationalIDFeaturesEnabled=await I.get("IS_MW_NATIONAL_ID_SCANNER_ENABLED"),this.facts.globalProperties.ddeEnabled=await I.get("IS_DDE_ENABLED"),this.useDDE=this.facts.globalProperties.ddeEnabled,this.app.applicationName==="ART"&&(this.facts.globalProperties.useFilingNumbers=await I.get("IS_ART_FILING_NUMBER_ENABLED"))},async setAncFacts(){const t=new $(this.patient.getID(),-1);this.facts.anc.canInitiateNewPregnancy=await t.canInitiateNewPregnancy(),this.facts.anc.currentPregnancyIsOverdue=await t.pregnancyIsOverdue(),this.facts.anc.lmpMonths=await t.getLmpInMonths()},async setTbFacts(){const t=await B.generateArtStatusFromArt(this.patient.getID(),B.getSessionDate());t&&(this.facts.tb.noHivPositiveRecordInTB=!t.hivStatus._recordedStatusInTB,this.facts.tb.clientEnrolledInArtProgram=!0,this.facts.tb._artData=t)},buildDDEDiffs(t){const e=[],a={givenName:{label:"First Name",ref:"given_name"},familyName:{label:"Last Name",ref:"family_name"},birthdate:{label:"Birthdate",ref:"birthdate"},gender:{label:"Gender",ref:"gender"},phoneNumber:{label:"Phone number",ref:"phone_number"},ancestryDistrict:{label:"Home District",ref:"home_district"},ancestryTA:{label:"Home TA",ref:"home_traditional_authority"},ancestryVillage:{label:"Home Village",ref:"home_village"},currentDistrict:{label:"Current District",ref:"current_district"},currentTA:{label:"Current TA",ref:"current_traditional_authority"},currentVillage:{label:"Current Village",ref:"current_village"}};let i=0;const s={indexes:[],class:"his-empty-set-color"};for(const r in a){let l=this.facts.demographics[r],N=l;a[r].ref in t&&(s.indexes.push(i),l=t[a[r].ref].local,N=t[a[r].ref].remote),e.push([a[r].label,l,N]),++i}return{comparisons:e,rowColors:[s]}},async setProgramFacts(){this.facts.programName=this.app.applicationName;try{this.program=new dt(this.patient.getID()),this.programInfo=await this.program.getProgram(),I.set("PATIENT_PROGRAM",this.programInfo);const{program:t,outcome:e}=this.programInfo;this.facts.enrolledInProgram=!(pt(t)||t.match(/n\/a/i)),this.facts.currentOutcome=e,this.facts.userRoles=S.getUserRoles().map(i=>i.role);const a=await ut.getFirstObs(this.patient.getID(),"Type of patient");a!=null&&a.value_coded&&(this.facts.patientType=a.value_coded,this.facts.patientTypeLastUpdated=L.toStandardHisFormat(a.obs_datetime))}catch(t){console.error("".concat(t))}},async setDDEFacts(){var t;try{const e=(t=await this.ddeInstance.getLocalAndRemoteDiffs())==null?void 0:t.diff;this.facts.dde.localDiffs=this.ddeInstance.formatDiffValuesByType(e,"local");const{comparisons:a,rowColors:i}=this.buildDDEDiffs(e);if(this.facts.dde.diffRows=a,this.facts.dde.diffRowColors=i,e.npid){const{local:s,remote:r}=e.npid;this.facts.dde.localNpidDiff=s,this.facts.dde.remoteNpidDiff=r,delete e.npid}this.facts.dde.hasDemographicConflict=!m.isEmpty(e)}catch(e){console.warn(e)}},async setVoidedNpidFacts(t){const e=["Name","Birthdate","Gender","Ancestry Home","CurrentID","Action"];let a=[];const i=await this.ddeInstance.findVoidedIdentifier(t);i&&(a=i.map(s=>{const r=new f(s);return[r.getFullName(),r.getBirthdate(),r.getGender(),r.getHomeTA(),r.getNationalID(),{type:"button",name:"Select",action:async()=>{if(r.patientIsComplete()){if(r.getNationalID().match(/unknown/i)||!r.getDocID())try{return await r.assignNpid(),await this.findAndSetPatient(r.getID(),void 0),V.dismiss()}catch(l){return M("Failed to assign npid to patient with unknown npid."),console.error(l)}}else return this.$router.push("/patient/registration?edit_person=".concat(r.getID()));await V.dismiss(),await this.findAndSetPatient(void 0,r.getNationalID())}}]}),this.facts.dde.voidedNpids.cols=e,this.facts.dde.voidedNpids.rows=a)},async onEvent(t,e={}){var i,s;const a=wt(this.facts,Pt,"",t,"weight");for(const r in a){const l=a[r];if((i=l==null?void 0:l.actions)!=null&&i.alert){const N=await((s=l==null?void 0:l.actions)==null?void 0:s.alert(this.facts));if(await this.runFlowState(N)===n.FORCE_EXIT)return!1}}typeof e=="function"&&e()},async onInitiateNewAncPregnancy(){await b("Are you sure you want to initiate new pregnancy?")&&(await this.initiateNewAncPregnancy()?(this.facts.anc.canInitiateNewPregnancy=!1,this.facts.anc.currentPregnancyIsOverdue=!1,this.nextTask()):M("Unable to initiate new pregnancy"))},initiateNewAncPregnancy(){return new $(this.patient.getID(),-1).createNewPregnancyStatus()},async runFlowState(t){const e={};if(e[n.SCAN_NATIONAL_ID]=async()=>await b("Are you able to scan National ID Card / Birth certificates at your Station?")?(await c("Malawi National ID","Use your 2D barcode scanner to scan the National ID Card / Birth certificate on the Home Page to proceed","",[{name:"Go To Home Page",slot:"start",color:"primary"}]),this.$router.push("/"),n.FORCE_EXIT):(await c("Malawi National ID","Please update Missing Malawi National ID Code","",[{name:"Update Demographics Manually",slot:"start",color:"primary"}]),this.$router.push("/patient/registration?edit_person=".concat(this.patient.getID())),n.FORCE_EXIT),e[n.ALERT_TO_BRING_NATIONAL_ID_NEXT]=async()=>(await c("Malawi National ID","","Please remind the client to bring a National ID or Birth certificate on their next visit",[{name:"Understood",slot:"start",color:"success"}]),n.CONTINUE),e[n.GO_HOME]=()=>(this.$router.push("/"),n.FORCE_EXIT),e[n.GO_BACK]=()=>(this.$router.back(),n.FORCE_EXIT),e[n.ENROLL]=()=>this.program.enrollProgram(),e[n.ACTIVATE_FN]=()=>(this.$router.push("/art/filing_numbers/".concat(this.patient.getID(),"?assign=true")),n.FORCE_EXIT),e[n.UPDATE_DMG]=()=>(this.$router.push("/patient/registration?edit_person=".concat(this.patient.getID())),n.FORCE_EXIT),e[n.PRINT_NPID]=async()=>(await this.ddeInstance.printNpid(this.patient.getID()),await A(1800),n.CONTINUE),e[n.SYNCH_ART_STATUS_WITH_TB]=async()=>{const a=new G(this.patient.getID(),ht.UPDATE_HIV_STATUS,-1);await a.createEncounter(),await a.saveObservationList(Object.keys(this.facts.tb._artData).reduce((i,s)=>[...i,this.facts.tb._artData[s].obs],[]))},e[n.CREATE_NPID_WITH_REMOTE_DIFF]=async()=>{const a=this.facts.dde.remoteNpidDiff;try{if(a&&await this.ddeInstance.createNPID(a))return this.facts.scannedNpid=a,this.facts.currentNpid=a,this.facts.dde.localNpidDiff=a,H("Remote NPID successfully updated"),await A(300),await this.ddeInstance.printNpid(),await this.findAndSetPatient(void 0,a),n.FORCE_EXIT}catch(i){const s=/Identifier already assigned to another patient/i;if(i instanceof F&&i.errors.join(",").match(s)){const r=await this.ddeInstance.reassignNpid(this.patient.getDocID());if(r)return this.patient=new f(r),H("Patient has been reassigned NPID"),await A(300),await this.ddeInstance.printNpid(),await this.findAndSetPatient(void 0,this.patient.getNationalID()),n.FORCE_EXIT}D("Unable to assign NPID: ".concat(i))}},e[n.ASSIGN_NPID]=async()=>(await this.patient.assignNpid(),await mt(this.patient.getID()),await A(300),await this.reloadPatient(),n.FORCE_EXIT),e[n.INITIATE_ANC_PREGNANCY]=async()=>(await this.initiateNewAncPregnancy(),n.CONTINUE),e[n.VIEW_MERGE_AUDIT_FOR_NPID]=()=>(this.$router.push("/merge/rollback/".concat(this.facts.scannedNpid)),n.FORCE_EXIT),e[n.RESOLVE_DUPLICATE_NPIDS]=()=>(this.$router.push("/npid/duplicates/".concat(this.facts.scannedNpid)),n.FORCE_EXIT),e[n.REFRESH_DDE_DEMOGRAPHICS]=async()=>(await this.ddeInstance.refreshDemographics(),await this.reloadPatient(),n.FORCE_EXIT),e[n.ADD_AS_DRUG_REFILL]=async()=>(await this.createPatientType("Emergency supply"),n.CONTINUE),e[n.ADD_AS_NEW_PATIENT]=async()=>(await this.createPatientType("New patient"),n.CONTINUE),e[n.ADD_AS_EXTERNAL_CONSULTATION]=async()=>(await this.createPatientType("External consultation"),n.CONTINUE),e[n.SEARCH_BY_NAME]=()=>(this.$router.push("/patient/registration"),n.FORCE_EXIT),e[n.UPDATE_LOCAL_DDE_DIFFS]=async()=>(await this.ddeInstance.updateLocalDifferences(this.facts.dde.localDiffs),await this.reloadPatient(),n.FORCE_EXIT),t in e)try{return await e[t]()}catch(a){D("".concat(a))}return t},async createPatientType(t){if(t!=this.facts.patientType&&this.facts.patientTypeLastUpdated===f.getSessionDate()&&!await b('This client was flagged today as "'.concat(this.facts.patientType,'", altering patient type to "').concat(t,'" may affect record integrity, do you want to affect change?')))return;const e=new gt(this.patient.getID(),-1);await e.createEncounter(),await e.savePatientType(t)},async onVoid(){At(async t=>{try{await f.voidPatient(this.patient.getID(),t),this.$router.push("/")}catch(e){D("".concat(e))}},"void-modal")},nextTask(){this.onEvent(v.ON_CONTINUE,()=>{ft(this.patient.getID(),this.$router)})}}}),Tt={class:"tool-bar-medium-card"},bt={class:"his-sm-text"},vt={class:"his-sm-text"},Ct={class:"his-sm-text"},Rt={class:"tool-bar-medium-card"},Ot={class:"his-sm-text"},Lt={class:"his-sm-text"},St={class:"his-sm-text"},Ft={class:"tool-bar-medium-card"},Bt={class:"his-sm-text"},Vt={class:"his-sm-text"},Mt={class:"his-sm-text"};function Ht(t,e,a,i,s,r){const l=h("ion-col"),N=h("ion-row"),C=h("ion-toolbar"),x=h("ion-header"),W=h("confirmation-card"),X=h("ion-content"),w=h("ion-button"),Y=h("ion-spinner"),z=h("ion-footer"),j=h("ion-page");return y(),E(j,null,{default:d(()=>[u(x,{translucent:!0},{default:d(()=>[u(C,null,{default:d(()=>[u(N,null,{default:d(()=>[u(l,null,{default:d(()=>[o("div",Tt,[o("span",bt,[e[0]||(e[0]=p("Patient Name: ")),o("b",null,g(t.demographics.patientName),1)]),e[3]||(e[3]=p()),e[4]||(e[4]=o("p",null,null,-1)),o("span",vt,[e[1]||(e[1]=p("Birthdate: ")),o("b",null,g(t.birthdate),1)]),e[5]||(e[5]=p()),e[6]||(e[6]=o("p",null,null,-1)),o("span",Ct,[e[2]||(e[2]=p("Gender: ")),o("b",null,g(t.demographics.gender),1)])])]),_:1}),u(l,null,{default:d(()=>[o("div",Rt,[o("span",Ot,[e[7]||(e[7]=p("Ancestry district: ")),o("b",null,g(t.demographics.ancestryDistrict),1)]),e[10]||(e[10]=o("p",null,null,-1)),o("span",Lt,[e[8]||(e[8]=p("Ancestry TA: ")),o("b",null,g(t.demographics.ancestryTA),1)]),e[11]||(e[11]=o("p",null,null,-1)),o("span",St,[e[9]||(e[9]=p("Ancestry village: ")),o("b",null,g(t.demographics.ancestryVillage),1)]),e[12]||(e[12]=o("p",null,null,-1))])]),_:1}),u(l,null,{default:d(()=>[o("div",Ft,[o("span",Bt,[e[13]||(e[13]=p("Current District:")),o("b",null,g(t.demographics.currentDistrict),1),e[14]||(e[14]=o("p",null,null,-1))]),o("span",Vt,[e[15]||(e[15]=p("Current TA: ")),o("b",null,g(t.demographics.currentTA),1),e[16]||(e[16]=o("p",null,null,-1))]),o("span",Mt,[e[17]||(e[17]=p("Current Village: ")),o("b",null,g(t.demographics.currentVillage),1),e[18]||(e[18]=o("p",null,null,-1))])])]),_:1})]),_:1})]),_:1})]),_:1}),u(X,null,{default:d(()=>[u(N,null,{default:d(()=>[(y(!0),yt(Et,null,It(t.cards,(P,R)=>(y(),E(l,{"size-md":"4","size-sm":"12",key:R},{default:d(()=>[(y(),E(W,{key:"card-".concat(R),title:P.label,items:P.values,isLoading:P.isLoading},null,8,["title","items","isLoading"]))]),_:2},1024))),128))]),_:1})]),_:1}),u(z,null,{default:d(()=>[u(C,{color:"dark"},{default:d(()=>[u(w,{color:"danger",size:"large","router-link":"/"},{default:d(()=>e[19]||(e[19]=[p(" Cancel ")])),_:1}),u(w,{disabled:!t.canVoidClient,color:"danger left",size:"large",onClick:t.onVoid},{default:d(()=>e[20]||(e[20]=[p("Void Client")])),_:1},8,["disabled","onClick"]),t.facts.anc.canInitiateNewPregnancy?(y(),E(w,{key:0,slot:"end",size:"large",onClick:t.onInitiateNewAncPregnancy},{default:d(()=>e[21]||(e[21]=[p(" New Pregnancy ")])),_:1},8,["onClick"])):U("",!0),u(w,{disabled:!t.facts.patientFound||t.facts.patientFound&&!t.isReady,slot:"end",color:"success",size:"large",onClick:t.nextTask},{default:d(()=>[t.isReady?U("",!0):(y(),E(Y,{key:0,name:"crescent"})),e[22]||(e[22]=p(" Continue "))]),_:1},8,["disabled","onClick"])]),_:1})]),_:1})]),_:1})}const Gt=Dt(_t,[["render",Ht],["__scopeId","data-v-a2faf79c"]]);export{Gt as default};
