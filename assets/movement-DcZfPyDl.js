var v=Object.defineProperty;var S=(e,t,o)=>t in e?v(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var d=(e,t,o)=>(S(e,typeof t!="symbol"?t+"":t,o),o);import{d as y,bn as E,ah as u,U as D,q as g,F as l,V as n,cL as h,t as b,bs as k,cE as I,H as _,aW as T,_ as A,r as x,o as C,c as F}from"./index-C6EjxQ0a.js";import{H as R}from"./HisStandardForm-CHL0RBXf.js";import{g as $}from"./LocationFieldOptions-DprQ5-p8.js";import"./storage-CYNMGoMg.js";class p{constructor(){d(this,"BASE30_DIGITS_INDEX",{});d(this,"BASE30_DIGITS");this.BASE30_DIGITS="0123456789ABCDEFGHJKLMNPRTVWXY".split(""),this.BASE30_DIGITS.forEach((t,o)=>this.BASE30_DIGITS_INDEX[t]=o)}convertFromDecimal(t,o=30){if(o<2||o>30)throw"Invalid base ${toBase}";let a="";for(;t>0;)a=this.BASE30_DIGITS[t%o]+a,t=Math.floor(t/o);return a}static calculateLuhnCheckDigit(t){const o=t.toString().split("").map(s=>Number.parseInt(s,10)),a=o.length%2;let i=0;o.forEach((s,c)=>{c%2===a&&(s*=2),s>9&&(s-=9),i+=s});const r=i%10;return r===0?0:10-r}isValidDHACode(t){try{const o=this.convertToDecimal(t).toString();return p.calculateLuhnCheckDigit(Number.parseInt(o,10)*10)===0}catch(o){return console.error(o),!1}}convertToDecimal(t){if(t.length==0)return 0;const o=this.BASE30_DIGITS_INDEX[t[0]];if(o==null)throw"Invalid base ${fromBase} number: ${number}";return o*30**(t.length-1)+this.convertToDecimal(t.slice(1))}}const B=y({components:{HisStandardForm:R},data:()=>({activeField:"",fields:[],drugs:[],selectedDrugs:[],barcode:"",stockService:{}}),methods:{async onFinish(e){let t=[];for(const o of e.enter_batches){const a={reallocation_code:e.authorization.value,quantity:o.other.pack_size*o.other.tins,date:e.date.value,reason:o.other.reason};try{e.task.value==="Relocations"?await this.stockService.relocateItems(o.other.id,{...a,location_id:e.relocation_location.value}):await this.stockService.disposeItems(o.other.id,a)}catch(i){i instanceof E&&!u.isEmpty(i.errors)?t=t.concat(i.errors.map(r=>"".concat(r," for ").concat(o.other.drug_name))):t.push("".concat(i)),console.log(i)}}if(u.isEmpty(t))return D("Stock succesfully moved"),this.$router.push("/");g("".concat(t.join(",")))},getFields(){return[{id:"task",helpText:"Select task",type:l.TT_SELECT,validation:e=>n.required(e),options:()=>[{label:"Relocations",value:"Relocations"},{label:"Disposal",value:"Disposal"}]},{id:"relocation_location",helpText:"Destination",type:l.TT_SELECT,validation:e=>n.required(e)||n.notTheSame(e.label,"".concat(h.getLocationName())),condition:e=>e.task.value==="Relocations",options:(e,t="")=>$(t),computedValue:e=>e.label,config:{showKeyboard:!0,isFilterDataViaApi:!0}},{id:"date",dynamicHelpText:e=>"Date of ".concat(e.task.label),helpText:"Set date",type:l.TT_FULL_DATE,validation:e=>n.required(e)},{id:"select drugs",helpText:"Select drugs",type:l.TT_MULTIPLE_SELECT,requireNext:!0,validation:e=>n.required(e),options:async(e,t)=>this.getDrugs(t,e.date.value),unload:e=>this.selectedDrugs=e},{id:"enter_batches",helpText:"Batch entry",type:l.TT_BATCH_MOVEMENT,beforeNext:(e,t,o,{currentFieldContext:a})=>{const i=s=>s.map(c=>"".concat(c.label)).join(" & "),r=a.drugs.filter(s=>!s.other.tins||!s.other.reason);if(!u.isEmpty(r)){const s=i(r);return b("Please fix partial batch entries for drugs: ".concat(s)),!1}return!0},options:()=>this.selectedDrugs,validation:e=>n.required(e),config:{getReasons:this.getReasons}},{id:"authorization",helpText:"Enter authorization code",type:l.TT_TEXT,config:{customKeyboard:[k,[["Delete"]]]},validation:e=>n.validateSeries([()=>n.required(e),()=>{const t=e.value;return new p().isValidDHACode(t.toUpperCase())?null:["Invalid authorization code"]}])},{id:"summary",helpText:"Summary",type:l.TT_TABLE_VIEWER,options:e=>this.buildResults(e),config:{hiddenFooterBtns:["Clear"]}}]},buildResults(e){const t=e.task.value==="Relocations",o=["Drug","Total Tins","Expiry date","Authorization code","Reason"];t&&o.push("Relocation");const a=e.enter_batches.map(i=>{const r=[i.other.drug_name,I(i.other.tins),_.toStandardHisDisplayFormat(i.other.expiry_date),e.authorization.value.toUpperCase(),i.other.reason];return t&&r.push(e.relocation_location.label),r});return[{label:"Confirm entry",value:"Table",other:{columns:o,rows:a}}]},async getDrugs(e,t){return(await this.stockService.getItems()).map(a=>{var c,m;const i=(m=(c=a==null?void 0:a.drug_name)!=null?c:a==null?void 0:a.drug_legacy_name)!=null?m:"N/A",r=_.toStandardHisDisplayFormat(a.expiry_date),s=e.filter(f=>f.label===i).length>=1;return{label:i,value:a.drug_id,isChecked:s,description:{color:"primary",show:"always",text:"Product Code: ".concat(a.product_code," - Batch Number: ").concat(a.batch_number," - Pack Size: ").concat(a.pack_size," - Expiry date: ").concat(r)},other:{...a,tins:null,quantity:Math.trunc(a.current_quantity/a.pack_size)||0,reason:""}}}).filter(a=>!T(t).isBefore(a.other.delivery_date)&&a.other.current_quantity>0)},mapToOptions(e){return e.map(t=>({label:t,value:t}))},getReasons(e,t){var i;if(t.task.value==="Relocations")return this.mapToOptions(["Transfer to another facility/relocation","For trainings"]);const o=T((i=e.other)==null?void 0:i.expiry_date).isAfter(h.getSessionDate()),a=["Damaged","Phased out","Banned","Missing"];return o||a.push("Expired"),this.mapToOptions(a)}},created(){this.stockService=new h,this.fields=this.getFields()}});function N(e,t,o,a,i,r){const s=x("his-standard-form");return C(),F(s,{fields:e.fields,activeField:e.activeField,onFinishAction:e.onFinish,skipSummary:!0},null,8,["fields","activeField","onFinishAction"])}const V=A(B,[["render",N]]);export{V as default};
