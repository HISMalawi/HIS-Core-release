System.register(["./dynamic-import-helper-legacy-DYK5bIOV.js","./index-legacy-DaDUPm0b.js","./EncounterMixin.vue_vue_type_script_lang-legacy-BDi4Plhg.js","./MultiFieldDateHelper-legacy-DbDPqams.js","./KbLayouts-legacy-BKvPSxzZ.js","./GuidelineEngine-legacy-KsvQuFdF.js","./LocationFieldOptions-legacy-ARcld0-A.js"],(function(t,e){"use strict";var i,s,n,a,o,r,g,d,c,l,h,p,u,m;return{setters:[t=>{i=t.F},t=>{s=t.n,n=t.aR,a=t.b3,o=t.U,r=t.d,g=t.ab,d=t.V,c=t.H},t=>{l=t._},t=>{h=t.g},t=>{p=t.a},t=>{u=t.m},t=>{m=t.g}],execute:function(){const e={"Adults with stage 4 conditions":{concept:"WHO STAGE IV ADULT",priority:1,conditions:{stage:t=>4===t}},"Classify as stage 4 when reason for ART is WHO STAGE 4":{concept:"WHO STAGE IV ADULT",priority:2,conditions:{reasonForArt:t=>"WHO STAGE IV ADULT"===t}},"Adults with stage 3 conditions":{concept:"WHO STAGE III ADULT",priority:3,conditions:{stage:t=>3===t}},"Adults with stage 2 conditions":{concept:"WHO STAGE II ADULT",priority:4,conditions:{stage:t=>2===t}},"Adults with stage 1 conditions":{concept:"WHO STAGE I ADULT",priority:5,conditions:{stage:t=>1===t}}},y={"Children with stage 4 conditions":{concept:"WHO STAGE IV PEDS",priority:1,conditions:{stage:t=>4===t}},"Classify as stage 4 when reason for ART is WHO STAGE 4":{concept:"WHO STAGE IV PEDS",priority:2,conditions:{reasonForArt:t=>"WHO STAGE IV PEDS"===t}},"For children with stage 3 conditions":{concept:"WHO STAGE III PEDS",priority:3,conditions:{stage:t=>3===t}},"Children with stage 2 conditions":{concept:"WHO STAGE II PEDS",priority:4,conditions:{stage:t=>2===t}},"Children with stage 1 conditions":{concept:"WHO STAGE I PEDS",priority:5,conditions:{stage:t=>1===t}}},C={"Warn if Severe weight loss is selected when actual patient BMI is acceptable":{priority:1,actions:{alert:async t=>await s(`Patient's BMI of ${t.bmi} greater than 18.5, do you wish to proceed?`,{confirmBtnLabel:"Yes, keep severe weightloss",cancelBtnLabel:"No, cancel"})},conditions:{selectedCondition:t=>"Severe weight loss >10% and/or BMI <18.5kg/m^2, unexplained"===t,bmi:t=>t>18.5}},"Warn for contradicting stage defining conditions":{priority:1,actions:{alert:async t=>!!(await s("CONTRADICTING STAGE DEFINING CONDITIONS",{confirmBtnLabel:"Keep Asymptomatic",cancelBtnLabel:"Keep other(s)"}))&&(t.stage=1,t.selectedConditions=[],t.stageThreeConditions=[],t.stageFourConditions=[],t.stageTwoConditions=[],!0)},conditions:{selectedCondition:t=>"Asymptomatic HIV infection"===t,stage:t=>t>=2}}},w={"For children whose current weight percentile is less than 70":{priority:1,actions:{isChecked:!0},description:{color:"danger",show:"always",info:t=>`Child has a low weight percentile of ${t.weightPercentile}`},conditions:{selectedCondition:t=>"Severe unexplained wasting or malnutrition not responding to treatment (weight-for-height/ -age <70% or MUAC less than 11cm or oedema)"===t,weightPercentile:t=>t<70}},"Enable Moderate unexplained malnutrition for children whose weight for height is 70-79%":{priority:1,actions:{isChecked:!0},description:{color:"danger",show:"always",info:t=>`Child has weight percentile of ${t.weightPercentile}`},conditions:{selectedCondition:t=>"Moderate unexplained wasting/malnutrition not responding to treatment (weight-for-height/ -age 70-79% or muac 11-12 cm)"===t,weightPercentile:t=>t>=70&&t<=79}},"Disable moderate weight loss when Severe unexplained weight loss is chosen":{priority:2,actions:{isChecked:!1,disabled:!0},description:{color:"secondary",show:"always",info:()=>"Severe weight loss/manutrition was already selected"},conditions:{selectedCondition:t=>"Moderate unexplained wasting/malnutrition not responding to treatment (weight-for-height/ -age 70-79% or muac 11-12 cm)"===t,selectedConditions:t=>t.includes("Severe unexplained wasting or malnutrition not responding to treatment (weight-for-height/ -age <70% or MUAC less than 11cm or oedema)")}}},T={"Adults with a BMI less than 16":{priority:1,actions:{isChecked:!0},description:{color:"danger",show:"always",info:t=>`Adult has a low BMI of ${t.bmi}`},conditions:{selectedCondition:t=>"Severe weight loss >10% and/or BMI <18.5kg/m^2, unexplained"===t,bmi:t=>t<16}},"Adults whose BMI is between 16 and 18":{priority:3,actions:{isChecked:!0},description:{color:"warning",show:"onChecked",info:t=>`BMI of ${t.bmi} is between 16 and 18`},conditions:{selectedCondition:t=>"Moderate weight loss less than or equal to 10 percent, unexplained"===t,bmi:t=>t>=16&&t<=18.5}},"Disable Moderate weight loss if severe weightloss is selected":{priority:2,actions:{isChecked:!1,disabled:!0},description:{color:"secondary",show:"always",info:()=>"Severe weight loss was already selected"},conditions:{selectedCondition:t=>"Moderate weight loss less than or equal to 10 percent, unexplained"===t,selectedConditions:t=>t.includes("Severe weight loss >10% and/or BMI <18.5kg/m^2, unexplained")}}},b={"Children under twelve months who tested positive on Rapid test and have presumed severe HIV":{concept:"PRESUMED SEVERE HIV",priority:1,conditions:{ageInMonths:t=>t<12,selectedConditions:t=>n.getConceptsByCategory("pshd_condition").some((e=>t.includes(e.name))),testType:t=>"HIV rapid test"===t}},"Has stage 4 conditions":{concept:"WHO STAGE IV PEDS",priority:2,conditions:{stage:t=>4===t}},"Has stage 3 conditions":{concept:"WHO STAGE III PEDS",priority:3,conditions:{stage:t=>3===t}},"Children under twelve who tested positive via HIV DNA Polymerase Chain Reaction test":{concept:"HIV DNA polymerase chain reaction",priority:4,conditions:{ageInMonths:t=>t<12,testType:t=>"HIV DNA polymerase chain reaction"===t}},"Children who are less than 24 months":{concept:"HIV infected",priority:5,conditions:{ageInMonths:t=>t<24}},"Children between 24 and 56 months who have stage 2 or 1 conditions":{concept:"CD4 COUNT LESS THAN OR EQUAL TO 750",priority:6,conditions:{ageInMonths:t=>t>=24&&t<=56,cd4Date:t=>new Date(t)<=new Date("2014-04-01"),cd4:t=>t<=750,cd4Modifier:t=>"<"===t||"="===t,stage:t=>t<=2}},"Children with CD4 count less than 500 and have stage 1 and stage 2 conditions":{concept:"CD4 COUNT LESS THAN OR EQUAL TO 500",priority:7,conditions:{cd4:t=>t<=500,cd4Date:t=>new Date(t)<=new Date("2014-04-01"),cd4Modifier:t=>"<"===t||"="===t,stage:t=>t<=2}},"Children over the date 2014-04-01 who are more than five years old and have cd4 count less than 500":{concept:"CD4 COUNT LESS THAN OR EQUAL TO 500",priority:9,conditions:{cd4Date:t=>new Date(t)<=new Date("2014-04-01"),age:t=>t>5,cd4:t=>t<=500,cd4Modifier:t=>"<"===t||"="===t}},"Children over date 2014-04-01 and less than Five years old":{concept:"HIV infected",priority:10,conditions:{date:t=>t>="2014-04-01",age:t=>t<=5}},"Women who are breast feeding":{concept:"BREASTFEEDING",priority:11,conditions:{gender:t=>"F"===t,breastFeeding:t=>"Yes"===t,stage:t=>t<=2}},"Women who are pregnant":{concept:"PATIENT PREGNANT",priority:12,conditions:{gender:t=>"F"===t,pregnant:t=>"Yes"===t,stage:t=>t<=2}},"Asymptomatic patient with either stage one or stage two conditions":{concept:"Asymptomatic",priority:13,conditions:{stage:t=>t<=2}}},S={"Has stage 4 conditions":{concept:"WHO STAGE IV ADULT",priority:1,conditions:{stage:t=>4===t}},"Has HIV wasting syndrome identified in stage 3":{concept:"WHO STAGE IV ADULT",priority:2,conditions:{selectedConditions:t=>n.getConceptsByCategory("severe_hiv_wasting_syndrome").reduce(((e,i)=>t.includes(i.name)?e+1:0),0)>=2}},"Has stage 3 conditions":{concept:"WHO STAGE III ADULT",priority:3,conditions:{stage:t=>3===t}},"CD4 less than 350 for adults before 2014":{concept:"cd4 less than or equal to 350",priority:4,conditions:{cd4Date:t=>new Date(t)<=new Date("2014-04-01"),cd4:t=>t<=350,cd4Modifier:t=>"<"===t||"="===t}},"CD4 less than 250 for adults after 2014":{concept:"cd4 less than or equal to 250",priority:4,conditions:{cd4Date:t=>new Date(t)<=new Date("2014-04-01"),cd4:t=>t<=250,cd4Modifier:t=>"<"===t||"="===t}},"CD4 less than 350 for adults after 2014":{concept:"cd4 less than or equal to 350",priority:5,conditions:{cd4Date:t=>new Date(t)<=new Date("2014-04-01"),cd4:t=>t<=350,cd4Modifier:t=>"<"===t||"="===t}},"CD4 less than 500 for adults after 2014":{concept:"cd4 less than or equal to 500",priority:6,conditions:{cd4Date:t=>new Date(t)<=new Date("2014-04-01"),cd4:t=>t<=500,cd4Modifier:t=>"<"===t||"="===t}},"Women who are breast feeding":{concept:"BREASTFEEDING",priority:8,conditions:{gender:t=>"F"===t,breastFeeding:t=>"Yes"===t,stage:t=>t<=2}},"Women who are pregnant":{concept:"PATIENT PREGNANT",priority:7,conditions:{gender:t=>"F"===t,pregnant:t=>"Yes"===t,stage:t=>t<=2}},"Asymptomatic patient with either stage one or stage two conditions":{concept:"Asymptomatic",priority:9,conditions:{stage:t=>t<=2}}};class F extends a{age;confirmatoryTest;constructor(t,e,i){super(t,52,i),this.age=e,this.confirmatoryTest=null}isAdult(){return this.age>=15}isPedaid(){return this.age<=14}setAge(t){this.age=t}getFacilities(t=""){return o.getFacilities({name:t})}getConfirmatoryTestType(){return this.confirmatoryTest}cd4CountIsValid(t){try{return!!t.match(/^(=|<|>)([0-9]*)$/m)}catch(e){return!1}}getAlertGuidelines(){return C}getWhoStageGuidelines(){return this.isAdult()?e:y}getProgramEligibilityGuidelines(){return this.isAdult()?S:b}getRecommendedConditionGuidelines(){return this.isAdult()?T:w}getStagingConditions(t){const e=this.getStagingCategoryByNum(t);return a.getConceptsByCategory(e)}buildWhoStageObs(t){return this.buildValueCoded("Who stage",t)}buildWhoCriteriaObs(t){return this.buildValueCoded("Who stages criteria present",t)}buildReasonForArtObs(t){return this.buildValueCoded("Reason for ART eligibility",t)}getStagingCategoryByNum(t){switch(t){case 1:return this.isAdult()?"stage_1_conditions_adults":"stage_1_conditions_pedaids";case 2:return this.isAdult()?"stage_2_conditions_adults":"stage_2_conditions_pedaids";case 3:return this.isAdult()?"stage_3_conditions_adults":"stage_3_conditions_pedaids";case 4:return this.isAdult()?"stage_4_conditions_adults":"stage_4_conditions_pedaids";default:return""}}async loadHivConfirmatoryTestType(){const t=await a.getFirstValueCoded(this.patientID,"Confirmatory hiv test type");t&&(this.confirmatoryTest=t)}}t("_",r({mixins:[l],data:()=>({staging:{},showStagingWeightChart:!0,canShowStagingFields:!0,bmiObj:{},stagingFacts:{age:-1,bmi:-1,gender:"",stage:-1,cd4:-1,cd4Date:"",date:"",isChildBearing:!1,stageOneConditions:[],stageTwoConditions:[],stageThreeConditions:[],stageFourConditions:[],reasonForArt:"",testType:"",pregnant:"",breastFeeding:"",selectedCondition:"",selectedConditions:[],weightPercentile:-1,ageInMonths:-1,cd4Modifier:"",whoStage:""}}),watch:{ready:{handler(t){t&&(this.staging=new F(this.patient.getID(),this.patient.getAge(),this.providerID))},immediate:!0}},methods:{async initStaging(t){await this.staging.loadHivConfirmatoryTestType(),this.bmiObj=await t.getBMI(),this.stagingFacts.age=t.getAge(),this.stagingFacts.bmi=this.bmiObj.index,this.stagingFacts.date=F.getSessionDate(),this.stagingFacts.gender=t.isMale()?"M":"F",this.stagingFacts.testType=this.staging.getConfirmatoryTestType(),this.stagingFacts.ageInMonths=t.getAgeInMonths(),this.stagingFacts.isChildBearing=t.isChildBearing(),this.staging.isPedaid()&&(this.stagingFacts.weightPercentile=await t.calculateWeightPercentile())},async submitStaging(t){if(!(await this.staging.createEncounter()))throw"Unable to create staging encounter";const e=await this.resolveObs(t,"staging"),i=await Promise.all([this.buildReasonForArtObs(),this.buildWhoStageObs()]);if(!(await this.staging.saveObservationList([...e,...i])))throw"Unable to save patient observations"},async onStagingCondition({label:t}){this.stagingFacts.selectedCondition=t;const e=this.staging.getAlertGuidelines(),i=u(this.stagingFacts,e);return!!g.isEmpty(i)||(!i[0]?.actions||!i[0]?.actions.alert||!!(await(i[0]?.actions.alert(this.stagingFacts))))},getFacilities:(t="")=>m(t),updateStagingFacts(){const t=[this.stagingFacts.stageOneConditions,this.stagingFacts.stageTwoConditions,this.stagingFacts.stageThreeConditions,this.stagingFacts.stageFourConditions];this.stagingFacts.stage=t.reduce(((t,e,i)=>g.isEmpty(e)?t:i+1),0),this.stagingFacts.selectedConditions=t.reduce(((t,e)=>t.concat(e)),[])},buildReasonForArtObs(){return this.staging.buildReasonForArtObs(this.stagingFacts.reasonForArt)},buildWhoStageObs(){return this.staging.buildWhoStageObs(this.stagingFacts.whoStage)},buildStagingOptions(t,e=[]){const i=this.staging.getRecommendedConditionGuidelines();return this.staging.getStagingConditions(t).map((t=>{let s,n=!1,a=e.includes(t.name);this.stagingFacts.selectedCondition=t.name;const o=u(this.stagingFacts,i);if(!g.isEmpty(o)){const t=o[0];t?.actions?.isChecked&&(a=!0),t?.actions?.disabled&&(n=!0),s=t.description}return{label:t.name,value:t.concept_id,isChecked:a,disabled:n,description:s}}))},setWhoStage(){const t=this.staging.getWhoStageGuidelines(),e=u(this.stagingFacts,t);this.stagingFacts.whoStage=e[0]?.concept||""},setReasonForArt(){const t=this.staging.getProgramEligibilityGuidelines(),e=u(this.stagingFacts,t);this.stagingFacts.reasonForArt=e[0]?.concept||""},notAsymptomatic(t){const e=t.stage_1_conditions;if(e){const t=e.filter((t=>t.label.match(/asymptomatic/i)&&t.isChecked));return g.isEmpty(t)}return!0},hasTransferLater:t=>"has_transfer_letter"in t&&t.has_transfer_letter&&"Yes"===t.has_transfer_letter.value,hasStaging(t){return!!this.hasTransferLater(t)||this.canShowStagingFields},getStagingSummaryField(t="Summary"){return{id:"summary",helpText:t,type:i.TT_ART_STAGING_SUMMARY,condition:t=>this.hasStaging(t),onload:()=>{this.setReasonForArt(),this.setWhoStage()},options:()=>[{label:"WHO Stage",value:this.stagingFacts.whoStage,other:{type:"title-section"}},{label:"Condition on starting ART",value:this.stagingFacts.reasonForArt,other:{type:"title-section"}},...(()=>this.stagingFacts.cd4>-1?[{label:"CD4 Result",value:`${this.stagingFacts.cd4Modifier}${this.stagingFacts.cd4}`,other:{type:"title-section"}}]:[])(),...this.stagingFacts.selectedConditions.map((t=>({label:t,value:t})))],config:{title:"Selected stage defining conditions",hiddenFooterBtns:["Clear"]}}},isANCclient:()=>"ANC"===F.getSuspendedProgram(),getStagingFields(){return[{id:"pregnancy_status",helpText:"Pregnant / Breastfeeding",type:i.TT_MULTIPLE_YES_NO,validation:t=>d.anyEmpty(t),summaryMapValue:t=>({label:t.label,value:t.value}),computedValue:(t,e)=>{let i=[];return this.isANCclient()&&!this.hasTransferLater(e)&&(this.stagingFacts.pregnant="Yes",i.push(this.staging.buildValueCoded("Is patient pregnant","Yes"))),i=i.concat(t.map((t=>{const{value:e,other:i}=t,s=i.factID;return this.stagingFacts[s]=`${e}`.match(/Yes/i)?"Yes":"No",this.staging.buildValueCoded(i.concept,e)}))),{obs:i,tag:"staging"}},options:t=>{if(g.isEmpty(t.pregnancy_status)){const e=[];return this.isANCclient()&&!this.hasTransferLater(t)||e.push({label:"Pregnant?",value:"",other:{values:this.yesNoOptions(),concept:"Is patient pregnant",factID:"pregnant"}}),e.push({label:"Breastfeeding?",value:"",other:{values:this.yesNoOptions(),concept:"Is patient breast feeding",factID:"breastFeeding"}}),e}return t.pregnancy_status},condition:t=>this.hasStaging(t)&&this.stagingFacts.isChildBearing},{id:"patient_weight_chart",helpText:"Weight history",type:i.TT_WEIGHT_CHART,options:async()=>{let t=await this.patient.getWeightHistory();return t=t.map((t=>({x:c.toStandardHisDisplayFormat(t.date),y:t.weight}))),[{label:"Weight for patient",value:"Weight trail",other:{values:t,age:this.patient.getAge(),bmi:this.bmiObj}}]},config:{hiddenFooterBtns:["Clear"]},condition:t=>this.hasStaging(t)&&this.showStagingWeightChart},{id:"stage_4_conditions",helpText:"Stage 4 conditions",type:i.TT_MULTIPLE_SELECT,options:()=>this.buildStagingOptions(4,this.stagingFacts.stageFourConditions),onValue:t=>this.onStagingCondition(t),computedValue:t=>({tag:"staging",obs:t.map((t=>this.staging.buildWhoCriteriaObs(t.label)))}),unload:t=>{this.stagingFacts.stageFourConditions=t.map((t=>t.label)),this.updateStagingFacts()},onConditionFalse:()=>{this.stagingFacts.stageFourConditions=[],this.updateStagingFacts()},condition:t=>this.hasStaging(t)&&this.notAsymptomatic(t)},{id:"stage_3_conditions",helpText:"Stage 3 conditions",type:i.TT_MULTIPLE_SELECT,options:()=>this.buildStagingOptions(3,this.stagingFacts.stageThreeConditions),onValue:t=>this.onStagingCondition(t),computedValue:t=>({tag:"staging",obs:t.map((t=>this.staging.buildWhoCriteriaObs(t.label)))}),unload:t=>{this.stagingFacts.stageThreeConditions=t.map((t=>t.label)),this.updateStagingFacts()},onConditionFalse:()=>{this.stagingFacts.stageThreeConditions=[],this.updateStagingFacts()},condition:t=>this.hasStaging(t)&&this.notAsymptomatic(t)},{id:"stage_2_conditions",helpText:"Stage 2 conditions",type:i.TT_MULTIPLE_SELECT,options:()=>this.buildStagingOptions(2,this.stagingFacts.stageTwoConditions),onValue:t=>this.onStagingCondition(t),computedValue:t=>({tag:"staging",obs:t.map((t=>this.staging.buildWhoCriteriaObs(t.label)))}),unload:t=>{this.stagingFacts.stageTwoConditions=t.map((t=>t.label)),this.updateStagingFacts()},onConditionFalse:()=>{this.stagingFacts.stageTwoConditions=[],this.updateStagingFacts()},condition:t=>this.hasStaging(t)&&this.notAsymptomatic(t)},{id:"stage_1_conditions",helpText:"Stage 1 conditions",type:i.TT_MULTIPLE_SELECT,validation:t=>{if(g.isEmpty(t)&&g.isEmpty(this.stagingFacts.selectedConditions))return["Please provide atleast one staging condition"]},options:()=>this.buildStagingOptions(1,this.stagingFacts.stageOneConditions),onValue:t=>this.onStagingCondition(t),computedValue:t=>{const e=t.map((t=>t.label));return this.stagingFacts.stageOneConditions=e,this.updateStagingFacts(),{tag:"staging",obs:e.map((t=>this.staging.buildWhoCriteriaObs(t)))}},condition:t=>this.hasStaging(t)},{id:"cd4_available",helpText:"Recent CD4 count results available?",type:i.TT_SELECT,condition:t=>this.hasStaging(t),validation:t=>d.required(t),options:()=>this.yesNoOptions()},{id:"cd4_count",helpText:"CD4 Count",type:i.TT_TEXT,computedValue:t=>{const e=t.value.toString(),i=e.charAt(0),s=parseInt(e.substring(1));return{tag:"staging",modifier:i,count:s,obs:this.staging.buildValueNumber("CD4 count",s,i)}},unload:(t,e,i,s)=>{const{count:n,modifier:a}=s.cd4_count;this.stagingFacts.cd4=n,this.stagingFacts.cd4Modifier=a},onConditionFalse:()=>{this.stagingFacts.cd4=-1,this.stagingFacts.cd4Modifier=""},validation:t=>{const e=()=>this.staging.cd4CountIsValid(t.value);return this.validateSeries([()=>d.required(t),()=>e()?null:["Please start with either modifier first: >, <, or ="]])},config:{customKeyboard:[p,[["Unknown","Delete"]]]},condition:t=>this.hasStaging(t)&&"Yes"===t.cd4_available.value},...h({id:"cd4_result_date",helpText:"Cd4 Results",required:!0,minDate:()=>this.patient.getBirthdate(),maxDate:()=>this.staging.getDate(),condition:t=>this.hasStaging(t)&&"Yes"===t.cd4_available.value,estimation:{allowUnknown:!1},computeValue:(t,e)=>(this.stagingFacts.cd4Date=t,{date:t,tag:"staging",isEstimate:e,obs:this.staging.buildValueDate("Cd4 count datetime",t)})}),{id:"location",helpText:"CD4 Location",type:i.TT_SELECT,defaultValue:()=>F.getLocationName(),computedValue:({label:t})=>({tag:"staging",obs:this.staging.buildValueText("Cd4 count location",t)}),validation:t=>d.required(t),options:(t,e="")=>this.getFacilities(e),config:{showKeyboard:!0,isFilterDataViaApi:!0},condition:t=>this.hasStaging(t)&&"Yes"===t.cd4_available.value}]}}}))}}}));
