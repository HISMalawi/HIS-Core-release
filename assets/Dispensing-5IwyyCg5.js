import{d as m,aN as u,H as p,aj as o,ad as f,aw as g,am as D,W as _,aa as y,c as v,af as b,a as w}from"./index-CMZASHAR.js";import{D as S}from"./dispensation_service-DN4x_RcI.js";import{_ as k}from"./EncounterMixin.vue_vue_type_script_lang-v2aYCq6R.js";import{j as C}from"./Arrays-CufAqHE9.js";import"./drug_order_service-DwQHOfYk.js";import"./encounter_guidelines-CJXpBOk4.js";import"./GuidelineEngine-D6V1_Znr.js";import"./HisStandardForm-BCjM4-bc.js";const E=m({mixins:[k],data:()=>({dispensation:{}}),watch:{ready:{handler(e){e&&(this.dispensation=new S(this.patientID,this.providerID),this.fields=this.getFields())},immediate:!0}},methods:{saveDispensations(e){return this.dispensation.saveDispensations(this.buildDispensations(e))},buildDispensations(e){var t;if(!u.isEmpty((t=e.other)==null?void 0:t.dispenses)){let a=[];return e.other.dispenses.forEach(([s,i])=>{a=[...a,...this.dispensation.buildDispensations(e.other.order_id,s,i)]}),a}return this.dispensation.buildDispensations(e.other.order_id,parseInt(e.value.toString()),1)},async buildMedicationHistory(){return await this.dispensation.loadDrugHistory(),this.dispensation.getDrugHistory().sort((e,t)=>{const a=new Date(e.order.start_date);return new Date(t.order.start_date)-a}).map(e=>({medication:e.drug.name,date:p.toStandardHisDisplayFormat(e.order.start_date),amount:e.quantity}))},buildOrderOptions(){return this.dispensation.getCurrentOrder().map(e=>({label:e.drug.name,value:e.quantity||0,other:{order:e,drug_id:e.drug.drug_id,order_id:e.order.order_id,available_stock:this.getCumulativeStocks(e.stocks),amount_needed:this.calculateCompletePack(e),pack_sizes:this.getPackSizesRows(e.drug.drug_id,e.stocks)}}))},getCumulativeStocks(e){return e?e.reduce((t,a)=>t+a.quantity,0):"-"},getPackSizesRows(e,t){const a=(t==null?void 0:t.map(s=>[s.packSize,Math.floor(s.quantity/s.packSize)||"-",0,0]))||[];return this.dispensation.getDrugPackSizes(e).forEach(s=>{a.findIndex(([n])=>n===s)===-1&&a.push([s,"-",0,0])}),a.sort((s,i)=>s[0]-i[0])},calculateCompletePack(e){const t=parseFloat(e.amount_needed)-(e.quantity||0);return t<=0?0:this.dispensation.calcCompletePack(e,t)},isDoneDispensing(e){return e.map(t=>t.value!=0).every(Boolean)},async isValidDispensation(e){var i;const t=parseInt(e.value.toString()),a=e.other.amount_needed,s=t/a*100;if(s>110&&!await o("Are you sure you want to dispense over 110% of the prescribed pill count?")||s<100&&!await o("Are you sure you want to dispense less than 100% of the prescribe amount?"))return!1;if(this.dispensation.useDrugManagement){const n=(i=e.other)==null?void 0:i.dispenses.filter(([r])=>{var d;return(d=e.other)==null?void 0:d.pack_sizes.some(([l,c,h])=>l===r&&c==="-"&&h>0)}).map(([r])=>r);if(!u.isEmpty(n))return o("Are you sure you want to dispense drugs of ".concat(C(n)," pack size(s) that have no associated stocks available?"))}return!0},getFields(){return[{id:"dispenses",helpText:"Dispensation",type:f.TT_DISPENSATION_INPUT,init:async()=>{try{return this.dispensation.setIsDrugManagementEnabled(await g.get("IS_ART_DRUG_MANAGEMENT_ENABLED")),await this.dispensation.loadCurrentDrugOrder(),!0}catch(e){return D("Unable to load current order: ".concat(e)),!1}},onValueUpdate:async(e,t)=>e.value!=-1&&this.isDoneDispensing(t)?this.$router.push({name:"appointment"}):(e.other.amount_needed=e.other.amount_needed-(parseInt(e.value.toString())||0),e.other.amount_needed<0&&(e.other.amount_needed=0),await this.dispensation.loadCurrentDrugOrder(),this.buildOrderOptions()),onValue:async(e,t)=>e.value===-1?!await this.dispensation.voidOrder(e.other.order_id):!t&&!await this.isValidDispensation(e)?!1:await this.saveDispensations(e)?!0:(_("Unable to save dispensation"),!1),config:{isDrugManagementEnabled:()=>this.dispensation.useDrugManagement,medicationHistory:()=>this.buildMedicationHistory(),toolbarInfo:[{label:"Name",value:this.patient.getFullName()},{label:"Gender",value:this.patient.getGender()},{label:"Date Of Birth",value:p.toStandardHisDisplayFormat(this.patient.getBirthdate())}],hiddenFooterBtns:["Clear","Finish"]},options:()=>this.buildOrderOptions()}]}}});function I(e,t,a,s,i,n){const r=b("his-standard-form");return w(),v(r,{fields:e.fields,skipSummary:!0,cancelDestinationPath:e.cancelDestination},null,8,["fields","cancelDestinationPath"])}const T=y(E,[["render",I]]);export{T as default};
