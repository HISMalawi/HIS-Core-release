var h=Object.defineProperty;var m=(e,t,i)=>t in e?h(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var u=(e,t,i)=>m(e,typeof t!="symbol"?t+"":t,i);import{bW as b,aB as f,be as c,d as v,an as a,ao as n,a_ as s,bK as _,bj as y,q as o,aD as g,p as T,aw as P,am as N,a as A,ar as w,b as V}from"./index-DrAzzURJ.js";import{H as x}from"./HisStandardForm-BuN2ARUl.js";import{_ as R}from"./EncounterMixin.vue_vue_type_script_lang-Bw4PWSin.js";import"./encounter_guidelines-wbooCIhg.js";import"./GuidelineEngine-D6V1_Znr.js";class S extends b{constructor(i,r){super(i,51,r);u(this,"sitePrefix");this.sitePrefix=""}getSitePrefix(){return this.sitePrefix}async loadSitePrefix(){this.sitePrefix=await f.sitePrefix()}createArvNumber(i){return c.postJson("/patient_identifiers/",{patient_id:this.patientID,identifier_type:4,identifier:i})}buildArvNumber(i){return"".concat(this.sitePrefix,"-ARV-").concat(i)}}const E=v({mixins:[R],components:{HisStandardForm:x},data:()=>({reception:{},activeField:"",hasARVNumber:!0,suggestedNumber:"",patientType:{}}),watch:{ready:{handler(e){e&&(this.reception=new S(this.patientID,this.providerID),this.fields=this.getFields())},immediate:!0}},methods:{async onFinish(e,t){if(!await this.reception.createEncounter())return o("Unable to create encounter");const r=await this.resolveObs(t,"obs");if(!await this.reception.saveObservationList(r))return o("Unable to create Obs");if(e.capture_arv&&e.capture_arv.value==="Yes"){if(!await this.reception.createArvNumber(t.arv_number))return o("Unable to save Arv number");g.invalidate("ACTIVE_PATIENT")}if(T("Encounter created"),s.find(e.who_is_present,{value:"Yes",label:"Guardian present?"})&&s.isEmpty(await this.patient.getGuardian()))return this.$router.push("/guardian/registration/".concat(this.patientID));this.nextTask()},getFields(){return[(()=>{let e="";return{id:"who_is_present",helpText:"HIV reception",type:n.TT_MULTIPLE_YES_NO,init:async()=>(e=await this.reception.getFirstValueCoded("Patient present"),!0),beforeNext:async t=>{const i=s.find(t,{label:"Patient present?"});return(i==null?void 0:i.value)===e&&e==="No"?await P("Last visit was a Guardian Visit. The current visit requires the patient to be present. Do you want to proceed?"):!0},validation:t=>a.required(t)||a.neitherOr(t)||a.anyEmpty(t),computedValue:t=>({tag:"obs",obs:t.map(({other:i,value:r})=>this.reception.buildValueCoded(i.concept,r))}),onValueUpdate:async(t,i)=>t.map(r=>(i.label!=r.label&&i.value==="No"&&(r.value="Yes"),r)),options:t=>t.who_is_present?t.who_is_present:[{label:"Patient present?",value:"",other:{concept:"Patient Present",property:"patient_present",values:this.yesNoOptions()}},{label:"Guardian present?",value:"",other:{concept:"Guardian Present",property:"guardian_present",values:this.yesNoOptions()}}]}})(),{id:"capture_arv",helpText:"Capture ARV Number?",type:n.TT_SELECT,requireNext:!0,init:async()=>(this.patient.getPatientIdentifier(4)===""&&(this.hasARVNumber=!1),this.patientType=new _(this.patientID,this.providerID),await this.patientType.loadPatientType(),!0),condition:()=>!this.hasARVNumber&&this.patientType.getType()==="New patient",validation:e=>a.required(e),options:()=>this.yesNoOptions()},{id:"arv_number",helpText:"ART number",type:n.TT_TEXT,init:async()=>{if(await this.reception.loadSitePrefix(),!this.hasARVNumber){const e=await c.getNextSuggestedARVNumber();this.suggestedNumber=e.arv_number.replace(/^\D+|\s/g,"")}return!0},computedValue:({value:e})=>e,validation:e=>a.required(e),condition:e=>!this.hasARVNumber&&e.capture_arv.value==="Yes",defaultValue:()=>this.suggestedNumber,config:{prependValue:()=>{const e=y.getActiveApp();return e&&e.programPatientIdentifiers?e.programPatientIdentifiers["ARV Number"].prefix():""}}}]}}});function F(e,t,i,r,d,l){const p=w("his-standard-form");return V(),A(p,{fields:e.fields,activeField:e.activeField,onFinishAction:e.onFinish,skipSummary:!0,cancelDestinationPath:e.cancelDestination},null,8,["fields","activeField","onFinishAction","cancelDestinationPath"])}const q=N(E,[["render",F]]);export{q as default};
