import{d as q,di as N,aV as Y,aA as b,O as v,bz as I,ah as j,aN as G,dF as Q,as as W,ad as X,aq as F,k as Z,c$ as J,d6 as ee,d4 as te,a3 as se,U as ne,Q as ie,S as oe,a2 as ae,R as re,a1 as le,a0 as de,W as ce,aQ as ue,ac as pe,dr as he,_ as me,aR as ye,a_ as fe,a6 as be,ab as o,u as r,B as c,x as n,w as i,z as p,E as g,C as O,v as h,Z as u,G as a,H as _}from"./index-CyYd6aWW.js";const ve=q({name:"Lab-modal",props:{activities:{type:Object,required:!0},ordersToday:{type:Object},onOrderAdded:{type:Object,required:!1},testFilters:{type:Array},title:{type:String,default:""}},watch:{activities:{handler(e){e&&(this.appActivities=[...e],this.getActivities())},immediate:!0}},async created(){this.extendedLabsEnabled=await N.extendedLabEnabled(),this.canScanDBS=await N.canScanDBS()},methods:{onFilter(e){this.searchFilter=Y(e,this.searchFilter)},testAlreadyDoneToday(e){return!!(this.ordersToday||{})[e]},async onScanEIDbarcode(e){if(this.verifyingBarcode=!this.verifyingBarcode,!this.verifyingBarcode){if((await b.create({message:"Checking ".concat(e)})).present(),this.testTypes[this.activeIndex].accessionNumber=null,"".concat(e||"").length<=0){v("Barcode is required"),this.verifyingBarcode=!1,b.getTop().then(t=>t&&b.dismiss());return}try{await I.accessionNumExists(e)?v("Barcode ".concat(e," was already used")):this.testTypes[this.activeIndex].accessionNumber=e}catch(t){j("Failed to confirm barcode "+e+", Please try again later",8e3)}this.verifyingBarcode=!1,b.getTop().then(t=>t&&b.dismiss())}},async onSelectTest(e,t,l){if(this.testAlreadyDoneToday(e))return v("Test was already ordered today, please void and try again!");this.searchFilter="",this.showKeyboard=!1,this.testTypes[t].isChecked=l.target.checked,this.testTypes[t].isChecked?(this.activeIndex=t,await this.setSpecimens(t)):this.removeOrder(t)},async setSpecimens(e){this.specimens=await I.getSpecimens(this.testTypes[e].name)},async getActivities(){const e=await I.getTestTypes(),t=G.findIndex(e,{name:"HIV viral load"}),l=t!==-1?e.splice(t,1):null,m=e.sort((d,y)=>"".concat(d.name).toUpperCase()>"".concat(y.name).toUpperCase()?1:-1).filter(d=>Array.isArray(this.testFilters)?this.testFilters.includes(d.name):!0);this.testTypes=(l?[...l,...m]:m).map((d,y)=>({...d,id:y}))},async removeOrder(e){this.testTypes[e].isChecked=!1,this.testTypes[e].reason=null,this.testTypes[e].specimen=null,this.testTypes[e].specimenConcept=null,this.testTypes[e].accessionNumber=null;const t=this.finalOrders.reverse();t[0]?(this.activeIndex=t[0].id,await this.setSpecimens(this.activeIndex)):(this.activeIndex=null,this.specimens=[])},addSpecimen(e){this.testTypes[this.activeIndex].specimenConcept=e.concept_id},async postActivities(){this.isPostingOrder=!0;try{const e="".concat(this.$route.params.patient_id),l=await new Q(parseInt(e),-1).createEncounter();if(l){const m=await I.buildLabOrders(l,this.finalOrders),d=await I.saveOrdersArray(l.encounter_id,m);if(!d)return v("Unable to save lab orders");W.invalidate("PATIENT_LAB_ORDERS");const k=this.finalOrders.some(f=>!f.accessionNumber)&&await X("Lab orders and encounter created!, print out your last orders?",{confirmBtnLabel:"Yes",cancelBtnLabel:"No"});typeof this.onOrderAdded=="function"&&this.finalOrders.forEach(f=>this.onOrderAdded&&this.onOrderAdded(f.name)),k&&await this.printOrders(d),await this.closeModal(d)}}catch(e){v("Unable to save order: ".concat(e))}this.isPostingOrder=!1},async closeModal(e){await F.dismiss(e)},async printOrders(e){const t=this.finalOrders.map(l=>"".concat(l.accessionNumber).toUpperCase());for(const l of e)t.includes("".concat(l.accession_number).toUpperCase())||await Z(l.order_id);await F.dismiss(e)}},computed:{searchIcon(){return J},searchColor(){return this.showKeyboard?"primary":"dark"},testTypesOnDisplay(){return this.searchFilter?new ee(this.testTypes,{threshold:.3,keys:["name"],useExtendedSearch:!0}).search(this.searchFilter).map(t=>t.item):this.testTypes},dbsBarcodeActivated(){var e,t;return this.canScanDBS&&/dbs|plasma/i.test("".concat((e=this.testTypes[this.activeIndex])==null?void 0:e.specimen))&&/hiv viral load/i.test("".concat((t=this.testTypes[this.activeIndex])==null?void 0:t.name))},isOrderComplete(){return typeof this.activeIndex!="number"||this.dbsBarcodeActivated&&/dbs/i.test(this.testTypes[this.activeIndex].specimen)&&!this.testTypes[this.activeIndex].accessionNumber?!1:this.extendedLabsEnabled?!!this.testTypes[this.activeIndex].reason:(this.testTypes[this.activeIndex].specimenConcept||this.testTypes[this.activeIndex].specimen)&&this.testTypes[this.activeIndex].reason},selectedOrders(){return this.testTypes.filter(e=>e.isChecked===!0)},finalOrders(){return this.selectedOrders.filter(e=>this.dbsBarcodeActivated&&/dbs/i.test(e.specimen)&&!e.accessionNumber?!1:e.reason&&(e.specimen&&!this.extendedLabsEnabled||this.extendedLabsEnabled))},testReasons(){let e=this.reasons;return this.testTypes[this.activeIndex].name.match(/Viral load/i)&&(e=e.filter(t=>t!=="Stat"),e=e.concat(["Follow up after Low Level Viremia","Follow up after High Viral Load"])),e}},mounted(){this.getActivities()},data(){return{isPostingOrder:!1,searchFilter:"",showKeyboard:!1,keyboardLayout:te,canScanDBS:!1,verifyingBarcode:!1,content:"Content",extendedLabsEnabled:!1,appActivities:[],testTypes:[],specimens:[],reasons:["Routine","Targeted","Confirmatory","Stat","Repeat / Missing"],activeIndex:null}},components:{IonButton:se,IonContent:ne,IonHeader:ie,IonTitle:oe,IonInput:ae,IonToolbar:re,IonLabel:le,IonList:de,IonItem:ce,BarcodeInput:ue,IonCheckbox:pe,IonRadioGroup:he,IonRow:me,HisKeyboard:ye,IonIcon:fe}}),Ie={key:0},ge={key:1},Te={class:"ion-margin-bottom"},Oe={key:1},_e={class:"his-md-text side-title"},ke={style:{background:"lightyellow",height:"34vh"}},Ce={class:"his-sm-text"};function we(e,t,l,m,d,y){const k=o("ion-title"),f=o("ion-icon"),D=o("ion-input"),A=o("ion-toolbar"),P=o("ion-header"),C=o("ion-label"),V=o("ion-checkbox"),w=o("ion-item"),B=o("ion-list"),L=o("ion-col"),$=o("ion-radio"),E=o("ion-radio-group"),R=o("ion-text"),K=o("BarcodeInput"),S=o("ion-button"),U=o("ion-row"),x=o("ion-grid"),z=o("his-keyboard"),H=o("ion-content"),M=o("ion-footer");return r(),c(g,null,[n(P,null,{default:i(()=>[n(A,null,{default:i(()=>[n(k,{class:"his-lg-text",slot:"start"},{default:i(()=>t[5]||(t[5]=[p(" Lab orders ")])),_:1}),n(f,{size:"large",slot:"end",icon:e.searchIcon,color:e.searchColor},null,8,["icon","color"]),n(D,{readonly:!0,value:e.searchFilter,disabled:e.activeIndex&&!e.isOrderComplete,color:e.searchColor,onClick:t[0]||(t[0]=()=>e.showKeyboard=!e.showKeyboard),placeholder:"Search for tests",style:{"text-align":"left",width:"35%"},class:"input_display",slot:"end"},null,8,["value","disabled","color"])]),_:1})]),_:1}),n(H,{style:{overflow:"hidden",background:"grey",height:"70vh"}},{default:i(()=>[n(x,null,{default:i(()=>[n(U,null,{default:i(()=>[n(L,{size:"6"},{default:i(()=>[n(B,{style:{overflowY:"auto",height:"75vh"}},{default:i(()=>[(r(!0),c(g,null,O(e.testTypesOnDisplay,s=>(r(),h(w,{class:"his-sm-text",key:s.id,color:e.activeIndex===s.id?"primary":"none",disabled:e.activeIndex!=null&&e.activeIndex!==s.id&&!e.isOrderComplete,detail:""},{default:i(()=>[n(C,{"text-wrap":""},{default:i(()=>[e.testAlreadyDoneToday(s.name)?(r(),c("s",Ie,u(s.name),1)):(r(),c("span",ge,u(s.name),1))]),_:2},1024),n(V,{slot:"start",checked:s.isChecked,onIonChange:T=>e.onSelectTest(s.name,s.id,T)},null,8,["checked","onIonChange"])]),_:2},1032,["color","disabled"]))),128))]),_:1})]),_:1}),e.activeIndex!=null&&e.selectedOrders.length>0?(r(),h(L,{key:0,style:{overflowY:"auto",height:"79vh"}},{default:i(()=>[a("div",Te,[e.extendedLabsEnabled?_("",!0):(r(),h(B,{key:0},{default:i(()=>[n(E,{modelValue:e.testTypes[e.activeIndex].specimen,"onUpdate:modelValue":t[1]||(t[1]=s=>e.testTypes[e.activeIndex].specimen=s)},{default:i(()=>[t[6]||(t[6]=a("div",{class:"his-md-text side-title"}," Select specimen ",-1)),(r(!0),c(g,null,O(e.specimens,s=>(r(),h(w,{key:s},{default:i(()=>[n(C,null,{default:i(()=>[p(u(s.name),1)]),_:2},1024),n($,{slot:"start",value:s.name,onClick:T=>e.addSpecimen(s)},null,8,["value","onClick"])]),_:2},1024))),128))]),_:1},8,["modelValue"])]),_:1})),e.dbsBarcodeActivated?(r(),c("div",Oe,[a("div",_e,[t[7]||(t[7]=p(" Barcode ID: ")),n(R,{color:e.testTypes[e.activeIndex].accessionNumber?"success":"dark"},{default:i(()=>[a("b",null,u(e.testTypes[e.activeIndex].accessionNumber||"None"),1)]),_:1},8,["color"])]),n(K,{size:"small",onOnScan:t[2]||(t[2]=s=>e.onScanEIDbarcode(s))})])):_("",!0),n(E,{modelValue:e.testTypes[e.activeIndex].reason,"onUpdate:modelValue":t[3]||(t[3]=s=>e.testTypes[e.activeIndex].reason=s)},{default:i(()=>[t[8]||(t[8]=a("div",{class:"his-md-text side-title"}," Main test(s) reason ",-1)),(r(!0),c(g,null,O(e.testReasons,s=>(r(),h(w,{class:"his-sm-text",key:s},{default:i(()=>[n(C,null,{default:i(()=>[p(u(s),1)]),_:2},1024),n($,{slot:"start",value:s},null,8,["value"])]),_:2},1024))),128))]),_:1},8,["modelValue"])]),a("div",ke,[a("table",Ce,[t[10]||(t[10]=a("thead",null,[a("tr",null,[a("th",null,"Test"),a("th",null,"Specimen"),a("th",null,"Reason"),a("th",null,"Action")])],-1)),a("tbody",null,[(r(!0),c(g,null,O(e.finalOrders,(s,T)=>(r(),c("tr",{key:T},[a("td",null,u(s.name),1),a("td",null,u(s.specimen||"N/A"),1),a("td",null,u(s.reason),1),a("td",null,[n(S,{onClick:Se=>e.removeOrder(s.id),slot:"end",color:"danger"},{default:i(()=>t[9]||(t[9]=[p("X")])),_:2},1032,["onClick"])])]))),128))])])])]),_:1})):_("",!0)]),_:1})]),_:1}),e.showKeyboard?(r(),h(z,{key:0,kbConfig:e.keyboardLayout,onKeyPress:e.onFilter,disabled:!1},null,8,["kbConfig","onKeyPress"])):_("",!0)]),_:1}),n(M,null,{default:i(()=>[n(A,null,{default:i(()=>[n(S,{onClick:e.postActivities,size:"large",slot:"end",disabled:e.isPostingOrder||e.finalOrders.length===0},{default:i(()=>t[11]||(t[11]=[p(" Place orders ")])),_:1},8,["onClick","disabled"]),n(S,{disabled:e.isPostingOrder,onClick:t[4]||(t[4]=s=>e.closeModal([])),size:"large",slot:"start",color:"danger"},{default:i(()=>t[12]||(t[12]=[p(" Close ")])),_:1},8,["disabled"])]),_:1})]),_:1})],64)}const Be=be(ve,[["render",we],["__scopeId","data-v-1be65671"]]);export{Be as L};
