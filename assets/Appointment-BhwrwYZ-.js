import{d as f,r as g,bS as v,bX as I,ad as D,ab as E,e4 as S,ae as w,e0 as p,ck as u,a as h,c as y,w as P,b as A,u as c,bW as N,bA as F,e1 as k,W as C,e8 as M,I as O}from"./index-BsVOoHAl.js";import{H as V}from"./HisStandardForm-E_D9nYQa.js";import{u as L}from"./useEncounter-CSSIFh8Z.js";import{r as R}from"./commons-zyUtAZg8.js";import{A as d}from"./appointment_service-dgZaP2G2.js";import"./isEmpty-FwhKJTM4.js";import"./encounter_guidelines-Dn8XjHDN.js";import"./GuidelineEngine-D6V1_Znr.js";const K=f({__name:"Appointment",setup($){const s=g([]),e=new v(-1,I.APPOINTMENT);let m=0;const{goToNextTask:_,patientDashboardUrl:T}=L((r,o)=>{e.patientID=o,e.providerID=r,m=o;const i=()=>{let a={},l=-1;const n={};return{id:"appointment",helpText:"Appointment booking",type:D.TT_DATE_PICKER,init:async()=>(l=await E.get(S.CLINIC_APPOINTMENT_LIMIT),a=await d.getJson("programs/".concat(e.programID,"/patients/").concat(o,"/next_appointment_date"),{date:e.date}),!0),defaultValue:()=>a==null?void 0:a.appointment_date,validation:t=>w.required(t),computedValue:t=>[{concept_id:p("APPOINTMENT_DATE"),value_datetime:t,obs_datetime:e.date},{concept_id:p("ESTIMATED_DATE"),value_datetime:a==null?void 0:a.appointment_date,obs_datetime:e.date}],config:{minDate:()=>e.date,maxDate:()=>a==null?void 0:a.drugs_run_out_date,supValue:t=>"".concat((n[t]||[]).length),infoItems:async t=>(n[t]||(n[t]=await d.getJson("programs/".concat(e.programID,"/booked_appointments"),{date:t,paginate:!1})),[{label:"Medication Run out Date",value:u((a==null?void 0:a.drugs_run_out_date)||"Not available")},{label:"User set appointment date",value:u(t)},{label:"Appointments",value:(n[t]||[]).length},{label:"Appointment limit (per/day)",value:l||"N/A"}]),hiddenFooterBtns:["Clear"]}}};s.value=[i()]});async function b(r,o){if(await e.createEncounter(),await e.saveObservationList(await R(o)),await N.shouldTransferToExternalFacility(e.patientID)){const i=new F(e.patientID);i.setStateDate(e.date),i.setStateId(k.TRANSFER_OUT);try{await i.updateState()}catch(a){C("Failed to transfer out patient, please do it manually for now."),console.error(a)}}await M(e.patientID),_()}return(r,o)=>(h(),y(c(O),null,{default:P(()=>[A(V,{cancelDestinationPath:c(T),onFinishAction:b,fields:s.value,skipSummary:!0},null,8,["cancelDestinationPath","fields"])]),_:1}))}});export{K as default};
