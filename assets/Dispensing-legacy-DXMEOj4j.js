System.register(["./index-legacy-CA6M7ipO.js","./dispensation_service-legacy-DDFX_tp1.js","./EncounterMixin.vue_vue_type_script_lang-legacy-qUwf12Yn.js","./Arrays-legacy-K5SD4h1d.js","./drug_order_service-legacy-3VUXkHbj.js","./encounter_guidelines-legacy-Bcz_Mw7r.js","./GuidelineEngine-legacy-KsvQuFdF.js","./HisStandardForm-legacy-a9YJRGaH.js"],(function(e,t){"use strict";var i,s,a,n,r,o,d,u,l,p,c,h,g,m,y;return{setters:[e=>{i=e.d,s=e.aN,a=e.H,n=e.aj,r=e.ad,o=e.aw,d=e.am,u=e.W,l=e.aa,p=e.c,c=e.af,h=e.a},e=>{g=e.D},e=>{m=e._},e=>{y=e.j},null,null,null,null],execute:function(){const t=i({mixins:[m],data:()=>({dispensation:{}}),watch:{ready:{handler(e){e&&(this.dispensation=new g(this.patientID,this.providerID),this.fields=this.getFields())},immediate:!0}},methods:{saveDispensations(e){return this.dispensation.saveDispensations(this.buildDispensations(e))},buildDispensations(e){if(!s.isEmpty(e.other?.dispenses)){let t=[];return e.other.dispenses.forEach((([i,s])=>{t=[...t,...this.dispensation.buildDispensations(e.other.order_id,i,s)]})),t}return this.dispensation.buildDispensations(e.other.order_id,parseInt(e.value.toString()),1)},async buildMedicationHistory(){return await this.dispensation.loadDrugHistory(),this.dispensation.getDrugHistory().sort(((e,t)=>{const i=new Date(e.order.start_date);return new Date(t.order.start_date)-i})).map((e=>({medication:e.drug.name,date:a.toStandardHisDisplayFormat(e.order.start_date),amount:e.quantity})))},buildOrderOptions(){return this.dispensation.getCurrentOrder().map((e=>({label:e.drug.name,value:e.quantity||0,other:{order:e,drug_id:e.drug.drug_id,order_id:e.order.order_id,available_stock:this.getCumulativeStocks(e.stocks),amount_needed:this.calculateCompletePack(e),pack_sizes:this.getPackSizesRows(e.drug.drug_id,e.stocks)}})))},getCumulativeStocks:e=>e?e.reduce(((e,t)=>e+t.quantity),0):"-",getPackSizesRows(e,t){const i=t?.map((e=>[e.packSize,Math.floor(e.quantity/e.packSize)||"-",0,0]))||[];return this.dispensation.getDrugPackSizes(e).forEach((e=>{-1===i.findIndex((([t])=>t===e))&&i.push([e,"-",0,0])})),i.sort(((e,t)=>e[0]-t[0]))},calculateCompletePack(e){const t=parseFloat(e.amount_needed)-(e.quantity||0);return t<=0?0:this.dispensation.calcCompletePack(e,t)},isDoneDispensing:e=>e.map((e=>0!=e.value)).every(Boolean),async isValidDispensation(e){const t=parseInt(e.value.toString())/e.other.amount_needed*100;if(t>110&&!(await n("Are you sure you want to dispense over 110% of the prescribed pill count?")))return!1;if(t<100&&!(await n("Are you sure you want to dispense less than 100% of the prescribe amount?")))return!1;if(this.dispensation.useDrugManagement){const t=e.other?.dispenses.filter((([t])=>e.other?.pack_sizes.some((([e,i,s])=>e===t&&"-"===i&&s>0)))).map((([e])=>e));if(!s.isEmpty(t))return n(`Are you sure you want to dispense drugs of ${y(t)} pack size(s) that have no associated stocks available?`)}return!0},getFields(){return[{id:"dispenses",helpText:"Dispensation",type:r.TT_DISPENSATION_INPUT,init:async()=>{try{return this.dispensation.setIsDrugManagementEnabled(await o.get("IS_ART_DRUG_MANAGEMENT_ENABLED")),await this.dispensation.loadCurrentDrugOrder(),!0}catch(e){return d(`Unable to load current order: ${e}`),!1}},onValueUpdate:async(e,t)=>-1!=e.value&&this.isDoneDispensing(t)?this.$router.push({name:"appointment"}):(e.other.amount_needed=e.other.amount_needed-(parseInt(e.value.toString())||0),e.other.amount_needed<0&&(e.other.amount_needed=0),await this.dispensation.loadCurrentDrugOrder(),this.buildOrderOptions()),onValue:async(e,t)=>-1===e.value?!(await this.dispensation.voidOrder(e.other.order_id)):!(!t&&!(await this.isValidDispensation(e)))&&(!!(await this.saveDispensations(e))||(u("Unable to save dispensation"),!1)),config:{isDrugManagementEnabled:()=>this.dispensation.useDrugManagement,medicationHistory:()=>this.buildMedicationHistory(),toolbarInfo:[{label:"Name",value:this.patient.getFullName()},{label:"Gender",value:this.patient.getGender()},{label:"Date Of Birth",value:a.toStandardHisDisplayFormat(this.patient.getBirthdate())}],hiddenFooterBtns:["Clear","Finish"]},options:()=>this.buildOrderOptions()}]}}});e("default",l(t,[["render",function(e,t,i,s,a,n){const r=c("his-standard-form");return h(),p(r,{fields:e.fields,skipSummary:!0,cancelDestinationPath:e.cancelDestination},null,8,["fields","cancelDestinationPath"])}]]))}}}));
