System.register(["./index-legacy-CNl53g3A.js","./drug_order_service-legacy-Bjt717AT.js","./drug_service-legacy-CYrzCqqJ.js","./drug_prescription_service-legacy-DfLqgUQA.js","./HisStandardForm-legacy-63OQYjIo.js","./useEncounter-legacy-Cg82F7Lh.js","./isEmpty-legacy-C49fv8op.js","./encounter_guidelines-legacy-BQOW7FSb.js","./GuidelineEngine-legacy-KsvQuFdF.js"],(function(e,a){"use strict";var t,r,n,i,s,o,u,l,d,c,g,p,y,h,m,_,f,D,b,v,T,w,E,q,x;return{setters:[e=>{t=e.bH,r=e.br,n=e.d,i=e.r,s=e.a9,o=e.aa,u=e.aJ,l=e.u,d=e.v,c=e.w,g=e.x,p=e.y,y=e.du,h=e.b,m=e.ag,_=e.ay,f=e.aq,D=e.a5,b=e.ad},e=>{v=e.D},e=>{T=e.D},e=>{w=e.D,E=e.A},e=>{q=e.H},e=>{x=e.u},null,null,null],execute:function(){class a extends t{static getDrugs;constructor(e,a){super(e,25,a)}async loadDrugs(e="",a=1,t=10){return(await T.getDrugs({name:e,page:a,page_size:t,concept_set:"OPD Medication"})).map((e=>({label:e.name,value:e.name,other:e})))}async getDrugs(e="",a=1,t=10){return(await T.getDrugs({name:e,page:a,page_size:t,concept_set:"OPD Medication"})).map((e=>({label:e.name,value:e.name,other:e})))}async hasMalaria(){const e=await r.getLatestMalariaTestResult(this.patientID);return"No"===e?!!(await t.getAllValueCoded(this.patientID,"Primary diagnosis")).includes("Malaria")||!!(await t.getAllValueCoded(this.patientID,"Secondary diagnosis")).includes("Malaria"):"Positive"===e}createDrugOrder(e){return v.create({encounter_id:this.encounterID,drug_orders:e})}}e("default",n({__name:"DrugPrescription",setup(e){const t=i([]);let r,n;const{goToNextTask:v}=x(((e,i)=>{n=new a(i,e),t.value=[{id:"drug_selection",helpText:"Select the drugs to be prescribed",type:s.TT_INFINITE_SCROLL_MULTIPLE_SELECT,onload:e=>r=e,validation:e=>o.required(e),options:async(e,a="",t=1,r=10)=>n.getDrugs(a,t,r),onValueUpdate:async e=>{for(let t=0;t<e.length;t++)if(e[t].isChecked&&!((a=e[t].other).dosage&&a.frequency&&a.duration)){const a=await P(e[t]);u.isEmpty(a)?e.splice(t,1):(e[t].other={...e[t].other,...a},r.filter="",r.selected="")}var a;return e},config:{isFilterDataViaApi:!0,showKeyboard:!0,footerBtns:[{name:"Predefined Malaria Drugs",color:"primary",size:"large",visible:!1,slot:"end",onClick:S}]}},{id:"summary",helpText:"Prescribed Drugs",type:s.TT_TABLE_VIEWER,options:e=>{const a=e.drug_selection.map((e=>[e.label,e.other.dosage,w.find((a=>a.code===e.other.frequency))?.label,e.other.duration]));return[{label:"Prescribed Drugs",value:"",other:{columns:["Drug","Dosage","Frequency","Duration"],rows:a}}]}}]}));async function T(e){const t=function(e){const t=a.getSessionDate();return e.map((e=>{const a=w.find((a=>a.code===e.other.frequency));return{drug_inventory_id:e.other.drug_id,equivalent_daily_dose:"Unknown"==e.other.dosage?0:e.other.dosage*a?.value||0,start_date:t,auto_expire_date:I(t,e.other.duration),units:e.other.units,instructions:`${e.label}: ${e.other.dosage} ${e.other.units} ${a?.code||""} for ${e.other.duration} days`,dose:e.other.dosage,frequency:a?.code||""}}))}(e.drug_selection);try{await n.createEncounter(),await n.createDrugOrder(t),await y.isSummaryPrintingEnabled()&&h(n.patientID),v()}catch(r){console.error(r)}}function I(e,a){const t=new Date(e);return t.setDate(t.getDate()+parseInt(a)),m.toStandardHisFormat(t)}async function S(){await async function(){return await n.hasMalaria()||b("Patient has no malaria. Do you still want to prescribe anti malaria drugs?")}()&&await _([{id:"malaria_drug",helpText:"Select the malaria drug to be prescribed",type:s.TT_SELECT,validation:e=>o.required(e),options:()=>E.map((e=>({value:e.name,label:e.name,other:{...e,dosage:e.dose_strength,frequency:w.find((a=>a.value===e.frequency))?.code}})))}],(async e=>{r.checkedItems.push({...e.malaria_drug,isChecked:!0}),await f.dismiss()}))}async function P(e){return new Promise((a=>{_([{id:"frequency",helpText:`Select the frequency for ${e.label}`,type:s.TT_SELECT,requireNext:!1,validation:e=>o.required(e),computedValue:e=>e.value,options:()=>w.map((e=>({value:e.code,label:e.label,other:e})))},{id:"dosage",helpText:`Enter the dosage for ${e.label}`,type:s.TT_NUMBER,defaultValue:()=>e.other.dose_strength,validation:e=>o.required(e),computedValue:e=>Number(e.value)},{id:"duration",helpText:`Enter the duration for ${e.label}`,type:s.TT_NUMBER,validation:e=>o.required(e),computedValue:e=>Number(e.value)}],(async(e,t)=>{await f.dismiss(),a(t)}),(()=>a({})))}))}return(e,a)=>(l(),d(p(D),null,{default:c((()=>[g(q,{"skip-summary":"",fields:t.value,onFinishAction:T},null,8,["fields"])])),_:1}))}}))}}}));
