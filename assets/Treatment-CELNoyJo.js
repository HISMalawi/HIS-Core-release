import{d as L,r as v,bQ as p,bV as V,ad as d,d$ as l,aW as M,ae as c,a as q,c as H,w as U,b as $,u as D,bC as k,bJ as B,bU as y,I as Y}from"./index-CMZASHAR.js";import{H as J}from"./HisStandardForm-BCjM4-bc.js";import{u as G}from"./useEncounter-CsCeua2V.js";import{m as W,r as j}from"./commons-Bp7XBfaW.js";import"./isEmpty-DjKeGqZh.js";import"./encounter_guidelines-CJXpBOk4.js";import"./GuidelineEngine-D6V1_Znr.js";const ne=L({__name:"Treatment",setup(z){const T=v(""),b=v([]),n=new p(-1,V.TREATMENT),h=v("standard"),u=v();function E(i){var r,o;return[...Array.isArray(i.selectedDrugs)?i.selectedDrugs.map(_=>_.other):[i.selectedDrugs.other],...(r=i.mdrSupplements)!=null&&r.value&&((o=i.mdrSupplements)==null?void 0:o.value)!="NONE"?[i.mdrSupplements.other]:[]]}const{goToNextTask:S,patientDashboardUrl:O,facts:N}=G((i,r)=>{n.patientID=r,n.providerID=i;const o=()=>{let t=[];return{id:"regimenShortCode",helpText:"DR regimen",type:d.TT_DR_PRESCRIPTION_INPUT,proxyID:"selectedDrugs",dynamicHelpText:()=>u.value.regimen_title,computedValue:e=>e.map(a=>({concept_id:l("MEDICAL_ORDERS"),value_coded:a.value,obs_datetime:n.date})),beforeNext:async e=>{if(!e.every(s=>!!s.other)){const s=e.filter(m=>!m.other).map(m=>m.label);return await M("System ERROR","Please report this issue to resume using the system:","Some drugs are missing weight band information: ".concat(s),[{name:"Ok",slot:"start",color:"danger"}]),!1}return!0},init:async()=>{var e,a;if(u.value=await p.getJson("mdr/regimen/status",{patient_id:n.patientID,program_id:n.programID,date:n.date}),(e=u.value)!=null&&e.mdr_status&&(((a=u.value)==null?void 0:a.regimen_drugs)||[]).length){const s=u.value.regimen_drugs.reduce((m,g)=>({...m,[g.abbreviation]:g}),{});t=u.value.regimen_composition.split("-").reduce((m,g)=>[...m,{label:g,value:g.split("/")[0],other:g.split("/").map(F=>s[F])}],[])}return!0},condition:()=>u.value.mdr_status,options:()=>t}},_=()=>{let t=[];return{id:"regimens",helpText:"Recommended regimens (weight-band adjusted):",type:d.TT_SELECT,requireNext:!1,proxyID:"selectedDrugs",init:async()=>(t=(await p.getJson("programs/".concat(n.programID,"/regimens"),{patient_id:r,date:n.date})).map(a=>({label:a.drug.name,value:a.drug_id,other:a})),!0),computedValue:e=>{var a,s;return[{concept_id:l("MEDICAL_ORDERS"),value_coded:(s=(a=e==null?void 0:e.other)==null?void 0:a.drug)==null?void 0:s.concept_id,obs_datetime:n.date}]},onload:()=>h.value="standard",validation:e=>c.required(e),condition:()=>{var e;return!((e=u.value)!=null&&e.mdr_status)},options:()=>t,config:{hiddenFooterBtns:["Back"],footerBtns:[{name:"Custom Regimen",slot:"end",onClick:()=>{h.value="custom",T.value="customRegimen"}}]}}},R=()=>{let t=[];return{id:"customRegimen",helpText:"Custom regimens:",type:d.TT_MULTIPLE_SELECT,proxyID:"selectedDrugs",validation:e=>c.required(e),condition:()=>h.value==="custom",computedValue:e=>e.map(a=>({concept_id:l("MEDICAL_ORDERS"),value_coded:a.other.drug.concept_id,obs_datetime:n.date})),options:async()=>(t.length||(t=(await p.getJson("programs/".concat(n.programID,"/custom_tb_ingredients"),{patient_id:r})).map(a=>({label:a.drug.name,value:a.drug_id,other:a}))),t)}},A=()=>{let t=[];return{id:"mdrSupplements",helpText:"Supplements:",requireNext:!0,type:d.TT_SELECT,init:async()=>{try{t=(await p.getJson("programs/".concat(n.programID,"/tb_regimen_group"),{patient:r,regimen_group:"secondline-supplements"})).map(a=>({label:a.drug.name,value:a.drug_id,other:a}))}catch(e){console.error(e)}return!0},computedValue:e=>{if(e.value!="NONE")return{concept_id:l("MEDICAL_ORDERS"),value_coded:e.other.drug.concept_id,obs_datetime:n.date}},validation:e=>c.required(e),condition:e=>e.regimenShortCode.length>=1,options:()=>[{label:"NONE",value:"NONE"},...t]}},I=()=>({id:"drugsView",helpText:"Dosages:",type:d.TT_TABLE_VIEWER,options:t=>[{label:"",value:"",other:{columns:["Name","AM","NOON","PM"],rows:E(t).map(e=>{var a;return[e.name||((a=e==null?void 0:e.drug)==null?void 0:a.name),e.am_dose,e.noon_dose,e.pm_dose]})}}]}),x=()=>({id:"recommendedNumberOfDays",helpText:"Duration of Drug Supply in Days:",type:d.TT_SELECT,validation:t=>c.required(t),computedValue:t=>{if(t.value!="Other")return{concept_id:l("REGIMEN_SUPPLY_DAYS"),value_numeric:parseInt("".concat(t.value)),obs_datetime:n.date}},options:()=>[{value:1,label:"1"},{value:2,label:"2"},{value:3,label:"3"},{value:14,label:"14"},{value:28,label:"28"},{value:56,label:"56"},{value:84,label:"84"},{value:"Other",label:"Other"}],requireNext:!1}),C=()=>({id:"otherDays",helpText:"Custom Duration of Drug Supply in Days:",type:d.TT_NUMBER,computedValue:t=>({concept_id:l("REGIMEN_SUPPLY_DAYS"),value_numeric:parseInt("".concat(t.value)),obs_datetime:n.date}),validation:t=>c.required(t),condition:t=>t.recommendedNumberOfDays.value==="Other"}),P=()=>({id:"dot",helpText:"DOT and Adherence Support Technique",type:d.TT_SELECT,validation:t=>c.required(t),computedValue:t=>({concept_id:l("TYPE_OF_SUPPORT"),value_coded:l("".concat(t.value)),obs_datetime:n.date}),options:()=>[{value:"GUARDIAN",label:"Guardian"},{value:"HEALTH_CARE_WORKER",label:"Health Care Worker"},{value:"VOLUNTEER",label:"Volunteer"},{value:"HSA",label:"Health Surveillance Assistant"}]}),w=()=>{let t=!1;return{id:"useHangingPills",helpText:"Use Hanging Pills:",type:d.TT_SELECT,init:async()=>(t=!!(await p.getObs({person_id:r,date:n.date,page_size:1,concept_id:l("TB_ADHERENCE")})||[]).length,!0),condition:()=>t,validation:e=>c.required(e),computedValue:(e,a)=>{e.value==="Yes"&&E(a).map(s=>({concept_id:l("APPOINTMENT_REASON"),value_drug:s.drug_id,value_text:"Optimize - including hanging pills",obs_datetime:n.date}))},options:()=>W(["Yes","No"])}};b.value=[o(),_(),R(),A(),I(),x(),C(),w(),P()]});async function f(i,r){await n.createEncounter(),await n.saveObservationList(await j(r)),await p.postJson("drug_orders",{encounter_id:n.encounterID,drug_orders:E(i).map(o=>{var _;return{drug_inventory_id:(o==null?void 0:o.drug_id)||(o==null?void 0:o.id)||((_=o==null?void 0:o.drug)==null?void 0:_.drug_id),start_date:n.date,am_dose:o.am_dose,noon_dose:o.noon_dose,pm_dose:o.pm_dose,auto_expire_date:k(n.date).add(i.recommendedNumberOfDays.value!="Other"?i.recommendedNumberOfDays.value:i.otherDays.value,"days").format(B),name:o.drug.name,concept_id:o.drug.concept_id,equivalent_daily_dose:o.am_dose+o.noon_dose+o.pm_dose}})}),y.isOnTreatment(N.outcome)||await y.enrollTb(n.patientID),S()}return(i,r)=>(q(),H(D(Y),null,{default:U(()=>[$(J,{cancelDestinationPath:D(O),onFinishAction:f,activeField:T.value,onOnIndex:r[0]||(r[0]=o=>T.value=""),fields:b.value,skipSummary:!0},null,8,["cancelDestinationPath","activeField","fields"])]),_:1}))}});export{ne as default};
