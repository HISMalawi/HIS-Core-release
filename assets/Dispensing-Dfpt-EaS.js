var g=Object.defineProperty;var D=(e,s,t)=>s in e?g(e,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[s]=t;var d=(e,s,t)=>D(e,typeof s!="symbol"?s+"":s,t);import{bQ as o,d as m,H as p,aj as l,ad as f,W as y,aa as _,c as b,af as v,a as O}from"./index-CMZASHAR.js";import{D as c}from"./drug_order_service-DwQHOfYk.js";import{_ as w}from"./EncounterMixin.vue_vue_type_script_lang-v2aYCq6R.js";import"./encounter_guidelines-CJXpBOk4.js";import"./GuidelineEngine-D6V1_Znr.js";import"./HisStandardForm-BCjM4-bc.js";class H extends o{constructor(t,r){super(t,54,r);d(this,"drugHistory");d(this,"currentDrugOrder");this.drugHistory=[],this.currentDrugOrder=[]}getDrugHistory(){return this.drugHistory}getCurrentOrder(){return this.currentDrugOrder}buildDispensations(t,r){return[{drug_order_id:t,date:this.date,quantity:r}]}saveDispensations(t){return o.postJson("/dispensations",{dispensations:t,program_id:o.getProgramID()})}async voidOrder(t){return o.void("/dispensations/".concat(t),{})}async loadDrugHistory(){const t=await c.getDrugOrderHistory(this.patientID);t&&(this.drugHistory=t)}async loadCurrentDrugOrder(){const t=await c.getDrugOrders(this.patientID);t&&(this.currentDrugOrder=await Promise.all(t))}calcCompletePack(t,r){const i=t.barcodes.sort(function(a,h){return a.tabs-h.tabs});if(i.length==0||r==0)return r;for(let a=0;a<=i.length-1;a++)if(parseInt(i[a].tabs)>=r)return i[a].tabs;const u=parseInt(i[0].tabs);let n=parseInt(i[i.length-1].tabs);for(;n<r;)n+=u;return n}}const P=m({mixins:[w],data:()=>({dispensation:{}}),watch:{patient:{async handler(e){this.dispensation=new H(e.getID(),this.providerID),await this.dispensation.loadCurrentDrugOrder(),await this.dispensation.loadDrugHistory(),this.fields=this.getFields()},deep:!0}},methods:{saveDispensations(e){const s=this.buildDispensations(e);return this.dispensation.saveDispensations(s)},buildDispensations(e){return this.dispensation.buildDispensations(e.other.order_id,e.value)},buildMedicationHistory(){return this.dispensation.getDrugHistory().sort((e,s)=>{const t=new Date(e.order.start_date);return new Date(s.order.start_date)-t}).map(e=>({medication:e.drug.name,date:p.toStandardHisDisplayFormat(e.order.start_date),amount:e.quantity}))},buildOrderOptions(){return this.dispensation.getCurrentOrder().map(e=>({label:e.drug.name,value:e.quantity||0,other:{drug_id:e.drug.drug_id,order_id:e.order.order_id,amount_needed:this.calculateCompletePack(e)}}))},getPackSizesRows(e,s){return this.dispensation.getDrugPackSizes(e).map(r=>{const i=s>0?s/r:"-";return[r,i,0,0]})},calculateCompletePack(e){const s=parseFloat(e.amount_needed)-(e.quantity||0),t=this.dispensation.calcCompletePack(e,s);return t<0?0:t},isDoneDispensing(e){return e.map(s=>s.value!=0).every(Boolean)},async isValidDispensation(e){let s=!0;const t=parseInt(e.value.toString()),r=e.other.amount_needed,i=t/r*100;return i>110&&(s=await l("Are you sure you want to dispense over 110% of the prescribed pill count?")),i<100&&(s=await l("Are you sure you want to dispense less than 100% of the prescribe amount?")),s},getFields(){return[{id:"dispenses",helpText:"Dispensation",type:f.TT_DRUG_DISPENSER,onValueUpdate:async(e,s)=>e.value!=-1&&this.isDoneDispensing(s)?this.gotoPatientDashboard():(e.other.amount_needed=0,await this.dispensation.loadCurrentDrugOrder(),this.buildOrderOptions()),onValue:async(e,s)=>e.value===-1?!!await this.dispensation.voidOrder(e.other.order_id):!s&&!await this.isValidDispensation(e)?!1:await this.saveDispensations(e)?!0:(y("Unable to save dispensation"),!1),config:{medicationHistory:this.buildMedicationHistory(),toolbarInfo:[{label:"Name",value:this.patient.getFullName()},{label:"Gender",value:this.patient.getGender()},{label:"Date Of Birth",value:p.toStandardHisDisplayFormat(this.patient.getBirthdate())}],hiddenFooterBtns:["Clear","Finish"]},options:()=>this.buildOrderOptions()}]}}});function k(e,s,t,r,i,u){const n=v("his-standard-form");return O(),b(n,{skipSummary:!0,cancelDestinationPath:e.cancelDestination,fields:e.fields},null,8,["cancelDestinationPath","fields"])}const $=_(P,[["render",k]]);export{$ as default};
