var v=Object.defineProperty;var S=(e,t,o)=>t in e?v(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var d=(e,t,o)=>(S(e,typeof t!="symbol"?t+"":t,o),o);import{F as l}from"./dynamic-import-helper-Bsjrd6Ro.js";import{H as y}from"./HisStandardForm-B3aw5EdY.js";import{C as E}from"./KbLayouts-VRA-vjeH.js";import{d as D,b7 as g,ab as u,T as b,q as k,V as n,cq as h,t as I,cm as A,H as _,a$ as T,_ as C,r as x,o as F,c as R}from"./index-BFG-WECc.js";import{g as $}from"./LocationFieldOptions-C7Umd-Mw.js";import"./TouchScreenForm-DiI3Xfhg.js";import"./ToolbarMediumCard-C3iotOe-.js";import"./Transformers-BPPLlH12.js";import"./ViewPort-0kHLdkku.js";class p{constructor(){d(this,"BASE30_DIGITS_INDEX",{});d(this,"BASE30_DIGITS");this.BASE30_DIGITS="0123456789ABCDEFGHJKLMNPRTVWXY".split(""),this.BASE30_DIGITS.forEach((t,o)=>this.BASE30_DIGITS_INDEX[t]=o)}convertFromDecimal(t,o=30){if(o<2||o>30)throw"Invalid base ${toBase}";let i="";for(;t>0;)i=this.BASE30_DIGITS[t%o]+i,t=Math.floor(t/o);return i}static calculateLuhnCheckDigit(t){const o=t.toString().split("").map(s=>Number.parseInt(s,10)),i=o.length%2;let a=0;o.forEach((s,c)=>{c%2===i&&(s*=2),s>9&&(s-=9),a+=s});const r=a%10;return r===0?0:10-r}isValidDHACode(t){try{const o=this.convertToDecimal(t).toString();return p.calculateLuhnCheckDigit(Number.parseInt(o,10)*10)===0}catch(o){return console.error(o),!1}}convertToDecimal(t){if(t.length==0)return 0;const o=this.BASE30_DIGITS_INDEX[t[0]];if(o==null)throw"Invalid base ${fromBase} number: ${number}";return o*30**(t.length-1)+this.convertToDecimal(t.slice(1))}}const B=D({components:{HisStandardForm:y},data:()=>({activeField:"",fields:[],drugs:[],selectedDrugs:[],barcode:"",stockService:{}}),methods:{async onFinish(e){let t=[];for(const o of e.enter_batches){const i={reallocation_code:e.authorization.value,quantity:o.other.pack_size*o.other.tins,date:e.date.value,reason:o.other.reason};try{e.task.value==="Relocations"?await this.stockService.relocateItems(o.other.id,{...i,location_id:e.relocation_location.value}):await this.stockService.disposeItems(o.other.id,i)}catch(a){a instanceof g&&!u.isEmpty(a.errors)?t=t.concat(a.errors.map(r=>"".concat(r," for ").concat(o.other.drug_name))):t.push("".concat(a)),console.log(a)}}if(u.isEmpty(t))return b("Stock succesfully moved"),this.$router.push("/");k("".concat(t.join(",")))},getFields(){return[{id:"task",helpText:"Select task",type:l.TT_SELECT,validation:e=>n.required(e),options:()=>[{label:"Relocations",value:"Relocations"},{label:"Disposal",value:"Disposal"}]},{id:"relocation_location",helpText:"Destination",type:l.TT_SELECT,validation:e=>n.required(e)||n.notTheSame(e.label,"".concat(h.getLocationName())),condition:e=>e.task.value==="Relocations",options:(e,t="")=>$(t),computedValue:e=>e.label,config:{showKeyboard:!0,isFilterDataViaApi:!0}},{id:"date",dynamicHelpText:e=>"Date of ".concat(e.task.label),helpText:"Set date",type:l.TT_FULL_DATE,validation:e=>n.required(e)},{id:"select drugs",helpText:"Select drugs",type:l.TT_MULTIPLE_SELECT,requireNext:!0,validation:e=>n.required(e),options:async(e,t)=>this.getDrugs(t,e.date.value),unload:e=>this.selectedDrugs=e},{id:"enter_batches",helpText:"Batch entry",type:l.TT_BATCH_MOVEMENT,beforeNext:(e,t,o,{currentFieldContext:i})=>{const a=s=>s.map(c=>"".concat(c.label)).join(" & "),r=i.drugs.filter(s=>!s.other.tins||!s.other.reason);if(!u.isEmpty(r)){const s=a(r);return I("Please fix partial batch entries for drugs: ".concat(s)),!1}return!0},options:()=>this.selectedDrugs,validation:e=>n.required(e),config:{getReasons:this.getReasons}},{id:"authorization",helpText:"Enter authorization code",type:l.TT_TEXT,config:{customKeyboard:[E,[["Delete"]]]},validation:e=>n.validateSeries([()=>n.required(e),()=>{const t=e.value;return new p().isValidDHACode(t.toUpperCase())?null:["Invalid authorization code"]}])},{id:"summary",helpText:"Summary",type:l.TT_TABLE_VIEWER,options:e=>this.buildResults(e),config:{hiddenFooterBtns:["Clear"]}}]},buildResults(e){const t=e.task.value==="Relocations",o=["Drug","Total Tins","Expiry date","Authorization code","Reason"];t&&o.push("Relocation");const i=e.enter_batches.map(a=>{const r=[a.other.drug_name,A(a.other.tins),_.toStandardHisDisplayFormat(a.other.expiry_date),e.authorization.value.toUpperCase(),a.other.reason];return t&&r.push(e.relocation_location.label),r});return[{label:"Confirm entry",value:"Table",other:{columns:o,rows:i}}]},async getDrugs(e,t){return(await this.stockService.getItems()).map(i=>{var c,m;const a=(m=(c=i==null?void 0:i.drug_name)!=null?c:i==null?void 0:i.drug_legacy_name)!=null?m:"N/A",r=_.toStandardHisDisplayFormat(i.expiry_date),s=e.filter(f=>f.label===a).length>=1;return{label:a,value:i.drug_id,isChecked:s,description:{color:"primary",show:"always",text:"Product Code: ".concat(i.product_code," - Batch Number: ").concat(i.batch_number," - Pack Size: ").concat(i.pack_size," - Expiry date: ").concat(r)},other:{...i,tins:null,quantity:Math.trunc(i.current_quantity/i.pack_size)||0,reason:""}}}).filter(i=>!T(t).isBefore(i.other.delivery_date)&&i.other.current_quantity>0)},mapToOptions(e){return e.map(t=>({label:t,value:t}))},getReasons(e,t){var a;if(t.task.value==="Relocations")return this.mapToOptions(["Transfer to another facility/relocation","For trainings"]);const o=T((a=e.other)==null?void 0:a.expiry_date).isAfter(h.getSessionDate()),i=["Damaged","Phased out","Banned","Missing"];return o||i.push("Expired"),this.mapToOptions(i)}},created(){this.stockService=new h,this.fields=this.getFields()}});function N(e,t,o,i,a,r){const s=x("his-standard-form");return F(),R(s,{fields:e.fields,activeField:e.activeField,onFinishAction:e.onFinish,skipSummary:!0},null,8,["fields","activeField","onFinishAction"])}const U=C(B,[["render",N]]);export{U as default};
