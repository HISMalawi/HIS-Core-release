import{d as g,a5 as w,r as d,aH as v,aK as _,cW as f,ca as D,bp as P,by as y,a8 as A,ad as m,u as C,v as k,w as T,x as $,aR as F,as as o,bl as i,aj as V}from"./index-LyP1z09P.js";import{v as h}from"./TableView-b2NipsWU.js";const E=25,I=g({props:{title:{type:String,default:"Drilldown"},patientIdentifiers:{type:Object},onFinish:{type:Function}},components:{IonPage:w,v2Datatable:h},setup(e){const a=d(!0),t=d("-"),n=d([]),r=[[S("identifier","ARV Number"),{label:"Gender",ref:"gender"},{label:"Birthdate",ref:"birthdate"},{label:"Art start date",ref:"art_start_date"},B()]];function p(){a.value=!1,typeof e.onFinish=="function"&&e.onFinish()}return v(()=>e.patientIdentifiers,async s=>{if(n.value=[],t.value="Total: 0",!(s&&s.length))return;const c=_.chunk(s,1e3);for(const b of c){try{if(!a.value)break;const u=(await P.getPersons(b)).map(l=>({...l,birthdate:f(l.birthdate),art_start_date:f(l.art_start_date),gender:D(l.gender)}));n.value=[...n.value,...u]}catch(u){console.error(u)}t.value="Total: ".concat(n.value.length," of ").concat((s||[]).length),await y(100)}},{immediate:!0}),{columns:r,subtitle:t,reportData:n,canLoadData:a,ITEMS_PER_PAGE:E,runFinishAction:p}}});function G(e,a,t,n,r,p){const s=m("v2Datatable"),c=m("ion-page");return C(),k(c,null,{default:T(()=>[$(s,{title:e.title,subtitle:e.subtitle,columnData:e.reportData,columns:e.columns,"default-sort-order":"asc","default-sorted-column":"identifier","on-finish":e.runFinishAction,rowsPerPage:e.ITEMS_PER_PAGE},null,8,["title","subtitle","columnData","columns","on-finish","rowsPerPage"])]),_:1})}const R=A(I,[["render",G]]);function S(e="arv_number",a="ARV#"){return{ref:e,label:a,sortValue:t=>{var r;const n="".concat(t).match(new RegExp("\\w{2,5}-arv-(?<arvDigit>\\d*)","i"));return parseInt(((r=n==null?void 0:n.groups)==null?void 0:r.arvDigit)||"-1")}}}function B(e="patient_id",a="/patient/dashboard/"){return{ref:e,label:"Actions",exportable:!1,toValue:()=>"View",tdClick:({refData:t})=>F.push("".concat(a).concat(t))}}async function N(e){var a;((a=e.columnData)!=null?a:[]).length&&(await o.create({component:h,backdropDismiss:!1,cssClass:"large-modal",componentProps:{onFinish:()=>o.getTop().then(t=>t&&o.dismiss()),...e}})).present()}async function x(e){e.patientIdentifiers.length&&(await o.create({component:R,backdropDismiss:!1,cssClass:"large-modal",componentProps:{onFinish:()=>o.getTop().then(a=>a&&o.dismiss()),...e}})).present()}async function H(e,a=!0){a&&(await i.create({message:"Please wait...",backdropDismiss:!1})).present();try{const t=await e();return i.getTop().then(n=>n?i.dismiss():null),t}catch(t){console.error(t),V("Unable to generate report")}i.getTop().then(t=>t?i.dismiss():null)}export{R as A,S as a,N as b,B as c,x as s,H as w};
