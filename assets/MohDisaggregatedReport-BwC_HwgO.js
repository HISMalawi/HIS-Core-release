import{d as M,a5 as F,cZ as x,ao as P,r as u,t as T,cY as R,aI as k,af as B,aj as y,cc as E,c_ as N,c$ as A,as as f,d1 as S,d2 as O,a8 as U,ad as _,u as V,v as H,w as L,x as q}from"./index-BXYGQb-P.js";import{D as G}from"./disaggregated_service-D9rEKxwR.js";import{R as Q}from"./regimen_report_service-D0Jt1rsJ.js";import{M as j}from"./moh_cohort_service-B88bpj_S.js";import{A as X}from"./v2utils-BIenKNQc.js";import{v as Y}from"./TableView-CKH-wDrl.js";import{R as Z}from"./ReportErrors-C2qAKoLq.js";import"./Export-CZ7Cg_rj.js";const z=M({components:{IonPage:F,IonLoading:x,v2Datatable:Y},setup(){const o=P(),d=u(!1),p=u([]),c=u(""),b=u(""),g=u(!1),n=new G,i=new j,s=u([]),$=async a=>{(await f.create({component:X,backdropDismiss:!1,cssClass:"large-modal",componentProps:{...a,subtitle:c.value,onFinish:()=>f.getTop().then(e=>e&&f.dismiss())}})).present()},m=(a,e)=>({ref:e,label:a,defaultValue:"0",toValue:t=>t.length,tdClick:async t=>{t.refData.length&&$({patientIdentifiers:t.refData,title:"".concat(t.data.age_group," ").concat(t.data.gender," ").concat(t.column.label)})}}),C=[[{label:"#",ref:"index"},{label:"Age group",ref:"age_group"},{label:"Gender",ref:"gender"},m("TX curr (receiving ART)","tx_curr"),...Q.map(a=>m(a,a)),m("Unknown","N/A"),m("Total (regimen)","total")]],w=async()=>D(await B("Do you want to rebuild report?")),v=function(a){const e=s.value.findIndex(t=>t.id===a.id);e!==-1?s.value[e]=a:s.value.push(a)},h=async function(a){const e="validation";(await f.create({id:e,component:Z,backdropDismiss:!1,cssClass:"large-modal",componentProps:{errors:a}})).present(),v({id:e,text:"<b>".concat(a.length,"</b> validation errors detected"),icon:O,color:"danger",action:()=>h(a)})},I=async a=>{const e={total_alive_and_on_art:{param:a.length,check:(r,l)=>r!=l,error:(r,l)=>"\n                        Total alive of <b>".concat(l,"</b>\n                        Does not match total alive of <b>").concat(r,"</b> on MOH report\n                    ")}};i.validateIndicators(e,r=>{r.length?h(r):v({id:"validation",text:"<b>Report is consistent</b>",icon:S,color:"success"})})===-1&&h(["Report not validated. Run the MoH cohort report for similar reporting period and then run this report"])},D=async(a=!1)=>{if(!d.value)return y("Unable to generate report, return to cohort report");g.value=!0;try{p.value=[];const e=(await n.getDisaggReport(a,"moh")).reduce((t,r)=>{if(/unknown/i.test(r.age_group))return t;const l="".concat(r.gender).toUpperCase();return t[l]&&t[l].push({...r,gender:E(r.gender)}),["M","F"].includes(l)&&!/all/i.test(r.age_group)&&(t.totalAlive=[...t.totalAlive,...r.tx_curr]),t},{M:[],F:[],FP:[],FBF:[],FNP:[],totalAlive:[]});p.value=[...e.F,...e.M,...e.FP,...e.FNP,...e.FBF].map((t,r)=>({index:r+1,...t})),v({text:"Total alive and on ART: <b>".concat(e.totalAlive.length,"</b>"),icon:N,color:"primary",action:()=>$({patientIdentifiers:e.totalAlive,title:"Total alive and on ART: ".concat(e.totalAlive.length)})}),I(e.totalAlive)}catch(e){const t="Unable to generate report!";y(t),s.value=[{text:t,color:"danger",icon:A,action:function(){s.value=[{text:"Exception occured: <b>".concat(e,"</b>"),color:"danger",icon:A}]}}]}g.value=!1,b.value=""};return T(()=>{d.value=!!(o.query.start_date&&o.query.end_date&&o.query.quarter),d.value&&(n.setStartDate("".concat(o.query.start_date)),n.setEndDate("".concat(o.query.end_date)),n.setOccupation("".concat(o.query.occupation)),i.setOccupation(n.occupation),i.setStartDate(n.startDate),i.setEndDate(n.endDate),c.value="".concat(R(n.startDate)," to ").concat(R(n.endDate)),o.query.quarter&&(n.setQuarter("".concat(o.query.quarter)),i.setQuarter(n.quarter),c.value="".concat(n.quarter==="Custom"?c.value:n.quarter)),D())}),{Img:k,onRegenerate:w,headerBadge:s,reportData:p,isLoading:g,generate:D,columns:C,period:c}}});function J(o,d,p,c,b,g){const n=_("ion-loading"),i=_("v2Datatable"),s=_("ion-page");return V(),H(s,null,{default:L(()=>[q(n,{"is-open":o.isLoading,message:"Please wait.."},null,8,["is-open"]),q(i,{"icon-url":o.Img("login-logos/Malawi-Coat_of_arms_of_arms.png"),title:"Disaggregated report","report-prefix":"MoH",subtitle:o.period,columns:o.columns,columnData:o.reportData,rowsPerPage:100,onRefresh:o.onRegenerate,headerBadge:o.headerBadge},null,8,["icon-url","subtitle","columns","columnData","onRefresh","headerBadge"])]),_:1})}const se=U(z,[["render",J]]);export{se as default};
