import{d as T,bm as g,aC as a,aw as C,c0 as m,as as D,c1 as b,aN as y,O as c,ah as A,ag as S,a9 as s,aa as r,bv as f,K as w,a6 as E,v as x,ab as N,u as P}from"./index-CyYd6aWW.js";import{H as I}from"./HisStandardForm-CuX9K_Ib.js";const R=T({components:{HisStandardForm:I},data:()=>({app:g.getActiveApp(),formKey:0,fields:[],activity:"",presets:{},programs:{},userData:{},fieldComponent:"",isSessionPasswordChange:!1,activeField:"",form:{}}),watch:{$route:{async handler(e){if(!e)return;const{query:t}=e;["edit","add"].includes(t.activity)?this.activity=t.activity:this.activity="add",t.update_password&&(this.userData=this.toUserData(await a.getCurrentUser()),this.isSessionPasswordChange=!0,this.activeField="new_password",this.fieldComponent=this.activeField),this.programs=this.removeObjectsByApplicationNames(a.getAvailableApps(),["CRVS"]),this.fields=this.getFields()},immediate:!0,deep:!0}},methods:{async onFinish(e,t){try{switch(this.activity){case"add":await this.create(t),this.activity="edit";break;case"edit":if(await this.update(t),this.isSessionPasswordChange){const i=new C;i.sessionDate=await a.getApiDate(),await i.resetUserPasswordChangeCheck(),this.$router.push("/")}break}e.hts_provider_code&&await a.setUserProperty(m,e.hts_provider_code.value,this.userData.id),D.invalidate("PROVIDERS"),this.activeField="user_info",this.$nextTick(()=>this.fieldComponent=this.activeField),this.formKey+=1}catch(i){i instanceof b&&!y.isEmpty(i.errors)?c(i.errors):A("".concat(i))}},removeObjectsByApplicationNames(e,t){return e.filter(d=>!t.includes(d.applicationName))},async create(e){const{user:t}=await a.createUser(e);if(t)return this.userData=this.toUserData(t);throw"Unable to create new user, Possibly the user already exists or incorrect info was entered"},async update(e){const t=await a.updateUser(this.userData.id,e);if(t)return this.userData=this.toUserData(t);throw"Unable to update user, possibly server error or incorrect information entered"},getProgramName(e){const t=y.find(this.programs,{programID:e});return t?t.applicationName:""},mapToOption(e){return e.map(t=>({label:t,value:t}))},async getRoles(){return(await a.getAllRoles()).filter(e=>{try{return!this.userData.role.split(",").includes(e.role)}catch(t){return!0}}).map(e=>({label:e.role,value:e.role,other:e}))},toUserData(e){const t=e.person.names[0];return{id:e.user_id,given_name:t.given_name,family_name:t.family_name,username:e.username,role:e.roles.map(i=>i.role),created:S.toStandardHisDisplayFormat(e.date_created),status:e.deactivated_on?"Inactive":"Active",programs:e.programs.map(i=>i.program_id)}},editConditionCheck(e=[]){return this.activity==="edit"?e.includes(this.activeField):!0},toLcase(e){return e.value.toString().toLowerCase()},getFields:function(){return[{id:"select_user",helpText:"Select Username",type:s.TT_SELECT,condition:()=>this.activity==="edit"&&a.isAdmin(),validation:e=>r.required(e),unload:({other:e})=>this.userData=this.toUserData(e),options:async()=>(await a.getAllUsers()).map(t=>({label:t.username,value:t.user_id,other:t})),config:{showKeyboard:!0}},{id:"user_info",helpText:"User information",type:s.TT_TABLE_VIEWER,dynamicHelpText:()=>"User: ".concat(this.userData.username," | Added On: ").concat(this.userData.created),condition:()=>this.activity==="edit"&&a.isAdmin(),options:async(e,t,i)=>{var _;const u=["Attributes","Values","Actions"],p=o=>({name:o==="Active"?"Deactivate":"Activate",type:"button",style:{width:"65%",fontWeight:"bold"},color:o==="Active"?"danger":"success",action:async()=>{try{o==="Active"&&(await a.deactivateUser(this.userData.id),this.userData.status="Inactive",i.rows[3]=["Status","Inactive",p("Inactive")],w("User has been deactivated",400)),o==="Inactive"&&(await a.activateUser(this.userData.id),this.userData.status="Active",i.rows[3]=["Status","Active",p("Active")],w("User has been activated",400))}catch(l){c("".concat(l))}}}),n=(o,l)=>({name:o,type:"button",color:"light",style:{fontWeight:"bold",width:"65%"},action:()=>{this.activeField=l,this.fieldComponent=this.activeField}}),h=[n("Add/Append Role","roles")];this.userData.role.length>1&&h.push(n("Remove Role","remove_roles"));const v=[["<b>Name</b>","".concat(this.userData.given_name," ").concat(this.userData.family_name),n("Edit Name","given_name"),""],["<b>Password</b>","*******",n("Change password","new_password"),""],["<b>Role</b>",this.userData.role.join("<br/>"),...h],["<b>Status</b>",this.userData.status,p(this.userData.status),""],["<b>Programs</b>",this.userData.programs.map(o=>this.getProgramName(o)).join("<br/>"),n("Edit Program","programs"),""]];if(((_=this.app)==null?void 0:_.applicationName)==="ITS"){let o="N/A";try{o=(await a.getUserProperty(m,this.userData.id)).property_value}catch(l){console.error(l)}v.push(["<b>Provider Code</b>",o,n("Update","has_hts_provider_code"),""])}return[{label:"",value:"",other:{columns:u,rows:v}}]},config:{hiddenFooterBtns:["Clear"],overrideDefaultFooterBtns:{nextBtn:{name:"Finish",onClick:()=>this.$router.back()}}}},{id:"given_name",helpText:"First name",type:s.TT_TEXT,computedValue:e=>e.value,defaultValue:()=>this.userData.given_name,condition:()=>this.editConditionCheck(["given_name"])&&a.isAdmin(),validation:e=>r.isName(e),options:async e=>{if(!e.given_name||e.given_name.value===null)return[];const t=await f.searchGivenName(e.given_name.value);return this.mapToOption(t)}},{id:"family_name",helpText:"Last name",type:s.TT_TEXT,computedValue:e=>e.value,defaultValue:()=>this.userData.family_name,validation:e=>r.isName(e),condition:()=>this.editConditionCheck(["given_name"])&&a.isAdmin(),options:async e=>{if(!e.family_name||e.family_name.value===null)return[];const t=await f.searchFamilyName(e.family_name.value);return this.mapToOption(t)}},{id:"roles",helpText:"Role",type:s.TT_SELECT,computedValue:e=>[e.value],condition:()=>this.editConditionCheck(["roles"])&&a.isAdmin(),validation:e=>r.required(e),options:()=>this.getRoles(),config:{showKeyboard:!0}},{id:"remove_roles",helpText:"Remove Roles",proxyID:"roles",type:s.TT_SELECT,validation:e=>r.required(e),condition:()=>this.editConditionCheck(["remove_roles"])&&a.isAdmin()&&this.activity==="edit",computedValue:e=>this.userData.role.filter(t=>t!=e.label),options:()=>this.mapToOption(this.userData.role),config:{showKeyboard:!0}},{id:"must_append_roles",helpText:"Would you like to append role?",type:s.TT_SELECT,computedValue:e=>e.label==="Yes",condition:()=>this.activity==="edit"&&this.editConditionCheck(["roles"])&&a.isAdmin(),defaultComputedOutput:()=>!1,validation:e=>r.required(e),options:()=>[{label:"Yes",value:"true"},{label:"No",value:"false"}]},{id:"programs",helpText:"Select Apps",type:s.TT_MULTIPLE_SELECT,condition:()=>a.isAdmin()&&this.editConditionCheck(["programs"]),validation:e=>r.required(e),computedValue:e=>e.map(t=>t.value),options:()=>this.programs.map(e=>{let t=!1;return this.activity==="edit"&&(t=this.userData.programs.includes(e.programID)),{label:e.applicationName,value:e.programID,isChecked:t}})},{id:"username",helpText:"Username",type:s.TT_TEXT,condition:()=>this.editConditionCheck(["nothing to see here"])&&a.isAdmin(),computedValue:e=>this.toLcase(e),validation:e=>r.validateSeries([()=>r.required(e),()=>r.hasLengthRangeOf(e,4,15)]),config:{casing:"lowercase"}},{id:"has_hts_provider_code",helpText:"HTS Provider code",type:s.TT_YES_NO,isRequired:()=>!0,beforeNext:async(e,t)=>{if(e==="No"){const i=t.select_user!=null?t.select_user.label:t.username!=null?t.username.value:"01010";await c("HTS provider code assigned is "+i)}return!0},condition:e=>{var d;const t=[this.activity==="add",e.programs.some(u=>u.label==="ITS"),e.roles.label==="Provider"].every(Boolean),i=[this.activity==="edit",a.isAdmin(),((d=this.app)==null?void 0:d.applicationName)==="ITS",this.editConditionCheck(["has_hts_provider_code"])].every(Boolean);return t||i},options:()=>[{label:"Does user have HTS Code?",values:[{label:"Yes",value:"Yes"},{label:"No",value:"No"}]}]},{id:"username_provider_code",proxyID:"hts_provider_code",helpText:"HTS Provider code",type:s.TT_HIDDEN,computedValue:e=>e.value,defaultValue:e=>{var i;const t=((i=e.username)==null?void 0:i.value)||e.select_user.label;return{label:t,value:t}},condition:e=>e.has_hts_provider_code==="No"&&this.editConditionCheck(["has_hts_provider_code"])},{id:"official_hts_provider_code",proxyID:"hts_provider_code",helpText:"HTS Provider code",type:s.TT_TEXT,isRequired:()=>!0,computedValue:e=>e.value,condition:e=>e.has_hts_provider_code==="Yes"&&this.editConditionCheck(["has_hts_provider_code"]),beforeNext:async e=>await a.userPropertyExists(m,"".concat(e.value))?(c("Provider code already registered!"),!1):await a.providerCodeRegisteredWithDHA("".concat(e.value))?!0:(c("Provider code is not registered with DHA"),!1),validation:e=>/^[a-zA-Z0-9]{4}$/i.test("".concat(e.value))?null:["Invalid provider code format"]},{id:"new_password",proxyID:"password",helpText:"New Password",type:s.TT_PASSWORD,computedValue:e=>this.toLcase(e),condition:()=>this.editConditionCheck(["new_password"]),validation:e=>r.validateSeries([()=>r.required(e)]),config:{inputType:"password"}},{id:"verify_password",proxyID:"password",helpText:"Confirm Password",type:s.TT_PASSWORD,computedValue:e=>this.toLcase(e),condition:()=>this.editConditionCheck(["new_password"]),validation:(e,t)=>r.validateSeries([()=>r.required(e),()=>{if(this.toLcase(t.verify_password)!=this.toLcase(t.new_password))return["New password does not match current password"]}]),config:{inputType:"password"}}]}}});function U(e,t,i,d,u,p){const n=N("his-standard-form");return P(),x(n,{key:e.formKey,fields:e.fields,skipSummary:!0,activeField:e.fieldComponent,onOnIndex:t[0]||(t[0]=h=>e.fieldComponent=""),onFinishAction:e.onFinish},null,8,["fields","activeField","onFinishAction"])}const V=E(R,[["render",U]]);export{V as default};
