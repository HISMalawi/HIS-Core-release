import{d as A,r as V,t as U,aw as ee,ax as z,u as l,v as b,w as o,x as t,y as g,z as w,B as m,C as O,E as $,Q as q,R as H,S as K,ay as se,U as M,a0 as te,W as Q,a1 as L,G as d,Z as C,H as v,a5 as W,a2 as oe,a3 as Y,az as j,aA as ne,aB as ae,aC as D,aD as G,aE as ie,ar as le,aF as re,aq as E,aG as ue,aH as de,a9 as F,O as S,aa as T,aI as pe,aJ as ce,ah as fe,a6 as J,ab as p,aK as he,aL as me,aM as we,a4 as ye,X as ge,Y as _e,aN as be,ap as Ie,aO as ke,aP as Ce,aQ as R,at as ve,aR as Pe,aS as Se,aT as Te,aU as $e,aV as Be,aW as Ve}from"./index-BMVUUxuO.js";import{p as Oe}from"./main-wWii2HKY.js";const Le={key:0},Ae={key:1},Ne=A({__name:"OfflineSync",props:{onFinish:Object},setup(e){const s=e,a=V({});return U(()=>{ee().then(n=>{Object.keys(n).forEach(async r=>{a.value[r]=!1,n[r].then(y=>a.value[r]=y)})})}),z(a,n=>{n&&Object.keys(n).every(r=>n[r])&&s.onFinish&&s.onFinish()},{deep:!0}),(n,r)=>(l(),b(g(W),null,{default:o(()=>[t(g(q),null,{default:o(()=>[t(g(H),null,{default:o(()=>[t(g(K),null,{default:o(()=>r[0]||(r[0]=[w("Please wait.......")])),_:1}),t(g(se),{type:"indeterminate"})]),_:1})]),_:1}),t(g(M),null,{default:o(()=>[t(g(te),null,{default:o(()=>[(l(!0),m($,null,O(a.value,(y,f)=>(l(),b(g(Q),{key:f,class:"his-md-text"},{default:o(()=>[t(g(L),null,{default:o(()=>[d("b",null,C(f),1)]),_:2},1024),t(g(L),null,{default:o(()=>[y?v("",!0):(l(),m("i",Le,"Downloading...")),y?(l(),m("i",Ae,"Done")):v("",!0)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1}))}}),De=A({components:{IonInput:oe,IonButton:Y,IonIcon:j},props:{useVirtualInput:{type:Boolean}},data:function(){return{eye:ne,eyeOff:ae,passwordTimeout:null,showPasswordButtonTimeout:null,showPassword:!1,showPasswordButton:!1,keyboard:D,auth:{},userInput:{type:String,username:"",password:""},focusInput:{type:Object,value:"",id:""},display:"none",keyboardTop:"",btnCaption:"",Caps:{type:Boolean,on:!1}}},created(){this.auth=new G,ie.clearScreenTimeout()},setup(){const{facility:e}=le();return{facility:e}},methods:{async syncOffline(){await re()&&(await E.create({component:Ne,backdropDismiss:!1,componentProps:{onFinish:()=>E.dismiss()}})).present()},onShowPassword(){this.showPassword=!0,this.showPasswordButton=!0,this.passwordTimeout&&clearTimeout(this.passwordTimeout),this.passwordTimeout=setTimeout(()=>this.showPassword=!1,1e4)},renderKeyBoard(e){this.focusInput=e.currentTarget,this.focusInput.id=="password"?this.btnCaption="Login":this.btnCaption="Next";let s=e.currentTarget.getBoundingClientRect().top;s=parseInt(s),this.keyboardTop=s+20+"px;",this.display="table",window.scrollTo(0,9999)},keyPress(e){const s=e.currentTarget.id;let a;try{s.match(/@#/i)?this.keyboard=ue:s.match(/qwerty/i)?this.keyboard=D:s.match(/Del/i)?this.focusInput.value=this.focusInput.value.substring(0,this.focusInput.value.length-1):s.match(/Next/i)?(this.display="none",a=this.$refs.password,a.$el.click()):s.match(/Login/i)?(this.display="none",this.doLogin()):s.match(/Caps/i)?(this.Caps.on=!this.Caps.on,this.display="none",this.focusInput.id==="username"?a=this.$refs.username:a=this.$refs.password,a.click()):s.match(/Hide/i)?this.display="none":this.focusInput.value+=s,this.focusInput.id=="username"?this.userInput.username=this.focusInput.value:this.userInput.password=this.focusInput.value}catch(n){console.warn("input error")}},doLogin:async function(){if(this.showPasswordButtonTimeout&&clearTimeout(this.showPasswordButtonTimeout),this.showPasswordButton=!1,this.showPassword=!1,this.userInput.username&&this.userInput.password){this.auth.setUsername(this.userInput.username);try{if(this.auth.versionLockingIsEnabled()&&await this.auth.validateIfCorrectAPIVersion(),!await this.auth.checkTimeIntegrity())throw"Local date does not match API date. Please Update your device's date";await this.auth.login(this.userInput.password),this.auth.startSession();const e=await Promise.all([this.auth.passwordPolicyEnabled(),this.auth.passwordExpired()]),s=(()=>{let a=0;const n=Oe(this.userInput.password);return a+=n.score,/^(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>])/i.test(this.userInput.password)&&(a+=2),a<3})();if(s||e.every(Boolean)){const a=n=>"".concat(n.value).toLowerCase();return de([{id:"new_password",proxyID:"password",helpText:"Change your password",type:F.TT_PASSWORD,init:()=>(setTimeout(()=>{s?S("Your password is weak, please change it below"):S("Your password has expired, please change it below",6e3)},500),!0),computedValue:n=>a(n),validation:n=>T.validateSeries([()=>T.required(n),()=>T.hasLengthRangeOf(n,4,15),()=>{if("".concat(this.userInput.password).toLowerCase()===a(n))return["New password should not match old password"]}]),config:{inputType:"password"}},{id:"verify_password",proxyID:"password",helpText:"Confirm Password",type:F.TT_PASSWORD,computedValue:n=>a(n),validation:(n,r)=>T.validateSeries([()=>T.required(n),()=>{if(a(r.verify_password)!=a(r.new_password))return["New password does not match current password"]}]),config:{inputType:"password"}}],async(n,r)=>{await pe.updateUser(this.auth.userID,r)?(await this.auth.resetUserPasswordChangeCheck(),this.$router.push("/select_hc_location")):S("Unable to update user")})}await this.syncOffline(),this.$router.push("/select_hc_location")}catch(e){e instanceof ce?(S("Invalid username or password"),this.showPasswordButton=!0,this.showPasswordButtonTimeout=setTimeout(()=>this.showPasswordButton=!1,3e4)):fe("".concat(e),5e4)}}else S("Complete form to log in")}},computed:{btnStyles(){return"display: ".concat(this.display,"; top: ").concat(this.keyboardTop,";")}}}),Ee={class:"main",ref:"main"},Fe={class:"cells ion-padding-bottom"},Re={key:0},Ue={style:{color:"#cd853f"}},ze={class:"rows"},qe={class:"cells"},He=["readonly"],Ke={class:"rows input-rows"},Me={class:"cells"},Qe={class:"rows"},We=["id"],Ye=["id"];function je(e,s,a,n,r,y){const f=p("ion-text"),I=p("ion-icon"),i=p("ion-button"),h=p("ion-input");return l(),m($,null,[d("div",Ee,[d("div",Fe,[e.facility?(l(),m("h3",Re,[s[7]||(s[7]=d("b",{style:{color:"#8b4513"}},"Facility: ",-1)),d("b",Ue,C(e.facility.name)+" ("+C(e.facility.district)+")",1)])):(l(),b(f,{key:1,color:"danger"},{default:o(()=>s[8]||(s[8]=[w("Facility Configuration is not set")])),_:1}))]),d("div",ze,[d("div",qe,[he(d("input",{type:"text",name:"usename",autocomplete:"off",placeholder:"Username",id:"username",ref:"username","onUpdate:modelValue":s[0]||(s[0]=c=>e.userInput.username=c),onClick:s[1]||(s[1]=c=>e.renderKeyBoard(c)),class:"input-boxes ion-padding",readonly:e.useVirtualInput},null,8,He),[[me,e.userInput.username]])])]),d("div",Ke,[d("div",Me,[t(h,{style:{margin:"0px auto","margin-top":"15px","text-align":"left"},modelValue:e.userInput.password,"onUpdate:modelValue":s[3]||(s[3]=c=>e.userInput.password=c),type:e.showPassword?"text":"password",name:"password",ref:"password",id:"password",onClick:s[4]||(s[4]=c=>e.renderKeyBoard(c)),class:"input-boxes ion-padding",placeholder:"Password",readonly:e.useVirtualInput},{default:o(()=>[!e.showPassword&&e.showPasswordButton?(l(),b(i,{key:0,onClick:e.onShowPassword,color:"light",size:"large",slot:"end"},{default:o(()=>[t(I,{size:"large",icon:e.eye},null,8,["icon"])]),_:1},8,["onClick"])):v("",!0),e.showPassword&&e.showPasswordButton?(l(),b(i,{key:1,onClick:s[2]||(s[2]=c=>e.showPassword=!1),color:"light",size:"large",slot:"end"},{default:o(()=>[t(I,{size:"large",icon:e.eyeOff},null,8,["icon"])]),_:1})):v("",!0)]),_:1},8,["modelValue","type","readonly"])])])],512),d("div",{id:"keyboard",style:we(e.btnStyles),class:"keyboard"},[(l(!0),m($,null,O(e.keyboard,(c,k)=>(l(),m("span",{key:k},[d("div",Qe,[(l(!0),m($,null,O(c,u=>(l(),m("div",{class:"cells",key:u},[u==="Next"||u==="Login"?(l(),m("button",{key:0,id:e.btnCaption,class:"keyboard-btn login-btn",onClick:s[5]||(s[5]=_=>e.keyPress(_))},C(e.btnCaption),9,We)):v("",!0),u!="Login"&&u!="Next"?(l(),m("button",{key:1,id:e.Caps.on?u.toUpperCase():u.toLowerCase(),class:"keyboard-btn",onClick:s[6]||(s[6]=_=>e.keyPress(_))},C(u==="Del."||u==="Caps"?u:e.Caps.on?u.toUpperCase():u.toLowerCase()),9,Ye)):v("",!0)]))),128))])]))),128))],4)],64)}const Ge=J(De,[["render",je],["__scopeId","data-v-3d7ae8f6"]]),Je=A({components:{IonIcon:j,IonItem:Q,Inputs:Ge,IonButton:Y,IonTitle:K,IonLabel:L,IonPage:W,IonHeader:q,IonToolbar:H,IonContent:M,IonFooter:ye,IonSelect:ge,IonSelectOption:_e},setup(){const e=V([]),s=async()=>{const i=await $e("Application Selection","Please specify the application you wish to use",e.value.map(h=>h.name),[{name:"Cancel",color:"danger",slot:"start"},{name:"Confirm",color:"primary",slot:"end",role:"action"}]);if(i.selection&&i.action!="Cancel"){const h=e.value.find(c=>c.name===i.selection);window.open("".concat(h.protocol||"http","://").concat(h.IP,":").concat(h.port||80),"_blank")}},{activePlatformProfile:a,platformProfiles:n}=be(),r=V(""),y=V(""),f=Ie(()=>a.value.keyboard===Ve.HIS_KEYBOARD_ONLY),I=Object.keys(n.value).map(i=>({label:i,value:{profileName:i,...n.value[i]}}));return z(y,i=>{a.value=(Be.find(I,{label:i})||{}).value}),U(async()=>{var k,u;const i=new G;e.value=((k=await i.loadConfig())==null?void 0:k.otherApps)||[];const h=i.getHeadVersion();i.setActiveVersion(h);const c=await i.getApiVersion();r.value="".concat(h," / ").concat(c),y.value=((u=a.value)==null?void 0:u.profileName)||""}),{showNetworkQr:ke,qrCode:Ce,version:r,profile:y,otherApps:e,deviceProfiles:I,useVirtualInputOnly:f,activePlatformProfile:a,coatImg:R("login-logos/Malawi-Coat_of_arms_of_arms.png"),pepfarImg:R("login-logos/PEPFAR.png"),showConfig:localStorage.getItem("useLocalStorage")==="true",openSelect:s,showQrNetworkScanner:ve,settingsOutline:Pe,pin:Se,albums:Te}}}),Xe={slot:"start"},Ze=["src"],xe=["src"];function es(e,s,a,n,r,y){const f=p("ion-label"),I=p("ion-title"),i=p("ion-toolbar"),h=p("ion-header"),c=p("inputs"),k=p("ion-content"),u=p("ion-button"),_=p("ion-icon"),P=p("ion-item"),N=p("ion-popover"),X=p("ion-list"),Z=p("ion-footer"),x=p("ion-page");return l(),b(x,null,{default:o(()=>[t(h,null,{default:o(()=>[t(i,null,{default:o(()=>[t(I,null,{default:o(()=>[t(f,{style:{fontWeight:"bolder",fontSize:"1.9em"}},{default:o(()=>s[1]||(s[1]=[d("b",{style:{color:"#8b4513"}},"National ",-1),d("b",{style:{color:"#cd853f"}},"EMR",-1)])),_:1})]),_:1}),t(f,{class:"ion-padding",slot:"end"},{default:o(()=>[s[2]||(s[2]=w(" Version: ")),d("b",null,C(e.version),1)]),_:1})]),_:1})]),_:1}),t(k,{fullscreen:!1,style:{width:"100%"}},{default:o(()=>[t(c,{useVirtualInput:e.useVirtualInputOnly},null,8,["useVirtualInput"])]),_:1}),t(Z,null,{default:o(()=>[t(i,null,{default:o(()=>[d("span",Xe,[d("img",{id:"coat",src:e.coatImg,alt:"Malawi Coat of Arms logo"},null,8,Ze),d("img",{id:"pepfar",src:e.pepfarImg,alt:"PEPFAR logo"},null,8,xe)]),t(u,{color:"dark",fill:"outline",size:"large",slot:"end",id:"configuration"},{default:o(()=>s[3]||(s[3]=[w(" Configuration ")])),_:1}),e.otherApps.length?(l(),b(u,{key:0,color:"dark",fill:"outline",size:"large",slot:"end",onClick:e.openSelect},{default:o(()=>s[4]||(s[4]=[w(" Other Applications ")])),_:1},8,["onClick"])):v("",!0),t(N,{trigger:"configuration","dismiss-on-select":""},{default:o(()=>[t(k,null,{default:o(()=>[t(X,null,{default:o(()=>[t(P,{button:"","router-link":"/settings/host",class:"his-sm-text"},{default:o(()=>[t(_,{icon:e.settingsOutline,slot:"start"},null,8,["icon"]),t(f,null,{default:o(()=>s[5]||(s[5]=[w("Network Settings")])),_:1})]),_:1}),t(P,{button:"","router-link":"/location/update/site",class:"his-sm-text"},{default:o(()=>[t(_,{icon:e.pin,slot:"start"},null,8,["icon"]),t(f,null,{default:o(()=>s[6]||(s[6]=[w("Facility Settings")])),_:1})]),_:1}),t(P,{button:"",onClick:s[0]||(s[0]=()=>e.showQrNetworkScanner(()=>e.$router.back())),class:"his-sm-text"},{default:o(()=>[t(_,{icon:e.qrCode,slot:"start"},null,8,["icon"]),t(f,null,{default:o(()=>s[7]||(s[7]=[w("Scan Settings")])),_:1})]),_:1}),t(P,{button:"",onClick:e.showNetworkQr,class:"his-sm-text"},{default:o(()=>[t(_,{icon:e.qrCode,slot:"start"},null,8,["icon"]),t(f,null,{default:o(()=>s[8]||(s[8]=[w("Share Settings")])),_:1})]),_:1},8,["onClick"]),t(P,{button:"",detail:"",id:"devices",class:"his-sm-text"},{default:o(()=>[t(_,{icon:e.albums,slot:"start"},null,8,["icon"]),t(f,null,{default:o(()=>s[9]||(s[9]=[w("Device Profile")])),_:1})]),_:1}),t(N,{trigger:"devices","dismiss-on-select":"",side:"end"},{default:o(()=>[(l(!0),m($,null,O(e.deviceProfiles,B=>(l(),b(P,{key:B.label,color:B.label===e.profile?"primary":"light",button:"",onClick:()=>e.profile=B.label},{default:o(()=>[t(f,null,{default:o(()=>[w(C(B.label),1)]),_:2},1024)]),_:2},1032,["color","onClick"]))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})}const os=J(Je,[["render",es],["__scopeId","data-v-09ea2fc8"]]);export{os as default};
