import{d as V,at as j,m as z,k as L,ad as q,i as K,ac as U,I as J,a4 as R,l as X,c1 as Z,z as G,cE as Q,a_ as b,q as W,ao as N,be as Y,aF as x,an as E,am as ee,a as y,w as s,ar as u,b as o,e as a,h as i,a6 as w,g as n,a9 as h,aa as g,j as _,t as C,ak as te,al as se}from"./index-DrAzzURJ.js";import{_ as oe}from"./EncounterMixin.vue_vue_type_script_lang-Bw4PWSin.js";import{H as P,B as I}from"./htn_service-fnB_Pzbh.js";import"./encounter_guidelines-wbooCIhg.js";import"./GuidelineEngine-D6V1_Znr.js";import"./HisStandardForm-BuN2ARUl.js";const ne=V({mixins:[oe],components:{ViewPort:Z,IonToolbar:X,IonHeader:R,IonContent:J,IonRow:U,IonButton:K,IonCol:q,IonFooter:L,IonPage:z,IonCheckbox:j},watch:{ready:{async handler(e){if(e){this.HTN=new I(this.patientID,this.providerID),this.drugs=this.HTN.getDrugs();const{drugs:t,notes:r}=await this.HTN.getCurrentDrugs();this.setPreviousBpDrugs(t),this.setPreviousBpNotes(r),this.canClearHtnSessionPrescription=this.patientHasHtnSessionKey()}},immediate:!0}},data:()=>({HTN:{},drugs:null,otherBpDrugs:[],canClearHtnSessionPrescription:!1}),methods:{clearPrescriptionInSession(){sessionStorage.removeItem(P.Prescription),this.canClearHtnSessionPrescription=!1},showMoreBpDrugs(){x([{id:"drug",helpText:"Select BP drugs",type:N.TT_MULTIPLE_SELECT,init:async()=>{b.isEmpty(this.otherBpDrugs)&&(await I.getAllBpDrugs()).forEach(t=>{this.otherBpDrugs.push({label:t.name,value:t.drug_id,other:t})});const e=this.getStandardSelectedDrugs().map(t=>t.drug_id);return this.otherBpDrugs=this.otherBpDrugs.map(t=>({...t,isChecked:e.includes(t.value)})),!0},onValueUpdate:e=>(Object.keys(this.drugs).forEach(t=>this.drugs[t].drugs=this.drugs[t].drugs.map(r=>({...r,selected:e.some(d=>d.value===r.drugID&&d.isChecked)}))),e),options:()=>this.otherBpDrugs,validation:e=>E.required(e),config:{showKeyboard:!0}},{id:"dosage",helpText:"Custom dose",type:N.TT_DOSAGE_INPUT,condition:e=>!b.isEmpty(e.drug),validation:e=>E.required(e)?["Drugs are not available"]:e.some(({other:t})=>t.am<=0&&t.noon<=0&&t.pm<=0)?["Missing dosage configuration on some drugs"]:null,computedValue:e=>e.map(t=>t.other),options:e=>e.drug.map(t=>({label:t.label,value:t.value,other:{drug_id:t.other.drug_id,drug_name:t.label,barcodes:t.other.barcodes,units:t.other.units,am:0,noon:0,pm:0,frequency:"Daily (QOD)"}}))}],(e,t)=>this.cacheSelectedDrugsAndProceed(t.dosage))},patientHasHtnSessionKey(){try{const e=sessionStorage.getItem(P.Prescription);if(e)return JSON.parse(e)[this.patientID]}catch(e){console.warn(e)}return!1},removeNote(e,t){this.drugs[e].notes.splice(t,1)},launchNotePad(e){this.showModal({id:"note",helpText:"Add notes for ".concat(e),type:N.TT_TEXT},t=>{t&&this.drugs[e].notes.push({date:Y.getSessionDate(),description:t.value||"",drugID:this.drugs[e].drugs[0].drugID,isNewNote:!0})})},async onFinish(){const e=Object.values(this.drugs).filter(t=>!b.isEmpty(t.notes)).map(t=>t.notes).reduce((t,r)=>t.concat(r),[]).filter(t=>t.isNewNote).map(t=>this.HTN.buildObs("Clinician notes",{value_text:t.description,value_drug:t.drugID}));if(!b.isEmpty(e))try{await this.HTN.createEncounter(),await this.HTN.saveObservationList(await Promise.all(e))}catch(t){return W("Unable to save notes ".concat(t))}this.cacheSelectedDrugsAndProceed(this.getStandardSelectedDrugs())},getStandardSelectedDrugs(){return this.selectedDrugs.map(e=>b.find(I.htnDrugReferences(),{drug_id:e.drugID}))},cacheSelectedDrugsAndProceed(e){const t={};t[this.patientID]=e,sessionStorage.setItem(P.Prescription,JSON.stringify(t)),this.$router.push("/art/encounters/prescriptions/".concat(this.patientID))},async showModal(e,t){(await G.create({component:Q,backdropDismiss:!1,cssClass:"full-modal",componentProps:{dismissType:"modal",currentField:e,onFinish:t}})).present()},setPreviousBpNotes(e){for(const t in e)this.drugs[t].notes=Object.keys(e[t]).map(r=>e[t][r].map(d=>({date:r,description:d,isNewNote:!1}))).reduce((r,d)=>r.concat(d),[])},setPreviousBpDrugs(e){e.forEach(t=>{for(const r in this.drugs)this.drugs[r].drugs.forEach((d,k)=>{t.drug_id===d.drugID&&(this.drugs[r].drugs[k].current=!0,this.drugs[r].drugs[k].selected=!0,this.drugs[r].selected=t.drug_id)})})},selectDrug(e,t,r){this.drugs[e].drugs.forEach((d,k)=>{this.drugs[e].drugs[k].selected=!1}),this.drugs[e].drugs[t].selected=r.detail.checked}},computed:{selectedDrugs(){return this.drugs?Object.values(this.drugs).map(e=>e.drugs).reduce((e,t)=>e.concat(t),[]).filter(e=>e.selected):[]}}}),f=e=>(te("data-v-00ea3049"),e=e(),se(),e),re=f(()=>n("label",{class:"his-title"}," Prescribe BP drugs ",-1)),ae={key:0,class:"view-port-content"},ie={id:"main-table",style:{width:"100%"}},le=f(()=>n("th",null," ",-1)),de=f(()=>n("td",{class:"td-remaining td-title"},[n("span",null,"New/Current")],-1)),ue=f(()=>n("td",{class:"td-remaining td-title"},[n("span",null," ")],-1)),ce=f(()=>n("p",null,null,-1)),pe={id:"table-notes",style:{width:"100%"}},he=f(()=>n("caption",{style:{"font-size":"1.2em"}}," Notes ",-1)),ge=f(()=>n("p",null,null,-1)),_e={class:"table-inner-notes",id:"notes-HCTZ"},me={class:"date-td today-td"},fe={class:"date-td today-td"};function De(e,t,r,d,k,ye){const S=u("ion-col"),v=u("ion-row"),T=u("ion-toolbar"),H=u("ion-header"),O=u("ion-checkbox"),D=u("ion-button"),$=u("view-port"),A=u("ion-content"),M=u("ion-footer"),F=u("ion-page");return o(),y(F,null,{default:s(()=>[a(H,null,{default:s(()=>[a(T,null,{default:s(()=>[a(v,null,{default:s(()=>[a(S,null,{default:s(()=>[re]),_:1})]),_:1})]),_:1})]),_:1}),a(A,null,{default:s(()=>[a($,null,{default:s(()=>[e.drugs?(o(),i("div",ae,[n("table",ie,[n("tr",null,[le,(o(!0),i(h,null,g(e.drugs,(c,l)=>(o(),i("th",{key:l},[_(C(l)+" ",1),a(v,null,{default:s(()=>[(o(!0),i(h,null,g(c.drugs,(p,m)=>(o(),y(S,{class:"col-borders",key:m},{default:s(()=>[_(C(p.amount||"0mg"),1)]),_:2},1024))),128))]),_:2},1024)]))),128))]),n("tr",null,[de,(o(!0),i(h,null,g(e.drugs,(c,l)=>(o(),i("td",{key:l,class:"td-current td-value"},[a(v,null,{default:s(()=>[(o(!0),i(h,null,g(c.drugs,(p,m)=>(o(),y(S,{key:m},{default:s(()=>[a(O,{checked:p.selected,onIonChange:B=>e.selectDrug(l,m,B)},null,8,["checked","onIonChange"])]),_:2},1024))),128))]),_:2},1024)]))),128))]),n("tr",null,[ue,(o(!0),i(h,null,g(Object.keys(e.drugs),(c,l)=>(o(),i("td",{class:"td-remaining td-value",key:l},[a(v,null,{default:s(()=>[a(S,null,{default:s(()=>[a(D,{onClick:p=>e.launchNotePad(c),color:"warning"},{default:s(()=>[_(" Add notes ")]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]))),128))])]),ce,n("table",pe,[he,ge,n("tr",null,[(o(!0),i(h,null,g(e.drugs,(c,l)=>(o(),i("th",{style:{width:"25%"},key:l},[n("span",null,C(l),1)]))),128))]),n("tr",null,[(o(!0),i(h,null,g(Object.keys(e.drugs),(c,l)=>(o(),i("td",{id:"HCTZ",style:{"padding-top":"2px !important"},valign:"top",key:l},[n("table",_e,[(o(!0),i(h,null,g(e.drugs[c].notes,(p,m)=>(o(),i("tr",{key:m},[n("td",me,C(p.date),1),n("td",fe,C(p.description),1),n("td",null,[p.isNewNote?(o(),y(D,{key:0,color:"danger",onClick:B=>e.removeNote(c,m)},{default:s(()=>[_(" X ")]),_:2},1032,["onClick"])):w("",!0)])]))),128))])]))),128))])])])):w("",!0)]),_:1})]),_:1}),a(M,null,{default:s(()=>[a(T,{color:"dark"},{default:s(()=>[a(D,{size:"large",color:"danger",slot:"start",onClick:e.gotoPatientDashboard},{default:s(()=>[_(" Cancel ")]),_:1},8,["onClick"]),a(D,{onClick:e.showMoreBpDrugs,size:"large",slot:"end"},{default:s(()=>[_(" More Drugs ")]),_:1},8,["onClick"]),e.canClearHtnSessionPrescription?(o(),y(D,{key:0,size:"large",color:"warning",slot:"end",onClick:e.clearPrescriptionInSession},{default:s(()=>[_(" Clear Session Prescription ")]),_:1},8,["onClick"])):w("",!0),e.selectedDrugs&&e.selectedDrugs.length>0?(o(),y(D,{key:1,size:"large",color:"success",slot:"end",onClick:e.onFinish},{default:s(()=>[_(" Continue ")]),_:1},8,["onClick"])):w("",!0)]),_:1})]),_:1})]),_:1})}const Ne=ee(ne,[["render",De],["__scopeId","data-v-00ea3049"]]);export{Ne as default};
