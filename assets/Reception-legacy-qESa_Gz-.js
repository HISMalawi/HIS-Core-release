System.register(["./index-legacy-zV5Jd_xD.js","./HisStandardForm-legacy-DUG6a-9J.js","./EncounterMixin.vue_vue_type_script_lang-legacy-BAZjOyt-.js","./encounter_guidelines-legacy-D0nfkYrS.js","./GuidelineEngine-legacy-KsvQuFdF.js"],(function(e,t){"use strict";var i,n,a,r,s,o,l,d,u,p,c,h,m,f,y,v,g,b,_,w,A;return{setters:[e=>{i=e.bV,n=e.az,a=e.bd,r=e.d,s=e.al,o=e.am,l=e.aZ,d=e.a_,u=e.bJ,p=e.bi,c=e.s,h=e.aB,m=e.q,f=e.at,y=e.B,v=e.ak,g=e.a,b=e.ap,_=e.b},e=>{w=e.H},e=>{A=e._},null,null],execute:function(){class t extends i{sitePrefix;constructor(e,t){super(e,51,t),this.sitePrefix=""}getSitePrefix(){return this.sitePrefix}async loadSitePrefix(){this.sitePrefix=await n.sitePrefix()}createArvNumber(e){return a.postJson("/patient_identifiers/",{patient_id:this.patientID,identifier_type:4,identifier:e})}buildArvNumber(e){return`${this.sitePrefix}-ARV-${e}`}}const V=r({mixins:[A],components:{HisStandardForm:w},data:()=>({reception:{},activeField:"",hasARVNumber:!0,suggestedNumber:"",patientType:{},isGuardianOnlyVisitAllowed:!0}),watch:{ready:{handler(e){e&&(this.reception=new t(this.patientID,this.providerID),this.fields=this.getFields())},immediate:!0}},methods:{async setIsGuardianOnlyVisitAllowed(){try{const e=await f.getPatientVisits(this.patientID,!1);if(0===e.length)return;let t=0,i=0;const n=365;for(const r of e){const e=await a.getCurrentProgramInformation(this.patientID,r);if("Guardian"!==e.visit_by)return;if(i++,e.pills_dispensed&&e.pills_dispensed.length>0){const[i,a,s]=e.pills_dispensed[0];if(s&&(t+=y(s).diff(y(r),"day"),t>=n))return void(this.isGuardianOnlyVisitAllowed=!1)}}}catch(e){console.error("Error checking guardian only visits drug dispensation period:",e)}},async onFinish(e,t){if(!(await this.reception.createEncounter()))return c("Unable to create encounter");const i=await this.resolveObs(t,"obs");if(!(await this.reception.saveObservationList(i)))return c("Unable to create Obs");if(e.capture_arv&&"Yes"===e.capture_arv.value){if(!(await this.reception.createArvNumber(t.arv_number)))return c("Unable to save Arv number");h.invalidate("ACTIVE_PATIENT")}if(m("Encounter created"),l.find(e.who_is_present,{value:"Yes",label:"Guardian present?"})&&l.isEmpty(await this.patient.getGuardian()))return this.$router.push(`/guardian/registration/${this.patientID}`);this.nextTask()},getFields(){return[(()=>({id:"who_is_present",helpText:"HIV reception",type:o.TT_MULTIPLE_YES_NO,init:async()=>(await this.setIsGuardianOnlyVisitAllowed(),!0),validation:e=>s.required(e)||s.neitherOr(e)||s.anyEmpty(e),computedValue:e=>({tag:"obs",obs:e.map((({other:e,value:t})=>this.reception.buildValueCoded(e.concept,t)))}),onValueUpdate:async(e,t)=>e.map((e=>(t.label!=e.label&&"No"===t.value&&(e.value="Yes"),e))),options:e=>e.who_is_present?e.who_is_present:[{label:"Patient present?",value:"",other:{concept:"Patient Present",property:"patient_present",values:this.yesNoOptions()}},{label:"Guardian present?",value:"",disabled:!this.isGuardianOnlyVisitAllowed,description:this.isGuardianOnlyVisitAllowed?void 0:{color:"warning",text:"Guardian-only visits have reached the maximum allowed duration of 12 months of drug dispensation. The patient must now attend in person."},other:{concept:"Guardian Present",property:"guardian_present",values:this.yesNoOptions()}}],beforeNext:async e=>{const t=l.find(e,{label:"Patient present?"});if("No"===t?.value&&!this.isGuardianOnlyVisitAllowed){const e=await d("Guardian-Only Visit Not Allowed","Patient not present for over 12 months","Guardian-only visits are no longer permitted after accumulating 12 months of drug dispensation. The patient must now attend the clinic in person.",[{name:"Update Selection",slot:"end",color:"danger"},{name:"Exit",slot:"end",color:"primary"}]);if("Update Selection"===e)return!1;if("Exit"===e)return this.$router.push(this.cancelDestination)}return!0}}))(),{id:"capture_arv",helpText:"Capture ARV Number?",type:o.TT_SELECT,requireNext:!0,init:async()=>(""===this.patient.getPatientIdentifier(4)&&(this.hasARVNumber=!1),this.patientType=new u(this.patientID,this.providerID),await this.patientType.loadPatientType(),!0),condition:()=>!this.hasARVNumber&&"New patient"===this.patientType.getType(),validation:e=>s.required(e),options:()=>this.yesNoOptions()},{id:"arv_number",helpText:"ART number",type:o.TT_TEXT,init:async()=>{if(await this.reception.loadSitePrefix(),!this.hasARVNumber){const e=await a.getNextSuggestedARVNumber();this.suggestedNumber=e.arv_number.replace(/^\D+|\s/g,"")}return!0},computedValue:({value:e})=>e,validation:e=>s.required(e),condition:e=>!this.hasARVNumber&&"Yes"===e.capture_arv.value,defaultValue:()=>this.suggestedNumber,config:{prependValue:()=>{const e=p.getActiveApp();return e&&e.programPatientIdentifiers?e.programPatientIdentifiers["ARV Number"].prefix():""}}}]}}});e("default",v(V,[["render",function(e,t,i,n,a,r){const s=b("his-standard-form");return _(),g(s,{fields:e.fields,activeField:e.activeField,onFinishAction:e.onFinish,skipSummary:!0,cancelDestinationPath:e.cancelDestination},null,8,["fields","activeField","onFinishAction","cancelDestinationPath"])}]]))}}}));
