System.register(["./index-legacy-BiNmSRfH.js","./EncounterMixin.vue_vue_type_script_lang-legacy-Da0kN4ru.js","./lab_order_service-legacy-9nO4q7LR.js","./encounter_guidelines-legacy-Ct5w19z6.js","./GuidelineEngine-legacy-KsvQuFdF.js","./HisStandardForm-legacy-Bllf5xqT.js"],(function(e,t){"use strict";var i,a,n,s,r,c,l,o,d,u,p,m,h,g,y,b,v,_,T,S,f,F;return{setters:[e=>{i=e.d,a=e.al,n=e.am,s=e.bj,r=e.bm,c=e.bI,l=e.c2,o=e.dF,d=e.br,u=e.s,p=e.y,m=e.H,h=e.S,g=e.aB,y=e.au,b=e.dj,v=e.ak,_=e.ap,T=e.a,S=e.b},e=>{f=e._},e=>{F=e.L},null,null,null],execute:function(){const t=i({mixins:[f],data:()=>({patientID:-1,service:{},fields:[],barcode:"",activityType:"",canScanDBS:!1,isNextBtnDisabled:!0,verifyingBarcode:!1}),async created(){this.canScanDBS=await b.canScanDBS()},watch:{$route:{handler({query:e,params:t}){e&&t&&(this.patientID=t.patient_id,this.activityType=e.type,this.service=new o(this.patientID),this.fields=[this.getClinianGivenNameField(),this.getClinianFamilyNameField(),this.getFacililityLocationField(),this.getReasonForTestField(),this.getTestSpecimensField(),this.getTestSelectionField(),this.getBarcodeInput(),this.getTestCombinationField()])},immediate:!0,deep:!0}},methods:{async onSubmit(e,t){const i=await r.getConceptID("HIV viral load"),a=await r.getConceptID("Plasma");if(t.specimen.concept_id!=a){const e=t.tests.findIndex((e=>e.concept_id===i));if(-1!==e){const i=new F(parseInt(this.patientID),this.providerID),a=await i.createEncounter();if(a){const i=t.tests.splice(e,1)[0],n=this.buildLabOrders(t,i.concept_id,a),r=await s.saveOrdersArray(a.encounter_id,n);if(!r)return u("Unable to save lab orders");g.invalidate("PATIENT_LAB_ORDERS"),await y("Lab orders and encounter created!, print out your last orders?",{confirmBtnLabel:"Yes",cancelBtnLabel:"No"})&&await this.service.printSpecimenLabel(r[0].order_id),t.tests.length<=0&&this.$router.push(`/patient/dashboard/${this.patientID}`)}}}if(t.tests.length>0){const e=await this.service.placeOrder(t);e&&(await this.service.printSpecimenLabel(e[0].order_id),this.$router.push(`/patient/dashboard/${this.patientID}`))}},buildLabOrders(e,t,i){return[{...this.barcode?{accession_number:this.barcode}:{},encounter_id:i.encounter_id,tests:[{concept_id:t}],reason_for_test_id:e.reason_for_test_id,target_lab:e.target_lab,date:m.toStandardHisFormat(h.getSessionDate()),requesting_clinician:e.requesting_clinician,specimen:{concept_id:e.specimen.concept_id}}]},async verifyingScanedBarcode(e){if(this.verifyingBarcode=!this.verifyingBarcode,this.verifyingBarcode)return!1;if((await d.create({message:`Checking ${e}`})).present(),this.isNextBtnDisabled=!0,!/^([A-Z]{1})?[0-9]{7,8}$/i.test(`${e}`.trim()))return u("Invalid Barcode"),this.verifyingBarcode=!1,d.getTop().then((e=>e&&d.dismiss())),!1;try{if(!(await s.accessionNumExists(e)))return this.barcode=e,this.isNextBtnDisabled=!1,!0;u(`Barcode ${e} was already used`)}catch(t){p("Failed to confirm barcode "+e+", Please try again later",8e3)}this.verifyingBarcode=!1,d.getTop().then((e=>e&&d.dismiss()))},getFacililityLocationField:()=>({id:"target_lab",helpText:"Requesting location",type:n.TT_SELECT,defaultValue:()=>o.getLocationName(),validation:e=>a.required(e),options:(e,t="")=>l(t),computedValue:e=>e.label,config:{showKeyboard:!0,isFilterDataViaApi:!0}}),getClinianGivenNameField(){const e=c.getGivenNameField();return e.helpText="Requesting clinician - First name",e.proxyID="requesting_clinician",e.condition=()=>"DRAW_SAMPLES"===this.activityType,e.appearInSummary=()=>!1,e},getClinianFamilyNameField(){const e=c.getFamilyNameField();return e.helpText="Requesting clinician - Last name",e.proxyID="requesting_clinician",e.condition=()=>"DRAW_SAMPLES"===this.activityType,e.summaryMapValue=(e,t)=>({label:"Clinician name",value:`${t.given_name.value} ${e.value}`}),e.computedValue=(e,t)=>`${t.given_name.value} ${e.value}`,e},getReasonForTestField:()=>({id:"reason_for_test_id",helpText:"Reason for test",type:n.TT_SELECT,validation:e=>a.required(e),computedValue:e=>r.getCachedConceptID(e.value,!0),options:()=>[{label:"Routine",value:"Routine"},{label:"Targeted",value:"Targeted"},{label:"Confirmatory",value:"Confirmatory"},{label:"Repeat / Missing",value:"Repeat / Missing"},{label:"Stat",value:"Stat"}]}),getTestSpecimensField(){return{id:"specimen",helpText:"Select specimen",type:n.TT_SELECT,condition:()=>"DRAW_SAMPLES"===this.activityType,validation:e=>a.required(e),computedValue:e=>({concept_id:e.value}),options:async()=>(await s.getSpecimens("")).map((e=>({label:e.name,value:e.concept_id}))),config:{showKeyboard:!0}}},getTestSelectionField(){let e="";return{id:"tests",helpText:"Select tests",type:n.TT_GRID_SELECTOR,validation:e=>a.required(e),computedValue:e=>e.map((e=>({concept_id:e.value}))),options:async(t,i,a)=>t.specimen&&t.specimen.label!=e?(e=t.specimen.label,(await s.getTestTypesBySpecimen(t.specimen.label)).map((e=>({label:e.name,value:e.concept_id,isChecked:!1,other:e})))):a}},getBarcodeInput(){return{id:"barcode",helpText:"Scan viral load barcode",type:n.TT_BARCODE,onValue:async e=>await this.verifyingScanedBarcode(e),summaryMapValue:e=>({label:"Scaned Barcode",value:e}),condition:e=>e.tests.some((e=>"HIV viral load"===e.label&&this.canScanDBS))&&"Plasma"!==e.specimen.label,config:{hiddenFooterBtns:["Clear"],overrideDefaultFooterBtns:{nextBtn:{name:"Next",state:{disabled:{default:()=>this.isNextBtnDisabled}}}},showScannedBarcode:!0}}},getTestCombinationField(){return{id:"combine_tests",helpText:"Combine test(s) in one order",type:n.TT_SELECT,computedValue:e=>"Yes"===e.value,condition:e=>e.tests.length>1,validation:e=>a.required(e),options:()=>this.yesNoOptions()}}}});e("default",v(t,[["render",function(e,t,i,a,n,s){const r=_("his-standard-form");return S(),T(r,{fields:e.fields,onFinishAction:e.onSubmit},null,8,["fields","onFinishAction"])}]]))}}}));
