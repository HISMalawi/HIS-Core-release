import{r as E,e as H,aL as N,bz as q,aj as P,aN as _,H as T,cG as M,ad as l,ae as u,W as f,aw as B,aE as W,cH as j}from"./index-CMZASHAR.js";import{L as k}from"./lab_order_service-DVn-Zq6K.js";let p;const y=E([]),b=E([]),w=E(Math.random()),c=H({date:"",id:-1,indicators:[]});async function C(t,r,a){if(t!=="HIV viral load")return!0;const i=a.substring(0,1),s=a.substring(1,a.length);return q.isValidVLResult(r,i,s)?!0:!await P("Invalid results for ".concat(r," HIV viral load"),{cancelBtnLabel:"Process result",confirmBtnLabel:"Re-enter result"})}function X(t){return/^(>|<|=)(.*)/im.test(t)}function K(t){return/^(=|<|>)([0-9]*)$/im.test(t)}function h(t){return/serum crag/i.test(t)}function g(t){return/mrdt|malaria/i.test(t)}function L(t){return/Lam/i.test(t)}function v(t){return/HIV viral load/i.test(t)}function U(t){return g(t)||L(t)||h(t)}function Y(t,r,a,i){const s=U(t),m=s?"text":r["type_".concat(a)].value,n=s?"".concat(i):i.substring(1),o=s?"=":i.charAt(0);return{type:m,value:n,modifier:o}}function z(t,r,a){return t.map(i=>({testId:r,indicatorName:i.name,indicatorId:i.concept_id,specimen:a}))}async function R(){const t=await p.getTestsWithoutResults(),r=["Acession#","Specimen","Test","Order date"],a=[];for(const i of t)for(const s of i.tests)if(_.isEmpty(s.result)){const m=await p.getTestIndicators(s.concept_id),n=z(m,s.id,i.specimen.name);y.value.push(...n),a.push([i.accession_number,i.specimen.name,s.name,T.toStandardHisDisplayFormat(i.order_date),{type:"button",name:"Enter result",action:()=>{c.id=s.id,c.date=i.order_date,c.indicators=n,M(G)}}])}b.value=[{label:"",value:"",other:{rows:a,columns:r}}]}async function G(){return W([{id:"result_date",helpText:"Result Date",type:l.TT_DATE_PICKER,required:!0,defaultValue:()=>p.getDate(),computedValue:t=>t,config:{infoItems:t=>[{label:"Order Date",value:T.toStandardHisDisplayFormat(c.date)},{label:"Result Date",value:T.toStandardHisDisplayFormat(t)}],minDate:()=>T.toStandardHisFormat(c.date),maxDate:()=>p.getDate()}},{id:"result_indicators",helpText:"Select test result indicators",type:l.TT_MULTIPLE_SELECT,validation:t=>u.required(t),options:()=>c.indicators.map(t=>({label:t.indicatorName,value:t.indicatorId}))},...O(),{id:"entry_confirmation",helpText:"Confirm entry",type:l.TT_TABLE_VIEWER,options:(t,r)=>[{label:"",value:"",other:{rows:Object.values(r).filter(i=>typeof i=="object"&&i!=null&&i.tag==="result_indicator").map(i=>[i.test,i.modifier,i.result]),columns:["Test","Modifier","Result"]}}]}],async(t,r)=>{const a=Object.values(r).filter(s=>s.tag==="result_indicator"&&s.measures).map(s=>s.measures);await A(a,r.result_date)&&(await R(),j.dismiss(),w.value=Math.random())})}function O(){const t=[];for(const r of y.value){const{indicatorName:a,indicatorId:i,testId:s,specimen:m}=r,n=i*s,o=e=>c.id===s&&_.findIndex(e.result_indicators,{label:a})>-1,F=e=>C(a,m,e.value),d=(e,S)=>{if(/^other$/i.test(e.value)&&v(a))return{};const{type:x,value:I,modifier:$}=Y(a,S,n,e.value),V=x==="numeric"?parseInt(I):I,D=_.find(S.result_indicators,{label:a});return{tag:"result_indicator",measures:{indicator:{concept_id:D.value},value:V,value_modifier:$,value_type:x},result:V,modifier:$,test:D.label}};t.push({id:"type_".concat(n),helpText:"Result type (".concat(a,")"),type:l.TT_SELECT,group:"test_indicator",condition:e=>o(e)&&!g(a)&&!L(a)&&!h(a),appearInSummary:()=>!1,validation:e=>u.required(e),options:()=>[{label:"Numeric (numbers only)",value:"numeric"},{label:"Alphanumeric(text and numbers)",value:"text"}]},{id:"urine_result_".concat(n),helpText:"Select Test Result (".concat(a,")"),type:l.TT_SELECT,group:"test_indicator",computedValue:d,validation:e=>u.required(e),condition:e=>o(e)&&L(a),options:()=>[{label:"Positive",value:"positive"},{label:"Negative",value:"negative"}]},{id:"crag_result_".concat(n),helpText:"Select Serum CrAg Result (".concat(a,")"),type:l.TT_SELECT,group:"test_indicator",computedValue:d,validation:e=>u.required(e),condition:e=>o(e)&&h(a),options:()=>[{label:"Positive",value:"positive"},{label:"Negative",value:"negative"}]},{id:"num_".concat(n),helpText:"Test Result (".concat(a,")"),type:l.TT_TEXT,group:"test_indicator",computedValue:d,beforeNext:F,onValue:e=>/hiv/i.test(a)&&e&&e.value&&!K(e.value.toString())?(f("You must enter a modifer and numbers only. i.e =90 / >19 / < 750"),!1):!0,validation:e=>u.required(e),condition:e=>o(e)&&e["type_".concat(n)].value==="numeric",config:{customKeyboard:[[["1","2","3"],["4","5","6","=","<",">"],["7","8","9","."],["","0",""]],[["Delete"]]]}},{id:"alpha_".concat(n),helpText:"Test Result (".concat(a,")"),type:l.TT_TEXT,group:"test_indicator",computedValue:d,validation:e=>u.required(e),condition:e=>o(e)&&e["type_".concat(n)].value==="text"&&!v(a)},{id:"VL_alpha_".concat(n),helpText:"Select Test Result (".concat(a,")"),type:l.TT_SELECT,group:"test_indicator",computedValue:d,validation:e=>u.required(e),condition:e=>o(e)&&e["type_".concat(n)].value==="text"&&v(a),options:()=>[{label:"Collect Another Sample",value:"=Collect Another Sample"},{label:"<LDL",value:"<LDL"},{label:"=LDL",value:"=LDL"},{value:"Other",label:"Other"}]},{id:"other_VL_alpha_".concat(n),helpText:"Test Result (".concat(a,")"),type:l.TT_TEXT,group:"test_indicator",onValue:e=>e&&e.value&&!X(e.value.toString())?(f("You must enter a modifier plus result (for example =LDL)"),!1):!0,computedValue:d,validation:e=>u.required(e),condition:e=>o(e)&&e["type_".concat(n)].value==="text"&&v(a)&&e["VL_alpha_".concat(n)].value==="Other"},{id:"malaria_result_".concat(n),helpText:"Select Test Result (".concat(a,")"),type:l.TT_SELECT,group:"test_indicator",computedValue:d,validation:e=>u.required(e),condition:e=>o(e)&&g(a),options:()=>a.match(/mrdt/i)?[{label:"Positive",value:"positive"},{label:"Negative",value:"negative"}]:[{label:"Parasites seen",value:"parasites seen"},{label:"No parasites seen",value:"no parasites seen"}]})}return t}async function A(t,r){try{return await p.createEncounter(),await p.createLabResult(t,c.id,r),B.invalidate("PATIENT_LAB_ORDERS"),y.value=[],f("Lab result saved successfully"),!0}catch(a){return console.error(a),f("Failed to save lab result"),!1}}function J(t=!1){return[{id:"test_type",helpText:"Tests without results",type:l.TT_TABLE_VIEWER,condition:()=>t?!_.isEmpty(b.value[0].other.rows):!0,init:async()=>(await R(),!0),options:()=>b.value,config:{hiddenFooterBtns:["Clear"]}}]}function ee(t,r,a){return p=new k(t,r),N(w,()=>a.value++,{deep:!0}),{testIndicators:y,testOptions:b,getLabFields:J,isValidResult:C,buildTestIndicatorFields:O,loadLabTests:R,submitLabResult:A}}export{ee as u};
