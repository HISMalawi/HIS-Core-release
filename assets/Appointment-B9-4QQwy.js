import{d as f,r as v,bJ as g,bO as I,ab as D,a9 as E,dV as S,ac as w,dR as p,c$ as d,u as y,v as h,w as N,x as P,y as u,bN as A,bu as F,dS as k,M as C,dZ as M,a5 as O}from"./index-DLUr6P7m.js";import{H as V}from"./HisStandardForm-CHh-Kykj.js";import{u as L}from"./useEncounter-DbA9tcQN.js";import{r as R}from"./commons-D2KKVktU.js";import{A as c}from"./appointment_service-DfEnOq03.js";import"./isEmpty-CxhcKDeW.js";import"./encounter_guidelines-Bg6Y9BA1.js";import"./GuidelineEngine-D6V1_Znr.js";const W=f({__name:"Appointment",setup($){const s=v([]),t=new g(-1,I.APPOINTMENT);let m=0;const{goToNextTask:_,patientDashboardUrl:T}=L((r,o)=>{t.patientID=o,t.providerID=r,m=o;const i=()=>{let a={},l=-1;const n={};return{id:"appointment",helpText:"Appointment booking",type:D.TT_DATE_PICKER,init:async()=>(l=await E.get(S.CLINIC_APPOINTMENT_LIMIT),a=await c.getJson("programs/".concat(t.programID,"/patients/").concat(o,"/next_appointment_date"),{date:t.date}),!0),defaultValue:()=>a==null?void 0:a.appointment_date,validation:e=>w.required(e),computedValue:e=>[{concept_id:p("APPOINTMENT_DATE"),value_datetime:e,obs_datetime:t.date},{concept_id:p("ESTIMATED_DATE"),value_datetime:a==null?void 0:a.appointment_date,obs_datetime:t.date}],config:{minDate:()=>t.date,maxDate:()=>a==null?void 0:a.drugs_run_out_date,supValue:e=>"".concat((n[e]||[]).length),infoItems:async e=>(n[e]||(n[e]=await c.getJson("programs/".concat(t.programID,"/booked_appointments"),{date:e,paginate:!1})),[{label:"Medication Run out Date",value:d((a==null?void 0:a.drugs_run_out_date)||"Not available")},{label:"User set appointment date",value:d(e)},{label:"Appointments",value:(n[e]||[]).length},{label:"Appointment limit (per/day)",value:l||"N/A"}]),hiddenFooterBtns:["Clear"]}}};s.value=[i()]});async function b(r,o){if(await t.createEncounter(),await t.saveObservationList(await R(o)),await A.shouldTransferToExternalFacility(t.patientID)){const i=new F(t.patientID);i.setStateDate(t.date),i.setStateId(k.TRANSFER_OUT);try{await i.updateState()}catch(a){C("Failed to transfer out patient, please do it manually for now."),console.error(a)}}await M(t.patientID),_()}return(r,o)=>(y(),h(u(O),null,{default:N(()=>[P(V,{cancelDestinationPath:u(T),onFinishAction:b,fields:s.value,skipSummary:!0},null,8,["cancelDestinationPath","fields"])]),_:1}))}});export{W as default};
