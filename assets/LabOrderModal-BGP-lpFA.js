import{d as U,r as J,u as c,v,w as n,x as s,y as m,z as p,G as a,Q as z,R as P,S as K,U as M,dx as ee,a4 as te,a3 as F,a5 as se,d8 as E,aR as ne,bk as I,O as _,br as T,ah as ie,aJ as oe,as as ae,ad as re,aq as w,k as le,cR as de,cZ as ce,cW as ue,a2 as pe,a1 as me,a0 as he,W as fe,aN as ye,ac as be,dg as ve,_ as ge,aO as Ie,aX as _e,a6 as Te,ab as o,B as f,E as C,C as S,Z as y,H as B}from"./index-uMA-i4im.js";import{L as Ce}from"./lab_order_service-BNdIELM6.js";const Oe={class:"ion-padding"},x="lab_use_small_print_label",ke=U({__name:"PrintOrderOptions",props:{onClose:Object},setup(e){const t=e,r=J(localStorage.getItem(x)==="true");function d(h,l){typeof t.onClose=="function"&&t.onClose(h,l)}function u(){localStorage.setItem(x,"".concat(r.value)),d(!0,r.value)}return(h,l)=>(c(),v(m(se),null,{default:n(()=>[s(m(z),null,{default:n(()=>[s(m(P),null,{default:n(()=>[s(m(K),null,{default:n(()=>l[2]||(l[2]=[p("Lab order print options")])),_:1})]),_:1})]),_:1}),s(m(M),null,{default:n(()=>[a("div",Oe,[s(m(ee),{size:"large",class:"his-lg-text",modelValue:r.value,"onUpdate:modelValue":l[0]||(l[0]=g=>r.value=g),checked:!1},{default:n(()=>l[3]||(l[3]=[p(" Print small label ")])),_:1},8,["modelValue"])])]),_:1}),s(m(te),null,{default:n(()=>[s(m(P),null,{default:n(()=>[s(m(F),{slot:"start",onClick:l[1]||(l[1]=g=>d(!1,!1)),color:"danger",size:"large",style:{width:"100%"}},{default:n(()=>l[4]||(l[4]=[p(" Cancel ")])),_:1}),s(m(F),{slot:"end",onClick:u,color:"success",size:"large",style:{width:"100%"}},{default:n(()=>l[5]||(l[5]=[p(" Print ")])),_:1})]),_:1})]),_:1})]),_:1}))}}),we=U({name:"Lab-modal",props:{activities:{type:Object,required:!0},ordersToday:{type:Object},onOrderAdded:{type:Object,required:!1},testFilters:{type:Array},title:{type:String,default:""}},watch:{activities:{handler(e){e&&(this.appActivities=[...e],this.getActivities())},immediate:!0}},async created(){var e;this.printCopies=(e=await E.labOrderPrintCopies())!=null?e:1,this.extendedLabsEnabled=await E.extendedLabEnabled(),this.canScanDBS=await E.canScanDBS()},methods:{onFilter(e){this.searchFilter=ne(e,this.searchFilter)},testAlreadyDoneToday(e){return!!(this.ordersToday||{})[e]},async onScanEIDbarcode(e){if(this.verifyingBarcode=!this.verifyingBarcode,!this.verifyingBarcode){if((await I.create({message:"Checking ".concat(e)})).present(),this.testTypes[this.activeIndex].accessionNumber=null,"".concat(e||"").length<=0){_("Barcode is required"),this.verifyingBarcode=!1,I.getTop().then(t=>t&&I.dismiss());return}try{await T.accessionNumExists(e)?_("Barcode ".concat(e," was already used")):this.testTypes[this.activeIndex].accessionNumber=e}catch(t){ie("Failed to confirm barcode "+e+", Please try again later",8e3)}this.verifyingBarcode=!1,I.getTop().then(t=>t&&I.dismiss())}},async onSelectTest(e,t,r){if(this.testAlreadyDoneToday(e))return _("Test was already ordered today, please void and try again!");this.searchFilter="",this.showKeyboard=!1,this.testTypes[t].isChecked=r.target.checked,this.testTypes[t].isChecked?(this.activeIndex=t,await this.setSpecimens(t)):this.removeOrder(t)},async setSpecimens(e){this.specimens=await T.getSpecimens(this.testTypes[e].name)},async getActivities(){const e=await T.getTestTypes(),t=oe.findIndex(e,{name:"HIV viral load"}),r=t!==-1?e.splice(t,1):null,d=e.sort((u,h)=>"".concat(u.name).toUpperCase()>"".concat(h.name).toUpperCase()?1:-1).filter(u=>Array.isArray(this.testFilters)?this.testFilters.includes(u.name):!0);this.testTypes=(r?[...r,...d]:d).map((u,h)=>({...u,id:h}))},async removeOrder(e){this.testTypes[e].isChecked=!1,this.testTypes[e].reason=null,this.testTypes[e].specimen=null,this.testTypes[e].specimenConcept=null,this.testTypes[e].accessionNumber=null;const t=this.finalOrders.reverse();t[0]?(this.activeIndex=t[0].id,await this.setSpecimens(this.activeIndex)):(this.activeIndex=null,this.specimens=[])},addSpecimen(e){this.testTypes[this.activeIndex].specimenConcept=e.concept_id},async postActivities(){this.isPostingOrder=!0;try{const e="".concat(this.$route.params.patient_id),r=await new Ce(parseInt(e),-1).createEncounter();if(r){const d=await T.buildLabOrders(r,this.finalOrders),u=await T.saveOrdersArray(r.encounter_id,d);if(!u)return _("Unable to save lab orders");ae.invalidate("PATIENT_LAB_ORDERS");const h=this.finalOrders.some(b=>!b.accessionNumber),g=!u.every(b=>b.tests.some(O=>["FBS","RBS"].includes(O.name)))&&h&&await re("Lab orders and encounter created!, print out your last orders?",{confirmBtnLabel:"Yes",cancelBtnLabel:"No"});typeof this.onOrderAdded=="function"&&this.finalOrders.forEach(b=>this.onOrderAdded&&this.onOrderAdded(b.name)),g&&await this.onPrintOrder(u),await this.closeModal(u)}}catch(e){_("Unable to save order: ".concat(e))}this.isPostingOrder=!1},async onPrintOrder(e){await w.dismiss();const t=await w.create({id:"print-options",component:ke,backdropDismiss:!1,cssClass:"custom-modal-backdrop",componentProps:{onClose:async(r,d)=>{await this.closeModal(e),r&&await this.printOrders(e,d)}}});await t.present(),await t.onWillDismiss()},async closeModal(e){await w.dismiss(e)},async printOrders(e,t=!1){const r=this.finalOrders.map(d=>"".concat(d.accessionNumber).toUpperCase());for(const d of e)d.tests.some(u=>["FBS","RBS"].includes(u.name))||r.includes("".concat(d.accession_number).toUpperCase())||await le(d.order_id,t,this.printCopies);await w.dismiss(e)}},computed:{searchIcon(){return de},searchColor(){return this.showKeyboard?"primary":"dark"},testTypesOnDisplay(){return this.searchFilter?new ce(this.testTypes,{threshold:.3,keys:["name"],useExtendedSearch:!0}).search(this.searchFilter).map(t=>t.item):this.testTypes},dbsBarcodeActivated(){var e,t;return this.canScanDBS&&/dbs|plasma/i.test("".concat((e=this.testTypes[this.activeIndex])==null?void 0:e.specimen))&&/hiv viral load/i.test("".concat((t=this.testTypes[this.activeIndex])==null?void 0:t.name))},isOrderComplete(){return typeof this.activeIndex!="number"||this.dbsBarcodeActivated&&/dbs/i.test(this.testTypes[this.activeIndex].specimen)&&!this.testTypes[this.activeIndex].accessionNumber?!1:this.extendedLabsEnabled?!!this.testTypes[this.activeIndex].reason:(this.testTypes[this.activeIndex].specimenConcept||this.testTypes[this.activeIndex].specimen)&&this.testTypes[this.activeIndex].reason},selectedOrders(){return this.testTypes.filter(e=>e.isChecked===!0)},finalOrders(){return this.selectedOrders.filter(e=>this.dbsBarcodeActivated&&/dbs/i.test(e.specimen)&&!e.accessionNumber?!1:e.reason&&(e.specimen&&!this.extendedLabsEnabled||this.extendedLabsEnabled))},testReasons(){let e=this.reasons;return this.testTypes[this.activeIndex].name.match(/Viral load/i)&&(e=e.filter(t=>t!=="Stat"),e=e.concat(["Follow up after Low Level Viremia","Follow up after High Viral Load"])),e}},mounted(){this.getActivities()},data(){return{printCopies:1,isPostingOrder:!1,searchFilter:"",showKeyboard:!1,keyboardLayout:ue,canScanDBS:!1,verifyingBarcode:!1,content:"Content",extendedLabsEnabled:!1,appActivities:[],testTypes:[],specimens:[],reasons:["Routine","Targeted","Confirmatory","Stat","Repeat / Missing"],activeIndex:null}},components:{IonButton:F,IonContent:M,IonHeader:z,IonTitle:K,IonInput:pe,IonToolbar:P,IonLabel:me,IonList:he,IonItem:fe,BarcodeInput:ye,IonCheckbox:be,IonRadioGroup:ve,IonRow:ge,HisKeyboard:Ie,IonIcon:_e}}),Se={key:0},Be={key:1},Le={class:"ion-margin-bottom"},Ae={key:1},$e={class:"his-md-text side-title"},Ee={style:{background:"lightyellow",height:"34vh"}},Pe={class:"his-sm-text"};function Fe(e,t,r,d,u,h){const l=o("ion-title"),g=o("ion-icon"),b=o("ion-input"),O=o("ion-toolbar"),H=o("ion-header"),L=o("ion-label"),W=o("ion-checkbox"),A=o("ion-item"),N=o("ion-list"),D=o("ion-col"),R=o("ion-radio"),V=o("ion-radio-group"),j=o("ion-text"),q=o("BarcodeInput"),$=o("ion-button"),G=o("ion-row"),Y=o("ion-grid"),Z=o("his-keyboard"),Q=o("ion-content"),X=o("ion-footer");return c(),f(C,null,[s(H,null,{default:n(()=>[s(O,null,{default:n(()=>[s(l,{class:"his-lg-text",slot:"start"},{default:n(()=>t[5]||(t[5]=[p(" Lab orders ")])),_:1}),s(g,{size:"large",slot:"end",icon:e.searchIcon,color:e.searchColor},null,8,["icon","color"]),s(b,{readonly:!0,value:e.searchFilter,disabled:e.activeIndex&&!e.isOrderComplete,color:e.searchColor,onClick:t[0]||(t[0]=()=>e.showKeyboard=!e.showKeyboard),placeholder:"Search for tests",style:{"text-align":"left",width:"35%"},class:"input_display",slot:"end"},null,8,["value","disabled","color"])]),_:1})]),_:1}),s(Q,{style:{overflow:"hidden",background:"grey",height:"70vh"}},{default:n(()=>[s(Y,null,{default:n(()=>[s(G,null,{default:n(()=>[s(D,{size:"6"},{default:n(()=>[s(N,{style:{overflowY:"auto",height:"75vh"}},{default:n(()=>[(c(!0),f(C,null,S(e.testTypesOnDisplay,i=>(c(),v(A,{class:"his-sm-text",key:i.id,color:e.activeIndex===i.id?"primary":"none",disabled:e.activeIndex!=null&&e.activeIndex!==i.id&&!e.isOrderComplete,detail:""},{default:n(()=>[s(L,{"text-wrap":""},{default:n(()=>[e.testAlreadyDoneToday(i.name)?(c(),f("s",Se,y(i.name),1)):(c(),f("span",Be,y(i.name),1))]),_:2},1024),s(W,{slot:"start",checked:i.isChecked,onIonChange:k=>e.onSelectTest(i.name,i.id,k)},null,8,["checked","onIonChange"])]),_:2},1032,["color","disabled"]))),128))]),_:1})]),_:1}),e.activeIndex!=null&&e.selectedOrders.length>0?(c(),v(D,{key:0,style:{overflowY:"auto",height:"79vh"}},{default:n(()=>[a("div",Le,[e.extendedLabsEnabled?B("",!0):(c(),v(N,{key:0},{default:n(()=>[s(V,{modelValue:e.testTypes[e.activeIndex].specimen,"onUpdate:modelValue":t[1]||(t[1]=i=>e.testTypes[e.activeIndex].specimen=i)},{default:n(()=>[t[6]||(t[6]=a("div",{class:"his-md-text side-title"}," Select specimen ",-1)),(c(!0),f(C,null,S(e.specimens,i=>(c(),v(A,{key:i},{default:n(()=>[s(L,null,{default:n(()=>[p(y(i.name),1)]),_:2},1024),s(R,{slot:"start",value:i.name,onClick:k=>e.addSpecimen(i)},null,8,["value","onClick"])]),_:2},1024))),128))]),_:1},8,["modelValue"])]),_:1})),e.dbsBarcodeActivated?(c(),f("div",Ae,[a("div",$e,[t[7]||(t[7]=p(" Barcode ID: ")),s(j,{color:e.testTypes[e.activeIndex].accessionNumber?"success":"dark"},{default:n(()=>[a("b",null,y(e.testTypes[e.activeIndex].accessionNumber||"None"),1)]),_:1},8,["color"])]),s(q,{size:"small",onOnScan:t[2]||(t[2]=i=>e.onScanEIDbarcode(i))})])):B("",!0),s(V,{modelValue:e.testTypes[e.activeIndex].reason,"onUpdate:modelValue":t[3]||(t[3]=i=>e.testTypes[e.activeIndex].reason=i)},{default:n(()=>[t[8]||(t[8]=a("div",{class:"his-md-text side-title"}," Main test(s) reason ",-1)),(c(!0),f(C,null,S(e.testReasons,i=>(c(),v(A,{class:"his-sm-text",key:i},{default:n(()=>[s(L,null,{default:n(()=>[p(y(i),1)]),_:2},1024),s(R,{slot:"start",value:i},null,8,["value"])]),_:2},1024))),128))]),_:1},8,["modelValue"])]),a("div",Ee,[a("table",Pe,[t[10]||(t[10]=a("thead",null,[a("tr",null,[a("th",null,"Test"),a("th",null,"Specimen"),a("th",null,"Reason"),a("th",null,"Action")])],-1)),a("tbody",null,[(c(!0),f(C,null,S(e.finalOrders,(i,k)=>(c(),f("tr",{key:k},[a("td",null,y(i.name),1),a("td",null,y(i.specimen||"N/A"),1),a("td",null,y(i.reason),1),a("td",null,[s($,{onClick:Ne=>e.removeOrder(i.id),slot:"end",color:"danger"},{default:n(()=>t[9]||(t[9]=[p("X")])),_:2},1032,["onClick"])])]))),128))])])])]),_:1})):B("",!0)]),_:1})]),_:1}),e.showKeyboard?(c(),v(Z,{key:0,kbConfig:e.keyboardLayout,onKeyPress:e.onFilter,disabled:!1},null,8,["kbConfig","onKeyPress"])):B("",!0)]),_:1}),s(X,null,{default:n(()=>[s(O,null,{default:n(()=>[s($,{onClick:e.postActivities,size:"large",slot:"end",disabled:e.isPostingOrder||e.finalOrders.length===0},{default:n(()=>t[11]||(t[11]=[p(" Place orders ")])),_:1},8,["onClick","disabled"]),s($,{disabled:e.isPostingOrder,onClick:t[4]||(t[4]=i=>e.closeModal([])),size:"large",slot:"start",color:"danger"},{default:n(()=>t[12]||(t[12]=[p(" Close ")])),_:1},8,["disabled"])]),_:1})]),_:1})],64)}const Ve=Te(we,[["render",Fe],["__scopeId","data-v-a76fc1a4"]]);export{Ve as L};
