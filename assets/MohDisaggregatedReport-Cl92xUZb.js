import{d as j,I as H,c4 as L,K as h,E as V,N as Q,cb as C,a9 as z,n as K,q as E,cz as G,t as W,c6 as B,O as F,ab as X,c5 as Y,c7 as J,c9 as Z,c8 as ee,_ as te,r as $,o as ae,c as re,w as oe,b as O}from"./index-BF3WrZAg.js";import{D as ne}from"./disaggregated_service-DBdN0esQ.js";import{v as se}from"./TableView-Fg-qLjAX.js";import{A as ie}from"./ArtDrilldown-DnkawA7L.js";import{R as I}from"./regimen_report_service-BiHl2eHG.js";import{M as le}from"./moh_cohort_service-B__eZWPc.js";import{R as ce}from"./ReportErrors-Bgm9c8TP.js";import"./PopupKeyboard-CvMQ_C5X.js";import"./SIngleTouchField-CA6430eG.js";import"./dynamic-import-helper-Bsjrd6Ro.js";import"./TouchScreenForm-DEXYdl71.js";import"./ToolbarMediumCard-CJsYT4iG.js";import"./Transformers-BPPLlH12.js";import"./ViewPort-J1DvtW6Z.js";import"./HisKeypad-JUwZV1nK.js";import"./BaseKeyboard-CDZD4guH.js";import"./KbLayouts-VRA-vjeH.js";import"./KbHandler-BuQ4TFU6.js";import"./fuse-YdZE3OCN.js";import"./Export-DX9Hlc8a.js";import"./HisKeyboard-DWUKKpPK.js";import"./HisKbConfigurations-GhFQZvlg.js";const ge=j({components:{IonPage:H,IonLoading:L,v2Datatable:se},setup(){const i=h(!1),_=h([]),b=h(""),D=h(""),y=h(!1),t=new ne,p=new le,l=h([]),c=V(),P=async r=>{(await F.create({component:ie,backdropDismiss:!1,cssClass:"large-modal",componentProps:{...r,subtitle:b.value,onFinish:()=>F.getTop().then(a=>a&&F.dismiss())}})).present()},A=(r,a)=>({ref:a,label:r,defaultValue:"0",toValue:e=>e.length,tdClick:async e=>{e.refData.length&&P({patientIdentifiers:e.refData,title:"".concat(e.data.age_group," ").concat(e.data.gender," ").concat(e.column.label)})}}),T=[[{label:"#",ref:"index"},{label:"Age group",ref:"age_group"},{label:"Gender",ref:"gender"},A("TX curr (receiving ART)","tx_curr"),...I.reduce((r,a)=>[...r,A(a,a)],[]),A("Unknown","N/A"),A("Total (regimen)","regimen_total")]],N=[...I,"N/A"].reduce((r,a)=>({...r,[a]:[]}),{}),S=async()=>w(await K("Do you want to rebuild report?")),x=function(r){const a=l.value.findIndex(e=>e.id===r.id);a!==-1?l.value[a]=r:l.value.push(r)},R=async function(r){const a="validationErrors";(await F.create({id:a,component:ce,backdropDismiss:!1,cssClass:"large-modal",componentProps:{errors:r}})).present(),x({id:a,text:"<b>".concat(r.length,"</b> validation errors detected"),icon:Z,color:"danger",action:()=>R(r)})},U=async r=>{const a={total_alive_and_on_art:{param:r.length,check:(u,v)=>u!=v,error:(u,v)=>"\n                        Total alive of <b>".concat(v,"</b>\n                        Does not match total alive of <b>").concat(u,"</b> on MOH report\n                    ")}};p.validateIndicators(a,u=>{u.length?R(u):x({id:"reportOk",text:"<b>Report is consistent</b>",icon:ee,color:"success"})})===-1&&R(["Report not validated. Run the MoH cohort report for similar reporting period and then run this report"])},w=async(r=!1)=>{var v,M,q;if(!i.value)return E("Unable to generate report, return to cohort report");y.value=!0;const a=["Pregnant","Breastfeeding"],e={F:{label:"Female",rows:[],aggregate:{},excludedAgeGroups:a},M:{label:"Male",rows:[],aggregate:{},excludedAgeGroups:a},FP:{label:"Pregnant",rows:[],aggregate:{},gender:"F",ageGroup:"All",genderDisplay:"FP",excludedAgeGroups:[...G,"Breastfeeding"]},FBF:{label:"Breastfeeding",rows:[],aggregate:{},gender:"F",ageGroup:"All",genderDisplay:"FBF",excludedAgeGroups:[...G,"Pregnant"]}},u=(s=!1)=>{const g=Object.keys(e.FP.aggregate).reduce((d,n)=>({...d,[n]:[...e.FP.aggregate[n]||[],...e.FBF.aggregate[n]||[]]}),{}),o=Object.keys(e.F.aggregate).reduce((d,n)=>({...d,[n]:d[n].filter(k=>Array.isArray(g[n])?!g[n].includes(k):!0)}),e.F.aggregate);_.value=[...e.F.rows,...e.M.rows,{age_group:"All",gender:"Male",...e.M.aggregate},...e.FP.rows,{age_group:"All",gender:"FNP",...o},...e.FBF.rows];const m=X.uniq([...e.M.aggregate.tx_curr||[],...e.F.aggregate.tx_curr||[]]),f={text:"Total alive and on ART: <b>".concat(m.length,"</b>"),icon:Y,color:"primary",action:()=>P({patientIdentifiers:m,title:"Total alive and on ART: ".concat(m.length)})};s?(l.value=[f],U(m)):l.value=[f,{text:D.value,icon:J,color:"dark"}]};try{if(t.setRebuildOutcome(r),!await t.init())return W("Unable to initialise report");for(const s of[...G,...a]){D.value="Processing <b>".concat(s,"</b>"),t.setAgeGroup(s);const g=await t.getCohort();t.setRebuildOutcome(!1);for(const o of Object.keys(e)){if((e[o].excludedAgeGroups||[]).includes(s))continue;t.setGender(o),e[o].ageGroup&&t.setAgeGroup(e[o].ageGroup);const m=await t.getRegimenDistribution(),f={age_group:((v=e[o])==null?void 0:v.ageGroup)||s,gender:((M=e[o])==null?void 0:M.genderDisplay)||e[o].label,...g[s]?g[s][((q=e[o])==null?void 0:q.gender)||o]:{},...N,...m,regimen_total:Object.values(m).flat(1)};e[o].rows.push(f),e[o].aggregate=Object.keys(f).reduce((d,n)=>Array.isArray(f[n])?{...d,[n]:[...d[n]||[],...f[n]]}:d,e[o].aggregate),u(!1)}}u(!0),_.value=_.value.map((s,g)=>({index:g+1,...s}))}catch(s){const g="Unable to generate report!";E(g),l.value=[{text:g,color:"danger",icon:B,action:function(){l.value=[{text:"Exception occured: <b>".concat(s,"</b>"),color:"danger",icon:B}]}}]}y.value=!1,D.value=""};return Q(()=>{i.value=!!(c.query.start_date&&c.query.end_date&&c.query.quarter),i.value&&(t.setStartDate("".concat(c.query.start_date)),t.setEndDate("".concat(c.query.end_date)),t.setOccupation("".concat(c.query.occupation)),p.setOccupation(t.occupation),p.setStartDate(t.startDate),p.setEndDate(t.endDate),b.value="".concat(C(t.startDate)," to ").concat(C(t.endDate)),c.query.quarter&&(t.setQuarter("".concat(c.query.quarter)),p.setQuarter(t.quarter),b.value="".concat(t.quarter==="Custom"?b.value:t.quarter)),w())}),{Img:z,onRegenerate:S,headerBadge:l,reportData:_,isLoading:y,generate:w,columns:T,period:b}}});function ue(i,_,b,D,y,t){const p=$("ion-loading"),l=$("v2Datatable"),c=$("ion-page");return ae(),re(c,null,{default:oe(()=>[O(p,{"is-open":i.isLoading,message:"Please wait.."},null,8,["is-open"]),O(l,{"icon-url":i.Img("login-logos/Malawi-Coat_of_arms_of_arms.png"),title:"Disaggregated report","report-prefix":"MoH",subtitle:i.period,columns:i.columns,columnData:i.reportData,rowsPerPage:100,onRefresh:i.onRegenerate,headerBadge:i.headerBadge},null,8,["icon-url","subtitle","columns","columnData","onRefresh","headerBadge"])]),_:1})}const Be=te(ge,[["render",ue]]);export{Be as default};
