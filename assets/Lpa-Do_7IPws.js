import{d as y,K as v,b5 as S,cV as C,S as L,V as A,o as N,c as M,w as B,b as P,cl as I,cX as b,cY as O,ad as V,I as F,ag as f}from"./index-BCTN_bnC.js";import{H as k}from"./HisStandardForm-CaDwl-hA.js";import{u as w}from"./useEncounter-CDUT-p5Y.js";import{F as d}from"./dynamic-import-helper-BkBZiFw5.js";import{r as $}from"./commons-BDvZ1JFN.js";import{g as i,a as U}from"./util-CyjuS_4X.js";import"./TouchScreenForm-TKB9q3ZD.js";import"./ToolbarMediumCard-O_J6wu7C.js";import"./Transformers-BPPLlH12.js";import"./ViewPort-BCxYiILf.js";import"./isEmpty-OXtHK5dz.js";import"./_Set-VKtKUQAI.js";import"./_setToArray-BLmuRUHx.js";import"./encounter_guidelines-DZpIPlYY.js";import"./GuidelineEngine-D6V1_Znr.js";const se=y({__name:"Lpa",setup(x){const E=v([]),n=new S(-1,C.LAB_RESULTS),h=v(),{goToNextTask:u,patientDashboardUrl:R,facts:g}=w((c,l,p)=>{n.patientID=l,n.providerID=c,h.value=p;const m=()=>({id:"sampleResult",helpText:"Sample Result:",type:d.TT_SELECT,computedValue:t=>[{concept_id:i("Lab test result"),value_coded:i("".concat(t.value)),obs_datetime:n.date},{concept_id:i("TB_STATUS"),value_coded:i(t.other),obs_datetime:n.date},{concept_id:i("BACTERIOLOGICALLY_DIAGNOSED"),value_coded:i("YES_ANSWER"),obs_datetime:n.date},{concept_id:i("PROCEDURE_TYPE"),value_coded:i("LPA"),obs_datetime:n.date},...t.other==="POSITIVE"?[{concept_id:i("TB_TYPE"),value_coded:i("PULMONARY_TB"),obs_datetime:n.date}]:[]],options:()=>[{value:"MTB_NOT_DETECTED",label:"MTB not detected",other:"NEGATIVE"},{value:"MTB_DETECTED",label:"MTB detected",other:"POSITIVE"},{value:"MTB_INVALID",label:"Invalid",other:"NEGATIVE"}]}),_=()=>({id:"treatmentType",helpText:"Select treatment drugs:",type:d.TT_SELECT,condition:t=>t.sampleResult.value==="MTB_DETECTED",options:()=>[{value:"FIRST_LINE",label:"Firstline Drugs"},{value:"SECOND_LINE",label:"DR TB Drugs"}]}),T=()=>({id:"sampleResistance",helpText:"MTB Resistance:",type:d.TT_MULTIPLE_SELECT,condition:t=>t.treatmentType.value==="FIRST_LINE",onValueUpdate:(t,a)=>t.map(e=>{if(a.isChecked){if(/no resistance/i.test("".concat(a.label))&&e.label!=a.label)return e.isChecked=!1,e;/no resistance/i.test("".concat(a.label))||/no resistance/i.test("".concat(e.label))&&(e.isChecked=!1)}return e}),computedValue:t=>{const a=[];return t.length===1?a.push({concept_id:i("Resistance classification"),value_coded:i("Mono drug resistant"),obs_datetime:n.date}):t.length>1&&a.push({concept_id:i("Resistance classification"),value_coded:i("Multi drug resistant"),obs_datetime:n.date}),t.some(e=>/rif/i.test(e.label))&&a.push({concept_id:i("Rifampicin resistance confirmed"),value_coded:i("YES_ANSWER"),obs_datetime:n.date}),[...a,...t.filter(e=>!/no resistance/i.test("".concat(e.value))).map(e=>({concept_id:i("TB_DRUG_RESISTANT"),value_coded:U("".concat(e.value)),obs_datetime:n.date}))]},options:()=>[{value:"Rifampicin (300mg)",label:"Rifampicin Resistant"},{value:"Isoniazid (300mg)",label:"Isoniazid Resistant"},{value:"No Resistance",label:"No Resistance"}]}),s=()=>{const t=[];return{id:"sampleSecondlineDrugs",helpText:"MTB Resistance:",type:d.TT_MULTIPLE_SELECT,init:async()=>{try{const a=[];(await L.getJson("programs/".concat(n.programID,"/tb_regimen_group"),{patient:l,regimen_group:"second-line-concepts"})).forEach(r=>{!a.includes(r.concept_id)&&!/none|other non-coded/i.test(r.name)&&(a.push(r.concept_id),t.push({label:r.name,value:r.concept_id}))})}catch(a){return!1}return!0},onValueUpdate:(a,e)=>a.map(r=>{if(e.isChecked){if(/no resistance/i.test("".concat(e.label))&&r.label!=e.label)return r.isChecked=!1,r;/no resistance/i.test("".concat(e.label))||/no resistance/i.test("".concat(r.label))&&(r.isChecked=!1)}return r}),computedValue:a=>{const e=[];return a.length===1?e.push({concept_id:i("Resistance classification"),value_coded:i("Mono drug resistant"),obs_datetime:n.date}):a.length>1&&e.push({concept_id:i("Resistance classification"),value_coded:i("Multi drug resistant"),obs_datetime:n.date}),[...e,...a.filter(r=>!/no resistance/i.test("".concat(r.value))).map(r=>({concept_id:i("TB_DRUG_RESISTANT"),value_coded:r.value,obs_datetime:n.date}))]},options:()=>[...t,{value:"No Resistance",label:"No Resistance"}],condition:a=>a.treatmentType.value==="SECOND_LINE"}},o=()=>({id:"sampleResultDate",helpText:"Sample Result Date:",type:d.TT_FULL_DATE,validation:t=>A.required(t),computedValue:t=>({concept_id:i("RESULT_DATE"),value_datetime:t.value,obs_datetime:n.date})});E.value=[m(),_(),T(),s(),o()]});async function D(c,l){var _,T;await n.createEncounter(),await n.saveObservationList(await $(l));const p={sampleIsInvalid:((_=c.sampleResult)==null?void 0:_.value)==="MTB_INVALID",tbPositive:((T=c.sampleResult)==null?void 0:T.value)==="POSITIVE",onTreatment:b.isOnTreatment(g.outcome),tptEligible:!b.isOnTreatment(g.outcome)&&h.value.getAge()>=0&&h.value.getAge()<O,inhResistance:(c.sampleResistance||[]).some(s=>s.label==="Isoniazid Resistant"),rrResistance:(c.sampleResistance||[]).some(s=>s.label==="Rifampicin Resistant")},m={"suggest to order another LPA test if sample is invalid":{title:"Results are invalid",message:"Do you want to order another LPA test?",yes:()=>f.push("/tb/lab/".concat(n.patientID,"?test=LPA")),no:()=>f.push("/tb/examination/".concat(n.patientID)),mandatoryCondition:{sampleIsInvalid:s=>s}},"try a different examination when negative result":{title:"Negative patient",message:"Do you want to try a different examination?",yes:()=>f.push("/tb/lab/".concat(n.patientID)),no:()=>f.push(R.value),mandatoryCondition:{tbPositive:s=>!s,onTreatment:s=>!s,tptEligble:s=>!s}},"go to other encounters if no drug resistance was found":{action:()=>u(),mandatoryCondition:{inhResistance:s=>!s,rrResistance:s=>!s}},"enroll in MDR program if drug resistance is found":{title:"Start drug resistance program",message:"Drug resistance has been detected, do you want to enroll patient is Drug Resistance program?",yes:async()=>{await b.enrollMDR(n.patientID),u()},no:()=>u(),eitherConditionMatch:{inhResistance:s=>s,rrResistance:s=>s}}};for(const s of Object.keys(m)){const o=m[s];let t=!0,a=!0;if(o.mandatoryCondition&&(a=Object.keys(o.mandatoryCondition).every(e=>o.mandatoryCondition[e](p[e]))),o.eitherConditionMatch&&(t=Object.keys(o.eitherConditionMatch||{}).some(e=>o.eitherConditionMatch[e](p[e]))),t&&a){if(typeof o.yes=="function"&&typeof o.no=="function")return await V(o.title,"",o.message,[{name:"Yes",slot:"start",color:"success"},{name:"No",slot:"start",color:"primary"}])==="Yes"?o.yes():o.no();if(typeof o.action=="function")return o.action()}}u()}return(c,l)=>(N(),M(I(F),null,{default:B(()=>[P(k,{cancelDestinationPath:I(R),onFinishAction:D,fields:E.value,skipSummary:!0},null,8,["cancelDestinationPath","fields"])]),_:1}))}});export{se as default};
