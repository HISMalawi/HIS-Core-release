import{d as j,ar as A,n as F,l as z,ad as L,k as K,ac as U,I as q,a4 as Z,m as J,c0 as R,z as X,cC as G,aZ as k,s as Q,am as w,bd as W,aE as Y,al as B,ak as x,a as D,w as s,ap as d,b as o,e as a,g as n,h as i,a6 as S,a9 as p,aa as h,j as m,t as C}from"./index-Ds0zDBhU.js";import{_ as ee}from"./EncounterMixin.vue_vue_type_script_lang-BAQU7yKM.js";import{H as N,B as P}from"./htn_service-Mmvo1xmr.js";import"./encounter_guidelines-B4wssV7B.js";import"./GuidelineEngine-D6V1_Znr.js";import"./HisStandardForm-CrmIN601.js";const te=j({mixins:[ee],components:{ViewPort:R,IonToolbar:J,IonHeader:Z,IonContent:q,IonRow:U,IonButton:K,IonCol:L,IonFooter:z,IonPage:F,IonCheckbox:A},watch:{ready:{async handler(t){if(t){this.HTN=new P(this.patientID,this.providerID),this.drugs=this.HTN.getDrugs();const{drugs:e,notes:r}=await this.HTN.getCurrentDrugs();this.setPreviousBpDrugs(e),this.setPreviousBpNotes(r),this.canClearHtnSessionPrescription=this.patientHasHtnSessionKey()}},immediate:!0}},data:()=>({HTN:{},drugs:null,otherBpDrugs:[],canClearHtnSessionPrescription:!1}),methods:{clearPrescriptionInSession(){sessionStorage.removeItem(N.Prescription),this.canClearHtnSessionPrescription=!1},showMoreBpDrugs(){Y([{id:"drug",helpText:"Select BP drugs",type:w.TT_MULTIPLE_SELECT,init:async()=>{k.isEmpty(this.otherBpDrugs)&&(await P.getAllBpDrugs()).forEach(e=>{this.otherBpDrugs.push({label:e.name,value:e.drug_id,other:e})});const t=this.getStandardSelectedDrugs().map(e=>e.drug_id);return this.otherBpDrugs=this.otherBpDrugs.map(e=>({...e,isChecked:t.includes(e.value)})),!0},onValueUpdate:t=>(Object.keys(this.drugs).forEach(e=>this.drugs[e].drugs=this.drugs[e].drugs.map(r=>({...r,selected:t.some(u=>u.value===r.drugID&&u.isChecked)}))),t),options:()=>this.otherBpDrugs,validation:t=>B.required(t),config:{showKeyboard:!0}},{id:"dosage",helpText:"Custom dose",type:w.TT_DOSAGE_INPUT,condition:t=>!k.isEmpty(t.drug),validation:t=>B.required(t)?["Drugs are not available"]:t.some(({other:e})=>e.am<=0&&e.noon<=0&&e.pm<=0)?["Missing dosage configuration on some drugs"]:null,computedValue:t=>t.map(e=>e.other),options:t=>t.drug.map(e=>({label:e.label,value:e.value,other:{drug_id:e.other.drug_id,drug_name:e.label,barcodes:e.other.barcodes,units:e.other.units,am:0,noon:0,pm:0,frequency:"Daily (QOD)"}}))}],(t,e)=>this.cacheSelectedDrugsAndProceed(e.dosage))},patientHasHtnSessionKey(){try{const t=sessionStorage.getItem(N.Prescription);if(t)return JSON.parse(t)[this.patientID]}catch(t){console.warn(t)}return!1},removeNote(t,e){this.drugs[t].notes.splice(e,1)},launchNotePad(t){this.showModal({id:"note",helpText:"Add notes for ".concat(t),type:w.TT_TEXT},e=>{e&&this.drugs[t].notes.push({date:W.getSessionDate(),description:e.value||"",drugID:this.drugs[t].drugs[0].drugID,isNewNote:!0})})},async onFinish(){const t=Object.values(this.drugs).filter(e=>!k.isEmpty(e.notes)).map(e=>e.notes).reduce((e,r)=>e.concat(r),[]).filter(e=>e.isNewNote).map(e=>this.HTN.buildObs("Clinician notes",{value_text:e.description,value_drug:e.drugID}));if(!k.isEmpty(t))try{await this.HTN.createEncounter(),await this.HTN.saveObservationList(await Promise.all(t))}catch(e){return Q("Unable to save notes ".concat(e))}this.cacheSelectedDrugsAndProceed(this.getStandardSelectedDrugs())},getStandardSelectedDrugs(){return this.selectedDrugs.map(t=>k.find(P.htnDrugReferences(),{drug_id:t.drugID}))},cacheSelectedDrugsAndProceed(t){const e={};e[this.patientID]=t,sessionStorage.setItem(N.Prescription,JSON.stringify(e)),this.$router.push("/art/encounters/prescriptions/".concat(this.patientID))},async showModal(t,e){(await X.create({component:G,backdropDismiss:!1,cssClass:"full-modal",componentProps:{dismissType:"modal",currentField:t,onFinish:e}})).present()},setPreviousBpNotes(t){for(const e in t)this.drugs[e].notes=Object.keys(t[e]).map(r=>t[e][r].map(u=>({date:r,description:u,isNewNote:!1}))).reduce((r,u)=>r.concat(u),[])},setPreviousBpDrugs(t){t.forEach(e=>{for(const r in this.drugs)this.drugs[r].drugs.forEach((u,y)=>{e.drug_id===u.drugID&&(this.drugs[r].drugs[y].current=!0,this.drugs[r].drugs[y].selected=!0,this.drugs[r].selected=e.drug_id)})})},selectDrug(t,e,r){this.drugs[t].drugs.forEach((u,y)=>{this.drugs[t].drugs[y].selected=!1}),this.drugs[t].drugs[e].selected=r.detail.checked}},computed:{selectedDrugs(){return this.drugs?Object.values(this.drugs).map(t=>t.drugs).reduce((t,e)=>t.concat(e),[]).filter(t=>t.selected):[]}}}),se={key:0,class:"view-port-content"},oe={id:"main-table",style:{width:"100%"}},ne={id:"table-notes",style:{width:"100%"}},re={class:"table-inner-notes",id:"notes-HCTZ"},ae={class:"date-td today-td"},ie={class:"date-td today-td"};function le(t,e,r,u,y,ue){const b=d("ion-col"),v=d("ion-row"),T=d("ion-toolbar"),E=d("ion-header"),H=d("ion-checkbox"),_=d("ion-button"),O=d("view-port"),$=d("ion-content"),M=d("ion-footer"),V=d("ion-page");return o(),D(V,null,{default:s(()=>[a(E,null,{default:s(()=>[a(T,null,{default:s(()=>[a(v,null,{default:s(()=>[a(b,null,{default:s(()=>[...e[0]||(e[0]=[n("label",{class:"his-title"}," Prescribe BP drugs ",-1)])]),_:1})]),_:1})]),_:1})]),_:1}),a($,null,{default:s(()=>[a(O,null,{default:s(()=>[t.drugs?(o(),i("div",se,[n("table",oe,[n("tr",null,[e[1]||(e[1]=n("th",null," ",-1)),(o(!0),i(p,null,h(t.drugs,(c,l)=>(o(),i("th",{key:l},[m(C(l)+" ",1),a(v,null,{default:s(()=>[(o(!0),i(p,null,h(c.drugs,(g,f)=>(o(),D(b,{class:"col-borders",key:f},{default:s(()=>[m(C(g.amount||"0mg"),1)]),_:2},1024))),128))]),_:2},1024)]))),128))]),n("tr",null,[e[2]||(e[2]=n("td",{class:"td-remaining td-title"},[n("span",null,"New/Current")],-1)),(o(!0),i(p,null,h(t.drugs,(c,l)=>(o(),i("td",{key:l,class:"td-current td-value"},[a(v,null,{default:s(()=>[(o(!0),i(p,null,h(c.drugs,(g,f)=>(o(),D(b,{key:f},{default:s(()=>[a(H,{checked:g.selected,onIonChange:I=>t.selectDrug(l,f,I)},null,8,["checked","onIonChange"])]),_:2},1024))),128))]),_:2},1024)]))),128))]),n("tr",null,[e[4]||(e[4]=n("td",{class:"td-remaining td-title"},[n("span",null," ")],-1)),(o(!0),i(p,null,h(Object.keys(t.drugs),(c,l)=>(o(),i("td",{class:"td-remaining td-value",key:l},[a(v,null,{default:s(()=>[a(b,null,{default:s(()=>[a(_,{onClick:g=>t.launchNotePad(c),color:"warning"},{default:s(()=>[...e[3]||(e[3]=[m(" Add notes ",-1)])]),_:1},8,["onClick"])]),_:2},1024)]),_:2},1024)]))),128))])]),e[8]||(e[8]=n("p",null,null,-1)),n("table",ne,[e[6]||(e[6]=n("caption",{style:{"font-size":"1.2em"}}," Notes ",-1)),e[7]||(e[7]=n("p",null,null,-1)),n("tr",null,[(o(!0),i(p,null,h(t.drugs,(c,l)=>(o(),i("th",{style:{width:"25%"},key:l},[n("span",null,C(l),1)]))),128))]),n("tr",null,[(o(!0),i(p,null,h(Object.keys(t.drugs),(c,l)=>(o(),i("td",{id:"HCTZ",style:{"padding-top":"2px !important"},valign:"top",key:l},[n("table",re,[(o(!0),i(p,null,h(t.drugs[c].notes,(g,f)=>(o(),i("tr",{key:f},[n("td",ae,C(g.date),1),n("td",ie,C(g.description),1),n("td",null,[g.isNewNote?(o(),D(_,{key:0,color:"danger",onClick:I=>t.removeNote(c,f)},{default:s(()=>[...e[5]||(e[5]=[m(" X ",-1)])]),_:1},8,["onClick"])):S("",!0)])]))),128))])]))),128))])])])):S("",!0)]),_:1})]),_:1}),a(M,null,{default:s(()=>[a(T,{color:"dark"},{default:s(()=>[a(_,{size:"large",color:"danger",slot:"start",onClick:t.gotoPatientDashboard},{default:s(()=>[...e[9]||(e[9]=[m(" Cancel ",-1)])]),_:1},8,["onClick"]),a(_,{onClick:t.showMoreBpDrugs,size:"large",slot:"end"},{default:s(()=>[...e[10]||(e[10]=[m(" More Drugs ",-1)])]),_:1},8,["onClick"]),t.canClearHtnSessionPrescription?(o(),D(_,{key:0,size:"large",color:"warning",slot:"end",onClick:t.clearPrescriptionInSession},{default:s(()=>[...e[11]||(e[11]=[m(" Clear Session Prescription ",-1)])]),_:1},8,["onClick"])):S("",!0),t.selectedDrugs&&t.selectedDrugs.length>0?(o(),D(_,{key:1,size:"large",color:"success",slot:"end",onClick:t.onFinish},{default:s(()=>[...e[12]||(e[12]=[m(" Continue ",-1)])]),_:1},8,["onClick"])):S("",!0)]),_:1})]),_:1})]),_:1})}const fe=x(te,[["render",le],["__scopeId","data-v-00ea3049"]]);export{fe as default};
