System.register(["./HisStandardForm-legacy-OekRIZB_.js","./index-legacy-CNrLGT3P.js","./patient_lab_result_service-legacy-BSfbhdAA.js"],(function(e,t){"use strict";var i,a,s,l,r,n,o,u,d,c,h,p,m,v,T,_,b,y,f;return{setters:[e=>{i=e.H},e=>{a=e.d,s=e.T,l=e.U,r=e.q,n=e.b5,o=e.n,u=e.F,d=e.V,c=e.t,h=e.ah,p=e.H,m=e.ai,v=e.S,T=e._,_=e.r,b=e.o,y=e.c},e=>{f=e.P}],execute:function(){const t=a({components:{HisStandardForm:i},data:()=>({fieldComponent:"",labResult:{},hisFormKey:0,patient:{},fields:[],selectedTest:{},testOptions:[],testIndicators:[]}),watch:{$route:{async handler({params:e}){e&&e.patient_id&&(this.patient=e.patient_id,this.labResult=new f(this.patient),await this.initData(),this.fields=this.getFields())},deep:!0,immediate:!0}},methods:{async onFinish(e,t){try{const e=Object.values(t).filter((e=>"result_indicator"===e.tag&&e.measures)).map((e=>e.measures));this.labResult.setTestID(this.selectedTest.value),this.labResult.setResultDate(t.result_date),await this.labResult.createEncounter(),await this.labResult.createLabResult(e),s.invalidate("PATIENT_LAB_ORDERS"),this.testOptions=[],this.selectedTest={},this.testIndicators=[],await this.initData(),this.hisFormKey=Math.floor(5e3*Math.random()),l("Lab result saved!")}catch(i){r(`${i}`),console.error(i)}},generateTestIndicatorsFields(){return this.testIndicators.reduce(((e,t)=>e.concat(this.buildTestIndicatorFields(t.indicatorId,t.indicatorName,t.specimen,t.testId))),[])},async validateVLresults(e,t,i){if("HIV viral load"!==e)return!0;const a=i.substring(0,1),s=i.substring(1,i.length);return!!n.isValidVLResult(t,a,s)||!(await o(`Invalid results for ${t} HIV viral load`,{cancelBtnLabel:"Process result",confirmBtnLabel:"Re-enter result"}))},alphaValueIsValid(e){try{return!!e.match(/^(>|<|=)(.*)/)}catch(t){return!1}},numericValueIsValid(e){try{return!!e.match(/^(=|<|>)([0-9]*)$/m)}catch(t){return!1}},isMalariaResult:e=>!!e.match(/mrdt|malaria/i),isUrineLamResult:e=>!!e.match(/Lam/i),buildTestIndicatorFields(e,t,i,a){const s=e*a,l=e=>[this.selectedTest.value===a,!!h.find(e.result_indicators,{label:t})].every(Boolean),r=(i,a)=>{if("Other"===i.value&&t.match(/HIV viral load/i))return{};const l=this.isMalariaResult(t)||this.isUrineLamResult(t)?"text":a[`type_${s}`].value,r=this.isMalariaResult(t)||this.isUrineLamResult(t)?"="+i.value:i.value.toString(),n=r.charAt(0),o="numeric"===l?parseInt(r.substring(1)):r.substring(1),u=a.result_indicators.filter((t=>t.value===e))[0];return{tag:"result_indicator",measures:{indicator:{concept_id:u.value},value:o,value_modifier:n,value_type:l},result:o,modifier:n,test:u.label}};return[{id:`type_${s}`,helpText:`Result type (${t})`,type:u.TT_SELECT,group:"test_indicator",condition:e=>l(e)&&!this.isMalariaResult(t)&&!this.isUrineLamResult(t),appearInSummary:()=>!1,validation:e=>d.required(e),options:()=>[{label:"Numeric (numbers only)",value:"numeric"},{label:"Alphanumeric(text and numbers)",value:"text"}]},{id:`urine_result_${s}`,helpText:`Select Test Result (${t})`,type:u.TT_SELECT,group:"test_indicator",computedValue:r,validation:e=>d.required(e),condition:e=>l(e)&&this.isUrineLamResult(t),options:()=>[{label:"Positive",value:"positive"},{label:"Negative",value:"negative"}]},{id:`num_${s}`,helpText:`Test Result (${t})`,type:u.TT_TEXT,group:"test_indicator",computedValue:r,beforeNext:e=>this.validateVLresults(t,i,e.value.toString()),onValue:e=>!(e&&e.value&&!this.numericValueIsValid(e.value.toString())&&(c("You must enter a modifer and numbers only. i.e =90 / >19 / < 750"),1)),validation:e=>d.required(e),condition:e=>l(e)&&"numeric"===e[`type_${s}`].value,config:{customKeyboard:[[["1","2","3"],["4","5","6","=","<",">"],["7","8","9","."],["","0",""]],[["Delete"]]]}},{id:`alpha_${s}`,helpText:`Test Result (${t})`,type:u.TT_TEXT,group:"test_indicator",onValue:e=>!(e&&e.value&&!this.alphaValueIsValid(e.value.toString())&&(c("You must enter a modifier plus result (for example =LDL)"),1)),computedValue:r,validation:e=>d.required(e),condition:e=>l(e)&&"text"===e[`type_${s}`].value&&!t.match(/HIV viral load/i)},{id:`VL_alpha_${s}`,helpText:`Select Test Result (${t})`,type:u.TT_SELECT,group:"test_indicator",computedValue:r,validation:e=>d.required(e),condition:e=>l(e)&&"text"===e[`type_${s}`].value&&t.match(/HIV viral load/i),options:()=>[{label:"Collect Another Sample",value:"=Collect Another Sample"},{label:"<LDL",value:"<LDL"},{label:"=LDL",value:"=LDL"},{value:"Other",label:"Other"}]},{id:`other_VL_alpha_${s}`,helpText:`Test Result (${t})`,type:u.TT_TEXT,group:"test_indicator",onValue:e=>!(e&&e.value&&!this.alphaValueIsValid(e.value.toString())&&(c("You must enter a modifier plus result (for example =LDL)"),1)),computedValue:r,validation:e=>d.required(e),condition:e=>l(e)&&"text"===e[`type_${s}`].value&&t.match(/HIV viral load/i)&&"Other"===e[`VL_alpha_${s}`].value},{id:`malaria_result_${s}`,helpText:`Select Test Result (${t})`,type:u.TT_SELECT,group:"test_indicator",computedValue:r,validation:e=>d.required(e),condition:e=>l(e)&&this.isMalariaResult(t),options:()=>t.match(/mrdt/i)?[{label:"Positive",value:"positive"},{label:"Negative",value:"negative"}]:[{label:"Parasites seen",value:"parasites seen"},{label:"No parasites seen",value:"no parasites seen"}]}]},async initData(){const e=await this.labResult.getTestsWithoutResults();for(const t in e){const i=e[t];for(const e in i.tests){const t=i.tests[e];if(!h.isEmpty(t.result))continue;this.labResult.setTestTypeID(t.concept_id);const a=(await this.labResult.getTestIndicators()).map((e=>({testId:t.id,indicatorName:e.name,indicatorId:e.concept_id,specimen:i.specimen.name})));this.testIndicators=[...this.testIndicators,...a],this.testOptions.push({label:t.name,value:t.id,other:{accession:i.accession_number,specimen:i.specimen.name,test:t.name,orderDate:i.order_date,testIndicators:a}})}}},getFields(){return[{id:"test_type",helpText:"Tests without results",type:u.TT_TABLE_VIEWER,options:()=>[{label:"",value:"",other:{rows:this.testOptions.map((e=>[e.other.accession,e.other.specimen,e.other.test,p.toStandardHisDisplayFormat(e.other.orderDate),{type:"button",name:"Select",action:()=>{this.selectedTest=e,this.$nextTick((()=>this.fieldComponent="year_result_date"))}}])),columns:["Acession#","Specimen","Test","Order date"]}}],validation:e=>d.required(e),config:{overrideDefaultFooterBtns:{nextBtn:{name:"Finish",onClick:()=>this.$router.back()}},hiddenFooterBtns:["Clear","Cancel"]}},...m({id:"result_date",helpText:"Result",required:!0,estimation:{allowUnknown:!1},minDate:()=>p.toStandardHisFormat(this.selectedTest.other.orderDate),maxDate:()=>v.getSessionDate(),computeValue:e=>e}),{id:"result_indicators",helpText:"Select test result indicators",type:u.TT_MULTIPLE_SELECT,validation:e=>d.required(e),options:()=>this.selectedTest.other.testIndicators.map((e=>({label:e.indicatorName,value:e.indicatorId})))},...this.generateTestIndicatorsFields(),{id:"entry_confirmation",helpText:"Confirm entry",type:u.TT_TABLE_VIEWER,options:(e,t)=>[{label:"",value:"",other:{rows:Object.values(t).filter((e=>"object"==typeof e&&null!=e&&"result_indicator"===e.tag)).map((e=>[e.test,e.modifier,e.result])),columns:["Test","Modifier","Result"]}}]}]}}});e("default",T(t,[["render",function(e,t,i,a,s,l){const r=_("his-standard-form");return b(),y(r,{key:e.hisFormKey,fields:e.fields,activeField:e.fieldComponent,skipSummary:!0,onOnIndex:t[0]||(t[0]=t=>e.fieldComponent=""),onOnFinish:e.onFinish},null,8,["fields","activeField","onOnFinish"])}]]))}}}));
