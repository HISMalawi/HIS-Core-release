System.register(["./index-legacy-CA6M7ipO.js","./HisStandardForm-legacy-a9YJRGaH.js"],(function(e,t){"use strict";var r,s,i,a,n,o,l,d,c,u,h,p,g,m,b,y,f;return{setters:[e=>{r=e.ao,s=e.d,i=e.R,a=e.am,n=e.ad,o=e.ae,l=e.bY,d=e.aN,c=e.W,u=e.de,h=e.H,p=e.dm,g=e.aa,m=e.c,b=e.af,y=e.a},e=>{f=e.H}],execute:function(){class t extends r{constructor(){super()}static getDrugs(e={}){return super.getJson("/drug_cms",e)}static search(e=""){return super.getJson("/drug_cms/search",{keyword:e})}}const _=s({components:{HisStandardForm:f},data:()=>({activeField:"",fields:[],drugs:[],selectedDrugs:[],barcode:"",stockService:{}}),methods:{async onFinish(e){const t=this.prepDrugs(e);await this.stockService.postItems(t)?(i("Stock succesfully added"),this.$router.push("/")):a("Could not save stock")},getFields(){return[{id:"transfer_origination",helpText:"Select where stock came from",type:n.TT_SELECT,validation:e=>o.required(e),options:()=>[{label:"DHA",value:"DHA"},{label:"Other location",value:"Other location"}]},{id:"transfer_location",helpText:"Location",type:n.TT_SELECT,validation:e=>o.required(e),condition:e=>"Other location"===e.transfer_origination.value,options:(e,t="")=>l(t),computedValue:e=>e.label,config:{showKeyboard:!0,isFilterDataViaApi:!0}},{id:"barcode",helpText:"Scan barcode",type:n.TT_BARCODE,config:{hiddenFooterBtns:["Clear","Next"]},onValue:async e=>{this.barcode=e,this.activeField="select_drugs"},condition:e=>"DHA"===e.transfer_origination.value},{id:"select_drugs",helpText:"Select drugs",type:n.TT_MULTIPLE_SELECT,requireNext:!0,validation:e=>o.required(e),options:()=>this.drugs,unload:e=>this.selectedDrugs=e,config:{showKeyboard:!0,footerBtns:[{name:"Select all",slot:"end",onClickComponentEvents:{refreshOptions:()=>(this.drugs=this.selectAll(this.drugs),this.drugs)},onClick:()=>"NONE"}]}},{id:"date",helpText:"Delivery Date",type:n.TT_FULL_DATE,validation:e=>o.required(e)},{id:"enter_batches",helpText:"Batch entry",type:n.TT_BATCH_ENTRY,options:()=>this.selectedDrugs,beforeNext:(e,t,r,{currentFieldContext:s})=>{const i=e=>e.map((e=>`${e.label}`)).join(" & "),a=s.drugs.filter((e=>e.entries.map((e=>!(e.tins||e.expiry||e.batchNumber||e.tabs))).every(Boolean))),n=s.drugs.filter((e=>e.entries.map((e=>{let t=0;return e.tins&&(t+=1),e.expiry&&(t+=1),e.batchNumber&&(t+=1),e.tabs&&(t+=1),t>=1&&t<=3})).some(Boolean)));if(!d.isEmpty(n)){const e=i(n);return c(`Please fix partial batch entries for drugs: ${e}`),!1}if(!d.isEmpty(a)){const e=i(a);return c(`The following drug batches are empty: ${e}`),!1}return!0},validation:e=>o.required(e),config:{entryDate:e=>e.date.value}},{id:"summary",helpText:"Summary",type:n.TT_TABLE_VIEWER,options:e=>this.buildResults(e.enter_batches),config:{hiddenFooterBtns:["Clear"]}}]},buildResults:e=>[{label:"Confirm entry",value:"Table",other:{columns:["Drug","Amount per unit","Tins/Pallets","Expiry date","Batch number"],rows:e.map((e=>{const t=e.value;return[t.short_name,t.tabs,u(t.tins),h.toStandardHisDisplayFormat(t.expiry),t.batchNumber]}))}}],prepDrugs(e){const t=[],r=this.barcode,s="DHA"===e.transfer_origination.value?null:e.transfer_location.value;return e.enter_batches.forEach((i=>{const a=i.value;t.push({batch_number:a.batchNumber,location_id:s,items:[{barcode:r,drug_id:a.drug_inventory_id,expiry_date:a.expiry,quantity:parseInt(a.tabs)*parseInt(a.tins),delivery_date:e.date.value,product_code:a.code,pack_size:a.tabs}]})})),t},selectAll:e=>e.map((e=>(e.isChecked=!0,e))),async loadDrugs(){const e=await t.getDrugs({pagenate:!1});this.drugs=e.map((e=>({label:`${e.short_name} (${e.code})`,value:e})))}},created(){this.stockService=new p,this.loadDrugs(),this.fields=this.getFields()}});e("default",g(_,[["render",function(e,t,r,s,i,a){const n=b("his-standard-form");return y(),m(n,{fields:e.fields,activeField:e.activeField,onFinishAction:e.onFinish,skipSummary:!0,onOnIndex:t[0]||(t[0]=t=>e.activeField="")},null,8,["fields","activeField","onFinishAction"])}]]))}}}));
