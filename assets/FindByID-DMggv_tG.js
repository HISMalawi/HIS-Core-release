import{F as n}from"./dynamic-import-helper-Bsjrd6Ro.js";import{H as u}from"./HisStandardForm-CxcKR3FF.js";import{d as c,V as a,G as m,L as r,P as s,aJ as h,aI as f,ab as p,t as l,_ as g,r as y,o as b,c as _}from"./index-BPESSmpp.js";import{l as T}from"./overlays-04a9a43f-pvrUHYCC.js";import"./TouchScreenForm-BjDI66hA.js";import"./ToolbarMediumCard-DnRdVW_r.js";import"./Transformers-BPPLlH12.js";import"./ViewPort-DixuDTZA.js";const A=c({components:{HisStandardForm:u},data:()=>({app:{},fields:[],fieldComponent:"",people:[],patient:{},assignNewARVNumber:!1,suggestedARVNumber:""}),created(){this.setApp(),this.fields=[this.getIdSelectionField(),this.getIdSearchField(),this.getARVDuplicatesField(),this.getReassignARVNumberField()]},methods:{getIdSelectionField(){return{id:"identifier_type",helpText:"Select identifier type",type:n.TT_SELECT,requireNext:!1,validation:e=>a.required(e),options:async()=>{const e=this.app.programPatientIdentifiers?Object.values(this.app.programPatientIdentifiers):[],t=await Promise.all(e.map(async i=>typeof i.visible=="function"?await i.visible():i.globalPropertySetting?await m.isProp(i.globalPropertySetting):!0));return e.filter((i,o)=>i.useForSearch&&t[o]).map(i=>({label:i.name,value:i.id,other:i}))}}},getIdSearchField(){return{id:"identifier",helpText:"Identifier",dynamicHelpText:e=>"Search by ".concat(e.identifier_type.label),type:n.TT_TEXT,validation:(e,t)=>a.validateSeries([()=>a.required(e),()=>{var i;return typeof((i=t.identifier_type.other)==null?void 0:i.validation)=="function"?t.identifier_type.other.validation(e):null}]),config:{casing:"uppercase",initialKb:e=>{var t;return((t=e.identifier_type.other)==null?void 0:t.keyboardName)||"0-9"},prependValue:e=>{var t;return((t=e.identifier_type.other)==null?void 0:t.prefix())||""}}}},getARVDuplicatesField(){return{id:"arv_duplicates",helpText:"Duplicates",dynamicHelpText:e=>"Duplicate patients with identifer ".concat(e.identifier.value),type:n.TT_DATA_TABLE,requireNext:!1,condition:async e=>await this.hasDuplicates(e)&&e.identifier_type.label==="ARV Number",config:{hiddenFooterBtns:["Clear","Finish"],columns:()=>[[r.thTxt("First Name"),r.thTxt("Family Name"),r.thTxt("Gender"),r.thDate("Birthdate"),r.thTxt("Current Village"),r.thTxt("Actions",{colspan:2})]],rows:()=>this.people.map(e=>{const t=new s(e);return[r.td(t.getGivenName()),r.td(t.getFamilyName()),r.td(t.getGender()),r.tdDate(t.getBirthdate().toString()),r.td(t.getCurrentVillage()),r.tdBtn("Select patient",()=>this.selectPatient(t.getID()),{style:{fontSize:"12px",textTransform:"none"}},"warning"),r.tdBtn("Re-assign identifier",()=>this.reassignARVNumber(t),{style:{fontSize:"12px",textTransform:"none"}},"danger")]})}}},getReassignARVNumberField(){return{id:"arv_number",helpText:"ART number",type:n.TT_TEXT,computedValue:({value:e})=>e,validation:e=>a.required(e),condition:()=>this.fieldComponent==="arv_number"&&this.assignNewARVNumber,defaultValue:()=>this.suggestedARVNumber,config:{initialKb:"0-9",prependValue:e=>e.identifier_type.other.prefix()}}},setApp(){const e=h.getActiveApp();e&&(this.app=e)},async hasDuplicates(e){return this.people=await s.findByOtherID(e.identifier_type.value,e.identifier.value),this.people.length>1},selectPatient(e){this.$router.push("/patients/confirm?person_id=".concat(e))},async reassignARVNumber(e){const t=await T.create({});t.present();const i=await f.getNextSuggestedARVNumber();this.suggestedARVNumber=i.arv_number.replace(/^\D+|\s/g,""),this.patient=e,this.assignNewARVNumber=!0,this.fieldComponent="arv_number",t.dismiss()},async onFinish(e){if(p.isEmpty(this.people))l("Client not found");else if(this.assignNewARVNumber&&!p.isEmpty(this.patient))try{await this.patient.updateARVNumber(e.arv_number.value),this.selectPatient(this.patient.getID())}catch(t){l("".concat(t))}else{const t=new s(this.people[0]);this.selectPatient(t.getID())}}}});function v(e,t,i,o,N,V){const d=y("his-standard-form");return b(),_(d,{fields:e.fields,onFinishAction:e.onFinish,skipSummary:!0,activeField:e.fieldComponent},null,8,["fields","onFinishAction","activeField"])}const C=g(A,[["render",v]]);export{C as default};
