System.register(["./index-legacy-Ck8hVlzC.js","./HisStandardForm-legacy-OroqgFde.js","./LocationFieldOptions-legacy-UgaUiM8M.js","./storage-legacy-CIkBlJKf.js"],(function(e,t){"use strict";var r,i,s,a,n,o,l,c,d,u,h,p,g,m,y,b,f;return{setters:[e=>{r=e.S,i=e.d,s=e.U,a=e.q,n=e.F,o=e.V,l=e.ah,c=e.t,d=e.cE,u=e.H,h=e.cL,p=e._,g=e.r,m=e.o,y=e.c},e=>{b=e.H},e=>{f=e.g},null],execute:function(){class t extends r{constructor(){super()}static getDrugs(e={}){return super.getJson("/drug_cms",e)}static search(e=""){return super.getJson("/drug_cms/search",{keyword:e})}}const _=i({components:{HisStandardForm:b},data:()=>({activeField:"",fields:[],drugs:[],selectedDrugs:[],barcode:"",stockService:{}}),methods:{async onFinish(e){const t=this.prepDrugs(e);await this.stockService.postItems(t)?(s("Stock succesfully added"),this.$router.push("/")):a("Could not save stock")},getFields(){return[{id:"transfer_origination",helpText:"Select where stock came from",type:n.TT_SELECT,validation:e=>o.required(e),options:()=>[{label:"DHA",value:"DHA"},{label:"Other location",value:"Other location"}]},{id:"transfer_location",helpText:"Location",type:n.TT_SELECT,validation:e=>o.required(e),condition:e=>"Other location"===e.transfer_origination.value,options:(e,t="")=>f(t),computedValue:e=>e.label,config:{showKeyboard:!0,isFilterDataViaApi:!0}},{id:"barcode",helpText:"Scan barcode",type:n.TT_BARCODE,config:{hiddenFooterBtns:["Clear","Next"]},onValue:async e=>{this.barcode=e,this.activeField="select drugs"},condition:e=>"DHA"===e.transfer_origination.value},{id:"select drugs",helpText:"Select drugs",type:n.TT_INFINITE_SCROLL_MULTIPLE_SELECT,requireNext:!0,validation:e=>o.required(e),options:async(e,r="a")=>{const i=await t.search(r||"a");return this.drugs=this.formatDrugs(i),this.drugs},unload:e=>this.selectedDrugs=e,config:{showKeyboard:!0,isFilterDataViaApi:!0,footerBtns:[{name:"Select all",slot:"end",onClick:async()=>{const e=await t.getDrugs({pagenate:!1});this.drugs=this.formatDrugs(e),this.selectAll(this.drugs)}}]}},{id:"date",helpText:"Delivery Date",type:n.TT_FULL_DATE,validation:e=>o.required(e)},{id:"enter_batches",helpText:"Batch entry",type:n.TT_BATCH_ENTRY,options:()=>this.selectedDrugs,beforeNext:(e,t,r,{currentFieldContext:i})=>{const s=e=>e.map((e=>`${e.label}`)).join(" & "),a=i.drugs.filter((e=>e.entries.map((e=>!(e.tins||e.expiry||e.batchNumber||e.tabs))).every(Boolean))),n=i.drugs.filter((e=>e.entries.map((e=>{let t=0;return e.tins&&(t+=1),e.expiry&&(t+=1),e.batchNumber&&(t+=1),e.tabs&&(t+=1),t>=1&&t<=3})).some(Boolean)));if(!l.isEmpty(n)){const e=s(n);return c(`Please fix partial batch entries for drugs: ${e}`),!1}if(!l.isEmpty(a)){const e=s(a);return c(`The following drug batches are empty: ${e}`),!1}return!0},validation:e=>o.required(e),config:{entryDate:e=>e.date.value}},{id:"summary",helpText:"Summary",type:n.TT_TABLE_VIEWER,options:e=>this.buildResults(e.enter_batches),config:{hiddenFooterBtns:["Clear"]}}]},buildResults:e=>[{label:"Confirm entry",value:"Table",other:{columns:["Drug","Amount per unit","Tins/Pallets","Expiry date","Batch number"],rows:e.map((e=>{const t=e.value;return[t.short_name,t.tabs,d(t.tins),u.toStandardHisDisplayFormat(t.expiry),t.batchNumber]}))}}],prepDrugs(e){const t=[],r=this.barcode,i="DHA"===e.transfer_origination.value?null:e.transfer_location.value;return e.enter_batches.forEach((s=>{const a=s.value;t.push({batch_number:a.batchNumber,location_id:i,items:[{barcode:r,drug_id:a.drug_inventory_id,expiry_date:a.expiry,quantity:parseInt(a.tabs)*parseInt(a.tins),delivery_date:e.date.value,product_code:a.code,pack_size:a.tabs}]})})),t},selectAll:e=>e.map((e=>(e.isChecked=!0,e))),formatDrugs:e=>e.map((e=>({label:`${e.short_name} (${e.code})`,value:e})))},created(){this.stockService=new h,this.fields=this.getFields()}});e("default",p(_,[["render",function(e,t,r,i,s,a){const n=g("his-standard-form");return m(),y(n,{fields:e.fields,activeField:e.activeField,onFinishAction:e.onFinish,skipSummary:!0,onOnIndex:t[0]||(t[0]=t=>e.activeField="")},null,8,["fields","activeField","onFinishAction"])}]]))}}}));
