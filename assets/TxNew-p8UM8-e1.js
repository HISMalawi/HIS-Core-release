import{d as I,a5 as M,cl as F,r as b,t as N,aH as q,O as E,ad as B,aJ as x,c_ as O,aq as p,ah as H,c$ as S,d0 as U,cN as L,d1 as X,d2 as j,a6 as V,v as W,w as G,ab as C,u as J,x as R}from"./index-ATRrruTT.js";import{T as Q}from"./tx_report_service-BI63Up4q.js";import{v as z}from"./TableView-C0_sXf7R.js";import{A}from"./v2utils-CjCFVQDN.js";import{R as K}from"./ReportErrors-DTBmgqjr.js";import{M as Y}from"./moh_cohort_service-D-bxSrKH.js";import"./Export-BikdWX3S.js";import"./index-_1Jf0d3I.js";const Z=I({components:{IonPage:M,IonLoading:F,v2Datatable:z},setup(){const o=b([]),m=b(""),f=b(!1),l=new Q,c=b([]),_=new Y,u=(n,i)=>({ref:i,label:n,toValue:a=>a.length,tdClick:async a=>{a.refData.length&&(await p.create({component:A,backdropDismiss:!1,cssClass:"large-modal",componentProps:{subtitle:m,patientIdentifiers:a.refData,title:"".concat(a.data.age_group," ").concat(a.data.gender," ").concat(a.column.label),onFinish:()=>p.getTop().then(e=>e&&p.dismiss())}})).present()}}),w=[[{label:"#",ref:"index"},{label:"Age group",ref:"age_group"},{label:"Gender",ref:"gender"},u("Tx new CD4 <200","cd4_less_than_200"),u("Tx new CD4 >=200","cd4_greater_than_equal_to_200"),u("Tx new CD4 Unknown","cd4_unknown_or_not_done"),u("Transfer-ins","transfer_in")]],g=function(n){const i=c.value.findIndex(a=>a.id===n.id);i!==-1?c.value[i]=n:c.value.push(n)},v=async function(n){const i="validationErrors";(await p.create({id:i,component:K,backdropDismiss:!1,cssClass:"large-modal",componentProps:{errors:n}})).present(),g({id:i,text:"<b>".concat(n.length,"</b> validation errors detected"),icon:j,color:"danger",action:()=>v(n)})};function P(n){const i={initiated_on_art_first_time:{param:n.total,check:(e,t)=>e!=t,error:(e,t)=>"\n                        MOH cohort initiated on ART first time <b>(".concat(e,")</b> is not matching Tx New <b>(").concat(t,")</b>\n                    ")},initial_pregnant_females_all_ages:{param:n.pregnant,check:(e,t)=>e!=t,error:(e,t)=>"\n                        MOH cohort initial pregnant females all ages \n                        <b>(".concat(e,")</b> is not matching with TX new Pregnant women <b>").concat(t,"</b>\n                    ")},males_initiated_on_art_first_time:{param:n.male,check:(e,t)=>e!=t,error:(e,t)=>"\n                        MoH Cohort males initiated on ART first time <b>(".concat(e,")</b>\n                        is not matching with TX new All male <b>(").concat(t,")</b>\n                    ")},"quarterly_re_initiated_on_art + transfer_in":{param:n.transfer_in,check:(e,t)=>e!=t,error:(e,t)=>"\n                        Quarterly Transfer In + Reinitiated Clients <b>".concat(e,"</b>  does not match Transfer In <b>").concat(t,"</b> clients in TXNEW report\n                    ")}};_.validateIndicators(i,e=>{e.length?v(e):g({id:"reportOk",text:"<b>Report is consistent</b>",icon:X,color:"success"})})===-1&&v(["Report not validated. Run the MoH cohort report for similar reporting period and then run this report"])}const $=async(n=!1)=>{if(!(l.startDate&&l.endDate))return E("Start date and end date required!");const i=n&&await B("Do you want to rebuild report?");f.value=!0,o.value=[];try{const a=await l.getTxNewReport(i),t=a.filter(r=>!["All"].includes(r.age_group)).reduce((r,s)=>(r[s.gender]=Object.keys(s).reduce((d,h)=>Array.isArray(s[h])?{...d,[h]:[...d[h]||[],...s[h]]}:d,r[s.gender]||{}),r),{Male:{},Female:{}});o.value=a;const k=a.reduce((r,s)=>{if(s.gender==="FP"){const d=Object.values(s).filter(Array.isArray).flat();return r.concat(d)}return r},[]),D=["cd4_less_than_200","cd4_greater_than_equal_to_200","cd4_unknown_or_not_done"],T=x.uniq(["Female","Male"].reduce((r,s)=>[...r,...D.map(d=>t[s][d]).flat(1)],[]));g({id:"stats",text:"Tx new <b>".concat(T.length,"</b>"),icon:O,color:"primary",action:async()=>{(await p.create({component:A,backdropDismiss:!1,cssClass:"large-modal",componentProps:{title:"All TxNew",subtitle:m.value,patientIdentifiers:T,onFinish:()=>p.getTop().then(r=>r&&p.dismiss())}})).present()}}),P({total:T.length,pregnant:x.uniq(D.map(r=>t.Female[r].filter(s=>k.includes(s))).flat(1)).length,male:x.uniq(D.map(r=>t.Male[r]).flat(1)).length,transfer_in:[...t.Male.transfer_in,...t.Female.transfer_in].length}),o.value=o.value.map((r,s)=>({index:s+1,...r}))}catch(a){console.error("".concat(a)),H("Unable to generate report!"),c.value=[{text:"Unable to generate report!",color:"danger",icon:S,action:function(){c.value=[{text:"Exception occured: <b>".concat(a,"</b>"),color:"danger",icon:U}]}}]}f.value=!1},y=()=>L({onFinish:(n,i,a,e)=>{m.value=a,l.startDate=n,l.endDate=i,e&&l.setOccupation(e),_.setStartDate(l.startDate),_.setEndDate(l.endDate),$()}});return N(()=>y()),{Img:q,headerBadge:c,reportData:o,isLoading:f,configure:y,generate:$,columns:w,period:m}}});function ee(o,m,f,l,c,_){const u=C("ion-loading"),w=C("v2Datatable"),g=C("ion-page");return J(),W(g,null,{default:G(()=>[R(u,{"is-open":o.isLoading,message:"Please wait..."},null,8,["is-open"]),R(w,{"icon-url":o.Img("login-logos/PEPFAR.png"),title:"Pepfar Tx New","report-prefix":"Pepfar",subtitle:o.period,columns:o.columns,columnData:o.reportData,rowsPerPage:100,headerBadge:o.headerBadge,onConfigure:o.configure,onRefresh:()=>o.generate(!0)},null,8,["icon-url","subtitle","columns","columnData","headerBadge","onConfigure","onRefresh"])]),_:1})}const ce=V(Z,[["render",ee]]);export{ce as default};
