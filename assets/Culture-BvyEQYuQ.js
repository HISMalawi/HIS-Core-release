import{H as I}from"./HisStandardForm-CaDwl-hA.js";import{u as C}from"./useEncounter-CDUT-p5Y.js";import{d as L,K as v,b5 as N,cV as A,V as R,S as O,o as P,c as F,w as M,b as U,cl as S,cX as b,cY as V,ad as k,I as w,ag as D}from"./index-BCTN_bnC.js";import{F as d}from"./dynamic-import-helper-BkBZiFw5.js";import{r as B}from"./commons-BDvZ1JFN.js";import{g as n,a as $}from"./util-CyjuS_4X.js";import"./TouchScreenForm-TKB9q3ZD.js";import"./ToolbarMediumCard-O_J6wu7C.js";import"./Transformers-BPPLlH12.js";import"./ViewPort-BCxYiILf.js";import"./isEmpty-OXtHK5dz.js";import"./_Set-VKtKUQAI.js";import"./_setToArray-BLmuRUHx.js";import"./encounter_guidelines-DZpIPlYY.js";import"./GuidelineEngine-D6V1_Znr.js";const ie=L({__name:"Culture",setup(x){const h=v([]),s=new N(-1,A.LAB_RESULTS),T=v(),{goToNextTask:u,patientDashboardUrl:g,facts:E}=C((c,l,p)=>{s.patientID=l,s.providerID=c,T.value=p;const m=()=>({id:"sampleResult",helpText:"Sample Result:",type:d.TT_SELECT,validation:t=>R.required(t),computedValue:t=>[{concept_id:n("TB_STATUS"),value_coded:n("".concat(t.value)),obs_datetime:s.date},{concept_id:n("BACTERIOLOGICALLY_DIAGNOSED"),value_coded:n("YES_ANSWER"),obs_datetime:s.date},{concept_id:n("PROCEDURE_TYPE"),value_coded:n("CULTURE_AND_DST"),obs_datetime:s.date},...t.value==="POSITIVE"?[{concept_id:n("TB_TYPE"),value_coded:n("PULMONARY_TB"),obs_datetime:s.date}]:[]],options:()=>[{value:"POSITIVE",label:"Culture Positive"},{value:"NEGATIVE",label:"Culture Negative"}]}),_=()=>({id:"treatmentType",helpText:"Select treatment drugs:",type:d.TT_SELECT,validation:t=>R.required(t),condition:t=>t.sampleResult.value==="POSITIVE",options:()=>[{value:"FIRST_LINE",label:"Firstline Drugs"},{value:"SECOND_LINE",label:"DR TB Drugs"}]}),i=()=>({id:"sampleResistance",helpText:"Firstline Drug Resistance:",type:d.TT_MULTIPLE_SELECT,condition:t=>t.treatmentType.value==="FIRST_LINE",computedValue:t=>{const e=[];return t.length===1?e.push({concept_id:n("Resistance classification"),value_coded:n("Mono drug resistant"),obs_datetime:s.date}):t.length>1&&e.push({concept_id:n("Resistance classification"),value_coded:n("Multi drug resistant"),obs_datetime:s.date}),t.some(a=>/rif/i.test(a.label))&&e.push({concept_id:n("Rifampicin resistance confirmed"),value_coded:n("YES_ANSWER"),obs_datetime:s.date}),[...e,...t.filter(a=>!/no resistance/i.test("".concat(a.value))).map(a=>({concept_id:n("TB_DRUG_RESISTANT"),value_coded:$("".concat(a.value)),obs_datetime:s.date}))]},onValueUpdate:(t,e)=>t.map(a=>{if(e.isChecked){if(/no resistance/i.test("".concat(e.label))&&a.label!=e.label)return a.isChecked=!1,a;/no resistance/i.test("".concat(e.label))||/no resistance/i.test("".concat(a.label))&&(a.isChecked=!1)}return a}),options:()=>[{value:"Rifampicin (300mg)",label:"Rifampicin Resistant"},{value:"Isoniazid (300mg)",label:"Isoniazid Resistant"},{value:"No Resistance",label:"No Resistance"}]}),o=()=>{const t=[];return{id:"sampleSecondlineDrugs",helpText:"DR TB Drug Resistance:",type:d.TT_MULTIPLE_SELECT,init:async()=>{try{const e=[];(await O.getJson("programs/".concat(s.programID,"/tb_regimen_group"),{patient:l,regimen_group:"second-line-concepts"})).forEach(r=>{!e.includes(r.concept_id)&&!/none|other non-coded/i.test(r.name)&&(e.push(r.concept_id),t.push({label:r.name,value:r.concept_id}))})}catch(e){return!1}return!0},condition:e=>e.treatmentType.value==="SECOND_LINE",onValueUpdate:(e,a)=>e.map(r=>{if(a.isChecked){if(/no resistance/i.test("".concat(a.label))&&r.label!=a.label)return r.isChecked=!1,r;/no resistance/i.test("".concat(a.label))||/no resistance/i.test("".concat(r.label))&&(r.isChecked=!1)}return r}),computedValue:e=>{const a=[];return e.length===1?a.push({concept_id:n("Resistance classification"),value_coded:n("Mono drug resistant"),obs_datetime:s.date}):e.length>1&&a.push({concept_id:n("Resistance classification"),value_coded:n("Multi drug resistant"),obs_datetime:s.date}),[...a,...e.filter(r=>!/no resistance/i.test("".concat(r.value))).map(r=>({concept_id:n("TB_DRUG_RESISTANT"),value_coded:r.value,obs_datetime:s.date}))]},options:()=>[...t,{value:"No Resistance",label:"No Resistance"}]}},f=()=>({id:"sampleResultDate",helpText:"Sample Result Date:",type:d.TT_FULL_DATE,validation:t=>R.required(t),computedValue:t=>({concept_id:n("RESULT_DATE"),value_datetime:t.value,obs_datetime:s.date})});h.value=[m(),_(),i(),o(),f()]});async function y(c,l){var _;await s.createEncounter(),await s.saveObservationList(await B(l));const p={tbPositive:((_=c.sampleResult)==null?void 0:_.value)==="POSITIVE",onTreatment:b.isOnTreatment(E.outcome),tptEligible:!b.isOnTreatment(E.outcome)&&T.value.getAge()>=0&&T.value.getAge()<V,inhResistance:(c.sampleResistance||[]).some(i=>i.label==="Isoniazid Resistant"),rrResistance:(c.sampleResistance||[]).some(i=>i.label==="Rifampicin Resistant")},m={"try a different examination when negative result":{title:"Negative patient",message:"Do you want to try a different examination?",yes:()=>D.push("/tb/lab/".concat(s.patientID)),no:()=>D.push(g.value),mandatoryCondition:{tbPositive:i=>!i,onTreatment:i=>!i,tptEligble:i=>!i}},"go to other encounters if no drug resistance was found":{action:()=>u(),mandatoryCondition:{inhResistance:i=>!i,rrResistance:i=>!i}},"enroll in MDR program if drug resistance is found":{title:"Start drug resistance program",message:"Drug resistance has been detected, do you want to enroll patient is Drug Resistance program?",yes:async()=>{await b.enrollMDR(s.patientID),u()},no:()=>u(),eitherConditionMatch:{inhResistance:i=>i,rrResistance:i=>i}}};for(const i of Object.keys(m)){const o=m[i];let f=!0,t=!0;if(o.mandatoryCondition&&(t=Object.keys(o.mandatoryCondition).every(e=>o.mandatoryCondition[e](p[e]))),o.eitherConditionMatch&&(f=Object.keys(o.eitherConditionMatch||{}).some(e=>o.eitherConditionMatch[e](p[e]))),f&&t){if(typeof o.yes=="function"&&typeof o.no=="function")return await k(o.title,"",o.message,[{name:"Yes",slot:"start",color:"success"},{name:"No",slot:"start",color:"primary"}])==="Yes"?o.yes():o.no();if(typeof o.action=="function")return o.action()}}u()}return(c,l)=>(P(),F(S(w),null,{default:M(()=>[U(I,{cancelDestinationPath:S(g),onFinishAction:y,fields:h.value,skipSummary:!0},null,8,["cancelDestinationPath","fields"])]),_:1}))}});export{ie as default};
