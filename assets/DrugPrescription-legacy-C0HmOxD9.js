System.register(["./index-legacy-zV5Jd_xD.js","./drug_order_service-legacy-C7x58fKT.js","./drug_service-legacy-xn2P-b8j.js","./drug_prescription_service-legacy-f6Ohj9PX.js","./HisStandardForm-legacy-DUG6a-9J.js","./useEncounter-legacy-CjSSj0Ri.js","./isEmpty-legacy-B03tgnL3.js","./encounter_guidelines-legacy-D0nfkYrS.js","./GuidelineEngine-legacy-KsvQuFdF.js"],(function(e,a){"use strict";var t,r,n,i,s,o,u,l,d,c,g,p,y,h,m,_,f,D,b,T,v,E,w,q,S,x;return{setters:[e=>{t=e.bV,r=e.bj,n=e.d,i=e.r,s=e.al,o=e.am,u=e.aZ,l=e.a,d=e.w,c=e.e,g=e.f,p=e.n,y=e.aE,h=e.dL,m=e.au,_=e.z,f=e.b,D=e.bL,b=e.a1,T=e.H},e=>{v=e.D},e=>{E=e.D},e=>{w=e.D,q=e.A},e=>{S=e.H},e=>{x=e.u},null,null,null],execute:function(){class a extends t{static getDrugs;constructor(e,a){super(e,25,a)}async loadDrugs(e="",a=1,t=10){return(await E.getDrugs({name:e,page:a,page_size:t,concept_set:"OPD Medication"})).map((e=>({label:e.name,value:e.name,other:e})))}async getDrugs(e="",a=1,t=10){return(await E.getDrugs({name:e,page:a,page_size:t,concept_set:"OPD Medication"})).map((e=>({label:e.name,value:e.name,other:e})))}async hasMalaria(){const e=await r.getLatestMalariaTestResult(this.patientID);return"No"===e?!!(await t.getAllValueCoded(this.patientID,"Primary diagnosis")).includes("Malaria")||!!(await t.getAllValueCoded(this.patientID,"Secondary diagnosis")).includes("Malaria"):"Positive"===e}createDrugOrder(e){return v.create({encounter_id:this.encounterID,drug_orders:e})}}e("default",n({__name:"DrugPrescription",setup(e){const t=i([]);let r,n;const{goToNextTask:v}=x(((e,i)=>{n=new a(i,e),t.value=[{id:"drug_selection",helpText:"Select the drugs to be prescribed",type:o.TT_INFINITE_SCROLL_MULTIPLE_SELECT,onload:e=>r=e,validation:e=>s.required(e),options:async(e,a="",t=1,r=10)=>n.getDrugs(a,t,r),onValueUpdate:async e=>{for(let t=0;t<e.length;t++)if(e[t].isChecked&&!((a=e[t].other).dosage&&a.frequency&&a.duration)){const a=await M(e[t]);u.isEmpty(a)?e.splice(t,1):(e[t].other={...e[t].other,...a},r.filter="",r.selected="")}var a;return e},config:{isFilterDataViaApi:!0,showKeyboard:!0,footerBtns:[{name:"Predefined Malaria Drugs",color:"primary",size:"large",visible:!1,slot:"end",onClick:L}]}},{id:"summary",helpText:"Prescribed Drugs",type:o.TT_TABLE_VIEWER,options:e=>{const a=e.drug_selection.map((e=>[e.label,e.other.dosage,w.find((a=>a.code===e.other.frequency))?.label,e.other.duration]));return[{label:"Prescribed Drugs",value:"",other:{columns:["Drug","Dosage","Frequency","Duration"],rows:a}}]}}]}));async function E(e){const t=function(e){const t=a.getSessionDate();return e.map((e=>{const a=w.find((a=>a.code===e.other.frequency));return{drug_inventory_id:e.other.drug_id,equivalent_daily_dose:"Unknown"==e.other.dosage?0:e.other.dosage*a?.value||0,start_date:t,auto_expire_date:I(t,e.other.duration),units:e.other.units,instructions:`${e.label}: ${e.other.dosage} ${e.other.units} ${a?.code||""} for ${e.other.duration} days`,dose:e.other.dosage,frequency:a?.code||""}}))}(e.drug_selection);try{await n.createEncounter(),await n.createDrugOrder(t),await D.isSummaryPrintingEnabled()&&b(n.patientID),v()}catch(r){console.error(r)}}function I(e,a){const t=new Date(e);return t.setDate(t.getDate()+parseInt(a)),T.toStandardHisFormat(t)}async function L(){await async function(){return await n.hasMalaria()||m("Patient has no malaria. Do you still want to prescribe anti malaria drugs?")}()&&await y([{id:"malaria_drug",helpText:"Select the malaria drug to be prescribed",type:o.TT_SELECT,validation:e=>s.required(e),options:()=>q.map((e=>({value:e.name,label:e.name,other:{...e,dosage:e.dose_strength,frequency:w.find((a=>a.value===e.frequency))?.code}})))}],(async e=>{r.checkedItems.push({...e.malaria_drug,isChecked:!0}),await _.dismiss()}))}async function M(e){return new Promise((a=>{y([{id:"frequency",helpText:`Select the frequency for ${e.label}`,type:o.TT_SELECT,requireNext:!1,validation:e=>s.required(e),computedValue:e=>e.value,options:()=>w.map((e=>({value:e.code,label:e.label,other:e})))},{id:"dosage",helpText:`Enter the dosage for ${e.label}`,type:o.TT_NUMBER,defaultValue:()=>e.other.dose_strength,validation:e=>s.required(e),computedValue:e=>Number(e.value),config:{keypad:[h,[["DELETE"]]]}},{id:"duration",helpText:`Enter the duration for ${e.label}`,type:o.TT_NUMBER,validation:e=>s.required(e),computedValue:e=>Number(e.value)}],(async(e,t)=>{await _.dismiss(),a(t)}),(()=>a({})))}))}return(e,a)=>(f(),l(g(p),null,{default:d((()=>[c(S,{"skip-summary":"",fields:t.value,onFinishAction:E},null,8,["fields"])])),_:1}))}}))}}}));
