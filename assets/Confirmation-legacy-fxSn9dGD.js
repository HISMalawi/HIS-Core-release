System.register(["./index-legacy-D_IOdfSn.js","./GuidelineEngine-legacy-KsvQuFdF.js","./VoidReason-legacy-Dnd7109d.js"],(function(t,e){"use strict";var a,i,n,s,o,r,c,l,d,p,h,m,u,g,f,N,D,y,I,E,w,A,P,T,_,b,v,C,R,O,F,L,S,H,M,B,V,$,U,x,k,G,W,X,Y,j,z,K,q,J,Q,Z,tt,et,at,it;return{setters:[t=>{a=t.aW,i=t.bQ,n=t.bR,s=t.H,o=t.bS,r=t.bn,c=t.bC,l=t.d,d=t._,p=t.X,h=t.a9,m=t.I,u=t.Y,g=t.bT,f=t.a3,N=t.a4,D=t.a8,y=t.bb,I=t.bo,E=t.an,w=t.aN,A=t.U,P=t.bz,T=t.am,_=t.ai,b=t.bU,v=t.bV,C=t.aw,R=t.bW,O=t.bA,F=t.bK,L=t.bI,S=t.au,H=t.W,M=t.ak,B=t.bG,V=t.bX,$=t.R,U=t.B,x=t.al,k=t.bB,G=t.aa,W=t.c,X=t.w,Y=t.af,j=t.a,z=t.b,K=t.K,q=t.C,J=t.a2,Q=t.E,Z=t.G,tt=t.J,et=t.M},t=>{at=t.m},t=>{it=t.p}],execute:function(){var nt=document.createElement("style");nt.textContent=".tool-bar-medium-card[data-v-0ccb7c0a]{padding:.3em}ion-col p[data-v-0ccb7c0a]{margin:0}\n/*$vite$:1*/",document.head.appendChild(nt);var st=(t=>(t.ON_CONTINUE="oncontinue",t.ONLOAD="onload",t))(st||{}),ot=(t=>(t.FORCE_EXIT="forceExit",t.GO_HOME="gotoHome",t.GO_BACK="goBack",t.CONTINUE="continue",t.ENROLL="enroll",t.EXIT="exit",t.ACTIVATE_FN="activateFn",t.ASSIGN_NPID="assignNpid",t.UPDATE_DMG="updateDemographics",t.PRINT_NPID="printNPID",t.CREATE_NPID_WITH_REMOTE_DIFF="createNpiDWithRemote",t.REFRESH_DDE_DEMOGRAPHICS="refreshDemographicsDDE",t.UPDATE_LOCAL_DDE_DIFFS="updateLocalDiffs",t.RESOLVE_DUPLICATE_NPIDS="resolveDuplicateNpids",t.ADD_AS_DRUG_REFILL="addAsDrugRefill",t.ADD_AS_NEW_PATIENT="addAsNewPatient",t.ADD_AS_EXTERNAL_CONSULTATION="addAsExternalConsultation",t.INITIATE_ANC_PREGNANCY="initiateNewAncPregnancy",t.VIEW_MERGE_AUDIT_FOR_NPID="viewMergeAuditForNpid",t.SEARCH_BY_NAME="searchByName",t.SYNCH_ART_STATUS_WITH_TB="syncArtStatusWithTb",t.ALERT_TO_BRING_NATIONAL_ID_NEXT="bringNationalID",t.SCAN_NATIONAL_ID="scanNationalID",t))(ot||{});const rt={"[DDE NOT ENABLED] Do not proceed if patient is not found in the system":{weight:98,targetEvent:"onload",actions:{alert:async()=>"Search by name"===await a(" 0 Search results","Patient has not been found","Choose how to proceed",[{name:"Close",slot:"start",color:"primary"},{name:"Search by name",slot:"end",color:"success"}],"his-danger-color")?"searchByName":"gotoHome"},conditions:{globalProperties:({ddeEnabled:t})=>!1===t,patientFound:t=>!1===t}},"[DDE ENABLED] Show invalid attributes for a patient whose remote":{weight:78,targetEvent:"onload",actions:{alert:async t=>(await i("DDE Entity Error","Remote patient has invalid attributes",["Attribute","Errors"],t.demographics.invalidDemographics,[{name:"Close",slot:"start",color:"danger"}],"his-danger-color"),"goBack")},conditions:{demographics:({hasInvalidDemographics:t})=>!0===t}},"[DDE ENABLED] Do not proceed if NPID is not found and Provide history of voided NPIDS":{weight:98,targetEvent:"onload",actions:{alert:async t=>{const e=await i(`Voided patients with ID ${t.scannedNpid}`,"NPID was not found. Please review available patient with similar ID",t.dde.voidedNpids.cols,t.dde.voidedNpids.rows,[{name:"Close",slot:"start",color:"primary"},{name:"Merge history",slot:"end",color:"primary"},{name:"Search by name",slot:"end",color:"success"}],"his-danger-color");return"Merge history"===e?"viewMergeAuditForNpid":"Search by name"===e?"searchByName":"gotoHome"}},conditions:{globalProperties:({ddeEnabled:t})=>!0===t,patientFound:t=>!1===t}},"[DDE NOT ENABLED] Notify the user to proceed with Remote NPID if local NPID does not match remote":{weight:77,targetEvent:"onload",actions:{alert:async({dde:t})=>(await a("Missing Local NPID",`Local NPID of "${t.localNpidDiff}" does not match remote "${t.remoteNpidDiff}"`,"Proceed to Fix issue",[{name:"Resolve issue",slot:"start",color:"danger"}],"his-danger-color"),"createNpiDWithRemote")},conditions:{dde:({localNpidDiff:t,remoteNpidDiff:e})=>t!=e,globalProperties:({ddeEnabled:t})=>!0===t}},"Warn if patient is missing National ID and assign them one":{weight:75,targetEvent:"onload",actions:{alert:async()=>(await a("Missing National ID","Patient was found BUT has no National ID","The system is going to assign the patient with a new ID",[{name:"OK",slot:"start",color:"primary"}],"his-danger-color"),"assignNpid")},conditions:{currentNpid:t=>n(t)}},"Detect NPID over 5 duplicates and prompt the user to resolve them":{weight:99,targetEvent:"onload",actions:{alert:async({scannedNpid:t})=>"Search by name"===await a("More than 5 duplicates found",`There are more than 5 duplicates for this NPID (${t}). Please search by name and gender`,"Choose how to proceed",[{name:"Close",slot:"start",color:"danger"},{name:"Search by name",slot:"start",color:"primary"}],"his-danger-color")?"searchByName":"gotoHome"},conditions:{npidHasOverFiveDuplicates:t=>t}},"Detect NPID duplicates and prompt the user to resolve them":{weight:99,targetEvent:"onload",actions:{alert:async({scannedNpid:t})=>(await a("DUPLICATE NPID",`NPID ${t} is currently assigned to multiple patients`,"Proceed to resolve the issue",[{name:"Resolve Duplicate NPIDs",slot:"start",color:"danger"}],"his-danger-color"),"resolveDuplicateNpids")},conditions:{npidHasDuplicates:t=>t}},"Enquire if patient has brought a national ID":{weight:95,targetEvent:"onload",actions:{alert:async()=>"Yes"==await a("Malawi National ID","Has Client brought a National ID Card or Birth Certificate?","",[{name:"Yes",slot:"start",color:"primary"},{name:"No",slot:"end",color:"primary"}])?"scanNationalID":"bringNationalID"},conditions:{isMalawiNationalIDFeaturesEnabled:t=>t,hasMalawiNationalID:t=>!t}},"Warn before proceeding if patient is deceased based on current Patient state":{weight:50,targetEvent:"oncontinue",actions:{alert:async()=>"Yes"===await a("Deceased Patient","Patient outcome is Died!","Do you want to continue?",[{name:"Yes",slot:"start",color:"danger"},{name:"No",slot:"end",color:"success"}],"his-warning-color")?"continue":"forceExit"},conditions:{currentOutcome:t=>"Patient died"===t}},"Warn before proceeding if patient stopped treatment based on current Patient state":{weight:49,targetEvent:"oncontinue",actions:{alert:async()=>"Yes"===await a("Stopped Treatment","Patient outcome is Stopped Treatment ","Do you want to continue?",[{name:"Yes",slot:"start",color:"danger"},{name:"No",slot:"end",color:"success"}],"his-warning-color")?"continue":"forceExit"},conditions:{currentOutcome:t=>"Treatment stopped"===t}},"Enforce that every client in ART must have a patient type":{weight:50,targetEvent:"oncontinue",actions:{alert:async({currentOutcome:t})=>{switch(await a("Please specify patient type",`Current outcome: ${t}`,"Please select purpose of the visit",[{name:"Emergency supply",slot:"start",color:"primary"},{name:"External Consultation",slot:"start",color:"primary"},{name:"New Patient",slot:"end",color:"primary"},{name:"Continue",slot:"end",color:"success"}])){case"Emergency supply":return"addAsDrugRefill";case"External Consultation":return"addAsExternalConsultation";case"New Patient":return"addAsNewPatient";default:return"continue"}}},conditions:{programName:t=>"ART"===t,patientType:t=>!t||/n\/a/i.test(t)}},"[ART patient visit purpose] Select purpose of visit if patient is Transferred out or Emergency supply":{weight:70,targetEvent:"oncontinue",actions:{alert:async({patientType:t,currentOutcome:e})=>{let i=[];switch("External consultation"!==t&&"Patient transferred out"!==e||(i=[{name:"Emergency supply",slot:"start",color:"primary"},{name:"New Patient",slot:"end",color:"primary"}]),"Emergency supply"===t&&(i=[{name:"External Consultation",slot:"start",color:"primary"},{name:"New Patient",slot:"end",color:"primary"}]),"New patient"===t&&(i=[{name:"External Consultation",slot:"start",color:"primary"},{name:"Emergency supply",slot:"start",color:"primary"}]),await a("Purpose of visit",`Patient type: ${t} | State: ${e}`,"Please select purpose of the visit",[...i,{name:"Continue",slot:"end",color:"success"}])){case"Emergency supply":return"addAsDrugRefill";case"External Consultation":return"addAsExternalConsultation";case"New Patient":return"addAsNewPatient";default:return"continue"}}},conditions:{programName:t=>"ART"===t,patientType:(t,{currentOutcome:e})=>["Emergency supply","External consultation"].includes(t)||"Patient transferred out"===e}},"Prompt patient enrollment in current programme if not enrolled":{weight:30,targetEvent:"onload",actions:{alert:async()=>"Yes"===await a("Programme Enrollment","Patient is not enrolled in current programme, do you want to enroll?","",[{name:"Yes",slot:"start",color:"success"},{name:"No",slot:"end",color:"danger"}])?"enroll":"exit"},conditions:{enrolledInProgram:t=>!1===t}},"[ART Enrollment Age Limit] Warn if patient is not eligible for ART based on age limit":{weight:100,targetEvent:"onload",actions:{alert:async({demographics:t})=>(await a("ART Enrollment Age Limit",`Patient is ${s.getAgeInWeeks(t.birthdate)} weeks old`,"Patient must be at least 6 weeks old to enroll in ART",[{name:"OK",slot:"start",color:"success"}],"his-danger-color"),"gotoHome")},conditions:{enrolledInProgram:t=>!1===t,programName:t=>"ART"===t,demographics:({birthdate:t})=>{const e=s.getAgeInWeeks(t);return console.log("ART Enrollment Age Limit",t,e),e<6}}},"(ART Filing numbers) Prompt dormant filing number reactivation if patient has a dormant filing number":{weight:25,targetEvent:"onload",actions:{alert:async()=>"Yes"===await a("Filing Numbers","Activate dormant #?","",[{name:"Yes",slot:"start",color:"success"},{name:"No",slot:"end",color:"danger"}])?"activateFn":"exit"},conditions:{programName:t=>"ART"===t,identifiers:t=>t.includes("Archived filing number"),currentOutcome:t=>!["Treatment stopped","Patient transferred out","Patient died"].includes(t),globalProperties:({useFilingNumbers:t})=>t}},"[DDE OFF] Prompt the user to update patient demographics when data is incomplete":{weight:92,targetEvent:"onload",actions:{alert:async()=>"Yes"===await a("Demographics","Patient data is incomplete","Do you want to review and update now?",[{name:"Yes",slot:"start",color:"success"},{name:"No",slot:"end",color:"danger"}],"his-danger-color")?"updateDemographics":"exit"},conditions:{globalProperties:({ddeEnabled:t})=>!1===t,demographics:({patientIsComplete:t})=>!1===t,patientFound:t=>!0===t}},"[DDE] Alert When remote Patient demographics dont match Local Demographics ":{weight:93,targetEvent:"onload",actions:{alert:async({dde:t})=>"Use Local"===await i("Demographics Mismatch","Local Demographics do not match Remote Demographics",["Attributes","Local","Remote"],t.diffRows,[{name:"Use Local",slot:"start",color:"primary"},{name:"Use Remote",slot:"start",color:"primary"}],"his-danger-color",t.diffRowColors)?"updateLocalDiffs":"refreshDemographicsDDE"},conditions:{dde:({hasDemographicConflict:t})=>t}},"[DDE] Alert to print newer NPID when the scanned NPID doesnt match active NPID":{weight:69,targetEvent:"onload",actions:{alert:async({currentNpid:t})=>(await a("[DDE] NATIONAL ID",`Patient has a newer National Identifier ${t}`,"Print and proceed",[{name:"Print",slot:"start",color:"primary"}]),"printNPID")},conditions:{globalProperties:({ddeEnabled:t})=>!0===t,scannedNpid:(t,{currentNpid:e})=>!t.match(new RegExp(e,"i"))}},"assign newer NPID when the current one is invalid":{weight:68,targetEvent:"onload",actions:{alert:async({currentNpid:t})=>(await a("NATIONAL ID",`Current NPID ${t} is invalid`,"Reasign and Print",[{name:"Reassign",slot:"start",color:"primary"}]),"assignNpid")},conditions:{demographics:({patientIsComplete:t})=>!0===t,patientFound:t=>!0===t,hasInvalidNpid:t=>t}},"[DDE ON] Warn program managers when Patient has incomplete demographics. Dont force them to update though":{weight:91,targetEvent:"onload",actions:{alert:async()=>"Yes"===await a("Demographics","Patient data is incomplete data","Do you want to review and update now?",[{name:"Yes",slot:"start",color:"success"},{name:"No",slot:"end",color:"danger"}],"his-danger-color")?"updateDemographics":"continue"},conditions:{globalProperties:({ddeEnabled:t})=>!0===t,demographics:({patientIsComplete:t})=>!1===t,patientFound:t=>!0===t,userRoles:t=>!0===t.includes("Program Manager")}},"[DDE ON] Force Users to update Incomplete Patient demographics":{weight:92,targetEvent:"onload",actions:{alert:async()=>"Cancel"===await a("Patient Demographics","Demographic data is incomplete","Continue to update",[{name:"Update",slot:"start",color:"success"},{name:"Cancel",slot:"start",color:"danger"}],"his-warning-color")?"gotoHome":"updateDemographics"},conditions:{globalProperties:({ddeEnabled:t})=>!0===t,demographics:({patientIsComplete:t})=>!1===t,userRoles:t=>!1===t.includes("Program Manager")}},"Warn the user when patient has high viral load":{weight:45,targetEvent:"onload",actions:{alert:async()=>(await a("High Viral Load","Patient has a high viral load, please take immediate action!","",[{name:"OK",slot:"end",color:"danger"}],"his-danger-color"),"continue")},conditions:{hasHighViralLoad:t=>!0===t}},"[ANC] Warn last LMP is more than 8 months ago and ask to initiate new pregnancy":{weight:32,targetEvent:"oncontinue",actions:{alert:async({anc:t})=>"Yes"===await a("Pregancy overdue",`Last menstrual period was ${t.lmpMonths} months ago!`,"Would you like to initiate new pregnancy?",[{name:"Yes",slot:"end",color:"success"},{name:"No",slot:"end",color:"danger"}],"his-danger-color")?"initiateNewAncPregnancy":"continue"},conditions:{programName:t=>"ANC"===t,anc:t=>!0===t.currentPregnancyIsOverdue}},"[ANC] Exit if client is NOT ELIGIBLE for ANC":{weight:89,targetEvent:"onload",actions:{alert:async()=>"EXIT"===await a("Client not eligible for ANC","This program is for women eligible for ANC only","If this is a mistake, please update client Demographics or Exit",[{name:"EXIT",slot:"end",color:"success"},{name:"EDIT DEMOGRAPHICS",slot:"end",color:"danger"}],"his-danger-color")?"gotoHome":"updateDemographics"},conditions:{demographics:({gender:t})=>{const e=t.toLowerCase();return"m"===e||"male"===e},programName:t=>"ANC"===t}},"Alert the provider that the client is on ART and record needs to be synched with TB":{weight:89,targetEvent:"oncontinue",actions:{alert:async()=>"No"===await a("TB PROGRAM ALERT","Client was enrolled in the ART program","Do you want to synchronize ART status into TB program?",[{name:"No",slot:"end",color:"primary"},{name:"Yes",slot:"end",color:"success"}],"his-danger-color")?"continue":"syncArtStatusWithTb"},conditions:{programName:t=>"TB"===t,tb:({noHivPositiveRecordInTB:t,clientEnrolledInArtProgram:e})=>e&&t}}};class ct extends o{constructor(t,e){super(t,111,e)}async getLmpInMonths(){const t=await r.getProgramInformation(this.patientID);if(t.date_of_lnmp){const e=c(t.date_of_lnmp);return c(this.date).diff(e,"months")}return-1}async pregnancyIsOverdue(){return await this.getLmpInMonths()>9}async canInitiateNewPregnancy(){return await this.getLmpInMonths()>=7}async createNewPregnancyStatus(){return await this.createEncounter(),this.saveValueCodedObs("Pregnancy status","New")}}const lt=l({name:"Patient Confirmation",components:{IonContent:d,IonHeader:p,IonFooter:h,IonPage:m,IonToolbar:u,IonSpinner:g,IonRow:f,IonCol:N,IonButton:D,ConfirmationCard:y((()=>k((()=>e.import("./PatientConfirmationCards-legacy-D60S3RSA.js")),void 0)))},data:()=>({app:{},program:{},patient:{},localPatient:{},ddeInstance:{},useDDE:!1,programInfo:{},isReady:!1,cards:[],facts:{isMalawiNationalIDFeaturesEnabled:!1,hasMalawiNationalID:!1,hasHighViralLoad:!1,patientFound:!1,npidHasDuplicates:!1,npidHasOverFiveDuplicates:!1,userRoles:[],scannedNpid:"",currentNpid:"",hasInvalidNpid:!1,enrolledInProgram:!1,programName:"N/A",currentOutcome:"",programs:[],identifiers:[],patientType:"N/A",patientTypeLastUpdated:"",tb:{noHivPositiveRecordInTB:!1,clientEnrolledInArtProgram:!1,_artData:{}},anc:{lmpMonths:-1,canInitiateNewPregnancy:!1,currentPregnancyIsOverdue:!1},dde:{localNpidDiff:"",remoteNpidDiff:"",voidedNpids:{cols:[],rows:[]},hasDemographicConflict:!1,localDiffs:{},diffRows:[],diffRowColors:[]},demographics:{patientIsComplete:!1,hasInvalidDemographics:!1,invalidDemographics:[],givenName:"",familyName:"",patientName:"",landmark:"",phoneNumber:"",currentDistrict:"",currentTA:"",currentVillage:"",ancestryDistrict:"",ancestryTA:"",ancestryVillage:"",gender:"",birthdate:""},globalProperties:{useFilingNumbers:!1,ddeEnabled:!1}}}),created(){this.initCards(),this.app=I.getActiveApp()||{}},mounted(){this.app&&(this.updateCards(),this.ddeInstance=new E,this.setGlobalPropertyFacts().then((()=>{const t=this.$route.query;w.isEmpty(t)||!t.person_id&&!t.patient_barcode||this.findAndSetPatient(t.person_id,t.patient_barcode)})))},computed:{demographics(){return this.facts.demographics},birthdate(){return s.toStandardHisDisplayFormat(this.facts.demographics.birthdate)},canVoidClient(){return this.facts.patientFound&&A.isDataManager()}},methods:{initCards(){for(let t=0;t<6;t++)this.cards[t]={label:"-",isLoading:!0,values:[]}},async updateCards(){if("function"==typeof this.app.confirmationSummary){const t=this.app.confirmationSummary(this.patient,this.program,this.facts),e=Object.keys(t);for(let a=0;a<this.cards.length;a++){const i=e[a]?t[e[a]]():[];if(this.cards[a]={label:e[a]||"-",isLoading:!1,values:i},"object"==typeof i&&i.then)this.cards[a].isLoading=!0,w.isEmpty(this.patient)||i.then((t=>{this.cards[a].isLoading=!1,this.cards[a].values=t})).catch((t=>{this.cards[a].isLoading=!1,console.error(`${t}`)}));else for(let t=0;t<i.length;++t){const e=i[t];this.cards[a].values[t]=e,w.isEmpty(this.patient)||("function"==typeof e.init&&await e.init(),"function"==typeof e.asyncValue?e.asyncValue().then((e=>{this.cards[a].values[t].value=e})).catch((e=>{this.cards[a].values[t].value="_ERROR_",console.error(`${e}`)})):"function"==typeof e.staticValue&&(this.cards[a].values[t].value=e.staticValue()))}}}},async setViralLoadStatus(){try{const t=(await P.getOrders(this.patient.getID())).reduce(((t,e)=>{const a=P.getVLResults(e);return w.isEmpty(a)||a[0].date<t.date?t:a[0]}),{});this.facts.hasHighViralLoad=P.isHighViralLoadResult(t)}catch(t){console.error(t)}},async findAndSetPatient(t,e){let a=null;this.isReady=!1,this.localPatient={},this.facts.scannedNpid||(this.facts.scannedNpid=e||""),a=this.useDDE&&e?this.ddeInstance.searchNpid(e):t?T.findByID(t):T.findByNpid(e),this.handleSearchResults(a).then((()=>this.isReady=!0)).catch((t=>_(`${t}`,3e5)))},async handleSearchResults(t){let e=[];try{e=await t}catch(a){if(a instanceof b&&!w.isEmpty(a.entity))e=a.entity;else if(a instanceof v&&Array.isArray(a.errors)){const[t,...e]=a.errors;"string"==typeof t&&"Invalid parameter(s)"===t&&this.setInvalidParametersFacts(e)}else _(`${a}`,3e5)}if(w.isEmpty(e)&&!w.isEmpty(this.localPatient)&&(e=this.localPatient),Array.isArray(e)&&e.length>1?(this.facts.npidHasDuplicates=e.length<=5,this.facts.npidHasOverFiveDuplicates=e.length>5):this.facts.patientFound=!w.isEmpty(e),this.facts.patientFound){this.patient=new T(Array.isArray(e)?e[0]:e),this.updateCards(),C.set("ACTIVE_PATIENT",this.patient),this.setPatientFacts();const t=[];t.push(this.setProgramFacts()),this.useDDE&&t.push(this.setDDEFacts()),"ANC"===this.facts.programName&&t.push(this.setAncFacts()),"TB"===this.facts.programName&&t.push(this.setTbFacts()),"ART"===this.facts.programName&&t.push(this.setViralLoadStatus()),this.facts.currentNpid=this.patient.getNationalID(),t.push(this.validateNpid()),await Promise.all(t)}else this.facts.scannedNpid&&this.setVoidedNpidFacts(this.facts.scannedNpid);this.onEvent(st.ONLOAD).then((()=>this.isReady=!0)).catch((t=>{_(`${t}`,3e5),this.isReady=!0}))},async validateNpid(){if(this.useDDE)this.facts.hasInvalidNpid=!this.patient.getDocID()||this.patient.getDocID()&&n(this.patient.getNationalID());else{const t=await T.findByNpid(this.facts.currentNpid,{page_size:2});this.facts.hasInvalidNpid=Array.isArray(t)&&t.length>1}},setInvalidParametersFacts(t){this.facts.demographics.hasInvalidDemographics=!0,this.facts.demographics.invalidDemographics=t.map((t=>{const e=Object.entries(t);return[e[0][0],e[0][1].join(", ")]}))},reloadPatient(){return this.findAndSetPatient(this.patient.getID(),void 0)},setPatientFacts(){this.facts.demographics.patientIsComplete=this.patient.patientIsComplete(),this.facts.demographics.patientName=this.patient.getFullName(),this.facts.demographics.givenName=this.patient.getGivenName(),this.facts.demographics.familyName=this.patient.getFamilyName(),this.facts.demographics.landmark=this.patient.getAttribute(19),this.facts.demographics.phoneNumber=this.patient.getAttribute(12),this.facts.demographics.gender=this.patient.getGender(),this.facts.demographics.birthdate=this.patient.getBirthdate(),this.facts.demographics.ancestryDistrict=this.patient.getHomeDistrict(),this.facts.demographics.ancestryTA=this.patient.getHomeTA(),this.facts.demographics.ancestryVillage=this.patient.getHomeVillage(),this.facts.demographics.currentDistrict=this.patient.getCurrentDistrict(),this.facts.demographics.currentTA=this.patient.getCurrentTA(),this.facts.demographics.currentVillage=this.patient.getCurrentVillage(),this.facts.identifiers=this.patient.getIdentifiers().map((t=>t.type.name)),this.facts.hasMalawiNationalID=!/unknown/i.test(this.patient.getMWNationalID())},async setGlobalPropertyFacts(){this.facts.isMalawiNationalIDFeaturesEnabled=await C.get("IS_MW_NATIONAL_ID_SCANNER_ENABLED"),this.facts.globalProperties.ddeEnabled=await C.get("IS_DDE_ENABLED"),this.useDDE=this.facts.globalProperties.ddeEnabled,"ART"===this.app.applicationName&&(this.facts.globalProperties.useFilingNumbers=await C.get("IS_ART_FILING_NUMBER_ENABLED"))},async setAncFacts(){const t=new ct(this.patient.getID(),-1);this.facts.anc.canInitiateNewPregnancy=await t.canInitiateNewPregnancy(),this.facts.anc.currentPregnancyIsOverdue=await t.pregnancyIsOverdue(),this.facts.anc.lmpMonths=await t.getLmpInMonths()},async setTbFacts(){const t=await R.generateArtStatusFromArt(this.patient.getID(),R.getSessionDate());t&&(this.facts.tb.noHivPositiveRecordInTB=!t.hivStatus._recordedStatusInTB,this.facts.tb.clientEnrolledInArtProgram=!0,this.facts.tb._artData=t)},buildDDEDiffs(t){const e=[],a={givenName:{label:"First Name",ref:"given_name"},familyName:{label:"Last Name",ref:"family_name"},birthdate:{label:"Birthdate",ref:"birthdate"},gender:{label:"Gender",ref:"gender"},phoneNumber:{label:"Phone number",ref:"phone_number"},ancestryDistrict:{label:"Home District",ref:"home_district"},ancestryTA:{label:"Home TA",ref:"home_traditional_authority"},ancestryVillage:{label:"Home Village",ref:"home_village"},currentDistrict:{label:"Current District",ref:"current_district"},currentTA:{label:"Current TA",ref:"current_traditional_authority"},currentVillage:{label:"Current Village",ref:"current_village"}};let i=0;const n={indexes:[],class:"his-empty-set-color"};for(const s in a){let o=this.facts.demographics[s],r=o;a[s].ref in t&&(n.indexes.push(i),o=t[a[s].ref].local,r=t[a[s].ref].remote),e.push([a[s].label,o,r]),++i}return{comparisons:e,rowColors:[n]}},async setProgramFacts(){this.facts.programName=this.app.applicationName;try{this.program=new O(this.patient.getID()),this.programInfo=await this.program.getProgram(),C.set("PATIENT_PROGRAM",this.programInfo);const{program:t,outcome:e}=this.programInfo;this.facts.enrolledInProgram=!(F(t)||t.match(/n\/a/i)),this.facts.currentOutcome=e,this.facts.userRoles=A.getUserRoles().map((t=>t.role));const a=await L.getArtPatientType(this.patient.getID());a?.value_coded&&(this.facts.patientType=a.value_coded,this.facts.patientTypeLastUpdated=s.toStandardHisFormat(a.obs_datetime))}catch(t){console.error(`${t}`)}},async setDDEFacts(){try{const t=(await this.ddeInstance.getLocalAndRemoteDiffs())?.diff;this.facts.dde.localDiffs=this.ddeInstance.formatDiffValuesByType(t,"local");const{comparisons:e,rowColors:a}=this.buildDDEDiffs(t);if(this.facts.dde.diffRows=e,this.facts.dde.diffRowColors=a,t.npid){const{local:e,remote:a}=t.npid;this.facts.dde.localNpidDiff=e,this.facts.dde.remoteNpidDiff=a,delete t.npid}this.facts.dde.hasDemographicConflict=!w.isEmpty(t)}catch(t){console.warn(t)}},async setVoidedNpidFacts(t){const e=["Name","Birthdate","Gender","Ancestry Home","CurrentID","Action"];let a=[];const i=await this.ddeInstance.findVoidedIdentifier(t);i&&(a=i.map((t=>{const e=new T(t);return[e.getFullName(),e.getBirthdate(),e.getGender(),e.getHomeTA(),e.getNationalID(),{type:"button",name:"Select",action:async()=>{if(!e.patientIsComplete())return this.$router.push(`/patient/registration?edit_person=${e.getID()}`);if(e.getNationalID().match(/unknown/i)||!e.getDocID())try{return await e.assignNpid(),await this.findAndSetPatient(e.getID(),void 0),S.dismiss()}catch(t){return H("Failed to assign npid to patient with unknown npid."),console.error(t)}await S.dismiss(),await this.findAndSetPatient(void 0,e.getNationalID())}}]})),this.facts.dde.voidedNpids.cols=e,this.facts.dde.voidedNpids.rows=a)},async onEvent(t,e={}){const a=at(this.facts,rt,"",t,"weight");for(const i in a){const t=a[i];if(t?.actions?.alert){const e=await(t?.actions?.alert(this.facts));if(await this.runFlowState(e)===ot.FORCE_EXIT)return!1}}"function"==typeof e&&e()},async onInitiateNewAncPregnancy(){await M("Are you sure you want to initiate new pregnancy?")&&(await this.initiateNewAncPregnancy()?(this.facts.anc.canInitiateNewPregnancy=!1,this.facts.anc.currentPregnancyIsOverdue=!1,this.nextTask()):H("Unable to initiate new pregnancy"))},initiateNewAncPregnancy(){return new ct(this.patient.getID(),-1).createNewPregnancyStatus()},async runFlowState(t){const e={};if(e[ot.SCAN_NATIONAL_ID]=async()=>await M("Are you able to scan National ID Card / Birth certificates at your Station?")?(await a("Malawi National ID","Use your 2D barcode scanner to scan the National ID Card / Birth certificate on the Home Page to proceed","",[{name:"Go To Home Page",slot:"start",color:"primary"}]),this.$router.push("/"),ot.FORCE_EXIT):(await a("Malawi National ID","Please update Missing Malawi National ID Code","",[{name:"Update Demographics Manually",slot:"start",color:"primary"}]),this.$router.push(`/patient/registration?edit_person=${this.patient.getID()}`),ot.FORCE_EXIT),e[ot.ALERT_TO_BRING_NATIONAL_ID_NEXT]=async()=>(await a("Malawi National ID","","Please remind the client to bring a National ID or Birth certificate on their next visit",[{name:"Understood",slot:"start",color:"success"}]),ot.CONTINUE),e[ot.GO_HOME]=()=>(this.$router.push("/"),ot.FORCE_EXIT),e[ot.GO_BACK]=()=>(this.$router.back(),ot.FORCE_EXIT),e[ot.ENROLL]=()=>this.program.enrollProgram(),e[ot.ACTIVATE_FN]=()=>(this.$router.push(`/art/filing_numbers/${this.patient.getID()}?assign=true`),ot.FORCE_EXIT),e[ot.UPDATE_DMG]=()=>(this.$router.push(`/patient/registration?edit_person=${this.patient.getID()}`),ot.FORCE_EXIT),e[ot.PRINT_NPID]=async()=>(await this.ddeInstance.printNpid(this.patient.getID()),await B(1800),ot.CONTINUE),e[ot.SYNCH_ART_STATUS_WITH_TB]=async()=>{const t=new o(this.patient.getID(),V.UPDATE_HIV_STATUS,-1);await t.createEncounter(),await t.saveObservationList(Object.keys(this.facts.tb._artData).reduce(((t,e)=>[...t,this.facts.tb._artData[e].obs]),[]))},e[ot.CREATE_NPID_WITH_REMOTE_DIFF]=async()=>{const t=this.facts.dde.remoteNpidDiff;try{if(t&&await this.ddeInstance.createNPID(t))return this.facts.scannedNpid=t,this.facts.currentNpid=t,this.facts.dde.localNpidDiff=t,$("Remote NPID successfully updated"),await B(300),await this.ddeInstance.printNpid(),await this.findAndSetPatient(void 0,t),ot.FORCE_EXIT}catch(e){const t=/Identifier already assigned to another patient/i;if(e instanceof v&&e.errors.join(",").match(t)){const t=await this.ddeInstance.reassignNpid(this.patient.getDocID());if(t)return this.patient=new T(t),$("Patient has been reassigned NPID"),await B(300),await this.ddeInstance.printNpid(),await this.findAndSetPatient(void 0,this.patient.getNationalID()),ot.FORCE_EXIT}_(`Unable to assign NPID: ${e}`)}},e[ot.ASSIGN_NPID]=async()=>(await this.patient.assignNpid(),await U(this.patient.getID()),await B(300),await this.reloadPatient(),ot.FORCE_EXIT),e[ot.INITIATE_ANC_PREGNANCY]=async()=>(await this.initiateNewAncPregnancy(),ot.CONTINUE),e[ot.VIEW_MERGE_AUDIT_FOR_NPID]=()=>(this.$router.push(`/merge/rollback/${this.facts.scannedNpid}`),ot.FORCE_EXIT),e[ot.RESOLVE_DUPLICATE_NPIDS]=()=>(this.$router.push(`/npid/duplicates/${this.facts.scannedNpid}`),ot.FORCE_EXIT),e[ot.REFRESH_DDE_DEMOGRAPHICS]=async()=>(await this.ddeInstance.refreshDemographics(),await this.reloadPatient(),ot.FORCE_EXIT),e[ot.ADD_AS_DRUG_REFILL]=async()=>(await this.createPatientType("Emergency supply"),ot.CONTINUE),e[ot.ADD_AS_NEW_PATIENT]=async()=>(await this.createPatientType("New patient"),ot.CONTINUE),e[ot.ADD_AS_EXTERNAL_CONSULTATION]=async()=>(await this.createPatientType("External consultation"),ot.CONTINUE),e[ot.SEARCH_BY_NAME]=()=>(this.$router.push("/patient/registration"),ot.FORCE_EXIT),e[ot.UPDATE_LOCAL_DDE_DIFFS]=async()=>(await this.ddeInstance.updateLocalDifferences(this.facts.dde.localDiffs),await this.reloadPatient(),ot.FORCE_EXIT),t in e)try{return await e[t]()}catch(i){_(`${i}`)}return t},async createPatientType(t){if(t!=this.facts.patientType&&this.facts.patientTypeLastUpdated===T.getSessionDate()&&!(await M(`This client was flagged today as "${this.facts.patientType}", altering patient type to "${t}" may affect record integrity, do you want to affect change?`)))return;const e=new L(this.patient.getID(),-1);await e.createEncounter(),await e.savePatientType(t)},async onVoid(){it((async t=>{try{await T.voidPatient(this.patient.getID(),t),this.$router.push("/")}catch(e){_(`${e}`)}}),"void-modal")},nextTask(){this.onEvent(st.ON_CONTINUE,(()=>{x(this.patient.getID(),this.$router)}))}}}),dt={class:"tool-bar-medium-card"},pt={class:"his-sm-text"},ht={class:"his-sm-text"},mt={class:"his-sm-text"},ut={class:"tool-bar-medium-card"},gt={class:"his-sm-text"},ft={class:"his-sm-text"},Nt={class:"his-sm-text"},Dt={class:"tool-bar-medium-card"},yt={class:"his-sm-text"},It={class:"his-sm-text"},Et={class:"his-sm-text"};t("default",G(lt,[["render",function(t,e,a,i,n,s){const o=Y("ion-col"),r=Y("ion-row"),c=Y("ion-toolbar"),l=Y("ion-header"),d=Y("confirmation-card"),p=Y("ion-content"),h=Y("ion-button"),m=Y("ion-spinner"),u=Y("ion-footer"),g=Y("ion-page");return j(),W(g,null,{default:X((()=>[z(l,{translucent:!0},{default:X((()=>[z(c,null,{default:X((()=>[z(r,null,{default:X((()=>[z(o,null,{default:X((()=>[K("div",dt,[K("span",pt,[e[0]||(e[0]=q("Patient Name: ")),K("b",null,J(t.demographics.patientName),1)]),e[3]||(e[3]=q()),e[4]||(e[4]=K("p",null,null,-1)),K("span",ht,[e[1]||(e[1]=q("Birthdate: ")),K("b",null,J(t.birthdate),1)]),e[5]||(e[5]=q()),e[6]||(e[6]=K("p",null,null,-1)),K("span",mt,[e[2]||(e[2]=q("Gender: ")),K("b",null,J(t.demographics.gender),1)])])])),_:1}),z(o,null,{default:X((()=>[K("div",ut,[K("span",gt,[e[7]||(e[7]=q("Ancestry district: ")),K("b",null,J(t.demographics.ancestryDistrict),1)]),e[10]||(e[10]=K("p",null,null,-1)),K("span",ft,[e[8]||(e[8]=q("Ancestry TA: ")),K("b",null,J(t.demographics.ancestryTA),1)]),e[11]||(e[11]=K("p",null,null,-1)),K("span",Nt,[e[9]||(e[9]=q("Ancestry village: ")),K("b",null,J(t.demographics.ancestryVillage),1)]),e[12]||(e[12]=K("p",null,null,-1))])])),_:1}),z(o,null,{default:X((()=>[K("div",Dt,[K("span",yt,[e[13]||(e[13]=q("Current District:")),K("b",null,J(t.demographics.currentDistrict),1),e[14]||(e[14]=K("p",null,null,-1))]),K("span",It,[e[15]||(e[15]=q("Current TA: ")),K("b",null,J(t.demographics.currentTA),1),e[16]||(e[16]=K("p",null,null,-1))]),K("span",Et,[e[17]||(e[17]=q("Current Village: ")),K("b",null,J(t.demographics.currentVillage),1),e[18]||(e[18]=K("p",null,null,-1))])])])),_:1})])),_:1})])),_:1})])),_:1}),z(p,null,{default:X((()=>[z(r,null,{default:X((()=>[(j(!0),Q(tt,null,Z(t.cards,((t,e)=>(j(),W(o,{"size-md":"4","size-sm":"12",key:e},{default:X((()=>[(j(),W(d,{key:`card-${e}`,title:t.label,items:t.values,isLoading:t.isLoading},null,8,["title","items","isLoading"]))])),_:2},1024)))),128))])),_:1})])),_:1}),z(u,null,{default:X((()=>[z(c,{color:"dark"},{default:X((()=>[z(h,{color:"danger",size:"large","router-link":"/"},{default:X((()=>e[19]||(e[19]=[q(" Cancel ")]))),_:1}),z(h,{disabled:!t.canVoidClient,color:"danger left",size:"large",onClick:t.onVoid},{default:X((()=>e[20]||(e[20]=[q("Void Client")]))),_:1},8,["disabled","onClick"]),t.facts.anc.canInitiateNewPregnancy?(j(),W(h,{key:0,slot:"end",size:"large",onClick:t.onInitiateNewAncPregnancy},{default:X((()=>e[21]||(e[21]=[q(" New Pregnancy ")]))),_:1},8,["onClick"])):et("",!0),z(h,{disabled:!t.facts.patientFound||t.facts.patientFound&&!t.isReady,slot:"end",color:"success",size:"large",onClick:t.nextTask},{default:X((()=>[t.isReady?et("",!0):(j(),W(m,{key:0,name:"crescent"})),e[22]||(e[22]=q(" Continue "))])),_:1},8,["disabled","onClick"])])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-0ccb7c0a"]]))}}}));
