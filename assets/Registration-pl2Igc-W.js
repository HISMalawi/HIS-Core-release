import{d as M,aJ as U,K as y,b5 as q,cV as C,E as O,c_ as T,aI as V,cX as b,ad as k,cb as H,ab as _,t as $,V as g,o as L,c as X,w as j,b as G,cl as B,c$ as x,R as J,I as K}from"./index-BCTN_bnC.js";import{F as I}from"./dynamic-import-helper-BkBZiFw5.js";import{g as N}from"./util-CyjuS_4X.js";import{H as W}from"./HisStandardForm-CaDwl-hA.js";import{u as Y}from"./useEncounter-CDUT-p5Y.js";import{m as z,r as Q}from"./commons-BDvZ1JFN.js";import{I as Z}from"./identifier_service-Gyvt1JKz.js";import"./TouchScreenForm-TKB9q3ZD.js";import"./ToolbarMediumCard-O_J6wu7C.js";import"./Transformers-BPPLlH12.js";import"./ViewPort-BCxYiILf.js";import"./isEmpty-OXtHK5dz.js";import"./_Set-VKtKUQAI.js";import"./_setToArray-BLmuRUHx.js";import"./encounter_guidelines-DZpIPlYY.js";import"./GuidelineEngine-D6V1_Znr.js";const Ie=M({__name:"Registration",setup(ee){const E=U.getActiveApp(),v=y([]),r=new q(-1,C.TB_REGISTRATION),c=new Z,o=y(),p=y(""),s=O();function u(a){const[n,f]="".concat(a).split("/");if(f)return"".concat(p.value).concat(n,"/").concat(f);const[d]="".concat(r.date).split("-");return"".concat(p.value).concat(n,"/").concat(d.trim())}const l={"Multi drug resistance treatment":{type:T.MDR,label:"Patient DR TB Number",indexID:"DR TB Number",concept:"MDR_NUMBER"},"Tuberculosis Preventive Treatment (TPT)":{type:T.IPT,label:"Patient IPT Number",indexID:"IPT Number",concept:"TB_NUMBER"},"Currently in treatment":{type:T.TB,label:"Patient TB Number",indexID:"TB Number",concept:"TB_NUMBER"},DEFAULT:{type:T.TB,label:"Patient TB Number",indexID:"TB Number",concept:"TB_NUMBER"}},{goToNextTask:D,patientDashboardUrl:P,patientId:R}=Y((a,n,f,d)=>{r.patientID=n,r.providerID=a;const h=()=>{let e={};const t=Object.values(l).find(i=>i.indexID===s.query.type);return{id:"reassign",helpText:"Reassign ".concat(s.query.type,": ").concat(s.query.id),proxyID:"patientIdentifier",type:I.TT_NUMBER,init:async()=>{e=await V.getProgramInformation(n),!s.query.id&&b.isOnTreatment(e.current_outcome)&&"".concat(e.tb_number).split("/").length>0&&await k("Caution!","Client is currently using program number ".concat(e.tb_number),"Current outcome is ".concat(e.current_outcome," updated on ").concat(H(e.current_outcome_date)),[{name:"Ok",color:"primary",slot:"start"}]);const[i,m]="".concat(s.query.id).split("/");return c.setIdentifierType(t==null?void 0:t.type),p.value="".concat(i,"/").concat(m,"/"),!0},beforeNext:async i=>{const m=u("".concat(i.value)),F=await c.getPatientsByIdentifier(m);return _.isEmpty(F)?!0:($("".concat(m," is already in use!!")),!1)},computedValue:i=>({obs_datetime:r.date,value_text:u("".concat(i.value)),concept_id:N(t==null?void 0:t.concept)}),condition:()=>s.query.reassign,validation:i=>g.required(i)}},S=()=>({id:"new",helpText:"Identifier:",proxyID:"patientIdentifier",type:I.TT_NUMBER,init:async()=>{var e,t,i;return l[d.outcome]?o.value=l[d.outcome]:o.value=l.DEFAULT,c.setIdentifierType((e=o.value)==null?void 0:e.type),p.value=await((i=E.programPatientIdentifiers[(t=o.value)==null?void 0:t.indexID])==null?void 0:i.prefix()),!0},beforeNext:async e=>{const t=u("".concat(e.value)),i=await c.getPatientsByIdentifier(t);return _.isEmpty(i)?!0:($("".concat(t," is already in use!!")),!1)},computedValue:e=>{var t;return{obs_datetime:r.date,value_text:u("".concat(e.value)),concept_id:N((t=o.value)==null?void 0:t.concept)}},condition:e=>{var t;return!((t=e.reassign)!=null&&t.value)},validation:e=>g.required(e),dynamicHelpText:()=>{var e;return(e=o.value)==null?void 0:e.label}}),A=()=>({id:"idSummary",helpText:"Identifier",type:I.TT_TEXT_BANNER,options:e=>{var t;return z(["".concat((t=o.value)==null?void 0:t.label,": <br/> <b>").concat(u(e.patientIdentifier.value),"</b>")])}});v.value=[h(),S(),A()]});async function w(a,n){await r.createEncounter(),await r.saveObservationList(await Q(n)),a.new?await x.create(R.value,c.identifierType,u(a.patientIdentifier.value)):await x.update(parseInt("".concat(s.query.reassign)),u(a.patientIdentifier.value)),await b.printTBNumber(r.patientID),J.invalidate("ACTIVE_PATIENT"),D()}return(a,n)=>(L(),X(B(K),null,{default:j(()=>[G(W,{cancelDestinationPath:B(P),onFinishAction:w,fields:v.value,skipSummary:!0},null,8,["cancelDestinationPath","fields"])]),_:1}))}});export{Ie as default};
