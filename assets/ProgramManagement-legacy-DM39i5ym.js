System.register(["./dynamic-import-helper-legacy-DYK5bIOV.js","./index-legacy-DaDUPm0b.js","./MultiFieldDateHelper-legacy-DbDPqams.js","./HisStandardForm-legacy-CturMrfg.js","./VoidReason-legacy-BeD7ZiUg.js","./LocationFieldOptions-legacy-ARcld0-A.js","./KbLayouts-legacy-BKvPSxzZ.js","./HisKbConfigurations-legacy-vrLd9Pgz.js","./TouchScreenForm-legacy-kTjvZFWF.js","./ToolbarMediumCard-legacy-TC6u67eT.js","./Transformers-legacy-DhNYVLaS.js","./ViewPort-legacy-DVkjms5h.js"],(function(t,e){"use strict";var a,r,o,i,n,s,l,m,d,g,p,c,h,u,P,_,f,y,F,S;return{setters:[t=>{a=t.F},t=>{r=t.d,o=t.b7,i=t.R,n=t.H,s=t.aI,l=t.ab,m=t.t,d=t.T,g=t.q,p=t.V,c=t._,h=t.r,u=t.o,P=t.c},t=>{_=t.g,f=t.E},t=>{y=t.H},t=>{F=t.p},t=>{S=t.g},null,null,null,null,null,null],execute:function(){const e=r({components:{HisStandardForm:y},data:()=>({hisFormKey:0,patient:{},patientProgram:{},fields:[],fieldComponent:"",activeField:"",activeProgram:{},programSelectionFieldContext:{}}),watch:{fieldComponent(t){t&&(this.activeField=t)},activeField(t){"program_selection"===t&&(this.hisFormKey+=1)},$route:{async handler({params:t}){t&&t.patient_id&&(this.patient=t.patient_id,this.patientProgram=new o(this.patient),this.fields=[this.getProgramSelectionField(),this.getProgramEnrollmentField(),...this.getProgramOutcomeDateFields(),this.getProgramStateField(),this.getTransferOutFacilityFields(),...this.getTransferoutReasonFields(),...this.getStateOutcomeDateFields()])},deep:!0,immediate:!0}},methods:{async onFinish(t){switch(this.activeField){case"program_enrollment":await this.onEnrollProgram();break;case"program_state":await this.onProgramState(t)}i.invalidate("PATIENT_PROGRAM")},async patientPrograms(){return(await this.patientProgram.getPrograms()).map((t=>({label:t.program.name,value:t.program.program_id,other:{...t,programStates:t.patient_states.map((t=>({name:t.name,startDate:n.toStandardHisDisplayFormat(t.start_date),endDate:t.end_date?n.toStandardHisDisplayFormat(t.end_date):"N/A",actions:this.getStateActions(t)})))}})))},async allPrograms(){const t=this.programSelectionFieldContext.listData;return(await s.getAllPrograms()).map((e=>({label:e.name,value:e.program_id,disabled:l.find(t,{value:e.program_id}),other:{...e}})))},async programWorkflows(){const t=await s.getProgramWorkflows(this.patientProgram.getProgramId());if(!l.isEmpty(t))return t[0].states.map((t=>({label:t.name,value:t.program_workflow_state_id,other:{...t}})))},getStateActions(t){const e=[{name:"Void",color:"danger",action:async(e,a)=>{await this.onVoidState(t.patient_state_id,e,a)}}];return"Patient transferred out"===t.name&&e.push({name:"Print",color:"primary",action:async()=>await this.patientProgram.printTransferout(t.start_date)}),e},onUpdateState(){if(-1===this.patientProgram.getProgramId())return m("Please select a program");this.fieldComponent="program_state"},async onProgramState(t){try{await this.patientProgram.updateState(),this.fieldComponent="program_selection",t.transfer_out_state&&await this.patientProgram.transferOutEncounter(t.transfer_out_state.other,t.reason_for_transferrout.value),d("State has been updated")}catch(e){g(`${e}`)}},async onEnrollProgram(){if(-1===this.patientProgram.getProgramId())return m("Please select a program");try{this.activeProgram=await this.patientProgram.enrollProgram(),this.fieldComponent="program_state",d("Patient has been enrolled!")}catch(t){this.activeProgram={},g(`${t}`)}},async onVoidState(t,e,a){await F((async r=>{try{this.patientProgram.setStateId(t),await this.patientProgram.voidState(r),this.patientProgram.setStateId(-1),e.other.programStates.splice(a,1),d("State has been voided")}catch(o){g(`${o}`)}}))},async onVoidProgram(){if(-1===this.patientProgram.getPatientProgramId())return m("Please select a program");await F((async t=>{try{await this.patientProgram.voidProgram(t);const e=this.programSelectionFieldContext,a=l.findIndex(e.listData,{value:this.patientProgram.getProgramId()});e.listData.splice(a,1),e.activeProgram={},this.patientProgram.setPatientProgramId(-1),this.patientProgram.setProgramId(-1),d("Program removed")}catch(e){console.error(e),g(`${e}`)}}))},getStateOutcomeDateFields(){return _({id:"state_outcome_date",helpText:"State",condition:t=>t.program_state,required:!0,minDate:()=>this.patientProgram.getProgramDate(),maxDate:()=>s.getSessionDate(),estimation:{allowUnknown:!0,estimationFieldType:f.MONTH_ESTIMATE_FIELD},computeValue:t=>this.patientProgram.setStateDate(t)})},getTransferOutFacilityFields:()=>({id:"transfer_out_state",helpText:"Please Select facility name",type:a.TT_SELECT,validation:t=>p.required(t),condition:t=>"Patient transferred out"===t.program_state.label,options:(t,e="")=>S(e),config:{showKeyboard:!0,isFilterDataViaApi:!0}}),getTransferoutReasonFields:()=>[{id:"transferout_reasons",proxyID:"reason_for_transferrout",helpText:"Reason for Transferring out",type:a.TT_SELECT,validation:t=>p.required(t),condition:t=>"Patient transferred out"===t.program_state.label,options:()=>{const t=t=>({label:t,value:t});return[t("Workplace transfer/lost job-related reasons"),t("Relocation to another place/home village"),t("Transport due to long distance"),t("School"),t("Business"),t("Marriage"),t("Unknown"),t("Clinic not helping"),t("Other")]}},{id:"transferout_other",proxyID:"reason_for_transferrout",helpText:"Other Reason for Transferring out",type:a.TT_TEXT,condition:t=>"Other"===t.transferout_reasons.value,validation:t=>p.required(t)}],getProgramStateField(){return{id:"program_state",helpText:"State",type:a.TT_SELECT,validation:t=>p.required(t),options:()=>this.programWorkflows(),condition:()=>"program_state"===this.activeField,unload:t=>this.patientProgram.setStateId(t.value)}},getProgramEnrollmentField(){return{id:"program_enrollment",helpText:"Please select a programme",type:a.TT_SELECT,condition:()=>"program_enrollment"===this.activeField,unload:t=>this.patientProgram.setProgramId(t.value),options:()=>this.allPrograms(),validation:t=>p.required(t),config:{showKeyboard:!0}}},getProgramOutcomeDateFields(){return _({id:"program_outcome_date",helpText:"Outcome",required:!0,minDate:()=>n.estimateDateFromAge(100),maxDate:()=>s.getSessionDate(),condition:()=>"program_enrollment"===this.activeField,estimation:{allowUnknown:!0,estimationFieldType:f.MONTH_ESTIMATE_FIELD},computeValue:t=>this.patientProgram.setProgramDate(t)})},getProgramSelectionField(){const t=t=>!l.isEmpty(t.program_selection);return{id:"program_selection",helpText:"Programs",type:a.TT_PROGRAM_SELECTION,onload:t=>{this.activeField="program_selection",this.programSelectionFieldContext=t},onValue:t=>(t&&(this.activeProgram=t.other,this.patientProgram.setProgramId(t.value),this.patientProgram.setPatientProgramId(t.other.patient_program_id),this.patientProgram.setProgramDate(n.toStandardHisFormat(t.other.date_enrolled))),!0),validation:t=>p.required(t),options:()=>this.patientPrograms(),config:{onVoidState:this.onVoidState,hiddenFooterBtns:["Back","Next","Clear"],footerBtns:[{name:"Void Program",slot:"end",color:"danger",state:{visible:{default:(e,a)=>t(a),onValue:(e,a)=>t(a)}},onClick:async()=>{await this.onVoidProgram()}},{name:"Update state",slot:"end",state:{visible:{default:(e,a)=>t(a),onValue:(e,a)=>t(a)}},onClick:async()=>{await this.onUpdateState()}},{name:"Enroll",color:"success",slot:"end",onClick:()=>{this.fieldComponent="program_enrollment"}}]}}}}});t("default",c(e,[["render",function(t,e,a,r,o,i){const n=h("his-standard-form");return u(),P(n,{key:t.hisFormKey,activeField:t.fieldComponent,skipSummary:!0,fields:t.fields,onOnIndex:e[0]||(e[0]=e=>t.fieldComponent=""),onOnFinish:t.onFinish},null,8,["activeField","fields","onOnFinish"])}]]))}}}));
