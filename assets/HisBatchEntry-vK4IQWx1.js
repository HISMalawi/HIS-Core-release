import{V as B}from"./ViewPort-4mhPlN2U.js";import{_ as I}from"./FieldMixin.vue_vue_type_script_lang-28YGpml0.js";import{d as P,b8 as x,C as M,g as F,h as L,ai as A,ak as H,aj as R,f as Y,S as O,ck as U,c9 as q,ab as c,O as j,V as D,H as K,aZ as T,co as G,_ as X,r as n,o as d,c as y,w as l,b as a,x as E,F as S,y as V,u as p,v as Z,z as J}from"./index-iM2cGz0p.js";import{F as m}from"./dynamic-import-helper-9HnG3Mif.js";import Q from"./BaseTextInput-eBYa-Pxr.js";import{M as W,P as k}from"./PopupKeyboard-qjNvN4qr.js";import"./SIngleTouchField-TVlhbHrr.js";import"./TouchScreenForm-hvB0I83y.js";import"./ToolbarMediumCard-ny9gUih7.js";import"./Transformers-XlEF3tgP.js";import"./HisKeypad-Ym76hLsm.js";import"./BaseKeyboard-o1nTAT9q.js";import"./KbLayouts-9dqmDWmG.js";import"./KbHandler-oqPdZ1-Q.js";import"./overlays-33ae3ea0-m-tZRAWI.js";const ee=P({components:{HisTextInput:Q,ViewPort:B,IonInput:x,IonLabel:M,IonList:F,IonItem:L,IonGrid:A,IonCol:H,IonRow:R,IonButton:Y},mixins:[I],data:()=>({drugs:[],allDrugsByName:[],selectedDrug:null,entryDate:O.getSessionDate()}),mounted(){this.init()},async activated(){this.init()},methods:{fmtNumber(e){return U(e)},fmtDate(e){return q(e)},async init(){this.$emit("onFieldActivated",this),await this.setDefaultValue()},async setDefaultValue(){const e=await this.options();this.drugs=this.drugs.filter(t=>e.map(s=>s.label).includes(t.label)),e.forEach(t=>{const s={tabs:null,tins:null,expiry:null,batchNumber:null},i={label:t.label,entries:[{...s},{...s},{...s}],...t.value};c.find(this.drugs,{label:t.label})||this.drugs.push(i)}),this.drugs.length>=1&&this.selectDrug(0),typeof this.config.entryDate=="function"&&(this.entryDate=this.config.entryDate(this.fdata,this.cdata))},getModalTitle(e){return"".concat(e," (").concat(this.drugs[this.selectedDrug].short_name,")")},getDrugValue(e,t){return this.drugs[this.selectedDrug].entries[e][t]},setDrugValue(e,t,s){this.drugs[this.selectedDrug].entries[e][t]=s?s.value:""},useCustomPackSize(e){return c.isEmpty(this.packSizes)||e.standard_pack_size.label.includes("Other")},async selectPackSize(e){await W([{id:"standard_pack_size",helpText:"Select Pack Size",type:m.TT_SELECT,condition:()=>!c.isEmpty(this.packSizes),defaultValue:()=>this.getDrugValue(e,"tabs"),options:()=>[...this.packSizes.map(t=>({label:"".concat(t),value:t})),{label:"Other (specify)",value:"Other"}]},{id:"custom_pack_size",helpText:"Input quantity",type:m.TT_NUMBER,defaultValue:()=>this.getDrugValue(e,"tabs"),validation:t=>D.required(t),condition:t=>this.useCustomPackSize(t),config:{showKeyboard:!0}}],async t=>{this.setDrugValue(e,"tabs",this.useCustomPackSize(t)?t.custom_pack_size:t.standard_pack_size),await j.dismiss()})},enterTins(e){k({id:"tins",helpText:this.getModalTitle("Enter number of tins/pallets"),type:m.TT_NUMBER,defaultValue:()=>this.getDrugValue(e,"tins"),validation:t=>!t||t&&!t.value?null:D.validateSeries([()=>D.isNumber(t),()=>t.value<=0?["Number of tins must be greater than 1"]:null])},t=>this.setDrugValue(e,"tins",t))},enterBatch(e){k({id:"batch",helpText:this.getModalTitle("Enter batch number"),type:m.TT_TEXT,config:{initialkb:"qwerty"},defaultValue:()=>this.getDrugValue(e,"batchNumber")},t=>{const s={...t},i="".concat(s.value).toUpperCase();s.label=i,s.value=i,this.setDrugValue(e,"batchNumber",s)})},enterExpiry(e){k({id:"expiry",helpText:this.getModalTitle("Enter expiry date")+" (Delivery Date: ".concat(K.toStandardHisDisplayFormat(this.entryDate),")"),type:m.TT_FULL_DATE,defaultValue:()=>this.getDrugValue(e,"expiry"),validation:t=>{if(t&&t.value)return T(t.value).isBefore(T(this.entryDate).add(30,"day"))?["You are not allowed to enter drugs that are expiring within the next 30 days from the delivery date"]:null}},t=>this.setDrugValue(e,"expiry",t))},addRow(){this.drugs[this.selectedDrug].entries.push({tabs:null,tins:null,expiry:null,batchNumber:null})},selectDrug(e){this.selectedDrug=e},validateEntry(e){return!c.isEmpty(e.tins)&&!c.isEmpty(e.expiry)&&!c.isEmpty(e.batchNumber)&&!c.isEmpty(e.tabs.toString())}},computed:{packSizes(){return this.selectedDrug===null?[]:G.getPackSizes(this.drugs[this.selectedDrug].drug_inventory_id)},fullSelectedDrugName(){try{return this.drugs[this.selectedDrug].fullName}catch(e){return"N/A"}},enteredDrugs(){const e=[];return this.drugs.forEach(t=>{t.entries.filter(i=>this.validateEntry(i)).forEach(i=>{e.push({label:t.short_name,value:{...t,...i,tabs:i.tabs}})})}),e}},watch:{clear(){this.drugs=this.drugs.map(e=>(e.entries=e.entries.map(t=>(t.tins=null,t.expiry=null,t.batchNumber=null,t)),e))},drugs:{handler(){this.$emit("onValue",this.enteredDrugs)},immediate:!0,deep:!0}}});function te(e,t,s,i,C,ae){const N=n("his-text-input"),h=n("ion-item"),w=n("ion-list"),u=n("ion-col"),g=n("ion-label"),f=n("ion-input"),b=n("ion-row"),z=n("ion-button"),v=n("ion-grid"),$=n("view-port");return d(),y($,null,{default:l(()=>[a(N,{readonly:"",value:e.fullSelectedDrugName},null,8,["value"]),a(v,{style:{background:"white"}},{default:l(()=>[a(b,null,{default:l(()=>[a(u,{size:"4",class:"border-right scroll-list"},{default:l(()=>[(d(!0),E(S,null,V(e.drugs,(o,r)=>(d(),y(w,{key:r},{default:l(()=>[a(h,{detail:"",color:r===e.selectedDrug?"secondary":"",onClick:_=>e.selectDrug(r)},{default:l(()=>[p(Z("".concat(o.short_name," (").concat(o.code,")")),1)]),_:2},1032,["color","onClick"])]),_:2},1024))),128))]),_:1}),a(u,null,{default:l(()=>[e.selectedDrug!==null?(d(),y(v,{key:0,class:"scroll-list"},{default:l(()=>[(d(!0),E(S,null,V(e.drugs[e.selectedDrug].entries,(o,r)=>(d(),y(b,{key:r},{default:l(()=>[a(u,null,{default:l(()=>[a(h,null,{default:l(()=>[a(g,{position:"floating"},{default:l(()=>[p("Pack Size")]),_:1}),a(f,{readonly:"",placeholder:"0",value:e.fmtNumber(o.tabs),onClick:_=>e.selectPackSize(r)},null,8,["value","onClick"])]),_:2},1024)]),_:2},1024),a(u,null,{default:l(()=>[a(h,null,{default:l(()=>[a(g,{position:"floating"},{default:l(()=>[p("Tins/Pallets")]),_:1}),a(f,{readonly:"",placeholder:"0",value:e.fmtNumber(o.tins),onClick:_=>e.enterTins(r)},null,8,["value","onClick"])]),_:2},1024)]),_:2},1024),a(u,null,{default:l(()=>[a(h,null,{default:l(()=>[a(g,{position:"floating"},{default:l(()=>[p("Expiry Date")]),_:1}),a(f,{readonly:"",placeholder:"DD/MM/YYYY",value:e.fmtDate(o.expiry),onClick:_=>e.enterExpiry(r)},null,8,["value","onClick"])]),_:2},1024)]),_:2},1024),a(u,null,{default:l(()=>[a(h,null,{default:l(()=>[a(g,{position:"floating"},{default:l(()=>[p("Batch Number")]),_:1}),a(f,{readonly:"",placeholder:"e.g. 'ABC-123'",value:o.batchNumber,onClick:_=>e.enterBatch(r)},null,8,["value","onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024))),128)),a(b,null,{default:l(()=>[a(u,null,{default:l(()=>[a(z,{onClick:e.addRow,siz:"large"},{default:l(()=>[p("Add row")]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})):J("",!0)]),_:1})]),_:1})]),_:1})]),_:1})}const ye=X(ee,[["render",te],["__scopeId","data-v-e9c2b14d"]]);export{ye as default};
