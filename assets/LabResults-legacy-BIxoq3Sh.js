System.register(["./HisStandardForm-legacy-a-GAw9o3.js","./dynamic-import-helper-legacy-DYK5bIOV.js","./MultiFieldDateHelper-legacy-CrZfaPmm.js","./index-legacy-Dab_9-0G.js","./TouchScreenForm-legacy-BrA5VXvB.js","./ToolbarMediumCard-legacy-tyMOM4tZ.js","./Transformers-legacy-DhNYVLaS.js","./ViewPort-legacy-kf7cSfpw.js","./KbLayouts-legacy-BKvPSxzZ.js","./HisKbConfigurations-legacy-vrLd9Pgz.js"],(function(e,t){"use strict";var s,i,a,l,r,n,o,u,d,c,h,p,m,T,v,_,y,I,b;return{setters:[e=>{s=e.H},e=>{i=e.F},e=>{a=e.g},e=>{l=e.b5,r=e.aU,n=e.d,o=e.R,u=e.T,d=e.q,c=e.n,h=e.V,p=e.t,m=e.ab,T=e.H,v=e.S,_=e._,y=e.r,I=e.o,b=e.c},null,null,null,null,null,null],execute:function(){class t extends l{patientID;testTypeID;resultDate;testID;constructor(e){super(e,57),this.patientID=e,this.testTypeID=-1,this.resultDate="",this.testID=-1}createLabResult(e){return l.postJson(`lab/tests/${this.testID}/results`,{encounter_id:this.encounterID,date:this.resultDate,measures:e})}getTestID(){return this.testID}getTestTypeID(){return this.testTypeID}setTestTypeID(e){this.testTypeID=e}setResultDate(e){this.resultDate=e}setTestID(e){this.testID=e}getTestsWithoutResults(){return r.getOrders(this.patientID,{status:"drawn"})}getTestIndicators(){return r.getJson("lab/test_result_indicators",{test_type_id:this.testTypeID})}}const g=n({components:{HisStandardForm:s},data:()=>({fieldComponent:"",labResult:{},hisFormKey:0,patient:{},fields:[],selectedTest:{},testOptions:[],testIndicators:[]}),watch:{$route:{async handler({params:e}){e&&e.patient_id&&(this.patient=e.patient_id,this.labResult=new t(this.patient),await this.initData(),this.fields=this.getFields())},deep:!0,immediate:!0}},methods:{async onFinish(e,t){try{const e=Object.values(t).filter((e=>"result_indicator"===e.tag&&e.measures)).map((e=>e.measures));this.labResult.setTestID(this.selectedTest.value),this.labResult.setResultDate(t.result_date),await this.labResult.createEncounter(),await this.labResult.createLabResult(e),o.invalidate("PATIENT_LAB_ORDERS"),this.testOptions=[],this.selectedTest={},this.testIndicators=[],await this.initData(),this.hisFormKey=Math.floor(5e3*Math.random()),u("Lab result saved!")}catch(s){d(`${s}`),console.error(s)}},generateTestIndicatorsFields(){return this.testIndicators.reduce(((e,t)=>e.concat(this.buildTestIndicatorFields(t.indicatorId,t.indicatorName,t.specimen,t.testId))),[])},async validateVLresults(e,t,s){if("HIV viral load"!==e)return!0;const i=s.substring(0,1),a=s.substring(1,s.length);return!!r.isValidVLResult(t,i,a)||!(await c(`Invalid results for ${t} HIV viral load`,{cancelBtnLabel:"Process result",confirmBtnLabel:"Re-enter result"}))},alphaValueIsValid(e){try{return!!e.match(/^(>|<|=)(.*)/)}catch(t){return!1}},numericValueIsValid(e){try{return!!e.match(/^(=|<|>)([0-9]*)$/m)}catch(t){return!1}},isMalariaResult:e=>!!e.match(/mrdt|malaria/i),isUrineLamResult:e=>!!e.match(/Lam/i),buildTestIndicatorFields(e,t,s,a){const l=e*a,r=e=>[this.selectedTest.value===a,!!m.find(e.result_indicators,{label:t})].every(Boolean),n=(s,i)=>{if("Other"===s.value&&t.match(/HIV viral load/i))return{};const a=this.isMalariaResult(t)||this.isUrineLamResult(t)?"text":i[`type_${l}`].value,r=this.isMalariaResult(t)||this.isUrineLamResult(t)?"="+s.value:s.value.toString(),n=r.charAt(0),o="numeric"===a?parseInt(r.substring(1)):r.substring(1),u=i.result_indicators.filter((t=>t.value===e))[0];return{tag:"result_indicator",measures:{indicator:{concept_id:u.value},value:o,value_modifier:n,value_type:a},result:o,modifier:n,test:u.label}};return[{id:`type_${l}`,helpText:`Result type (${t})`,type:i.TT_SELECT,group:"test_indicator",condition:e=>r(e)&&!this.isMalariaResult(t)&&!this.isUrineLamResult(t),appearInSummary:()=>!1,validation:e=>h.required(e),options:()=>[{label:"Numeric (numbers only)",value:"numeric"},{label:"Alphanumeric(text and numbers)",value:"text"}]},{id:`urine_result_${l}`,helpText:`Select Test Result (${t})`,type:i.TT_SELECT,group:"test_indicator",computedValue:n,validation:e=>h.required(e),condition:e=>r(e)&&this.isUrineLamResult(t),options:()=>[{label:"Positive",value:"positive"},{label:"Negative",value:"negative"}]},{id:`num_${l}`,helpText:`Test Result (${t})`,type:i.TT_TEXT,group:"test_indicator",computedValue:n,beforeNext:e=>this.validateVLresults(t,s,e.value.toString()),onValue:e=>!(e&&e.value&&!this.numericValueIsValid(e.value.toString())&&(p("You must enter a modifer and numbers only. i.e =90 / >19 / < 750"),1)),validation:e=>h.required(e),condition:e=>r(e)&&"numeric"===e[`type_${l}`].value,config:{customKeyboard:[[["1","2","3"],["4","5","6","=","<",">"],["7","8","9","."],["","0",""]],[["Delete"]]]}},{id:`alpha_${l}`,helpText:`Test Result (${t})`,type:i.TT_TEXT,group:"test_indicator",onValue:e=>!(e&&e.value&&!this.alphaValueIsValid(e.value.toString())&&(p("You must enter a modifier plus result (for example =LDL)"),1)),computedValue:n,validation:e=>h.required(e),condition:e=>r(e)&&"text"===e[`type_${l}`].value&&!t.match(/HIV viral load/i)},{id:`VL_alpha_${l}`,helpText:`Select Test Result (${t})`,type:i.TT_SELECT,group:"test_indicator",computedValue:n,validation:e=>h.required(e),condition:e=>r(e)&&"text"===e[`type_${l}`].value&&t.match(/HIV viral load/i),options:()=>[{label:"Collect Another Sample",value:"=Collect Another Sample"},{label:"<LDL",value:"<LDL"},{label:"=LDL",value:"=LDL"},{value:"Other",label:"Other"}]},{id:`other_VL_alpha_${l}`,helpText:`Test Result (${t})`,type:i.TT_TEXT,group:"test_indicator",onValue:e=>!(e&&e.value&&!this.alphaValueIsValid(e.value.toString())&&(p("You must enter a modifier plus result (for example =LDL)"),1)),computedValue:n,validation:e=>h.required(e),condition:e=>r(e)&&"text"===e[`type_${l}`].value&&t.match(/HIV viral load/i)&&"Other"===e[`VL_alpha_${l}`].value},{id:`malaria_result_${l}`,helpText:`Select Test Result (${t})`,type:i.TT_SELECT,group:"test_indicator",computedValue:n,validation:e=>h.required(e),condition:e=>r(e)&&this.isMalariaResult(t),options:()=>t.match(/mrdt/i)?[{label:"Positive",value:"positive"},{label:"Negative",value:"negative"}]:[{label:"Parasites seen",value:"parasites seen"},{label:"No parasites seen",value:"no parasites seen"}]}]},async initData(){const e=await this.labResult.getTestsWithoutResults();for(const t in e){const s=e[t];for(const e in s.tests){const t=s.tests[e];if(!m.isEmpty(t.result))continue;this.labResult.setTestTypeID(t.concept_id);const i=(await this.labResult.getTestIndicators()).map((e=>({testId:t.id,indicatorName:e.name,indicatorId:e.concept_id,specimen:s.specimen.name})));this.testIndicators=[...this.testIndicators,...i],this.testOptions.push({label:t.name,value:t.id,other:{accession:s.accession_number,specimen:s.specimen.name,test:t.name,orderDate:s.order_date,testIndicators:i}})}}},getFields(){return[{id:"test_type",helpText:"Tests without results",type:i.TT_TABLE_VIEWER,options:()=>[{label:"",value:"",other:{rows:this.testOptions.map((e=>[e.other.accession,e.other.specimen,e.other.test,T.toStandardHisDisplayFormat(e.other.orderDate),{type:"button",name:"Select",action:()=>{this.selectedTest=e,this.$nextTick((()=>this.fieldComponent="year_result_date"))}}])),columns:["Acession#","Specimen","Test","Order date"]}}],validation:e=>h.required(e),config:{overrideDefaultFooterBtns:{nextBtn:{name:"Finish",onClick:()=>this.$router.back()}},hiddenFooterBtns:["Clear","Cancel"]}},...a({id:"result_date",helpText:"Result",required:!0,estimation:{allowUnknown:!1},minDate:()=>T.toStandardHisFormat(this.selectedTest.other.orderDate),maxDate:()=>v.getSessionDate(),computeValue:e=>e}),{id:"result_indicators",helpText:"Select test result indicators",type:i.TT_MULTIPLE_SELECT,validation:e=>h.required(e),options:()=>this.selectedTest.other.testIndicators.map((e=>({label:e.indicatorName,value:e.indicatorId})))},...this.generateTestIndicatorsFields(),{id:"entry_confirmation",helpText:"Confirm entry",type:i.TT_TABLE_VIEWER,options:(e,t)=>[{label:"",value:"",other:{rows:Object.values(t).filter((e=>"object"==typeof e&&null!=e&&"result_indicator"===e.tag)).map((e=>[e.test,e.modifier,e.result])),columns:["Test","Modifier","Result"]}}]}]}}});e("default",_(g,[["render",function(e,t,s,i,a,l){const r=y("his-standard-form");return I(),b(r,{key:e.hisFormKey,fields:e.fields,activeField:e.fieldComponent,skipSummary:!0,onOnIndex:t[0]||(t[0]=t=>e.fieldComponent=""),onOnFinish:e.onFinish},null,8,["fields","activeField","onOnFinish"])}]]))}}}));
