import{d as H,dy as W,ad as Y,b5 as Z,l as q,aC as G,b0 as x,ac as Q,ds as X,ar as J,b1 as ee,a7 as te,ag as se,ah as ne,m as oe,ai as ie,a5 as ae,a4 as re,I as le,k as de,cc as ce,cn as ue,ch as he,dZ as pe,z as me,bj as g,s as C,aB as ye,au as fe,aZ as be,br as k,y as ve,b4 as Ie,dj as N,ak as Te,ap as i,h as u,b as r,e as n,w as o,j as y,a as f,a6 as _,a9 as O,aa as w,t as p,g as a}from"./index-BCOAvIf2.js";import{L as ge}from"./lab_order_service-DlXqurg1.js";const Oe=H({name:"Lab-modal",props:{activities:{type:Object,required:!0},ordersToday:{type:Object},onOrderAdded:{type:Object,required:!1},testFilters:{type:Array},title:{type:String,default:""}},watch:{activities:{handler(e){e&&(this.appActivities=[...e],this.getActivities())},immediate:!0}},async created(){var e;this.printCopies=(e=await N.labOrderPrintCopies())!=null?e:1,this.extendedLabsEnabled=await N.extendedLabEnabled(),this.canScanDBS=await N.canScanDBS()},methods:{onFilter(e){this.searchFilter=Ie(e,this.searchFilter)},testAlreadyDoneToday(e){return!!(this.ordersToday||{})[e]},async onScanEIDbarcode(e){if((await k.create({message:"Checking ".concat(e)})).present(),this.testTypes[this.activeIndex].accessionNumber=null,"".concat(e||"").length<=0){C("Barcode is required"),k.getTop().then(t=>t&&k.dismiss());return}try{await g.accessionNumExists(e)?C("Barcode ".concat(e," was already used")):this.testTypes[this.activeIndex].accessionNumber=e}catch(t){ve("Failed to confirm barcode "+e+", Please try again later",8e3)}k.getTop().then(t=>t&&k.dismiss())},async onSelectTest(e,t,l){if(this.testAlreadyDoneToday(e))return C("Test was already ordered today, please void and try again!");this.searchFilter="",this.showKeyboard=!1,this.testTypes[t].isChecked=l.target.checked,this.testTypes[t].isChecked?(this.activeIndex=t,await this.setTestDetails(t)):this.removeOrder(t)},async setTestDetails(e){this.specimens=await g.getSpecimens(this.testTypes[e].name,this.testTypes[e].nlims_code),this.testMethods=await g.getTestMethods(this.testTypes[e].nlims_code)},async getActivities(){const e=await g.getTestTypes(),t=be.findIndex(e,d=>/hiv viral load/i.test(d.name)),l=t!==-1?e.splice(t,1):null,h=e.sort((d,m)=>{const I="".concat(d.name).toUpperCase(),b="".concat(m.name).toUpperCase(),c=/^[0-9]/.test(I),T=/^[0-9]/.test(b);if(c!==T)return c?1:-1;const A=I.replace(/^[^A-Z]+/,"")[0]||"",v=b.replace(/^[^A-Z]+/,"")[0]||"";return A!==v?A.localeCompare(v):I.localeCompare(b)}).filter(d=>Array.isArray(this.testFilters)?this.testFilters.includes(d.name):!0);this.testTypes=(l?[...l,...h]:h).map((d,m)=>({...d,id:m}))},async removeOrder(e){this.testTypes[e].isChecked=!1,this.testTypes[e].reason=null,this.testTypes[e].specimen=null,this.testTypes[e].testMethod=null,this.testTypes[e].specimenConcept=null,this.testTypes[e].accessionNumber=null;const t=this.finalOrders.reverse();t[0]?(this.activeIndex=t[0].id,await this.setTestDetails(this.activeIndex)):(this.activeIndex=null,this.specimens=[],this.testMethods=[])},addSpecimen(e){this.testTypes[this.activeIndex].specimenConcept=e.concept_id},async postActivities(){this.isPostingOrder=!0;try{const e="".concat(this.$route.params.patient_id),l=await new ge(parseInt(e),-1).createEncounter();if(l){const h=await g.buildLabOrders(l,this.finalOrders),d=await g.saveOrdersArray(l.encounter_id,h);if(!d)return C("Unable to save lab orders");ye.invalidate("PATIENT_LAB_ORDERS");const m=this.finalOrders.some(c=>!c.accessionNumber),b=!d.every(c=>c.tests.some(T=>["FBS","RBS"].includes(T.name)))&&m&&await fe("Lab orders and encounter created!, print out your last orders?",{confirmBtnLabel:"Yes",cancelBtnLabel:"No"});typeof this.onOrderAdded=="function"&&this.finalOrders.forEach(c=>this.onOrderAdded&&this.onOrderAdded(c.name)),await this.closeModal(d),b&&await this.onPrintOrder(d)}}catch(e){C("Unable to save order: ".concat(e))}this.isPostingOrder=!1},async closeModal(e){await me.dismiss(e)},async onPrintOrder(e){const t=this.getOrdersToPrint(e);await pe(t)},getOrdersToPrint(e){const t=this.finalOrders.map(l=>"".concat(l.accessionNumber).toUpperCase());return e.reduce((l,h)=>[h.tests.some(m=>["FBS","RBS"].includes(m.name)),t.includes("".concat(h.accession_number).toUpperCase())].every(Boolean)?l:[...l,h.order_id],[])}},computed:{searchIcon(){return he},searchColor(){return this.showKeyboard?"primary":"dark"},testTypesOnDisplay(){return this.searchFilter?new ue(this.testTypes,{threshold:.3,keys:["name"],useExtendedSearch:!0}).search(this.searchFilter).map(t=>t.item):this.testTypes},dbsBarcodeActivated(){var e,t;return this.canScanDBS&&/dbs|plasma/i.test("".concat((e=this.testTypes[this.activeIndex])==null?void 0:e.specimen))&&/hiv viral load/i.test("".concat((t=this.testTypes[this.activeIndex])==null?void 0:t.name))},isOrderComplete(){return typeof this.activeIndex!="number"||this.dbsBarcodeActivated&&/dbs/i.test(this.testTypes[this.activeIndex].specimen)&&!this.testTypes[this.activeIndex].accessionNumber?!1:this.extendedLabsEnabled?!!this.testTypes[this.activeIndex].reason:(this.testTypes[this.activeIndex].specimenConcept||this.testTypes[this.activeIndex].specimen)&&this.testTypes[this.activeIndex].reason},selectedOrders(){return this.testTypes.filter(e=>e.isChecked===!0)},finalOrders(){return this.selectedOrders.filter(e=>this.dbsBarcodeActivated&&/dbs/i.test(e.specimen)&&!e.accessionNumber?!1:e.reason&&(e.specimen&&!this.extendedLabsEnabled||this.extendedLabsEnabled))},testReasons(){let e=this.reasons;return this.testTypes[this.activeIndex].name.match(/Viral load/i)&&(e=e.filter(t=>t!=="Stat"),e=e.concat(["Follow up after Low Level Viremia","Follow up after High Viral Load"])),e}},mounted(){this.getActivities()},data(){return{printCopies:1,isPostingOrder:!1,searchFilter:"",showKeyboard:!1,keyboardLayout:ce,canScanDBS:!1,content:"Content",extendedLabsEnabled:!1,appActivities:[],testTypes:[],specimens:[],testMethods:[],reasons:["Routine","Targeted","Confirmatory","Stat","Repeat / Missing"],activeIndex:null}},components:{IonButton:de,IonContent:le,IonHeader:re,IonTitle:ae,IonInput:ie,IonToolbar:oe,IonLabel:ne,IonList:se,IonItem:te,BarcodeInput:ee,IonCheckbox:J,IonRadioGroup:X,IonRow:Q,HisKeyboard:x,IonIcon:G,IonFooter:q,IonGrid:Z,IonCol:Y,IonRadio:W}}),Ce={key:0},ke={key:1},_e={class:"ion-margin-bottom"},we={key:1},Ae={class:"his-md-text side-title"},Be={style:{background:"lightyellow",height:"34vh"}},Se={class:"his-sm-text"};function Le(e,t,l,h,d,m){const I=i("ion-title"),b=i("ion-icon"),c=i("ion-input"),T=i("ion-toolbar"),A=i("ion-header"),v=i("ion-label"),E=i("ion-checkbox"),B=i("ion-item"),P=i("ion-list"),$=i("ion-col"),L=i("ion-radio"),D=i("ion-radio-group"),M=i("ion-text"),V=i("BarcodeInput"),F=i("ion-button"),R=i("ion-row"),K=i("ion-grid"),U=i("his-keyboard"),j=i("ion-content"),z=i("ion-footer");return r(),u(O,null,[n(A,null,{default:o(()=>[n(T,null,{default:o(()=>[n(I,{class:"his-lg-text",slot:"start"},{default:o(()=>[...t[5]||(t[5]=[y(" Lab orders ",-1)])]),_:1}),n(b,{size:"large",slot:"end",icon:e.searchIcon,color:e.searchColor},null,8,["icon","color"]),n(c,{readonly:!0,value:e.searchFilter,disabled:e.activeIndex&&!e.isOrderComplete,color:e.searchColor,onClick:t[0]||(t[0]=()=>e.showKeyboard=!e.showKeyboard),placeholder:"Search for tests",style:{"text-align":"left",width:"35%"},class:"input_display",slot:"end"},null,8,["value","disabled","color"])]),_:1})]),_:1}),n(j,{style:{overflow:"hidden",background:"grey",height:"70vh"}},{default:o(()=>[n(K,null,{default:o(()=>[n(R,null,{default:o(()=>[n($,{size:"6"},{default:o(()=>[n(P,{style:{overflowY:"auto",height:"75vh"}},{default:o(()=>[(r(!0),u(O,null,w(e.testTypesOnDisplay,s=>(r(),f(B,{class:"his-sm-text",key:s.id,color:e.activeIndex===s.id?"primary":"none",disabled:e.activeIndex!=null&&e.activeIndex!==s.id&&!e.isOrderComplete,detail:""},{default:o(()=>[n(v,{"text-wrap":""},{default:o(()=>[e.testAlreadyDoneToday(s.name)?(r(),u("s",Ce,p(s.name),1)):(r(),u("span",ke,p(s.name),1))]),_:2},1024),n(E,{slot:"start",checked:s.isChecked,onIonChange:S=>e.onSelectTest(s.name,s.id,S)},null,8,["checked","onIonChange"])]),_:2},1032,["color","disabled"]))),128))]),_:1})]),_:1}),e.activeIndex!=null&&e.selectedOrders.length>0?(r(),f($,{key:0,style:{overflowY:"auto",height:"79vh"}},{default:o(()=>[a("div",_e,[e.extendedLabsEnabled?_("",!0):(r(),f(P,{key:0},{default:o(()=>[n(D,{modelValue:e.testTypes[e.activeIndex].specimen,"onUpdate:modelValue":t[1]||(t[1]=s=>e.testTypes[e.activeIndex].specimen=s)},{default:o(()=>[t[6]||(t[6]=a("div",{class:"his-md-text side-title"}," Select specimen ",-1)),(r(!0),u(O,null,w(e.specimens,s=>(r(),f(B,{key:s},{default:o(()=>[n(v,null,{default:o(()=>[y(p(s.name),1)]),_:2},1024),n(L,{slot:"start",value:s.name,onClick:S=>e.addSpecimen(s)},null,8,["value","onClick"])]),_:2},1024))),128))]),_:1},8,["modelValue"])]),_:1})),e.dbsBarcodeActivated?(r(),u("div",we,[a("div",Ae,[t[7]||(t[7]=y(" Barcode ID: ",-1)),n(M,{color:e.testTypes[e.activeIndex].accessionNumber?"success":"dark"},{default:o(()=>[a("b",null,p(e.testTypes[e.activeIndex].accessionNumber||"None"),1)]),_:1},8,["color"])]),n(V,{size:"small",onOnScan:e.onScanEIDbarcode},null,8,["onOnScan"])])):_("",!0),e.testMethods.length>0?(r(),f(D,{key:2,modelValue:e.testTypes[e.activeIndex].testMethod,"onUpdate:modelValue":t[2]||(t[2]=s=>e.testTypes[e.activeIndex].testMethod=s)},{default:o(()=>[t[8]||(t[8]=a("div",{class:"his-md-text side-title"}," Test Method to be used ",-1)),(r(!0),u(O,null,w(e.testMethods,s=>(r(),f(B,{class:"his-sm-text",key:s},{default:o(()=>[n(v,null,{default:o(()=>[y(p(s.name),1)]),_:2},1024),n(L,{slot:"start",value:s.concept_id},null,8,["value"])]),_:2},1024))),128))]),_:1},8,["modelValue"])):_("",!0),n(D,{modelValue:e.testTypes[e.activeIndex].reason,"onUpdate:modelValue":t[3]||(t[3]=s=>e.testTypes[e.activeIndex].reason=s)},{default:o(()=>[t[9]||(t[9]=a("div",{class:"his-md-text side-title"}," Main test(s) reason ",-1)),(r(!0),u(O,null,w(e.testReasons,s=>(r(),f(B,{class:"his-sm-text",key:s},{default:o(()=>[n(v,null,{default:o(()=>[y(p(s),1)]),_:2},1024),n(L,{slot:"start",value:s},null,8,["value"])]),_:2},1024))),128))]),_:1},8,["modelValue"])]),a("div",Be,[a("table",Se,[t[11]||(t[11]=a("thead",null,[a("tr",null,[a("th",null,"Test"),a("th",null,"Specimen"),a("th",null,"Reason"),a("th",null,"Action")])],-1)),a("tbody",null,[(r(!0),u(O,null,w(e.finalOrders,(s,S)=>(r(),u("tr",{key:S},[a("td",null,p(s.name),1),a("td",null,p(s.specimen||"N/A"),1),a("td",null,p(s.reason),1),a("td",null,[n(F,{onClick:De=>e.removeOrder(s.id),slot:"end",color:"danger"},{default:o(()=>[...t[10]||(t[10]=[y("X",-1)])]),_:1},8,["onClick"])])]))),128))])])])]),_:1})):_("",!0)]),_:1})]),_:1}),e.showKeyboard?(r(),f(U,{key:0,kbConfig:e.keyboardLayout,onKeyPress:e.onFilter,disabled:!1},null,8,["kbConfig","onKeyPress"])):_("",!0)]),_:1}),n(z,null,{default:o(()=>[n(T,null,{default:o(()=>[n(F,{onClick:e.postActivities,size:"large",slot:"end",disabled:e.isPostingOrder||e.finalOrders.length===0},{default:o(()=>[...t[12]||(t[12]=[y(" Place orders ",-1)])]),_:1},8,["onClick","disabled"]),n(F,{disabled:e.isPostingOrder,onClick:t[4]||(t[4]=s=>e.closeModal([])),size:"large",slot:"start",color:"danger"},{default:o(()=>[...t[13]||(t[13]=[y(" Close ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})],64)}const Pe=Te(Oe,[["render",Le],["__scopeId","data-v-96198bde"]]);export{Pe as L};
