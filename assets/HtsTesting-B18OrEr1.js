import{bk as Q,d as Z,I as ee,K as te,dF as ie,F as c,dH as se,aj as P,ah as N,n as oe,dG as k,ct as le,_ as ne,r as S,o as ae,c as re,w as ue,b as ce}from"./index-C6EjxQ0a.js";import{T as de,K as f}from"./testKits-DzqKLRPH.js";import{H as pe}from"./HisStandardForm-CHL0RBXf.js";class ve extends Q{constructor(a,m=-1){super(a,197,m)}getRecentAccesspoint(){return this.getFirstValueCoded("HTS Access Type")}}const fe=Z({components:{IonPage:ee,HisStandardForm:pe},setup(){const b=te([]),a=new ve(-1),{htsClient:m,toOption:y,saveEncounter:C,toYesNoOption:I,mapStrToOptions:g,patientDashboardUrl:V,toConditionalOptions:H}=ie({onInitVisit:()=>{b.value=[w(),O(),F(),L(),U(),$(),K(),B(),Y(),q(),G(),W(),z(),j(),X(),J()]}});function A(e,t){C({encounterName:"Testing",encounterTypeID:a.encounterTypeID,computedData:t})}function R(e){var u;let t=!1,l=!1;for(const i of e)i.other.id==="test_1"&&i.value==="Positive"?t=!0:/test_2|test_1_repeat|test_3/i.test("".concat((u=i==null?void 0:i.other)==null?void 0:u.id))&&i.value===""&&!i.disabled&&(l=!0);return t&&l}function E(e){return parseInt("".concat(e.other.value))<=0&&!/day/i.test(e.other.timeUnit)?["Enter ".concat(e.other.timeUnit," greater than zero")]:e.other.timeUnit==="Days"&&parseInt("".concat(e.other.value))>90?["Enter ".concat(e.other.timeUnit," less than 90, use Weeks Instead")]:e.other.timeUnit==="Weeks"&&parseInt("".concat(e.other.value))>12?["Enter ".concat(e.other.timeUnit," less than 12, use Months Instead")]:e.other.timeUnit==="Months"&&parseInt("".concat(e.other.value))>24?["Enter ".concat(e.other.timeUnit," less than 24, use Years Instead")]:e.other.value.length>1&&e.other.value[0]==="0"?["Value ".concat(e.other.value," is invalid!")]:new Date(e.other.date)<new Date(m.birthDate)?["".concat(e.label," is greater than client's age of ").concat(m.age," Years")]:null}function M(){return P("Reschedule test","","HIV result is inconclusive, schedule another test in 2 weeks",[{name:"Ok",slot:"start"}])}function x(e,t){return e.tests_offered.some(l=>l.value===t)}function w(){return{id:"accesspoint_type",helpText:"Access point type",type:c.TT_SELECT,isRequired:()=>!0,finalComputedValue:e=>{const t="HTS Access Type";return{offlineMeta:{[t]:e.value},obs:a.buildValueCoded(t,e.value)}},options:()=>[{label:"Health Facility",value:"Health Facility"},{label:"Community",value:"Community"},{label:"Facility Referred from Community",value:"Health Facility"}]}}function O(){return{id:"facility_access_points",helpText:"Health facility access points",type:c.TT_SELECT_GRID,isRequired:()=>!0,condition:e=>e.accesspoint_type.value==="Health Facility",finalComputedValue:e=>({obs:a.buildValueText("Location where test took place","".concat(e.value))}),config:{columnsPerRow:2},options:()=>[{label:"1 | VCT",value:"VCT"},{label:"2 | ANC",value:"ANC First Visit"},{label:"3 | Inpatient",value:"Inpatient"},{label:"4 | STI",value:"STI"},{label:"5 | PMTCT-Follow-up (ANC FUP, Mat, Post-nat, BF)",value:"PMTCT FUP"},{label:"6 | Index",value:"Index"},{label:"7 | Paediatric",value:"Paediatric"},{label:"8 | VMMC",value:"VMMC"},{label:"9 | Malnutrition",value:"Malnutrition"},{label:"10 | TB",value:"TB"},{label:"11 | OPD",value:"OPD"},{label:"12 | Other PITC (PrEP, dental e.t.c)",value:"Other"},{label:"18 | SNS (Social Network Strategies)",value:"SNS"}]}}function F(){return{id:"community_access_points",helpText:"Community access points",type:c.TT_SELECT,condition:e=>e.accesspoint_type.value==="Community",isRequired:()=>!0,finalComputedValue:e=>({obs:a.buildValueText("Location where test took place","".concat(e.value))}),options:()=>[{label:"13 | VCT",value:"VCT"},{label:"14 | Index",value:"Index"},{label:"15 | VMMC",value:"VMMC"},{label:"16 | Other",value:"Other"},{label:"17 | SNS",value:"SNS"},{label:"19 | Mobile",value:"Mobile"}]}}function L(){let e=["HIV","Syphilis","Hepatitis B"];return{id:"tests_offered",helpText:"Tests to be offered today?",type:c.TT_MULTIPLE_SELECT,init:async()=>{try{const{getUserProp:t}=se(),u=(await t("HTS_PROGRAMS")).split(",").filter(i=>/HIV|syphilis|hepatitis/i.test(i)).map(i=>i.replace(/test/i,"").trim());u.length>=1&&(e=u)}catch(t){return console.error(t),!1}return!0},isRequired:()=>!0,condition:()=>e.length>1,defaultOutput:()=>g(e),options:()=>g(e),config:{buildOptionsOnce:!0}}}function U(){return{id:"last_hiv_result",helpText:"Last HIV Test",type:c.TT_SELECT,isRequired:()=>!0,finalComputedValue:e=>{const t="Previous HIV Test Results";return{offlineMeta:{[t]:e.value},obs:a.buildValueCoded(t,e.value)}},options:()=>H([["Never Tested"],["Negative"],["Positive"],["Exposed infant"],["Invalid or inconclusive"]])}}function $(){return{id:"last_hiv_perfomed",helpText:"Last HIV test performed",type:c.TT_SELECT,isRequired:()=>!0,condition:e=>!["Never Tested","Exposed infant"].includes(e.last_hiv_result.value),finalComputedValue:e=>{const t="Previous HIV test done";return{offlineMeta:{[t]:e.value},obs:a.buildValueCoded(t,e.value)}},defaultOutput:e=>{if(/exposed infant/i.test(e.last_hiv_result.value))return y("Professional")},options:e=>H([["Self"],["Initial professional",!/Negative|Inconclusive/i.test(e.last_hiv_result.value)],["Professional"]])}}function K(){return{id:"last_time_hiv_tested",helpText:"Time since last HIV test",type:c.TT_AGE_INPUT,condition:e=>e.last_hiv_result.value&&e.last_hiv_result.value!="Never Tested",isRequired:()=>!0,beforeNext:async(e,t)=>(e.other.monthsAgoInt>=12&&!x(t,"HIV")&&await P("Recommendation Alert","","Please consider testing client for HIV",[{name:"Ok",slot:"start",color:"primary"}]),!0),validation:e=>E(e),finalComputedValue:e=>{const t="Time of HIV test";return{offlineMeta:{[t]:e.value},obs:a.buildObs(t,{value_datetime:e.other.date,value_text:e.value})}},config:{excludeUnits:["Hours"]}}}function B(){return{id:"last_taken_drugs",helpText:"Ever taken the following drugs?",type:c.TT_MULTIPLE_YES_NO,isRequired:()=>!0,finalComputedValue:e=>({obs:e.map(t=>a.buildValueCoded(t.other.concept,t.value))}),options:e=>e.last_taken_drugs?e.last_taken_drugs:[I("PrEP or infant NVP",{concept:"Taken Prep before"}),...(()=>{var t;return"".concat((t=e.last_hiv_result)==null?void 0:t.value)!="Negative"?[I("ART",{concept:"Taken ARV Before"})]:[]})(),I("PEP",{concept:"Taken PEP before"})]}}function Y(){return{id:"drug_taken",helpText:"Most recent drug taken",type:c.TT_SELECT,isRequired:()=>!0,condition:e=>{let t=0;for(const l of e.last_taken_drugs){if(l.label==="ART"&&l.value==="Yes")return!1;l.value==="Yes"&&++t}return t>1},defaultOutput:e=>{const t=e.last_taken_drugs.find(l=>l.label==="ART");if((t==null?void 0:t.value)==="Yes")return y("ART")},finalComputedValue:e=>{const t="Most recent drug taken";return{offlineMeta:{[t]:e.value},obs:a.buildValueCoded(t,e.value)}},options:e=>e.last_taken_drugs.filter(t=>t.value==="Yes").map(t=>y(t.label))}}function q(){return{id:"most_recent_drug",helpText:"Most recent drug",type:c.TT_HIDDEN,condition:e=>e.last_taken_drugs.filter(t=>t.value==="Yes").length===1,defaultValue:e=>N.find(e.last_taken_drugs,{value:"Yes"}),finalComputedValue:e=>({obs:a.buildValueCoded("Most recent drug taken",e.value)})}}function G(){return{id:"time_since_last_drug_taken",helpText:"Time since last taken medication",type:c.TT_AGE_INPUT,condition:e=>e.last_taken_drugs.some(t=>t.value==="Yes"),finalComputedValue:e=>{const t="Time since last taken medication";return{offlineMeta:{[t]:e.value},obs:a.buildObs(t,{value_text:"".concat(e.value," ago"),value_datetime:e.other.date})}},validation:e=>E(e),isRequired:()=>!0,config:{excludeUnits:["Hours"]}}}function W(){return{id:"client_risk_category",helpText:"Client Risk Category",type:c.TT_SELECT,isRequired:()=>!0,finalComputedValue:e=>{const t="client risk category";return{offlineMeta:{[t]:e.value},obs:a.buildValueCoded(t,e.value)}},options:()=>g(["Low risk","On-going risk","High risk event in last 3 months","Risk assessment not done"])}}function j(){return{id:"test_kit",helpText:"Kit information",type:c.TT_INPUT_ARRAY,condition:e=>e.test_results.filter(t=>t.value!="").some(t=>!(t.other.expiryDate&&t.other.lotNo)),config:{columns:[{label:"Kit Name"},{label:"Kit Lot No."},{label:"Kit Expiry Date"}]},summaryMapValue:e=>({label:"Kit: ".concat(e.label),value:"Lot No: ".concat(e.value||e.other.fields[1].value)}),validation:e=>{const t=e.map(i=>i.other.fields);return t.some(i=>{const o=i.filter(n=>n.value!="").length;return o>0&&o<3})?["Some rows have incomplete data!"]:t.some(i=>i.some(o=>o.value===""))?["Some rows are missing data"]:null},finalComputedValue:e=>({obs:e.map(t=>t.other.fields).map(async t=>{const[l,...u]=t.filter(i=>typeof i.other.obs=="function").map(i=>i.other.obs(i));return{...await l,child:await Promise.all(u)}})}),defaultOutput:e=>{const t=e.test_results.filter(l=>l.value!="");if(t.every(l=>l.other.expiryDate&&l.other.lotNo))return t.map(l=>({label:l.label,value:l.other.lotNo,other:{fields:[{label:"Kit name",value:l.label,other:{obs:()=>a.buildValueText("Kit name",l.label)}},{label:"Kit Lot No",value:l.other.lotNo,other:{obs:()=>a.buildValueText("Kit lot number",l.other.lotNo)}},{label:"Kit expiry date",value:l.other.expiryDate,other:{obs:()=>a.buildValueDate("kit expiry date",l.other.expiryDate)}}]}}))},options:async e=>{const t=Array.isArray(e.test_results)?e.test_results:[],l=n=>({label:"Kit Name",value:n,clearable:!1,other:{usefontBold:!0,obs:r=>a.buildValueText("Kit name",r.label)}}),u=n=>({label:"Kit Lot No.",value:n,other:{obs:r=>a.buildValueText("Kit lot number",r.value),onclick:r=>{k({id:"lot",helpText:"Enter Lot Number",type:c.TT_TEXT,isRequired:()=>!0},d=>{r.value=d.value})}}}),i=n=>({label:"Kit Expiry Date",value:n,other:{obs:r=>a.buildValueDate("kit expiry date",r.value),onclick:r=>{k({id:"end_user",helpText:"Kit Expiry Date",type:c.TT_FULL_DATE,isRequired:()=>!0,validation:d=>new Date(d.label)<new Date(a.date)?["Expiry date cannot be less than current date "+le(a.date)]:null},d=>{r.value=d.value})}}}),o=e.test_kit===null?[]:e.test_kit;return t.filter(n=>n.value!="").map(n=>{const r=N.find(o,{label:n.label});return r||{label:n.label,value:"",other:{fields:[l(n.other.shortName),u(n.other.lotNo),i(n.other.expiryDate)]}}})}}}function z(){const{getLotNo:e,getExpiryDate:t,initKits:l}=de(),u=(i,o,n)=>!!N.find(i,{value:n,other:{id:o}});return{id:"test_results",helpText:"Test results",type:c.TT_MULTIPLE_YES_NO,config:{requireAllValues:!1},summaryMapValue:i=>{const o={Positive:"Reactive",Negative:"Non-reactive"};if(i.value!="")return{label:i.label,value:o[i.value]||i.value}},beforeNext:async(i,o)=>{const n=u(i,"test_2","Negative")&&u(i,"test_1_repeat","Positive")||u(i,"test_2","Positive")&&u(i,"test_3","Negative");return/inconclusive/i.test(o.last_hiv_result.value)&&n?(await P("Inconclusive Re-Test Result","","Please collect DBS sample.",[{name:"Ok",slot:"start"}]),!0):n?(await M(),!0):(u(i,"test_1","Positive")&&u(i,"test_2","Positive")&&u(i,"test_3","Positive")&&m.age<=0&&await P("<12 months old all HIV tests reactive","","Please collect DBS sample for EID",[{name:"Ok",slot:"start"}]),!(o.accesspoint_type.value!="Community"&&R(i)&&!await oe("Are you sure you want to save incomplete HIV results?",{header:"Incomplete HIV results!"})))},onValueUpdate:(i,o,n)=>{if(x(n,"HIV")&&n.accesspoint_type.value==="Health Facility"){const r=[...i],d=u(r,"test_1","Positive"),h=u(r,"test_2","Positive"),s=(_,p)=>{r.forEach(T=>{T.other.id===_&&(T.disabled=p,p&&(T.value=""))})};if(d)s("test_2",!1);else return s("test_2",!0),s("test_3",!0),s("test_1_repeat",!0),r;return d&&h?(s("test_3",!1),s("test_1_repeat",!0),r):(d&&!h&&i.some(_=>_.other.id==="test_2"&&_.value!="")&&(s("test_1_repeat",!1),s("test_3",!0)),r)}return i},validation:i=>!i||i.some(o=>{var n;return/syphilis|hepatitis|test_1/i.test("".concat((n=o==null?void 0:o.other)==null?void 0:n.id))&&o.value===""&&!o.disabled})?["Result entry incomplete!"]:null,finalComputedValue:i=>({offlineMeta:i.filter(o=>o.value).reduce((o,n)=>({...o,[n.other.concept]:n.value}),{}),obs:i.filter(o=>o.value&&typeof o.other.obs=="function").map(o=>o.other.obs(o))}),init:async()=>(await l(),!0),condition:i=>i.tests_offered.length,options:i=>{const o=(s={})=>({label:s.name,value:"",disabled:typeof(s==null?void 0:s.disabled)=="boolean"?s.disabled:!1,other:{id:(s==null?void 0:s.id)||"",concept:(s==null?void 0:s.concept)||"",shortName:(s==null?void 0:s.shortName)||"",category:(s==null?void 0:s.category)||"",expiryDate:(s==null?void 0:s.expiryDate)||"",lotNo:(s==null?void 0:s.lotNo)||"",obs:typeof(s==null?void 0:s.obs)=="function"?s.obs:void 0,accessPoint:(s==null?void 0:s.accessPoint)||"*",values:[{label:"Reactive",value:"Positive"},{label:"Non-reactive",value:"Negative"}]}}),n=[o({id:"test_1",name:"HIV Test 1 (Determine)",category:"HIV",shortName:"Determine",lotNo:e(f.DETERMINE),expiryDate:t(f.DETERMINE),concept:"Test 1",obs:s=>a.buildValueCoded(s.other.concept,s.value)}),o({id:"test_2",name:"HIV Test 2 (Unigold)",category:"HIV",disabled:!0,accessPoint:"Health Facility",shortName:"Unigold",concept:"Test 2",lotNo:e(f.UNIGOLD),expiryDate:t(f.UNIGOLD),obs:s=>a.buildValueCoded(s.other.concept,s.value)}),o({id:"test_1_repeat",name:"HIV Test 1 (Determine) Repeat",category:"HIV",disabled:!0,shortName:"Determine (Repeat)",accessPoint:"Health Facility",concept:"Immediate Repeat Test 1 Result",lotNo:e(f.DETERMINE),expiryDate:t(f.DETERMINE),obs:s=>a.buildValueCoded(s.other.concept,s.value)}),o({id:"test_3",name:"HIV Test 3 (Bioline)",category:"HIV",disabled:!0,shortName:"Bioline",accessPoint:"Health Facility",concept:"Test 3",lotNo:e(f.BIOLINE),expiryDate:t(f.BIOLINE),obs:s=>a.buildValueCoded(s.other.concept,s.value)}),o({id:"syphilis",name:"Syphilis Test Result",category:"Syphilis",shortName:"Syphilis",concept:"Syphilis Test Result",lotNo:e(f.SYPHILIS),expiryDate:t(f.SYPHILIS),obs:s=>a.buildValueCoded(s.other.concept,s.value)}),o({id:"hepatitis",name:"Hepatitis B Test Result",category:"Hepatitis B",shortName:"Hepatitis B",concept:"Hepatitis B Test Result",lotNo:e(f.HEPATITIS),expiryDate:t(f.HEPATITIS),obs:s=>a.buildValueCoded(s.other.concept,s.value)})],r=i.accesspoint_type.value,d=Array.isArray(i.test_results)?i.test_results:[],h=n.reduce((s,_)=>{const p=N.find(d,{label:_.label});return p?(p.other.accessPoint!="*"&&p.other.accessPoint!=r&&(p.value=""),s.push(p)):s.push(_),s},[]);return i.tests_offered.reduce((s,_)=>{const p=h.filter(T=>T.other.category===_.value&&(T.other.accessPoint===r||T.other.accessPoint==="*"));return p.length?s.concat(p):s},[])}}}function X(){let e="";return{id:"hiv_result",helpText:"HIV Result",type:c.TT_HIDDEN,appearInSummary:()=>!1,condition:t=>x(t,"HIV"),onload:t=>{let l=t.last_hiv_perfomed!=null,u=t.last_hiv_result!=null,i="",o="",n="",r="";const d=t.test_results||[],h=t.accesspoint_type.value==="Community",s=()=>{var v;return(v=t.last_hiv_result)==null?void 0:v.value},_=()=>{var v;return(v=t.last_hiv_perfomed)==null?void 0:v.value};d.forEach(v=>{switch(v.other.id){case"test_1":i=v.value;break;case"test_2":o=v.value;break;case"test_3":n=v.value;break;case"test_1_repeat":r=v.value;break}});const p=()=>u&&l&&s()==="Positive"&&_()==="Professional"&&(i==="Negative"||o==="Negative"||n==="Negative"),T={Incomplete:()=>[t.accesspoint_type.value!="Community",R(d)],Negative:()=>[!p(),i==="Negative"||o==="Negative"||n==="Negative"||r==="Negative"],Positive:()=>[!h,n==="Positive"],Inconclusive:()=>[!h,p()||o==="Negative"&&r==="Positive"||o==="Positive"&&n==="Negative"],"Positive Initial Professional":()=>[h,i==="Positive"]};e=Object.keys(T).reduce((v,D)=>T[D]().every(Boolean)?D:v,"Not indicated")},defaultValue:()=>{if(e)return y(e)},finalComputedValue:()=>{if(e){const t="HIV status";return{offlineMeta:{[t]:e},obs:a.buildValueCoded(t,e)}}}}}function J(){let e="N/A";return{id:"patient_category",helpText:"Result given to client",type:c.TT_HIDDEN,onload:t=>{if(!t.hiv_result)return;const l=t.hiv_result.value,u=m.age,i=t.last_hiv_result.value,o=t.last_hiv_perfomed!=null?t.last_hiv_perfomed.value:"",n=t.last_time_hiv_tested!=null?t.last_time_hiv_tested.other.monthsAgoInt:-1,r={"New Positive":[l==="Positive",/never tested|negative|exposed|inconclusive/i.test(i)||i==="Positive"&&/initial professional|self/i.test(o)&&n<=12],"New exposed infant":[u<=0,l==="Positive"],"Positive Re-test":[l==="Positive",i==="Positive",o==="Professional"],"Inconclusive Re-test":[i==="Positive",l==="Inconclusive",o==="Professional"],"New Negative":[l==="Negative"],"New Inconclusive":[l==="Inconclusive",/self/i.test(o)&&/invalid/i.test(i)||/never tested|negative|exposed infant/i.test(i)||i==="Positive"&&/self|initial professional/i.test(o)]};e=Object.keys(r).reduce((d,h)=>r[h].every(Boolean)?h:d,"N/A")},defaultValue:()=>{if(e!="N/A")return y(e)},finalComputedValue:()=>{if(e!="N/A"){const t="HIV group";return{offlineMeta:{[t]:e},obs:a.buildValueCoded(t,e)}}},condition:t=>t.hiv_result.value}}return{fields:b,onFinish:A,patientDashboardUrl:V}}});function he(b,a,m,y,C,I){const g=S("his-standard-form"),V=S("ion-page");return ae(),re(V,null,{default:ue(()=>[ce(g,{formLabel:"Testing",fields:b.fields,onFinishAction:b.onFinish,cancelDestinationPath:b.patientDashboardUrl()},null,8,["fields","onFinishAction","cancelDestinationPath"])]),_:1})}const me=ne(fe,[["render",he]]);export{me as default};
