System.register(["./index-legacy-CNrLGT3P.js","./HisStandardForm-legacy-OekRIZB_.js"],(function(e,t){"use strict";var i,a,s,o,r,n,d,l,c,u,h,p,m,v,_,y,T,g,f,w;return{setters:[e=>{i=e.d,a=e.aU,s=e.a2,o=e.Y,r=e.bw,n=e.T,d=e.bx,l=e.ah,c=e.t,u=e.q,h=e.H,p=e.F,m=e.V,v=e.b1,_=e.U,y=e._,T=e.r,g=e.o,f=e.c},e=>{w=e.H}],execute:function(){const t=i({components:{HisStandardForm:w},data:()=>({app:a.getActiveApp(),formKey:0,fields:[],activity:"",presets:{},programs:{},userData:{},fieldComponent:"",isSessionPasswordChange:!1,activeField:"",form:{}}),watch:{$route:{async handler(e){if(!e)return;const{query:t}=e;["edit","add"].includes(t.activity)?this.activity=t.activity:this.activity="add",t.update_password&&(this.userData=this.toUserData(await s.getCurrentUser()),this.isSessionPasswordChange=!0,this.activeField="new_password",this.fieldComponent=this.activeField),this.programs=this.removeObjectsByApplicationNames(s.getAvailableApps(),["CRVS"]),this.fields=this.getFields()},immediate:!0,deep:!0}},methods:{async onFinish(e,t){try{switch(this.activity){case"add":await this.create(t),this.activity="edit";break;case"edit":if(await this.update(t),this.isSessionPasswordChange){const e=new o;e.sessionDate=await s.getApiDate(),await e.resetUserPasswordChangeCheck(),this.$router.push("/")}}e.hts_provider_code&&await s.setUserProperty(r,e.hts_provider_code.value,this.userData.id),n.invalidate("PROVIDERS"),this.activeField="user_info",this.$nextTick((()=>this.fieldComponent=this.activeField)),this.formKey+=1}catch(i){i instanceof d&&!l.isEmpty(i.errors)?c(i.errors):u(`${i}`)}},removeObjectsByApplicationNames:(e,t)=>e.filter((e=>!t.includes(e.applicationName))),async create(e){const{user:t}=await s.createUser(e);if(t)return this.userData=this.toUserData(t);throw"Unable to create new user, Possibly the user already exists or incorrect info was entered"},async update(e){const t=await s.updateUser(this.userData.id,e);if(t)return this.userData=this.toUserData(t);throw"Unable to update user, possibly server error or incorrect information entered"},getProgramName(e){const t=l.find(this.programs,{programID:e});return t?t.applicationName:""},mapToOption:e=>e.map((e=>({label:e,value:e}))),async getRoles(){return(await s.getAllRoles()).filter((e=>{try{return!this.userData.role.split(",").includes(e.role)}catch(t){return!0}})).map((e=>({label:e.role,value:e.role,other:e})))},toUserData(e){const t=e.person.names[0];return{id:e.user_id,given_name:t.given_name,family_name:t.family_name,username:e.username,role:e.roles.map((e=>e.role)),created:h.toStandardHisDisplayFormat(e.date_created),status:e.deactivated_on?"Inactive":"Active",programs:e.programs.map((e=>e.program_id))}},editConditionCheck(e=[]){return"edit"!==this.activity||e.includes(this.activeField)},toLcase:e=>e.value.toString().toLowerCase(),getFields:function(){return[{id:"select_user",helpText:"Select Username",type:p.TT_SELECT,condition:()=>"edit"===this.activity&&s.isAdmin(),validation:e=>m.required(e),unload:({other:e})=>this.userData=this.toUserData(e),options:async()=>(await s.getAllUsers()).map((e=>({label:e.username,value:e.user_id,other:e}))),config:{showKeyboard:!0}},{id:"user_info",helpText:"User information",type:p.TT_TABLE_VIEWER,dynamicHelpText:()=>`User: ${this.userData.username} | Added On: ${this.userData.created}`,condition:()=>"edit"===this.activity&&s.isAdmin(),options:async(e,t,i)=>{const a=e=>({name:"Active"===e?"Deactivate":"Activate",type:"button",style:{width:"65%",fontWeight:"bold"},color:"Active"===e?"danger":"success",action:async()=>{try{"Active"===e&&(await s.deactivateUser(this.userData.id),this.userData.status="Inactive",i.rows[3]=["Status","Inactive",a("Inactive")],_("User has been deactivated",400)),"Inactive"===e&&(await s.activateUser(this.userData.id),this.userData.status="Active",i.rows[3]=["Status","Active",a("Active")],_("User has been activated",400))}catch(t){c(`${t}`)}}}),o=(e,t)=>({name:e,type:"button",color:"light",style:{fontWeight:"bold",width:"65%"},action:()=>{this.activeField=t,this.fieldComponent=this.activeField}}),n=[o("Add/Append Role","roles")];this.userData.role.length>1&&n.push(o("Remove Role","remove_roles"));const d=[["<b>Name</b>",`${this.userData.given_name} ${this.userData.family_name}`,o("Edit Name","given_name"),""],["<b>Password</b>","*******",o("Change password","new_password"),""],["<b>Role</b>",this.userData.role.join("<br/>"),...n],["<b>Status</b>",this.userData.status,a(this.userData.status),""],["<b>Programs</b>",this.userData.programs.map((e=>this.getProgramName(e))).join("<br/>"),o("Edit Program","programs"),""]];if("ITS"===this.app?.applicationName){let e="N/A";try{e=(await s.getUserProperty(r,this.userData.id)).property_value}catch(l){console.error(l)}d.push(["<b>Provider Code</b>",e,o("Update","has_hts_provider_code"),""])}return[{label:"",value:"",other:{columns:["Attributes","Values","Actions"],rows:d}}]},config:{hiddenFooterBtns:["Clear"],overrideDefaultFooterBtns:{nextBtn:{name:"Finish",onClick:()=>this.$router.back()}}}},{id:"given_name",helpText:"First name",type:p.TT_TEXT,computedValue:e=>e.value,defaultValue:()=>this.userData.given_name,condition:()=>this.editConditionCheck(["given_name"])&&s.isAdmin(),validation:e=>m.isName(e),options:async e=>{if(!e.given_name||null===e.given_name.value)return[];const t=await v.searchGivenName(e.given_name.value);return this.mapToOption(t)}},{id:"family_name",helpText:"Last name",type:p.TT_TEXT,computedValue:e=>e.value,defaultValue:()=>this.userData.family_name,validation:e=>m.isName(e),condition:()=>this.editConditionCheck(["given_name"])&&s.isAdmin(),options:async e=>{if(!e.family_name||null===e.family_name.value)return[];const t=await v.searchFamilyName(e.family_name.value);return this.mapToOption(t)}},{id:"roles",helpText:"Role",type:p.TT_SELECT,computedValue:e=>[e.value],condition:()=>this.editConditionCheck(["roles"])&&s.isAdmin(),validation:e=>m.required(e),options:()=>this.getRoles(),config:{showKeyboard:!0}},{id:"remove_roles",helpText:"Remove Roles",proxyID:"roles",type:p.TT_SELECT,validation:e=>m.required(e),condition:()=>this.editConditionCheck(["remove_roles"])&&s.isAdmin()&&"edit"===this.activity,computedValue:e=>this.userData.role.filter((t=>t!=e.label)),options:()=>this.mapToOption(this.userData.role),config:{showKeyboard:!0}},{id:"must_append_roles",helpText:"Would you like to append role?",type:p.TT_SELECT,computedValue:e=>"Yes"===e.label,condition:()=>"edit"===this.activity&&this.editConditionCheck(["roles"])&&s.isAdmin(),defaultComputedOutput:()=>!1,validation:e=>m.required(e),options:()=>[{label:"Yes",value:"true"},{label:"No",value:"false"}]},{id:"programs",helpText:"Select Apps",type:p.TT_MULTIPLE_SELECT,condition:()=>s.isAdmin()&&this.editConditionCheck(["programs"]),validation:e=>m.required(e),computedValue:e=>e.map((e=>e.value)),options:()=>this.programs.map((e=>{let t=!1;return"edit"===this.activity&&(t=this.userData.programs.includes(e.programID)),{label:e.applicationName,value:e.programID,isChecked:t}}))},{id:"username",helpText:"Username",type:p.TT_TEXT,condition:()=>this.editConditionCheck(["nothing to see here"])&&s.isAdmin(),computedValue:e=>this.toLcase(e),validation:e=>m.validateSeries([()=>m.required(e),()=>m.hasLengthRangeOf(e,4,15)]),config:{casing:"lowercase"}},{id:"has_hts_provider_code",helpText:"HTS Provider code",type:p.TT_YES_NO,isRequired:()=>!0,beforeNext:async(e,t)=>{if("No"===e){const e=null!=t.select_user?t.select_user.label:null!=t.username?t.username.value:"01010";await c("HTS provider code assigned is "+e)}return!0},condition:e=>{const t=["add"===this.activity,e.programs.some((e=>"ITS"===e.label)),"Provider"===e.roles.label].every(Boolean),i=["edit"===this.activity,s.isAdmin(),"ITS"===this.app?.applicationName,this.editConditionCheck(["has_hts_provider_code"])].every(Boolean);return t||i},options:()=>[{label:"Does user have HTS Code?",values:[{label:"Yes",value:"Yes"},{label:"No",value:"No"}]}]},{id:"username_provider_code",proxyID:"hts_provider_code",helpText:"HTS Provider code",type:p.TT_HIDDEN,computedValue:e=>e.value,defaultValue:e=>{const t=e.username?.value||e.select_user.label;return{label:t,value:t}},condition:e=>"No"===e.has_hts_provider_code&&this.editConditionCheck(["has_hts_provider_code"])},{id:"official_hts_provider_code",proxyID:"hts_provider_code",helpText:"HTS Provider code",type:p.TT_TEXT,isRequired:()=>!0,computedValue:e=>e.value,condition:e=>"Yes"===e.has_hts_provider_code&&this.editConditionCheck(["has_hts_provider_code"]),beforeNext:async e=>await s.userPropertyExists(r,`${e.value}`)?(c("Provider code already registered!"),!1):!!(await s.providerCodeRegisteredWithDHA(`${e.value}`))||(c("Provider code is not registered with DHA"),!1),validation:e=>/^[a-zA-Z0-9]{4}$/i.test(`${e.value}`)?null:["Invalid provider code format"]},{id:"new_password",proxyID:"password",helpText:"New Password",type:p.TT_TEXT,computedValue:e=>this.toLcase(e),condition:()=>this.editConditionCheck(["new_password"]),validation:e=>m.validateSeries([()=>m.required(e),()=>m.hasLengthRangeOf(e,4,15)]),config:{inputType:"password"}},{id:"verify_password",proxyID:"password",helpText:"Confirm Password",type:p.TT_TEXT,computedValue:e=>this.toLcase(e),condition:()=>this.editConditionCheck(["new_password"]),validation:(e,t)=>m.validateSeries([()=>m.required(e),()=>{if(this.toLcase(t.verify_password)!=this.toLcase(t.new_password))return["New password does not match current password"]}]),config:{inputType:"password"}}]}}});e("default",y(t,[["render",function(e,t,i,a,s,o){const r=T("his-standard-form");return g(),f(r,{key:e.formKey,fields:e.fields,skipSummary:!0,activeField:e.fieldComponent,onOnIndex:t[0]||(t[0]=t=>e.fieldComponent=""),onFinishAction:e.onFinish},null,8,["fields","activeField","onFinishAction"])}]]))}}}));
