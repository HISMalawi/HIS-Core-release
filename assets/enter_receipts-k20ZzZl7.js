import{ao as m,d as g,R as f,am as _,ad as n,ae as u,bY as b,aN as p,W as h,de as v,H as y,dm as T,aa as D,c as S,af as E,a as F}from"./index-CMZASHAR.js";import{H as x}from"./HisStandardForm-BCjM4-bc.js";class C extends m{constructor(){super()}static getDrugs(t={}){return super.getJson("/drug_cms",t)}static search(t=""){return super.getJson("/drug_cms/search",{keyword:t})}}const k=g({components:{HisStandardForm:x},data:()=>({activeField:"",fields:[],drugs:[],selectedDrugs:[],barcode:"",stockService:{}}),methods:{async onFinish(e){const t=this.prepDrugs(e);await this.stockService.postItems(t)?(f("Stock succesfully added"),this.$router.push("/")):_("Could not save stock")},getFields(){return[{id:"transfer_origination",helpText:"Select where stock came from",type:n.TT_SELECT,validation:e=>u.required(e),options:()=>[{label:"DHA",value:"DHA"},{label:"Other location",value:"Other location"}]},{id:"transfer_location",helpText:"Location",type:n.TT_SELECT,validation:e=>u.required(e),condition:e=>e.transfer_origination.value==="Other location",options:(e,t="")=>b(t),computedValue:e=>e.label,config:{showKeyboard:!0,isFilterDataViaApi:!0}},{id:"barcode",helpText:"Scan barcode",type:n.TT_BARCODE,config:{hiddenFooterBtns:["Clear","Next"]},onValue:async e=>{this.barcode=e,this.activeField="select_drugs"},condition:e=>e.transfer_origination.value==="DHA"},{id:"select_drugs",helpText:"Select drugs",type:n.TT_MULTIPLE_SELECT,requireNext:!0,validation:e=>u.required(e),options:()=>this.drugs,unload:e=>this.selectedDrugs=e,config:{showKeyboard:!0,footerBtns:[{name:"Select all",slot:"end",onClickComponentEvents:{refreshOptions:()=>(this.drugs=this.selectAll(this.drugs),this.drugs)},onClick:()=>"NONE"}]}},{id:"date",helpText:"Delivery Date",type:n.TT_FULL_DATE,validation:e=>u.required(e)},{id:"enter_batches",helpText:"Batch entry",type:n.TT_BATCH_ENTRY,options:()=>this.selectedDrugs,beforeNext:(e,t,l,{currentFieldContext:o})=>{const s=i=>i.map(a=>"".concat(a.label)).join(" & "),r=o.drugs.filter(i=>i.entries.map(a=>!a.tins&&!a.expiry&&!a.batchNumber&&!a.tabs).every(Boolean)),d=o.drugs.filter(i=>i.entries.map(a=>{let c=0;return a.tins&&(c+=1),a.expiry&&(c+=1),a.batchNumber&&(c+=1),a.tabs&&(c+=1),c>=1&&c<=3}).some(Boolean));if(!p.isEmpty(d)){const i=s(d);return h("Please fix partial batch entries for drugs: ".concat(i)),!1}if(!p.isEmpty(r)){const i=s(r);return h("The following drug batches are empty: ".concat(i)),!1}return!0},validation:e=>u.required(e),config:{entryDate:e=>e.date.value}},{id:"summary",helpText:"Summary",type:n.TT_TABLE_VIEWER,options:e=>this.buildResults(e.enter_batches),config:{hiddenFooterBtns:["Clear"]}}]},buildResults(e){const t=["Drug","Amount per unit","Tins/Pallets","Expiry date","Batch number"],l=e.map(o=>{const s=o.value;return[s.short_name,s.tabs,v(s.tins),y.toStandardHisDisplayFormat(s.expiry),s.batchNumber]});return[{label:"Confirm entry",value:"Table",other:{columns:t,rows:l}}]},prepDrugs(e){const t=[],l=this.barcode,o=e.transfer_origination.value==="DHA"?null:e.transfer_location.value;return e.enter_batches.forEach(s=>{const r=s.value;t.push({batch_number:r.batchNumber,location_id:o,items:[{barcode:l,drug_id:r.drug_inventory_id,expiry_date:r.expiry,quantity:parseInt(r.tabs)*parseInt(r.tins),delivery_date:e.date.value,product_code:r.code,pack_size:r.tabs}]})}),t},selectAll(e){return e.map(t=>(t.isChecked=!0,t))},async loadDrugs(){const e=await C.getDrugs({pagenate:!1});this.drugs=e.map(t=>({label:"".concat(t.short_name," (").concat(t.code,")"),value:t}))}},created(){this.stockService=new T,this.loadDrugs(),this.fields=this.getFields()}});function A(e,t,l,o,s,r){const d=E("his-standard-form");return F(),S(d,{fields:e.fields,activeField:e.activeField,onFinishAction:e.onFinish,skipSummary:!0,onOnIndex:t[0]||(t[0]=i=>e.activeField="")},null,8,["fields","activeField","onFinishAction"])}const $=D(k,[["render",A]]);export{$ as default};
