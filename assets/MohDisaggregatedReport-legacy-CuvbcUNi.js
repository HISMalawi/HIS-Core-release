System.register(["./index-legacy-CNrLGT3P.js","./disaggregated_service-legacy-GzxbCxPv.js","./TableView-legacy-DSuuxKFH.js","./ArtDrilldown-legacy-BX7rPIVx.js","./regimen_report_service-legacy-nd-as-fr.js","./moh_cohort_service-legacy-DCfa07BQ.js","./ReportErrors-legacy-C_GtpKAy.js","./fuse-legacy-CQoBB3MK.js","./HisKeyboard-legacy-DlfcKdJX.js"],(function(e,t){"use strict";var a,r,o,n,l,s,g,i,c,u,d,p,b,f,v,m,y,h,_,D,w,A,F,x,q,$,P,R,j,G,O;return{setters:[e=>{a=e.d,r=e.I,o=e.cm,n=e.K,l=e.E,s=e.N,g=e.ct,i=e.af,c=e.n,u=e.q,d=e.cW,p=e.t,b=e.co,f=e.O,v=e.ah,m=e.cn,y=e.cp,h=e.cr,_=e.cq,D=e._,w=e.r,A=e.o,F=e.c,x=e.w,q=e.b},e=>{$=e.D},e=>{P=e.v},e=>{R=e.A},e=>{j=e.R},e=>{G=e.M},e=>{O=e.R},null,null],execute:function(){const t=a({components:{IonPage:r,IonLoading:o,v2Datatable:P},setup(){const e=n(!1),t=n([]),a=n(""),r=n(""),o=n(!1),D=new $,w=new G,A=n([]),F=l(),x=async e=>{(await f.create({component:R,backdropDismiss:!1,cssClass:"large-modal",componentProps:{...e,subtitle:a.value,onFinish:()=>f.getTop().then((e=>e&&f.dismiss()))}})).present()},q=(e,t)=>({ref:t,label:e,defaultValue:"0",toValue:e=>e.length,tdClick:async e=>{e.refData.length&&x({patientIdentifiers:e.refData,title:`${e.data.age_group} ${e.data.gender} ${e.column.label}`})}}),P=[[{label:"#",ref:"index"},{label:"Age group",ref:"age_group"},{label:"Gender",ref:"gender"},q("TX curr (receiving ART)","tx_curr"),...j.reduce(((e,t)=>[...e,q(t,t)]),[]),q("Unknown","N/A"),q("Total (regimen)","regimen_total")]],k=[...j,"N/A"].reduce(((e,t)=>({...e,[t]:[]})),{}),B=function(e){const t=A.value.findIndex((t=>t.id===e.id));-1!==t?A.value[t]=e:A.value.push(e)},M=async function(e){const t="validationErrors";(await f.create({id:t,component:O,backdropDismiss:!1,cssClass:"large-modal",componentProps:{errors:e}})).present(),B({id:t,text:`<b>${e.length}</b> validation errors detected`,icon:h,color:"danger",action:()=>M(e)})},T=async(a=!1)=>{if(!e.value)return u("Unable to generate report, return to cohort report");o.value=!0;const n=["Pregnant","Breastfeeding"],l={F:{label:"Female",rows:[],aggregate:{},excludedAgeGroups:n},M:{label:"Male",rows:[],aggregate:{},excludedAgeGroups:n},FP:{label:"Pregnant",rows:[],aggregate:{},gender:"F",ageGroup:"All",genderDisplay:"FP",excludedAgeGroups:[...d,"Breastfeeding"]},FBF:{label:"Breastfeeding",rows:[],aggregate:{},gender:"F",ageGroup:"All",genderDisplay:"FBF",excludedAgeGroups:[...d,"Pregnant"]}},s=(e=!1)=>{const a=Object.keys(l.FP.aggregate).reduce(((e,t)=>({...e,[t]:[...l.FP.aggregate[t]||[],...l.FBF.aggregate[t]||[]]})),{}),o=Object.keys(l.F.aggregate).reduce(((e,t)=>({...e,[t]:e[t].filter((e=>!Array.isArray(a[t])||!a[t].includes(e)))})),l.F.aggregate);t.value=[...l.F.rows,...l.M.rows,{age_group:"All",gender:"Male",...l.M.aggregate},...l.FP.rows,{age_group:"All",gender:"FNP",...o},...l.FBF.rows];const n=v.uniq([...l.M.aggregate.tx_curr||[],...l.F.aggregate.tx_curr||[]]),s={text:`Total alive and on ART: <b>${n.length}</b>`,icon:m,color:"primary",action:()=>x({patientIdentifiers:n,title:`Total alive and on ART: ${n.length}`})};e?(A.value=[s],(async e=>{const t={total_alive_and_on_art:{param:e.length,check:(e,t)=>e!=t,error:(e,t)=>`\n                        Total alive of <b>${t}</b>\n                        Does not match total alive of <b>${e}</b> on MOH report\n                    `}};-1===w.validateIndicators(t,(e=>{e.length?M(e):B({id:"reportOk",text:"<b>Report is consistent</b>",icon:_,color:"success"})}))&&M(["Report not validated. Run the MoH cohort report for similar reporting period and then run this report"])})(n)):A.value=[s,{text:r.value,icon:y,color:"dark"}]};try{if(D.setRebuildOutcome(a),!(await D.init()))return p("Unable to initialise report");for(const e of[...d,...n]){r.value=`Processing <b>${e}</b>`,D.setAgeGroup(e);const t=await D.getCohort();D.setRebuildOutcome(!1);for(const a of Object.keys(l)){if((l[a].excludedAgeGroups||[]).includes(e))continue;D.setGender(a),l[a].ageGroup&&D.setAgeGroup(l[a].ageGroup);const r=await D.getRegimenDistribution(),o={age_group:l[a]?.ageGroup||e,gender:l[a]?.genderDisplay||l[a].label,...t[e]?t[e][l[a]?.gender||a]:{},...k,...r,regimen_total:Object.values(r).flat(1)};l[a].rows.push(o),l[a].aggregate=Object.keys(o).reduce(((e,t)=>Array.isArray(o[t])?{...e,[t]:[...e[t]||[],...o[t]]}:e),l[a].aggregate),s(!1)}}s(!0),t.value=t.value.map(((e,t)=>({index:t+1,...e})))}catch(g){const e="Unable to generate report!";u(e),A.value=[{text:e,color:"danger",icon:b,action:function(){A.value=[{text:`Exception occured: <b>${g}</b>`,color:"danger",icon:b}]}}]}o.value=!1,r.value=""};return s((()=>{e.value=!!(F.query.start_date&&F.query.end_date&&F.query.quarter),e.value&&(D.setStartDate(`${F.query.start_date}`),D.setEndDate(`${F.query.end_date}`),D.setOccupation(`${F.query.occupation}`),w.setOccupation(D.occupation),w.setStartDate(D.startDate),w.setEndDate(D.endDate),a.value=`${g(D.startDate)} to ${g(D.endDate)}`,F.query.quarter&&(D.setQuarter(`${F.query.quarter}`),w.setQuarter(D.quarter),a.value=`${"Custom"===D.quarter?a.value:D.quarter}`),T())})),{Img:i,onRegenerate:async()=>T(await c("Do you want to rebuild report?")),headerBadge:A,reportData:t,isLoading:o,generate:T,columns:P,period:a}}});e("default",D(t,[["render",function(e,t,a,r,o,n){const l=w("ion-loading"),s=w("v2Datatable"),g=w("ion-page");return A(),F(g,null,{default:x((()=>[q(l,{"is-open":e.isLoading,message:"Please wait.."},null,8,["is-open"]),q(s,{"icon-url":e.Img("login-logos/Malawi-Coat_of_arms_of_arms.png"),title:"Disaggregated report","report-prefix":"MoH",subtitle:e.period,columns:e.columns,columnData:e.reportData,rowsPerPage:100,onRefresh:e.onRegenerate,headerBadge:e.headerBadge},null,8,["icon-url","subtitle","columns","columnData","onRefresh","headerBadge"])])),_:1})}]]))}}}));
