System.register(["./HisStandardForm-legacy-BD_Op0XH.js","./index-legacy-DMRuT87V.js"],(function(e,t){"use strict";var s,i,a,l,r,n,o,u,d,c,h,p,m,T,v,_,y,I,b;return{setters:[e=>{s=e.H},e=>{i=e.bJ,a=e.bt,l=e.d,r=e.au,n=e.J,o=e.aj,u=e.af,d=e.ab,c=e.ac,h=e.M,p=e.aL,m=e.ai,T=e.aN,v=e.al,_=e.a8,y=e.v,I=e.ad,b=e.u}],execute:function(){class t extends i{patientID;testTypeID;resultDate;testID;constructor(e){super(e,57),this.patientID=e,this.testTypeID=-1,this.resultDate="",this.testID=-1}createLabResult(e){return i.postJson(`lab/tests/${this.testID}/results`,{encounter_id:this.encounterID,date:this.resultDate,measures:e})}getTestID(){return this.testID}getTestTypeID(){return this.testTypeID}setTestTypeID(e){this.testTypeID=e}setResultDate(e){this.resultDate=e}setTestID(e){this.testID=e}getTestsWithoutResults(){return a.getOrders(this.patientID,{status:"drawn"})}getTestIndicators(){return a.getJson("lab/test_result_indicators",{test_type_id:this.testTypeID})}}const g=l({components:{HisStandardForm:s},data:()=>({fieldComponent:"",labResult:{},hisFormKey:0,patient:{},fields:[],selectedTest:{},testOptions:[],testIndicators:[]}),watch:{$route:{async handler({params:e}){e&&e.patient_id&&(this.patient=e.patient_id,this.labResult=new t(this.patient),await this.initData(),this.fields=this.getFields())},deep:!0,immediate:!0}},methods:{async onFinish(e,t){try{const e=Object.values(t).filter((e=>"result_indicator"===e.tag&&e.measures)).map((e=>e.measures));this.labResult.setTestID(this.selectedTest.value),this.labResult.setResultDate(t.result_date),await this.labResult.createEncounter(),await this.labResult.createLabResult(e),r.invalidate("PATIENT_LAB_ORDERS"),this.testOptions=[],this.selectedTest={},this.testIndicators=[],await this.initData(),this.hisFormKey=Math.floor(5e3*Math.random()),n("Lab result saved!")}catch(s){o(`${s}`),console.error(s)}},generateTestIndicatorsFields(){return this.testIndicators.reduce(((e,t)=>e.concat(this.buildTestIndicatorFields(t.indicatorId,t.indicatorName,t.specimen,t.testId))),[])},async validateVLresults(e,t,s){if("HIV viral load"!==e)return!0;const i=s.substring(0,1),l=s.substring(1,s.length);return!!a.isValidVLResult(t,i,l)||!(await u(`Invalid results for ${t} HIV viral load`,{cancelBtnLabel:"Process result",confirmBtnLabel:"Re-enter result"}))},alphaValueIsValid(e){try{return!!e.match(/^(>|<|=)(.*)/)}catch(t){return!1}},numericValueIsValid(e){try{return!!e.match(/^(=|<|>)([0-9]*)$/m)}catch(t){return!1}},isCrAgResult:e=>/serum crag/i.test(e),isMalariaResult:e=>!!e.match(/mrdt|malaria/i),isUrineLamResult:e=>!!e.match(/Lam/i),buildTestIndicatorFields(e,t,s,i){const a=e*i,l=e=>[this.selectedTest.value===i,!!p.find(e.result_indicators,{label:t})].every(Boolean),r=(s,i)=>{if("Other"===s.value&&t.match(/HIV viral load/i))return{};const l=this.isMalariaResult(t)||this.isUrineLamResult(t)||this.isCrAgResult(t)?"text":i[`type_${a}`].value;let r=this.isMalariaResult(t)||this.isUrineLamResult(t)||this.isCrAgResult(t)?"="+s.value:`${s.value}`,n="=";/[=><]/i.test(`${r}`.charAt(0))&&(n=r.charAt(0),r=r.substring(1));const o="numeric"===l?parseInt(r):r,u=i.result_indicators.filter((t=>t.value===e))[0];return{tag:"result_indicator",measures:{indicator:{concept_id:u.value},value:o,value_modifier:n,value_type:l},result:o,modifier:n,test:u.label}};return[{id:`type_${a}`,helpText:`Result type (${t})`,type:d.TT_SELECT,group:"test_indicator",condition:e=>l(e)&&!this.isMalariaResult(t)&&!this.isUrineLamResult(t)&&!this.isCrAgResult(t),appearInSummary:()=>!1,validation:e=>c.required(e),options:()=>[{label:"Numeric (numbers only)",value:"numeric"},{label:"Alphanumeric(text and numbers)",value:"text"}]},{id:`urine_result_${a}`,helpText:`Select Test Result (${t})`,type:d.TT_SELECT,group:"test_indicator",computedValue:r,validation:e=>c.required(e),condition:e=>l(e)&&this.isUrineLamResult(t),options:()=>[{label:"Positive",value:"positive"},{label:"Negative",value:"negative"}]},{id:`crag_result_${a}`,helpText:`Select Serum CrAg Result (${t})`,type:d.TT_SELECT,group:"test_indicator",computedValue:r,validation:e=>c.required(e),condition:e=>l(e)&&this.isCrAgResult(t),options:()=>[{label:"Positive",value:"positive"},{label:"Negative",value:"negative"}]},{id:`num_${a}`,helpText:`Test Result (${t})`,type:d.TT_TEXT,group:"test_indicator",computedValue:r,beforeNext:e=>this.validateVLresults(t,s,e.value.toString()),onValue:e=>!(/hiv/i.test(t)&&e&&e.value&&!this.numericValueIsValid(e.value.toString())&&(h("You must enter a modifer and numbers only. i.e =90 / >19 / < 750"),1)),validation:e=>c.required(e),condition:e=>l(e)&&"numeric"===e[`type_${a}`].value,config:{customKeyboard:[[["1","2","3"],["4","5","6","=","<",">"],["7","8","9","."],["","0",""]],[["Delete"]]]}},{id:`alpha_${a}`,helpText:`Test Result (${t})`,type:d.TT_TEXT,group:"test_indicator",computedValue:r,validation:e=>c.required(e),condition:e=>l(e)&&"text"===e[`type_${a}`].value&&!t.match(/HIV viral load/i)},{id:`VL_alpha_${a}`,helpText:`Select Test Result (${t})`,type:d.TT_SELECT,group:"test_indicator",computedValue:r,validation:e=>c.required(e),condition:e=>l(e)&&"text"===e[`type_${a}`].value&&t.match(/HIV viral load/i),options:()=>[{label:"Collect Another Sample",value:"=Collect Another Sample"},{label:"<LDL",value:"<LDL"},{label:"=LDL",value:"=LDL"},{value:"Other",label:"Other"}]},{id:`other_VL_alpha_${a}`,helpText:`Test Result (${t})`,type:d.TT_TEXT,group:"test_indicator",onValue:e=>!(e&&e.value&&!this.alphaValueIsValid(e.value.toString())&&(h("You must enter a modifier plus result (for example =LDL)"),1)),computedValue:r,validation:e=>c.required(e),condition:e=>l(e)&&"text"===e[`type_${a}`].value&&t.match(/HIV viral load/i)&&"Other"===e[`VL_alpha_${a}`].value},{id:`malaria_result_${a}`,helpText:`Select Test Result (${t})`,type:d.TT_SELECT,group:"test_indicator",computedValue:r,validation:e=>c.required(e),condition:e=>l(e)&&this.isMalariaResult(t),options:()=>t.match(/mrdt/i)?[{label:"Positive",value:"positive"},{label:"Negative",value:"negative"}]:[{label:"Parasites seen",value:"parasites seen"},{label:"No parasites seen",value:"no parasites seen"}]}]},async initData(){const e=await this.labResult.getTestsWithoutResults();for(const t in e){const s=e[t];for(const e in s.tests){const t=s.tests[e];if(!p.isEmpty(t.result))continue;this.labResult.setTestTypeID(t.concept_id);const i=(await this.labResult.getTestIndicators()).map((e=>({testId:t.id,indicatorName:e.name,indicatorId:e.concept_id,specimen:s.specimen.name})));this.testIndicators=[...this.testIndicators,...i],this.testOptions.push({label:t.name,value:t.id,other:{accession:s.accession_number,specimen:s.specimen.name,test:t.name,orderDate:s.order_date,testIndicators:i}})}}},getFields(){return[{id:"test_type",helpText:"Tests without results",type:d.TT_TABLE_VIEWER,options:()=>[{label:"",value:"",other:{rows:this.testOptions.map((e=>[e.other.accession,e.other.specimen,e.other.test,m.toStandardHisDisplayFormat(e.other.orderDate),{type:"button",name:"Select",action:()=>{this.selectedTest=e,this.$nextTick((()=>this.fieldComponent="year_result_date"))}}])),columns:["Acession#","Specimen","Test","Order date"]}}],validation:e=>c.required(e),config:{overrideDefaultFooterBtns:{nextBtn:{name:"Finish",onClick:()=>this.$router.back()}},hiddenFooterBtns:["Clear","Cancel"]}},...T({id:"result_date",helpText:"Result",required:!0,estimation:{allowUnknown:!1},minDate:()=>m.toStandardHisFormat(this.selectedTest.other.orderDate),maxDate:()=>v.getSessionDate(),computeValue:e=>e}),{id:"result_indicators",helpText:"Select test result indicators",type:d.TT_MULTIPLE_SELECT,validation:e=>c.required(e),options:()=>this.selectedTest.other.testIndicators.map((e=>({label:e.indicatorName,value:e.indicatorId})))},...this.generateTestIndicatorsFields(),{id:"entry_confirmation",helpText:"Confirm entry",type:d.TT_TABLE_VIEWER,options:(e,t)=>[{label:"",value:"",other:{rows:Object.values(t).filter((e=>"object"==typeof e&&null!=e&&"result_indicator"===e.tag)).map((e=>[e.test,e.modifier,e.result])),columns:["Test","Modifier","Result"]}}]}]}}});e("default",_(g,[["render",function(e,t,s,i,a,l){const r=I("his-standard-form");return b(),y(r,{key:e.hisFormKey,fields:e.fields,activeField:e.fieldComponent,skipSummary:!0,onOnIndex:t[0]||(t[0]=t=>e.fieldComponent=""),onOnFinish:e.onFinish},null,8,["fields","activeField","onOnFinish"])}]]))}}}));
