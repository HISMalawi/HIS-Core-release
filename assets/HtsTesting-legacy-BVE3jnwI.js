System.register(["./index-legacy-CNrLGT3P.js","./testKits-legacy-DYvG61Vg.js","./HisStandardForm-legacy-OekRIZB_.js"],(function(e,t){"use strict";var a,i,l,s,o,n,r,u,c,d,v,p,h,_,f,m,b,T,y,g,I;return{setters:[e=>{a=e.bk,i=e.d,l=e.I,s=e.K,o=e.dF,n=e.F,r=e.dH,u=e.aj,c=e.ah,d=e.n,v=e.dG,p=e.ct,h=e._,_=e.r,f=e.o,m=e.c,b=e.w,T=e.b},e=>{y=e.T,g=e.K},e=>{I=e.H}],execute:function(){class t extends a{constructor(e,t=-1){super(e,197,t)}getRecentAccesspoint(){return this.getFirstValueCoded("HTS Access Type")}}const N=i({components:{IonPage:l,HisStandardForm:I},setup(){const e=s([]),a=new t(-1),{htsClient:i,toOption:l,saveEncounter:h,toYesNoOption:_,mapStrToOptions:f,patientDashboardUrl:m,toConditionalOptions:b}=o({onInitVisit:()=>{e.value=[{id:"accesspoint_type",helpText:"Access point type",type:n.TT_SELECT,isRequired:()=>!0,finalComputedValue:e=>{const t="HTS Access Type";return{offlineMeta:{[t]:e.value},obs:a.buildValueCoded(t,e.value)}},options:()=>[{label:"Health Facility",value:"Health Facility"},{label:"Community",value:"Community"},{label:"Facility Referred from Community",value:"Health Facility"}]},{id:"facility_access_points",helpText:"Health facility access points",type:n.TT_SELECT_GRID,isRequired:()=>!0,condition:e=>"Health Facility"===e.accesspoint_type.value,finalComputedValue:e=>({obs:a.buildValueText("Location where test took place",`${e.value}`)}),config:{columnsPerRow:2},options:()=>[{label:"1 | VCT",value:"VCT"},{label:"2 | ANC",value:"ANC First Visit"},{label:"3 | Inpatient",value:"Inpatient"},{label:"4 | STI",value:"STI"},{label:"5 | PMTCT-Follow-up (ANC FUP, Mat, Post-nat, BF)",value:"PMTCT FUP"},{label:"6 | Index",value:"Index"},{label:"7 | Paediatric",value:"Paediatric"},{label:"8 | VMMC",value:"VMMC"},{label:"9 | Malnutrition",value:"Malnutrition"},{label:"10 | TB",value:"TB"},{label:"11 | OPD",value:"OPD"},{label:"12 | Other PITC (PrEP, dental e.t.c)",value:"Other"},{label:"18 | SNS (Social Network Strategies)",value:"SNS"}]},{id:"community_access_points",helpText:"Community access points",type:n.TT_SELECT,condition:e=>"Community"===e.accesspoint_type.value,isRequired:()=>!0,finalComputedValue:e=>({obs:a.buildValueText("Location where test took place",`${e.value}`)}),options:()=>[{label:"13 | VCT",value:"VCT"},{label:"14 | Index",value:"Index"},{label:"15 | VMMC",value:"VMMC"},{label:"16 | Other",value:"Other"},{label:"17 | SNS",value:"SNS"},{label:"19 | Mobile",value:"Mobile"}]},V(),{id:"last_hiv_result",helpText:"Last HIV Test",type:n.TT_SELECT,isRequired:()=>!0,finalComputedValue:e=>{const t="Previous HIV Test Results";return{offlineMeta:{[t]:e.value},obs:a.buildValueCoded(t,e.value)}},options:()=>b([["Never Tested"],["Negative"],["Positive"],["Exposed infant"],["Invalid or inconclusive"]])},{id:"last_hiv_perfomed",helpText:"Last HIV test performed",type:n.TT_SELECT,isRequired:()=>!0,condition:e=>!["Never Tested","Exposed infant"].includes(e.last_hiv_result.value),finalComputedValue:e=>{const t="Previous HIV test done";return{offlineMeta:{[t]:e.value},obs:a.buildValueCoded(t,e.value)}},defaultOutput:e=>{if(/exposed infant/i.test(e.last_hiv_result.value))return l("Professional")},options:e=>b([["Self"],["Initial professional",!/Negative|Inconclusive/i.test(e.last_hiv_result.value)],["Professional"]])},{id:"last_time_hiv_tested",helpText:"Time since last HIV test",type:n.TT_AGE_INPUT,condition:e=>e.last_hiv_result.value&&"Never Tested"!=e.last_hiv_result.value,isRequired:()=>!0,beforeNext:async(e,t)=>(e.other.monthsAgoInt>=12&&!N(t,"HIV")&&await u("Recommendation Alert","","Please consider testing client for HIV",[{name:"Ok",slot:"start",color:"primary"}]),!0),validation:e=>I(e),finalComputedValue:e=>{const t="Time of HIV test";return{offlineMeta:{[t]:e.value},obs:a.buildObs(t,{value_datetime:e.other.date,value_text:e.value})}},config:{excludeUnits:["Hours"]}},{id:"last_taken_drugs",helpText:"Ever taken the following drugs?",type:n.TT_MULTIPLE_YES_NO,isRequired:()=>!0,finalComputedValue:e=>({obs:e.map((e=>a.buildValueCoded(e.other.concept,e.value)))}),options:e=>e.last_taken_drugs?e.last_taken_drugs:[_("PrEP or infant NVP",{concept:"Taken Prep before"}),..."Negative"!=`${e.last_hiv_result?.value}`?[_("ART",{concept:"Taken ARV Before"})]:[],_("PEP",{concept:"Taken PEP before"})]},{id:"drug_taken",helpText:"Most recent drug taken",type:n.TT_SELECT,isRequired:()=>!0,condition:e=>{let t=0;for(const a of e.last_taken_drugs){if("ART"===a.label&&"Yes"===a.value)return!1;"Yes"===a.value&&++t}return t>1},defaultOutput:e=>{const t=e.last_taken_drugs.find((e=>"ART"===e.label));if("Yes"===t?.value)return l("ART")},finalComputedValue:e=>{const t="Most recent drug taken";return{offlineMeta:{[t]:e.value},obs:a.buildValueCoded(t,e.value)}},options:e=>e.last_taken_drugs.filter((e=>"Yes"===e.value)).map((e=>l(e.label)))},{id:"most_recent_drug",helpText:"Most recent drug",type:n.TT_HIDDEN,condition:e=>1===e.last_taken_drugs.filter((e=>"Yes"===e.value)).length,defaultValue:e=>c.find(e.last_taken_drugs,{value:"Yes"}),finalComputedValue:e=>({obs:a.buildValueCoded("Most recent drug taken",e.value)})},{id:"time_since_last_drug_taken",helpText:"Time since last taken medication",type:n.TT_AGE_INPUT,condition:e=>e.last_taken_drugs.some((e=>"Yes"===e.value)),finalComputedValue:e=>{const t="Time since last taken medication";return{offlineMeta:{[t]:e.value},obs:a.buildObs(t,{value_text:`${e.value} ago`,value_datetime:e.other.date})}},validation:e=>I(e),isRequired:()=>!0,config:{excludeUnits:["Hours"]}},{id:"client_risk_category",helpText:"Client Risk Category",type:n.TT_SELECT,isRequired:()=>!0,finalComputedValue:e=>{const t="client risk category";return{offlineMeta:{[t]:e.value},obs:a.buildValueCoded(t,e.value)}},options:()=>f(["Low risk","On-going risk","High risk event in last 3 months","Risk assessment not done"])},P(),{id:"test_kit",helpText:"Kit information",type:n.TT_INPUT_ARRAY,condition:e=>e.test_results.filter((e=>""!=e.value)).some((e=>!(e.other.expiryDate&&e.other.lotNo))),config:{columns:[{label:"Kit Name"},{label:"Kit Lot No."},{label:"Kit Expiry Date"}]},summaryMapValue:e=>({label:`Kit: ${e.label}`,value:`Lot No: ${e.value||e.other.fields[1].value}`}),validation:e=>{const t=e.map((e=>e.other.fields)),a=t.some((e=>{const t=e.filter((e=>""!=e.value)).length;return t>0&&t<3}));if(a)return["Some rows have incomplete data!"];const i=t.some((e=>e.some((e=>""===e.value))));return i?["Some rows are missing data"]:null},finalComputedValue:e=>({obs:e.map((e=>e.other.fields)).map((async e=>{const[t,...a]=e.filter((e=>"function"==typeof e.other.obs)).map((e=>e.other.obs(e)));return{...await t,child:await Promise.all(a)}}))}),defaultOutput:e=>{const t=e.test_results.filter((e=>""!=e.value));if(t.every((e=>e.other.expiryDate&&e.other.lotNo)))return t.map((e=>({label:e.label,value:e.other.lotNo,other:{fields:[{label:"Kit name",value:e.label,other:{obs:()=>a.buildValueText("Kit name",e.label)}},{label:"Kit Lot No",value:e.other.lotNo,other:{obs:()=>a.buildValueText("Kit lot number",e.other.lotNo)}},{label:"Kit expiry date",value:e.other.expiryDate,other:{obs:()=>a.buildValueDate("kit expiry date",e.other.expiryDate)}}]}})))},options:async e=>{const t=Array.isArray(e.test_results)?e.test_results:[],i=null===e.test_kit?[]:e.test_kit;return t.filter((e=>""!=e.value)).map((e=>{const t=c.find(i,{label:e.label});return t||{label:e.label,value:"",other:{fields:[(o=e.other.shortName,{label:"Kit Name",value:o,clearable:!1,other:{usefontBold:!0,obs:e=>a.buildValueText("Kit name",e.label)}}),(s=e.other.lotNo,{label:"Kit Lot No.",value:s,other:{obs:e=>a.buildValueText("Kit lot number",e.value),onclick:e=>{v({id:"lot",helpText:"Enter Lot Number",type:n.TT_TEXT,isRequired:()=>!0},(t=>{e.value=t.value}))}}}),(l=e.other.expiryDate,{label:"Kit Expiry Date",value:l,other:{obs:e=>a.buildValueDate("kit expiry date",e.value),onclick:e=>{v({id:"end_user",helpText:"Kit Expiry Date",type:n.TT_FULL_DATE,isRequired:()=>!0,validation:e=>new Date(e.label)<new Date(a.date)?["Expiry date cannot be less than current date "+p(a.date)]:null},(t=>{e.value=t.value}))}}})]}};var l,s,o}))}},C(),E()]}});function T(e){let t=!1,a=!1;for(const i of e)"test_1"===i.other.id&&"Positive"===i.value?t=!0:/test_2|test_1_repeat|test_3/i.test(`${i?.other?.id}`)&&""===i.value&&!i.disabled&&(a=!0);return t&&a}function I(e){return parseInt(`${e.other.value}`)<=0&&!/day/i.test(e.other.timeUnit)?[`Enter ${e.other.timeUnit} greater than zero`]:"Days"===e.other.timeUnit&&parseInt(`${e.other.value}`)>90?[`Enter ${e.other.timeUnit} less than 90, use Weeks Instead`]:"Weeks"===e.other.timeUnit&&parseInt(`${e.other.value}`)>12?[`Enter ${e.other.timeUnit} less than 12, use Months Instead`]:"Months"===e.other.timeUnit&&parseInt(`${e.other.value}`)>24?[`Enter ${e.other.timeUnit} less than 24, use Years Instead`]:e.other.value.length>1&&"0"===e.other.value[0]?[`Value ${e.other.value} is invalid!`]:new Date(e.other.date)<new Date(i.birthDate)?[`${e.label} is greater than client's age of ${i.age} Years`]:null}function N(e,t){return e.tests_offered.some((e=>e.value===t))}function V(){let e=["HIV","Syphilis","Hepatitis B"];return{id:"tests_offered",helpText:"Tests to be offered today?",type:n.TT_MULTIPLE_SELECT,init:async()=>{try{const{getUserProp:t}=r(),a=(await t("HTS_PROGRAMS")).split(",").filter((e=>/HIV|syphilis|hepatitis/i.test(e))).map((e=>e.replace(/test/i,"").trim()));a.length>=1&&(e=a)}catch(t){return console.error(t),!1}return!0},isRequired:()=>!0,condition:()=>e.length>1,defaultOutput:()=>f(e),options:()=>f(e),config:{buildOptionsOnce:!0}}}function P(){const{getLotNo:e,getExpiryDate:t,initKits:l}=y(),s=(e,t,a)=>!!c.find(e,{value:a,other:{id:t}});return{id:"test_results",helpText:"Test results",type:n.TT_MULTIPLE_YES_NO,config:{requireAllValues:!1},summaryMapValue:e=>{const t={Positive:"Reactive",Negative:"Non-reactive"};if(""!=e.value)return{label:e.label,value:t[e.value]||e.value}},beforeNext:async(e,t)=>{const a=s(e,"test_2","Negative")&&s(e,"test_1_repeat","Positive")||s(e,"test_2","Positive")&&s(e,"test_3","Negative");return/inconclusive/i.test(t.last_hiv_result.value)&&a?(await u("Inconclusive Re-Test Result","","Please collect DBS sample.",[{name:"Ok",slot:"start"}]),!0):a?(await u("Reschedule test","","HIV result is inconclusive, schedule another test in 2 weeks",[{name:"Ok",slot:"start"}]),!0):(s(e,"test_1","Positive")&&s(e,"test_2","Positive")&&s(e,"test_3","Positive")&&i.age<=0&&await u("<12 months old all HIV tests reactive","","Please collect DBS sample for EID",[{name:"Ok",slot:"start"}]),!("Community"!=t.accesspoint_type.value&&T(e)&&!(await d("Are you sure you want to save incomplete HIV results?",{header:"Incomplete HIV results!"}))))},onValueUpdate:(e,t,a)=>{if(N(a,"HIV")&&"Health Facility"===a.accesspoint_type.value){const t=[...e],a=s(t,"test_1","Positive"),i=s(t,"test_2","Positive"),l=(e,a)=>{t.forEach((t=>{t.other.id===e&&(t.disabled=a,a&&(t.value=""))}))};return a?(l("test_2",!1),a&&i?(l("test_3",!1),l("test_1_repeat",!0),t):(a&&!i&&e.some((e=>"test_2"===e.other.id&&""!=e.value))&&(l("test_1_repeat",!1),l("test_3",!0)),t)):(l("test_2",!0),l("test_3",!0),l("test_1_repeat",!0),t)}return e},validation:e=>!e||e.some((e=>/syphilis|hepatitis|test_1/i.test(`${e?.other?.id}`)&&""===e.value&&!e.disabled))?["Result entry incomplete!"]:null,finalComputedValue:e=>({offlineMeta:e.filter((e=>e.value)).reduce(((e,t)=>({...e,[t.other.concept]:t.value})),{}),obs:e.filter((e=>e.value&&"function"==typeof e.other.obs)).map((e=>e.other.obs(e)))}),init:async()=>(await l(),!0),condition:e=>e.tests_offered.length,options:i=>{const l=(e={})=>({label:e.name,value:"",disabled:"boolean"==typeof e?.disabled&&e.disabled,other:{id:e?.id||"",concept:e?.concept||"",shortName:e?.shortName||"",category:e?.category||"",expiryDate:e?.expiryDate||"",lotNo:e?.lotNo||"",obs:"function"==typeof e?.obs?e.obs:void 0,accessPoint:e?.accessPoint||"*",values:[{label:"Reactive",value:"Positive"},{label:"Non-reactive",value:"Negative"}]}}),s=[l({id:"test_1",name:"HIV Test 1 (Determine)",category:"HIV",shortName:"Determine",lotNo:e(g.DETERMINE),expiryDate:t(g.DETERMINE),concept:"Test 1",obs:e=>a.buildValueCoded(e.other.concept,e.value)}),l({id:"test_2",name:"HIV Test 2 (Unigold)",category:"HIV",disabled:!0,accessPoint:"Health Facility",shortName:"Unigold",concept:"Test 2",lotNo:e(g.UNIGOLD),expiryDate:t(g.UNIGOLD),obs:e=>a.buildValueCoded(e.other.concept,e.value)}),l({id:"test_1_repeat",name:"HIV Test 1 (Determine) Repeat",category:"HIV",disabled:!0,shortName:"Determine (Repeat)",accessPoint:"Health Facility",concept:"Immediate Repeat Test 1 Result",lotNo:e(g.DETERMINE),expiryDate:t(g.DETERMINE),obs:e=>a.buildValueCoded(e.other.concept,e.value)}),l({id:"test_3",name:"HIV Test 3 (Bioline)",category:"HIV",disabled:!0,shortName:"Bioline",accessPoint:"Health Facility",concept:"Test 3",lotNo:e(g.BIOLINE),expiryDate:t(g.BIOLINE),obs:e=>a.buildValueCoded(e.other.concept,e.value)}),l({id:"syphilis",name:"Syphilis Test Result",category:"Syphilis",shortName:"Syphilis",concept:"Syphilis Test Result",lotNo:e(g.SYPHILIS),expiryDate:t(g.SYPHILIS),obs:e=>a.buildValueCoded(e.other.concept,e.value)}),l({id:"hepatitis",name:"Hepatitis B Test Result",category:"Hepatitis B",shortName:"Hepatitis B",concept:"Hepatitis B Test Result",lotNo:e(g.HEPATITIS),expiryDate:t(g.HEPATITIS),obs:e=>a.buildValueCoded(e.other.concept,e.value)})],o=i.accesspoint_type.value,n=Array.isArray(i.test_results)?i.test_results:[],r=s.reduce(((e,t)=>{const a=c.find(n,{label:t.label});return a?("*"!=a.other.accessPoint&&a.other.accessPoint!=o&&(a.value=""),e.push(a)):e.push(t),e}),[]);return i.tests_offered.reduce(((e,t)=>{const a=r.filter((e=>e.other.category===t.value&&(e.other.accessPoint===o||"*"===e.other.accessPoint)));return a.length?e.concat(a):e}),[])}}}function C(){let e="";return{id:"hiv_result",helpText:"HIV Result",type:n.TT_HIDDEN,appearInSummary:()=>!1,condition:e=>N(e,"HIV"),onload:t=>{let a=null!=t.last_hiv_perfomed,i=null!=t.last_hiv_result,l="",s="",o="",n="";const r=t.test_results||[],u="Community"===t.accesspoint_type.value;r.forEach((e=>{switch(e.other.id){case"test_1":l=e.value;break;case"test_2":s=e.value;break;case"test_3":o=e.value;break;case"test_1_repeat":n=e.value}}));const c=()=>i&&a&&"Positive"===t.last_hiv_result?.value&&"Professional"===t.last_hiv_perfomed?.value&&("Negative"===l||"Negative"===s||"Negative"===o),d={Incomplete:()=>["Community"!=t.accesspoint_type.value,T(r)],Negative:()=>[!c(),"Negative"===l||"Negative"===s||"Negative"===o||"Negative"===n],Positive:()=>[!u,"Positive"===o],Inconclusive:()=>[!u,c()||"Negative"===s&&"Positive"===n||"Positive"===s&&"Negative"===o],"Positive Initial Professional":()=>[u,"Positive"===l]};e=Object.keys(d).reduce(((e,t)=>d[t]().every(Boolean)?t:e),"Not indicated")},defaultValue:()=>{if(e)return l(e)},finalComputedValue:()=>{if(e){const t="HIV status";return{offlineMeta:{[t]:e},obs:a.buildValueCoded(t,e)}}}}}function E(){let e="N/A";return{id:"patient_category",helpText:"Result given to client",type:n.TT_HIDDEN,onload:t=>{if(!t.hiv_result)return;const a=t.hiv_result.value,l=i.age,s=t.last_hiv_result.value,o=null!=t.last_hiv_perfomed?t.last_hiv_perfomed.value:"",n=null!=t.last_time_hiv_tested?t.last_time_hiv_tested.other.monthsAgoInt:-1,r={"New Positive":["Positive"===a,/never tested|negative|exposed|inconclusive/i.test(s)||"Positive"===s&&/initial professional|self/i.test(o)&&n<=12],"New exposed infant":[l<=0,"Positive"===a],"Positive Re-test":["Positive"===a,"Positive"===s,"Professional"===o],"Inconclusive Re-test":["Positive"===s,"Inconclusive"===a,"Professional"===o],"New Negative":["Negative"===a],"New Inconclusive":["Inconclusive"===a,/self/i.test(o)&&/invalid/i.test(s)||/never tested|negative|exposed infant/i.test(s)||"Positive"===s&&/self|initial professional/i.test(o)]};e=Object.keys(r).reduce(((e,t)=>r[t].every(Boolean)?t:e),"N/A")},defaultValue:()=>{if("N/A"!=e)return l(e)},finalComputedValue:()=>{if("N/A"!=e){const t="HIV group";return{offlineMeta:{[t]:e},obs:a.buildValueCoded(t,e)}}},condition:e=>e.hiv_result.value}}return{fields:e,onFinish:function(e,t){h({encounterName:"Testing",encounterTypeID:a.encounterTypeID,computedData:t})},patientDashboardUrl:m}}});e("default",h(N,[["render",function(e,t,a,i,l,s){const o=_("his-standard-form"),n=_("ion-page");return f(),m(n,null,{default:b((()=>[T(o,{formLabel:"Testing",fields:e.fields,onFinishAction:e.onFinish,cancelDestinationPath:e.patientDashboardUrl()},null,8,["fields","onFinishAction","cancelDestinationPath"])])),_:1})}]]))}}}));
