import{F as s}from"./dynamic-import-helper-Bsjrd6Ro.js";import{H as c}from"./HisStandardForm-tUhdyeHF.js";import{d as l,T as d,q as p,cq as r,V as o,t as u,cm as _,H as h,_ as m,r as y,o as v,c as f}from"./index-DxdybAew.js";import"./TouchScreenForm-CWGDOcQm.js";import"./ToolbarMediumCard-DpQmY2Av.js";import"./Transformers-BPPLlH12.js";import"./ViewPort-Bxq2iSVB.js";const b=l({components:{HisStandardForm:c},data:()=>({activeField:"",fields:[],drugs:[],stockService:{}}),methods:{async onFinish(t){const a=this.prepDrugs(t);try{await this.stockService.batchUpdate({verification_date:t.date.value,reason:t.reason.value,items:a}),d("Stock succesfully updated"),this.$router.push("/")}catch(e){p("Could not save stock"),console.error(e)}},mapDrugsToOptions(t){const a=new Map;return t.forEach(e=>{var i;e.pack_size||(e.pack_size=r.getPackSize(e.drug_id)),e.original_quantity=Math.trunc(e.current_quantity/(e.pack_size||1)),e.current_quantity=e.original_quantity,a.has(e.drug_id)?(i=a.get(e.drug_id))==null||i.other.push(e):a.set(e.drug_id,{label:"".concat((e==null?void 0:e.drug_name)||(e==null?void 0:e.drug_legacy_name)," (").concat(e.product_code,")"),value:e.drug_id,other:[e]})}),Array.from(a.values())},getFields(){return[{id:"date",helpText:"Verification Date",type:s.TT_FULL_DATE,validation:t=>o.required(t)},{id:"enter_batches",helpText:"Batch entry",type:s.TT_BATCH_VERIFICATION,options:()=>this.drugs,validation:t=>o.required(t),init:async()=>{try{const t=await this.stockService.getItems();return this.drugs=this.mapDrugsToOptions(t),!0}catch(t){return console.error(t),u("Unable to load drugs"),!1}}},{id:"reason",helpText:"Select reason",type:s.TT_SELECT,validation:t=>o.required(t),options:()=>[{label:"Monthly stock take",value:"Monthly stock take"},{label:"Audit",value:"Audit"},{label:"Adhoc (due to stock imbalance)",value:"Adhoc (due to stock imbalance)"},{label:"Supervision",value:"Supervision"},{label:"Handover",value:"Handover"}]},{id:"verification_summary",helpText:"Summary",type:s.TT_TABLE_VIEWER,options:t=>this.buildResults(t.enter_batches),config:{hiddenFooterBtns:["Clear"]}}]},buildResults(t){const a=["Drug Name (BatchNumber)","Tins/Pallets","Reason for Modification","Expiry date"],e=t.map(i=>["".concat(i.drug_name," (").concat(i.batch_number,")"),_(i.current_quantity),i.reason,h.toStandardHisDisplayFormat(i.expiry_date)]);return[{label:"Confirm entry",value:"Table",other:{columns:a,rows:e}}]},prepDrugs(t){return t.enter_batches.map(a=>({id:a.id,current_quantity:parseInt(a.pack_size)*parseInt(a.current_quantity),delivered_quantity:a.delivered_quantity,pack_size:a.pack_size,expiry_date:a.expiry_date,delivery_date:a.delivery_date,batch_number:a.batch_number,reason:a.reason}))}},async created(){this.stockService=new r,this.fields=this.getFields()}});function k(t,a,e,i,T,S){const n=y("his-standard-form");return v(),f(n,{fields:t.fields,activeField:t.activeField,onFinishAction:t.onFinish,skipSummary:!0},null,8,["fields","activeField","onFinishAction"])}const D=m(b,[["render",k]]);export{D as default};
