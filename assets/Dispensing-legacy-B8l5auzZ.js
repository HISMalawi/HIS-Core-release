System.register(["./HisStandardForm-legacy-a9YJRGaH.js","./index-legacy-CA6M7ipO.js","./drug_order_service-legacy-3VUXkHbj.js","./useEncounter-legacy-CgHUO1ZL.js","./isEmpty-legacy-cRrH0Hs5.js","./encounter_guidelines-legacy-Bcz_Mw7r.js","./GuidelineEngine-legacy-KsvQuFdF.js"],(function(e,t){"use strict";var r,n,a,s,i,o,u,d,l,c,g,p,y,D,h,m;return{setters:[e=>{r=e.H},e=>{n=e.bQ,a=e.d,s=e.r,i=e.ad,o=e.H,u=e.a,d=e.c,l=e.w,c=e.b,g=e.u,p=e.I,y=e.W,D=e.aj},e=>{h=e.D},e=>{m=e.u},null,null,null],execute:function(){class t extends n{drugHistory;currentDrugOrder;constructor(e,t){super(e,54,t),this.drugHistory=[],this.currentDrugOrder=[]}getDrugHistory(){return this.drugHistory}getCurrentOrder(){return this.currentDrugOrder}buildDispensations(e,t){return[{drug_order_id:e,date:this.date,quantity:t}]}saveDispensations(e){return n.postJson("/dispensations",{dispensations:e,program_id:n.getProgramID()})}async voidOrder(e){return n.void(`/dispensations/${e}`,{})}async loadDrugHistory(){const e=await h.getDrugOrderHistory(this.patientID);e&&(this.drugHistory=e)}async loadCurrentDrugOrder(){const e=await h.getDrugOrders(this.patientID);e&&(this.currentDrugOrder=await Promise.all(e))}calcCompletePack(e,t){const r=e.barcodes.sort((function(e,t){return e.tabs-t.tabs}));if(0==r.length||0==t)return t;for(let s=0;s<=r.length-1;s++)if(parseInt(r[s].tabs)>=t)return r[s].tabs;const n=parseInt(r[0].tabs);let a=parseInt(r[r.length-1].tabs);for(;a<t;)a+=n;return a}}e("default",a({__name:"Dispensing",setup(e){let n;const a=s([]),{goToPatientDashboard:h,patientDashboardUrl:f}=m((async(e,r,s)=>{n=new t(r,e),await n.loadCurrentDrugOrder(),await n.loadDrugHistory(),a.value.push(function(e){return{id:"dispenses",helpText:"Dispensation",type:i.TT_DRUG_DISPENSER,onValueUpdate:w,onValue:H,config:{medicationHistory:v(),toolbarInfo:[{label:"Name",value:e?.getFullName()},{label:"Gender",value:e?.getGender()},{label:"Date Of Birth",value:o.toStandardHisDisplayFormat(e?.getBirthdate())}],hiddenFooterBtns:["Clear","Finish"]},options:()=>b()}}(s))}));function _(e){const t=parseFloat(e.amount_needed)-(e.quantity||0),r=n.calcCompletePack(e,t);return r<0?0:r}function b(){return n.getCurrentOrder().map((e=>({label:e.drug.name,value:e.quantity||0,other:{drug_id:e.drug.drug_id,order_id:e.order.order_id,amount_needed:_(e)}})))}function v(){return n.getDrugHistory().sort(((e,t)=>{const r=new Date(e.order.start_date);return new Date(t.order.start_date)-r})).map((e=>({medication:e.drug.name,date:o.toStandardHisDisplayFormat(e.order.start_date),amount:e.quantity})))}async function w(e,t){return-1!=e.value&&function(e){return e.map((e=>0!=e.value)).every(Boolean)}(t)?h():(e.other.amount_needed=0,await n.loadCurrentDrugOrder(),b())}async function H(e,t){if(-1===e.value)return!(await n.voidOrder(e.other.order_id));if(!t&&!(await async function(e){let t=!0;const r=parseInt(e.value.toString())/e.other.amount_needed*100;return r>110&&(t=await D("Are you sure you want to dispense over 110% of the prescribed pill count?")),r<100&&(t=await D("Are you sure you want to dispense less than 100% of the prescribe amount?")),t}(e)))return!1;const r=n.buildDispensations(e.other.order_id,e.value);return!!(await n.saveDispensations(r))||(y("Unable to save dispensation"),!1)}return(e,t)=>(u(),d(g(p),null,{default:l((()=>[c(r,{skipSummary:!0,cancelDestinationPath:g(f),fields:a.value},null,8,["cancelDestinationPath","fields"])])),_:1}))}}))}}}));
