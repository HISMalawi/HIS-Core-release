import{d as P,j as R,au as U,ap as G,D as M,ao as H,aq as K,I as Q,l as W,k as J,bj as X,f as Y,m as Z,i as x,d9 as ee,da as te,n as w,t as S,bi as ne,F as D,V as v,O as ae,bL as ie,_ as se,r as i,o as u,c as g,w as a,b as n,u as d,A as o,x as y,B as T,y as I,z as E,v as q,a6 as oe,a7 as re}from"./index-BBbw6-oc.js";import{_ as le}from"./EncounterMixin.vue_vue_type_script_lang-DK6TRcnt.js";import{A as ue,D as ce}from"./anc_treatment_service-BZojbjFN.js";import{D as F}from"./drug_service-4GD0N9tw.js";import{A as de}from"./anc_drug_set-Ba-zjNii.js";import"./encounter_guidelines-DqZrhpay.js";import"./GuidelineEngine-D6V1_Znr.js";import"./HisStandardForm-BhUAZgIK.js";import"./drug_order_service-HAbiAU5w.js";const he=P({components:{IonHeader:R,IonIcon:U,IonRow:G,IonLabel:M,IonGrid:H,IonCol:K,IonPage:Q,IonContent:W,IonTitle:J,IonInput:X,IonButton:Y,IonFooter:Z,IonToolbar:x},mixins:[le],setup(){return{add:ee,trashBin:te}},data:()=>({activeDrugs:[],drugSets:[],defaultDrugs:[],isSubmitting:!1,service:{}}),computed:{selectedDrugNames(){return this.activeDrugs.map(e=>e.drug_name||"")}},watch:{ready:{async handler(e){this.activeDrugs=[this.defaultDrugObj()],e&&(this.service=new ue(this.patientID,this.providerID),this.drugSets=(await de.getDrugSets()).map(t=>({label:t.name,value:t.description,other:{drugs:t.drugs}})),this.defaultDrugs=await F.getDrugs({page_size:50}))},immediate:!0}},methods:{async onFinish(){if(this.formIsEmpty()){await w("Do you want to proceed without prescribing drugs?")&&(await this.service.createEncounter(),await this.service.saveValueCodedObs("Medication received at vist","No"),this.nextTask());return}if(!this.formIsComplete())return S("Please complete the form");this.isSubmitting=!0;try{return await this.service.submitTreatment(this.activeDrugs),await new ne(this.patientID).printVisitSummaryLbl(),this.nextTask()}catch(e){S("".concat(e)),console.error(e)}this.isSubmitting=!1},defaultDrugObj(){return{id:0,drug_name:"",dose:"",duration:0,frequency:"",units:""}},formIsComplete(){return this.activeDrugs.every(e=>e.id&&e.duration&&e.frequency)},formIsEmpty(){return this.activeDrugs.length===1&&this.activeDrugs[0].drug_name===""&&this.activeDrugs[0].duration===0&&this.activeDrugs[0].frequency===""},appendDrugSetValues(e){const t=e.other.drugs.reduce((r,c)=>r.concat(c),[]);this.activeDrugs.length===1&&!this.activeDrugs[0].id?this.activeDrugs=t:this.activeDrugs=this.activeDrugs.concat(t.filter(r=>!this.selectedDrugNames.includes(r.drug_name)))},editDrugName(e){this.launchEditor({id:"new_drug",helpText:"Add drug to prescribe",type:D.TT_SELECT,defaultValue:()=>e.drug_name,validation:t=>this.validateSeries([()=>v.required(t),()=>this.selectedDrugNames.includes(t.label)?["Drug already added"]:null]),options:async(t,r)=>{let c=[];return r?c=await F.getDrugs({page_size:50,name:r}):c=this.defaultDrugs,c.map(h=>({label:h.name,value:h.drug_id,other:{dose:h.dose,units:h.units}}))},config:{showKeyboard:!0,isFilterDataViaApi:!0}},t=>{e.id=t.value,e.drug_name=t.label,e.dose=t.other.dose,e.units=t.other.units})},editDrugFrequency(e){this.launchEditor({id:"frequency",helpText:"Edit drug frequency for ".concat(e.drug_name),type:D.TT_SELECT,defaultValue:()=>e.frequency,validation:t=>v.required(t),options:()=>this.mapStrToOptions(Object.keys(ce))},t=>{e.frequency=t.label})},editDrugDuration(e){this.launchEditor({id:"duration",helpText:"Edit duration of ".concat(e.drug_name," in days"),type:D.TT_NUMBER,defaultValue:()=>e.duration,validation:t=>v.required(t)},t=>{e.duration=t.value})},async clear(){await w("Are you sure you want to clear all drugs?")&&(this.activeDrugs=[this.defaultDrugObj()])},async launchEditor(e,t){(await ae.create({component:ie,backdropDismiss:!1,cssClass:"full-modal",componentProps:{dismissType:"modal",currentField:e,onFinish:t}})).present()}}}),me=e=>(oe("data-v-81aec3aa"),e=e(),re(),e),pe=me(()=>o("thead",null,[o("tr",{class:"his-sm-text"},[o("th",null,"Drug"),o("th",null,"Frequency"),o("th",null,"Duration (Days)"),o("th")])],-1));function ge(e,t,r,c,h,_e){const V=i("ion-title"),b=i("ion-toolbar"),$=i("ion-header"),_=i("ion-input"),k=i("ion-icon"),m=i("ion-button"),f=i("ion-col"),C=i("ion-row"),A=i("ion-grid"),N=i("ion-label"),B=i("ion-item"),z=i("ion-list"),O=i("ion-content"),j=i("ion-footer"),L=i("ion-page");return u(),g(L,null,{default:a(()=>[n($,null,{default:a(()=>[n(b,null,{default:a(()=>[n(V,{class:"his-lg-text"},{default:a(()=>[d("Treatment")]),_:1})]),_:1})]),_:1}),n(O,null,{default:a(()=>[n(A,null,{default:a(()=>[n(C,{style:{height:"50vh"},class:"his-card section drug-section-style"},{default:a(()=>[n(f,null,{default:a(()=>[o("table",null,[pe,o("tbody",null,[(u(!0),y(T,null,I(e.activeDrugs,(s,l)=>(u(),y("tr",{key:l},[o("td",null,[n(_,{readonly:"",onClick:p=>e.editDrugName(s),value:s.drug_name,placeholder:"Add drug",class:"his-sm-text dosage-input"},null,8,["onClick","value"])]),o("td",null,[n(_,{readonly:"",onClick:p=>e.editDrugFrequency(s),value:s.frequency,class:"his-sm-text dosage-input",placeholder:"Add frequency.."},null,8,["onClick","value"])]),o("td",null,[n(_,{readonly:"",onClick:p=>e.editDrugDuration(s),value:s.duration,placeholder:"Add duration..",class:"dosage-input his-sm-text"},null,8,["onClick","value"])]),o("td",null,[n(C,null,{default:a(()=>[l+1>=e.activeDrugs.length?(u(),g(f,{key:0,size:"6"},{default:a(()=>[n(m,{disabled:!(s.id&&s.frequency&&s.duration),onClick:t[0]||(t[0]=p=>e.activeDrugs.push(e.defaultDrugObj())),class:"his-md-text",style:{width:"100%"},color:"success"},{default:a(()=>[n(k,{icon:e.add},null,8,["icon"]),d(" Add ")]),_:2},1032,["disabled"])]),_:2},1024)):E("",!0),l+1<e.activeDrugs.length||l!=0&&l+1>=e.activeDrugs.length?(u(),g(f,{key:1,size:"6"},{default:a(()=>[n(m,{onClick:p=>e.activeDrugs.splice(l,1),class:"his-lg-text",style:{width:"100%"},color:"danger"},{default:a(()=>[n(k,{icon:e.trashBin},null,8,["icon"])]),_:2},1032,["onClick"])]),_:2},1024)):E("",!0)]),_:2},1024)])]))),128))])])]),_:1})]),_:1})]),_:1}),n(z,{style:{height:"29vh"},class:"his-card section"},{default:a(()=>[(u(!0),y(T,null,I(e.drugSets,(s,l)=>(u(),g(B,{class:"his-md-text",detail:"",onClick:p=>e.appendDrugSetValues(s),button:"",key:l},{default:a(()=>[n(N,null,{default:a(()=>[d(q(s.label)+" ("+q(s.value)+")",1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1}),n(j,null,{default:a(()=>[n(b,{color:"dark"},{default:a(()=>[n(m,{"router-link":e.cancelDestination,slot:"start",size:"large",color:"danger"},{default:a(()=>[d(" Cancel ")]),_:1},8,["router-link"]),n(m,{onClick:e.clear,slot:"end",size:"large",color:"warning"},{default:a(()=>[d(" Clear ")]),_:1},8,["onClick"]),n(m,{disabled:e.isSubmitting,onClick:e.onFinish,slot:"end",size:"large",color:"success"},{default:a(()=>[d(" Finish ")]),_:1},8,["disabled","onClick"])]),_:1})]),_:1})]),_:1})}const Te=se(he,[["render",ge],["__scopeId","data-v-81aec3aa"]]);export{Te as default};
