import{d as I,I as M,cL as F,r as b,o as N,i as E,W as q,ak as B,aN as x,da as O,au as p,ai as S,db as H,dc as L,D as U,dd as W,de as X,aa as j,c as V,w as G,af as C,a as Q,b as R}from"./index-cHXRFGhh.js";import{T as z}from"./tx_report_service-BwDY_jUG.js";import{v as J}from"./TableView-QhJWs5MP.js";import{A}from"./v2utils-sIm7mCCH.js";import{R as K}from"./ReportErrors-Ig3bnQeO.js";import{M as Y}from"./moh_cohort_service-CNhwLzBy.js";import"./Export-BW0U4Bvn.js";import"./index-CbTI2VvS.js";const Z=I({components:{IonPage:M,IonLoading:F,v2Datatable:J},setup(){const o=b([]),m=b(""),g=b(!1),l=new z,c=b([]),_=new Y,u=(n,s)=>({ref:s,label:n,toValue:a=>a.length,tdClick:async a=>{a.refData.length&&(await p.create({component:A,backdropDismiss:!1,cssClass:"large-modal",componentProps:{subtitle:m,patientIdentifiers:a.refData,title:"".concat(a.data.age_group," ").concat(a.data.gender," ").concat(a.column.label),onFinish:()=>p.getTop().then(e=>e&&p.dismiss())}})).present()}}),w=[[{label:"#",ref:"index"},{label:"Age group",ref:"age_group"},{label:"Gender",ref:"gender"},u("Tx new CD4 <200","cd4_less_than_200"),u("Tx new CD4 >=200","cd4_greater_than_equal_to_200"),u("Tx new CD4 Unknown","cd4_unknown_or_not_done"),u("Transfer-ins","transfer_in")]],f=function(n){const s=c.value.findIndex(a=>a.id===n.id);s!==-1?c.value[s]=n:c.value.push(n)},D=async function(n){const s="validationErrors";(await p.create({id:s,component:K,backdropDismiss:!1,cssClass:"large-modal",componentProps:{errors:n}})).present(),f({id:s,text:"<b>".concat(n.length,"</b> validation errors detected"),icon:X,color:"danger",action:()=>D(n)})};function k(n){const s={initiated_on_art_first_time:{param:n.total,check:(e,t)=>e!=t,error:(e,t)=>"\n                        MOH cohort initiated on ART first time <b>(".concat(e,")</b> is not matching Tx New <b>(").concat(t,")</b>\n                    ")},initial_pregnant_females_all_ages:{param:n.pregnant,check:(e,t)=>e!=t,error:(e,t)=>"\n                        MOH cohort initial pregnant females all ages \n                        <b>(".concat(e,")</b> is not matching with TX new Pregnant women <b>").concat(t,"</b>\n                    ")},males_initiated_on_art_first_time:{param:n.male,check:(e,t)=>e!=t,error:(e,t)=>"\n                        MoH Cohort males initiated on ART first time <b>(".concat(e,")</b>\n                        is not matching with TX new All male <b>(").concat(t,")</b>\n                    ")},"quarterly_re_initiated_on_art + transfer_in":{param:n.transfer_in,check:(e,t)=>e!=t,error:(e,t)=>"\n                        Quarterly Transfer In + Reinitiated Clients <b>".concat(e,"</b>  does not match Transfer In <b>").concat(t,"</b> clients in TXNEW report\n                    ")}};_.validateIndicators(s,e=>{e.length?D(e):f({id:"reportOk",text:"<b>Report is consistent</b>",icon:W,color:"success"})})===-1&&D(["Report not validated. Run the MoH cohort report for similar reporting period and then run this report"])}const $=async(n=!1)=>{if(!(l.startDate&&l.endDate))return q("Start date and end date required!");const s=n&&await B("Do you want to rebuild report?");g.value=!0,o.value=[];try{const a=await l.getTxNewReport(s),t=a.filter(r=>!["All"].includes(r.age_group)).reduce((r,i)=>(r[i.gender]=Object.keys(i).reduce((d,h)=>Array.isArray(i[h])?{...d,[h]:[...d[h]||[],...i[h]]}:d,r[i.gender]||{}),r),{Male:{},Female:{}});o.value=a;const P=a.reduce((r,i)=>{if(i.gender==="FP"){const d=Object.values(i).filter(Array.isArray).flat();return r.concat(d)}return r},[]),v=["cd4_less_than_200","cd4_greater_than_equal_to_200","cd4_unknown_or_not_done"],T=x.uniq(["Female","Male"].reduce((r,i)=>[...r,...v.map(d=>t[i][d]).flat(1)],[]));f({id:"stats",text:"Tx new <b>".concat(T.length,"</b>"),icon:O,color:"primary",action:async()=>{(await p.create({component:A,backdropDismiss:!1,cssClass:"large-modal",componentProps:{title:"All TxNew",subtitle:m.value,patientIdentifiers:T,onFinish:()=>p.getTop().then(r=>r&&p.dismiss())}})).present()}}),k({total:T.length,pregnant:x.uniq(v.map(r=>t.Female[r].filter(i=>P.includes(i))).flat(1)).length,male:x.uniq(v.map(r=>t.Male[r]).flat(1)).length,transfer_in:[...t.Male.transfer_in,...t.Female.transfer_in].length}),o.value=o.value.map((r,i)=>({index:i+1,...r}))}catch(a){console.error("".concat(a)),S("Unable to generate report!"),c.value=[{text:"Unable to generate report!",color:"danger",icon:H,action:function(){c.value=[{text:"Exception occured: <b>".concat(a,"</b>"),color:"danger",icon:L}]}}]}g.value=!1},y=()=>U({onFinish:(n,s,a,e)=>{m.value=a,l.startDate=n,l.endDate=s,e&&l.setOccupation(e),_.setStartDate(l.startDate),_.setEndDate(l.endDate),$()}});return N(()=>y()),{Img:E,headerBadge:c,reportData:o,isLoading:g,configure:y,generate:$,columns:w,period:m}}});function ee(o,m,g,l,c,_){const u=C("ion-loading"),w=C("v2Datatable"),f=C("ion-page");return Q(),V(f,null,{default:G(()=>[R(u,{"is-open":o.isLoading,message:"Please wait..."},null,8,["is-open"]),R(w,{"icon-url":o.Img("login-logos/PEPFAR.png"),title:"Pepfar Tx New","report-prefix":"Pepfar",subtitle:o.period,columns:o.columns,columnData:o.reportData,rowsPerPage:100,headerBadge:o.headerBadge,onConfigure:o.configure,onRefresh:()=>o.generate(!0)},null,8,["icon-url","subtitle","columns","columnData","headerBadge","onConfigure","onRefresh"])]),_:1})}const ce=j(Z,[["render",ee]]);export{ce as default};
