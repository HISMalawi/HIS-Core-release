System.register(["./index-legacy-BoFMGMh4.js","./dispensation_service-legacy-DcVQvy3b.js","./EncounterMixin.vue_vue_type_script_lang-legacy-DeDyfLNc.js","./Arrays-legacy-K5SD4h1d.js","./drug_order_service-legacy-Ck-MpRLw.js","./encounter_guidelines-legacy-DmafaR8u.js","./GuidelineEngine-legacy-KsvQuFdF.js","./HisStandardForm-legacy-COVbZ4u5.js"],(function(e,t){"use strict";var i,s,a,n,r,o,d,u,l,p,c,h,y,g,m,D,v,f,_;return{setters:[e=>{i=e.d,s=e.H,a=e.am,n=e.al,r=e.s,o=e.aB,d=e.y,u=e.au,l=e.aZ,p=e.bJ,c=e.bh,h=e.ct,y=e.ak,g=e.a,m=e.ap,D=e.b},e=>{v=e.D},e=>{f=e._},e=>{_=e.j},null,null,null,null],execute:function(){const t=i({mixins:[f],data:()=>({dispensation:{},hasTodayAppointment:!1,isEmergencySupply:!1,activeField:""}),watch:{ready:{async handler(e){if(e){this.dispensation=new v(this.patientID,this.providerID);try{const e=new c(this.patientID);await e.enrollProgram()}catch(t){console.log("Probably already enrolled!"),console.error(t)}const e=await v.getFirstObs(this.patientID,"Appointment date");this.hasTodayAppointment=!!e&&h(e.obs_datetime)===h(this.dispensation.date);const i=await p.getArtPatientType(this.patientID);this.isEmergencySupply=/Emergency ARVs for In-Patient/i.test(i?.value_coded||""),this.fields=this.getFields()}},immediate:!0}},methods:{async onSubmitHandler(e){if(this.isEmergencySupply&&e?.notification?.value){const t=new p(this.patientID,this.providerID);await t.createEncounter(),await t.saveValueCodedObs("Registered facility notified of emergency supply",e.notification.value)}return this.hasTodayAppointment?this.gotoPatientDashboard():this.$router.push({name:"appointment"})},saveDispensations(e){return this.dispensation.saveDispensations(this.buildDispensations(e))},buildDispensations(e){if(!l.isEmpty(e.other?.dispenses)){let t=[];return e.other.dispenses.forEach((([i,s])=>{t=[...t,...this.dispensation.buildDispensations(e.other.order_id,i,s)]})),t}return this.dispensation.buildDispensations(e.other.order_id,Number.parseInt(e.value.toString()),1)},async buildMedicationHistory(){return await this.dispensation.loadDrugHistory(),this.dispensation.getDrugHistory().sort(((e,t)=>{const i=new Date(e.order.start_date);return new Date(t.order.start_date)-i})).map((e=>({medication:e.drug.name,date:s.toStandardHisDisplayFormat(e.order.start_date),amount:e.quantity})))},buildOrderOptions(){return this.dispensation.getCurrentOrder().map((e=>({label:e.drug.name,value:e.quantity||0,other:{order:e,drug_id:e.drug.drug_id,order_id:e.order.order_id,available_stock:this.getCumulativeStocks(e.stocks),amount_needed:this.calculateCompletePack(e),pack_sizes:this.getPackSizesRows(e.drug.drug_id,e.stocks)}})))},getCumulativeStocks:e=>e?e.reduce(((e,t)=>e+t.quantity),0):"-",getPackSizesRows(e,t){const i=t?.map((e=>[e.packSize,Math.floor(e.quantity/e.packSize)||"-",0,0]))||[];return this.dispensation.getDrugPackSizes(e).forEach((e=>{-1===i.findIndex((([t])=>t===e))&&i.push([e,"-",0,0])})),i.sort(((e,t)=>e[0]-t[0]))},calculateCompletePack(e){const t=parseFloat(e.amount_needed)-(e.quantity||0);return t<=0?0:this.dispensation.calcCompletePack(e,t)},isDoneDispensing:e=>e.map((e=>0!=e.value)).every(Boolean),async isValidDispensation(e){const t=parseInt(e.value.toString())/e.other.amount_needed*100;if(t>110&&!(await u("Are you sure you want to dispense over 110% of the prescribed pill count?")))return!1;if(t<100&&!(await u("Are you sure you want to dispense less than 100% of the prescribe amount?")))return!1;if(this.dispensation.useDrugManagement){const t=e.other?.dispenses.filter((([t])=>e.other?.pack_sizes.some((([e,i,s])=>e===t&&"-"===i&&s>0)))).map((([e])=>e));if(!l.isEmpty(t))return u(`Are you sure you want to dispense drugs of ${_(t)} pack size(s) that have no associated stocks available?`)}return!0},getFields(){return[{id:"dispenses",helpText:"Dispensation",type:a.TT_DISPENSATION_INPUT,init:async()=>{try{return this.dispensation.setIsDrugManagementEnabled(await o.get("IS_ART_DRUG_MANAGEMENT_ENABLED")),await this.dispensation.loadCurrentDrugOrder(),!0}catch(e){return d(`Unable to load current order: ${e}`),!1}},onValueUpdate:async(e,t)=>-1!=e.value&&this.isDoneDispensing(t)?this.isEmergencySupply?void(this.activeField="notification"):this.onSubmitHandler():(e.other.amount_needed=e.other.amount_needed-(parseInt(e.value.toString())||0),e.other.amount_needed<0&&(e.other.amount_needed=0),await this.dispensation.loadCurrentDrugOrder(),this.buildOrderOptions()),onValue:async(e,t)=>-1===e.value?!(await this.dispensation.voidOrder(e.other.order_id)):!(!t&&!(await this.isValidDispensation(e)))&&(!!(await this.saveDispensations(e))||(r("Unable to save dispensation"),!1)),config:{isDrugManagementEnabled:()=>this.dispensation.useDrugManagement,medicationHistory:()=>this.buildMedicationHistory(),toolbarInfo:[{label:"Name",value:this.patient.getFullName()},{label:"Gender",value:this.patient.getGender()},{label:"Date Of Birth",value:s.toStandardHisDisplayFormat(this.patient.getBirthdate())}],hiddenFooterBtns:["Clear","Finish"]},options:()=>this.buildOrderOptions()},{id:"notification",type:a.TT_SELECT,helpText:"Is registered facility notified of Emergency Supply",options:this.yesNoOptions,validation:e=>n.required(e)}]}}});e("default",y(t,[["render",function(e,t,i,s,a,n){const r=m("his-standard-form");return D(),g(r,{fields:e.fields,skipSummary:!0,activeField:e.activeField,cancelDestinationPath:e.cancelDestination,onOnFinish:e.onSubmitHandler},null,8,["fields","activeField","cancelDestinationPath","onOnFinish"])}]]))}}}));
