import{d as j,cn as E,aN as y,t as I,aU as v,q,ab as G,R as Q,n as W,O as $,ae as X,ce as J,f as Z,l as ee,j as te,k as se,bb as ne,i as oe,C as ie,g as ae,h as re,af as le,e as de,ct as ce,aj as ue,ao as he,_ as pe,r as i,o as r,x as h,b as n,w as o,u as c,F as b,y as g,c as m,v as p,A as a,z as T,a3 as me,a4 as fe}from"./index-CZt4BSQf.js";import{L as ye}from"./lab_order_service-BECVJZd-.js";import{Q as ve}from"./HisKbConfigurations-GhFQZvlg.js";import{H as be}from"./HisKeyboard-DJ3XMwgb.js";import{k as _e}from"./KbHandler-BuQ4TFU6.js";import{F as Ie}from"./fuse-YdZE3OCN.js";const ge=j({name:"Modal",props:{activities:{type:Object,required:!0},testFilters:{type:Array},title:{type:String,default:""}},watch:{activities:{handler(e){e&&(this.appActivities=[...e],this.getActivities())},immediate:!0}},async created(){this.extendedLabsEnabled=await E.extendedLabEnabled(),this.canScanDBS=await E.canScanDBS()},methods:{onFilter(e){this.searchFilter=_e(e,this.searchFilter)},async onScanEIDbarcode(e){if(this.verifyingBarcode=!this.verifyingBarcode,!this.verifyingBarcode){if((await y.create({message:"Checking ".concat(e)})).present(),this.testTypes[this.activeIndex].accessionNumber=null,"".concat(e||"").length<=0){I("Barcode is required"),this.verifyingBarcode=!1,y.getTop().then(t=>t&&y.dismiss());return}try{await v.accessionNumExists(e)?I("Barcode ".concat(e," was already used")):this.testTypes[this.activeIndex].accessionNumber=e}catch(t){q("Failed to confirm barcode "+e+", Please try again later",8e3)}this.verifyingBarcode=!1,y.getTop().then(t=>t&&y.dismiss())}},async onSelectTest(e,t,l){this.searchFilter="",this.showKeyboard=!1,this.testTypes[t].isChecked=l.target.checked,this.testTypes[t].isChecked?(this.activeIndex=t,this.specimens=await v.getSpecimens(e)):this.removeOrder(t)},async getActivities(){const e=await v.getTestTypes(),t=G.findIndex(e,{name:"HIV viral load"}),l=t!==-1?e.splice(t,1):null,u=e.sort((d,f)=>"".concat(d.name).toUpperCase()>"".concat(f.name).toUpperCase()?1:-1).filter(d=>Array.isArray(this.testFilters)?this.testFilters.includes(d.name):!0);this.testTypes=(l?[...l,...u]:u).map((d,f)=>({...d,id:f}))},removeOrder(e){this.testTypes[e].isChecked=!1,this.testTypes[e].reason=null,this.testTypes[e].specimen=null,this.testTypes[e].specimenConcept=null,this.testTypes[e].accessionNumber=null,this.activeIndex=null,this.specimens=[]},addSpecimen(e){this.testTypes[this.activeIndex].specimenConcept=e.concept_id},async postActivities(){this.isPostingOrder=!0;try{const e="".concat(this.$route.params.patient_id),l=await new ye(parseInt(e),-1).createEncounter();if(l){const u=await v.buildLabOrders(l,this.finalOrders),d=await v.saveOrdersArray(l.encounter_id,u);if(!d)return I("Unable to save lab orders");Q.invalidate("PATIENT_LAB_ORDERS"),await W("Lab orders and encounter created!, print out your last orders?",{confirmBtnLabel:"Yes",cancelBtnLabel:"No"})?await this.printOrders(d):await this.closeModal(d)}}catch(e){I("Unable to save order: ".concat(e))}this.isPostingOrder=!1},async closeModal(e){await $.dismiss(e)},async printOrders(e){const t=new X;await e.forEach(async l=>{const u="lab/labels/order?order_id=".concat(l.order_id);await t.printLbl(u)}),await $.dismiss(e)}},computed:{searchIcon(){return J},searchColor(){return this.showKeyboard?"primary":"dark"},testTypesOnDisplay(){return this.searchFilter?new Ie(this.testTypes,{threshold:.3,keys:["name"],useExtendedSearch:!0}).search(this.searchFilter).map(t=>t.item):this.testTypes},dbsBarcodeActivated(){var e,t;return this.canScanDBS&&/dbs/i.test("".concat((e=this.testTypes[this.activeIndex])==null?void 0:e.specimen))&&/hiv viral load/i.test("".concat((t=this.testTypes[this.activeIndex])==null?void 0:t.name))},isOrderComplete(){return typeof this.activeIndex!="number"||this.dbsBarcodeActivated&&!this.testTypes[this.activeIndex].accessionNumber?!1:this.extendedLabsEnabled?!!this.testTypes[this.activeIndex].reason:(this.testTypes[this.activeIndex].specimenConcept||this.testTypes[this.activeIndex].specimen)&&this.testTypes[this.activeIndex].reason},selectedOrders(){return this.testTypes.filter(e=>e.isChecked===!0)},finalOrders(){return this.selectedOrders.filter(e=>this.dbsBarcodeActivated&&!e.accessionNumber?!1:e.reason&&(e.specimen&&!this.extendedLabsEnabled||this.extendedLabsEnabled))},testReasons(){let e=this.reasons;return this.testTypes[this.activeIndex].name.match(/Viral load/i)&&(e=e.filter(t=>t!=="Stat"),e=e.concat(["Follow up after Low Level Viremia","Follow up after High Viral Load"])),e}},mounted(){this.getActivities()},data(){return{isPostingOrder:!1,searchFilter:"",showKeyboard:!1,keyboardLayout:ve,canScanDBS:!1,verifyingBarcode:!1,content:"Content",extendedLabsEnabled:!1,appActivities:[],testTypes:[],specimens:[],reasons:["Routine","Targeted","Confirmatory","Stat","Repeat / Missing"],activeIndex:null}},components:{IonButton:Z,IonContent:ee,IonHeader:te,IonTitle:se,IonInput:ne,IonToolbar:oe,IonLabel:ie,IonList:ae,IonItem:re,BarcodeInput:le,IonCheckbox:de,IonRadioGroup:ce,IonRow:ue,HisKeyboard:be,IonIcon:he}}),O=e=>(me("data-v-04cd93d8"),e=e(),fe(),e),Te={class:"ion-margin-bottom"},ke=O(()=>a("div",{class:"his-md-text side-title"}," Select specimen ",-1)),we={key:1},Ce={class:"his-md-text side-title"},Oe=O(()=>a("div",{class:"his-md-text side-title"}," Main test(s) reason ",-1)),Se={style:{background:"lightyellow",height:"34vh"}},Be={class:"his-sm-text"},Le=O(()=>a("thead",null,[a("tr",null,[a("th",null,"Test"),a("th",null,"Specimen"),a("th",null,"Reason"),a("th",null,"Action")])],-1));function Ae(e,t,l,u,d,f){const N=i("ion-title"),P=i("ion-icon"),V=i("ion-input"),S=i("ion-toolbar"),D=i("ion-header"),k=i("ion-label"),R=i("ion-checkbox"),w=i("ion-item"),B=i("ion-list"),L=i("ion-col"),A=i("ion-radio"),F=i("ion-radio-group"),K=i("ion-text"),x=i("BarcodeInput"),C=i("ion-button"),M=i("ion-row"),U=i("ion-grid"),z=i("his-keyboard"),H=i("ion-content"),Y=i("ion-footer");return r(),h(b,null,[n(D,null,{default:o(()=>[n(S,null,{default:o(()=>[n(N,{class:"his-lg-text",slot:"start"},{default:o(()=>[c(" Lab orders ")]),_:1}),n(P,{size:"large",slot:"end",icon:e.searchIcon,color:e.searchColor},null,8,["icon","color"]),n(V,{readonly:!0,value:e.searchFilter,disabled:e.activeIndex&&!e.isOrderComplete,color:e.searchColor,onClick:t[0]||(t[0]=()=>e.showKeyboard=!e.showKeyboard),placeholder:"Search for tests",style:{"text-align":"left",width:"35%"},class:"input_display",slot:"end"},null,8,["value","disabled","color"])]),_:1})]),_:1}),n(H,{style:{overflow:"hidden",background:"grey",height:"70vh"}},{default:o(()=>[n(U,null,{default:o(()=>[n(M,null,{default:o(()=>[n(L,{size:"6"},{default:o(()=>[n(B,{style:{overflowY:"auto",height:"75vh"}},{default:o(()=>[(r(!0),h(b,null,g(e.testTypesOnDisplay,s=>(r(),m(w,{class:"his-sm-text",key:s.id,disabled:e.activeIndex!=null&&e.activeIndex!==s.id&&!e.isOrderComplete,detail:""},{default:o(()=>[n(k,{"text-wrap":""},{default:o(()=>[c(p(s.name),1)]),_:2},1024),n(R,{slot:"start",checked:s.isChecked,onIonChange:_=>e.onSelectTest(s.name,s.id,_)},null,8,["checked","onIonChange"])]),_:2},1032,["disabled"]))),128))]),_:1})]),_:1}),e.activeIndex!=null&&e.selectedOrders.length>0?(r(),m(L,{key:0,style:{overflowY:"auto",height:"79vh"}},{default:o(()=>[a("div",Te,[e.extendedLabsEnabled?T("",!0):(r(),m(B,{key:0},{default:o(()=>[n(F,{modelValue:e.testTypes[e.activeIndex].specimen,"onUpdate:modelValue":t[1]||(t[1]=s=>e.testTypes[e.activeIndex].specimen=s)},{default:o(()=>[ke,(r(!0),h(b,null,g(e.specimens,s=>(r(),m(w,{key:s},{default:o(()=>[n(k,null,{default:o(()=>[c(p(s.name),1)]),_:2},1024),n(A,{slot:"start",value:s.name,onClick:_=>e.addSpecimen(s)},null,8,["value","onClick"])]),_:2},1024))),128))]),_:1},8,["modelValue"])]),_:1})),e.dbsBarcodeActivated?(r(),h("div",we,[a("div",Ce,[c(" Barcode ID: "),n(K,{color:e.testTypes[e.activeIndex].accessionNumber?"success":"dark"},{default:o(()=>[a("b",null,p(e.testTypes[e.activeIndex].accessionNumber||"None"),1)]),_:1},8,["color"])]),n(x,{size:"small",onOnScan:t[2]||(t[2]=s=>e.onScanEIDbarcode(s))})])):T("",!0),n(F,{modelValue:e.testTypes[e.activeIndex].reason,"onUpdate:modelValue":t[3]||(t[3]=s=>e.testTypes[e.activeIndex].reason=s)},{default:o(()=>[Oe,(r(!0),h(b,null,g(e.testReasons,s=>(r(),m(w,{class:"his-sm-text",key:s},{default:o(()=>[n(k,null,{default:o(()=>[c(p(s),1)]),_:2},1024),n(A,{slot:"start",value:s},null,8,["value"])]),_:2},1024))),128))]),_:1},8,["modelValue"])]),a("div",Se,[a("table",Be,[Le,a("tbody",null,[(r(!0),h(b,null,g(e.finalOrders,(s,_)=>(r(),h("tr",{key:_},[a("td",null,p(s.name),1),a("td",null,p(s.specimen||"N/A"),1),a("td",null,p(s.reason),1),a("td",null,[n(C,{onClick:Fe=>e.removeOrder(s.id),slot:"end",color:"danger"},{default:o(()=>[c("X")]),_:2},1032,["onClick"])])]))),128))])])])]),_:1})):T("",!0)]),_:1})]),_:1}),e.showKeyboard?(r(),m(z,{key:0,kbConfig:e.keyboardLayout,onKeyPress:e.onFilter,disabled:!1},null,8,["kbConfig","onKeyPress"])):T("",!0)]),_:1}),n(Y,null,{default:o(()=>[n(S,null,{default:o(()=>[n(C,{onClick:e.postActivities,size:"large",slot:"end",disabled:e.isPostingOrder||e.finalOrders.length===0},{default:o(()=>[c(" Place orders ")]),_:1},8,["onClick","disabled"]),n(C,{disabled:e.isPostingOrder,onClick:t[4]||(t[4]=s=>e.closeModal([])),size:"large",slot:"start",color:"danger"},{default:o(()=>[c(" Close ")]),_:1},8,["disabled"])]),_:1})]),_:1})],64)}const Re=pe(ge,[["render",Ae],["__scopeId","data-v-04cd93d8"]]);export{Re as L};
