System.register(["./index-legacy-DCqMHtVA.js","./HisStandardForm-legacy-Dsz-zwoz.js"],(function(e,t){"use strict";var i,a,o,r,s,n,l,c,u,d,h,p,m,T,_,g,y,f,v;return{setters:[e=>{i=e.d,a=e.bi,o=e.ae,r=e.U,s=e.q,n=e.F,l=e.V,c=e.cH,u=e.bn,d=e.t,h=e.bm,p=e.cB,m=e.H,T=e.b2,_=e._,g=e.r,y=e.o,f=e.c},e=>{v=e.H}],execute:function(){class t{BASE30_DIGITS_INDEX={};BASE30_DIGITS;constructor(){this.BASE30_DIGITS="0123456789ABCDEFGHJKLMNPRTVWXY".split(""),this.BASE30_DIGITS.forEach(((e,t)=>this.BASE30_DIGITS_INDEX[e]=t))}convertFromDecimal(e,t=30){if(t<2||t>30)throw"Invalid base ${toBase}";let i="";for(;e>0;)i=this.BASE30_DIGITS[e%t]+i,e=Math.floor(e/t);return i}static calculateLuhnCheckDigit(e){const t=e.toString().split("").map((e=>Number.parseInt(e,10))),i=t.length%2;let a=0;t.forEach(((e,t)=>{t%2===i&&(e*=2),e>9&&(e-=9),a+=e}));const o=a%10;return 0===o?0:10-o}isValidDHACode(e){try{const i=this.convertToDecimal(e).toString();return 0===t.calculateLuhnCheckDigit(10*Number.parseInt(i,10))}catch(i){return console.error(i),!1}}convertToDecimal(e){if(0==e.length)return 0;const t=this.BASE30_DIGITS_INDEX[e[0]];if(null==t)throw"Invalid base ${fromBase} number: ${number}";return t*30**(e.length-1)+this.convertToDecimal(e.slice(1))}}const S=i({components:{HisStandardForm:v},data:()=>({activeField:"",fields:[],drugs:[],selectedDrugs:[],barcode:"",stockService:{}}),methods:{async onFinish(e){let t=[];for(const r of e.enter_batches){const s={reallocation_code:e.authorization.value,quantity:r.other.pack_size*r.other.tins,date:e.date.value,reason:r.other.reason};try{"Relocations"===e.task.value?await this.stockService.relocateItems(r.other.id,{...s,location_id:e.relocation_location.value}):await this.stockService.disposeItems(r.other.id,s)}catch(i){i instanceof a&&!o.isEmpty(i.errors)?t=t.concat(i.errors.map((e=>`${e} for ${r.other.drug_name}`))):t.push(`${i}`),console.log(i)}}if(o.isEmpty(t))return r("Stock succesfully moved"),this.$router.push("/");s(`${t.join(",")}`)},getFields(){return[{id:"task",helpText:"Select task",type:n.TT_SELECT,validation:e=>l.required(e),options:()=>[{label:"Relocations",value:"Relocations"},{label:"Disposal",value:"Disposal"}]},{id:"relocation_location",helpText:"Destination",type:n.TT_SELECT,validation:e=>l.required(e)||l.notTheSame(e.label,`${c.getLocationName()}`),condition:e=>"Relocations"===e.task.value,options:(e,t="")=>u(t),computedValue:e=>e.label,config:{showKeyboard:!0,isFilterDataViaApi:!0}},{id:"date",dynamicHelpText:e=>`Date of ${e.task.label}`,helpText:"Set date",type:n.TT_FULL_DATE,validation:e=>l.required(e)},{id:"select drugs",helpText:"Select drugs",type:n.TT_MULTIPLE_SELECT,requireNext:!0,validation:e=>l.required(e),options:async(e,t)=>this.getDrugs(t,e.date.value),unload:e=>this.selectedDrugs=e},{id:"enter_batches",helpText:"Batch entry",type:n.TT_BATCH_MOVEMENT,beforeNext:(e,t,i,{currentFieldContext:a})=>{const r=a.drugs.filter((e=>!e.other.tins||!e.other.reason));if(!o.isEmpty(r)){const e=r.map((e=>`${e.label}`)).join(" & ");return d(`Please fix partial batch entries for drugs: ${e}`),!1}return!0},options:()=>this.selectedDrugs,validation:e=>l.required(e),config:{getReasons:this.getReasons}},{id:"authorization",helpText:"Enter authorization code",type:n.TT_TEXT,config:{customKeyboard:[h,[["Delete"]]]},validation:e=>l.validateSeries([()=>l.required(e),()=>{const i=e.value;return(new t).isValidDHACode(i.toUpperCase())?null:["Invalid authorization code"]}])},{id:"summary",helpText:"Summary",type:n.TT_TABLE_VIEWER,options:e=>this.buildResults(e),config:{hiddenFooterBtns:["Clear"]}}]},buildResults(e){const t="Relocations"===e.task.value,i=["Drug","Total Tins","Expiry date","Authorization code","Reason"];return t&&i.push("Relocation"),[{label:"Confirm entry",value:"Table",other:{columns:i,rows:e.enter_batches.map((i=>{const a=[i.other.drug_name,p(i.other.tins),m.toStandardHisDisplayFormat(i.other.expiry_date),e.authorization.value.toUpperCase(),i.other.reason];return t&&a.push(e.relocation_location.label),a}))}}]},async getDrugs(e,t){return(await this.stockService.getItems()).map((t=>{const i=t?.drug_name??t?.drug_legacy_name??"N/A",a=m.toStandardHisDisplayFormat(t.expiry_date),o=e.filter((e=>e.label===i)).length>=1;return{label:i,value:t.drug_id,isChecked:o,description:{color:"primary",show:"always",text:`Product Code: ${t.product_code} - Batch Number: ${t.batch_number} - Pack Size: ${t.pack_size} - Expiry date: ${a}`},other:{...t,tins:null,quantity:Math.trunc(t.current_quantity/t.pack_size)||0,reason:""}}})).filter((e=>!T(t).isBefore(e.other.delivery_date)&&e.other.current_quantity>0))},mapToOptions:e=>e.map((e=>({label:e,value:e}))),getReasons(e,t){if("Relocations"===t.task.value)return this.mapToOptions(["Transfer to another facility/relocation","For trainings"]);const i=["Damaged","Phased out","Banned","Missing"];return T(e.other?.expiry_date).isAfter(c.getSessionDate())||i.push("Expired"),this.mapToOptions(i)}},created(){this.stockService=new c,this.fields=this.getFields()}});e("default",_(S,[["render",function(e,t,i,a,o,r){const s=g("his-standard-form");return y(),f(s,{fields:e.fields,activeField:e.activeField,onFinishAction:e.onFinish,skipSummary:!0},null,8,["fields","activeField","onFinishAction"])}]]))}}}));
