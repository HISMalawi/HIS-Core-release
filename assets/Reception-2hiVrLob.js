var v=Object.defineProperty;var y=(e,t,i)=>t in e?v(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var h=(e,t,i)=>y(e,typeof t!="symbol"?t+"":t,i);import{bV as b,az as _,bd as l,d as g,al as a,am as u,aZ as p,a_ as A,bJ as w,bi as T,s as d,aB as V,q as P,at as N,B as f,ak as x,a as I,ap as O,b as S}from"./index-3BeNlo1y.js";import{H as G}from"./HisStandardForm-D73p5TNy.js";import{_ as D}from"./EncounterMixin.vue_vue_type_script_lang-CwGN_UQp.js";import"./encounter_guidelines-D8zVYBRP.js";import"./GuidelineEngine-D6V1_Znr.js";class E extends b{constructor(i,n){super(i,51,n);h(this,"sitePrefix");this.sitePrefix=""}getSitePrefix(){return this.sitePrefix}async loadSitePrefix(){this.sitePrefix=await _.sitePrefix()}createArvNumber(i){return l.postJson("/patient_identifiers/",{patient_id:this.patientID,identifier_type:4,identifier:i})}buildArvNumber(i){return"".concat(this.sitePrefix,"-ARV-").concat(i)}}const R=g({mixins:[D],components:{HisStandardForm:G},data:()=>({reception:{},activeField:"",hasARVNumber:!0,suggestedNumber:"",patientType:{},isGuardianOnlyVisitAllowed:!0}),watch:{ready:{handler(e){e&&(this.reception=new E(this.patientID,this.providerID),this.fields=this.getFields())},immediate:!0}},methods:{async setIsGuardianOnlyVisitAllowed(){try{const e=await N.getPatientVisits(this.patientID,!1);if(e.length===0)return;let t=0,i=0;const n=365;for(const s of e){const r=await l.getCurrentProgramInformation(this.patientID,s);if(r.visit_by!=="Guardian")return;if(i++,r.pills_dispensed&&r.pills_dispensed.length>0){const[o,$,c]=r.pills_dispensed[0];if(c){const m=f(c).diff(f(s),"day");if(t+=m,t>=n){this.isGuardianOnlyVisitAllowed=!1;return}}}}}catch(e){console.error("Error checking guardian only visits drug dispensation period:",e)}},async onFinish(e,t){if(!await this.reception.createEncounter())return d("Unable to create encounter");const n=await this.resolveObs(t,"obs");if(!await this.reception.saveObservationList(n))return d("Unable to create Obs");if(e.capture_arv&&e.capture_arv.value==="Yes"){if(!await this.reception.createArvNumber(t.arv_number))return d("Unable to save Arv number");V.invalidate("ACTIVE_PATIENT")}if(P("Encounter created"),p.find(e.who_is_present,{value:"Yes",label:"Guardian present?"})&&p.isEmpty(await this.patient.getGuardian()))return this.$router.push("/guardian/registration/".concat(this.patientID));this.nextTask()},getFields(){return[{id:"who_is_present",helpText:"HIV reception",type:u.TT_MULTIPLE_YES_NO,init:async()=>(await this.setIsGuardianOnlyVisitAllowed(),!0),validation:e=>a.required(e)||a.neitherOr(e)||a.anyEmpty(e),computedValue:e=>({tag:"obs",obs:e.map(({other:t,value:i})=>this.reception.buildValueCoded(t.concept,i))}),onValueUpdate:async(e,t)=>e.map(i=>(t.label!=i.label&&t.value==="No"&&(i.value="Yes"),i)),options:e=>e.who_is_present?e.who_is_present:[{label:"Patient present?",value:"",other:{concept:"Patient Present",property:"patient_present",values:this.yesNoOptions()}},{label:"Guardian present?",value:"",disabled:!this.isGuardianOnlyVisitAllowed,description:this.isGuardianOnlyVisitAllowed?void 0:{color:"warning",text:"Guardian-only visits have reached the maximum allowed duration of 12 months of drug dispensation. The patient must now attend in person."},other:{concept:"Guardian Present",property:"guardian_present",values:this.yesNoOptions()}}],beforeNext:async e=>{const t=p.find(e,{label:"Patient present?"});if((t==null?void 0:t.value)==="No"&&!this.isGuardianOnlyVisitAllowed){const i=await A("Guardian-Only Visit Not Allowed","Patient not present for over 12 months","Guardian-only visits are no longer permitted after accumulating 12 months of drug dispensation. The patient must now attend the clinic in person.",[{name:"Update Selection",slot:"end",color:"danger"},{name:"Exit",slot:"end",color:"primary"}]);if(i==="Update Selection")return!1;if(i==="Exit")return this.$router.push(this.cancelDestination)}return!0}},{id:"capture_arv",helpText:"Capture ARV Number?",type:u.TT_SELECT,requireNext:!0,init:async()=>(this.patient.getPatientIdentifier(4)===""&&(this.hasARVNumber=!1),this.patientType=new w(this.patientID,this.providerID),await this.patientType.loadPatientType(),!0),condition:()=>!this.hasARVNumber&&this.patientType.getType()==="New patient",validation:e=>a.required(e),options:()=>this.yesNoOptions()},{id:"arv_number",helpText:"ART number",type:u.TT_TEXT,init:async()=>{if(await this.reception.loadSitePrefix(),!this.hasARVNumber){const e=await l.getNextSuggestedARVNumber();this.suggestedNumber=e.arv_number.replace(/^\D+|\s/g,"")}return!0},computedValue:({value:e})=>e,validation:e=>a.required(e),condition:e=>!this.hasARVNumber&&e.capture_arv.value==="Yes",defaultValue:()=>this.suggestedNumber,config:{prependValue:()=>{const e=T.getActiveApp();return e&&e.programPatientIdentifiers?e.programPatientIdentifiers["ARV Number"].prefix():""}}}]}}});function F(e,t,i,n,s,r){const o=O("his-standard-form");return S(),I(o,{fields:e.fields,activeField:e.activeField,onFinishAction:e.onFinish,skipSummary:!0,cancelDestinationPath:e.cancelDestination},null,8,["fields","activeField","onFinishAction","cancelDestinationPath"])}const B=x(R,[["render",F]]);export{B as default};
