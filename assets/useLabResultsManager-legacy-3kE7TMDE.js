System.register(["./index-legacy-2OuOZQ1w.js","./lab_order_service-legacy-BUwyFfNb.js"],(function(e,t){"use strict";var a,i,r,n,l,s,o,u,d,c,p,m,v,_,T;return{setters:[e=>{a=e.aR,i=e.r,r=e.C,n=e.aD,l=e.q,s=e.a_,o=e.H,u=e.cL,d=e.an,c=e.ao,p=e.bk,m=e.aw,v=e.aF,_=e.cM},e=>{T=e.L}],execute:function(){let t;e("u",(function(e,i,r){return t=new T(e,i),a(y,(()=>r.value++),{deep:!0}),{testIndicators:f,testOptions:b,getLabFields:C,isValidResult:g,buildTestIndicatorFields:D,loadLabTests:V,submitLabResult:w}}));const f=i([]),b=i([]),y=i(Math.random()),h=r({date:"",id:-1,indicators:[]});async function g(e,t,a){if("HIV viral load"!==e)return!0;const i=a.substring(0,1),r=a.substring(1,a.length);return!!p.isValidVLResult(t,i,r)||!(await m(`Invalid results for ${t} HIV viral load`,{cancelBtnLabel:"Process result",confirmBtnLabel:"Re-enter result"}))}function L(e){return/serum crag/i.test(e)}function E(e){return/mrdt|malaria/i.test(e)}function $(e){return/Lam/i.test(e)}function x(e){return/HIV viral load/i.test(e)}function S(e,t,a,i){const r=function(e){return E(e)||$(e)||L(e)}(e);return{type:r?"text":t[`type_${a}`].value,value:r?`${i}`:i.substring(1),modifier:r?"=":i.charAt(0)}}function R(e,t,a){return e.map((e=>({testId:t,indicatorName:e.name,indicatorId:e.concept_id,specimen:a})))}async function V(){const e=await t.getTestsWithoutResults(),a=[];for(const i of e)for(const e of i.tests)if(s.isEmpty(e.result)){const r=R(await t.getTestIndicators(e.concept_id),e.id,i.specimen.name);f.value.push(...r),a.push([i.accession_number,i.specimen.name,e.name,o.toStandardHisDisplayFormat(i.order_date),{type:"button",name:"Enter result",action:()=>{h.id=e.id,h.date=i.order_date,h.indicators=r,u(I)}}])}b.value=[{label:"",value:"",other:{rows:a,columns:["Acession#","Specimen","Test","Order date"]}}]}async function I(){return v([{id:"result_date",helpText:"Result Date",type:c.TT_DATE_PICKER,required:!0,defaultValue:()=>t.getDate(),computedValue:e=>e,config:{infoItems:e=>[{label:"Order Date",value:o.toStandardHisDisplayFormat(h.date)},{label:"Result Date",value:o.toStandardHisDisplayFormat(e)}],minDate:()=>o.toStandardHisFormat(h.date),maxDate:()=>t.getDate()}},{id:"result_indicators",helpText:"Select test result indicators",type:c.TT_MULTIPLE_SELECT,validation:e=>d.required(e),options:()=>h.indicators.map((e=>({label:e.indicatorName,value:e.indicatorId})))},...D(),{id:"entry_confirmation",helpText:"Confirm entry",type:c.TT_TABLE_VIEWER,options:(e,t)=>[{label:"",value:"",other:{rows:Object.values(t).filter((e=>"object"==typeof e&&null!=e&&"result_indicator"===e.tag)).map((e=>[e.test,e.modifier,e.result])),columns:["Test","Modifier","Result"]}}]}],(async(e,t)=>{const a=Object.values(t).filter((e=>"result_indicator"===e.tag&&e.measures)).map((e=>e.measures));await w(a,t.result_date)&&(await V(),_.dismiss(),y.value=Math.random())}))}function D(){const e=[];for(const t of f.value){const{indicatorName:a,indicatorId:i,testId:r,specimen:n}=t,o=i*r,u=e=>h.id===r&&s.findIndex(e.result_indicators,{label:a})>-1,p=e=>g(a,n,e.value),m=(e,t)=>{if(/^other$/i.test(e.value)&&x(a))return{};const{type:i,value:r,modifier:n}=S(a,t,o,e.value),l="numeric"===i?parseInt(r):r,u=s.find(t.result_indicators,{label:a});return{tag:"result_indicator",measures:{indicator:{concept_id:u.value},value:l,value_modifier:n,value_type:i},result:l,modifier:n,test:u.label}};e.push({id:`type_${o}`,helpText:`Result type (${a})`,type:c.TT_SELECT,group:"test_indicator",condition:e=>u(e)&&!E(a)&&!$(a)&&!L(a),appearInSummary:()=>!1,validation:e=>d.required(e),options:()=>[{label:"Numeric (numbers only)",value:"numeric"},{label:"Alphanumeric(text and numbers)",value:"text"}]},{id:`urine_result_${o}`,helpText:`Select Test Result (${a})`,type:c.TT_SELECT,group:"test_indicator",computedValue:m,validation:e=>d.required(e),condition:e=>u(e)&&$(a),options:()=>[{label:"Positive",value:"positive"},{label:"Negative",value:"negative"}]},{id:`crag_result_${o}`,helpText:`Select Serum CrAg Result (${a})`,type:c.TT_SELECT,group:"test_indicator",computedValue:m,validation:e=>d.required(e),condition:e=>u(e)&&L(a),options:()=>[{label:"Positive",value:"positive"},{label:"Negative",value:"negative"}]},{id:`num_${o}`,helpText:`Test Result (${a})`,type:c.TT_TEXT,group:"test_indicator",computedValue:m,beforeNext:p,onValue:e=>{return!(/hiv/i.test(a)&&e&&e.value&&(t=e.value.toString(),!/^(=|<|>)([0-9]*)$/im.test(t))&&(l("You must enter a modifer and numbers only. i.e =90 / >19 / < 750"),1));var t},validation:e=>d.required(e),condition:e=>u(e)&&"numeric"===e[`type_${o}`].value,config:{customKeyboard:[[["1","2","3"],["4","5","6","=","<",">"],["7","8","9","."],["","0",""]],[["Delete"]]]}},{id:`alpha_${o}`,helpText:`Test Result (${a})`,type:c.TT_TEXT,group:"test_indicator",computedValue:m,validation:e=>d.required(e),condition:e=>u(e)&&"text"===e[`type_${o}`].value&&!x(a)},{id:`VL_alpha_${o}`,helpText:`Select Test Result (${a})`,type:c.TT_SELECT,group:"test_indicator",computedValue:m,validation:e=>d.required(e),condition:e=>u(e)&&"text"===e[`type_${o}`].value&&x(a),options:()=>[{label:"Collect Another Sample",value:"=Collect Another Sample"},{label:"<LDL",value:"<LDL"},{label:"=LDL",value:"=LDL"},{value:"Other",label:"Other"}]},{id:`other_VL_alpha_${o}`,helpText:`Test Result (${a})`,type:c.TT_TEXT,group:"test_indicator",onValue:e=>{return!(e&&e.value&&(t=e.value.toString(),!/^(>|<|=)(.*)/im.test(t))&&(l("You must enter a modifier plus result (for example =LDL)"),1));var t},computedValue:m,validation:e=>d.required(e),condition:e=>u(e)&&"text"===e[`type_${o}`].value&&x(a)&&"Other"===e[`VL_alpha_${o}`].value},{id:`malaria_result_${o}`,helpText:`Select Test Result (${a})`,type:c.TT_SELECT,group:"test_indicator",computedValue:m,validation:e=>d.required(e),condition:e=>u(e)&&E(a),options:()=>a.match(/mrdt/i)?[{label:"Positive",value:"positive"},{label:"Negative",value:"negative"}]:[{label:"Parasites seen",value:"parasites seen"},{label:"No parasites seen",value:"no parasites seen"}]})}return e}async function w(e,a){try{return await t.createEncounter(),await t.createLabResult(e,h.id,a),n.invalidate("PATIENT_LAB_ORDERS"),f.value=[],l("Lab result saved successfully"),!0}catch(i){return console.error(i),l("Failed to save lab result"),!1}}function C(e=!1){return[{id:"test_type",helpText:"Tests without results",type:c.TT_TABLE_VIEWER,condition:()=>!e||!s.isEmpty(b.value[0].other.rows),init:async()=>(await V(),!0),options:()=>b.value,config:{hiddenFooterBtns:["Clear"]}}]}}}}));
