System.register(["./dynamic-import-helper-legacy-DYK5bIOV.js","./HisStandardForm-legacy-DMJkhfrq.js","./index-legacy-X--GYU37.js","./LocationFieldOptions-legacy-tb_FnfFb.js","./TouchScreenForm-legacy-C_f8Ho2H.js","./ToolbarMediumCard-legacy-CdhT4OJW.js","./Transformers-legacy-DhNYVLaS.js","./ViewPort-legacy-1het9QhE.js"],(function(e,t){"use strict";var r,s,i,a,n,o,l,c,d,u,h,p,g,m,y,b,f;return{setters:[e=>{r=e.F},e=>{s=e.H},e=>{i=e.S,a=e.d,n=e.T,o=e.q,l=e.V,c=e.ab,d=e.t,u=e.cm,h=e.H,p=e.cq,g=e._,m=e.r,y=e.o,b=e.c},e=>{f=e.g},null,null,null,null],execute:function(){class t extends i{constructor(){super()}static getDrugs(e={}){return super.getJson("/drug_cms",e)}static search(e=""){return super.getJson("/drug_cms/search",{keyword:e})}}const T=a({components:{HisStandardForm:s},data:()=>({activeField:"",fields:[],drugs:[],selectedDrugs:[],barcode:"",stockService:{}}),methods:{async onFinish(e){const t=this.prepDrugs(e);await this.stockService.postItems(t)?(n("Stock succesfully added"),this.$router.push("/")):o("Could not save stock")},getFields(){return[{id:"transfer_origination",helpText:"Select where stock came from",type:r.TT_SELECT,validation:e=>l.required(e),options:()=>[{label:"DHA",value:"DHA"},{label:"Other location",value:"Other location"}]},{id:"transfer_location",helpText:"Location",type:r.TT_SELECT,validation:e=>l.required(e),condition:e=>"Other location"===e.transfer_origination.value,options:(e,t="")=>f(t),computedValue:e=>e.label,config:{showKeyboard:!0,isFilterDataViaApi:!0}},{id:"barcode",helpText:"Scan barcode",type:r.TT_BARCODE,config:{hiddenFooterBtns:["Clear","Next"]},onValue:async e=>{this.barcode=e,this.activeField="select drugs"},condition:e=>"DHA"===e.transfer_origination.value},{id:"select drugs",helpText:"Select drugs",type:r.TT_INFINITE_SCROLL_MULTIPLE_SELECT,requireNext:!0,validation:e=>l.required(e),options:async(e,r="a")=>{const s=await t.search(r||"a");return this.drugs=this.formatDrugs(s),this.drugs},unload:e=>this.selectedDrugs=e,config:{showKeyboard:!0,isFilterDataViaApi:!0,footerBtns:[{name:"Select all",slot:"end",onClick:async()=>{const e=await t.getDrugs({pagenate:!1});this.drugs=this.formatDrugs(e),this.selectAll(this.drugs)}}]}},{id:"date",helpText:"Delivery Date",type:r.TT_FULL_DATE,validation:e=>l.required(e)},{id:"enter_batches",helpText:"Batch entry",type:r.TT_BATCH_ENTRY,options:()=>this.selectedDrugs,beforeNext:(e,t,r,{currentFieldContext:s})=>{const i=e=>e.map((e=>`${e.label}`)).join(" & "),a=s.drugs.filter((e=>e.entries.map((e=>!(e.tins||e.expiry||e.batchNumber||e.tabs))).every(Boolean))),n=s.drugs.filter((e=>e.entries.map((e=>{let t=0;return e.tins&&(t+=1),e.expiry&&(t+=1),e.batchNumber&&(t+=1),e.tabs&&(t+=1),t>=1&&t<=3})).some(Boolean)));if(!c.isEmpty(n)){const e=i(n);return d(`Please fix partial batch entries for drugs: ${e}`),!1}if(!c.isEmpty(a)){const e=i(a);return d(`The following drug batches are empty: ${e}`),!1}return!0},validation:e=>l.required(e),config:{entryDate:e=>e.date.value}},{id:"summary",helpText:"Summary",type:r.TT_TABLE_VIEWER,options:e=>this.buildResults(e.enter_batches),config:{hiddenFooterBtns:["Clear"]}}]},buildResults:e=>[{label:"Confirm entry",value:"Table",other:{columns:["Drug","Amount per unit","Tins/Pallets","Expiry date","Batch number"],rows:e.map((e=>{const t=e.value;return[t.short_name,t.tabs,u(t.tins),h.toStandardHisDisplayFormat(t.expiry),t.batchNumber]}))}}],prepDrugs(e){const t=[],r=this.barcode,s="DHA"===e.transfer_origination.value?null:e.transfer_location.value;return e.enter_batches.forEach((i=>{const a=i.value;t.push({batch_number:a.batchNumber,location_id:s,items:[{barcode:r,drug_id:a.drug_inventory_id,expiry_date:a.expiry,quantity:parseInt(a.tabs)*parseInt(a.tins),delivery_date:e.date.value,product_code:a.code,pack_size:a.tabs}]})})),t},selectAll:e=>e.map((e=>(e.isChecked=!0,e))),formatDrugs:e=>e.map((e=>({label:`${e.short_name} (${e.code})`,value:e})))},created(){this.stockService=new p,this.fields=this.getFields()}});e("default",g(T,[["render",function(e,t,r,s,i,a){const n=m("his-standard-form");return y(),b(n,{fields:e.fields,activeField:e.activeField,onFinishAction:e.onFinish,skipSummary:!0,onOnIndex:t[0]||(t[0]=t=>e.activeField="")},null,8,["fields","activeField","onFinishAction"])}]]))}}}));
