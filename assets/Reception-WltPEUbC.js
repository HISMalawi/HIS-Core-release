var h=Object.defineProperty;var m=(e,i,t)=>i in e?h(e,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[i]=t;var p=(e,i,t)=>(m(e,typeof i!="symbol"?i+"":i,t),t);import{F as n}from"./dynamic-import-helper-Bsjrd6Ro.js";import{H as f}from"./HisStandardForm-DASCGMaQ.js";import{b5 as b,Q as v,aI as c,d as _,t as s,R as g,T as y,ab as u,V as r,aZ as T,aJ as P,_ as A,r as N,o as V,c as x}from"./index-BCfs_J-V.js";import{_ as w}from"./EncounterMixin.vue_vue_type_script_lang-WQYZM_3x.js";import"./TouchScreenForm-BEQyavf9.js";import"./ToolbarMediumCard-DFqt8bLl.js";import"./Transformers-BPPLlH12.js";import"./ViewPort-CUJ1kut7.js";import"./encounter_guidelines-CdLGhSXd.js";import"./GuidelineEngine-D6V1_Znr.js";class R extends b{constructor(t,a){super(t,51,a);p(this,"sitePrefix");this.sitePrefix=""}getSitePrefix(){return this.sitePrefix}async loadSitePrefix(){this.sitePrefix=await v.sitePrefix()}createArvNumber(t){return c.postJson("/patient_identifiers/",{patient_id:this.patientID,identifier_type:4,identifier:t})}buildArvNumber(t){return"".concat(this.sitePrefix,"-ARV-").concat(t)}}const I=_({mixins:[w],components:{HisStandardForm:f},data:()=>({reception:{},activeField:"",hasARVNumber:!0,suggestedNumber:"",patientType:{}}),watch:{ready:{handler(e){e&&(this.reception=new R(this.patientID,this.providerID),this.fields=this.getFields())},immediate:!0}},methods:{async onFinish(e,i){if(!await this.reception.createEncounter())return s("Unable to create encounter");const a=await this.resolveObs(i,"obs");if(!await this.reception.saveObservationList(a))return s("Unable to create Obs");if(e.capture_arv&&e.capture_arv.value==="Yes"){if(!await this.reception.createArvNumber(i.arv_number))return s("Unable to save Arv number");g.invalidate("ACTIVE_PATIENT")}if(y("Encounter created"),u.find(e.who_is_present,{value:"Yes",label:"Guardian present?"})&&u.isEmpty(await this.patient.getGuardian()))return this.$router.push("/guardian/registration/".concat(this.patientID));this.nextTask()},getFields(){return[{id:"who_is_present",helpText:"HIV reception",type:n.TT_MULTIPLE_YES_NO,validation:e=>r.required(e)||r.neitherOr(e)||r.anyEmpty(e),computedValue:e=>({tag:"obs",obs:e.map(({other:i,value:t})=>this.reception.buildValueCoded(i.concept,t))}),onValueUpdate:async(e,i)=>e.map(t=>(i.label!=t.label&&i.value==="No"&&(t.value="Yes"),t)),options:e=>e.who_is_present?e.who_is_present:[{label:"Patient present?",value:"",other:{concept:"Patient Present",property:"patient_present",values:this.yesNoOptions()}},{label:"Guardian present?",value:"",other:{concept:"Guardian Present",property:"guardian_present",values:this.yesNoOptions()}}]},{id:"capture_arv",helpText:"Capture ARV Number?",type:n.TT_SELECT,requireNext:!0,init:async()=>(this.patient.getPatientIdentifier(4)===""&&(this.hasARVNumber=!1),this.patientType=new T(this.patientID,this.providerID),await this.patientType.loadPatientType(),!0),condition:()=>!this.hasARVNumber&&this.patientType.getType()==="New patient",validation:e=>r.required(e),options:()=>this.yesNoOptions()},{id:"arv_number",helpText:"ART number",type:n.TT_TEXT,init:async()=>{if(await this.reception.loadSitePrefix(),!this.hasARVNumber){const e=await c.getNextSuggestedARVNumber();this.suggestedNumber=e.arv_number.replace(/^\D+|\s/g,"")}return!0},computedValue:({value:e})=>e,validation:e=>r.required(e),condition:e=>!this.hasARVNumber&&e.capture_arv.value==="Yes",defaultValue:()=>this.suggestedNumber,config:{prependValue:()=>{const e=P.getActiveApp();return e&&e.programPatientIdentifiers?e.programPatientIdentifiers["ARV Number"].prefix():""}}}]}}});function S(e,i,t,a,d,l){const o=N("his-standard-form");return V(),x(o,{fields:e.fields,activeField:e.activeField,onFinishAction:e.onFinish,skipSummary:!0,cancelDestinationPath:e.cancelDestination},null,8,["fields","activeField","onFinishAction","cancelDestinationPath"])}const q=A(I,[["render",S]]);export{q as default};
