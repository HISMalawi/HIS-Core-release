System.register(["./index-legacy-zV5Jd_xD.js","./HisStandardForm-legacy-DUG6a-9J.js","./AdherenceMixin.vue_vue_type_script_lang-legacy-CDZvV7Yb.js","./prescription_service-legacy-EyZh2fuj.js","./dispensation_service-legacy-CsrzgWYU.js","./tb_integration_service-legacy-BVWgiaoo.js","./appointment_service-legacy-CgIh5zbY.js","./adherence_service-legacy-B1RSiCX0.js","./htn_service-legacy-DF2pObVj.js","./EncounterMixin.vue_vue_type_script_lang-legacy-BAZjOyt-.js","./encounter_guidelines-legacy-D0nfkYrS.js","./GuidelineEngine-legacy-KsvQuFdF.js","./drug_order_service-legacy-C7x58fKT.js"],(function(t,e){"use strict";var i,a,n,s,o,r,l,d,u,c,h,p,m,g,b,T,_,f,v,y,C,S,P,O,D,x,w,E,I,N,V,H,B,F,A,R,k,L,M,Y,U,q,W,j,$,z,G,X,K,Z,J,Q,tt,et,it,at,nt,st,ot,rt;return{setters:[t=>{i=t.d,a=t.k,n=t.l,s=t.I,o=t.a5,r=t.m,l=t.a4,d=t.z,u=t.H,c=t.ak,h=t.h,p=t.e,m=t.w,g=t.ap,b=t.j,T=t.g,_=t.t,f=t.a9,v=t.b,y=t.bV,C=t.ac,S=t.ds,P=t.a7,O=t.ag,D=t.ah,x=t.aa,w=t.a,E=t.a6,I=t.aO,N=t.al,V=t.am,H=t.a$,B=t.ay,F=t.c2,A=t.U,R=t.aZ,k=t.au,L=t.aY,M=t.bJ,Y=t.aB,U=t.O,q=t.dj,W=t.c1,j=t.ct,$=t.a_,z=t.dr,G=t.B,X=t.bd,K=t.bj,Z=t.bm,J=t.dt,Q=t.s,tt=t.q},t=>{et=t.H},t=>{it=t._},t=>{at=t.P,nt=t.R},t=>{st=t.D},t=>{ot=t.T},t=>{rt=t.A},null,null,null,null,null,null],execute:function(){var e=document.createElement("style");e.textContent="p[data-v-2044e916]{font-size:2rem;font-weight:700;text-align:center}ion-title[data-v-2044e916]{text-align:center;color:green;font-size:2rem;font-weight:700}table[data-v-045e07c6]{font-family:arial,sans-serif;border-collapse:collapse;width:100%}ion-col[data-v-045e07c6]{border-right:solid 1px #ccc}.side-title[data-v-045e07c6]{width:100%;padding:.5em;text-align:center;background:#e9e8e8;font-size:1.2em}td[data-v-045e07c6],th[data-v-045e07c6]{border:1px solid #dddddd;text-align:left;padding:8px}tr[data-v-045e07c6]:nth-child(2n){background-color:#ddd}p[data-v-045e07c6]{font-weight:700}\n/*$vite$:1*/",document.head.appendChild(e);const lt=i({name:"Modal",props:{VLData:{type:Object,required:!0}},async created(){this.artStartDate=u.toStandardHisDisplayFormat(this.VLData.earliest_start_date),this.monthsOnART=this.VLData.period_on_art,this.lastOrder=this.VLData.last_order_date?u.toStandardHisDisplayFormat(this.VLData.last_order_date):"N/A",this.currentRegimen=this.VLData.current_regimen.name?this.VLData.current_regimen.name:"Other",this.regimenStartDate=u.toStandardHisDisplayFormat(this.VLData.current_regimen.date_started)},methods:{async closeModal(t){await d.dismiss(t)}},data:()=>({content:"Content",artStartDate:"",monthsOnART:"",lastOrder:"",currentRegimen:"",regimenStartDate:""}),components:{IonHeader:l,IonToolbar:r,IonTitle:o,IonContent:s,IonFooter:n,IonButton:a}}),dt=c(lt,[["render",function(t,e,i,a,n,s){const o=g("ion-title"),r=g("ion-toolbar"),l=g("ion-header"),d=g("ion-content"),u=g("ion-button"),c=g("ion-footer");return v(),h(f,null,[p(l,null,{default:m((()=>[p(r,null,{default:m((()=>[p(o,null,{default:m((()=>[...e[3]||(e[3]=[b("VL milestone has been reached",-1)])])),_:1})])),_:1})])),_:1}),p(d,{style:{overflowY:"hidden",background:"grey"}},{default:m((()=>[T("p",null,"ART start date : "+_(t.artStartDate),1),T("p",null,"Months on ART: "+_(t.monthsOnART),1),T("p",null,"Last VL order date "+_(t.lastOrder),1),T("p",null,"Current regimen / start date: "+_(t.currentRegimen)+" - "+_(t.regimenStartDate),1)])),_:1}),p(c,null,{default:m((()=>[p(r,null,{default:m((()=>[p(u,{slot:"end",color:"success",size:"large",onClick:e[0]||(e[0]=e=>t.closeModal("order"))},{default:m((()=>[...e[4]||(e[4]=[b(" Order VL",-1)])])),_:1}),p(u,{slot:"end",size:"large",onClick:e[1]||(e[1]=e=>t.closeModal("wait"))},{default:m((()=>[...e[5]||(e[5]=[b(" Wait till next milestone",-1)])])),_:1}),p(u,{slot:"start",color:"danger",size:"large",onClick:e[2]||(e[2]=e=>t.closeModal("later"))},{default:m((()=>[...e[6]||(e[6]=[b(" Remind me later ",-1)])])),_:1})])),_:1})])),_:1})],64)}],["__scopeId","data-v-2044e916"]]);class ut extends y{constructor(t,e){super(t,13,e)}async buildDefferedOrder(t){return[{concept_id:await y.getConceptID("HIV viral load"),value_text:"Wait till next milestone",value_coded:await y.getConceptID("Delayed milestones"),value_numeric:t}]}}const ct=i({name:"Modal",props:{sideEffects:{type:Object,required:!0},drugs:{type:Array,default:()=>[]}},methods:{closeModal(){d.dismiss()},async postSideEffects(){await d.dismiss(this.sides)},selectSideEffect(t){this.activeIndex=t}},computed:{allSelected(){return this.sides.filter((t=>t.reason)).length===this.sides.length}},mounted(){this.sides=this.sideEffects},data:()=>({content:"Content",extendedLabsEnabled:!1,appActivities:[],sides:[],specimens:[],reasons:["Routine","Targeted","Confirmatory","Stat","Repeat / Missing"],activeIndex:null}),components:{IonButton:a,IonContent:s,IonHeader:l,IonTitle:o,IonToolbar:r,IonLabel:D,IonList:O,IonItem:P,IonRadioGroup:S,IonRow:C}}),ht={style:{}},pt=c(ct,[["render",function(t,e,i,a,n,s){const o=g("ion-title"),r=g("ion-toolbar"),l=g("ion-header"),d=g("ion-label"),u=g("ion-item"),c=g("ion-list"),y=g("ion-col"),C=g("ion-radio"),S=g("ion-radio-group"),P=g("ion-row"),O=g("ion-grid"),D=g("ion-content"),N=g("ion-button"),V=g("ion-footer");return v(),h(f,null,[p(l,null,{default:m((()=>[p(r,null,{default:m((()=>[p(o,null,{default:m((()=>[...e[1]||(e[1]=[b("Side effects suspected causes",-1)])])),_:1})])),_:1})])),_:1}),p(D,{style:{overflowY:"hidden",background:"grey"}},{default:m((()=>[p(O,null,{default:m((()=>[p(P,null,{default:m((()=>[p(y,{size:"4"},{default:m((()=>[p(c,{style:{overflowY:"auto",height:"78vh"}},{default:m((()=>[(v(!0),h(f,null,x(t.sides,((e,i)=>(v(),w(u,{key:e,onClick:e=>t.selectSideEffect(i),detail:!0,style:I(t.activeIndex===i?"color: green":"color: black")},{default:m((()=>[p(d,null,{default:m((()=>[b(_(e.label),1)])),_:2},1024)])),_:2},1032,["onClick","style"])))),128))])),_:1})])),_:1}),p(y,{style:{overflowY:"auto",height:"78vh"}},{default:m((()=>[T("div",ht,[p(c,null,{default:m((()=>[null!==t.activeIndex?(v(),w(S,{key:0,modelValue:t.sides[t.activeIndex].reason,"onUpdate:modelValue":e[0]||(e[0]=e=>t.sides[t.activeIndex].reason=e)},{default:m((()=>[e[4]||(e[4]=T("div",{class:"side-title"}," Select reason ",-1)),e[5]||(e[5]=T("p",null,"Current Medication",-1)),(v(!0),h(f,null,x(t.drugs,((t,e)=>(v(),w(u,{key:e},{default:m((()=>[p(d,null,{default:m((()=>[b(_(t.drug.name),1)])),_:2},1024),p(C,{slot:"start",value:t.drug_inventory_id},null,8,["value"])])),_:2},1024)))),128)),e[6]||(e[6]=T("p",null,"Previous Medication",-1)),p(u,null,{default:m((()=>[p(d,null,{default:m((()=>[...e[2]||(e[2]=[b("Other, not drug related",-1)])])),_:1}),p(C,{slot:"start",value:"other"})])),_:1}),p(u,null,{default:m((()=>[p(d,null,{default:m((()=>[...e[3]||(e[3]=[b("Drug side effect",-1)])])),_:1}),p(C,{slot:"start",value:"drug"})])),_:1})])),_:1},8,["modelValue"])):E("",!0)])),_:1})]),e[7]||(e[7]=T("p",null,null,-1))])),_:1})])),_:1})])),_:1})])),_:1}),p(V,null,{default:m((()=>[p(r,null,{default:m((()=>[p(N,{onClick:t.closeModal,slot:"end",color:"danger"},{default:m((()=>[...e[8]||(e[8]=[b(" Close ",-1)])])),_:1},8,["onClick"]),p(N,{onClick:t.postSideEffects,slot:"end",disabled:!t.allSelected},{default:m((()=>[...e[9]||(e[9]=[b(" Save ",-1)])])),_:1},8,["onClick","disabled"])])),_:1})])),_:1})],64)}],["__scopeId","data-v-045e07c6"]]),mt=i({mixins:[it],components:{HisStandardForm:et},data:()=>({fields:[],currentWeight:-1,weightTrail:[],customRegimens:[],labOrders:[],weightLossPercentageNum:0,lostTenPercentBodyWeight:!1,CxCaEnabled:!1,CxCaStartAge:-1,CxCaMaxAge:-1,DueForCxCa:!1,currentlyPregnant:!1,currentlyBreastfeeding:!1,patientHitMenopause:!1,hasPregnancyObsToday:!1,autoSelect3HP:!1,labOrderFieldContext:{},consultation:{},prescription:{},dispensation:{},hasTbHistoryObs:!1,allergicToSulphur:!1,TBSuspected:!1,presentedTBSymptoms:!1,askAdherence:!1,lastDrugsReceived:[],sideEffectsHistory:{},onPermanentFPMethods:!1,reasonForDecliningTPTObs:{},malawiSideEffectReasonObs:[],otherSideEffectReasonObs:[],wasTransferredIn:!1,dateStartedArt:"",clientHadAHysterectomy:!1,isNoneClientPatient:!1,tptStatus:{},customDrugs:[],CxCaAppointDate:{},hasTbTreatmentDate:!1,isEligibleForTpt:!1,appointment:{},extraDtgState:{init:!1,onDtg:!1,dtgNeeded:0,nextAppointment:"",consultationBeforeAppointment:!1,arvExpireDate:"",lastArvStartDate:"",isNewTbTreatment:!1}}),watch:{ready:{handler(t){t&&(this.consultation=new z(this.patientID,this.providerID),this.prescription=new at(this.patientID,this.providerID),this.dispensation=new st(this.patientID,this.providerID),this.appointment=new rt(this.patientID,this.providerID),this.fields=this.getFields())},immediate:!0}},methods:{async onFinish(t,e){if(!(await this.consultation.createEncounter()))return Q("Unable to create encounter");const i=await this.resolveObs(e,"consultation"),a=(await Promise.all([...this.malawiSideEffectReasonObs,...this.otherSideEffectReasonObs,this.reasonForDecliningTPTObs,this.buildTBStatusObs(t)])).filter((t=>!R.isEmpty(t))),n=await this.consultation.saveObservationList([...i,...a]);if(R.isEmpty(this.drugObs)||this.isNoneClientPatient||await this.saveAdherence(),!n)return Q("Unable to save patient observations");const s=this.inArray(t.prescription,(t=>"ARVs"===t.value&&t.isChecked));this.isEligibleForExtraDtg(t)&&s&&"Prescribe Extra DTG"===await $("Patient on TB Treatment","Patient is eligible for extra DTG supplementation","Patient is currently on TB treatment and taking DTG-based regimen. Choose to prescribe extra DTG or review current ART regimen",[{name:"Prescribe Extra DTG",slot:"start",color:"success"},{name:"Review ART Regimen",slot:"end",color:"primary"}],"his-warning-color")&&await this.prescribeExtraDtg(),tt("Observations and encounter created!"),t.refer_to_clinician&&"Yes"===t.refer_to_clinician.value?this.gotoPatientDashboard():this.nextTask()},async getTptDrugs(t){const e=[],i=t.routine_tb_therapy.value;return R.isEmpty(this.customDrugs)&&(this.customDrugs=await nt.getCustomIngridients()),i.match(/ipt/i)?e.push("INH or H (Isoniazid 300mg tablet)"):i.includes("3HP (RFP + INH)")?(e.push("INH or H (Isoniazid 300mg tablet)"),e.push("Rifapentine (150mg)")):i.includes("INH 300 / RFP 300 (3HP)")&&e.push("INH 300 / RFP 300 (3HP)"),R.isEmpty(e)?[]:this.customDrugs.filter((t=>e.includes(t.name))).map((t=>({label:t.name,value:"",other:t})))},async getTransferInStatus(){const t=await z.getFirstValueCoded(this.patientID,"Ever received ART"),e=await z.getFirstObs(this.patientID,"Has transfer letter"),i=e?u.toStandardHisFormat(e.obs_datetime):"";return t&&t.match(/yes/i)&&e&&`${e.value_coded}`.match(/yes/i)&&i===this.consultation.getDate()},async getDateStartedArt(){const t=await z.getFirstValueDatetime(this.patientID,"Date ART started");return t?u.toStandardHisFormat(t):""},async checkIfWeightLossIsControlled(t){if(this.lostTenPercentBodyWeight&&`${t.label}`.match(/malnutrition/i)&&`${t.value}`.match(/no/i)){const e=await $("Recommendation",`Patient's weight has dropped by ${this.weightLossPercentageNum}% , is this controlled weight loss??`,"Please verify",[{name:"Confirm weight loss",slot:"start",color:"success"},{name:"Confirm controlled",slot:"end",color:"primary"}]);t.value="Confirm weight loss"===e?"Yes":"No"}},async checkVLReminder(){const t=await X.getPatientVLInfo(this.patientID);if(!0===t.eligibile){const e=await d.create({component:dt,backdropDismiss:!1,cssClass:"large-modal",componentProps:{VLData:t}});e.present();const{data:i}=await e.onDidDismiss();switch(i){case"order":await this.labOrderFieldContext.launchOrderSelection();break;case"wait":await this.waitForVL()}}},async waitForVL(t=null){const e=new ut(this.patientID,this.providerID),i=await e.createEncounter(),a=await e.buildDefferedOrder(t);if(!i)return Q("Unable to create encounter");await e.saveObservationList(a)},canScreenCxCa(){const t=this.patient.getAge();return this.patient.isFemale()&&this.DueForCxCa&&this.CxCaEnabled&&t>=this.CxCaStartAge&&t<=this.CxCaMaxAge&&!this.clientHadAHysterectomy},pregnancyEligible(){return this.patient.isChildBearing()&&!this.onPermanentFPMethods},showCurrentContraceptionMethods(t){return this.pregnancyEligible()&&!this.patientHitMenopause&&!this.isPregnant(t)&&!this.isANCclient()},showNewContraceptionMethods(t){return this.pregnancyEligible()&&!this.patientHitMenopause&&!this.isPregnant(t)&&!this.isLongTermFpMethod(t)&&!this.isANCclient()},isPregnant(t){return t.pregnant_breastfeeding?this.inArray(t.pregnant_breastfeeding,(t=>"Pregnant"===t.label&&"Yes"===t.value)):this.currentlyPregnant},isBreastFeeding(t){return t.pregnant_breastfeeding?this.inArray(t.pregnant_breastfeeding,(t=>"Breastfeeding"===t.label&&"Yes"===t.value)):this.currentlyBreastfeeding},isLongTermFpMethod:t=>(t.current_fp_methods||[]).some((t=>/contraceptive implant|intrauterine|tubal ligation/i.test(`${t.value}`))),async disableFPMethods(t,e){if(e.isChecked&&"NONE"===e.label)return t.map((t=>("NONE"!=t.label&&(t.isChecked=!1,t.disabled=!1),t)));if("NONE"!=e.label&&e.isChecked){e.label.match(/condom/gi)&&J("Combine with other modern methods of family planning"),t[R.findIndex(t,{label:"NONE"})].isChecked=!1;const i=this.consultation.familyPlanningMethods(e.label,t);return i[R.findIndex(i,{label:e.label})].isChecked=!0,i}return t.map((t=>(t.disabled=!1,t)))},disablePrescriptions:(t,e)=>e.isChecked&&/extra dtg|none/i.test(e.label)?t.map((t=>({...t,isChecked:t.label===e.label}))):t.map((t=>({...t,isChecked:!/extra dtg|none/i.test(`${t.label}`)&&t.isChecked}))),buildMedicationOrders(t){return this.inArray(t,(t=>"Extra DTG"===t.label))?[this.consultation.buildValueCoded("Prescribe drugs","Yes"),this.consultation.buildValueCoded("Medication orders","ARVs")]:this.inArray(t,(t=>"NONE OF THE ABOVE"===t.label))?this.consultation.buildValueCoded("Prescribe drugs","No"):[this.consultation.buildValueCoded("Prescribe drugs","Yes"),...t.map((t=>this.consultation.buildValueCoded("Medication orders",t.label)))]},declinedFPM(t){return this.inArray(t.fp_methods,(t=>"NONE"===t.value))&&this.inArray(t.current_fp_methods,(t=>"NONE"===t.value))},riskOfUnplannedPregnancy:t=>"At risk of unplanned pregnancy"===t.reason_for_no_fpm.value,showOtherSideEffects(t){return this.inArray(t.side_effects,(t=>"Other"===t.label&&"Yes"===t.value))},hasTBSymptoms(t){return this.presentedTBSymptoms=this.inArray(t.tb_side_effects,(t=>"Yes"===t.value)),this.presentedTBSymptoms},isTBSuspect(t){return this.TBSuspected=!!t.value.toString().match(/Yes|TB Suspected/i),this.TBSuspected},isAllergicToSulphur(t){return this.allergicToSulphur=t.value.match(/unknown/i)?null:!!t.value.match(/yes/i),this.allergicToSulphur},async buildSideEffectObs(t,e){const i=await this.getSideEffectsReasons(t);if(this[e]=[],void 0===i)return!1;if(-1!=i){const t=Z.getCachedConceptID("Drug induced",!0),a=t=>!!`${t}`.match(/other|drug/i);this[e]=i.map((e=>({concept_id:t,value_coded:Z.getCachedConceptID(e.label,!0),value_text:a(e.reason)?"Past medication history":null,value_drug:a(e.reason)?null:e.reason})))}return!0},async getSideEffectsReasons(t){const e=t.filter((t=>!`${t.label}`.match(/other/i)&&"Yes"===t.value));if(e.length>0){const t=await d.create({component:pt,backdropDismiss:!1,cssClass:"large-modal",componentProps:{sideEffects:e,drugs:this.lastDrugsReceived}});t.present();const{data:i}=await t.onDidDismiss();return i}return-1},getFPMethods(t=[],e){return this.consultation.getFamilyPlanningMethods().filter((e=>!t.includes(e))).map((t=>({label:t,value:t,isChecked:e.map((t=>t.label)).includes(t)})))},getContraindications(t){const e=Z.getConceptsByCategory("contraindication",!0).map((t=>t.name));return this.getOptions([...e,"Other"],t)},getOtherContraindications(t){const e=Z.getConceptsByCategory("side_effect",!0).map((t=>t.name)),i=e.pop();return this.getOptions([...e,"Other (Specify)",`${i}`],t)},getTBSymptoms(t){const e=Z.getConceptsByCategory("tb_symptom",!0).map((t=>t.name));return this.getOptions([...e],t)},getReasonsForNoCxcaOptions:()=>Z.getConceptsByCategory("reason_for_no_cxca").map((t=>({label:t.name,value:t.name,other:{c:t}}))),runAppendOptionParams(t,e){const i=e.filter((t=>t.isChecked)).map((t=>t.label));return t.map((t=>{if("function"==typeof t?.other?.appendOptionParams){const e=t?.other?.appendOptionParams();if("object"==typeof e){const a={label:t.label,value:t.value,other:t.other};return e.isChecked?(a.isChecked=e.isChecked,delete e.isChecked):a.isChecked=i.includes(t.label),{...a,...e}}}return t}))},didCompletedTPT(t){return/complete/i.test(t.routine_tb_therapy?.value)||this.tptStatus.completed},patientOnTpt(t){return this.didCompletedTPT(t)},async on3HPValueUpdate(t,e){const i=t=>!!t.label.match(/IPT|3HP/i),a=(()=>{const e=t.reduce(((t,e)=>(i(e)&&!(e.label in t)&&e.isChecked&&t.push(e.label),t)),[]);return e.includes("IPT")&&(e.includes("3HP (RFP + INH)")||e.includes("INH 300 / RFP 300 (3HP)"))})(),n=i(e)&&t.filter((t=>i(t))).map((t=>!t.isChecked)).every(Boolean);if(i(e)&&n&&!this.tptStatus.completed){const t=await L("Reasons for declining TPT","",["Patient declined","Side-effects (previous or current)","Stock-out","Starting TB treatment","Heavy alcohol use","Hepatic conditions (active hepatitis or liver damage)","Severe/moderate peripheral neuropathy","Hypersensitivity to INH, Rifapentine, or Rifampicin","Other"],[{name:"Done",slot:"start",role:"action"}]);this.reasonForDecliningTPTObs=this.consultation.buildValueText("Other reason for not seeking services",t.selection)}else this.reasonForDecliningTPTObs={};if(a){const e=await $("IPT / 3HP conflict","IPT and 3HP can NOT be prescribed together","Please pick either one",[{name:"Prescribe 3HP",slot:"start",color:"primary"},{name:"Prescribe IPT",slot:"end",color:"primary"}]);return t.map((t=>(i(t)&&(t.isChecked="Prescribe IPT"===e&&"IPT"===t.label||"Prescribe 3HP"===e&&"INH 300 / RFP 300 (3HP)"===t.label),t)))}return t.map((t=>(("3HP (RFP + INH)"===e.label&&"INH 300 / RFP 300 (3HP)"===t.label&&e.isChecked||"INH 300 / RFP 300 (3HP)"===e.label&&"3HP (RFP + INH)"===t.label&&e.isChecked)&&(t.isChecked=!1),t)))},medicationOrderOptions(t,e=[]){this.isEligibleForTpt=!1;const i=this.didCompletedTPT(t),a=null!==this.tptStatus.tpt,n=this.isBreastFeeding(t),s=this.isPregnant(t),o="Yes"===t.on_tb_treatment?.value||"Yes"===t.start_tb_treatment?.value||t.tb_module_status,r=t=>({disabled:!0,isChecked:!1,description:{color:"danger",show:"always",text:t}}),l=n?{isChecked:!1,description:{color:"danger",show:"always",text:"Patient is breast feeding"}}:{};return this.runAppendOptionParams([this.toOption("ARVs",{appendOptionParams:()=>({isChecked:!this.isEligibleForExtraDtg(t)&&this.autoSelect3HP&&!this.TBSuspected})}),this.toOption("CPT",{appendOptionParams:()=>this.isEligibleForExtraDtg(t)||!this.autoSelect3HP||this.TBSuspected||this.allergicToSulphur?this.allergicToSulphur?r("Allergic to CPT"):{disabled:!1}:{isChecked:!0}}),this.toOption("3HP (RFP + INH)",{appendOptionParams:()=>i?r("Completed TPT treatment"):o?r("On TB treatment"):this.tptStatus.tb_treatment?r("Completed/on TB treatment"):/confirmed tb/i.test(t.tb_status?.value)?r("Confirmed TB Not on treatment"):this.TBSuspected?r("TB Suspect"):s?r("Pregnant patient"):this.currentWeight<20?r("Weight below regulation"):this.tptStatus.eligible["3HP"]||this.tptStatus.eligible["6H"]?a&&"3HP (RFP + INH)"!==this.tptStatus.tpt&&!this.tptStatus.completed?r(`On ${this.tptStatus.tpt} treatment`):(this.isEligibleForTpt=this.tptStatus.eligible["3HP"],"3HP (RFP + INH)"===this.tptStatus.tpt&&!this.tptStatus.completed&&this.isEligibleForTpt?{isChecked:!0,...l}:void 0):r("Not eligible to start or re-start TPT")}),this.toOption("INH 300 / RFP 300 (3HP)",{appendOptionParams:()=>i?r("Completed TPT treatment"):o?r("On TB treatment"):this.tptStatus.tb_treatment?r("Completed/on TB treatment"):this.TBSuspected?r("TB Suspect"):/confirmed tb/i.test(t.tb_status?.value)?r("Confirmed TB Not on treatment"):s?r("Pregnant patient"):this.currentWeight<30?r("Weight below regulation"):this.tptStatus.eligible["3HP"]||this.tptStatus.eligible["6H"]?a&&"INH 300 / RFP 300 (3HP)"!==this.tptStatus.tpt&&!this.tptStatus.completed?r(`On ${this.tptStatus.tpt} treatment`):(this.isEligibleForTpt=this.tptStatus.eligible["3HP"],"INH 300 / RFP 300 (3HP)"===this.tptStatus.tpt&&!this.tptStatus.completed&&this.isEligibleForTpt?{isChecked:!0,...l}:{isChecked:this.autoSelect3HP&&this.isEligibleForTpt,...l}):r("Not eligible to start or re-start TPT")}),this.toOption("IPT",{appendOptionParams:()=>i?r("Completed TPT treatment"):o?r("On TB treatment"):this.tptStatus.tb_treatment?r("Completed/on TB treatment"):this.TBSuspected?r("TB Suspect"):/confirmed tb/i.test(t.tb_status?.value)?r("Confirmed TB Not on treatment"):s?r("Pregnant patient"):this.tptStatus.eligible["3HP"]||this.tptStatus.eligible["6H"]?a&&"IPT"!==this.tptStatus.tpt&&!this.tptStatus.completed?r(`On ${this.tptStatus.tpt} treatment`):(this.isEligibleForTpt=this.tptStatus.eligible["6H"],"IPT"===this.tptStatus.tpt&&!this.tptStatus.completed&&this.isEligibleForTpt?{isChecked:!0,...l}:void 0):r("Not eligible to start or re-start TPT")}),this.toOption("NONE OF THE ABOVE")],e)},async getVlLabData(){return K.formatLabs(await Y.get("GET_LAB_ORDERS_WITH_GIVEN_RESULT_STATUS",{patientID:this.patientID}))},isANCclient:()=>"ANC"===X.getSuspendedProgram(),isRapidTestPositive(t){const e="Molecular WHO Recommended Rapid Diagnostic test",i=t.tb_screening_testing_results.reduce(((t,e)=>({...t,[e.label]:e.value})),{});return"Negative"!==i[e]&&("Positive"===i["chest x-ray"]||"Positive"===i[e])},buildTBStatusObs(t){return"Yes"===t?.on_tb_treatment?.value||"Yes"===t.start_tb_treatment?.value?this.consultation.buildValueCoded("TB Status","Confirmed TB on treatment"):t?.tb_status?this.consultation.buildValueCoded("TB Status",t.tb_status.value):t?.tb_screening_testing_results?this.isRapidTestPositive(t)?this.consultation.buildValueCoded("TB Status","TB Suspected"):this.consultation.buildValueCoded("TB Status","TB NOT suspected"):t?.tb_side_effects&&!this.hasTBSymptoms(t)?this.consultation.buildValueCoded("TB Status","TB NOT suspected"):{}},async prescribeExtraDtg(){const t=this.prescription.toOrderObj(982,"Dolutegravir (50mg tablet)","tab(s)",0,1,"Daily (QOD)");t.auto_expire_date=this.extraDtgState.arvExpireDate,await this.prescription.createEncounter(),await this.prescription.createDrugOrder([t]),await this.appointment.createEncounter(),await this.appointment.saveValueDatetimeObs("Appointment date",this.extraDtgState.nextAppointment),await this.appointment.saveValueDatetimeObs("Estimated date",this.extraDtgState.nextAppointment)},async initExtraDtgCheck(t){this.extraDtgState.init||(this.extraDtgState.nextAppointment=await this.appointment.getLastAppointmentDate(),this.extraDtgState.isNewTbTreatment="Yes"===await this.appointment.getFirstValueCoded("TB treatment"));const e=(t?.pills_brought??[]).find((t=>at.regimenHasDtg(t.other.regimen)&&t.value>0));e&&(this.extraDtgState.onDtg=!0,this.extraDtgState.lastArvStartDate=e.other.order.start_date,this.extraDtgState.arvExpireDate=e.other.order.auto_expire_date,this.extraDtgState.dtgNeeded=e.other.quantity-e.value,this.extraDtgState.consultationBeforeAppointment=!!this.extraDtgState.nextAppointment&&G(this.consultation.date).isBefore(this.extraDtgState.nextAppointment)),this.extraDtgState.init=!0},isEligibleForExtraDtg(t){return!this.isNoneClientPatient&&("Yes"===t?.on_tb_treatment?.value||"Yes"===t?.start_tb_treatment?.value)&&this.extraDtgState.consultationBeforeAppointment&&this.extraDtgState.onDtg&&this.extraDtgState.dtgNeeded>0&&!this.extraDtgState.isNewTbTreatment},isTBPositive:t=>/confirmed/i.test(t.tb_status?.value??"")||t.tb_screening_testing_results?.some((t=>/Positive/i.test(t.value.toString()))),getFields(){return[{id:"other_patient_prescription",proxyID:"prescription",helpText:"Medication to prescribe during this visit",type:V.TT_MULTIPLE_SELECT,init:async()=>{const t="No"===await this.consultation.getClient();return this.isNoneClientPatient=!!t||!!(await M.isDrugRefillPatient(this.patientID)),this.isNoneClientPatient&&(this.currentWeight=Number(await this.patient.getRecentWeight()),this.autoSelect3HP=await Y.get("ART_AUTO_3HP_SELECTION"),this.tptStatus=await this.consultation.getTptTreatmentStatus()),!0},beforeNext:async(t,e)=>{if(!Object.keys(this.reasonForDecliningTPTObs).length&&!this.isBreastFeeding(e)&&this.isEligibleForTpt&&!this.patientOnTpt(e)&&!t.some((t=>/3hp|ipt/i.test(t.label)))){if(!(await k("Are you sure you want to proceed without prescribing TPT?")))return this.reasonForDecliningTPTObs={},!1;{const t=await L("Reasons for declining TPT","",["Patient declined","Side-effects (previous or current)","Stock-out","Starting TB treatment","Heavy alcohol use","Hepatic conditions (active hepatitis or liver damage)","Severe/moderate peripheral neuropathy","Hypersensitivity to INH, Rifapentine, or Rifampicin","Other"],[{name:"Done",slot:"start",role:"action"}]);this.reasonForDecliningTPTObs=this.consultation.buildValueText("Other reason for not seeking services",t.selection)}}return!0},validation:t=>N.required(t),computedValue:t=>({tag:"consultation",obs:this.buildMedicationOrders(t)}),onValueUpdate:(t,e)=>{const i=this.disablePrescriptions(t,e);return this.on3HPValueUpdate(i,e)},options:(t,e,i,a)=>R.isEmpty(a)?this.medicationOrderOptions(t):a,condition:()=>this.isNoneClientPatient,exitsForm:()=>!0},...H({id:"date_last_received_arvs",helpText:"Last ARV Dispensation",required:!0,init:async()=>(this.wasTransferredIn=await this.getTransferInStatus()||!1,this.dateStartedArt=await this.getDateStartedArt(),!0),condition:()=>this.wasTransferredIn,minDate:()=>this.dateStartedArt,maxDate:()=>this.consultation.getDate(),computeValue:t=>(this.prescription.setDate(t),{tag:"consultation",date:t,obs:this.consultation.buildValueDate("Date drug received from previous facility",t)}),estimation:{allowUnknown:!1}}),{id:"previous_arvs_received",helpText:"Last ARV drugs dispensed",type:V.TT_MULTIPLE_SELECT,computedValue:t=>t.map((t=>t.other)),validation:t=>N.required(t),options:async()=>{if(!R.isEmpty(this.customRegimens))return this.customRegimens;const t=new at(this.patientID,this.providerID);return this.customRegimens=(await t.getARVs()).map((t=>({label:t.name,value:t.drug_id,other:{...t}}))),this.customRegimens},config:{showKeyboard:!0},condition:()=>this.wasTransferredIn},{id:"drug_interval",helpText:"Duration period for last received ARVs",type:V.TT_NEXT_VISIT_INTERVAL_SELECTION,condition:()=>this.wasTransferredIn,validation:t=>N.required(t),computedValue:t=>t.other.nextAppointment,options:()=>[{label:"2 weeks",value:14},{label:"1 month",value:28},{label:"2 months",value:56},{label:"3 months",value:84},{label:"4 months",value:112},{label:"5 months",value:140},{label:"6 months",value:168},{label:"7 months",value:196},{label:"8 months",value:224},{label:"9 months",value:252},{label:"10 months",value:280},{label:"11 months",value:308},{label:"12 months",value:336}].map((({label:t,value:e})=>{this.prescription.setNextVisitInterval(e);const i=this.prescription.calculateDateFromInterval();return{label:t,value:e,other:{label:"Medication run-out date:",value:u.toStandardHisDisplayFormat(i),nextAppointment:i,other:{label:"",value:[]}}}}))},{id:"arv_quantities",helpText:"Amount of drugs dispensed (From last ART Facility)",type:V.TT_DRUG_TRANSFER_IN,validation:t=>this.validateSeries([()=>N.required(t),()=>t.map((t=>""===t.value||""===t?.other?.pillsBrought)).some(Boolean)?["Some Drugs are missing values"]:null]),computedValue:(t,e,i)=>({tag:"consultation",obs:t.map((async t=>{const e=t?.other?.drug?.drug_id||0;return{...await this.consultation.buildObs("Drug received from previous facility",{value_drug:e,value_datetime:i?.drug_interval||null,value_numeric:t?.value||0}),child:[await this.consultation.buildObs("Number of tablets brought to clinic",{value_drug:e,value_numeric:t?.other?.pillsBrought||-1,value_datetime:i?.date_last_received_arvs?.date||null})]}}))}),options:(t,e,i)=>e.previous_arvs_received.map((t=>{const e=t.alternative_drug_name||t.drug_name||t.name,a=R.find(i,{label:e});let n="",s="";return a&&(n=a?.value,s=a?.other?.pillsBrought),{label:e,value:n,other:{drug:t,pillsBrought:s}}})),condition:()=>this.wasTransferredIn},{id:"patient_lab_orders",helpText:"Lab orders",type:V.TT_LAB_ORDERS,init:async()=>(this.labOrders=await this.getVlLabData(),!0),unload:async()=>{await this.checkVLReminder();const t=this.labOrders.filter((t=>"No"===t.result_given));if(t.length&&await k("Result(s) Given to Client?")){const e=new y(this.patientID,-1,this.providerID),i=t.reduce(((t,i)=>[...t,...i.resultIds.map((async t=>(e.encounterID=i.encounter_id,e.saveObs(await e.buildObs("Result Given to Client",{value_coded:"Yes",obs_group_id:t})))))]),[]);await Promise.all(i)}this.labOrders=await this.getVlLabData()},onload:t=>this.labOrderFieldContext=t,options:()=>[{label:"Lab orders",value:"order trail",other:{values:this.labOrders}}],config:{printOrder:t=>U(t),hiddenFooterBtns:["Clear"],footerBtns:[{name:"Order",size:"large",slot:"end",color:"primary",visible:!0,onClick:async()=>{R.isEmpty(this.labOrderFieldContext)||await this.labOrderFieldContext.launchOrderSelection()}}]}},{id:"pregnant_breastfeeding",helpText:"Patient Pregnant or breastfeeding?",init:async()=>(this.patient.isFemale()&&(this.patient.isChildBearing()&&(this.hasPregnancyObsToday=await this.patient.hasPregnancyObsToday(),this.currentlyPregnant=await this.patient.isPregnant(),this.currentlyBreastfeeding=await this.patient.isBreastfeeding()),this.onPermanentFPMethods=await this.consultation.getTLObs()),!0),condition:()=>!this.hasPregnancyObsToday&&this.pregnancyEligible(),type:V.TT_MULTIPLE_YES_NO,validation:t=>this.validateSeries([()=>N.required(t),()=>N.anyEmpty(t)]),computedValue:t=>({tag:"consultation",obs:t.map((t=>this.consultation.buildValueCoded(t.other.concept,t.value))).concat(this.isANCclient()?[this.consultation.buildValueCoded("Is patient pregnant","Yes")]:[])}),options:t=>{const e=[];return this.isANCclient()||e.push({label:"Pregnant",value:"",other:{values:this.yesNoOptions(),concept:"Is patient pregnant"}}),e.push({label:"Breastfeeding",value:"",other:{values:this.yesNoOptions(),concept:"Is patient breast feeding"}}),t.pregnant_breastfeeding||e}},{id:"patient_weight_chart",helpText:"Patient weight chart",type:V.TT_WEIGHT_CHART,init:async()=>(this.weightTrail=await this.patient.getWeightHistory(),this.weightLossPercentageNum=this.patient.getWeightLossPercentageFromTrail(this.weightTrail),this.lostTenPercentBodyWeight=this.weightLossPercentageNum>=10,!0),options:async()=>[{label:"Weight for patient",value:"Weight trail",other:{bmi:await this.patient.getBMI(),values:this.weightTrail.map((t=>({x:u.toStandardHisDisplayFormat(t.date),y:t.weight}))),age:this.patient.getAge()}}],config:{hiddenFooterBtns:["Clear"]}},{id:"has_fp_methods",helpText:"",type:V.TT_TEXT_BANNER,condition:()=>this.onPermanentFPMethods,options:()=>this.mapStrToOptions(["Patient is on Tubal ligation method"])},{id:"current_fp_methods",helpText:"What method are you currently on?",type:V.TT_MULTIPLE_SELECT,init:async()=>(this.patient.isFemale()&&(this.patientHitMenopause=await this.consultation.patientHitMenopause()),!0),validation:t=>N.required(t),onValueUpdate:(t,e)=>this.disableFPMethods(t,e),computedValue:t=>({tag:"consultation",obs:t.map((t=>this.consultation.buildValueCoded("Family planning method",t.value)))}),condition:t=>this.showCurrentContraceptionMethods(t),options:(t,e)=>this.getFPMethods([],e)},{id:"fp_methods",helpText:"What method are you providing today?",type:V.TT_MULTIPLE_SELECT,condition:t=>this.showNewContraceptionMethods(t),validation:t=>N.required(t),onValueUpdate:(t,e)=>this.disableFPMethods(t,e),computedValue:t=>({tag:"consultation",obs:t.map((t=>this.consultation.buildValueCoded("Family planning, action to take",t.value)))}),options:(t,e)=>this.getFPMethods([],e)},{id:"reason_for_no_fpm",helpText:"Main reason for not using family planning methods",type:V.TT_SELECT,validation:t=>N.required(t),condition:t=>this.declinedFPM(t),computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueText("Why does the woman not use birth control",t.value)}),options:()=>this.mapStrToOptions(["Not Sexually active","Patient want to get pregnant","Not needed for medical reasons","At risk of unplanned pregnancy","Menopause","Not Interested"])},{id:"specific_reason_for_no_fpm",helpText:"Specific reason for not using family planning methods",type:V.TT_SELECT,validation:t=>N.required(t),computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueText("Reason for not using contraceptives",t.value)}),condition:t=>this.riskOfUnplannedPregnancy(t),options:()=>this.mapStrToOptions(["Following wishes of spouse","Religious reasons","Afraid of side effects","Never though about it","Indifferent (does not mind getting pregnant)"])},{id:"offer_contraceptives",helpText:"Offer contraceptives",type:V.TT_SELECT,validation:t=>N.required(t),condition:t=>this.riskOfUnplannedPregnancy(t),computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueCoded("Family planning, action to take",t.value)}),options:()=>[{label:"Accepted",value:"Yes"},{label:"Declined",value:"No"},{label:"Discuss with spouse",value:"Discuss with spouse"}]},{id:"offered_intervention",helpText:"Offered intervention",type:V.TT_MULTIPLE_SELECT,validation:t=>N.required(t),condition:t=>"Accepted"===t.offer_contraceptives.value,computedValue:t=>({tag:"consultation",obs:t.map((t=>this.consultation.buildValueCoded(t.label,t.value)))}),options:(t,e)=>this.getFPMethods(["NONE"],e)},{id:"offer_cxca",helpText:"Refer client for CxCa screening",type:V.TT_SELECT,init:async()=>{if(this.patient.isFemale()&&(this.CxCaEnabled=await q.cervicalCancerScreeningEnabled(),this.CxCaEnabled)){const{start:t,end:e}=await q.cervicalCancerScreeningAgeBounds();this.CxCaMaxAge=e,this.CxCaStartAge=t,this.DueForCxCa=await this.consultation.clientDueForCxCa(),this.clientHadAHysterectomy=await this.consultation.clientHasHadAHysterectomy()}return!0},validation:t=>N.required(t),condition:t=>this.canScreenCxCa()&&!this.isPregnant(t),computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueCoded("Offer CxCa",t.value)}),options:()=>this.yesNoOptions()},{id:"cxca_reminder",helpText:"CxCa Screening Reminder",type:V.TT_TEXT_BANNER,init:async()=>(this.CxCaEnabled&&this.patient.isFemale()&&(this.CxCaAppointDate=await this.patient.nextAppointment(24)),!0),condition:()=>30>u.dateDiffInDays(this.CxCaAppointDate,this.consultation.date),options:()=>this.mapStrToOptions([`Patient is due for Cervical Cancer Screening on ${u.toStandardHisDisplayFormat(this.CxCaAppointDate.appointment_date)}`])},{id:"reason_for_no_cxca",helpText:"Reason for NOT offering CxCa",type:V.TT_SELECT,validation:t=>N.required(t),condition:t=>"No"===t.offer_cxca.value,computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueCoded("Reason for NOT offering CxCa",t.value)}),options:()=>this.getReasonsForNoCxcaOptions()},...H({id:"previous_cxca_test_date",helpText:"Previous CxCa test",required:!0,minDate:()=>this.patient.getBirthdate(),maxDate:()=>z.getSessionDate(),condition:t=>"Not due for screening"===t.reason_for_no_cxca.value,computeValue:(t,e)=>e?{tag:"consultation",obs:this.consultation.buildValueDateEstimated("CxCa test date",t)}:{tag:"consultation",obs:this.consultation.buildValueDate("CxCa test date",t)},estimation:{allowUnknown:!0,estimationFieldType:W.MONTH_ESTIMATE_FIELD}}),{id:"previous_side_effects",helpText:"Side effects / Contraindications history",type:V.TT_DATA_TABLE,init:async()=>(this.sideEffectsHistory=await this.consultation.getDrugSideEffects(),!0),config:{columns:()=>[[B.thTxt("Date"),B.thTxt("Condition"),B.thTxt("Drug induced"),B.thTxt("Drug")]],rows:()=>Object.keys(this.sideEffectsHistory).map((t=>Object.values(this.sideEffectsHistory[t]).filter((t=>!R.isEmpty(t.name))).map((e=>[B.tdDate(t),B.td(e.name),B.td(e.drug_induced?"Yes":"No"),B.td(e.drug)])))).reduce(((t,e)=>t.concat(e)),[])}},{id:"side_effects",helpText:"Contraindications / Side effects (select either 'Yes' or 'No')",type:V.TT_MULTIPLE_YES_NO,init:async()=>(this.lastDrugsReceived=await this.consultation.getPreviousDrugs(),!0),validation:t=>this.validateSeries([()=>N.required(t),()=>N.anyEmpty(t)]),computedValue:t=>({tag:"consultation",obs:t.map((async t=>({...await this.consultation.buildValueCoded("Malawi ART side effects",t.label),child:[await this.consultation.buildValueCoded(t.label,t.value)]})))}),beforeNext:t=>this.buildSideEffectObs(t,"malawiSideEffectReasonObs"),options:(t,e)=>this.getContraindications(e)},{id:"other_side_effects",helpText:"Other Contraindications / Side effects (select either 'Yes' or 'No')",type:V.TT_MULTIPLE_YES_NO,onValue:async t=>(await this.checkIfWeightLossIsControlled(t),!0),condition:t=>this.showOtherSideEffects(t),onConditionFalse:()=>this.otherSideEffectReasonObs=[],validation:t=>this.validateSeries([()=>N.required(t),()=>N.anyEmpty(t)]),computedValue:t=>({tag:"consultation",obs:t.filter((t=>"Other (Specify)"!=t.label)).map((async t=>({...await this.consultation.buildValueCoded("Other side effect",t.label),child:[await this.consultation.buildValueCoded(t.label,t.value)]})))}),beforeNext:t=>this.buildSideEffectObs(t,"otherSideEffectReasonObs"),options:(t,e)=>this.getOtherContraindications(e)},{id:"other_side_effect_specify",helpText:"Other Contraindications / Side effects (specify)",type:V.TT_NOTE,computedValue:async t=>({tag:"consultation",obs:{...await this.consultation.buildValueCoded("Other side effect","Other (Specify)"),child:[await this.consultation.buildValueText("Other (Specify)",t.value)]}}),condition:t=>this.inArray(t.other_side_effects,(t=>"Other (Specify)"===t.label&&"Yes"===t.value)),validation:t=>N.required(t)},(()=>{const t=new ot(this.patientID);return{id:"tb_module_status",helpText:"TB Module Status",type:V.TT_SUMMARY,init:async()=>(await t.loadTbProgram(),!0),computedValue:t=>({tag:"consultation",obs:t.filter((t=>t?.other?.obs)).map((t=>t.other.obs()))}),condition:()=>t.isOnTreatment,options:()=>[{label:"TB Status",value:t.isPositive?"Positive":"Negative",other:{obs:()=>this.consultation.buildValueCoded("TB Status","Confirmed TB on treatment")}},{label:"Treatment status",value:"On Treatment",other:{obs:()=>this.consultation.buildValueCoded("TB treatment","Yes")}},{label:"Treatment start date",value:j(t.outcomeDate),other:{obs:()=>this.consultation.buildValueDate("TB treatment start date",t.outcomeDate)}},{label:"Treatment period in months",value:t.maxPeriodOnTreatment,other:{obs:()=>this.consultation.buildValueNumber("TB treatment period",t.maxPeriodOnTreatment)}}]}})(),{id:"on_tb_treatment",helpText:"On TB Treatment?",type:V.TT_SELECT,validation:t=>N.required(t),computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueCoded("TB treatment",t.value)}),condition:t=>!t.tb_module_status,options:()=>this.yesNoOptions()},{id:"tb_side_effects",helpText:"TB Associated symptoms",type:V.TT_MULTIPLE_YES_NO,onValue:async t=>(await this.checkIfWeightLossIsControlled(t),!0),validation:t=>this.validateSeries([()=>N.required(t),()=>N.anyEmpty(t)]),condition:t=>t.on_tb_treatment?.value.match(/no/i),options:(t,e)=>this.getTBSymptoms(e),computedValue:t=>({tag:"consultation",obs:t.map((async t=>({...await this.consultation.buildValueCoded("Routine TB Screening",t.label),child:[await this.consultation.buildValueCoded(t.label,t.value)]})))})},{id:"tb_status",helpText:"TB Status",type:V.TT_SELECT,validation:t=>N.required(t),condition:t=>this.hasTBSymptoms(t),onConditionFalse:()=>this.TBSuspected=!1,defaultValue:()=>"TB Suspected",options:()=>this.mapStrToOptions(["TB NOT Suspected","TB Suspected","Confirmed TB Not on treatment"])},{id:"tb_screening_testing_methods",helpText:"TB screening method used",type:V.TT_MULTIPLE_YES_NO,validation:t=>N.anyEmpty(t),condition:t=>!this.hasTBSymptoms(t)||t.tb_status?.value.toString().includes("Suspected"),options:t=>[{label:"chest x-ray",value:(t.tb_screening_testing_methods||[])[0]?.value||"",other:{values:this.yesNoOptions(),resultOptions:[{label:"Abnormal",value:"Positive"},{label:"Normal",value:"Negative"}]}},{label:"Molecular WHO Recommended Rapid Diagnostic test",value:(t.tb_screening_testing_methods||[])[1]?.value||"",other:{values:this.yesNoOptions(),resultOptions:[{label:"Positive",value:"Positive"},{label:"Negative",value:"Negative"}]}}]},{id:"tb_screening_testing_results",helpText:"TB screening result",type:V.TT_MULTIPLE_YES_NO,validation:t=>N.required(t),condition:t=>t.tb_screening_testing_methods.some((t=>"Yes"===t.value)),options:t=>t.tb_screening_testing_methods.filter((t=>"Yes"===t.value)).map((e=>({value:((t.tb_screening_testing_results||[]).find((t=>t.label===e.label))||[])?.value||"",label:e.label,other:{values:e.other.resultOptions}}))),computedValue:t=>({tag:"consultation",obs:t.map((async t=>({...await this.consultation.buildValueCoded("TB screening method used",t.label),child:[await this.consultation.buildValueCoded(t.label,t.value)]})))})},{id:"start_tb_treatment",helpText:"Start TB Treatment?",type:V.TT_SELECT,validation:t=>N.required(t),computedValue:async t=>({tag:"consultation",obs:[await this.consultation.buildValueCoded("TB treatment",t.value),this.consultation.buildValueDate("TB treatment start date",this.consultation.date)]}),condition:t=>this.isTBPositive(t),options:()=>this.yesNoOptions(),beforeNext:async t=>("No"===t.value&&await $("TB Treatment Not Initiated","Patient has tested positive for TB but treatment has not been started","TB treatment should be initiated as soon as possible for optimal patient outcomes",[{name:"Continue",color:"primary",slot:"start"}]),!0)},{id:"tb_date_started_treatment_known",helpText:"TB treatment history",type:V.TT_YES_NO,init:async()=>{this.hasTbTreatmentDate=!1;const t=await z.getFirstValueDatetime(this.patientID,"TB treatment start date"),e=await z.getFirstValueNumber(this.patientID,"TB treatment period");if(e&&t){const i=G(this.consultation.date).diff(t,"months");this.hasTbTreatmentDate=i<=e}return!0},validation:t=>N.required(t),condition:t=>!this.hasTbTreatmentDate&&"Yes"===t.on_tb_treatment.label,options:()=>[{label:"Date started treatment known?",values:this.yesNoOptions()}]},...H({id:"tb_start_date",helpText:"Enter start date for treatment?",required:!0,minDate:()=>this.patient.getBirthdate(),maxDate:()=>z.getSessionDate(),condition:t=>"Yes"===t.tb_date_started_treatment_known,computeValue:t=>({tag:"consultation",obs:this.consultation.buildValueDate("TB treatment start date",t)}),estimation:{allowUnknown:!1}}),{id:"tb_treatment_period",helpText:"Enter Full TB Treatment Period (In Months)",type:V.TT_NUMBER,validation:t=>N.validateSeries([()=>N.required(t),()=>N.isNumber(t),()=>N.rangeOf(t,3,9)]),condition:t=>"Yes"===t.tb_date_started_treatment_known||"Yes"===t.start_tb_treatment.label,computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueNumber("TB treatment period",t.value)})},{id:"routine_tb_therapy",helpText:"TB preventive therapy (TPT) history",type:V.TT_SELECT,init:async()=>(this.hasTbHistoryObs=await this.consultation.hasTreatmentHistoryObs(),!0),validation:t=>N.required(t),condition:()=>!this.hasTbHistoryObs,computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueText("Previous TB treatment history",t.value)}),options:t=>{let e=[];return/no/i.test(`${t.on_tb_treatment?.value}`)&&(e=["Currently on IPT","Currently on 3HP (RFP + INH)","Currently on INH 300 / RFP 300 (3HP)"]),e=e.concat(["Complete course of 3HP in the past (3 months RFP+INH)","Complete course of IPT in the past (min. 6 months of INH)","Aborted course of 3HP (RFP + INH) in the past","Aborted course of INH 300 / RFP 300 (3HP) in the past","Aborted course of IPT in the past","Never taken IPT or 3HP"]),this.mapStrToOptions(e)}},...H({id:"date_started_tpt",helpText:"Started TPT Treatment",required:!0,minDate:()=>this.patient.getBirthdate(),maxDate:()=>z.getSessionDate(),condition:t=>t.routine_tb_therapy.value.match(/currently/i),computeValue:t=>t,estimation:{allowUnknown:!0,estimationFieldType:W.MONTH_ESTIMATE_FIELD}}),{id:"tpt_drugs_received",helpText:"TPT Drugs Received",required:!0,condition:t=>t.routine_tb_therapy.value.match(/currently/i),type:V.TT_ADHERENCE_INPUT,options:t=>this.getTptDrugs(t),computedValue:(t,e,i)=>({tag:"consultation",obs:t.map((async t=>this.consultation.buildObs("TPT Drugs Received",{value_drug:t?.other?.drug_id||0,value_datetime:i?.date_started_tpt||null,value_numeric:t?.value||0})))}),config:{titles:{label:"Drug name",value:"Tablets received"}}},{id:"tpt_tranfer_from",helpText:"Facility client is transferring in from",type:V.TT_SELECT,computedValue:({label:t})=>({tag:"consultation",obs:this.consultation.buildValueText("Location TPT last received",t)}),validation:t=>N.required(t),condition:t=>t.routine_tb_therapy.value.match(/currently/i),options:(t,e="")=>F(e),config:{showKeyboard:!0,isFilterDataViaApi:!0}},{id:"allergic_to_sulphur",helpText:"Allergic to Cotrimoxazole",type:V.TT_SELECT,validation:t=>N.required(t),computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueCoded("Allergic to sulphur",t.value)}),beforeNext:t=>(this.isAllergicToSulphur(t),!0),options:()=>this.yesNoUnknownOptions()},...this.getAdherenceFields(!0),{id:"refer_to_clinician",helpText:"Refer to clinician",type:V.TT_SELECT,condition:()=>A.isNurse(),validation:t=>N.required(t),computedValue:t=>({tag:"consultation",obs:this.consultation.buildValueCoded("Refer to clinician",t.value)}),options:()=>this.yesNoOptions()},{id:"medication_to_prescribe",proxyID:"prescription",helpText:"Medication to prescribe during this visit",type:V.TT_MULTIPLE_SELECT,init:async()=>(this.isNoneClientPatient||(this.currentWeight=Number(await this.patient.getRecentWeight()),this.autoSelect3HP=await Y.get("ART_AUTO_3HP_SELECTION"),this.tptStatus=await this.consultation.getTptTreatmentStatus()),!0),beforeNext:async(t,e)=>{if(!Object.keys(this.reasonForDecliningTPTObs).length&&!this.isBreastFeeding(e)&&this.isEligibleForTpt&&!this.patientOnTpt(e)&&!t.some((t=>/3hp|ipt/i.test(t.label)))){if(!(await k("Are you sure you want to proceed without prescribing TPT?")))return this.reasonForDecliningTPTObs={},!1;{const t=await L("Reasons for declining TPT","",["Patient declined","Side-effects (previous or current)","Stock-out","Starting TB treatment","Heavy alcohol use","Hepatic conditions (active hepatitis or liver damage)","Severe/moderate peripheral neuropathy","Hypersensitivity to INH, Rifapentine, or Rifampicin","Other"],[{name:"Done",slot:"start",role:"action"}]);this.reasonForDecliningTPTObs=this.consultation.buildValueText("Other reason for not seeking services",t.selection)}}return!0},condition:t=>!t.refer_to_clinician||`${t.refer_to_clinician.value}`.match(/no/i),validation:t=>N.required(t),computedValue:t=>({tag:"consultation",obs:this.buildMedicationOrders(t)}),onValueUpdate:(t,e)=>{const i=this.disablePrescriptions(t,e);return this.on3HPValueUpdate(i,e)},options:async(t,e,i,a)=>(await this.initExtraDtgCheck(t),this.medicationOrderOptions(t,a)),config:{footerBtns:[{name:"Update allergic to CPT",onClickComponentEvents:{refreshOptions:(t,e,i)=>(this.allergicToSulphur="Allergic"===t.btnOutput,this.medicationOrderOptions(i,e))},onClick:()=>$("Allergic to Cotrimoxazole update","Is the patient allergic to cotrimoxazole.","",[{name:"Allergic",slot:"start",color:"success"},{name:"NOT Allergic",slot:"end"}])}]}}]}}});t("default",c(mt,[["render",function(t,e,i,a,n,s){const o=g("his-standard-form");return v(),w(o,{fields:t.fields,onFinishAction:t.onFinish,skipSummary:!0,cancelDestinationPath:t.cancelDestination},null,8,["fields","onFinishAction","cancelDestinationPath"])}]]))}}}));
