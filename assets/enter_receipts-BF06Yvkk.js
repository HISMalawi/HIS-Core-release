import{S as g,d as f,U as _,q as b,F as c,V as u,bo as v,ae as p,t as h,cB as y,H as T,cH as D,_ as S,r as F,o as E,c as x}from"./index-C-Wf7IuL.js";import{H as A}from"./HisStandardForm-zCup__or.js";class m extends g{constructor(){super()}static getDrugs(t={}){return super.getJson("/drug_cms",t)}static search(t=""){return super.getJson("/drug_cms/search",{keyword:t})}}const B=f({components:{HisStandardForm:A},data:()=>({activeField:"",fields:[],drugs:[],selectedDrugs:[],barcode:"",stockService:{}}),methods:{async onFinish(e){const t=this.prepDrugs(e);await this.stockService.postItems(t)?(_("Stock succesfully added"),this.$router.push("/")):b("Could not save stock")},getFields(){return[{id:"transfer_origination",helpText:"Select where stock came from",type:c.TT_SELECT,validation:e=>u.required(e),options:()=>[{label:"DHA",value:"DHA"},{label:"Other location",value:"Other location"}]},{id:"transfer_location",helpText:"Location",type:c.TT_SELECT,validation:e=>u.required(e),condition:e=>e.transfer_origination.value==="Other location",options:(e,t="")=>v(t),computedValue:e=>e.label,config:{showKeyboard:!0,isFilterDataViaApi:!0}},{id:"barcode",helpText:"Scan barcode",type:c.TT_BARCODE,config:{hiddenFooterBtns:["Clear","Next"]},onValue:async e=>{this.barcode=e,this.activeField="select drugs"},condition:e=>e.transfer_origination.value==="DHA"},{id:"select drugs",helpText:"Select drugs",type:c.TT_INFINITE_SCROLL_MULTIPLE_SELECT,requireNext:!0,validation:e=>u.required(e),options:async(e,t="a")=>{const o=await m.search(t||"a");return this.drugs=this.formatDrugs(o),this.drugs},unload:e=>this.selectedDrugs=e,config:{showKeyboard:!0,isFilterDataViaApi:!0,footerBtns:[{name:"Select all",slot:"end",onClick:async()=>{const e=await m.getDrugs({pagenate:!1});this.drugs=this.formatDrugs(e),this.selectAll(this.drugs)}}]}},{id:"date",helpText:"Delivery Date",type:c.TT_FULL_DATE,validation:e=>u.required(e)},{id:"enter_batches",helpText:"Batch entry",type:c.TT_BATCH_ENTRY,options:()=>this.selectedDrugs,beforeNext:(e,t,o,{currentFieldContext:n})=>{const s=i=>i.map(a=>"".concat(a.label)).join(" & "),r=n.drugs.filter(i=>i.entries.map(a=>!a.tins&&!a.expiry&&!a.batchNumber&&!a.tabs).every(Boolean)),d=n.drugs.filter(i=>i.entries.map(a=>{let l=0;return a.tins&&(l+=1),a.expiry&&(l+=1),a.batchNumber&&(l+=1),a.tabs&&(l+=1),l>=1&&l<=3}).some(Boolean));if(!p.isEmpty(d)){const i=s(d);return h("Please fix partial batch entries for drugs: ".concat(i)),!1}if(!p.isEmpty(r)){const i=s(r);return h("The following drug batches are empty: ".concat(i)),!1}return!0},validation:e=>u.required(e),config:{entryDate:e=>e.date.value}},{id:"summary",helpText:"Summary",type:c.TT_TABLE_VIEWER,options:e=>this.buildResults(e.enter_batches),config:{hiddenFooterBtns:["Clear"]}}]},buildResults(e){const t=["Drug","Amount per unit","Tins/Pallets","Expiry date","Batch number"],o=e.map(n=>{const s=n.value;return[s.short_name,s.tabs,y(s.tins),T.toStandardHisDisplayFormat(s.expiry),s.batchNumber]});return[{label:"Confirm entry",value:"Table",other:{columns:t,rows:o}}]},prepDrugs(e){const t=[],o=this.barcode,n=e.transfer_origination.value==="DHA"?null:e.transfer_location.value;return e.enter_batches.forEach(s=>{const r=s.value;t.push({batch_number:r.batchNumber,location_id:n,items:[{barcode:o,drug_id:r.drug_inventory_id,expiry_date:r.expiry,quantity:parseInt(r.tabs)*parseInt(r.tins),delivery_date:e.date.value,product_code:r.code,pack_size:r.tabs}]})}),t},selectAll(e){return e.map(t=>(t.isChecked=!0,t))},formatDrugs(e){return e.map(t=>({label:"".concat(t.short_name," (").concat(t.code,")"),value:t}))}},created(){this.stockService=new D,this.fields=this.getFields()}});function C(e,t,o,n,s,r){const d=F("his-standard-form");return E(),x(d,{fields:e.fields,activeField:e.activeField,onFinishAction:e.onFinish,skipSummary:!0,onOnIndex:t[0]||(t[0]=i=>e.activeField="")},null,8,["fields","activeField","onFinishAction"])}const L=S(B,[["render",C]]);export{L as default};
