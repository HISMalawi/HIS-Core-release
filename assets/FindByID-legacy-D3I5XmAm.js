System.register(["./dynamic-import-helper-legacy-DYK5bIOV.js","./HisStandardForm-legacy-DMJkhfrq.js","./index-legacy-X--GYU37.js","./overlays-04a9a43f-legacy-lkJ5ZVky.js","./TouchScreenForm-legacy-C_f8Ho2H.js","./ToolbarMediumCard-legacy-CdhT4OJW.js","./Transformers-legacy-DhNYVLaS.js","./ViewPort-legacy-1het9QhE.js"],(function(e,t){"use strict";var i,n,a,r,s,l,d,o,p,u,c,h,g,m,f,y;return{setters:[e=>{i=e.F},e=>{n=e.H},e=>{a=e.d,r=e.V,s=e.G,l=e.L,d=e.P,o=e.aJ,p=e.aI,u=e.ab,c=e.t,h=e._,g=e.r,m=e.o,f=e.c},e=>{y=e.l},null,null,null,null],execute:function(){const t=a({components:{HisStandardForm:n},data:()=>({app:{},fields:[],fieldComponent:"",people:[],patient:{},assignNewARVNumber:!1,suggestedARVNumber:""}),created(){this.setApp(),this.fields=[this.getIdSelectionField(),this.getIdSearchField(),this.getARVDuplicatesField(),this.getReassignARVNumberField()]},methods:{getIdSelectionField(){return{id:"identifier_type",helpText:"Select identifier type",type:i.TT_SELECT,requireNext:!1,validation:e=>r.required(e),options:async()=>{const e=this.app.programPatientIdentifiers?Object.values(this.app.programPatientIdentifiers):[],t=await Promise.all(e.map((async e=>"function"==typeof e.visible?await e.visible():!e.globalPropertySetting||await s.isProp(e.globalPropertySetting))));return e.filter(((e,i)=>e.useForSearch&&t[i])).map((e=>({label:e.name,value:e.id,other:e})))}}},getIdSearchField:()=>({id:"identifier",helpText:"Identifier",dynamicHelpText:e=>`Search by ${e.identifier_type.label}`,type:i.TT_TEXT,validation:(e,t)=>r.validateSeries([()=>r.required(e),()=>"function"==typeof t.identifier_type.other?.validation?t.identifier_type.other.validation(e):null]),config:{casing:"uppercase",initialKb:e=>e.identifier_type.other?.keyboardName||"0-9",prependValue:e=>e.identifier_type.other?.prefix()||""}}),getARVDuplicatesField(){return{id:"arv_duplicates",helpText:"Duplicates",dynamicHelpText:e=>`Duplicate patients with identifer ${e.identifier.value}`,type:i.TT_DATA_TABLE,requireNext:!1,condition:async e=>await this.hasDuplicates(e)&&"ARV Number"===e.identifier_type.label,config:{hiddenFooterBtns:["Clear","Finish"],columns:()=>[[l.thTxt("First Name"),l.thTxt("Family Name"),l.thTxt("Gender"),l.thDate("Birthdate"),l.thTxt("Current Village"),l.thTxt("Actions",{colspan:2})]],rows:()=>this.people.map((e=>{const t=new d(e);return[l.td(t.getGivenName()),l.td(t.getFamilyName()),l.td(t.getGender()),l.tdDate(t.getBirthdate().toString()),l.td(t.getCurrentVillage()),l.tdBtn("Select patient",(()=>this.selectPatient(t.getID())),{style:{fontSize:"12px",textTransform:"none"}},"warning"),l.tdBtn("Re-assign identifier",(()=>this.reassignARVNumber(t)),{style:{fontSize:"12px",textTransform:"none"}},"danger")]}))}}},getReassignARVNumberField(){return{id:"arv_number",helpText:"ART number",type:i.TT_TEXT,computedValue:({value:e})=>e,validation:e=>r.required(e),condition:()=>"arv_number"===this.fieldComponent&&this.assignNewARVNumber,defaultValue:()=>this.suggestedARVNumber,config:{initialKb:"0-9",prependValue:e=>e.identifier_type.other.prefix()}}},setApp(){const e=o.getActiveApp();e&&(this.app=e)},async hasDuplicates(e){return this.people=await d.findByOtherID(e.identifier_type.value,e.identifier.value),this.people.length>1},selectPatient(e){this.$router.push(`/patients/confirm?person_id=${e}`)},async reassignARVNumber(e){const t=await y.create({});t.present();const i=await p.getNextSuggestedARVNumber();this.suggestedARVNumber=i.arv_number.replace(/^\D+|\s/g,""),this.patient=e,this.assignNewARVNumber=!0,this.fieldComponent="arv_number",t.dismiss()},async onFinish(e){if(u.isEmpty(this.people))c("Client not found");else if(this.assignNewARVNumber&&!u.isEmpty(this.patient))try{await this.patient.updateARVNumber(e.arv_number.value),this.selectPatient(this.patient.getID())}catch(t){c(`${t}`)}else{const e=new d(this.people[0]);this.selectPatient(e.getID())}}}});e("default",h(t,[["render",function(e,t,i,n,a,r){const s=g("his-standard-form");return m(),f(s,{fields:e.fields,onFinishAction:e.onFinish,skipSummary:!0,activeField:e.fieldComponent},null,8,["fields","onFinishAction","activeField"])}]]))}}}));
