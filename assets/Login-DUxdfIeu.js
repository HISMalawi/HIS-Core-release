import{au as Y,aj as j,d as U,av as L,aw as F,ax as q,ay as G,az as J,aA as S,aB as Q,a9 as N,O as g,aa as I,aC as X,aD as Z,ah as x,aE as ee,a6 as R,u as p,B as f,G as n,Z as m,aF as O,aG as B,E as C,C as T,H as V,aH as te,W as se,a3 as oe,S as ae,a1 as ne,a5 as ie,Q as re,R as le,U as ue,a4 as de,X as pe,Y as ce,r as P,aI as fe,ap as he,aJ as me,t as ye,aK as D,aL as we,aM as ge,aN as Ie,v as $,w as r,ab as d,x as u,z as _}from"./index-CyYd6aWW.js";import{p as _e}from"./main-D7g93A5K.js";const E=Y("IndexedDBStorage"),ve=[{key:"villages",endpoint:"villages"},{key:"traditional_authorities",endpoint:"traditional_authorities"},{key:"districts",endpoint:"districts"},{key:"regions",endpoint:"regions"},{key:"locations",endpoint:"locations"}];async function be(){for(const t of ve)if(!await E.existsinStorage(t.key))try{const e=await j.getJson(t.endpoint,{paginate:!1});E.saveToStorage(t.key,e)}catch(e){console.warn("Issue loading/saving metadata ".concat(t,": ").concat(e))}}const ke=U({props:{useVirtualInput:{type:Boolean}},data:function(){return{keyboard:L,auth:{},userInput:{type:String,username:"",password:""},focusInput:{type:Object,value:"",id:""},display:"none",keyboardTop:"",btnCaption:"",Caps:{type:Boolean,on:!1}}},created(){this.auth=new F,q.clearScreenTimeout()},setup(){const{facilityName:t,district:e}=ee();return{facilityName:t,district:e}},methods:{renderKeyBoard(t){this.focusInput=t.currentTarget,this.focusInput.id=="password"?this.btnCaption="Login":this.btnCaption="Next";let e=t.currentTarget.getBoundingClientRect().top;e=parseInt(e),this.keyboardTop=e+20+"px;",this.display="table",window.scrollTo(0,9999)},keyPress(t){const e=t.currentTarget.id;let o;try{e.match(/@#/i)?this.keyboard=G:e.match(/qwerty/i)?this.keyboard=L:e.match(/Del/i)?this.focusInput.value=this.focusInput.value.substring(0,this.focusInput.value.length-1):e.match(/Next/i)?(this.display="none",o=this.$refs.password,o.click()):e.match(/Login/i)?(this.display="none",this.doLogin()):e.match(/Caps/i)?(this.Caps.on=!this.Caps.on,this.display="none",this.focusInput.id==="username"?o=this.$refs.username:o=this.$refs.password,o.click()):e.match(/Hide/i)?this.display="none":this.focusInput.value+=e,this.focusInput.id=="username"?this.userInput.username=this.focusInput.value:this.userInput.password=this.focusInput.value}catch(a){console.warn("input error")}},isStrongPassword(){},doLogin:async function(){if(this.userInput.username&&this.userInput.password){this.auth.setUsername(this.userInput.username);try{if(this.auth.versionLockingIsEnabled()&&await this.auth.validateIfCorrectAPIVersion(),!await this.auth.checkTimeIntegrity())throw"Local date does not match API date. Please Update your device's date";await this.auth.login(this.userInput.password),this.auth.startSession(),J.value=!1,(await S.create({message:"Loading metadata, this may take a while...",backdropDismiss:!1})).present(),await be(),S.getTop().then(o=>o&&S.dismiss());const t=await Promise.all([this.auth.passwordPolicyEnabled(),this.auth.passwordExpired()]),e=(()=>{let o=0;const a=_e(this.userInput.password);return o+=a.score,/^(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>])/i.test(this.userInput.password)&&(o+=2),o<3})();if(e||t.every(Boolean)){const o=a=>"".concat(a.value).toLowerCase();return Q([{id:"new_password",proxyID:"password",helpText:"Change your password",type:N.TT_PASSWORD,init:()=>(setTimeout(()=>{e?g("Your password is weak, please change it below"):g("Your password has expired, please change it below",6e3)},500),!0),computedValue:a=>o(a),validation:a=>I.validateSeries([()=>I.required(a),()=>I.hasLengthRangeOf(a,4,15),()=>{if("".concat(this.userInput.password).toLowerCase()===o(a))return["New password should not match old password"]}]),config:{inputType:"password"}},{id:"verify_password",proxyID:"password",helpText:"Confirm Password",type:N.TT_PASSWORD,computedValue:a=>o(a),validation:(a,c)=>I.validateSeries([()=>I.required(a),()=>{if(o(c.verify_password)!=o(c.new_password))return["New password does not match current password"]}]),config:{inputType:"password"}}],{onFinish:async(a,c)=>{await X.updateUser(this.auth.userID,c)?(await this.auth.resetUserPasswordChangeCheck(),this.$router.push("/select_hc_location")):g("Unable to update user")}})}this.$router.push("/select_hc_location")}catch(t){t instanceof Z?g("Invalid username or password"):x("Unable to login. Please contact your local administrator for assistance",5e4)}}else g("Complete form to log in")}},computed:{btnStyles(){return"display: ".concat(this.display,"; top: ").concat(this.keyboardTop,";")}}}),Ce={class:"main",ref:"main"},Se={class:"cells ion-padding-bottom"},Pe={style:{color:"#cd853f"}},$e={class:"rows"},Te={class:"cells"},Ve=["readonly"],Ae={class:"rows input-rows"},Le={class:"cells"},Ne=["readonly"],Oe={class:"rows"},Be=["id"],De=["id"];function Ee(t,e,o,a,c,y){return p(),f(C,null,[n("div",Ce,[n("div",Se,[n("h3",null,[e[6]||(e[6]=n("b",{style:{color:"#8b4513"}},"Facility: ",-1)),n("b",Pe,m(t.facilityName)+" ("+m(t.district)+")",1)])]),n("div",$e,[n("div",Te,[O(n("input",{type:"text",name:"usename",autocomplete:"off",placeholder:"Username",id:"username",ref:"username","onUpdate:modelValue":e[0]||(e[0]=i=>t.userInput.username=i),onClick:e[1]||(e[1]=i=>t.renderKeyBoard(i)),class:"input-boxes",readonly:t.useVirtualInput},null,8,Ve),[[B,t.userInput.username]])])]),n("div",Ae,[n("div",Le,[O(n("input",{"onUpdate:modelValue":e[2]||(e[2]=i=>t.userInput.password=i),type:"password",name:"password",ref:"password",id:"password",onClick:e[3]||(e[3]=i=>t.renderKeyBoard(i)),class:"input-boxes",placeholder:"Password",readonly:t.useVirtualInput},null,8,Ne),[[B,t.userInput.password]])])])],512),n("div",{id:"keyboard",style:te(t.btnStyles),class:"keyboard"},[(p(!0),f(C,null,T(t.keyboard,(i,h)=>(p(),f("span",{key:h},[n("div",Oe,[(p(!0),f(C,null,T(i,s=>(p(),f("div",{class:"cells",key:s},[s==="Next"||s==="Login"?(p(),f("button",{key:0,id:t.btnCaption,class:"keyboard-btn login-btn",onClick:e[4]||(e[4]=l=>t.keyPress(l))},m(t.btnCaption),9,Be)):V("",!0),s!="Login"&&s!="Next"?(p(),f("button",{key:1,id:t.Caps.on?s.toUpperCase():s.toLowerCase(),class:"keyboard-btn",onClick:e[5]||(e[5]=l=>t.keyPress(l))},m(s==="Del."||s==="Caps"?s:t.Caps.on?s.toUpperCase():s.toLowerCase()),9,De)):V("",!0)]))),128))])]))),128))],4)],64)}const Ue=R(ke,[["render",Ee],["__scopeId","data-v-df99edeb"]]),Fe=U({components:{IonItem:se,Inputs:Ue,IonButton:oe,IonTitle:ae,IonLabel:ne,IonPage:ie,IonHeader:re,IonToolbar:le,IonContent:ue,IonFooter:de,IonSelect:pe,IonSelectOption:ce},setup(){const t=P([]),e=async()=>{const s=await we("Application Selection","Please specify the application you wish to use",t.value.map(l=>l.name),[{name:"Cancel",color:"danger",slot:"start"},{name:"Confirm",color:"primary",slot:"end",role:"action"}]);if(s.selection&&s.action!="Cancel"){const l=t.value.find(w=>w.name===s.selection);window.open("".concat(l.protocol||"http","://").concat(l.IP,":").concat(l.port||80),"_blank")}},{activePlatformProfile:o,platformProfiles:a}=fe(),c=P(""),y=P(""),i=he(()=>o.value.keyboard===ge.HIS_KEYBOARD_ONLY),h=Object.keys(a.value).map(s=>({label:s,value:{profileName:s,...a.value[s]}}));return me(y,s=>{o.value=(Ie.find(h,{label:s})||{}).value}),ye(async()=>{var v,b;const s=new F;t.value=((v=await s.loadConfig())==null?void 0:v.otherApps)||[];const l=s.getHeadVersion();s.setActiveVersion(l);const w=await s.getApiVersion();c.value="".concat(l," / ").concat(w),y.value=((b=o.value)==null?void 0:b.profileName)||""}),{version:c,profile:y,otherApps:t,deviceProfiles:h,useVirtualInputOnly:i,activePlatformProfile:o,coatImg:D("login-logos/Malawi-Coat_of_arms_of_arms.png"),pepfarImg:D("login-logos/PEPFAR.png"),showConfig:localStorage.getItem("useLocalStorage")==="true",openSelect:e}}}),Re={slot:"start"},Me=["src"],He=["src"];function Ke(t,e,o,a,c,y){const i=d("ion-label"),h=d("ion-title"),s=d("ion-toolbar"),l=d("ion-header"),w=d("inputs"),v=d("ion-content"),b=d("ion-select-option"),M=d("ion-select"),A=d("ion-button"),H=d("ion-item"),K=d("ion-footer"),z=d("ion-page");return p(),$(z,null,{default:r(()=>[u(l,null,{default:r(()=>[u(s,null,{default:r(()=>[u(h,null,{default:r(()=>[u(i,{style:{fontWeight:"bolder",fontSize:"1.9em"}},{default:r(()=>e[1]||(e[1]=[n("b",{style:{color:"#8b4513"}},"National ",-1),n("b",{style:{color:"#cd853f"}},"EMR",-1)])),_:1})]),_:1}),u(i,{class:"ion-padding",slot:"end"},{default:r(()=>[e[2]||(e[2]=_(" Version: ")),n("b",null,m(t.version),1)]),_:1})]),_:1})]),_:1}),u(v,{fullscreen:!1,style:{width:"100%"}},{default:r(()=>[u(w,{useVirtualInput:t.useVirtualInputOnly},null,8,["useVirtualInput"])]),_:1}),u(K,null,{default:r(()=>[u(s,null,{default:r(()=>[n("span",Re,[n("img",{id:"coat",src:t.coatImg,alt:"Malawi Coat of Arms logo"},null,8,Me),n("img",{id:"pepfar",src:t.pepfarImg,alt:"PEPFAR logo"},null,8,He)]),u(H,{class:"his-sm-text",style:{width:"75%"},slot:"end"},{default:r(()=>[u(i,null,{default:r(()=>e[3]||(e[3]=[_("Device Profile")])),_:1}),u(M,{modelValue:t.profile,"onUpdate:modelValue":e[0]||(e[0]=k=>t.profile=k),value:t.profile},{default:r(()=>[(p(!0),f(C,null,T(t.deviceProfiles,(k,W)=>(p(),$(b,{key:W,value:k.label},{default:r(()=>[_(m(k.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue","value"]),u(A,{color:"dark",fill:"outline",size:"large",slot:"end","router-link":"/settings/host"},{default:r(()=>e[4]||(e[4]=[_(" Network ")])),_:1}),t.otherApps.length?(p(),$(A,{key:0,color:"dark",fill:"outline",size:"large",slot:"end",onClick:t.openSelect},{default:r(()=>e[5]||(e[5]=[_(" Other Applications ")])),_:1},8,["onClick"])):V("",!0)]),_:1})]),_:1})]),_:1})]),_:1})}const Ye=R(Fe,[["render",Ke],["__scopeId","data-v-f474746d"]]);export{Ye as default};
