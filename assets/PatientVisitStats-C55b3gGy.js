import{d as T,dj as O,I as G,X as $,Z as B,Y as F,_ as R,a9 as I,a8 as j,bW as E,dk as H,bs as y,al as _,as as s,aN as z,au as k,aa as M,E as L,c as D,M as v,w as l,J as q,af as d,a as P,b as p,C as f,K as c,a2 as g,cx as w}from"./index-CMZASHAR.js";import{H as x}from"./HisStandardForm-BCjM4-bc.js";import{_ as J}from"./ReportMixin.vue_vue_type_script_lang-CqLvuQmv.js";import"./BasicReportTemplate-CbJ_oMga.js";import"./Export-CpyT9Gk1.js";import"./index-_zuoFVCp.js";import"./Pagination-D_B_LriE.js";const K=T({components:{ApexChart:O,IonPage:G,IonHeader:$,IonTitle:B,IonToolbar:F,IonContent:R,IonFooter:I,IonButton:j,ViewPort:E,HisStandardForm:x},mixins:[J],data:()=>({patients:{},reportData:{},chartType:"area",height:"100%",width:"100%",canShowReport:!1,report:{},series:[],patientPresent:{},guardianPresent:{},bothPresent:{},chartOptions:{title:{text:"HIV Reception encounters"},yaxis:{title:{text:"Number of clients"},plotAreaHeight:800},xaxis:{type:"datetime"},markers:{size:8,hover:{sizeOffset:3}}}}),created(){this.fields=this.getDateDurationFields()},computed:{totalAttendance(){let e=[];return Object.keys(this.reportData).forEach(t=>{e=e.concat(Object.keys(this.reportData[t]).map(r=>({patient_id:r,date:t})))}),e},totalPatientVisits(){return Object.keys(this.patientPresent).reduce((e,t)=>e.concat(this.patientPresent[t].map(r=>({patient_id:r,date:t}))),[])},totalGuardianVisits(){return Object.keys(this.guardianPresent).reduce((e,t)=>e.concat(this.guardianPresent[t].map(r=>({patient_id:r,date:t}))),[])}},methods:{async onPeriod(e,t){await this.presentLoading(),this.reportData={},this.canShowReport=!0,this.patientPresent={},this.guardianPresent={},this.report=new H,this.report.setStartDate(t.start_date),this.report.setEndDate(t.end_date),this.reportData=await this.report.getPatientVisitTypes(),this.series=this.buildSeries(this.reportData),y.dismiss()},async presentLoading(){(await y.create({message:"Please wait...",backdropDismiss:!1})).present()},async getCachedPatient(e){if(!(e in this.patients)){const t=await _.findByID(e);this.patients[e]=new _(t)}return this.patients[e]},async drillPatients(e,t){const r=[[s.thTxt("ARV Number"),s.thTxt("First name"),s.thTxt("Last name"),s.thTxt("Gender"),s.thTxt("Visit date"),s.thTxt("Action")]],h=async o=>{const a=o.map(async n=>{const i=await this.getCachedPatient(n.patient_id);try{return[this.tdARV(i.getArvNumber()),s.td(i.getGivenName()),s.td(i.getFamilyName()),s.td(this.formatGender(i.getGender())),s.tdDate(n.date),s.tdBtn("Show",async()=>{await k.dismiss({}),this.$router.push({path:"/patient/dashboard/".concat(n.patient_id)})})]}catch(m){return[s.td("N/A"),s.td("N/A"),s.td("N/A"),s.td("N/A"),s.td("N/A"),s.tdBtn("Show",async()=>{await k.dismiss({}),this.$router.push({path:"/patient/dashboard/".concat(n.patient_id)})})]}});return Promise.all(a)};this.drilldownData(e,r,t,h)},onPointSelection(e,t,{dataPointIndex:r,seriesIndex:h}){try{const o=h<=0?0:h,a=this.series[o].data[r],n=this.series[o].raw[r],i=Array.from({length:n.length},(m,u)=>({patient_id:n[u],date:new Date(a[0]).toISOString()}));this.drillPatients("Point selection",i)}catch(o){console.log("Error loading point selection data")}},buildSeries(e){const t=z.uniq(Object.keys(e)),r=(a,n,i)=>{a in n||(n[a]=[]);const m=Object.entries(e[a]).filter(([,u])=>i(u.patient_present,u.guardian_present)).map(([u])=>u);return n[a]=[...n[a],...m],n},h=a=>t.map(n=>[new Date(n).getTime(),a[n].length]),o=a=>t.map(n=>a[n]);for(const a in e)r(a,this.patientPresent,(n,i)=>n&&!i),r(a,this.guardianPresent,(n,i)=>!n&&i),r(a,this.bothPresent,(n,i)=>n&&i);return[{name:"Patient present",raw:o(this.patientPresent),data:h(this.patientPresent)},{name:"Guardian present",raw:o(this.guardianPresent),data:h(this.guardianPresent)},{name:"Both patient and guardian present",raw:o(this.bothPresent),data:h(this.bothPresent)}]}}}),W={class:"view-port-content"};function X(e,t,r,h,o,a){const n=d("his-standard-form"),i=d("ion-title"),m=d("ion-toolbar"),u=d("ion-header"),S=d("ApexChart"),C=d("view-port"),A=d("ion-content"),b=d("ion-button"),V=d("ion-footer"),N=d("ion-page");return P(),L(q,null,[e.canShowReport?v("",!0):(P(),D(n,{key:0,onOnFinish:e.onPeriod,skipSummary:!0,fields:e.fields},null,8,["onOnFinish","fields"])),e.canShowReport?(P(),D(N,{key:1},{default:l(()=>[p(u,null,{default:l(()=>[p(m,null,{default:l(()=>[p(i,null,{default:l(()=>[t[4]||(t[4]=f(" Total Attendance: ")),c("a",{href:"#",onClick:t[0]||(t[0]=w(()=>e.drillPatients("Total attendance",e.totalAttendance),["prevent"]))},g(e.totalAttendance.length),1),t[5]||(t[5]=c("br",null,null,-1)),t[6]||(t[6]=f(" Patient visit: ")),c("a",{href:"#",onClick:t[1]||(t[1]=w(()=>e.drillPatients("Total patient visits",e.totalPatientVisits),["prevent"]))},g(e.totalPatientVisits.length),1),t[7]||(t[7]=c("br",null,null,-1)),t[8]||(t[8]=f(" Guardian visit: ")),c("a",{href:"#",onClick:t[2]||(t[2]=w(()=>e.drillPatients("Guardian visits",e.totalGuardianVisits),["prevent"]))},g(e.totalGuardianVisits.length),1)]),_:1})]),_:1})]),_:1}),p(A,null,{default:l(()=>[p(C,null,{default:l(()=>[c("div",W,[p(S,{width:e.width,height:e.height,type:e.chartType,options:e.chartOptions,series:e.series,onMarkerClick:e.onPointSelection},null,8,["width","height","type","options","series","onMarkerClick"])])]),_:1})]),_:1}),p(V,null,{default:l(()=>[p(m,{color:"dark"},{default:l(()=>[p(b,{onClick:t[3]||(t[3]=Y=>e.canShowReport=!1),slot:"start",size:"large"},{default:l(()=>t[9]||(t[9]=[f(" New Date ")])),_:1}),p(b,{slot:"end",size:"large","router-link":"/",color:"success"},{default:l(()=>t[10]||(t[10]=[f(" Finish ")])),_:1})]),_:1})]),_:1})]),_:1})):v("",!0)],64)}const st=M(K,[["render",X],["__scopeId","data-v-a93c0f70"]]);export{st as default};
