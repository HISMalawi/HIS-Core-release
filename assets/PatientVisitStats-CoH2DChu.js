import{d as O,co as G,I,j as F,k as $,i as B,l as R,m as j,f as z,cp as E,aN as b,P as y,L as i,ab as H,O as k,_ as L,r as l,o as _,x as M,c as S,z as v,w as d,F as q,b as p,u as f,A as m,v as P,bq as g,a3 as x,a4 as J}from"./index-BFG-WECc.js";import{V as K}from"./ViewPort-0kHLdkku.js";import{H as Q}from"./HisStandardForm-B3aw5EdY.js";import{_ as U}from"./ReportMixin.vue_vue_type_script_lang-Ce5B9pzq.js";import"./TouchScreenForm-DiI3Xfhg.js";import"./dynamic-import-helper-Bsjrd6Ro.js";import"./ToolbarMediumCard-C3iotOe-.js";import"./Transformers-BPPLlH12.js";import"./MultiFieldDateHelper-CAg9Dfet.js";import"./KbLayouts-VRA-vjeH.js";import"./HisKbConfigurations-GhFQZvlg.js";import"./BasicReportTemplate-SATK8Q6M.js";import"./Export-CRv3Yrt4.js";import"./SIngleTouchField-OvqCQtJi.js";import"./Pagination-wn9n5xfa.js";const W=O({components:{ApexChart:G,IonPage:I,IonHeader:F,IonTitle:$,IonToolbar:B,IonContent:R,IonFooter:j,IonButton:z,ViewPort:K,HisStandardForm:Q},mixins:[U],data:()=>({patients:{},reportData:{},chartType:"area",height:"100%",width:"100%",canShowReport:!1,report:{},series:[],patientPresent:{},guardianPresent:{},bothPresent:{},chartOptions:{title:{text:"HIV Reception encounters"},yaxis:{title:{text:"Number of clients"},plotAreaHeight:800},xaxis:{type:"datetime"},markers:{size:8,hover:{sizeOffset:3}}}}),created(){this.fields=this.getDateDurationFields()},computed:{totalAttendance(){let t=[];return Object.keys(this.reportData).forEach(e=>{t=t.concat(Object.keys(this.reportData[e]).map(r=>({patient_id:r,date:e})))}),t},totalPatientVisits(){return Object.keys(this.patientPresent).reduce((t,e)=>t.concat(this.patientPresent[e].map(r=>({patient_id:r,date:e}))),[])},totalGuardianVisits(){return Object.keys(this.guardianPresent).reduce((t,e)=>t.concat(this.guardianPresent[e].map(r=>({patient_id:r,date:e}))),[])}},methods:{async onPeriod(t,e){await this.presentLoading(),this.reportData={},this.canShowReport=!0,this.patientPresent={},this.guardianPresent={},this.report=new E,this.report.setStartDate(e.start_date),this.report.setEndDate(e.end_date),this.reportData=await this.report.getPatientVisitTypes(),this.series=this.buildSeries(this.reportData),b.dismiss()},async presentLoading(){(await b.create({message:"Please wait...",backdropDismiss:!1})).present()},async getCachedPatient(t){if(!(t in this.patients)){const e=await y.findByID(t);this.patients[t]=new y(e)}return this.patients[t]},async drillPatients(t,e){const r=[[i.thTxt("ARV Number"),i.thTxt("First name"),i.thTxt("Last name"),i.thTxt("Gender"),i.thTxt("Visit date"),i.thTxt("Action")]],h=async o=>{const a=o.map(async n=>{const s=await this.getCachedPatient(n.patient_id);try{return[this.tdARV(s.getArvNumber()),i.td(s.getGivenName()),i.td(s.getFamilyName()),i.td(this.formatGender(s.getGender())),i.tdDate(n.date),i.tdBtn("Show",async()=>{await k.dismiss({}),this.$router.push({path:"/patient/dashboard/".concat(n.patient_id)})})]}catch(u){return[i.td("N/A"),i.td("N/A"),i.td("N/A"),i.td("N/A"),i.td("N/A"),i.tdBtn("Show",async()=>{await k.dismiss({}),this.$router.push({path:"/patient/dashboard/".concat(n.patient_id)})})]}});return Promise.all(a)};this.drilldownData(t,r,e,h)},onPointSelection(t,e,{dataPointIndex:r,seriesIndex:h}){try{const o=h<=0?0:h,a=this.series[o].data[r],n=this.series[o].raw[r],s=Array.from({length:n.length},(u,c)=>({patient_id:n[c],date:new Date(a[0]).toISOString()}));this.drillPatients("Point selection",s)}catch(o){console.log("Error loading point selection data")}},buildSeries(t){const e=H.uniq(Object.keys(t)),r=(a,n,s)=>{a in n||(n[a]=[]);const u=Object.entries(t[a]).filter(([,c])=>s(c.patient_present,c.guardian_present)).map(([c])=>c);return n[a]=[...n[a],...u],n},h=a=>e.map(n=>[new Date(n).getTime(),a[n].length]),o=a=>e.map(n=>a[n]);for(const a in t)r(a,this.patientPresent,(n,s)=>n&&!s),r(a,this.guardianPresent,(n,s)=>!n&&s),r(a,this.bothPresent,(n,s)=>n&&s);return[{name:"Patient present",raw:o(this.patientPresent),data:h(this.patientPresent)},{name:"Guardian present",raw:o(this.guardianPresent),data:h(this.guardianPresent)},{name:"Both patient and guardian present",raw:o(this.bothPresent),data:h(this.bothPresent)}]}}}),D=t=>(x("data-v-a93c0f70"),t=t(),J(),t),X=D(()=>m("br",null,null,-1)),Y=D(()=>m("br",null,null,-1)),Z={class:"view-port-content"};function tt(t,e,r,h,o,a){const n=l("his-standard-form"),s=l("ion-title"),u=l("ion-toolbar"),c=l("ion-header"),A=l("ApexChart"),V=l("view-port"),C=l("ion-content"),w=l("ion-button"),N=l("ion-footer"),T=l("ion-page");return _(),M(q,null,[t.canShowReport?v("",!0):(_(),S(n,{key:0,onOnFinish:t.onPeriod,skipSummary:!0,fields:t.fields},null,8,["onOnFinish","fields"])),t.canShowReport?(_(),S(T,{key:1},{default:d(()=>[p(c,null,{default:d(()=>[p(u,null,{default:d(()=>[p(s,null,{default:d(()=>[f(" Total Attendance: "),m("a",{href:"#",onClick:e[0]||(e[0]=g(()=>t.drillPatients("Total attendance",t.totalAttendance),["prevent"]))},P(t.totalAttendance.length),1),X,f(" Patient visit: "),m("a",{href:"#",onClick:e[1]||(e[1]=g(()=>t.drillPatients("Total patient visits",t.totalPatientVisits),["prevent"]))},P(t.totalPatientVisits.length),1),Y,f(" Guardian visit: "),m("a",{href:"#",onClick:e[2]||(e[2]=g(()=>t.drillPatients("Guardian visits",t.totalGuardianVisits),["prevent"]))},P(t.totalGuardianVisits.length),1)]),_:1})]),_:1})]),_:1}),p(C,null,{default:d(()=>[p(V,null,{default:d(()=>[m("div",Z,[p(A,{width:t.width,height:t.height,type:t.chartType,options:t.chartOptions,series:t.series,onMarkerClick:t.onPointSelection},null,8,["width","height","type","options","series","onMarkerClick"])])]),_:1})]),_:1}),p(N,null,{default:d(()=>[p(u,{color:"dark"},{default:d(()=>[p(w,{onClick:e[3]||(e[3]=et=>t.canShowReport=!1),slot:"start",size:"large"},{default:d(()=>[f(" New Date ")]),_:1}),p(w,{slot:"end",size:"large","router-link":"/",color:"success"},{default:d(()=>[f(" Finish ")]),_:1})]),_:1})]),_:1})]),_:1})):v("",!0)],64)}const Pt=L(W,[["render",tt],["__scopeId","data-v-a93c0f70"]]);export{Pt as default};
