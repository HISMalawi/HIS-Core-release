System.register(["./dynamic-import-helper-legacy-DYK5bIOV.js","./HisStandardForm-legacy-C7VqHmr3.js","./MultiFieldDateHelper-legacy-B97J9Bxd.js","./index-legacy--hxN_V8z.js","./PersonFieldHelper-legacy-DXv4y3LF.js","./patient_registration_service-legacy-BbK5Cpnn.js","./VoidReason-legacy-BOQg269n.js","./TouchScreenForm-legacy-DxIQwsU4.js","./ToolbarMediumCard-legacy-CzmL2SiF.js","./Transformers-legacy-DhNYVLaS.js","./ViewPort-legacy-TUlObaz7.js","./KbLayouts-legacy-BKvPSxzZ.js","./HisKbConfigurations-legacy-vrLd9Pgz.js","./LocationFieldOptions-legacy-TTrPmoN6.js","./person_service-legacy-BPtn1P_Z.js"],(function(e,t){"use strict";var i,a,n,r,s,o,d,l,h,c,u,g,m,p,_,f,y,D,F,b,R;return{setters:[e=>{i=e.F},e=>{a=e.H},e=>{n=e.g},e=>{r=e.S,s=e.d,o=e.P,d=e.t,l=e.p,h=e.H,c=e.V,u=e.a$,g=e.ab,m=e.aW,p=e.ad,_=e._,f=e.r,y=e.o,D=e.c},e=>{F=e.P},e=>{b=e.P},e=>{R=e.p},null,null,null,null,null,null,null,null],execute:function(){class t extends r{constructor(){super()}static voidRelation(e,t,i){return r.void(`people/${e}/relationships/${t}`,{reason:i})}static async amendRelation(e,i,a,n){return await t.voidRelation(e,a,"Updating guardian relationship"),t.createRelation(e,i,n)}static getRelations(){return super.getJson("types/relationships")}static createRelation(e,t,i){return super.postJson(`people/${e}/relationships`,{relationship_type_id:i,relation_id:t})}}const v=s({components:{HisStandardForm:a},data:()=>({patientData:{},guardianData:{},fieldAction:"",fieldComponent:"",fields:[],form:{},redirectURL:"",activeField:"",currentAddressAttributes:["current_region","current_district","current_village","current_traditional_authority"],homeAddressAttributes:["home_region","home_district","home_traditional_authority","home_village"]}),watch:{$route:{async handler({params:e,query:t}){if(e.patient_id){const i=await o.findByID(e.patient_id);i&&(this.patientData=F.mapPersonData(i.person),t.edit_guardian&&(this.fieldAction="edit"),this.fields=this.getFields())}t.source&&(this.redirectURL=t.source)},immediate:!0,deep:!0}},methods:{getFields(){let e=[];return e.push(this.guardianSelection()),e.push(this.guardianIndex()),e.push(this.scanGuardian()),e.push(this.givenNameField()),e.push(this.familyNameField()),e.push(this.genderField()),e.push(this.searchResultField()),e=e.concat(this.dobFields()),e.push(this.homeRegionField()),e.push(this.homeDistrictField()),e.push(this.homeTAField()),e.push(this.homeVillageField()),e.push(this.currentRegionField()),e.push(this.currentDistrictField()),e.push(this.currentTAField()),e.push(this.currentVillage()),e=e.concat(this.landmarkFields()),e.push(this.cellPhoneField()),e.push(this.relationsField()),e},async onFinish(e,i){if(this.isEditMode()){if("relations"!=this.activeField){const e=new b;e.setPersonID(this.guardianData.id),await e.updatePerson(F.resolvePerson(i)),Object.keys(i).forEach((e=>{e in this.guardianData&&(this.guardianData[e]=i[e]?.date||i[e].person)}))}else if(this.guardianData?.relation){const i=await t.amendRelation(this.patientData.id,this.guardianData.id,this.guardianData.relation.relationship_id,e.relations.other.relationship_type_id);i&&(this.guardianData.relation=i)}this.fieldComponent="guardian_index"}else if(this.isSameAsPatient(i))d("Guardian cannot be the same patient");else{let a=-1;if(this.isRegistrationMode()){const e=new b;await e.registerGuardian(F.resolvePerson(i)),a=e.getPersonID()}else a=this.guardianData.id;await t.createRelation(this.patientData.id,a,e.relations.other.relationship_type_id),this.redirectURL?this.$router.push({name:this.redirectURL}):this.$route.query.edit_guardian?this.fieldComponent="select_guardian":await l(this.patientData.id,this.$router,this.$route)}},isEditMode(){return"edit"===this.fieldAction},isSearchMode(){return["Search","Registration"].includes(this.fieldAction)},isRegistrationMode(){return"Registration"===this.fieldAction},canEdit(e,t=!0,i=!0){return this.isEditMode()?e.includes(this.activeField)&&i:t},isSameAsPatient(e){let t="",i="",a="";return this.isRegistrationMode()?(t=h.toStandardHisDisplayFormat(e.birth_date.date),i=e.given_name.person&&e.family_name.person,a=e.gender.person):(t=this.guardianData.birth_date,i=this.guardianData.name,a=this.guardianData.gender),i.toLowerCase()===this.patientData.name.toLowerCase()&&t===this.patientData.birth_date&&a===this.patientData.gender},guardianSelection(){return{id:"select_guardian",helpText:"Select guardian to edit/view",type:i.TT_SELECT,condition:()=>this.isEditMode(),validation:e=>c.required(e),options:async()=>{const e=await u.getRelationships(this.patientData.id);return g.isEmpty(e)?(await m(450),"Register new"===await p("Patient has no guardians","","Select option to proceed",[{name:"Cancel",slot:"start",color:"danger"},{name:"Register new",slot:"start",color:"success"}])?(this.guardianData={},this.fieldAction="Registration",this.fieldComponent="scan"):this.$router.back(),[]):e.map((e=>{const t=F.mapPersonData(e.relation);return{label:`${t.name} (${e.type.b_is_to_a})`,value:e.relation.person_id,other:{relations:e,details:t}}}))},config:{footerBtns:[{name:"New Guardian",slot:"end",color:"primary",onClick:()=>{this.guardianData={},this.fieldAction="Registration",this.fieldComponent="scan"}}]}}},getDefaultVal(e){try{return this.guardianData[e]}catch(t){return""}},guardianIndex(){return{id:"guardian_index",helpText:"Guardian details",type:i.TT_TABLE_VIEWER,condition:e=>e.select_guardian.value,options:e=>{this.guardianData&&this.guardianData.id!=e.select_guardian.value&&(this.guardianData={...e.select_guardian.other.details,relation:e.select_guardian.other.relations});const t=e=>({name:"Edit",type:"button",action:()=>{this.activeField=e,this.fieldComponent=this.activeField}});return[{label:"",value:"",other:{rows:[["Given Name",this.guardianData.given_name,t("given_name")],["Family Name",this.guardianData.family_name,t("family_name")],["Gender",this.guardianData.gender,t("gender")],["Birthdate",h.toStandardHisDisplayFormat(this.guardianData.birth_date),t("year_birth_date")],["Cell Phone Number",this.guardianData.cell_phone_number,t("cell_phone_number")],["Home District",this.guardianData.home_district,t("home_region")],["Home TA",this.guardianData.home_traditional_authority,t("home_region")],["Home Village",this.guardianData.home_village,t("home_region")],["Current district",this.guardianData.current_district,t("current_region")],["Current T/A",this.guardianData.current_traditional_authority,t("current_region")],["Landmark",this.guardianData.landmark,t("default_landmarks")],["Relation",this.guardianData.relation.type.b_is_to_a,t("relations")]]}}]},config:{overrideDefaultFooterBtns:{nextBtn:{name:"Finish",slot:"end",color:"success",onClick:()=>this.fieldComponent="select_guardian"}},footerBtns:[{name:"Void Relation",slot:"start",color:"danger",onClick:async()=>{R((async e=>{await t.voidRelation(this.patientData.id,this.guardianData.relation.relationship_id,e),this.fieldComponent="select_guardian"}))}}],hiddenFooterBtns:["Clear","Back"]}}},givenNameField(){const e=F.getGivenNameField();return e.helpText="Guardian First name",e.defaultValue=()=>this.getDefaultVal(e.id),e.condition=()=>this.canEdit([e.id],this.isSearchMode()),e},familyNameField(){const e=F.getFamilyNameField();return e.helpText="Guardian Last name",e.defaultValue=()=>this.getDefaultVal(e.id),e.condition=()=>this.canEdit([e.id],this.isSearchMode()),e},genderField(){const e=F.getGenderField();return e.defaultValue=()=>this.getDefaultVal(e.id),e.condition=()=>this.canEdit([e.id],this.isSearchMode()),e},dobFields(){const e=F.getDobConfig();return e.defaultValue=()=>this.getDefaultVal("birth_date"),e.condition=()=>this.canEdit(["year_birth_date","month_birth_date","day_birth_date"],this.isRegistrationMode()),n(e)},homeRegionField(){const e=F.getHomeRegionField();return e.condition=()=>this.canEdit(this.homeAddressAttributes,this.isRegistrationMode()),e},homeDistrictField(){const e=F.getHomeDistrictField();return e.condition=()=>this.canEdit(this.homeAddressAttributes,this.isRegistrationMode()),e},homeTAField(){const e=F.getHomeTaField();return e.condition=e=>this.canEdit(this.homeAddressAttributes,this.isRegistrationMode()&&!e.home_region.label.match(/foreign/i),!e.home_region.label.match(/foreign/i)),e},homeVillageField(){const e=F.getHomeVillageField();return e.condition=e=>this.canEdit(this.homeAddressAttributes,this.isRegistrationMode()&&!e.home_region.label.match(/foreign/i),!e.home_region.label.match(/foreign/i)),e},currentRegionField(){const e=F.getCurrentRegionField();return e.condition=()=>this.canEdit(this.currentAddressAttributes,this.isRegistrationMode()),e},currentDistrictField(){const e=F.getCurrentDistrictField();return e.condition=()=>this.canEdit(this.currentAddressAttributes,this.isRegistrationMode()),e},currentTAField(){const e=F.getCurrentTAfield();return e.condition=e=>this.canEdit(this.currentAddressAttributes,this.isRegistrationMode()&&!e.current_region.label.match(/foreign/i),!e.current_region.label.match(/foreign/i)),e},currentVillage(){const e=F.getCurrentVillageField();return e.condition=e=>this.canEdit(this.currentAddressAttributes,this.isRegistrationMode()&&!e.current_region.label.match(/foreign/i),!e.current_region.label.match(/foreign/i)),e},cellPhoneField(){const e=F.getCellNumberField();return e.condition=()=>this.canEdit([e.id],this.isRegistrationMode()),e},landmarkFields(){const e=F.getLandmarkFields(),t=e[0].proxyID||e[0].id;return e[0].defaultValue=()=>this.getDefaultVal(t),e[0].condition=()=>this.canEdit([t],this.isRegistrationMode()),e},relationsField(){return{id:"relations",helpText:"Select relationship type",type:i.TT_RELATION_SELECTION,defaultValue:()=>this.getDefaultVal("relations"),validation:e=>c.required(e),condition:()=>this.canEdit(["relations"]),onload:e=>{if(e.patient=this.patientData,this.isRegistrationMode()){const t=F.resolvePerson(e.cdata);e.guardian={name:`${t.given_name} ${t.family_name}`,birth_date:h.toStandardHisDisplayFormat(t.birthdate),home_address:`${t.home_district} ${t.home_traditional_authority}`}}else e.guardian=this.guardianData},options:async()=>(await t.getRelations()).map((e=>({label:e.b_is_to_a,value:e.description,other:e}))),config:{hiddenFooterBtns:["Clear"]}}},scanGuardian(){return{id:"scan",helpText:"Scan or Register Guardian",type:i.TT_BARCODE,requireNext:!1,condition:()=>!this.isEditMode(),onValue:async e=>{const t=await o.findByNpid(e);return g.isEmpty(t)||(this.guardianData=F.mapPersonData(t[0].person),this.fieldComponent="relations",this.fieldAction="Scan"),!1},config:{hiddenFooterBtns:["Clear","Next","Back"],footerBtns:[{name:"Find or Register Guardian",color:"success",slot:"end",onClick:()=>{this.fieldAction="Search",this.fieldComponent="given_name"}}]}}},searchResultField(){return{id:"results",helpText:"Search results",type:i.TT_PERSON_RESULT_VIEW,dynamicHelpText:e=>`Search results for \n                "${e.given_name.value} ${e.family_name.value} | ${e.gender.label}"\n                `,appearInSummary:()=>!1,condition:()=>this.isSearchMode(),validation:e=>c.required(e),options:async e=>(await o.search({given_name:e.given_name.value,family_name:e.family_name.value,gender:e.gender.value})).map((e=>F.getPersonAttributeOptions(e))),config:{hiddenFooterBtns:["Clear","Next","Back"],footerBtns:[{name:"Edit Search",slot:"end",onClick:()=>{this.fieldAction="Search",this.fieldComponent="given_name"}},{name:"New Guardian",slot:"end",onClick:()=>{this.fieldAction="Registration",this.fieldComponent="year_birth_date"}},{name:"Continue Guardian",color:"success",slot:"end",state:{disabled:{default:()=>!0,onValue:(e,t)=>g.isEmpty(t.results)}},onClick:e=>{this.guardianData=F.mapPersonData(e.results.other.person.person),this.fieldComponent="relations",this.fieldAction="Search"}}]}}}}});e("default",_(v,[["render",function(e,t,i,a,n,r){const s=f("his-standard-form");return y(),D(s,{onOnIndex:t[0]||(t[0]=t=>e.fieldComponent=""),skipSummary:!0,activeField:e.fieldComponent,fields:e.fields,onFinishAction:e.onFinish,cancelDestinationPath:`/patient/dashboard/${e.patientData.id}`},null,8,["activeField","fields","onFinishAction","cancelDestinationPath"])}]]))}}}));
