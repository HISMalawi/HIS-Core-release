import{d as B,r as N,bS as T,bX as P,ad as v,W as U,ae as x,bx as D,aN as k,H as h,a as V,c as R,w as W,b as L,u as C,bC as M,I as O}from"./index-DMkqWlw1.js";import{H as G}from"./HisStandardForm-BTvSx8oL.js";import{u as j}from"./useEncounter-BBzrVHzy.js";import{r as J}from"./commons-Bci_rX4Q.js";import"./isEmpty-CpaViA7X.js";import"./encounter_guidelines-BtwGHdk0.js";import"./GuidelineEngine-D6V1_Znr.js";const ae=B({__name:"Adherence",setup(Q){const m=N([]),i=new T(-1,P.ADHERENCE);function F(e,t){const o=parseFloat(e)-parseFloat(t);return o<0?o*-1+" missed":o+" unacc"}function _(e,t){return M(h.toStandardHisFormat(i.date)).diff(h.toStandardHisFormat(e),t)}function g(e,t,o){return Math.round(100*(e-t)/(e-o))}function b(e){const t=e.frequency==="QW"?"week":"day",o=_(e.order.start_date,t);return e.quantity-o*parseFloat("".concat(e.equivalent_daily_dose))}const{goToNextTask:$,patientDashboardUrl:S}=j((e,t)=>{i.patientID=t,i.providerID=e;const o=()=>{let d=[];return{id:"pills_brought",helpText:"Pills remaining (brought to clinic)",type:v.TT_ADHERENCE_INPUT,init:async()=>{try{d=await T.getJson("patients/".concat(t,"/drugs_orders_by_program"),{date:i.date,program_id:i.programID})}catch(a){console.error("".concat(a)),U("Unable to load data!")}return!0},validation:a=>x.validateSeries([()=>x.required(a),()=>a.some(s=>s.value==="")?["Some values are missing"]:null]),computedValue:a=>a.map(u=>{const c=u.other;return[{concept_id:D.getCachedConceptID("Drug adherence"),value_drug:c.drug.drug_id,order_id:c.order_id,value_modifier:"%",person_id:t,value_numeric:g(c.quantity,parseInt("".concat(u.value)),b(c))},{concept_id:D.getCachedConceptID("Number of tablets brought to clinic"),order_id:c.order_id,value_numeric:u.value,person_id:t}]}).flat(1),options:a=>k.isEmpty(a.pills_brought)?d.map(s=>({label:s.drug.name,value:"",other:s})):a.pills_brought}},A=()=>({id:"adherence_report",helpText:"TB adherence",type:v.TT_TABLE_VIEWER,condition:d=>d.pills_brought.length,options:d=>{const a=d.pills_brought,s=a[0].other.order.start_date,u=_(s,"day"),c=" Last visit: ".concat(h.toStandardHisDisplayFormat(s)," \n                    (").concat(u," Days Elapsed)"),H=[{indexes:[0,3,6],class:"adherence-col-bg"}],f=[],y=[c],r=[["Prescription"],["Tabs given"],["Tabs per day"],["Tabs remaining"],["Expected"],["Actual (counted)"],["Adherence"],["Doses missed/ Unaccounted for"],["Doses consumed"],["TB Adherence"]];return a.forEach((n,q)=>{const l=b(n.other),p=g(n.other.quantity,parseInt("".concat(n.value)),l),E=p>=95&&p<=105?"Good adherence":"Explore problem",I=F("".concat(l),"".concat(n.value));y.push(n.other.drug.name),r[0].push(""),r[1].push(n.other.quantity),r[2].push("".concat(n.other.equivalent_daily_dose)),r[3].push(""),r[4].push(l<0?"0":"".concat(l)),r[5].push("".concat(n.value)),r[6].push(""),r[7].push(I),r[8].push("".concat(p,"%")),r[9].push(E),f.push({index:q+1,row:9,class:E.match(/good/i)?"adherence-txt-good":"adherence-txt-bad"})}),[{label:"Selected Medication",value:"Table",other:{columns:y,rows:r,rowColors:H,cellColors:f}}]},config:{hiddenFooterBtns:["Clear"]}});m.value=[o(),A()]});async function w(e,t){await i.createEncounter(),await i.saveObservationList(await J(t)),$()}return(e,t)=>(V(),R(C(O),null,{default:W(()=>[L(G,{cancelDestinationPath:C(S),onFinishAction:w,fields:m.value,skipSummary:!0},null,8,["cancelDestinationPath","fields"])]),_:1}))}});export{ae as default};
