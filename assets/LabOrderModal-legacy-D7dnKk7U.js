System.register(["./index-legacy-DJZIfc2x.js","./lab_order_service-legacy-B6VbnK1l.js"],(function(e,t){"use strict";var s,a,i,n,l,d,r,o,c,h,u,p,m,y,b,v,f,g,x,I,_,T,w,k,C,O,S,A,L,B,P,E,D,F,N,$,V,R,U,z,K,j,H,M,q,W,Y,G,X;return{setters:[e=>{s=e.d,a=e.r,i=e.u,n=e.v,l=e.w,d=e.x,r=e.y,o=e.z,c=e.G,h=e.aq,u=e.Q,p=e.R,m=e.S,y=e.U,b=e.dw,v=e.a4,f=e.a3,g=e.a5,x=e.d8,I=e.aR,_=e.bk,T=e.O,w=e.br,k=e.ah,C=e.aJ,O=e.as,S=e.ad,A=e.k,L=e.cR,B=e.cZ,P=e.cW,E=e.a2,D=e.a1,F=e.a0,N=e.W,$=e.aN,V=e.ac,R=e.dg,U=e._,z=e.aO,K=e.aX,j=e.a6,H=e.ab,M=e.B,q=e.E,W=e.C,Y=e.Z,G=e.H},e=>{X=e.L}],execute:function(){var t=document.createElement("style");t.textContent="table[data-v-1cd7f71c]{font-family:arial,sans-serif;border-collapse:collapse;width:100%}ion-col[data-v-1cd7f71c]{border-right:solid 1px #ccc}.side-title[data-v-1cd7f71c]{width:100%;padding:.3em;text-align:center;background:#e9e8e8}td[data-v-1cd7f71c],th[data-v-1cd7f71c]{border:1px solid #dddddd;text-align:left;padding:8px}tr[data-v-1cd7f71c]:nth-child(2n){background-color:#ddd}\n/*$vite$:1*/",document.head.appendChild(t);const Z={class:"ion-padding"},J="lab_use_small_print_label",Q=s({__name:"PrintOrderOptions",setup(e){const t=a("true"===localStorage.getItem(J));function s(){h.dismiss({canPrint:!1})}function x(){localStorage.setItem(J,`${t.value}`),h.dismiss({canPrint:!0,useSmallSpecimenLabel:t.value})}return(e,a)=>(i(),n(r(g),null,{default:l((()=>[d(r(u),null,{default:l((()=>[d(r(p),null,{default:l((()=>[d(r(m),null,{default:l((()=>a[1]||(a[1]=[o("Lab order print options")]))),_:1})])),_:1})])),_:1}),d(r(y),null,{default:l((()=>[c("div",Z,[d(r(b),{size:"large",class:"his-lg-text",modelValue:t.value,"onUpdate:modelValue":a[0]||(a[0]=e=>t.value=e),checked:!1},{default:l((()=>a[2]||(a[2]=[o(" Print small label ")]))),_:1},8,["modelValue"])])])),_:1}),d(r(v),null,{default:l((()=>[d(r(p),null,{default:l((()=>[d(r(f),{slot:"start",onClick:s,color:"danger",size:"large",style:{width:"100%"}},{default:l((()=>a[3]||(a[3]=[o(" Cancel ")]))),_:1}),d(r(f),{slot:"end",onClick:x,color:"success",size:"large",style:{width:"100%"}},{default:l((()=>a[4]||(a[4]=[o(" Print ")]))),_:1})])),_:1})])),_:1})])),_:1}))}}),ee=s({name:"Lab-modal",props:{activities:{type:Object,required:!0},ordersToday:{type:Object},onOrderAdded:{type:Object,required:!1},testFilters:{type:Array},title:{type:String,default:""}},watch:{activities:{handler(e){e&&(this.appActivities=[...e],this.getActivities())},immediate:!0}},async created(){this.printCopies=await x.labOrderPrintCopies()??1,this.extendedLabsEnabled=await x.extendedLabEnabled(),this.canScanDBS=await x.canScanDBS()},methods:{onFilter(e){this.searchFilter=I(e,this.searchFilter)},testAlreadyDoneToday(e){return!!(this.ordersToday||{})[e]},async onScanEIDbarcode(e){if(this.verifyingBarcode=!this.verifyingBarcode,!this.verifyingBarcode){if((await _.create({message:`Checking ${e}`})).present(),this.testTypes[this.activeIndex].accessionNumber=null,`${e||""}`.length<=0)return T("Barcode is required"),this.verifyingBarcode=!1,void _.getTop().then((e=>e&&_.dismiss()));try{await w.accessionNumExists(e)?T(`Barcode ${e} was already used`):this.testTypes[this.activeIndex].accessionNumber=e}catch(t){k("Failed to confirm barcode "+e+", Please try again later",8e3)}this.verifyingBarcode=!1,_.getTop().then((e=>e&&_.dismiss()))}},async onSelectTest(e,t,s){if(this.testAlreadyDoneToday(e))return T("Test was already ordered today, please void and try again!");this.searchFilter="",this.showKeyboard=!1,this.testTypes[t].isChecked=s.target.checked,this.testTypes[t].isChecked?(this.activeIndex=t,await this.setSpecimens(t)):this.removeOrder(t)},async setSpecimens(e){this.specimens=await w.getSpecimens(this.testTypes[e].name)},async getActivities(){const e=await w.getTestTypes(),t=C.findIndex(e,{name:"HIV viral load"}),s=-1!==t?e.splice(t,1):null,a=e.sort(((e,t)=>`${e.name}`.toUpperCase()>`${t.name}`.toUpperCase()?1:-1)).filter((e=>!Array.isArray(this.testFilters)||this.testFilters.includes(e.name)));this.testTypes=(s?[...s,...a]:a).map(((e,t)=>({...e,id:t})))},async removeOrder(e){this.testTypes[e].isChecked=!1,this.testTypes[e].reason=null,this.testTypes[e].specimen=null,this.testTypes[e].specimenConcept=null,this.testTypes[e].accessionNumber=null;const t=this.finalOrders.reverse();t[0]?(this.activeIndex=t[0].id,await this.setSpecimens(this.activeIndex)):(this.activeIndex=null,this.specimens=[])},addSpecimen(e){this.testTypes[this.activeIndex].specimenConcept=e.concept_id},async postActivities(){this.isPostingOrder=!0;try{const e=`${this.$route.params.patient_id}`,t=new X(parseInt(e),-1),s=await t.createEncounter();if(s){const e=await w.buildLabOrders(s,this.finalOrders),t=await w.saveOrdersArray(s.encounter_id,e);if(!t)return T("Unable to save lab orders");O.invalidate("PATIENT_LAB_ORDERS");const a=this.finalOrders.some((e=>!e.accessionNumber))&&await S("Lab orders and encounter created!, print out your last orders?",{confirmBtnLabel:"Yes",cancelBtnLabel:"No"});"function"==typeof this.onOrderAdded&&this.finalOrders.forEach((e=>this.onOrderAdded&&this.onOrderAdded(e.name))),a&&await this.onPrintOrder(t),await this.closeModal(t)}}catch(e){T(`Unable to save order: ${e}`)}this.isPostingOrder=!1},async onPrintOrder(e){const t=await h.create({component:Q,backdropDismiss:!1,cssClass:"custom-modal-backdrop"});await t.present();const{data:s}=await t.onWillDismiss();s.canPrint&&await this.printOrders(e,s.useSmallSpecimenLabel)},async closeModal(e){await h.dismiss(e)},async printOrders(e,t=!1){const s=this.finalOrders.map((e=>`${e.accessionNumber}`.toUpperCase()));for(const a of e)s.includes(`${a.accession_number}`.toUpperCase())||await A(a.order_id,t,this.printCopies);await h.dismiss(e)}},computed:{searchIcon:()=>L,searchColor(){return this.showKeyboard?"primary":"dark"},testTypesOnDisplay(){return this.searchFilter?new B(this.testTypes,{threshold:.3,keys:["name"],useExtendedSearch:!0}).search(this.searchFilter).map((e=>e.item)):this.testTypes},dbsBarcodeActivated(){return this.canScanDBS&&/dbs|plasma/i.test(`${this.testTypes[this.activeIndex]?.specimen}`)&&/hiv viral load/i.test(`${this.testTypes[this.activeIndex]?.name}`)},isOrderComplete(){return"number"==typeof this.activeIndex&&!(this.dbsBarcodeActivated&&/dbs/i.test(this.testTypes[this.activeIndex].specimen)&&!this.testTypes[this.activeIndex].accessionNumber)&&(this.extendedLabsEnabled?!!this.testTypes[this.activeIndex].reason:(this.testTypes[this.activeIndex].specimenConcept||this.testTypes[this.activeIndex].specimen)&&this.testTypes[this.activeIndex].reason)},selectedOrders(){return this.testTypes.filter((e=>!0===e.isChecked))},finalOrders(){return this.selectedOrders.filter((e=>!(this.dbsBarcodeActivated&&/dbs/i.test(e.specimen)&&!e.accessionNumber)&&e.reason&&(e.specimen&&!this.extendedLabsEnabled||this.extendedLabsEnabled)))},testReasons(){let e=this.reasons;return this.testTypes[this.activeIndex].name.match(/Viral load/i)&&(e=e.filter((e=>"Stat"!==e)),e=e.concat(["Follow up after Low Level Viremia","Follow up after High Viral Load"])),e}},mounted(){this.getActivities()},data:()=>({printCopies:1,isPostingOrder:!1,searchFilter:"",showKeyboard:!1,keyboardLayout:P,canScanDBS:!1,verifyingBarcode:!1,content:"Content",extendedLabsEnabled:!1,appActivities:[],testTypes:[],specimens:[],reasons:["Routine","Targeted","Confirmatory","Stat","Repeat / Missing"],activeIndex:null}),components:{IonButton:f,IonContent:y,IonHeader:u,IonTitle:m,IonInput:E,IonToolbar:p,IonLabel:D,IonList:F,IonItem:N,BarcodeInput:$,IonCheckbox:V,IonRadioGroup:R,IonRow:U,HisKeyboard:z,IonIcon:K}}),te={key:0},se={key:1},ae={class:"ion-margin-bottom"},ie={key:1},ne={class:"his-md-text side-title"},le={style:{background:"lightyellow",height:"34vh"}},de={class:"his-sm-text"};e("L",j(ee,[["render",function(e,t,s,a,r,h){const u=H("ion-title"),p=H("ion-icon"),m=H("ion-input"),y=H("ion-toolbar"),b=H("ion-header"),v=H("ion-label"),f=H("ion-checkbox"),g=H("ion-item"),x=H("ion-list"),I=H("ion-col"),_=H("ion-radio"),T=H("ion-radio-group"),w=H("ion-text"),k=H("BarcodeInput"),C=H("ion-button"),O=H("ion-row"),S=H("ion-grid"),A=H("his-keyboard"),L=H("ion-content"),B=H("ion-footer");return i(),M(q,null,[d(b,null,{default:l((()=>[d(y,null,{default:l((()=>[d(u,{class:"his-lg-text",slot:"start"},{default:l((()=>t[5]||(t[5]=[o(" Lab orders ")]))),_:1}),d(p,{size:"large",slot:"end",icon:e.searchIcon,color:e.searchColor},null,8,["icon","color"]),d(m,{readonly:!0,value:e.searchFilter,disabled:e.activeIndex&&!e.isOrderComplete,color:e.searchColor,onClick:t[0]||(t[0]=()=>e.showKeyboard=!e.showKeyboard),placeholder:"Search for tests",style:{"text-align":"left",width:"35%"},class:"input_display",slot:"end"},null,8,["value","disabled","color"])])),_:1})])),_:1}),d(L,{style:{overflow:"hidden",background:"grey",height:"70vh"}},{default:l((()=>[d(S,null,{default:l((()=>[d(O,null,{default:l((()=>[d(I,{size:"6"},{default:l((()=>[d(x,{style:{overflowY:"auto",height:"75vh"}},{default:l((()=>[(i(!0),M(q,null,W(e.testTypesOnDisplay,(t=>(i(),n(g,{class:"his-sm-text",key:t.id,color:e.activeIndex===t.id?"primary":"none",disabled:null!=e.activeIndex&&e.activeIndex!==t.id&&!e.isOrderComplete,detail:""},{default:l((()=>[d(v,{"text-wrap":""},{default:l((()=>[e.testAlreadyDoneToday(t.name)?(i(),M("s",te,Y(t.name),1)):(i(),M("span",se,Y(t.name),1))])),_:2},1024),d(f,{slot:"start",checked:t.isChecked,onIonChange:s=>e.onSelectTest(t.name,t.id,s)},null,8,["checked","onIonChange"])])),_:2},1032,["color","disabled"])))),128))])),_:1})])),_:1}),null!=e.activeIndex&&e.selectedOrders.length>0?(i(),n(I,{key:0,style:{overflowY:"auto",height:"79vh"}},{default:l((()=>[c("div",ae,[e.extendedLabsEnabled?G("",!0):(i(),n(x,{key:0},{default:l((()=>[d(T,{modelValue:e.testTypes[e.activeIndex].specimen,"onUpdate:modelValue":t[1]||(t[1]=t=>e.testTypes[e.activeIndex].specimen=t)},{default:l((()=>[t[6]||(t[6]=c("div",{class:"his-md-text side-title"}," Select specimen ",-1)),(i(!0),M(q,null,W(e.specimens,(t=>(i(),n(g,{key:t},{default:l((()=>[d(v,null,{default:l((()=>[o(Y(t.name),1)])),_:2},1024),d(_,{slot:"start",value:t.name,onClick:s=>e.addSpecimen(t)},null,8,["value","onClick"])])),_:2},1024)))),128))])),_:1},8,["modelValue"])])),_:1})),e.dbsBarcodeActivated?(i(),M("div",ie,[c("div",ne,[t[7]||(t[7]=o(" Barcode ID: ")),d(w,{color:e.testTypes[e.activeIndex].accessionNumber?"success":"dark"},{default:l((()=>[c("b",null,Y(e.testTypes[e.activeIndex].accessionNumber||"None"),1)])),_:1},8,["color"])]),d(k,{size:"small",onOnScan:t[2]||(t[2]=t=>e.onScanEIDbarcode(t))})])):G("",!0),d(T,{modelValue:e.testTypes[e.activeIndex].reason,"onUpdate:modelValue":t[3]||(t[3]=t=>e.testTypes[e.activeIndex].reason=t)},{default:l((()=>[t[8]||(t[8]=c("div",{class:"his-md-text side-title"}," Main test(s) reason ",-1)),(i(!0),M(q,null,W(e.testReasons,(e=>(i(),n(g,{class:"his-sm-text",key:e},{default:l((()=>[d(v,null,{default:l((()=>[o(Y(e),1)])),_:2},1024),d(_,{slot:"start",value:e},null,8,["value"])])),_:2},1024)))),128))])),_:1},8,["modelValue"])]),c("div",le,[c("table",de,[t[10]||(t[10]=c("thead",null,[c("tr",null,[c("th",null,"Test"),c("th",null,"Specimen"),c("th",null,"Reason"),c("th",null,"Action")])],-1)),c("tbody",null,[(i(!0),M(q,null,W(e.finalOrders,((s,a)=>(i(),M("tr",{key:a},[c("td",null,Y(s.name),1),c("td",null,Y(s.specimen||"N/A"),1),c("td",null,Y(s.reason),1),c("td",null,[d(C,{onClick:t=>e.removeOrder(s.id),slot:"end",color:"danger"},{default:l((()=>t[9]||(t[9]=[o("X")]))),_:2},1032,["onClick"])])])))),128))])])])])),_:1})):G("",!0)])),_:1})])),_:1}),e.showKeyboard?(i(),n(A,{key:0,kbConfig:e.keyboardLayout,onKeyPress:e.onFilter,disabled:!1},null,8,["kbConfig","onKeyPress"])):G("",!0)])),_:1}),d(B,null,{default:l((()=>[d(y,null,{default:l((()=>[d(C,{onClick:e.postActivities,size:"large",slot:"end",disabled:e.isPostingOrder||0===e.finalOrders.length},{default:l((()=>t[11]||(t[11]=[o(" Place orders ")]))),_:1},8,["onClick","disabled"]),d(C,{disabled:e.isPostingOrder,onClick:t[4]||(t[4]=t=>e.closeModal([])),size:"large",slot:"start",color:"danger"},{default:l((()=>t[12]||(t[12]=[o(" Close ")]))),_:1},8,["disabled"])])),_:1})])),_:1})],64)}],["__scopeId","data-v-1cd7f71c"]]))}}}));
