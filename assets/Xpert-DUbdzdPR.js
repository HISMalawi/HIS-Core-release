import{d as P,K as N,b5 as L,cV as B,aI as O,V as u,o as x,c as U,w as V,b as k,cl as M,cX as I,ad as G,I as X,ag as D}from"./index-BCTN_bnC.js";import{H as q}from"./HisStandardForm-CaDwl-hA.js";import{u as Y}from"./useEncounter-CDUT-p5Y.js";import{F as p}from"./dynamic-import-helper-BkBZiFw5.js";import{r as $}from"./commons-BDvZ1JFN.js";import{g as i,a as W,b as j}from"./util-CyjuS_4X.js";import{L as H}from"./lab_service-BRM8Dcbe.js";import"./TouchScreenForm-TKB9q3ZD.js";import"./ToolbarMediumCard-O_J6wu7C.js";import"./Transformers-BPPLlH12.js";import"./ViewPort-BCxYiILf.js";import"./isEmpty-OXtHK5dz.js";import"./_Set-VKtKUQAI.js";import"./_setToArray-BLmuRUHx.js";import"./encounter_guidelines-DZpIPlYY.js";import"./GuidelineEngine-D6V1_Znr.js";const ue=P({__name:"Xpert",setup(K){const f=N([]),a=new L(-1,B.LAB_RESULTS),F=N(),{goToNextTask:T,facts:y,patientDashboardUrl:b}=Y((n,s,m)=>{a.patientID=s,a.providerID=n,F.value=m;const r=()=>({id:"xpertSampleOneResult",helpText:"Sample One Result:",type:p.TT_SELECT,init:async()=>{const e=await O.getProgramInformation(a.patientID);return console.log(e),!0},validation:e=>u.required(e),computedValue:e=>({concept_id:i("SAMPLE_ONE_GENEXPERT_RESULT"),value_coded:i("".concat(e.value)),obs_datetime:a.date}),options:()=>[{value:"MTB_NOT_DETECTED",label:"MTB not detected"},{value:"MTB_DETECTED",label:"MTB detected"},{value:"MTB_NO_RESULT",label:"No result"},{value:"MTB_ERROR",label:"Error"},{value:"MTB_INVALID",label:"Invalid"}]}),d=()=>({id:"sampleOneRifResistancePattern",helpText:"Sample One RIF Resistance:",type:p.TT_SELECT,validation:e=>u.required(e),condition:e=>e.xpertSampleOneResult.value==="MTB_DETECTED",computedValue:(e,l)=>({concept_id:i("SAMPLE_ONE_RIF_RESISTANCE_PATTERN"),value_coded:i("".concat(e.value)),obs_datetime:a.date}),options:()=>[{value:"RIF_RESISTANT_NOT_DETECTED",label:"RIF resistant not detected"},{value:"RIF_RESISTANT_DETECTED",label:"RIF resistant detected"},{value:"RIF_RESISTANT_INDETERMINATE",label:"RIF resistant indeterminate"}]}),_=()=>({id:"sampleOneResultDate",helpText:"Sample One Result Date:",type:p.TT_FULL_DATE,validation:e=>u.required(e),computedValue:e=>({concept_id:i("SAMPLE_ONE_GENEXPERT_RESULT_DATE"),value_datetime:e.value,obs_datetime:a.date})}),R=()=>({id:"xpertSampleTwoResult",helpText:"Sample Two Result:",type:p.TT_SELECT,validation:e=>u.required(e),computedValue:e=>({concept_id:i("SAMPLE_TWO_GENEXPERT_RESULT"),value_coded:i("".concat(e.value)),obs_datetime:a.date}),options:()=>[{value:"MTB_NOT_DETECTED",label:"MTB not detected"},{value:"MTB_DETECTED",label:"MTB detected"},{value:"MTB_NO_RESULT",label:"No result"},{value:"MTB_ERROR",label:"Error"},{value:"MTB_INVALID",label:"Invalid"}],condition:e=>{var l;return/invalid|error|no_result/i.test(e.xpertSampleOneResult.value)||/RIF_RESISTANT_INDETERMINATE|RIF_RESISTANT_DETECTED/i.test((l=e.sampleOneRifResistancePattern)==null?void 0:l.value)}}),v=()=>({id:"sampleTwoRifResistancePattern",helpText:"Sample Two RIF Resistance:",type:p.TT_SELECT,validation:e=>u.required(e),condition:e=>e.xpertSampleTwoResult.value==="MTB_DETECTED",computedValue:(e,l)=>[{concept_id:i("SAMPLE_TWO_RIF_RESISTANCE_PATTERN"),value_coded:i("".concat(e.value)),obs_datetime:a.date},...(()=>{var E;return((E=l.sampleOneRifResistancePattern)==null?void 0:E.value)==="RIF_RESISTANT_DETECTED"&&e.value==="RIF_RESISTANT_DETECTED"?[{concept_id:i("TB_DRUG_RESISTANT"),value_coded:W("Rifampicin (300mg)"),obs_datetime:a.date},{concept_id:i("Resistance classification"),value_coded:i("Mono drug resistant"),obs_datetime:a.date}]:[]})()],options:()=>[{value:"RIF_RESISTANT_NOT_DETECTED",label:"RIF resistant not detected"},{value:"RIF_RESISTANT_DETECTED",label:"RIF resistant detected"},{value:"RIF_RESISTANT_INDETERMINATE",label:"RIF resistant indeterminate"}]}),S=()=>({id:"sampleTwoResultDate",helpText:"Sample Two Result Date:",type:p.TT_FULL_DATE,validation:e=>u.required(e),condition:e=>e.xpertSampleTwoResult.value,computedValue:e=>({concept_id:i("SAMPLE_TWO_GENEXPERT_RESULT_DATE"),value_datetime:e.value,obs_datetime:a.date})});f.value=[r(),d(),_(),R(),v(),S()]});function h(n){var r,d;const s=((r=n.xpertSampleOneResult)==null?void 0:r.value)==="MTB_DETECTED"||((d=n.xpertSampleTwoResult)==null?void 0:d.value)==="MTB_DETECTED";return[{concept_id:i("PROCEDURE_TYPE"),value_coded:i("XPERTRIF"),obs_datetime:a.date},{concept_id:i("BACTERIOLOGICALLY_DIAGNOSED"),value_coded:i("YES_ANSWER"),obs_datetime:a.date},{concept_id:i("TB_STATUS"),value_coded:i(s?"POSITIVE":"NEGATIVE"),obs_datetime:a.date},...s?[{concept_id:i("TB_TYPE"),value_coded:i("PULMONARY_TB"),obs_datetime:a.date},{concept_id:i("TUBERCULOSIS_CLASS"),value_coded:i("All Other"),obs_datetime:a.date}]:[]]}async function g(){return(await H.getRecentOrders(a.patientID)).observations.reduce((n,s)=>i("REASON_FOR_TEST")===s.concept_id?s.value_text||s.value_coded:n,"")}async function w(n,s){var R,v,S,e,l,E;await a.createEncounter(),await a.saveObservationList([...h(n),...await $(s)]);const m=await g(),r=await O.getProgramInformation(a.patientID),d={testReason:m,isConfirmatoryTest:["Confirmatory Rifampicin Resitance test","Rifampicin Resistance confirmation test",j("Confirmatory Rifampicin Resitance test")].includes(m),age:r.age,eptb:r.eptb,hiv:r.hiv,onTreatment:I.isOnTreatment(y.outcome),onMdr:/multi drug resistance treatment/i.test(y.outcome),isTbPositive:[(R=n.xpertSampleOneResult)==null?void 0:R.value,(v=n.xpertSampleTwoResult)==null?void 0:v.value].some(t=>t==="MTB_DETECTED"),sampleResultsAreInvalid:[(S=n.xpertSampleOneResult)==null?void 0:S.value,(e=n.xpertSampleTwoResult)==null?void 0:e.value].every(t=>t==="MTB_INVALID"),samplesAreRifResistant:[(l=n.sampleOneRifResistancePattern)==null?void 0:l.value,(E=n.sampleTwoRifResistancePattern)==null?void 0:E.value].every(t=>t==="RIF_RESISTANT_DETECTED")},_={"prompt when results are invalid":{title:"Sample one and sample two results are invalid",message:"Do you want to Order another GeneXpert test?",yes:()=>D.push("/tb/lab/".concat(a.patientID,"?test=XPERT_MTB_RIF")),no:T,mandatoryCondition:{sampleResultsAreInvalid:t=>t}},"Continue if already on mdr":{action:T,mandatoryCondition:{onMdr:t=>t}},"ask for confirmatory test if resistance is detected":{title:"Rifampcin Resistance Detected!",message:"Do you want to order confirmatory test?",yes:()=>D.push("/tb/lab/".concat(a.patientID,"?reason=Confirmatory Rifampicin Resitance test")),no:async()=>{await I.enrollMDR(a.patientID),T()},mandatoryCondition:{samplesAreRifResistant:t=>t,isConfirmatoryTest:t=>!t}},"enroll in mdr if confirmatory test detects drug resistance":{action:async()=>{await I.enrollMDR(a.patientID),T()},mandatoryCondition:{samplesAreRifResistant:t=>t,isConfirmatoryTest:t=>t}},"Offer Culture and pDST test if MTB is detected without RIF and if patient falls into risk category":{title:"High risk patient",message:"MTB Detected without RIF and patient is a high risk category. Do you want to request Culture and pDST test?",yes:()=>D.push("/tb/lab/".concat(a.patientID,"?test=CULTURE_AND_DST")),no:T,mandatoryCondition:{isTbPositive:t=>t,samplesAreRifResistant:t=>!t},eitherConditionMatch:{eptb:t=>t,hiv:t=>t,age:t=>t<14}},"offer to try a different examination if client is negative":{title:"Negative patient",message:"Do you want to try a different examination?",yes:T,no:()=>D.push(b.value),mandatoryCondition:{isTbPositive:t=>!t,onTreatment:t=>!t,age:t=>t>14}}};for(const t of Object.keys(_)){const o=_[t];let C=!0,A=!1;if(o.mandatoryCondition&&(A=Object.keys(o.mandatoryCondition).every(c=>o.mandatoryCondition[c](d[c]))),o.eitherConditionMatch&&(C=Object.keys(o.eitherConditionMatch||{}).some(c=>o.eitherConditionMatch[c](d[c]))),C&&A){if(typeof o.yes=="function"&&typeof o.no=="function")return await G(o.title,"",o.message,[{name:"Yes",slot:"start",color:"success"},{name:"No",slot:"start",color:"primary"}])==="Yes"?o.yes():o.no();if(typeof o.action=="function")return o.action()}}}return(n,s)=>(x(),U(M(X),null,{default:V(()=>[k(q,{cancelDestinationPath:M(b),onFinishAction:w,fields:f.value,skipSummary:!0},null,8,["cancelDestinationPath","fields"])]),_:1}))}});export{ue as default};
