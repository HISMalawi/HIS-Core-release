import{d as q,ai as x,aq as W,Z as K,Y as J,X,_ as Z,b1 as Q,a3 as tt,a8 as et,dq as nt,dv as at,a4 as st,a9 as ot,I as it,$ as rt,a6 as lt,as as u,bs as N,H as S,ao as ct,U as V,W as g,by as k,bn as A,bx as ut,au as dt,aN as pt,aW as ht,dw as ft,bA as mt,R as gt,ad as bt,ae as yt,aa as kt,c as l,w as n,af as o,a as i,b as a,K as T,a2 as w,E as C,M as m,C as p,G as R,J as E}from"./index-CMZASHAR.js";import{_ as Tt}from"./EncounterMixin.vue_vue_type_script_lang-v2aYCq6R.js";import{R as wt}from"./RiskFactorModal-Cpt0i1Kz.js";import{B as P}from"./htn_service-B9DGYTze.js";import{V as _t}from"./vitals_service-DXPPoar9.js";import"./encounter_guidelines-CJXpBOk4.js";import"./GuidelineEngine-D6V1_Znr.js";import"./HisStandardForm-BCjM4-bc.js";const b={background:"#444444"},Dt=q({mixins:[Tt],components:{IonCheckbox:x,DataTable:W,IonTitle:K,IonToolbar:J,IonHeader:X,IonContent:Z,IonGrid:Q,IonRow:tt,IonButton:et,IonRadioGroup:nt,IonRadio:at,IonCol:st,IonFooter:ot,IonPage:it,IonItem:rt,IonLabel:lt},data:()=>({htn:{},hasARVNumber:!0,suggestedNumber:"",columns:[[u.thTxt("Date",{style:b}),u.thTxt("Systolic",{style:b}),u.thTxt("Diastolic",{style:b}),u.thTxt("BP Drugs",{style:b}),u.thTxt("Action / Note",{style:b})]],bpGradeColorMap:{"N/A":"#ffffff",normal:"#ffffff","grade 1":"#FFC3CE","grade 2":"#F20056","grade 3":"#FF3333"},rows:[],riskFactors:[],action:null,trail:[],date:null,patientOnBPDrugs:!1,patientFirstVisit:!1,normatensive:!1,patientHasHyperTensionObs:!1,currentDrugs:[],items:[],isEnrolledInHTN:!1,isAliveOnHTN:!1,HTNProgramID:20,aliveState:160,refer:!1,onBpDrugActions:[],noneBpActions:[]}),watch:{ready:{async handler(t){if(!t)return;await(await N.create({message:"Please wait...",backdropDismiss:!1})).present(),this.htn=new P(this.patientID,this.providerID),this.trail=await this.htn.getBPTrail(),this.rows=this.formatBpTrailRows(this.trail),this.normatensive=P.isBpNormotensive(this.trail),this.riskFactors=await this.getRiskFactors(),this.date=S.toStandardHisDisplayFormat(ct.getSessionDate()),await this.isTransfered(),await this.hasHyperTenstion(),await this.getTreatmentStatus(),await this.getProgramStatus(),N.dismiss(),this.patientFirstVisit&&this.patientOnBPDrugs&&await this.alertTransferIn(),this.setBpActions()},immediate:!0}},computed:{totalRiskFactors(){return this.riskFactors.filter(t=>t.value==="Yes").length},showClinicianButton(){return!(V.isClinician()&&V.isDoctor())}},methods:{setBpActions(){this.onBpDrugActions=[{label:"Continue drugs",value:"on treatment",other:{action:()=>this.$router.push("/art/encounters/bp_adherence/".concat(this.patientID))}},{label:"Medication not available",value:"on treatment",other:{action:()=>this.$router.push("/art/encounters/bp_adherence/".concat(this.patientID))}},{label:"Review drugs",value:"on treatment",other:{action:()=>this.$router.push("/art/encounters/bp_adherence/".concat(this.patientID,"?review=true"))}}],this.noneBpActions=[{label:"Lifestyle advice given",value:"Lifestyle changes only",isChecked:!1},{label:"Patient declining BP drugs ",value:"Symptomatic but not in treatment",isChecked:!1},...this.normatensive?[{label:"Return to annual screening",value:"Alive"}]:[],{label:"Start anti hypertensives",value:"On treatment",other:{action:()=>this.$router.push("/art/encounters/bp_prescription/".concat(this.patientID))}}]},async onFinish(){var t,e;if(this.noneBpActions.some(r=>r.isChecked)||this.action||this.refer){if(!await this.htn.createEncounter())return g("Unable to create encounter");if(this.refer){if(!await this.htn.saveValueCodedObs("Refer patient to clinician","Yes"))return g("Unable to create Obs");this.gotoPatientDashboard()}else{if(this.currentDrugs.length){await this.htn.saveValueTextObs("Plan",this.action.label);const s={state:this.action.value};await this.htn.enrollPatient(s)}else{const s=this.noneBpActions.filter(d=>d.isChecked);if(s.length){const d=s.map(_=>this.htn.saveValueTextObs("Plan",_.label));await Promise.all(d)}}const c=this.noneBpActions.filter(s=>{var d;return s.isChecked&&typeof((d=s.other)==null?void 0:d.action)=="function"});if(c.length)return c.forEach(s=>s.other.action());if(typeof((e=(t=this.action)==null?void 0:t.other)==null?void 0:e.action)=="function")return this.action.other.action();this.nextTask()}}else g("Please select an action")},referPatient(){this.refer=!0,this.onFinish()},goToDiagnosis(){return this.$router.push({path:"/art/encounters/hypertension_diagnosis/".concat(this.patientID)})},async hasHyperTenstion(){const t=await k.getFirstValueCoded(this.patientID,"Patient has hypertension");this.patientHasHyperTensionObs=!!"".concat(t).match(/yes|no/i)},async isTransfered(){const t=await k.getFirstValueCoded(this.patientID,"Transferred");this.patientFirstVisit=!t},async getTreatmentStatus(){const t=await k.getFirstValueText(this.patientID,"Treatment status");this.patientOnBPDrugs=!!(t&&t.match(/BP Drugs started/i))},async getProgramStatus(){const t=await A.getPatientPrograms(this.patientID);this.isEnrolledInHTN=t.filter(e=>e.program.name==="HYPERTENSION PROGRAM").length>0,this.isEnrolledInHTN&&await this.programState()},async programState(){const t=await A.getPatientStates(this.patientID,this.HTNProgramID);this.isAliveOnHTN=t.filter(e=>e.name==="Alive").length>0},async getRiskFactors(){const e=ut.getConceptsByCategory("risk factors").map(async r=>{const c=await k.getFirstValueCoded(this.patientID,r.name);return{concept:r.name,value:c}});return Promise.all(e)},formatBpTrailRows(t){return Object.keys(t).map(e=>{const r=S.toStandardHisDisplayFormat(e);this.currentDrugs=this.currentDrugs.concat(t[e].drugs);const s={background:(()=>{const d=P.getBpGrade(parseInt(t[e].sbp),parseInt(t[e].dbp));return this.bpGradeColorMap[d]})()};return[u.tdDate(r,{style:s}),u.td(t[e].sbp,{style:s}),u.td(t[e].dbp,{style:s}),u.td(t[e].drugs.join(", "),{style:s}),u.td(t[e].note,{style:s})]})},async showRiskFactors(){const t=await dt.create({component:wt,backdropDismiss:!1,cssClass:"large-modal",componentProps:{factors:this.riskFactors}});t.present();const{data:e}=await t.onDidDismiss();pt.isEmpty(e)||(this.riskFactors=e.map(r=>{const c=r.isChecked===!0?"Yes":"No";return{concept:r.concept,value:c}}))},async alertTransferIn(){await ht("Transfer in","Does the patient want to transfer in for HTN management?","",[{name:"Yes",slot:"end",color:"success"},{name:"No",slot:"start",color:"danger"}])==="Yes"?(await this.enrollInHTN(),await this.setHtnTransferred("Yes"),this.patientFirstVisit=!1,this.setBpActions()):(await this.setHtnTransferred("No"),this.nextTask())},async enrollInHTN(){ft({id:"enrollment_date",helpText:"HTN Enrollment date",type:bt.TT_FULL_DATE,validation:t=>yt.required(t)},async t=>{try{const e=new mt(this.patientID);e.setProgramId(this.HTNProgramID),e.setProgramDate("".concat(t.value)),e.setStateDate("".concat(t.value)),e.setStateId(this.aliveState),await e.enrollProgram(),await e.updateState(),this.isEnrolledInHTN=!0,gt("Patient is now enrolled in HTN")}catch(e){console.error(e),g("".concat(e))}})},async setHtnTransferred(t){const e=new _t(this.patientID,this.providerID);await e.createEncounter()?await e.saveValueCodedObs("Transferred",t)||g("Unable to create observation Transferred for patient"):g("Unable to create patient transfer encounter")}}}),vt={key:0,style:{color:"green"}},It={slot:"end"};function Ct(t,e,r,c,s,d){const _=o("ion-title"),f=o("ion-button"),y=o("ion-toolbar"),O=o("ion-header"),$=o("data-table"),U=o("ion-content"),G=o("ion-radio"),H=o("ion-label"),F=o("ion-item"),D=o("ion-col"),v=o("ion-row"),B=o("ion-grid"),Y=o("ion-radio-group"),M=o("ion-checkbox"),L=o("ion-footer"),z=o("ion-page");return i(),l(z,null,{default:n(()=>[a(O,null,{default:n(()=>[a(y,null,{default:n(()=>[a(_,null,{default:n(()=>[T("span",null,"BP management screening on "+w(t.date),1),t.patientOnBPDrugs?(i(),C("small",vt," (Patient already on BP drugs)")):m("",!0)]),_:1}),T("span",It,[t.totalRiskFactors>0?(i(),l(f,{key:0,color:"danger",onClick:t.showRiskFactors},{default:n(()=>[p("View/Edit risk factors "+w(t.totalRiskFactors),1)]),_:1},8,["onClick"])):m("",!0),t.totalRiskFactors===0?(i(),l(f,{key:1,onClick:t.showRiskFactors},{default:n(()=>e[1]||(e[1]=[p("add riskfactors")])),_:1},8,["onClick"])):m("",!0)])]),_:1})]),_:1}),a(U,null,{default:n(()=>[a($,{config:{showIndex:!1},columns:t.columns,rows:t.rows},null,8,["columns","rows"])]),_:1}),a(L,null,{default:n(()=>[t.currentDrugs.length?(i(),l(y,{key:0},{default:n(()=>[e[2]||(e[2]=T("h1",{style:{"text-align":"center"}},"Actions",-1)),a(Y,{modelValue:t.action,"onUpdate:modelValue":e[0]||(e[0]=h=>t.action=h)},{default:n(()=>[a(B,null,{default:n(()=>[a(v,null,{default:n(()=>[(i(!0),C(E,null,R(t.onBpDrugActions,(h,I)=>(i(),l(D,{key:I},{default:n(()=>[a(F,{lines:"none"},{default:n(()=>[a(G,{style:{"margin-right":"10px"},value:h},null,8,["value"]),a(H,{style:{"font-size":"1.0rem","font-weight":"bold"}},{default:n(()=>[p(w(h.label),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})):(i(),l(y,{key:1},{default:n(()=>[a(B,null,{default:n(()=>[a(v,null,{default:n(()=>[a(D,null,{default:n(()=>e[3]||(e[3]=[T("h1",{style:{"text-align":"center"}},"Actions",-1)])),_:1})]),_:1}),a(v,null,{default:n(()=>[(i(!0),C(E,null,R(t.noneBpActions,(h,I)=>(i(),l(D,{key:I},{default:n(()=>[a(F,{lines:"none"},{default:n(()=>[a(M,{style:{"margin-right":"10px"},modelValue:h.isChecked,"onUpdate:modelValue":j=>h.isChecked=j},null,8,["modelValue","onUpdate:modelValue"]),a(H,null,{default:n(()=>[p(w(h.label),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})),a(y,{color:"dark"},{default:n(()=>[a(f,{size:"large",color:"danger",slot:"start",onClick:t.gotoPatientDashboard},{default:n(()=>e[4]||(e[4]=[p(" cancel ")])),_:1},8,["onClick"]),t.showClinicianButton?(i(),l(f,{key:0,size:"large",color:"danger",slot:"start",onClick:t.referPatient},{default:n(()=>e[5]||(e[5]=[p(" Refer to clinician ")])),_:1},8,["onClick"])):m("",!0),t.patientHasHyperTensionObs?m("",!0):(i(),l(f,{key:1,size:"large",slot:"end",onClick:t.goToDiagnosis},{default:n(()=>e[6]||(e[6]=[p(" Hypertension Diagnosis ")])),_:1},8,["onClick"])),t.patientHasHyperTensionObs&&!t.isEnrolledInHTN?(i(),l(f,{key:2,size:"large",slot:"end",onClick:t.enrollInHTN},{default:n(()=>e[7]||(e[7]=[p(" Enroll in HTN ")])),_:1},8,["onClick"])):m("",!0),t.patientHasHyperTensionObs?(i(),l(f,{key:3,size:"large",color:"success",slot:"end",onClick:t.onFinish},{default:n(()=>e[8]||(e[8]=[p(" Finish ")])),_:1},8,["onClick"])):m("",!0)]),_:1})]),_:1})]),_:1})}const Rt=kt(Dt,[["render",Ct]]);export{Rt as default};
