import{d as j,I as H,cg as L,K as h,E as V,N as Q,cn as C,ac as K,n as W,q as E,cQ as G,t as X,ci as B,O as F,ae as Y,ch as z,cj as J,cl as Z,ck as ee,_ as te,r as $,o as ae,c as re,w as oe,b as O}from"./index-C234CYGF.js";import{D as ne}from"./disaggregated_service-2v7lIurb.js";import{v as se}from"./TableView-D3zkwj8Y.js";import{A as le}from"./ArtDrilldown-D0QTf6BA.js";import{R as I}from"./regimen_report_service-BQ2sIU7g.js";import{M as ie}from"./moh_cohort_service-B4sf1M0u.js";import{R as ce}from"./ReportErrors-TYNIFo8T.js";import"./fuse-YdZE3OCN.js";import"./Export-9qIusFpp.js";import"./HisKeyboard-Dt_TzYc6.js";const ge=j({components:{IonPage:H,IonLoading:L,v2Datatable:se},setup(){const l=h(!1),_=h([]),b=h(""),D=h(""),y=h(!1),t=new ne,p=new ie,i=h([]),c=V(),P=async r=>{(await F.create({component:le,backdropDismiss:!1,cssClass:"large-modal",componentProps:{...r,subtitle:b.value,onFinish:()=>F.getTop().then(a=>a&&F.dismiss())}})).present()},A=(r,a)=>({ref:a,label:r,defaultValue:"0",toValue:e=>e.length,tdClick:async e=>{e.refData.length&&P({patientIdentifiers:e.refData,title:"".concat(e.data.age_group," ").concat(e.data.gender," ").concat(e.column.label)})}}),T=[[{label:"#",ref:"index"},{label:"Age group",ref:"age_group"},{label:"Gender",ref:"gender"},A("TX curr (receiving ART)","tx_curr"),...I.reduce((r,a)=>[...r,A(a,a)],[]),A("Unknown","N/A"),A("Total (regimen)","regimen_total")]],N=[...I,"N/A"].reduce((r,a)=>({...r,[a]:[]}),{}),S=async()=>w(await W("Do you want to rebuild report?")),x=function(r){const a=i.value.findIndex(e=>e.id===r.id);a!==-1?i.value[a]=r:i.value.push(r)},R=async function(r){const a="validationErrors";(await F.create({id:a,component:ce,backdropDismiss:!1,cssClass:"large-modal",componentProps:{errors:r}})).present(),x({id:a,text:"<b>".concat(r.length,"</b> validation errors detected"),icon:Z,color:"danger",action:()=>R(r)})},U=async r=>{const a={total_alive_and_on_art:{param:r.length,check:(u,v)=>u!=v,error:(u,v)=>"\n                        Total alive of <b>".concat(v,"</b>\n                        Does not match total alive of <b>").concat(u,"</b> on MOH report\n                    ")}};p.validateIndicators(a,u=>{u.length?R(u):x({id:"reportOk",text:"<b>Report is consistent</b>",icon:ee,color:"success"})})===-1&&R(["Report not validated. Run the MoH cohort report for similar reporting period and then run this report"])},w=async(r=!1)=>{var v,M,q;if(!l.value)return E("Unable to generate report, return to cohort report");y.value=!0;const a=["Pregnant","Breastfeeding"],e={F:{label:"Female",rows:[],aggregate:{},excludedAgeGroups:a},M:{label:"Male",rows:[],aggregate:{},excludedAgeGroups:a},FP:{label:"Pregnant",rows:[],aggregate:{},gender:"F",ageGroup:"All",genderDisplay:"FP",excludedAgeGroups:[...G,"Breastfeeding"]},FBF:{label:"Breastfeeding",rows:[],aggregate:{},gender:"F",ageGroup:"All",genderDisplay:"FBF",excludedAgeGroups:[...G,"Pregnant"]}},u=(s=!1)=>{const g=Object.keys(e.FP.aggregate).reduce((d,n)=>({...d,[n]:[...e.FP.aggregate[n]||[],...e.FBF.aggregate[n]||[]]}),{}),o=Object.keys(e.F.aggregate).reduce((d,n)=>({...d,[n]:d[n].filter(k=>Array.isArray(g[n])?!g[n].includes(k):!0)}),e.F.aggregate);_.value=[...e.F.rows,...e.M.rows,{age_group:"All",gender:"Male",...e.M.aggregate},...e.FP.rows,{age_group:"All",gender:"FNP",...o},...e.FBF.rows];const f=Y.uniq([...e.M.aggregate.tx_curr||[],...e.F.aggregate.tx_curr||[]]),m={text:"Total alive and on ART: <b>".concat(f.length,"</b>"),icon:z,color:"primary",action:()=>P({patientIdentifiers:f,title:"Total alive and on ART: ".concat(f.length)})};s?(i.value=[m],U(f)):i.value=[m,{text:D.value,icon:J,color:"dark"}]};try{if(t.setRebuildOutcome(r),!await t.init())return X("Unable to initialise report");for(const s of[...G,...a]){D.value="Processing <b>".concat(s,"</b>"),t.setAgeGroup(s);const g=await t.getCohort();t.setRebuildOutcome(!1);for(const o of Object.keys(e)){if((e[o].excludedAgeGroups||[]).includes(s))continue;t.setGender(o),e[o].ageGroup&&t.setAgeGroup(e[o].ageGroup);const f=await t.getRegimenDistribution(),m={age_group:((v=e[o])==null?void 0:v.ageGroup)||s,gender:((M=e[o])==null?void 0:M.genderDisplay)||e[o].label,...g[s]?g[s][((q=e[o])==null?void 0:q.gender)||o]:{},...N,...f,regimen_total:Object.values(f).flat(1)};e[o].rows.push(m),e[o].aggregate=Object.keys(m).reduce((d,n)=>Array.isArray(m[n])?{...d,[n]:[...d[n]||[],...m[n]]}:d,e[o].aggregate),u(!1)}}u(!0),_.value=_.value.map((s,g)=>({index:g+1,...s}))}catch(s){const g="Unable to generate report!";E(g),i.value=[{text:g,color:"danger",icon:B,action:function(){i.value=[{text:"Exception occured: <b>".concat(s,"</b>"),color:"danger",icon:B}]}}]}y.value=!1,D.value=""};return Q(()=>{l.value=!!(c.query.start_date&&c.query.end_date&&c.query.quarter),l.value&&(t.setStartDate("".concat(c.query.start_date)),t.setEndDate("".concat(c.query.end_date)),t.setOccupation("".concat(c.query.occupation)),p.setOccupation(t.occupation),p.setStartDate(t.startDate),p.setEndDate(t.endDate),b.value="".concat(C(t.startDate)," to ").concat(C(t.endDate)),c.query.quarter&&(t.setQuarter("".concat(c.query.quarter)),p.setQuarter(t.quarter),b.value="".concat(t.quarter==="Custom"?b.value:t.quarter)),w())}),{Img:K,onRegenerate:S,headerBadge:i,reportData:_,isLoading:y,generate:w,columns:T,period:b}}});function ue(l,_,b,D,y,t){const p=$("ion-loading"),i=$("v2Datatable"),c=$("ion-page");return ae(),re(c,null,{default:oe(()=>[O(p,{"is-open":l.isLoading,message:"Please wait.."},null,8,["is-open"]),O(i,{"icon-url":l.Img("login-logos/Malawi-Coat_of_arms_of_arms.png"),title:"Disaggregated report","report-prefix":"MoH",subtitle:l.period,columns:l.columns,columnData:l.reportData,rowsPerPage:100,onRefresh:l.onRegenerate,headerBadge:l.headerBadge},null,8,["icon-url","subtitle","columns","columnData","onRefresh","headerBadge"])]),_:1})}const Ae=te(ge,[["render",ue]]);export{Ae as default};
