System.register(["./index-legacy-CA6M7ipO.js","./htn_service-legacy-CIVLkoYj.js"],(function(t,e){"use strict";var r,s,a,i,u;return{setters:[t=>{r=t.bQ,s=t.aN,a=t.bC,i=t.H},t=>{u=t.B}],execute:function(){t("A",class extends r{lastDrugs;lastReceiptDate;constructor(t,e){super(t,68,e),this.lastDrugs=[],this.lastReceiptDate=""}async loadPreviousDrugs(t=!1){const e=new Date(this.date);e.setDate(e.getDate()-1);const a=t=>i.toStandardHisFormat(t),n=await r.getJson(`patients/${this.patientID}/drugs_received`,{date:a(e)});if(!s.isEmpty(n)){this.lastReceiptDate=n.reduce(((t,e)=>!t||new Date(a(e.order.start_date))>new Date(t)?a(e.order.start_date):t),null);const e=u.htnDrugReferences().map((t=>t.drug_id));if(this.lastDrugs=n.filter((t=>!e.includes(t.drug.drug_id)&&a(t.order.start_date)===this.lastReceiptDate)),t){const t=await this.getPreviousDrugPillCount()||{};this.lastDrugs=this.lastDrugs.map((e=>(t[e.drug.drug_id]&&e.quantity&&(e.quantity+=t[e.drug.drug_id]),e)))}}}getReceiptDate(){return this.lastReceiptDate}getLastDrugs(){return this.lastDrugs}receivedDrugsBefore(){return!s.isEmpty(this.lastDrugs)}buildPillCountObs(t,e){return this.buildValueNumber("Number of tablets brought to clinic",e,null,t)}getPreviousDrugPillCount(){return r.getJson("last_drugs_pill_count",{patient_id:this.patientID,program_id:this.programID,date:this.lastReceiptDate})}async buildAdherenceObs(t,e,s,a=r.getSessionDate()){return{concept_id:await r.getConceptID("Drug adherence",!0),value_numeric:s,value_drug:e,value_modifier:"%",order_id:t,person_id:this.patientID,obs_datetime:a}}isAdherenceGood(t){return t>=95&&t<=105}calculateAdherence(t,e,r){return Math.round(100*(t-e)/(t-r))}calculateExpected(t,e,r,s){const a="QW"===s?"week":"day";return t-this.calcTimeElapsed(r,a)*parseFloat(e.toString())}calcTimeElapsed(t,e){return a(i.toStandardHisFormat(this.date)).diff(i.toStandardHisFormat(t),e)+1}calculateUnaccountedOrMissed(t,e){const r=parseFloat(t)-parseFloat(e);return r<0?-1*r+" missed":r+" unacc"}})}}}));
