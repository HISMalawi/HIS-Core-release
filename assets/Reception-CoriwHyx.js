var v=Object.defineProperty;var b=(e,t,i)=>t in e?v(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var h=(e,t,i)=>b(e,typeof t!="symbol"?t+"":t,i);import{bV as y,az as _,bd as d,d as g,al as a,am as o,aZ as u,a_ as A,bJ as P,bi as T,s as p,aB as V,q as N,at as w,B as f,ak as I,a as x,ap as O,b as S}from"./index-BCOAvIf2.js";import{H as D}from"./HisStandardForm-CejSRcn9.js";import{_ as G}from"./EncounterMixin.vue_vue_type_script_lang-BiqmNDbL.js";import"./encounter_guidelines-DtnttXhU.js";import"./GuidelineEngine-D6V1_Znr.js";class R extends y{constructor(i,r){super(i,51,r);h(this,"sitePrefix");this.sitePrefix=""}getSitePrefix(){return this.sitePrefix}async loadSitePrefix(){this.sitePrefix=await _.sitePrefix()}createArvNumber(i){return d.postJson("/patient_identifiers/",{patient_id:this.patientID,identifier_type:4,identifier:i})}buildArvNumber(i){return"".concat(this.sitePrefix,"-ARV-").concat(i)}}const E=g({mixins:[G],components:{HisStandardForm:D},data:()=>({reception:{},activeField:"",hasARVNumber:!0,suggestedNumber:"",patientType:{},isGuardianOnlyVisitAllowed:!0}),watch:{ready:{handler(e){e&&(this.reception=new R(this.patientID,this.providerID),this.fields=this.getFields())},immediate:!0}},methods:{async setIsGuardianOnlyVisitAllowed(){try{const e=await w.getPatientVisits(this.patientID,!1);if(e.length===0)return;let t=0;const i=336;for(const r of e){const n=await d.getCurrentProgramInformation(this.patientID,r);if(n.visit_by!=="Guardian")return;if(n.pills_dispensed&&n.pills_dispensed.length>0){const[c,s,l]=n.pills_dispensed[0];if(l){const m=f(l).diff(f(r),"day");if(t+=m,t>=i){this.isGuardianOnlyVisitAllowed=!1;return}}}}}catch(e){console.error("Error checking guardian only visits drug dispensation period:",e)}},async onFinish(e,t){if(!await this.reception.createEncounter())return p("Unable to create encounter");const r=await this.resolveObs(t,"obs");if(!await this.reception.saveObservationList(r))return p("Unable to create Obs");if(e.capture_arv&&e.capture_arv.value==="Yes"){if(!await this.reception.createArvNumber(t.arv_number))return p("Unable to save Arv number");V.invalidate("ACTIVE_PATIENT")}if(N("Encounter created"),u.find(e.who_is_present,{value:"Yes",label:"Guardian present?"})&&u.isEmpty(await this.patient.getGuardian()))return this.$router.push("/guardian/registration/".concat(this.patientID));this.nextTask()},getFields(){return[{id:"who_is_present",helpText:"HIV reception",type:o.TT_MULTIPLE_YES_NO,init:async()=>(await this.setIsGuardianOnlyVisitAllowed(),!0),validation:e=>a.required(e)||a.neitherOr(e)||a.anyEmpty(e),computedValue:e=>({tag:"obs",obs:e.map(({other:t,value:i})=>this.reception.buildValueCoded(t.concept,i))}),onValueUpdate:async(e,t)=>e.map(i=>(t.label!=i.label&&t.value==="No"&&(i.value="Yes"),i)),options:e=>e.who_is_present?e.who_is_present:[{label:"Patient present?",value:"",other:{concept:"Patient Present",property:"patient_present",values:this.yesNoOptions()}},{label:"Guardian present?",value:"",other:{concept:"Guardian Present",property:"guardian_present",values:this.yesNoOptions()}}],beforeNext:async e=>{const t=u.find(e,{label:"Patient present?"});return(t==null?void 0:t.value)==="No"&&!this.isGuardianOnlyVisitAllowed?await A("Guardian-Only Visit Not Allowed","Patient not present for over 12 months","Guardian-only visits are no longer permitted after accumulating 12 months of drug dispensation. The patient must now attend the clinic in person.",[{name:"Update Selection",slot:"end",color:"primary"},{name:"Authorized Guardian Visit",slot:"end",color:"danger"}])==="Authorized Guardian Visit":!0}},{id:"capture_arv",helpText:"Capture ARV Number?",type:o.TT_SELECT,requireNext:!0,init:async()=>(this.patient.getPatientIdentifier(4)===""&&(this.hasARVNumber=!1),this.patientType=new P(this.patientID,this.providerID),await this.patientType.loadPatientType(),!0),condition:()=>!this.hasARVNumber&&this.patientType.getType()==="New patient",validation:e=>a.required(e),options:()=>this.yesNoOptions()},{id:"arv_number",helpText:"ART number",type:o.TT_TEXT,init:async()=>{if(await this.reception.loadSitePrefix(),!this.hasARVNumber){const e=await d.getNextSuggestedARVNumber();this.suggestedNumber=e.arv_number.replace(/^\D+|\s/g,"")}return!0},computedValue:({value:e})=>e,validation:e=>a.required(e),condition:e=>!this.hasARVNumber&&e.capture_arv.value==="Yes",defaultValue:()=>this.suggestedNumber,config:{prependValue:()=>{const e=T.getActiveApp();return e&&e.programPatientIdentifiers?e.programPatientIdentifiers["ARV Number"].prefix():""}}}]}}});function F(e,t,i,r,n,c){const s=O("his-standard-form");return S(),x(s,{fields:e.fields,activeField:e.activeField,onFinishAction:e.onFinish,skipSummary:!0,cancelDestinationPath:e.cancelDestination},null,8,["fields","activeField","onFinishAction","cancelDestinationPath"])}const Y=I(E,[["render",F]]);export{Y as default};
