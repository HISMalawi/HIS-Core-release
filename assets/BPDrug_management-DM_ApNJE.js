import{d as F,bm as j,i as z,j as L,l as q,aq as U,f as K,ar as J,m as R,I as X,e as Z,$ as G,F as P,ae as k,V as H,aP as Q,t as W,O as Y,bN as x,_ as ee,r as u,o as s,c as y,w as o,b as a,x as i,A as n,B as h,y as g,u as _,v as C,z as N,a6 as te,a7 as se}from"./index-CZ5Jg0n0.js";import{_ as oe}from"./EncounterMixin.vue_vue_type_script_lang-ghA-Vd8p.js";import{B as w,H as I}from"./htn_service-Cr7d1Qdx.js";import"./encounter_guidelines-Dpkw575K.js";import"./GuidelineEngine-D6V1_Znr.js";import"./HisStandardForm-B3BJzCdf.js";const ne=F({mixins:[oe],components:{ViewPort:j,IonToolbar:z,IonHeader:L,IonContent:q,IonRow:U,IonButton:K,IonCol:J,IonFooter:R,IonPage:X,IonCheckbox:Z},watch:{ready:{async handler(e){if(e){this.HTN=new w(this.patientID,this.providerID),this.drugs=this.HTN.getDrugs();const{drugs:t,notes:r}=await this.HTN.getCurrentDrugs();this.setPreviousBpDrugs(t),this.setPreviousBpNotes(r),this.canClearHtnSessionPrescription=this.patientHasHtnSessionKey()}},immediate:!0}},data:()=>({HTN:{},drugs:null,otherBpDrugs:[],canClearHtnSessionPrescription:!1}),methods:{clearPrescriptionInSession(){sessionStorage.removeItem(I.Prescription),this.canClearHtnSessionPrescription=!1},showMoreBpDrugs(){G([{id:"drug",helpText:"Select BP drugs",type:P.TT_MULTIPLE_SELECT,init:async()=>{k.isEmpty(this.otherBpDrugs)&&(await w.getAllBpDrugs()).forEach(t=>{this.otherBpDrugs.push({label:t.name,value:t.drug_id,other:t})});const e=this.getStandardSelectedDrugs().map(t=>t.drug_id);return this.otherBpDrugs=this.otherBpDrugs.map(t=>({...t,isChecked:e.includes(t.value)})),!0},onValueUpdate:e=>(Object.keys(this.drugs).forEach(t=>this.drugs[t].drugs=this.drugs[t].drugs.map(r=>({...r,selected:e.some(d=>d.value===r.drugID&&d.isChecked)}))),e),options:()=>this.otherBpDrugs,validation:e=>H.required(e)},{id:"dosage",helpText:"Custom dose",type:P.TT_DOSAGE_INPUT,condition:e=>!k.isEmpty(e.drug),validation:e=>H.required(e)?["Drugs are not available"]:e.some(({other:t})=>t.am<=0&&t.noon<=0&&t.pm<=0)?["Missing dosage configuration on some drugs"]:null,computedValue:e=>e.map(t=>t.other),options:e=>e.drug.map(t=>({label:t.label,value:t.value,other:{drug_id:t.other.drug_id,drug_name:t.label,barcodes:t.other.barcodes,units:t.other.units,am:0,noon:0,pm:0,frequency:"Daily (QOD)"}}))}],(e,t)=>this.cacheSelectedDrugsAndProceed(t.dosage))},patientHasHtnSessionKey(){try{const e=sessionStorage.getItem(I.Prescription);if(e)return JSON.parse(e)[this.patientID]}catch(e){console.warn(e)}return!1},removeNote(e,t){this.drugs[e].notes.splice(t,1)},launchNotePad(e){this.showModal({id:"note",helpText:"Add notes for ".concat(e),type:P.TT_TEXT},t=>{t&&this.drugs[e].notes.push({date:Q.getSessionDate(),description:t.value||"",drugID:this.drugs[e].drugs[0].drugID,isNewNote:!0})})},async onFinish(){const e=Object.values(this.drugs).filter(t=>!k.isEmpty(t.notes)).map(t=>t.notes).reduce((t,r)=>t.concat(r),[]).filter(t=>t.isNewNote).map(t=>this.HTN.buildObs("Clinician notes",{value_text:t.description,value_drug:t.drugID}));if(!k.isEmpty(e))try{await this.HTN.createEncounter(),await this.HTN.saveObservationList(await Promise.all(e))}catch(t){return W("Unable to save notes ".concat(t))}this.cacheSelectedDrugsAndProceed(this.getStandardSelectedDrugs())},getStandardSelectedDrugs(){return this.selectedDrugs.map(e=>k.find(w.htnDrugReferences(),{drug_id:e.drugID}))},cacheSelectedDrugsAndProceed(e){const t={};t[this.patientID]=e,sessionStorage.setItem(I.Prescription,JSON.stringify(t)),this.$router.push("/art/encounters/prescriptions/".concat(this.patientID))},async showModal(e,t){(await Y.create({component:x,backdropDismiss:!1,cssClass:"full-modal",componentProps:{dismissType:"modal",currentField:e,onFinish:t}})).present()},setPreviousBpNotes(e){for(const t in e)this.drugs[t].notes=Object.keys(e[t]).map(r=>e[t][r].map(d=>({date:r,description:d,isNewNote:!1}))).reduce((r,d)=>r.concat(d),[])},setPreviousBpDrugs(e){e.forEach(t=>{for(const r in this.drugs)this.drugs[r].drugs.forEach((d,b)=>{t.drug_id===d.drugID&&(this.drugs[r].drugs[b].current=!0,this.drugs[r].drugs[b].selected=!0,this.drugs[r].selected=t.drug_id)})})},selectDrug(e,t,r){this.drugs[e].drugs.forEach((d,b)=>{this.drugs[e].drugs[b].selected=!1}),this.drugs[e].drugs[t].selected=r.detail.checked}},computed:{selectedDrugs(){return this.drugs?Object.values(this.drugs).map(e=>e.drugs).reduce((e,t)=>e.concat(t),[]).filter(e=>e.selected):[]}}}),f=e=>(te("data-v-ebc5e397"),e=e(),se(),e),re=f(()=>n("label",{class:"his-title"}," Prescribe BP drugs ",-1)),ae={key:0,class:"view-port-content"},ie={id:"main-table",style:{width:"100%"}},le=f(()=>n("th",null," ",-1)),de=f(()=>n("td",{class:"td-remaining td-title"},[n("span",null,"New/Current")],-1)),ue=f(()=>n("td",{class:"td-remaining td-title"},[n("span",null," ")],-1)),ce=f(()=>n("p",null,null,-1)),pe={id:"table-notes",style:{width:"100%"}},he=f(()=>n("caption",{style:{"font-size":"1.2em"}}," Notes ",-1)),ge=f(()=>n("p",null,null,-1)),_e={class:"table-inner-notes",id:"notes-HCZ"},me={class:"date-td today-td"},fe={class:"date-td today-td"};function De(e,t,r,d,b,ye){const v=u("ion-col"),S=u("ion-row"),T=u("ion-toolbar"),E=u("ion-header"),O=u("ion-checkbox"),D=u("ion-button"),$=u("view-port"),A=u("ion-content"),M=u("ion-footer"),V=u("ion-page");return s(),y(V,null,{default:o(()=>[a(E,null,{default:o(()=>[a(T,null,{default:o(()=>[a(S,null,{default:o(()=>[a(v,null,{default:o(()=>[re]),_:1})]),_:1})]),_:1})]),_:1}),a(A,null,{default:o(()=>[a($,null,{default:o(()=>[e.drugs?(s(),i("div",ae,[n("table",ie,[n("tr",null,[le,(s(!0),i(h,null,g(e.drugs,(c,l)=>(s(),i("th",{key:l},[_(C(l)+" ",1),a(S,null,{default:o(()=>[(s(!0),i(h,null,g(c.drugs,(p,m)=>(s(),y(v,{class:"col-borders",key:m},{default:o(()=>[_(C(p.amount||"0mg"),1)]),_:2},1024))),128))]),_:2},1024)]))),128))]),n("tr",null,[de,(s(!0),i(h,null,g(e.drugs,(c,l)=>(s(),i("td",{key:l,class:"td-current td-value"},[a(S,null,{default:o(()=>[(s(!0),i(h,null,g(c.drugs,(p,m)=>(s(),y(v,{key:m},{default:o(()=>[a(O,{checked:p.selected,onIonChange:B=>e.selectDrug(l,m,B)},null,8,["checked","onIonChange"])]),_:2},1024))),128))]),_:2},1024)]))),128))]),n("tr",null,[ue,(s(!0),i(h,null,g(Object.keys(e.drugs),(c,l)=>(s(),i("td",{class:"td-remaining td-value",key:l},[a(S,null,{default:o(()=>[a(v,null,{default:o(()=>[a(D,{onClick:p=>e.launchNotePad(c),color:"warning"},{default:o(()=>[_(" Add notes ")]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]))),128))])]),ce,n("table",pe,[he,ge,n("tr",null,[(s(!0),i(h,null,g(e.drugs,(c,l)=>(s(),i("th",{style:{width:"25%"},key:l},[n("span",null,C(l),1)]))),128))]),n("tr",null,[(s(!0),i(h,null,g(Object.keys(e.drugs),(c,l)=>(s(),i("td",{id:"HCZ",style:{"padding-top":"2px !important"},valign:"top",key:l},[n("table",_e,[(s(!0),i(h,null,g(e.drugs[c].notes,(p,m)=>(s(),i("tr",{key:m},[n("td",me,C(p.date),1),n("td",fe,C(p.description),1),n("td",null,[p.isNewNote?(s(),y(D,{key:0,color:"danger",onClick:B=>e.removeNote(c,m)},{default:o(()=>[_(" X ")]),_:2},1032,["onClick"])):N("",!0)])]))),128))])]))),128))])])])):N("",!0)]),_:1})]),_:1}),a(M,null,{default:o(()=>[a(T,{color:"dark"},{default:o(()=>[a(D,{size:"large",color:"danger",slot:"start",onClick:e.gotoPatientDashboard},{default:o(()=>[_(" Cancel ")]),_:1},8,["onClick"]),a(D,{onClick:e.showMoreBpDrugs,size:"large",slot:"end"},{default:o(()=>[_(" More Drugs ")]),_:1},8,["onClick"]),e.canClearHtnSessionPrescription?(s(),y(D,{key:0,size:"large",color:"warning",slot:"end",onClick:e.clearPrescriptionInSession},{default:o(()=>[_(" Clear Session Prescription ")]),_:1},8,["onClick"])):N("",!0),e.selectedDrugs&&e.selectedDrugs.length>0?(s(),y(D,{key:1,size:"large",color:"success",slot:"end",onClick:e.onFinish},{default:o(()=>[_(" Continue ")]),_:1},8,["onClick"])):N("",!0)]),_:1})]),_:1})]),_:1})}const Pe=ee(ne,[["render",De],["__scopeId","data-v-ebc5e397"]]);export{Pe as default};
