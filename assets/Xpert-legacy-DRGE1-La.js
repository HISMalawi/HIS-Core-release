System.register(["./index-legacy-Dg5P6bX-.js","./HisStandardForm-legacy-BXV61qjj.js","./useEncounter-legacy-Bp6E5sCN.js","./dynamic-import-helper-legacy-arUa2LZV.js","./commons-legacy-CiEua9CM.js","./util-legacy-CjANJSja.js","./lab_service-legacy-B78INX4z.js","./TouchScreenForm-legacy-Bqug27CT.js","./ToolbarMediumCard-legacy-DWokgyDV.js","./Transformers-legacy-DhNYVLaS.js","./ViewPort-legacy-D3j1oaCn.js","./isEmpty-legacy-rdjCNuhy.js","./_Set-legacy-BL8ow4HL.js","./_setToArray-legacy-jEwcQpqP.js","./encounter_guidelines-legacy-mRSBdMQj.js","./GuidelineEngine-legacy-KsvQuFdF.js"],(function(e,t){"use strict";var a,i,n,o,l,s,r,d,T,c,u,E,_,R,p,m,v,S,D,I,y,f,A;return{setters:[e=>{a=e.d,i=e.K,n=e.b5,o=e.cV,l=e.aI,s=e.V,r=e.o,d=e.c,T=e.w,c=e.b,u=e.cl,E=e.cX,_=e.ad,R=e.I,p=e.ag},e=>{m=e.H},e=>{v=e.u},e=>{S=e.F},e=>{D=e.r},e=>{I=e.g,y=e.a,f=e.b},e=>{A=e.L},null,null,null,null,null,null,null,null,null],execute:function(){e("default",a({__name:"Xpert",setup(e){const t=i([]),a=new n(-1,o.LAB_RESULTS),b=i(),{goToNextTask:C,facts:N,patientDashboardUrl:g}=v(((e,i,n)=>{a.patientID=i,a.providerID=e,b.value=n,t.value=[{id:"xpertSampleOneResult",helpText:"Sample One Result:",type:S.TT_SELECT,init:async()=>{const e=await l.getProgramInformation(a.patientID);return console.log(e),!0},validation:e=>s.required(e),computedValue:e=>({concept_id:I("SAMPLE_ONE_GENEXPERT_RESULT"),value_coded:I(`${e.value}`),obs_datetime:a.date}),options:()=>[{value:"MTB_NOT_DETECTED",label:"MTB not detected"},{value:"MTB_DETECTED",label:"MTB detected"},{value:"MTB_NO_RESULT",label:"No result"},{value:"MTB_ERROR",label:"Error"},{value:"MTB_INVALID",label:"Invalid"}]},{id:"sampleOneRifResistancePattern",helpText:"Sample One RIF Resistance:",type:S.TT_SELECT,validation:e=>s.required(e),condition:e=>"MTB_DETECTED"===e.xpertSampleOneResult.value,computedValue:(e,t)=>({concept_id:I("SAMPLE_ONE_RIF_RESISTANCE_PATTERN"),value_coded:I(`${e.value}`),obs_datetime:a.date}),options:()=>[{value:"RIF_RESISTANT_NOT_DETECTED",label:"RIF resistant not detected"},{value:"RIF_RESISTANT_DETECTED",label:"RIF resistant detected"},{value:"RIF_RESISTANT_INDETERMINATE",label:"RIF resistant indeterminate"}]},{id:"sampleOneResultDate",helpText:"Sample One Result Date:",type:S.TT_FULL_DATE,validation:e=>s.required(e),computedValue:e=>({concept_id:I("SAMPLE_ONE_GENEXPERT_RESULT_DATE"),value_datetime:e.value,obs_datetime:a.date})},{id:"xpertSampleTwoResult",helpText:"Sample Two Result:",type:S.TT_SELECT,validation:e=>s.required(e),computedValue:e=>({concept_id:I("SAMPLE_TWO_GENEXPERT_RESULT"),value_coded:I(`${e.value}`),obs_datetime:a.date}),options:()=>[{value:"MTB_NOT_DETECTED",label:"MTB not detected"},{value:"MTB_DETECTED",label:"MTB detected"},{value:"MTB_NO_RESULT",label:"No result"},{value:"MTB_ERROR",label:"Error"},{value:"MTB_INVALID",label:"Invalid"}],condition:e=>/invalid|error|no_result/i.test(e.xpertSampleOneResult.value)||/RIF_RESISTANT_INDETERMINATE|RIF_RESISTANT_DETECTED/i.test(e.sampleOneRifResistancePattern?.value)},{id:"sampleTwoRifResistancePattern",helpText:"Sample Two RIF Resistance:",type:S.TT_SELECT,validation:e=>s.required(e),condition:e=>"MTB_DETECTED"===e.xpertSampleTwoResult.value,computedValue:(e,t)=>[{concept_id:I("SAMPLE_TWO_RIF_RESISTANCE_PATTERN"),value_coded:I(`${e.value}`),obs_datetime:a.date},..."RIF_RESISTANT_DETECTED"===t.sampleOneRifResistancePattern?.value&&"RIF_RESISTANT_DETECTED"===e.value?[{concept_id:I("TB_DRUG_RESISTANT"),value_coded:y("Rifampicin (300mg)"),obs_datetime:a.date},{concept_id:I("Resistance classification"),value_coded:I("Mono drug resistant"),obs_datetime:a.date}]:[]],options:()=>[{value:"RIF_RESISTANT_NOT_DETECTED",label:"RIF resistant not detected"},{value:"RIF_RESISTANT_DETECTED",label:"RIF resistant detected"},{value:"RIF_RESISTANT_INDETERMINATE",label:"RIF resistant indeterminate"}]},{id:"sampleTwoResultDate",helpText:"Sample Two Result Date:",type:S.TT_FULL_DATE,validation:e=>s.required(e),condition:e=>e.xpertSampleTwoResult.value,computedValue:e=>({concept_id:I("SAMPLE_TWO_GENEXPERT_RESULT_DATE"),value_datetime:e.value,obs_datetime:a.date})}]}));function O(e){const t="MTB_DETECTED"===e.xpertSampleOneResult?.value||"MTB_DETECTED"===e.xpertSampleTwoResult?.value;return[{concept_id:I("PROCEDURE_TYPE"),value_coded:I("XPERTRIF"),obs_datetime:a.date},{concept_id:I("BACTERIOLOGICALLY_DIAGNOSED"),value_coded:I("YES_ANSWER"),obs_datetime:a.date},{concept_id:I("TB_STATUS"),value_coded:I(t?"POSITIVE":"NEGATIVE"),obs_datetime:a.date},...t?[{concept_id:I("TB_TYPE"),value_coded:I("PULMONARY_TB"),obs_datetime:a.date},{concept_id:I("TUBERCULOSIS_CLASS"),value_coded:I("All Other"),obs_datetime:a.date}]:[]]}async function M(e,t){await a.createEncounter(),await a.saveObservationList([...O(e),...await D(t)]);const i=await async function(){return(await A.getRecentOrders(a.patientID)).observations.reduce(((e,t)=>I("REASON_FOR_TEST")===t.concept_id?t.value_text||t.value_coded:e),"")}(),n=await l.getProgramInformation(a.patientID),o={testReason:i,isConfirmatoryTest:["Confirmatory Rifampicin Resitance test","Rifampicin Resistance confirmation test",f("Confirmatory Rifampicin Resitance test")].includes(i),age:n.age,eptb:n.eptb,hiv:n.hiv,onTreatment:E.isOnTreatment(N.outcome),onMdr:/multi drug resistance treatment/i.test(N.outcome),isTbPositive:[e.xpertSampleOneResult?.value,e.xpertSampleTwoResult?.value].some((e=>"MTB_DETECTED"===e)),sampleResultsAreInvalid:[e.xpertSampleOneResult?.value,e.xpertSampleTwoResult?.value].every((e=>"MTB_INVALID"===e)),samplesAreRifResistant:[e.sampleOneRifResistancePattern?.value,e.sampleTwoRifResistancePattern?.value].every((e=>"RIF_RESISTANT_DETECTED"===e))},s={"prompt when results are invalid":{title:"Sample one and sample two results are invalid",message:"Do you want to Order another GeneXpert test?",yes:()=>p.push(`/tb/lab/${a.patientID}?test=XPERT_MTB_RIF`),no:C,mandatoryCondition:{sampleResultsAreInvalid:e=>e}},"Continue if already on mdr":{action:C,mandatoryCondition:{onMdr:e=>e}},"ask for confirmatory test if resistance is detected":{title:"Rifampcin Resistance Detected!",message:"Do you want to order confirmatory test?",yes:()=>p.push(`/tb/lab/${a.patientID}?reason=Confirmatory Rifampicin Resitance test`),no:async()=>{await E.enrollMDR(a.patientID),C()},mandatoryCondition:{samplesAreRifResistant:e=>e,isConfirmatoryTest:e=>!e}},"enroll in mdr if confirmatory test detects drug resistance":{action:async()=>{await E.enrollMDR(a.patientID),C()},mandatoryCondition:{samplesAreRifResistant:e=>e,isConfirmatoryTest:e=>e}},"Offer Culture and pDST test if MTB is detected without RIF and if patient falls into risk category":{title:"High risk patient",message:"MTB Detected without RIF and patient is a high risk category. Do you want to request Culture and pDST test?",yes:()=>p.push(`/tb/lab/${a.patientID}?test=CULTURE_AND_DST`),no:C,mandatoryCondition:{isTbPositive:e=>e,samplesAreRifResistant:e=>!e},eitherConditionMatch:{eptb:e=>e,hiv:e=>e,age:e=>e<14}},"offer to try a different examination if client is negative":{title:"Negative patient",message:"Do you want to try a different examination?",yes:C,no:()=>p.push(g.value),mandatoryCondition:{isTbPositive:e=>!e,onTreatment:e=>!e,age:e=>e>14}}};for(const a of Object.keys(s)){const e=s[a];let t=!0,i=!1;if(e.mandatoryCondition&&(i=Object.keys(e.mandatoryCondition).every((t=>e.mandatoryCondition[t](o[t])))),e.eitherConditionMatch&&(t=Object.keys(e.eitherConditionMatch||{}).some((t=>e.eitherConditionMatch[t](o[t])))),t&&i){if("function"==typeof e.yes&&"function"==typeof e.no)return"Yes"===await _(e.title,"",e.message,[{name:"Yes",slot:"start",color:"success"},{name:"No",slot:"start",color:"primary"}])?e.yes():e.no();if("function"==typeof e.action)return e.action()}}}return(e,a)=>(r(),d(u(R),null,{default:T((()=>[c(m,{cancelDestinationPath:u(g),onFinishAction:M,fields:t.value,skipSummary:!0},null,8,["cancelDestinationPath","fields"])])),_:1}))}}))}}}));
