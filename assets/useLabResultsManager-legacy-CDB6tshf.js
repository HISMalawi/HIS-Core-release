System.register(["./index-legacy-B837ziyX.js","./lab_order_service-legacy-BVvt1Tgn.js"],(function(e,t){"use strict";var a,i,r,n,l,s,o,u,d,c,p,m,v,T,_;return{setters:[e=>{a=e.aR,i=e.r,r=e.C,n=e.aB,l=e.s,s=e.aZ,o=e.H,u=e.cJ,d=e.al,c=e.am,p=e.bj,m=e.au,v=e.aE,T=e.cK},e=>{_=e.L}],execute:function(){let t;e("u",(function(e,i,r){return t=new _(e,i),a(y,(()=>r.value++),{deep:!0}),{testIndicators:f,testOptions:b,getLabFields:N,isValidResult:g,buildTestIndicatorFields:C,loadLabTests:I,submitLabResult:A}}));const f=i([]),b=i([]),y=i(Math.random()),h=r({date:"",id:-1,indicators:[]});async function g(e,t,a){if(!R(e))return!0;const i=a.substring(0,1),r=a.substring(1,a.length);return!!p.isValidVLResult(t,i,r)||!(await m(`Invalid results for ${t} HIV viral load`,{cancelBtnLabel:"Process result",confirmBtnLabel:"Re-enter result"}))}function L(e){return/^(>|<|=)(.*)/i.test(e)}function E(e){return/^(=|<|>)([0-9]*\.?[0-9]*)$/im.test(e)}function $(e){return/serum crag/i.test(e)}function x(e){return/mrdt|malaria/i.test(e)}function S(e){return/Lam/i.test(e)}function R(e){return/HIV viral load/i.test(e)}function V(e,t,a,i){const r=function(e){return x(e)||S(e)||$(e)}(e);return{type:r?"text":t[`type_${a}`].value,value:r?`${i}`:i.substring(1),modifier:r?"=":i.charAt(0)}}function D(e,t,a){return e.map((e=>({testId:t,indicatorName:e.name,indicatorId:e.concept_id,specimen:a})))}async function I(){const e=await t.getTestsWithoutResults(),a=[];for(const i of e)for(const e of i.tests)if(s.isEmpty(e.result)){const r=D(await t.getTestIndicators(e.concept_id),e.id,i.specimen.name);f.value.push(...r),a.push([i.accession_number,i.specimen.name,e.name,o.toStandardHisDisplayFormat(i.order_date),{type:"button",name:"Enter result",action:()=>{h.id=e.id,h.date=i.order_date,h.indicators=r,u(w)}}])}b.value=[{label:"",value:"",other:{rows:a,columns:["Accession#","Specimen","Test","Order date"]}}]}async function w(){return v([{id:"result_date",helpText:"Result Date",type:c.TT_DATE_PICKER,defaultValue:()=>t.getDate(),computedValue:e=>e,config:{infoItems:e=>[{label:"Order Date",value:o.toStandardHisDisplayFormat(h.date)},{label:"Result Date",value:o.toStandardHisDisplayFormat(e)}],minDate:()=>o.toStandardHisFormat(h.date),maxDate:()=>t.getDate()}},{id:"result_indicators",helpText:"Select test result indicators",type:c.TT_MULTIPLE_SELECT,validation:e=>d.required(e),options:()=>h.indicators.map((e=>({label:e.indicatorName,value:e.indicatorId})))},...C(),{id:"entry_confirmation",helpText:"Confirm entry",type:c.TT_TABLE_VIEWER,options:(e,t)=>[{label:"",value:"",other:{rows:Object.values(t).filter((e=>"object"==typeof e&&null!=e&&"result_indicator"===e.tag)).map((e=>[e.test,e.modifier,e.result])),columns:["Test","Modifier","Result"]}}]}],(async(e,t)=>{const a=Object.values(t).filter((e=>"result_indicator"===e.tag&&e.measures)).map((e=>e.measures));await A(a,t.result_date)&&(await I(),T.dismiss(),y.value=Math.random())}))}function C(){const e=[];let t=0;for(const a of f.value){const{indicatorName:i,indicatorId:r,testId:n,specimen:o}=a,u=r*n+t++,p=e=>h.id===n&&s.findIndex(e.result_indicators,{label:i})>-1,m=e=>g(i,o,e.value),v=(e,t)=>{if(/^other$/i.test(e.value)&&R(i))return{};const{type:a,value:r,modifier:n}=V(i,t,u,e.value),l="numeric"===a?parseFloat(r):r,o=s.find(t.result_indicators,{label:i});return{tag:"result_indicator",measures:{indicator:{concept_id:o.value},value:l,value_modifier:n,value_type:a},result:l,modifier:n,test:o.label}};e.push({id:`type_${u}`,helpText:`Result type (${i})`,type:c.TT_SELECT,group:"test_indicator",condition:e=>p(e)&&!x(i)&&!S(i)&&!$(i),appearInSummary:()=>!1,validation:e=>d.required(e),options:()=>[{label:"Numeric (numbers only)",value:"numeric"},{label:"Alphanumeric(text and numbers)",value:"text"}]},{id:`urine_result_${u}`,helpText:`Select Test Result (${i})`,type:c.TT_SELECT,group:"test_indicator",computedValue:v,validation:e=>d.required(e),condition:e=>p(e)&&S(i),options:()=>[{label:"Positive",value:"positive"},{label:"Negative",value:"negative"}]},{id:`crag_result_${u}`,helpText:`Select Serum CrAg Result (${i})`,type:c.TT_SELECT,group:"test_indicator",computedValue:v,validation:e=>d.required(e),condition:e=>p(e)&&$(i),options:()=>[{label:"Positive",value:"positive"},{label:"Negative",value:"negative"}]},{id:`num_${u}`,helpText:`Test Result (${i})`,type:c.TT_TEXT,group:"test_indicator",computedValue:v,beforeNext:m,onValue:e=>{return/hiv/i.test(i)&&e&&e.value&&(t=e.value.toString(),!/^(=|<|>)([0-9]*)$/im.test(t))?(l("You must enter a modifier and numbers only. i.e =90 / >19 / < 750"),!1):!(e&&e.value&&!E(e.value.toString())&&(l("You must enter a modifier and numbers only. i.e =90 / >19.5 / < 750.45"),1));var t},validation:e=>d.required(e),condition:e=>p(e)&&"numeric"===e[`type_${u}`].value,config:{customKeyboard:[[["1","2","3"],["4","5","6","=","<",">"],["7","8","9","."],["","0",""]],[["Delete"]]]}},{id:`alpha_${u}`,helpText:`Test Result (${i})`,type:c.TT_TEXT,group:"test_indicator",computedValue:v,validation:e=>{const t=d.required(e);return t||(L(`${e?.value}`)?null:["You must enter a modifier plus result (for example =LDL)"])},condition:e=>p(e)&&"text"===e[`type_${u}`].value&&!R(i)},{id:`VL_alpha_${u}`,helpText:`Select Test Result (${i})`,type:c.TT_SELECT,group:"test_indicator",computedValue:v,validation:e=>d.required(e),condition:e=>p(e)&&"text"===e[`type_${u}`].value&&R(i),options:()=>[{label:"Collect Another Sample",value:"=Collect Another Sample"},{label:"<LDL",value:"<LDL"},{label:"=LDL",value:"=LDL"},{value:"Other",label:"Other"}]},{id:`other_VL_alpha_${u}`,helpText:`Test Result (${i})`,type:c.TT_TEXT,group:"test_indicator",onValue:e=>!(e&&e.value&&!L(e.value.toString())&&(l("You must enter a modifier plus result (for example =LDL)"),1)),computedValue:v,validation:e=>d.required(e),condition:e=>p(e)&&"text"===e[`type_${u}`].value&&R(i)&&"Other"===e[`VL_alpha_${u}`].value},{id:`malaria_result_${u}`,helpText:`Select Test Result (${i})`,type:c.TT_SELECT,group:"test_indicator",computedValue:v,validation:e=>d.required(e),condition:e=>p(e)&&x(i),options:()=>i.match(/mrdt/i)?[{label:"Positive",value:"positive"},{label:"Negative",value:"negative"}]:[{label:"Parasites seen",value:"parasites seen"},{label:"No parasites seen",value:"no parasites seen"}]})}return e}async function A(e,a){try{return await t.createEncounter(),await t.createLabResult(e,h.id,a),n.invalidate("PATIENT_LAB_ORDERS"),f.value=[],l("Lab result saved successfully"),!0}catch(i){return console.error(i),l("Failed to save lab result"),!1}}function N(e=!1){return[{id:"test_type",helpText:"Tests without results",type:c.TT_TABLE_VIEWER,condition:()=>!e||!s.isEmpty(b.value[0].other.rows),init:async()=>(await I(),!0),options:()=>b.value,config:{hiddenFooterBtns:["Clear"]}}]}}}}));
