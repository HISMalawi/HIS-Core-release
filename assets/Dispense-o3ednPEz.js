import{d,ai as n,af as r,ab as p,Q as u,a8 as l,ad as c,u as h,v as m}from"./index-LyP1z09P.js";import{D}from"./dispensation_service-0-O7uKNF.js";import{_ as f}from"./EncounterMixin.vue_vue_type_script_lang-6UF_ldRw.js";import"./drug_order_service-o0dipGHB.js";import"./encounter_guidelines-6akTZ644.js";import"./GuidelineEngine-syyQoOzo.js";import"./HisStandardForm-DTr2fl7A.js";const _=d({mixins:[f],data:()=>({dispensation:{}}),watch:{patient:{async handler(e){this.dispensation=new D(e.getID(),this.providerID),await this.dispensation.loadCurrentDrugOrder(),await this.dispensation.loadDrugHistory(),this.fields=this.getFields()},deep:!0}},methods:{saveDispensations(e){const t=this.buildDispensations(e);return this.dispensation.saveDispensations(t)},buildDispensations(e){return this.dispensation.buildDispensations(e.other.order_id,e.value)},buildMedicationHistory(){return this.dispensation.getDrugHistory().sort((e,t)=>{const s=new Date(e.order.start_date);return new Date(t.order.start_date)-s}).map(e=>({medication:e.drug.name,date:n.toStandardHisDisplayFormat(e.order.start_date),amount:e.quantity}))},buildOrderOptions(){return this.dispensation.getCurrentOrder().map(e=>({label:e.drug.name,value:e.quantity||0,other:{drug_id:e.drug.drug_id,order_id:e.order.order_id,amount_needed:this.calculateCompletePack(e)}}))},getPackSizesRows(e,t){return this.dispensation.getDrugPackSizes(e).map(i=>{const a=t>0?t/i:"-";return[i,a,0,0]})},calculateCompletePack(e){const t=parseFloat(e.amount_needed)-(e.quantity||0),s=this.dispensation.calcCompletePack(e,t);return s<0?0:s},isDoneDispensing(e){return e.map(t=>t.value!=0).every(Boolean)},async isValidDispensation(e){let t=!0;const s=parseInt(e.value.toString()),i=e.other.amount_needed,a=s/i*100;return a>110&&(t=await r("Are you sure you want to dispense over 110% of the prescribed pill count?")),a<100&&(t=await r("Are you sure you want to dispense less than 100% of the prescribe amount?")),t},getFields(){return[{id:"dispenses",helpText:"Dispensation",type:p.TT_DRUG_DISPENSER,onValueUpdate:async(e,t)=>e.value!=-1&&this.isDoneDispensing(t)?this.nextTask():(e.other.amount_needed=0,await this.dispensation.loadCurrentDrugOrder(),this.buildOrderOptions()),onValue:async(e,t)=>e.value===-1?!!await this.dispensation.voidOrder(e.other.order_id):!t&&!await this.isValidDispensation(e)?!1:await this.saveDispensations(e)?!0:(u("Unable to save dispensation"),!1),config:{medicationHistory:this.buildMedicationHistory(),toolbarInfo:[{label:"Name",value:this.patient.getFullName()},{label:"Gender",value:this.patient.getGender()},{label:"Date Of Birth",value:n.toStandardHisDisplayFormat(this.patient.getBirthdate())}],hiddenFooterBtns:["Clear","Finish"]},options:()=>this.buildOrderOptions()}]}}});function g(e,t,s,i,a,v){const o=c("his-standard-form");return h(),m(o,{skipSummary:!0,cancelDestinationPath:e.cancelDestination,fields:e.fields},null,8,["cancelDestinationPath","fields"])}const P=l(_,[["render",g]]);export{P as default};
