System.register(["./dynamic-import-helper-legacy-DYK5bIOV.js","./HisStandardForm-legacy-DOc8dQFT.js","./KbLayouts-legacy-BKvPSxzZ.js","./index-legacy-HpoRL6sM.js","./LocationFieldOptions-legacy-CpjtC_88.js","./TouchScreenForm-legacy-D3QVjNom.js","./ToolbarMediumCard-legacy-BjHrpWWd.js","./Transformers-legacy-DhNYVLaS.js","./ViewPort-legacy-u0ytW13O.js"],(function(e,t){"use strict";var a,i,o,r,s,n,l,c,u,d,h,p,m,T,g,y,_,f,v;return{setters:[e=>{a=e.F},e=>{i=e.H},e=>{o=e.C},e=>{r=e.d,s=e.b8,n=e.ab,l=e.T,c=e.q,u=e.V,d=e.cq,h=e.t,p=e.cm,m=e.H,T=e.a$,g=e._,y=e.r,_=e.o,f=e.c},e=>{v=e.g},null,null,null,null],execute:function(){class t{BASE30_DIGITS_INDEX={};BASE30_DIGITS;constructor(){this.BASE30_DIGITS="0123456789ABCDEFGHJKLMNPRTVWXY".split(""),this.BASE30_DIGITS.forEach(((e,t)=>this.BASE30_DIGITS_INDEX[e]=t))}convertFromDecimal(e,t=30){if(t<2||t>30)throw"Invalid base ${toBase}";let a="";for(;e>0;)a=this.BASE30_DIGITS[e%t]+a,e=Math.floor(e/t);return a}static calculateLuhnCheckDigit(e){const t=e.toString().split("").map((e=>Number.parseInt(e,10))),a=t.length%2;let i=0;t.forEach(((e,t)=>{t%2===a&&(e*=2),e>9&&(e-=9),i+=e}));const o=i%10;return 0===o?0:10-o}isValidDHACode(e){try{const a=this.convertToDecimal(e).toString();return 0===t.calculateLuhnCheckDigit(10*Number.parseInt(a,10))}catch(a){return console.error(a),!1}}convertToDecimal(e){if(0==e.length)return 0;const t=this.BASE30_DIGITS_INDEX[e[0]];if(null==t)throw"Invalid base ${fromBase} number: ${number}";return t*30**(e.length-1)+this.convertToDecimal(e.slice(1))}}const S=r({components:{HisStandardForm:i},data:()=>({activeField:"",fields:[],drugs:[],selectedDrugs:[],barcode:"",stockService:{}}),methods:{async onFinish(e){let t=[];for(const i of e.enter_batches){const o={reallocation_code:e.authorization.value,quantity:i.other.pack_size*i.other.tins,date:e.date.value,reason:i.other.reason};try{"Relocations"===e.task.value?await this.stockService.relocateItems(i.other.id,{...o,location_id:e.relocation_location.value}):await this.stockService.disposeItems(i.other.id,o)}catch(a){a instanceof s&&!n.isEmpty(a.errors)?t=t.concat(a.errors.map((e=>`${e} for ${i.other.drug_name}`))):t.push(`${a}`),console.log(a)}}if(n.isEmpty(t))return l("Stock succesfully moved"),this.$router.push("/");c(`${t.join(",")}`)},getFields(){return[{id:"task",helpText:"Select task",type:a.TT_SELECT,validation:e=>u.required(e),options:()=>[{label:"Relocations",value:"Relocations"},{label:"Disposal",value:"Disposal"}]},{id:"relocation_location",helpText:"Destination",type:a.TT_SELECT,validation:e=>u.required(e)||u.notTheSame(e.label,`${d.getLocationName()}`),condition:e=>"Relocations"===e.task.value,options:(e,t="")=>v(t),computedValue:e=>e.label,config:{showKeyboard:!0,isFilterDataViaApi:!0}},{id:"date",dynamicHelpText:e=>`Date of ${e.task.label}`,helpText:"Set date",type:a.TT_FULL_DATE,validation:e=>u.required(e)},{id:"select drugs",helpText:"Select drugs",type:a.TT_MULTIPLE_SELECT,requireNext:!0,validation:e=>u.required(e),options:async(e,t)=>this.getDrugs(t,e.date.value),unload:e=>this.selectedDrugs=e},{id:"enter_batches",helpText:"Batch entry",type:a.TT_BATCH_MOVEMENT,beforeNext:(e,t,a,{currentFieldContext:i})=>{const o=i.drugs.filter((e=>!e.other.tins||!e.other.reason));if(!n.isEmpty(o)){const e=o.map((e=>`${e.label}`)).join(" & ");return h(`Please fix partial batch entries for drugs: ${e}`),!1}return!0},options:()=>this.selectedDrugs,validation:e=>u.required(e),config:{getReasons:this.getReasons}},{id:"authorization",helpText:"Enter authorization code",type:a.TT_TEXT,config:{customKeyboard:[o,[["Delete"]]]},validation:e=>u.validateSeries([()=>u.required(e),()=>{const a=e.value;return(new t).isValidDHACode(a.toUpperCase())?null:["Invalid authorization code"]}])},{id:"summary",helpText:"Summary",type:a.TT_TABLE_VIEWER,options:e=>this.buildResults(e),config:{hiddenFooterBtns:["Clear"]}}]},buildResults(e){const t="Relocations"===e.task.value,a=["Drug","Total Tins","Expiry date","Authorization code","Reason"];return t&&a.push("Relocation"),[{label:"Confirm entry",value:"Table",other:{columns:a,rows:e.enter_batches.map((a=>{const i=[a.other.drug_name,p(a.other.tins),m.toStandardHisDisplayFormat(a.other.expiry_date),e.authorization.value.toUpperCase(),a.other.reason];return t&&i.push(e.relocation_location.label),i}))}}]},async getDrugs(e,t){return(await this.stockService.getItems()).map((t=>{const a=t?.drug_name??t?.drug_legacy_name??"N/A",i=m.toStandardHisDisplayFormat(t.expiry_date),o=e.filter((e=>e.label===a)).length>=1;return{label:a,value:t.drug_id,isChecked:o,description:{color:"primary",show:"always",text:`Product Code: ${t.product_code} - Batch Number: ${t.batch_number} - Pack Size: ${t.pack_size} - Expiry date: ${i}`},other:{...t,tins:null,quantity:Math.trunc(t.current_quantity/t.pack_size)||0,reason:""}}})).filter((e=>!T(t).isBefore(e.other.delivery_date)&&e.other.current_quantity>0))},mapToOptions:e=>e.map((e=>({label:e,value:e}))),getReasons(e,t){if("Relocations"===t.task.value)return this.mapToOptions(["Transfer to another facility/relocation","For trainings"]);const a=["Damaged","Phased out","Banned","Missing"];return T(e.other?.expiry_date).isAfter(d.getSessionDate())||a.push("Expired"),this.mapToOptions(a)}},created(){this.stockService=new d,this.fields=this.getFields()}});e("default",g(S,[["render",function(e,t,a,i,o,r){const s=y("his-standard-form");return _(),f(s,{fields:e.fields,activeField:e.activeField,onFinishAction:e.onFinish,skipSummary:!0},null,8,["fields","activeField","onFinishAction"])}]]))}}}));
