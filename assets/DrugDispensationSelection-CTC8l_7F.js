import{d as N,z as v,df as S,ak as V,ap as u,a as r,g as c,e as a,w as d,f as e,t as m,a5 as _,a4 as D,ba as z,h as y,aj as I,b_ as B,a$ as P,af as R,ag as M,aR as O,v as H,b as L,a6 as A}from"./index-CJleCCtM.js";import{O as T}from"./ActionSideButton-BR89eqy0.js";import{R as q}from"./ResetButton-Dtn_bHGz.js";import{_ as F}from"./FieldMixin.vue_vue_type_script_lang-BmhYWVLG.js";const Q=N({data:()=>({listData:[],tabsIndex:2,packsIndex:3}),props:{drugName:{type:String,required:!0},tabsNeeded:{type:String,required:!0},items:{type:Array,required:!0},onDispense:{type:Function,required:!0},onClose:{type:Function}},computed:{dispensedValues(){return this.listData.filter(t=>t[this.tabsIndex]>0).map(t=>[t[this.tabsIndex],t[this.packsIndex]])},amountNeededRowSpan(){return this.listData.length+1}},watch:{items:{handler(t){t&&(this.listData=[...t])},deep:!0,immediate:!0}},methods:{async onClose(){await v.dismiss({}),typeof this.onClose=="function"&&this.onClose()},incrementAmount(t){const[n,,i,p]=this.listData[t],o=n+i,h=p+1;this.listData[t][2]=o,this.listData[t][3]=h},decrementAmount(t){const[n,,i,p]=this.listData[t],o=p-1;if(o>=0){const h=i-n;this.listData[t][2]=h,this.listData[t][3]=o}},fmtNumber(t){return/-/i.test(t)?t:S(t)}}}),U={colspan:"6"},j=["rowspan"],G={class:"btn-list"};function J(t,n,i,p,o,h){const l=u("ion-button"),b=u("ion-content"),C=u("ion-toolbar"),w=u("ion-footer");return r(),c(_,null,[a(b,null,{default:d(()=>[e("table",null,[e("thead",null,[e("tr",null,[e("th",U,m(t.drugName),1)]),n[1]||(n[1]=e("tr",null,[e("th",null,"Total tab(s) needed "),e("th",{colspan:"2"}," Available stock "),e("th",{colspan:"2"}," Dispensed "),e("th")],-1)),n[2]||(n[2]=e("tr",null,[e("th"),e("th",null," Pack size "),e("th",null," Packs "),e("th",null," Total Tab(s)"),e("th",null," Packs "),e("th")],-1))]),e("tbody",null,[e("tr",null,[e("td",{rowspan:t.amountNeededRowSpan},m(t.tabsNeeded)+" tab(s) ",9,j)]),(r(!0),c(_,null,D(t.listData,(g,f)=>(r(),c("tr",{key:f},[(r(!0),c(_,null,D(g,(k,s)=>(r(),c("td",{key:s,class:z(s>=2?"input-field":"his-md-text")},m(t.fmtNumber(k)),3))),128)),e("td",null,[e("ul",G,[e("li",null,[a(l,{onClick:k=>t.incrementAmount(f),class:"dispense-btn",size:"large"},{default:d(()=>n[3]||(n[3]=[y(" + ")])),_:2},1032,["onClick"])]),e("li",null,[a(l,{onClick:k=>t.decrementAmount(f),class:"dispense-btn",size:"large"},{default:d(()=>n[4]||(n[4]=[y(" - ")])),_:2},1032,["onClick"])])])])]))),128))])])]),_:1}),a(w,null,{default:d(()=>[a(C,null,{default:d(()=>[a(l,{onClick:t.onClose,color:"danger",size:"large",slot:"end"},{default:d(()=>n[5]||(n[5]=[y(" Close ")])),_:1},8,["onClick"]),a(l,{onClick:n[0]||(n[0]=g=>t.onDispense(t.dispensedValues)),color:"success",size:"large",slot:"end"},{default:d(()=>n[6]||(n[6]=[y(" Dispense ")])),_:1})]),_:1})]),_:1})],64)}const K=V(Q,[["render",J],["__scopeId","data-v-de39aa22"]]),W=N({components:{IonInput:I,ViewPort:B,Barcode:P,NavButton:T,ResetButton:q,IonRow:R,IonCol:M},mixins:[F],data:()=>({dispensingLockEnabled:!1,tab:"prescribe",listData:[],medicationHistory:[],isStockManagementEnabled:!1}),mounted(){this.init()},activated(){this.init()},watch:{tab:{handler(t){t==="history"&&O.isEmpty(this.medicationHistory)&&typeof this.config.medicationHistory=="function"&&this.config.medicationHistory().then(n=>{n&&(this.medicationHistory=n)}).catch(n=>{H("".concat(n))})}}},methods:{async init(){var t,n;this.$emit("onFieldActivated",this),typeof((t=this.config)==null?void 0:t.isDrugManagementEnabled)=="function"&&(this.isStockManagementEnabled=(n=this.config)==null?void 0:n.isDrugManagementEnabled()),this.listData=await this.options(this.fdata)},async onScan(t){const[n,i]=t.split("-"),p=this.listData.map(async o=>{if(o.other.drug_id===parseInt(n)){const h=parseInt(o.value.toString()),l=parseInt(i);await this.updateOnValue(o,l,[],!0)&&(o.value=l+h)}return o});this.listData=await Promise.all(p)},async onReset(t){await this.updateOnValue(t,-1)},fmtNumber(t){return!this.isStockManagementEnabled||/-/i.test(t)?"-":S(t)},async updateOnValue(t,n,i=[],p=!1){return this.onValue&&!await this.onValue({label:t.label,other:{dispenses:i,...t.other},value:n},p)?!1:(t.value=n<0?0:n,this.$emit("onValue",t),this.onValueUpdate&&(this.listData=await this.onValueUpdate(t,this.listData)),!0)},async launchDispenser(t){this.dispensingLockEnabled=!0,(await v.create({component:K,backdropDismiss:!1,cssClass:"custom-modal",componentProps:{drugName:t.label,tabsNeeded:t.other.amount_needed,items:t.other.pack_sizes,onClose:async()=>{this.dispensingLockEnabled=!1,await v.dismiss({})},onDispense:async i=>{const o=i.reduce((l,b)=>l+b[0],0);await this.updateOnValue(t,o,i)&&(this.dispensingLockEnabled=!1,await v.dismiss({}))}}})).present()}}}),X={class:"view-port-content"},Y={key:0,class:"his-card history"},Z={class:"his-table"},x={key:1,class:"prescription-tab"},tt={class:"prescription-table-section his-card"},et={class:"his-table"},nt={class:"barcode-section"};function st(t,n,i,p,o,h){const l=u("nav-button"),b=u("ion-col"),C=u("ion-input"),w=u("reset-button"),g=u("barcode"),f=u("ion-row"),k=u("view-port");return r(),L(k,null,{default:d(()=>[e("div",X,[a(f,null,{default:d(()=>[a(b,{size:"2"},{default:d(()=>[a(l,{onClick:n[0]||(n[0]=s=>t.tab="prescribe"),isActive:t.tab==="prescribe",image:"prescription/rx",label:"Prescribed"},null,8,["isActive"]),a(l,{onClick:n[1]||(n[1]=s=>t.tab="history"),isActive:t.tab==="history",image:"prescription/history",label:"History"},null,8,["isActive"])]),_:1}),a(b,{size:"10"},{default:d(()=>[t.tab==="history"?(r(),c("div",Y,[e("table",Z,[n[2]||(n[2]=e("tr",null,[e("th",null," Medication"),e("th",null," Date"),e("th",null," Amount dispensed ")],-1)),(r(!0),c(_,null,D(t.medicationHistory,(s,$)=>(r(),c("tr",{key:$},[e("td",null,m(s.medication),1),e("td",null,m(s.date),1),e("td",null,m(s.amount),1)]))),128))])])):A("",!0),t.tab==="prescribe"?(r(),c("div",x,[e("div",tt,[e("table",et,[n[3]||(n[3]=e("tr",null,[e("th",null," Medication"),e("th",null," Amount in stock"),e("th",null," Amount needed"),e("th",null," Amount dispensed "),e("th",null," Reset ")],-1)),(r(!0),c(_,null,D(t.listData,(s,$)=>(r(),c("tr",{key:$},[e("td",null,m(s.label),1),e("td",null,m(t.fmtNumber(s.other.available_stock)),1),e("td",null,m(s.other.amount_needed),1),e("td",null,[a(C,{disabled:t.dispensingLockEnabled||s.value>0,value:s.value,onClick:E=>s.value<=0&&!t.dispensingLockEnabled?t.launchDispenser(s):null,class:"dosage-input"},null,8,["disabled","value","onClick"])]),e("td",null,[a(w,{label:"",disabled:s.value<=0,onClick:E=>s.value>0?t.onReset(s):null},null,8,["disabled","onClick"])])]))),128))])]),e("div",nt,[a(g,{onOnScan:t.onScan,class:"his-card"},null,8,["onOnScan"])])])):A("",!0)]),_:1})]),_:1})])]),_:1})}const rt=V(W,[["render",st],["__scopeId","data-v-e0e49e2a"]]);export{rt as default};
