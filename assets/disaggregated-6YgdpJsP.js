import{d as N,I as T,cg as S,K as m,N as j,ac as U,n as L,t as x,cQ as h,q,cj as G,O as R,ae as V,ch as k,_ as Q,r as w,o as K,c as W,w as X,b as E}from"./index-BzVWU-6u.js";import{D as Y}from"./ReportDateSelectionPrompt-BUka0vzS.js";import{D as z}from"./disaggregated_service-B1X7yEvS.js";import{v as H}from"./TableView-CIAE159z.js";import{A as J}from"./ArtDrilldown-AYOsHY7t.js";import{R as O}from"./regimen_report_service-KW589ykV.js";import"./fuse-YdZE3OCN.js";import"./Export-PjGFz1RJ.js";import"./HisKeyboard-mYPg-10z.js";const Z=N({components:{IonPage:T,IonLoading:S,v2Datatable:H},setup(){const o=m([]),b=m(""),A=m(""),D=m(!1),a=new z,u=m([]),F=async l=>{(await R.create({component:J,backdropDismiss:!1,cssClass:"large-modal",componentProps:{...l,subtitle:b.value,onFinish:()=>R.getTop().then(t=>t&&R.dismiss())}})).present()},d=(l,t)=>({ref:t,label:l,defaultValue:"0",toValue:e=>e.length,tdClick:async e=>{e.refData.length&&F({patientIdentifiers:e.refData,title:"".concat(e.data.age_group," ").concat(e.data.gender," ").concat(e.column.label)})}}),_=[[{label:"#",ref:"index"},{label:"Age group",ref:"age_group"},{label:"Gender",ref:"gender"},d("TX curr (receiving ART)","tx_curr"),...O.reduce((l,t)=>[...l,d(t,t)],[]),d("Unknown","N/A"),d("Total (regimen)","regimen_total")]],$=[...O,"N/A"].reduce((l,t)=>({...l,[t]:[]}),{}),M=async()=>P(await L("Do you want to rebuild report?")),P=async(l=!1)=>{var f,B,C;if(!(a.startDate&&a.endDate))return x("Start date and end date required!");D.value=!0;const t=["Pregnant","Breastfeeding"],e={F:{label:"Female",rows:[],aggregate:{},excludedAgeGroups:t},M:{label:"Male",rows:[],aggregate:{},excludedAgeGroups:t},FP:{label:"Pregnant",rows:[],aggregate:{},gender:"F",ageGroup:"All",genderDisplay:"FP",excludedAgeGroups:[...h,"Breastfeeding"]},FBF:{label:"Breastfeeding",rows:[],aggregate:{},gender:"F",ageGroup:"All",genderDisplay:"FBF",excludedAgeGroups:[...h,"Pregnant"]}},v=(s=!1)=>{const g=Object.keys(e.FP.aggregate).reduce((i,n)=>({...i,[n]:[...e.FP.aggregate[n]||[],...e.FBF.aggregate[n]||[]]}),{}),r=Object.keys(e.F.aggregate).reduce((i,n)=>({...i,[n]:i[n].filter(I=>Array.isArray(g[n])?!g[n].includes(I):!0)}),e.F.aggregate);o.value=[...e.F.rows,...e.M.rows,{age_group:"All",gender:"Male",...e.M.aggregate},...e.FP.rows,{age_group:"All",gender:"FNP",...r},...e.FBF.rows];const p=V.uniq([...e.M.aggregate.tx_curr||[],...e.F.aggregate.tx_curr||[]]),c={text:"Total alive and on ART: <b>".concat(p.length,"</b>"),icon:k,color:"primary",action:()=>F({patientIdentifiers:p,title:"Total alive and on ART: ".concat(p.length)})};s?u.value=[c]:u.value=[c,{text:A.value,icon:G,color:"dark"}]};try{if(a.setRebuildOutcome(l),!await a.init())return x("Unable to initialise report");for(const s of[...h,...t]){A.value="Processing <b>".concat(s,"</b>"),a.setAgeGroup(s);const g=await a.getCohort();a.setRebuildOutcome(!1);for(const r of Object.keys(e)){if((e[r].excludedAgeGroups||[]).includes(s))continue;a.setGender(r),e[r].ageGroup&&a.setAgeGroup(e[r].ageGroup);const p=await a.getRegimenDistribution(),c={age_group:((f=e[r])==null?void 0:f.ageGroup)||s,gender:((B=e[r])==null?void 0:B.genderDisplay)||e[r].label,...g[s]?g[s][((C=e[r])==null?void 0:C.gender)||r]:{},...$,...p,regimen_total:Object.values(p).flat(1)};e[r].rows.push(c),e[r].aggregate=Object.keys(c).reduce((i,n)=>Array.isArray(c[n])?{...i,[n]:[...i[n]||[],...c[n]]}:i,e[r].aggregate),v(!1)}}v(!0),o.value=o.value.map((s,g)=>({index:g+1,...s}))}catch(s){const g="Unable to generate report!";q(g),u.value=[{text:g,color:"danger",icon:G,action:function(){u.value=[{text:"Exception occured: <b>".concat(s,"</b>"),color:"danger",icon:G}]}}]}D.value=!1,A.value=""},y=(l=!1)=>Y({onFinish:(t,e,v,f)=>{b.value=v,a.startDate=t,a.endDate=e,f&&a.setOccupation(f),a.setQuarter("pepfar"),P(l)}});return j(()=>y(!0)),{Img:U,onRegenerate:M,headerBadge:u,reportData:o,isLoading:D,configure:y,generate:P,columns:_,period:b}}});function ee(o,b,A,D,a,u){const F=w("ion-loading"),d=w("v2Datatable"),_=w("ion-page");return K(),W(_,null,{default:X(()=>[E(F,{"is-open":o.isLoading,message:"Please wait.."},null,8,["is-open"]),E(d,{"icon-url":o.Img("login-logos/PEPFAR.png"),title:"PEPFAR Disaggregated Report","report-prefix":"Pepfar",subtitle:o.period,columns:o.columns,columnData:o.reportData,rowsPerPage:100,onConfigure:o.configure,onRefresh:o.onRegenerate,headerBadge:o.headerBadge},null,8,["icon-url","subtitle","columns","columnData","onConfigure","onRefresh","headerBadge"])]),_:1})}const ce=Q(Z,[["render",ee]]);export{ce as default};
