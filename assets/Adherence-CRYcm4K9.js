import{d as I,r as P,bW as T,bY as N,an as v,ao as x,a_ as U,bn as D,q as k,H as h,a as V,w as R,e as W,f as F,m as L,B as M,b as O}from"./index-qFt4YszW.js";import{H as G}from"./HisStandardForm-B3LOSMqB.js";import{u as j}from"./useEncounter-Bj5eamVf.js";import{r as J}from"./commons-B4jZtVaM.js";import"./isEmpty-1LErKKNT.js";import"./encounter_guidelines-CLmFwnI6.js";import"./GuidelineEngine-D6V1_Znr.js";const ae=I({__name:"Adherence",setup(Q){const m=P([]),i=new T(-1,N.ADHERENCE);function $(e,t){const o=parseFloat(e)-parseFloat(t);return o<0?o*-1+" missed":o+" unacc"}function _(e,t){return M(h.toStandardHisFormat(i.date)).diff(h.toStandardHisFormat(e),t)}function g(e,t,o){return Math.round(100*(e-t)/(e-o))}function b(e){const t=e.frequency==="QW"?"week":"day",o=_(e.order.start_date,t);return e.quantity-o*parseFloat("".concat(e.equivalent_daily_dose))}const{goToNextTask:C,patientDashboardUrl:w}=j((e,t)=>{i.patientID=t,i.providerID=e;const o=()=>{let d=[];return{id:"pills_brought",helpText:"Pills remaining (brought to clinic)",type:x.TT_ADHERENCE_INPUT,init:async()=>{try{d=await T.getJson("patients/".concat(t,"/drugs_orders_by_program"),{date:i.date,program_id:i.programID})}catch(a){console.error("".concat(a)),k("Unable to load data!")}return!0},validation:a=>v.validateSeries([()=>v.required(a),()=>a.some(s=>s.value==="")?["Some values are missing"]:null]),computedValue:a=>a.map(l=>{const c=l.other;return[{concept_id:D.getCachedConceptID("Drug adherence"),value_drug:c.drug.drug_id,order_id:c.order_id,value_modifier:"%",person_id:t,value_numeric:g(c.quantity,parseInt("".concat(l.value)),b(c))},{concept_id:D.getCachedConceptID("Number of tablets brought to clinic"),order_id:c.order_id,value_numeric:l.value,person_id:t}]}).flat(1),options:a=>U.isEmpty(a.pills_brought)?d.map(s=>({label:s.drug.name,value:"",other:s})):a.pills_brought}},S=()=>({id:"adherence_report",helpText:"TB adherence",type:x.TT_TABLE_VIEWER,condition:d=>d.pills_brought.length,options:d=>{const a=d.pills_brought,s=a[0].other.order.start_date,l=_(s,"day"),c=" Last visit: ".concat(h.toStandardHisDisplayFormat(s)," \n                    (").concat(l," Days Elapsed)"),q=[{indexes:[0,3,6],class:"adherence-col-bg"}],f=[],y=[c],r=[["Prescription"],["Tabs given"],["Tabs per day"],["Tabs remaining"],["Expected"],["Actual (counted)"],["Adherence"],["Doses missed/ Unaccounted for"],["Doses consumed"],["TB Adherence"]];return a.forEach((n,H)=>{const u=b(n.other),p=g(n.other.quantity,parseInt("".concat(n.value)),u),E=p>=95&&p<=105?"Good adherence":"Explore problem",B=$("".concat(u),"".concat(n.value));y.push(n.other.drug.name),r[0].push(""),r[1].push(n.other.quantity),r[2].push("".concat(n.other.equivalent_daily_dose)),r[3].push(""),r[4].push(u<0?"0":"".concat(u)),r[5].push("".concat(n.value)),r[6].push(""),r[7].push(B),r[8].push("".concat(p,"%")),r[9].push(E),f.push({index:H+1,row:9,class:E.match(/good/i)?"adherence-txt-good":"adherence-txt-bad"})}),[{label:"Selected Medication",value:"Table",other:{columns:y,rows:r,rowColors:q,cellColors:f}}]},config:{hiddenFooterBtns:["Clear"]}});m.value=[o(),S()]});async function A(e,t){await i.createEncounter(),await i.saveObservationList(await J(t)),C()}return(e,t)=>(O(),V(F(L),null,{default:R(()=>[W(G,{cancelDestinationPath:F(w),onFinishAction:A,fields:m.value,skipSummary:!0},null,8,["cancelDestinationPath","fields"])]),_:1}))}});export{ae as default};
