System.register(["./index-legacy-B837ziyX.js","./lab_order_service-legacy-BVvt1Tgn.js"],(function(e,t){"use strict";var s,a,i,n,d,o,l,r,c,h,u,p,y,m,b,v,f,I,x,T,g,k,C,w,_,O,S,A,B,L,F,D,E,M,P,N,$,R,V,K,U,j,z,Z,q,H,Y,G;return{setters:[e=>{s=e.d,a=e.dy,i=e.ad,n=e.b5,d=e.l,o=e.aC,l=e.b0,r=e.ac,c=e.ds,h=e.ar,u=e.b1,p=e.a7,y=e.ag,m=e.ah,b=e.m,v=e.ai,f=e.a5,I=e.a4,x=e.I,T=e.k,g=e.cc,k=e.cn,C=e.ch,w=e.dZ,_=e.z,O=e.bj,S=e.s,A=e.aB,B=e.au,L=e.aZ,F=e.br,D=e.y,E=e.b4,M=e.dj,P=e.ak,N=e.ap,$=e.h,R=e.b,V=e.e,K=e.w,U=e.j,j=e.a,z=e.a6,Z=e.a9,q=e.aa,H=e.t,Y=e.g},e=>{G=e.L}],execute:function(){var t=document.createElement("style");t.textContent="table[data-v-96198bde]{font-family:arial,sans-serif;border-collapse:collapse;width:100%}ion-col[data-v-96198bde]{border-right:solid 1px #ccc}.side-title[data-v-96198bde]{width:100%;padding:.3em;text-align:center;background:#e9e8e8}td[data-v-96198bde],th[data-v-96198bde]{border:1px solid #dddddd;text-align:left;padding:8px}tr[data-v-96198bde]:nth-child(2n){background-color:#ddd}\n/*$vite$:1*/",document.head.appendChild(t);const W=s({name:"Lab-modal",props:{activities:{type:Object,required:!0},ordersToday:{type:Object},onOrderAdded:{type:Object,required:!1},testFilters:{type:Array},title:{type:String,default:""}},watch:{activities:{handler(e){e&&(this.appActivities=[...e],this.getActivities())},immediate:!0}},async created(){this.printCopies=await M.labOrderPrintCopies()??1,this.extendedLabsEnabled=await M.extendedLabEnabled(),this.canScanDBS=await M.canScanDBS()},methods:{onFilter(e){this.searchFilter=E(e,this.searchFilter)},testAlreadyDoneToday(e){return!!(this.ordersToday||{})[e]},async onScanEIDbarcode(e){if((await F.create({message:`Checking ${e}`})).present(),this.testTypes[this.activeIndex].accessionNumber=null,`${e||""}`.length<=0)return S("Barcode is required"),void F.getTop().then((e=>e&&F.dismiss()));try{await O.accessionNumExists(e)?S(`Barcode ${e} was already used`):this.testTypes[this.activeIndex].accessionNumber=e}catch(t){D("Failed to confirm barcode "+e+", Please try again later",8e3)}F.getTop().then((e=>e&&F.dismiss()))},async onSelectTest(e,t,s){if(this.testAlreadyDoneToday(e))return S("Test was already ordered today, please void and try again!");this.searchFilter="",this.showKeyboard=!1,this.testTypes[t].isChecked=s.target.checked,this.testTypes[t].isChecked?(this.activeIndex=t,await this.setTestDetails(t)):this.removeOrder(t)},async setTestDetails(e){this.specimens=await O.getSpecimens(this.testTypes[e].name,this.testTypes[e].nlims_code),this.testMethods=await O.getTestMethods(this.testTypes[e].nlims_code)},async getActivities(){const e=await O.getTestTypes(),t=L.findIndex(e,(e=>/hiv viral load/i.test(e.name))),s=-1!==t?e.splice(t,1):null,a=e.sort(((e,t)=>{const s=`${e.name}`.toUpperCase(),a=`${t.name}`.toUpperCase(),i=/^[0-9]/.test(s);if(i!==/^[0-9]/.test(a))return i?1:-1;const n=s.replace(/^[^A-Z]+/,"")[0]||"",d=a.replace(/^[^A-Z]+/,"")[0]||"";return n!==d?n.localeCompare(d):s.localeCompare(a)})).filter((e=>!Array.isArray(this.testFilters)||this.testFilters.includes(e.name)));this.testTypes=(s?[...s,...a]:a).map(((e,t)=>({...e,id:t})))},async removeOrder(e){this.testTypes[e].isChecked=!1,this.testTypes[e].reason=null,this.testTypes[e].specimen=null,this.testTypes[e].testMethod=null,this.testTypes[e].specimenConcept=null,this.testTypes[e].accessionNumber=null;const t=this.finalOrders.reverse();t[0]?(this.activeIndex=t[0].id,await this.setTestDetails(this.activeIndex)):(this.activeIndex=null,this.specimens=[],this.testMethods=[])},addSpecimen(e){this.testTypes[this.activeIndex].specimenConcept=e.concept_id},async postActivities(){this.isPostingOrder=!0;try{const e=`${this.$route.params.patient_id}`,t=new G(parseInt(e),-1),s=await t.createEncounter();if(s){const e=await O.buildLabOrders(s,this.finalOrders),t=await O.saveOrdersArray(s.encounter_id,e);if(!t)return S("Unable to save lab orders");A.invalidate("PATIENT_LAB_ORDERS");const a=this.finalOrders.some((e=>!e.accessionNumber)),i=!t.every((e=>e.tests.some((e=>["FBS","RBS"].includes(e.name)))))&&a&&await B("Lab orders and encounter created!, print out your last orders?",{confirmBtnLabel:"Yes",cancelBtnLabel:"No"});"function"==typeof this.onOrderAdded&&this.finalOrders.forEach((e=>this.onOrderAdded&&this.onOrderAdded(e.name))),await this.closeModal(t),i&&await this.onPrintOrder(t)}}catch(e){S(`Unable to save order: ${e}`)}this.isPostingOrder=!1},async closeModal(e){await _.dismiss(e)},async onPrintOrder(e){const t=this.getOrdersToPrint(e);await w(t)},getOrdersToPrint(e){const t=this.finalOrders.map((e=>`${e.accessionNumber}`.toUpperCase()));return e.reduce(((e,s)=>[s.tests.some((e=>["FBS","RBS"].includes(e.name))),t.includes(`${s.accession_number}`.toUpperCase())].every(Boolean)?e:[...e,s.order_id]),[])}},computed:{searchIcon:()=>C,searchColor(){return this.showKeyboard?"primary":"dark"},testTypesOnDisplay(){return this.searchFilter?new k(this.testTypes,{threshold:.3,keys:["name"],useExtendedSearch:!0}).search(this.searchFilter).map((e=>e.item)):this.testTypes},dbsBarcodeActivated(){return this.canScanDBS&&/dbs|plasma/i.test(`${this.testTypes[this.activeIndex]?.specimen}`)&&/hiv viral load/i.test(`${this.testTypes[this.activeIndex]?.name}`)},isOrderComplete(){return"number"==typeof this.activeIndex&&!(this.dbsBarcodeActivated&&/dbs/i.test(this.testTypes[this.activeIndex].specimen)&&!this.testTypes[this.activeIndex].accessionNumber)&&(this.extendedLabsEnabled?!!this.testTypes[this.activeIndex].reason:(this.testTypes[this.activeIndex].specimenConcept||this.testTypes[this.activeIndex].specimen)&&this.testTypes[this.activeIndex].reason)},selectedOrders(){return this.testTypes.filter((e=>!0===e.isChecked))},finalOrders(){return this.selectedOrders.filter((e=>!(this.dbsBarcodeActivated&&/dbs/i.test(e.specimen)&&!e.accessionNumber)&&e.reason&&(e.specimen&&!this.extendedLabsEnabled||this.extendedLabsEnabled)))},testReasons(){let e=this.reasons;return this.testTypes[this.activeIndex].name.match(/Viral load/i)&&(e=e.filter((e=>"Stat"!==e)),e=e.concat(["Follow up after Low Level Viremia","Follow up after High Viral Load"])),e}},mounted(){this.getActivities()},data:()=>({printCopies:1,isPostingOrder:!1,searchFilter:"",showKeyboard:!1,keyboardLayout:g,canScanDBS:!1,content:"Content",extendedLabsEnabled:!1,appActivities:[],testTypes:[],specimens:[],testMethods:[],reasons:["Routine","Targeted","Confirmatory","Stat","Repeat / Missing"],activeIndex:null}),components:{IonButton:T,IonContent:x,IonHeader:I,IonTitle:f,IonInput:v,IonToolbar:b,IonLabel:m,IonList:y,IonItem:p,BarcodeInput:u,IonCheckbox:h,IonRadioGroup:c,IonRow:r,HisKeyboard:l,IonIcon:o,IonFooter:d,IonGrid:n,IonCol:i,IonRadio:a}}),X={key:0},J={key:1},Q={class:"ion-margin-bottom"},ee={key:1},te={class:"his-md-text side-title"},se={style:{background:"lightyellow",height:"34vh"}},ae={class:"his-sm-text"};e("L",P(W,[["render",function(e,t,s,a,i,n){const d=N("ion-title"),o=N("ion-icon"),l=N("ion-input"),r=N("ion-toolbar"),c=N("ion-header"),h=N("ion-label"),u=N("ion-checkbox"),p=N("ion-item"),y=N("ion-list"),m=N("ion-col"),b=N("ion-radio"),v=N("ion-radio-group"),f=N("ion-text"),I=N("BarcodeInput"),x=N("ion-button"),T=N("ion-row"),g=N("ion-grid"),k=N("his-keyboard"),C=N("ion-content"),w=N("ion-footer");return R(),$(Z,null,[V(c,null,{default:K((()=>[V(r,null,{default:K((()=>[V(d,{class:"his-lg-text",slot:"start"},{default:K((()=>[...t[5]||(t[5]=[U(" Lab orders ",-1)])])),_:1}),V(o,{size:"large",slot:"end",icon:e.searchIcon,color:e.searchColor},null,8,["icon","color"]),V(l,{readonly:!0,value:e.searchFilter,disabled:e.activeIndex&&!e.isOrderComplete,color:e.searchColor,onClick:t[0]||(t[0]=()=>e.showKeyboard=!e.showKeyboard),placeholder:"Search for tests",style:{"text-align":"left",width:"35%"},class:"input_display",slot:"end"},null,8,["value","disabled","color"])])),_:1})])),_:1}),V(C,{style:{overflow:"hidden",background:"grey",height:"70vh"}},{default:K((()=>[V(g,null,{default:K((()=>[V(T,null,{default:K((()=>[V(m,{size:"6"},{default:K((()=>[V(y,{style:{overflowY:"auto",height:"75vh"}},{default:K((()=>[(R(!0),$(Z,null,q(e.testTypesOnDisplay,(t=>(R(),j(p,{class:"his-sm-text",key:t.id,color:e.activeIndex===t.id?"primary":"none",disabled:null!=e.activeIndex&&e.activeIndex!==t.id&&!e.isOrderComplete,detail:""},{default:K((()=>[V(h,{"text-wrap":""},{default:K((()=>[e.testAlreadyDoneToday(t.name)?(R(),$("s",X,H(t.name),1)):(R(),$("span",J,H(t.name),1))])),_:2},1024),V(u,{slot:"start",checked:t.isChecked,onIonChange:s=>e.onSelectTest(t.name,t.id,s)},null,8,["checked","onIonChange"])])),_:2},1032,["color","disabled"])))),128))])),_:1})])),_:1}),null!=e.activeIndex&&e.selectedOrders.length>0?(R(),j(m,{key:0,style:{overflowY:"auto",height:"79vh"}},{default:K((()=>[Y("div",Q,[e.extendedLabsEnabled?z("",!0):(R(),j(y,{key:0},{default:K((()=>[V(v,{modelValue:e.testTypes[e.activeIndex].specimen,"onUpdate:modelValue":t[1]||(t[1]=t=>e.testTypes[e.activeIndex].specimen=t)},{default:K((()=>[t[6]||(t[6]=Y("div",{class:"his-md-text side-title"}," Select specimen ",-1)),(R(!0),$(Z,null,q(e.specimens,(t=>(R(),j(p,{key:t},{default:K((()=>[V(h,null,{default:K((()=>[U(H(t.name),1)])),_:2},1024),V(b,{slot:"start",value:t.name,onClick:s=>e.addSpecimen(t)},null,8,["value","onClick"])])),_:2},1024)))),128))])),_:1},8,["modelValue"])])),_:1})),e.dbsBarcodeActivated?(R(),$("div",ee,[Y("div",te,[t[7]||(t[7]=U(" Barcode ID: ",-1)),V(f,{color:e.testTypes[e.activeIndex].accessionNumber?"success":"dark"},{default:K((()=>[Y("b",null,H(e.testTypes[e.activeIndex].accessionNumber||"None"),1)])),_:1},8,["color"])]),V(I,{size:"small",onOnScan:e.onScanEIDbarcode},null,8,["onOnScan"])])):z("",!0),e.testMethods.length>0?(R(),j(v,{key:2,modelValue:e.testTypes[e.activeIndex].testMethod,"onUpdate:modelValue":t[2]||(t[2]=t=>e.testTypes[e.activeIndex].testMethod=t)},{default:K((()=>[t[8]||(t[8]=Y("div",{class:"his-md-text side-title"}," Test Method to be used ",-1)),(R(!0),$(Z,null,q(e.testMethods,(e=>(R(),j(p,{class:"his-sm-text",key:e},{default:K((()=>[V(h,null,{default:K((()=>[U(H(e.name),1)])),_:2},1024),V(b,{slot:"start",value:e.concept_id},null,8,["value"])])),_:2},1024)))),128))])),_:1},8,["modelValue"])):z("",!0),V(v,{modelValue:e.testTypes[e.activeIndex].reason,"onUpdate:modelValue":t[3]||(t[3]=t=>e.testTypes[e.activeIndex].reason=t)},{default:K((()=>[t[9]||(t[9]=Y("div",{class:"his-md-text side-title"}," Main test(s) reason ",-1)),(R(!0),$(Z,null,q(e.testReasons,(e=>(R(),j(p,{class:"his-sm-text",key:e},{default:K((()=>[V(h,null,{default:K((()=>[U(H(e),1)])),_:2},1024),V(b,{slot:"start",value:e},null,8,["value"])])),_:2},1024)))),128))])),_:1},8,["modelValue"])]),Y("div",se,[Y("table",ae,[t[11]||(t[11]=Y("thead",null,[Y("tr",null,[Y("th",null,"Test"),Y("th",null,"Specimen"),Y("th",null,"Reason"),Y("th",null,"Action")])],-1)),Y("tbody",null,[(R(!0),$(Z,null,q(e.finalOrders,((s,a)=>(R(),$("tr",{key:a},[Y("td",null,H(s.name),1),Y("td",null,H(s.specimen||"N/A"),1),Y("td",null,H(s.reason),1),Y("td",null,[V(x,{onClick:t=>e.removeOrder(s.id),slot:"end",color:"danger"},{default:K((()=>[...t[10]||(t[10]=[U("X",-1)])])),_:1},8,["onClick"])])])))),128))])])])])),_:1})):z("",!0)])),_:1})])),_:1}),e.showKeyboard?(R(),j(k,{key:0,kbConfig:e.keyboardLayout,onKeyPress:e.onFilter,disabled:!1},null,8,["kbConfig","onKeyPress"])):z("",!0)])),_:1}),V(w,null,{default:K((()=>[V(r,null,{default:K((()=>[V(x,{onClick:e.postActivities,size:"large",slot:"end",disabled:e.isPostingOrder||0===e.finalOrders.length},{default:K((()=>[...t[12]||(t[12]=[U(" Place orders ",-1)])])),_:1},8,["onClick","disabled"]),V(x,{disabled:e.isPostingOrder,onClick:t[4]||(t[4]=t=>e.closeModal([])),size:"large",slot:"start",color:"danger"},{default:K((()=>[...t[13]||(t[13]=[U(" Close ",-1)])])),_:1},8,["disabled"])])),_:1})])),_:1})],64)}],["__scopeId","data-v-96198bde"]]))}}}));
