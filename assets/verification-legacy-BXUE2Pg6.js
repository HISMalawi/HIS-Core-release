System.register(["./dynamic-import-helper-legacy-DYK5bIOV.js","./HisStandardForm-legacy-BpfFI5_j.js","./index-legacy-C29Eb2Qm.js","./TouchScreenForm-legacy-BmEuIwWy.js","./ToolbarMediumCard-legacy-CF38wqjC.js","./Transformers-legacy-DhNYVLaS.js","./ViewPort-legacy-CDi_rmkw.js"],(function(e,t){"use strict";var a,i,r,s,n,o,c,d,l,u,h,p,_,y;return{setters:[e=>{a=e.F},e=>{i=e.H},e=>{r=e.d,s=e.T,n=e.q,o=e.cq,c=e.V,d=e.t,l=e.cm,u=e.H,h=e._,p=e.r,_=e.o,y=e.c},null,null,null,null],execute:function(){const t=r({components:{HisStandardForm:i},data:()=>({activeField:"",fields:[],drugs:[],stockService:{}}),methods:{async onFinish(e){const t=this.prepDrugs(e);try{await this.stockService.batchUpdate({verification_date:e.date.value,reason:e.reason.value,items:t}),s("Stock succesfully updated"),this.$router.push("/")}catch(a){n("Could not save stock"),console.error(a)}},mapDrugsToOptions(e){const t=new Map;return e.forEach((e=>{e.pack_size||(e.pack_size=o.getPackSize(e.drug_id)),e.original_quantity=Math.trunc(e.current_quantity/(e.pack_size||1)),e.current_quantity=e.original_quantity,t.has(e.drug_id)?t.get(e.drug_id)?.other.push(e):t.set(e.drug_id,{label:`${e?.drug_name||e?.drug_legacy_name} (${e.product_code})`,value:e.drug_id,other:[e]})})),Array.from(t.values())},getFields(){return[{id:"date",helpText:"Verification Date",type:a.TT_FULL_DATE,validation:e=>c.required(e)},{id:"enter_batches",helpText:"Batch entry",type:a.TT_BATCH_VERIFICATION,options:()=>this.drugs,validation:e=>c.required(e),init:async()=>{try{const e=await this.stockService.getItems();return this.drugs=this.mapDrugsToOptions(e),!0}catch(e){return console.error(e),d("Unable to load drugs"),!1}}},{id:"reason",helpText:"Select reason",type:a.TT_SELECT,validation:e=>c.required(e),options:()=>[{label:"Monthly stock take",value:"Monthly stock take"},{label:"Audit",value:"Audit"},{label:"Adhoc (due to stock imbalance)",value:"Adhoc (due to stock imbalance)"},{label:"Supervision",value:"Supervision"},{label:"Handover",value:"Handover"}]},{id:"verification_summary",helpText:"Summary",type:a.TT_TABLE_VIEWER,options:e=>this.buildResults(e.enter_batches),config:{hiddenFooterBtns:["Clear"]}}]},buildResults:e=>[{label:"Confirm entry",value:"Table",other:{columns:["Drug Name (BatchNumber)","Tins/Pallets","Reason for Modification","Expiry date"],rows:e.map((e=>[`${e.drug_name} (${e.batch_number})`,l(e.current_quantity),e.reason,u.toStandardHisDisplayFormat(e.expiry_date)]))}}],prepDrugs:e=>e.enter_batches.map((e=>({id:e.id,current_quantity:parseInt(e.pack_size)*parseInt(e.current_quantity),delivered_quantity:e.delivered_quantity,pack_size:e.pack_size,expiry_date:e.expiry_date,delivery_date:e.delivery_date,batch_number:e.batch_number,reason:e.reason})))},async created(){this.stockService=new o,this.fields=this.getFields()}});e("default",h(t,[["render",function(e,t,a,i,r,s){const n=p("his-standard-form");return _(),y(n,{fields:e.fields,activeField:e.activeField,onFinishAction:e.onFinish,skipSummary:!0},null,8,["fields","activeField","onFinishAction"])}]]))}}}));
