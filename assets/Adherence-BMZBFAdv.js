import{d as P,K as V,b5 as T,cV as N,t as U,V as v,aS as x,ab as k,H as h,o as B,c as R,w as L,b as M,cl as D,a$ as O,I as W}from"./index-BCTN_bnC.js";import{F}from"./dynamic-import-helper-BkBZiFw5.js";import{H as G}from"./HisStandardForm-CaDwl-hA.js";import{u as j}from"./useEncounter-CDUT-p5Y.js";import{r as J}from"./commons-BDvZ1JFN.js";import"./TouchScreenForm-TKB9q3ZD.js";import"./ToolbarMediumCard-O_J6wu7C.js";import"./Transformers-BPPLlH12.js";import"./ViewPort-BCxYiILf.js";import"./isEmpty-OXtHK5dz.js";import"./_Set-VKtKUQAI.js";import"./_setToArray-BLmuRUHx.js";import"./encounter_guidelines-DZpIPlYY.js";import"./GuidelineEngine-D6V1_Znr.js";const de=P({__name:"Adherence",setup(K){const m=V([]),i=new T(-1,N.ADHERENCE);function $(e,t){const o=parseFloat(e)-parseFloat(t);return o<0?o*-1+" missed":o+" unacc"}function _(e,t){return O(h.toStandardHisFormat(i.date)).diff(h.toStandardHisFormat(e),t)}function g(e,t,o){return Math.round(100*(e-t)/(e-o))}function f(e){const t=e.frequency==="QW"?"week":"day",o=_(e.order.start_date,t);return e.quantity-o*parseFloat("".concat(e.equivalent_daily_dose))}const{goToNextTask:A,patientDashboardUrl:C}=j((e,t)=>{i.patientID=t,i.providerID=e;const o=()=>{let d=[];return{id:"pills_brought",helpText:"Pills remaining (brought to clinic)",type:F.TT_ADHERENCE_INPUT,init:async()=>{try{d=await T.getJson("patients/".concat(t,"/drugs_orders_by_program"),{date:i.date,program_id:i.programID})}catch(r){console.error("".concat(r)),U("Unable to load data!")}return!0},validation:r=>v.validateSeries([()=>v.required(r),()=>r.some(s=>s.value==="")?["Some values are missing"]:null]),computedValue:r=>r.map(l=>{const c=l.other;return[{concept_id:x.getCachedConceptID("Drug adherence"),value_drug:c.drug.drug_id,order_id:c.order_id,value_modifier:"%",person_id:t,value_numeric:g(c.quantity,parseInt("".concat(l.value)),f(c))},{concept_id:x.getCachedConceptID("Number of tablets brought to clinic"),order_id:c.order_id,value_numeric:l.value,person_id:t}]}).flat(1),options:r=>k.isEmpty(r.pills_brought)?d.map(s=>({label:s.drug.name,value:"",other:s})):r.pills_brought}},w=()=>({id:"adherence_report",helpText:"ART adherence",type:F.TT_TABLE_VIEWER,condition:d=>d.pills_brought.length,options:d=>{const r=d.pills_brought,s=r[0].other.order.start_date,l=_(s,"day"),c=" Last visit: ".concat(h.toStandardHisDisplayFormat(s)," \n                    (").concat(l," Days Elapsed)"),H=[{indexes:[0,3,6],class:"adherence-col-bg"}],b=[],y=[c],a=[["Prescription"],["Tabs given"],["Tabs per day"],["Tabs remaining"],["Expected"],["Actual (counted)"],["Adherence"],["Doses missed/ Unaccounted for"],["Doses consumed"],["Art Adherence"]];return r.forEach((n,q)=>{const u=f(n.other),p=g(n.other.quantity,parseInt("".concat(n.value)),u),E=p>=95&&p<=105?"Good adherence":"Explore problem",I=$("".concat(u),"".concat(n.value));y.push(n.other.drug.name),a[0].push(""),a[1].push(n.other.quantity),a[2].push("".concat(n.other.equivalent_daily_dose)),a[3].push(""),a[4].push(u<0?"0":"".concat(u)),a[5].push("".concat(n.value)),a[6].push(""),a[7].push(I),a[8].push("".concat(p,"%")),a[9].push(E),b.push({index:q+1,row:9,class:E.match(/good/i)?"adherence-txt-good":"adherence-txt-bad"})}),[{label:"Selected Medication",value:"Table",other:{columns:y,rows:a,rowColors:H,cellColors:b}}]},config:{hiddenFooterBtns:["Clear"]}});m.value=[o(),w()]});async function S(e,t){await i.createEncounter(),await i.saveObservationList(await J(t)),A()}return(e,t)=>(B(),R(D(W),null,{default:L(()=>[M(G,{cancelDestinationPath:D(C),onFinishAction:S,fields:m.value,skipSummary:!0},null,8,["cancelDestinationPath","fields"])]),_:1}))}});export{de as default};
